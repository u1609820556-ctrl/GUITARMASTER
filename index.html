<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guitar Theory Master</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Archivo+Black&family=IBM+Plex+Mono:wght@400;500;600;700&family=Barlow+Condensed:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        void: {
                            950: '#0a0a0a',
                            900: '#121212',
                            800: '#1a1a1a',
                            700: '#252525',
                            600: '#333333',
                            500: '#4a4a4a',
                            400: '#666666',
                            300: '#888888',
                        },
                        blood: {
                            400: '#dc2626',
                            500: '#b91c1c',
                            600: '#991b1b',
                        },
                        brass: {
                            400: '#d4a574',
                            500: '#c4956a',
                            600: '#a67c52',
                        },
                        chalk: {
                            100: '#fafafa',
                            200: '#e5e5e5',
                            300: '#cccccc',
                        }
                    },
                    fontFamily: {
                        'display': ['Bebas Neue', 'sans-serif'],
                        'heading': ['Archivo Black', 'sans-serif'],
                        'body': ['Barlow Condensed', 'sans-serif'],
                        'mono': ['IBM Plex Mono', 'monospace'],
                    }
                }
            }
        }
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Barlow Condensed', sans-serif;
            background: #0a0a0a;
            color: #e5e5e5;
            min-height: 100vh;
            overflow-x: hidden;
            letter-spacing: 0.02em;
        }

        /* Noise texture overlay */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            opacity: 0.035;
            z-index: 9999;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 400 400' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
        }

        /* Custom scrollbar - industrial */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #121212;
            border-left: 1px solid #252525;
        }
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #dc2626 0%, #991b1b 100%);
            border: 1px solid #0a0a0a;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #ef4444 0%, #b91c1c 100%);
        }

        /* Fretboard styles - dark rosewood industrial with rounded */
        .fretboard-container {
            background: linear-gradient(180deg, #1a1412 0%, #0d0a08 100%);
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid #333;
            box-shadow:
                inset 0 0 60px rgba(0,0,0,0.8),
                0 0 0 1px #0a0a0a,
                0 20px 60px rgba(0,0,0,0.7);
        }

        .fretboard-container::before {
            content: '';
            position: absolute;
            inset: 0;
            background-image:
                url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='5' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E"),
                repeating-linear-gradient(90deg, transparent 0px, transparent 40px, rgba(0,0,0,0.1) 40px, rgba(0,0,0,0.1) 41px);
            opacity: 0.12;
            pointer-events: none;
        }

        .string {
            position: relative;
            display: flex;
            align-items: center;
            height: 42px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.02);
        }

        .string::before {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            top: 50%;
            height: 2px;
            background: linear-gradient(90deg,
                rgba(200, 180, 160, 0.2) 0%,
                rgba(220, 200, 180, 0.7) 8%,
                rgba(200, 180, 160, 0.5) 50%,
                rgba(180, 160, 140, 0.3) 100%
            );
            transform: translateY(-50%);
            box-shadow: 0 1px 3px rgba(0,0,0,0.6);
        }

        .string:nth-child(1)::before { height: 1px; opacity: 0.85; }
        .string:nth-child(2)::before { height: 1.5px; opacity: 0.8; }
        .string:nth-child(3)::before { height: 2px; opacity: 0.75; }
        .string:nth-child(4)::before { height: 2.5px; opacity: 0.7; background: linear-gradient(90deg, rgba(180, 165, 150, 0.2) 0%, rgba(190, 175, 160, 0.65) 8%, rgba(170, 155, 140, 0.45) 50%, rgba(160, 145, 130, 0.25) 100%); }
        .string:nth-child(5)::before { height: 3px; opacity: 0.65; background: linear-gradient(90deg, rgba(160, 150, 140, 0.2) 0%, rgba(170, 160, 150, 0.55) 8%, rgba(150, 140, 130, 0.35) 50%, rgba(140, 130, 120, 0.18) 100%); }
        .string:nth-child(6)::before { height: 3.5px; opacity: 0.6; background: linear-gradient(90deg, rgba(150, 140, 130, 0.2) 0%, rgba(160, 150, 140, 0.45) 8%, rgba(140, 130, 120, 0.28) 50%, rgba(130, 120, 110, 0.15) 100%); }

        .fret {
            position: relative;
            flex: 1;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            border-right: 3px solid #555;
            box-shadow: inset -2px 0 6px rgba(0,0,0,0.4), inset 2px 0 4px rgba(255,255,255,0.02);
        }

        .fret:first-child {
            flex: 0.6;
            background: linear-gradient(90deg, #f0ead6 0%, #d8cdb8 50%, #c4b89a 100%);
            border-right: 6px solid #1a1a1a;
            box-shadow: inset -4px 0 10px rgba(0,0,0,0.5), 4px 0 12px rgba(0,0,0,0.4);
        }

        .fret-marker {
            position: absolute;
            bottom: -30px;
            left: 50%;
            transform: translateX(-50%);
            width: 12px;
            height: 12px;
            background: radial-gradient(circle, #e8e0d0 0%, #b8a888 100%);
            border-radius: 50%;
            opacity: 0.8;
            box-shadow: 0 2px 4px rgba(0,0,0,0.4);
        }

        .note-bubble {
            position: relative;
            z-index: 10;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 12px;
            font-weight: 700;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            opacity: 0;
            transform: scale(0);
            text-transform: uppercase;
        }

        .note-bubble.visible {
            opacity: 1;
            transform: scale(1);
        }

        .note-bubble.tonic {
            background: #dc2626;
            color: #fafafa;
            box-shadow:
                0 0 0 3px #0a0a0a,
                0 0 20px rgba(220, 38, 38, 0.6),
                0 4px 15px rgba(0,0,0,0.4);
            border: none;
        }

        .note-bubble.interval {
            background: #fafafa;
            color: #0a0a0a;
            box-shadow:
                0 0 0 2px #0a0a0a,
                0 4px 12px rgba(0,0,0,0.4);
            border: none;
        }

        .note-bubble.other {
            background: #444;
            color: #bbb;
            box-shadow:
                0 2px 8px rgba(0,0,0,0.3);
            border: none;
        }

        .note-bubble:hover {
            transform: scale(1.2);
            z-index: 20;
        }

        /* Level cards - industrial with rounded */
        .level-card {
            background: #121212;
            border: 2px solid #252525;
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.2s ease;
        }

        .level-card:hover {
            border-color: #444;
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
        }

        .level-card.active {
            border-color: #dc2626;
            box-shadow: 0 0 30px rgba(220, 38, 38, 0.2);
        }

        .level-header {
            padding: 16px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: background 0.2s ease;
            border-left: 4px solid transparent;
        }

        .level-header:hover {
            background: rgba(255,255,255,0.03);
            border-left-color: #dc2626;
        }

        .level-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease;
        }

        .level-card.expanded .level-content {
            max-height: 2000px;
        }

        .level-badge {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Bebas Neue', sans-serif;
            font-weight: 400;
            font-size: 18px;
            letter-spacing: 1px;
        }

        /* Buttons - industrial with rounded */
        .btn-primary {
            background: #dc2626;
            color: #fafafa;
            padding: 12px 24px;
            border-radius: 10px;
            font-family: 'Bebas Neue', sans-serif;
            font-weight: 400;
            font-size: 16px;
            letter-spacing: 2px;
            text-transform: uppercase;
            border: 2px solid #dc2626;
            cursor: pointer;
            transition: all 0.15s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .btn-primary:hover {
            background: transparent;
            color: #dc2626;
            transform: translateY(-2px);
            box-shadow: 0 0 20px rgba(220, 38, 38, 0.3);
        }

        .btn-secondary {
            background: transparent;
            color: #e5e5e5;
            padding: 10px 18px;
            border-radius: 8px;
            font-family: 'Barlow Condensed', sans-serif;
            font-weight: 600;
            font-size: 14px;
            letter-spacing: 1px;
            text-transform: uppercase;
            border: 2px solid #444;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .btn-secondary:hover {
            border-color: #dc2626;
            color: #dc2626;
        }

        /* Select dropdown - industrial with rounded */
        .custom-select {
            appearance: none;
            background: #1a1a1a;
            border: 2px solid #333;
            border-radius: 10px;
            padding: 12px 44px 12px 16px;
            color: #fafafa;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23dc2626'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 18px;
            transition: all 0.15s ease;
        }

        .custom-select:hover {
            border-color: #555;
        }

        .custom-select:focus {
            outline: none;
            border-color: #dc2626;
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.15);
        }

        /* Toggle switch - industrial with rounded */
        .toggle-switch {
            position: relative;
            width: 48px;
            height: 26px;
            background: #252525;
            border-radius: 13px;
            border: 2px solid #333;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .toggle-switch.active {
            background: #dc2626;
            border-color: #dc2626;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 18px;
            height: 18px;
            background: #fafafa;
            border-radius: 50%;
            transition: transform 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .toggle-switch.active::after {
            transform: translateX(22px);
        }

        /* Interval buttons - industrial with rounded */
        .interval-btn {
            padding: 10px 16px;
            border-radius: 8px;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 13px;
            font-weight: 600;
            border: 2px solid #333;
            background: #1a1a1a;
            color: #999;
            cursor: pointer;
            transition: all 0.15s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .interval-btn:hover {
            border-color: #666;
            color: #fafafa;
            background: #252525;
        }

        .interval-btn.active {
            background: #fafafa;
            color: #0a0a0a;
            border-color: #fafafa;
            font-weight: 700;
        }

        /* Chord button - industrial with rounded */
        .chord-btn {
            padding: 14px 18px;
            border-radius: 10px;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 13px;
            font-weight: 500;
            border: 2px solid #333;
            background: #151515;
            color: #ccc;
            cursor: pointer;
            transition: all 0.15s ease;
            text-align: center;
            min-width: 70px;
        }

        .chord-btn:hover {
            border-color: #dc2626;
            color: #fafafa;
            background: #1a1a1a;
            transform: translateY(-2px);
        }

        .chord-btn.active {
            background: #dc2626;
            color: #fafafa;
            border-color: #dc2626;
            box-shadow: 0 0 20px rgba(220, 38, 38, 0.3);
        }

        .chord-btn .roman {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 22px;
            font-weight: 400;
            display: block;
            margin-bottom: 4px;
            letter-spacing: 1px;
        }

        .chord-btn .name {
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 11px;
            opacity: 0.7;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Mode button - industrial with rounded */
        .mode-btn {
            padding: 14px 18px;
            border-radius: 10px;
            border: 2px solid #333;
            border-left: 4px solid #444;
            background: #151515;
            color: #ccc;
            cursor: pointer;
            transition: all 0.15s ease;
            text-align: left;
        }

        .mode-btn:hover {
            border-color: #d4a574;
            border-left-color: #d4a574;
            background: #1a1a1a;
            transform: translateX(4px);
        }

        .mode-btn.active {
            border-color: #d4a574;
            border-left-color: #d4a574;
            background: rgba(212, 165, 116, 0.1);
        }

        .mode-btn .mode-name {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 20px;
            color: #d4a574;
            margin-bottom: 4px;
            letter-spacing: 1px;
        }

        .mode-btn .mode-degree {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Animations - sharper, more industrial */
        @keyframes pulse-glow {
            0%, 100% {
                box-shadow:
                    0 0 0 2px #0a0a0a,
                    0 0 0 4px #dc2626,
                    0 4px 20px rgba(220, 38, 38, 0.5);
            }
            50% {
                box-shadow:
                    0 0 0 2px #0a0a0a,
                    0 0 0 6px #dc2626,
                    0 4px 30px rgba(220, 38, 38, 0.7);
            }
        }

        .note-bubble.tonic.pulse {
            animation: pulse-glow 1.5s ease-in-out infinite;
        }

        @keyframes fade-in-up {
            from {
                opacity: 0;
                transform: translateY(15px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in-up {
            animation: fade-in-up 0.3s ease-out forwards;
        }

        @keyframes slide-in-left {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .slide-in-left {
            animation: slide-in-left 0.25s ease-out forwards;
        }

        /* Theory text - improved readability */
        .theory-text {
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 16px;
            line-height: 1.8;
            color: #bbb;
            font-weight: 400;
        }

        .theory-text strong {
            color: #fafafa;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .theory-text em {
            color: #dc2626;
            font-style: normal;
            font-weight: 600;
        }

        .formula-box {
            background: #121212;
            border: 2px solid #333;
            border-left: 4px solid #dc2626;
            border-radius: 10px;
            padding: 16px 20px;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 16px;
            font-weight: 600;
            color: #fafafa;
            letter-spacing: 3px;
            text-align: center;
            margin: 16px 0;
        }

        /* Header glow effect - industrial */
        .header-glow {
            position: relative;
        }

        .header-glow::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent 0%, #dc2626 50%, transparent 100%);
            opacity: 0.6;
        }

        /* String labels */
        .string-label {
            width: 32px;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 13px;
            font-weight: 600;
            color: #666;
            text-align: center;
        }

        /* Progression button - industrial with rounded */
        .progression-btn {
            padding: 12px 16px;
            border-radius: 10px;
            border: 2px solid #333;
            background: #151515;
            color: #ccc;
            cursor: pointer;
            transition: all 0.15s ease;
            text-align: left;
        }

        .progression-btn:hover {
            border-color: #fafafa;
            background: #1a1a1a;
            color: #fafafa;
        }

        .progression-btn.active {
            border-color: #fafafa;
            background: #fafafa;
            color: #0a0a0a;
        }

        /* Circle of fifths - industrial with rounded */
        .circle-note {
            position: absolute;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.15s ease;
            background: #252525;
            color: #ccc;
            border: 2px solid #333;
        }

        .circle-note:hover {
            transform: scale(1.15);
            border-color: #dc2626;
            color: #fafafa;
        }

        .circle-note.active {
            background: #dc2626;
            color: #fafafa;
            border-color: #dc2626;
            box-shadow: 0 0 20px rgba(220, 38, 38, 0.5);
        }

        .circle-note.minor {
            font-size: 10px;
            width: 30px;
            height: 30px;
            background: #1a1a1a;
            color: #888;
        }

        .circle-note.minor.active {
            background: #fafafa;
            color: #0a0a0a;
            border-color: #fafafa;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.3);
        }

        /* Blue note special highlight */
        .note-bubble.blue-note {
            background: #d4a574;
            color: #0a0a0a;
            box-shadow:
                0 0 0 2px #0a0a0a,
                0 0 0 4px #d4a574,
                0 4px 15px rgba(212, 165, 116, 0.5);
        }

        /* Chord highlight for harmonization */
        .note-bubble.chord-highlight {
            box-shadow:
                0 0 0 3px #0a0a0a,
                0 0 0 6px #d4a574,
                0 4px 20px rgba(212, 165, 116, 0.6);
            transform: scale(1.15);
            z-index: 10;
        }

        /* Progression info panel - industrial with rounded */
        .progression-info {
            background: #121212;
            border: 2px solid #252525;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }

        .chord-in-progression {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 56px;
            height: 56px;
            border-radius: 12px;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 20px;
            font-weight: 400;
            letter-spacing: 1px;
            transition: all 0.2s ease;
            border: 2px solid #333;
        }

        .chord-in-progression.current {
            background: #dc2626;
            color: #fafafa;
            border-color: #dc2626;
            transform: scale(1.1);
            box-shadow: 0 0 25px rgba(220, 38, 38, 0.5);
        }

        .chord-in-progression:not(.current) {
            background: #1a1a1a;
            color: #888;
        }

        /* Chord Diagram Component - HORIZONTAL like fretboard */
        .chord-diagram {
            background: linear-gradient(180deg, #1a1412 0%, #0d0a08 100%);
            border-radius: 12px;
            border: 2px solid #333;
            padding: 16px;
            display: inline-block;
            position: relative;
            box-shadow:
                inset 0 0 40px rgba(0,0,0,0.6),
                0 0 0 1px #0a0a0a,
                0 10px 30px rgba(0,0,0,0.5);
        }

        .chord-diagram::before {
            content: '';
            position: absolute;
            inset: 0;
            background-image:
                url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='5' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
            opacity: 0.1;
            pointer-events: none;
            border-radius: 12px;
        }

        .chord-diagram-grid {
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .chord-diagram .nut {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 8px;
            background: linear-gradient(90deg, #f0ead6 0%, #c4b89a 100%);
            border-radius: 2px;
            box-shadow: 4px 0 10px rgba(0,0,0,0.4);
            z-index: 5;
        }

        .chord-diagram .string-row {
            display: flex;
            align-items: center;
            height: 32px;
            position: relative;
            border-bottom: 1px solid rgba(255, 255, 255, 0.02);
        }

        .chord-diagram .string-row::before {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            top: 50%;
            height: 2px;
            background: linear-gradient(90deg,
                rgba(200, 180, 160, 0.2) 0%,
                rgba(220, 200, 180, 0.7) 15%,
                rgba(200, 180, 160, 0.5) 50%,
                rgba(180, 160, 140, 0.3) 100%
            );
            transform: translateY(-50%);
            box-shadow: 0 1px 3px rgba(0,0,0,0.6);
        }

        .chord-diagram .string-row:nth-child(1)::before { height: 1px; opacity: 0.85; }
        .chord-diagram .string-row:nth-child(2)::before { height: 1.5px; opacity: 0.8; }
        .chord-diagram .string-row:nth-child(3)::before { height: 2px; opacity: 0.75; }
        .chord-diagram .string-row:nth-child(4)::before { height: 2.5px; opacity: 0.7; background: linear-gradient(90deg, rgba(180, 165, 150, 0.2) 0%, rgba(190, 175, 160, 0.65) 15%, rgba(170, 155, 140, 0.45) 50%, rgba(160, 145, 130, 0.25) 100%); }
        .chord-diagram .string-row:nth-child(5)::before { height: 3px; opacity: 0.65; background: linear-gradient(90deg, rgba(160, 150, 140, 0.2) 0%, rgba(170, 160, 150, 0.55) 15%, rgba(150, 140, 130, 0.35) 50%, rgba(140, 130, 120, 0.18) 100%); }
        .chord-diagram .string-row:nth-child(6)::before { height: 3.5px; opacity: 0.6; background: linear-gradient(90deg, rgba(150, 140, 130, 0.2) 0%, rgba(160, 150, 140, 0.45) 15%, rgba(140, 130, 120, 0.28) 50%, rgba(130, 120, 110, 0.15) 100%); }

        .chord-diagram .fret-cell {
            position: relative;
            width: 50px;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            border-right: 3px solid #555;
            box-shadow: inset -2px 0 6px rgba(0,0,0,0.4), inset 2px 0 4px rgba(255,255,255,0.02);
        }

        .chord-diagram .fret-cell.nut-fret {
            width: 35px;
            background: linear-gradient(90deg, #f0ead6 0%, #d8cdb8 50%, #c4b89a 100%);
            border-right: 5px solid #1a1a1a;
            box-shadow: inset -4px 0 10px rgba(0,0,0,0.5), 4px 0 12px rgba(0,0,0,0.4);
        }

        .chord-diagram .finger-dot {
            width: 26px;
            height: 26px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 11px;
            font-weight: 700;
            z-index: 10;
            position: relative;
            text-transform: uppercase;
        }

        .chord-diagram .finger-dot.root {
            background: #dc2626;
            color: #fafafa;
            box-shadow:
                0 0 0 2px #0a0a0a,
                0 0 15px rgba(220, 38, 38, 0.6),
                0 3px 10px rgba(0,0,0,0.4);
        }

        .chord-diagram .finger-dot.note {
            background: #fafafa;
            color: #0a0a0a;
            box-shadow:
                0 0 0 2px #0a0a0a,
                0 3px 10px rgba(0,0,0,0.4);
        }

        .chord-diagram .open-indicator {
            position: absolute;
            left: -24px;
            width: 18px;
            height: 18px;
            border: 2px solid #fafafa;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: #fafafa;
            font-weight: 600;
        }

        .chord-diagram .muted-indicator {
            position: absolute;
            left: -24px;
            font-size: 16px;
            color: #666;
            font-weight: bold;
        }

        .chord-diagram .barre-line {
            position: absolute;
            width: 20px;
            background: #fafafa;
            border-radius: 10px;
            z-index: 5;
            box-shadow: 0 2px 8px rgba(0,0,0,0.5);
            left: 50%;
            transform: translateX(-50%);
        }

        .chord-diagram .fret-numbers {
            display: flex;
            padding-left: 35px;
            margin-top: 6px;
        }

        .chord-diagram .fret-num {
            width: 50px;
            text-align: center;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 11px;
            font-weight: 600;
            color: #666;
        }

        .chord-diagram .string-labels-left {
            position: absolute;
            left: -28px;
            top: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
        }

        .chord-diagram .string-label-item {
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 11px;
            font-weight: 600;
            color: #666;
        }

        /* Chord name display - industrial */
        .chord-name-display {
            text-align: center;
            margin-bottom: 12px;
        }

        .chord-name-display .chord-symbol {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 36px;
            color: #fafafa;
            letter-spacing: 2px;
        }

        .chord-name-display .chord-type {
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 13px;
            font-weight: 500;
            color: #888;
            margin-top: 4px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        /* Position indicator - industrial with rounded */
        .position-indicator {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 8px 16px;
            background: #1a1a1a;
            border: 2px solid #333;
            border-left: 4px solid #dc2626;
            border-radius: 20px;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 13px;
            font-weight: 600;
            color: #fafafa;
            margin: 10px 0;
        }

        /* Fretboard zone highlight */
        .fret.in-zone {
            background: rgba(220, 38, 38, 0.06);
        }

        .fret.zone-start {
            border-left: 3px solid rgba(220, 38, 38, 0.6);
        }

        .fret.zone-end {
            border-right: 3px solid rgba(220, 38, 38, 0.6);
        }

        /* Box/Position selector - industrial with rounded */
        .box-selector {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin: 16px 0;
        }

        .box-btn {
            width: 44px;
            height: 44px;
            border-radius: 10px;
            border: 2px solid #333;
            background: #1a1a1a;
            color: #888;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 20px;
            font-weight: 400;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .box-btn:hover {
            border-color: #666;
            color: #fafafa;
        }

        .box-btn.active {
            background: #dc2626;
            color: #fafafa;
            border-color: #dc2626;
            box-shadow: 0 0 15px rgba(220, 38, 38, 0.4);
        }

        /* Diagrams container */
        .diagrams-container {
            display: flex;
            flex-direction: row;
            gap: 16px;
            justify-content: center;
            align-items: flex-start;
            flex-wrap: wrap;
            max-width: 100%;
            overflow-x: auto;
            padding: 8px;
        }

        .diagrams-container.scrollable-horizontal {
            flex-wrap: nowrap;
            overflow-x: auto;
            overflow-y: hidden;
            padding-bottom: 12px;
        }

        .diagrams-container.scrollable-horizontal::-webkit-scrollbar {
            height: 8px;
        }

        .diagrams-container.scrollable-horizontal::-webkit-scrollbar-thumb {
            background: linear-gradient(90deg, #dc2626 0%, #991b1b 100%);
            border-radius: 4px;
        }

        .chord-diagram.compact {
            min-width: 140px;
            max-width: 160px;
            padding: 12px;
        }

        .chord-diagram.compact .chord-name-display .chord-symbol {
            font-size: 28px;
        }

        .chord-diagram.compact .fret-cell {
            width: 40px;
        }

        .chord-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: all 0.3s ease;
        }

        .chord-wrapper.active-chord {
            transform: scale(1.05);
        }

        /* Interval label on fretboard */
        .note-bubble .interval-label {
            font-size: 10px;
            font-weight: 600;
            opacity: 0.9;
        }

        /* Dimmed notes (outside current zone) */
        .note-bubble.dimmed {
            opacity: 0.2;
            transform: scale(0.65);
        }

        /* Simplified Sidebar Navigation - industrial with rounded */
        .level-nav-btn {
            display: flex;
            align-items: center;
            gap: 14px;
            width: 100%;
            padding: 14px 16px;
            border-radius: 12px;
            border: 2px solid transparent;
            background: rgba(18, 18, 18, 0.6);
            cursor: pointer;
            transition: all 0.15s ease;
            text-align: left;
        }

        .level-nav-btn:hover {
            background: rgba(26, 26, 26, 0.9);
            border-color: #333;
        }

        .level-nav-btn.active {
            background: #1a1a1a;
            border-color: #dc2626;
            box-shadow: 0 0 20px rgba(220, 38, 38, 0.15);
        }

        .level-nav-text {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .level-nav-title {
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 15px;
            font-weight: 600;
            color: #e5e5e5;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .level-nav-sub {
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 12px;
            color: #666;
            font-weight: 400;
        }

        .level-nav-btn.active .level-nav-title {
            color: #dc2626;
        }

        /* Simple mode buttons - industrial with rounded */
        .mode-btn-simple, .progression-btn-simple {
            padding: 10px 16px;
            border-radius: 8px;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 12px;
            font-weight: 600;
            border: 2px solid #333;
            background: #151515;
            color: #999;
            cursor: pointer;
            transition: all 0.15s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .mode-btn-simple:hover, .progression-btn-simple:hover {
            border-color: #666;
            color: #fafafa;
            background: #1a1a1a;
        }

        .mode-btn-simple.active, .progression-btn-simple.active {
            background: #fafafa;
            color: #0a0a0a;
            border-color: #fafafa;
            font-weight: 700;
        }

        /* Scale category buttons - industrial with rounded */
        .scale-cat-btn {
            padding: 8px 14px;
            border-radius: 8px;
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 13px;
            font-weight: 600;
            border: 2px solid #333;
            background: #151515;
            color: #888;
            cursor: pointer;
            transition: all 0.15s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .scale-cat-btn:hover {
            border-color: #d4a574;
            color: #d4a574;
        }

        .scale-cat-btn.active {
            background: #d4a574;
            color: #0a0a0a;
            border-color: #d4a574;
            font-weight: 700;
        }

        /* Scale list item - industrial with rounded */
        .scale-list-item {
            padding: 12px 14px;
            border-radius: 10px;
            border: 2px solid #252525;
            background: #151515;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .scale-list-item:hover {
            border-color: #444;
            background: #1a1a1a;
        }

        .scale-list-item.active {
            border-color: #dc2626;
            background: rgba(220, 38, 38, 0.08);
        }

        .scale-list-item .scale-name {
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 15px;
            font-weight: 600;
            color: #fafafa;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .scale-list-item .scale-emotion {
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 12px;
            color: #666;
            margin-top: 4px;
            font-weight: 400;
        }

        /* Scale info box - matching app theme */
        .scale-info-box {
            background: linear-gradient(180deg, #1a1412 0%, #0d0a08 100%);
            border: 2px solid #333;
            border-radius: 12px;
            padding: 20px;
            position: relative;
            box-shadow:
                inset 0 0 40px rgba(0,0,0,0.5),
                0 0 0 1px #0a0a0a,
                0 10px 30px rgba(0,0,0,0.4);
        }

        .scale-info-box::before {
            content: '';
            position: absolute;
            inset: 0;
            background-image:
                url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='5' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
            opacity: 0.08;
            pointer-events: none;
            border-radius: 12px;
        }

        .scale-info-box .info-header {
            border-bottom: 1px solid #333;
            padding-bottom: 16px;
            margin-bottom: 16px;
        }

        .scale-info-box .info-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 28px;
            color: #dc2626;
            letter-spacing: 2px;
            margin-bottom: 8px;
        }

        .scale-info-box .info-emotion {
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 15px;
            color: #e5e5e5;
            font-style: italic;
        }

        .scale-info-box .info-section {
            background: #151515;
            border: 2px solid #252525;
            border-radius: 10px;
            padding: 14px;
            margin-bottom: 12px;
        }

        .scale-info-box .info-section.accent {
            border-left: 4px solid #dc2626;
        }

        .scale-info-box .info-label {
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 11px;
            font-weight: 600;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 8px;
        }

        .scale-info-box .info-value {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 16px;
            font-weight: 600;
            color: #fafafa;
        }

        .scale-info-box .info-value.highlight {
            color: #dc2626;
        }

        .scale-info-box .info-description {
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 13px;
            color: #e5e5e5;
            margin-top: 6px;
        }

        .scale-info-box .brightness-bar {
            height: 8px;
            background: #1a1a1a;
            border-radius: 4px;
            overflow: hidden;
            border: 1px solid #333;
        }

        .scale-info-box .brightness-fill {
            height: 100%;
            border-radius: 4px;
            background: linear-gradient(90deg, #333 0%, #dc2626 50%, #d4a574 100%);
            transition: width 0.5s ease;
        }

        .scale-info-box .context-tag {
            display: inline-block;
            padding: 6px 12px;
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 12px;
            font-weight: 600;
            color: #ccc;
            background: #1a1a1a;
            border: 2px solid #333;
            border-radius: 20px;
            margin: 3px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .scale-info-box .parent-scale-box {
            background: linear-gradient(90deg, rgba(220, 38, 38, 0.15) 0%, transparent 100%);
            border-left: 4px solid #dc2626;
            border-radius: 8px;
            padding: 12px 14px;
        }

        /* Harmonization chord buttons - matching app theme */
        .harm-chord-btn {
            padding: 12px 16px;
            border-radius: 10px;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 13px;
            font-weight: 600;
            border: 2px solid #333;
            background: #151515;
            color: #ccc;
            cursor: pointer;
            transition: all 0.15s ease;
            text-align: center;
            min-width: 64px;
        }

        .harm-chord-btn:hover {
            border-color: #dc2626;
            color: #fafafa;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .harm-chord-btn.active {
            background: #dc2626;
            color: #fafafa;
            border-color: #dc2626;
            box-shadow: 0 0 15px rgba(220, 38, 38, 0.4);
        }

        .harm-chord-btn.type-maj {
            border-color: #22c55e30;
        }
        .harm-chord-btn.type-maj:hover, .harm-chord-btn.type-maj.active {
            border-color: #22c55e;
            box-shadow: 0 0 12px rgba(34, 197, 94, 0.3);
        }

        .harm-chord-btn.type-min {
            border-color: #3b82f630;
        }
        .harm-chord-btn.type-min:hover, .harm-chord-btn.type-min.active {
            border-color: #3b82f6;
            box-shadow: 0 0 12px rgba(59, 130, 246, 0.3);
        }

        .harm-chord-btn.type-dim {
            border-color: #dc262630;
        }
        .harm-chord-btn.type-dim:hover, .harm-chord-btn.type-dim.active {
            border-color: #dc2626;
            box-shadow: 0 0 12px rgba(220, 38, 38, 0.3);
        }

        .harm-chord-btn .chord-quality {
            font-size: 10px;
            opacity: 0.7;
            display: block;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            margin-top: 4px;
        }

        /* Scale comparison colors - industrial */
        .note-common { color: #4ade80; }
        .note-only-first { color: #dc2626; }
        .note-only-second { color: #d4a574; }

        /* Note highlight for comparison mode */
        .note-bubble.comparison-common {
            background: #4ade80 !important;
            color: #0a0a0a !important;
            box-shadow: 0 0 0 2px #0a0a0a, 0 0 15px rgba(74, 222, 128, 0.5) !important;
        }

        .note-bubble.comparison-different {
            background: #d4a574 !important;
            color: #0a0a0a !important;
            box-shadow: 0 0 0 2px #0a0a0a, 0 0 15px rgba(212, 165, 116, 0.5) !important;
        }

        /* Custom selection styling */
        ::selection {
            background: #dc2626;
            color: #fafafa;
        }

        /* Quiz styles */
        .quiz-cat-btn {
            padding: 8px 14px;
            border-radius: 8px;
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 13px;
            font-weight: 600;
            border: 2px solid #333;
            background: #151515;
            color: #888;
            cursor: pointer;
            transition: all 0.15s ease;
            text-transform: uppercase;
        }
        .quiz-cat-btn:hover { border-color: #dc2626; color: #dc2626; }
        .quiz-cat-btn.active { background: #dc2626; color: #fafafa; border-color: #dc2626; }

        .quiz-question-box {
            background: #121212;
            border: 2px solid #333;
            border-left: 4px solid #dc2626;
            border-radius: 12px;
            padding: 24px;
            margin: 20px 0;
        }

        .quiz-option {
            padding: 12px 20px;
            border-radius: 10px;
            border: 2px solid #333;
            background: #1a1a1a;
            color: #ccc;
            cursor: pointer;
            transition: all 0.15s ease;
            margin: 8px 0;
            display: block;
            width: 100%;
            text-align: left;
        }
        .quiz-option:hover { border-color: #666; color: #fafafa; }
        .quiz-option.correct { border-color: #22c55e; background: rgba(34, 197, 94, 0.15); color: #22c55e; }
        .quiz-option.incorrect { border-color: #dc2626; background: rgba(220, 38, 38, 0.15); color: #dc2626; }
        .quiz-option.disabled { pointer-events: none; opacity: 0.6; }

        /* Song card */
        .song-card {
            background: #121212;
            border: 2px solid #252525;
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.15s ease;
            min-width: 200px;
        }
        .song-card:hover { border-color: #444; transform: translateY(-2px); }
        .song-card.active { border-color: #dc2626; box-shadow: 0 0 20px rgba(220, 38, 38, 0.2); }

        .genre-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .genre-badge.metal { background: #991b1b; color: #fafafa; }
        .genre-badge.prog { background: #7c3aed; color: #fafafa; }
        .genre-badge.rock { background: #d97706; color: #fafafa; }
        .genre-badge.blues { background: #1e40af; color: #fafafa; }
        .genre-badge.jazz { background: #a67c52; color: #0a0a0a; }
        .genre-badge.funk { background: #9333ea; color: #fafafa; }
        .genre-badge.pop { background: #dc2626; color: #fafafa; }
        .genre-badge.latin { background: #b91c1c; color: #fafafa; }
        .genre-badge.country { background: #92400e; color: #fafafa; }
        .genre-badge.reggae { background: #166534; color: #fafafa; }
        .genre-badge.grunge { background: #333333; color: #fafafa; }

        /* Extended chord matrix */
        .ext-matrix-grid {
            display: grid;
            grid-template-columns: auto repeat(4, 1fr);
            gap: 6px;
            max-width: 500px;
        }
        .ext-matrix-corner { }
        .ext-matrix-col-header {
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 11px;
            font-weight: 700;
            color: #d4a574;
            text-transform: uppercase;
            text-align: center;
            padding: 4px 0;
            letter-spacing: 0.5px;
        }
        .ext-matrix-row-header {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 18px;
            color: #dc2626;
            display: flex;
            align-items: center;
            padding-right: 8px;
        }
        .ext-matrix-btn {
            background: #1a1a1a;
            border: 2px solid #333;
            border-radius: 8px;
            color: #e5e5e5;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 13px;
            font-weight: 600;
            padding: 8px 6px;
            cursor: pointer;
            transition: all 0.15s ease;
            text-align: center;
        }
        .ext-matrix-btn:hover {
            border-color: #dc2626;
            background: #252525;
            color: #fafafa;
        }
        .ext-matrix-btn.active {
            background: #dc2626;
            border-color: #dc2626;
            color: #fafafa;
            box-shadow: 0 0 12px rgba(220, 38, 38, 0.3);
        }

        /* Extended chord info */
        .ext-chord-info {
            background: #121212;
            border: 2px solid #333;
            border-radius: 12px;
            padding: 16px;
            margin-top: 16px;
        }

        /* Secondary dominant arrows */
        .sec-dom-arrow {
            font-size: 24px;
            color: #666;
            margin: 0 8px;
        }

        .sec-dom-chord {
            padding: 12px 16px;
            border-radius: 10px;
            border: 2px solid #333;
            background: #1a1a1a;
            text-align: center;
            min-width: 60px;
        }
        .sec-dom-chord.dominant { border-color: #d97706; background: rgba(217, 119, 6, 0.1); }
        .sec-dom-chord.target { border-color: #22c55e; background: rgba(34, 197, 94, 0.1); }

        /* Additional visual enhancements */
        .section-divider {
            height: 2px;
            background: linear-gradient(90deg, transparent 0%, #333 20%, #333 80%, transparent 100%);
            margin: 20px 0;
        }

        /* Glow effects for important elements */
        .glow-red {
            box-shadow: 0 0 20px rgba(220, 38, 38, 0.4);
        }

        .glow-white {
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.2);
        }

        /* Border accents */
        .border-accent-left {
            border-left: 4px solid #dc2626;
        }

        .border-accent-top {
            border-top: 2px solid #dc2626;
        }

        /* Text utilities */
        .text-display {
            font-family: 'Bebas Neue', sans-serif;
            letter-spacing: 2px;
        }

        .text-mono {
            font-family: 'IBM Plex Mono', monospace;
        }

        .text-body {
            font-family: 'Barlow Condensed', sans-serif;
        }

        /* Subtle hover states for interactive elements */
        .hover-lift:hover {
            transform: translateY(-2px);
        }

        .hover-glow:hover {
            box-shadow: 0 0 25px rgba(220, 38, 38, 0.3);
        }

        /* Responsive styles for chord diagrams */
        @media (max-width: 768px) {
            .diagrams-container {
                gap: 12px;
            }

            .chord-diagram {
                min-width: 140px;
                max-width: 160px;
            }
        }

        @media (max-width: 480px) {
            .diagrams-container {
                flex-direction: column;
                flex-wrap: nowrap;
            }

            .chord-diagram {
                width: 100%;
                max-width: 280px;
            }

            .diagrams-container.scrollable-horizontal {
                flex-direction: column;
                overflow-x: hidden;
            }
        }

        /* Toggle switch styles para el toggle de batera */
        .slider {
            position: relative;
            display: block;
            cursor: pointer;
            user-select: none;
        }

        .slider .dot {
            transition: transform 0.3s ease;
        }

        input[type="checkbox"]:checked + .slider {
            background-color: #dc2626 !important;
        }

        input[type="checkbox"]:checked + .slider .dot {
            transform: translateX(24px) !important;
        }

        input[type="checkbox"]:not(:checked) + .slider {
            background-color: #404040 !important;
        }

        input[type="checkbox"]:not(:checked) + .slider .dot {
            transform: translateX(0) !important;
        }

        /* Estilos para el slider de BPM */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            height: 6px;
            background: #333;
            border-radius: 3px;
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            background: #dc2626;
            cursor: pointer;
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(220, 38, 38, 0.5);
        }

        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: #dc2626;
            cursor: pointer;
            border-radius: 50%;
            border: none;
            box-shadow: 0 0 10px rgba(220, 38, 38, 0.5);
        }

        input[type="range"]:hover::-webkit-slider-thumb {
            box-shadow: 0 0 15px rgba(220, 38, 38, 0.8);
        }

        input[type="range"]:hover::-moz-range-thumb {
            box-shadow: 0 0 15px rgba(220, 38, 38, 0.8);
        }

        /* Toast notifications */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            min-width: 300px;
            max-width: 400px;
            background: #1a1a1a;
            border: 2px solid #333;
            border-left: 4px solid #dc2626;
            border-radius: 12px;
            padding: 16px 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.6);
            transform: translateX(500px);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 10000;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .toast.show {
            transform: translateX(0);
            opacity: 1;
        }

        .toast.toast-success {
            border-left-color: #22c55e;
        }

        .toast.toast-error {
            border-left-color: #dc2626;
        }

        .toast.toast-info {
            border-left-color: #3b82f6;
        }

        .toast.toast-warning {
            border-left-color: #f59e0b;
        }

        .toast-icon {
            font-size: 20px;
            flex-shrink: 0;
        }

        .toast-content {
            flex: 1;
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 14px;
            color: #e5e5e5;
            line-height: 1.5;
        }

        .toast-success .toast-icon { color: #22c55e; }
        .toast-error .toast-icon { color: #dc2626; }
        .toast-info .toast-icon { color: #3b82f6; }
        .toast-warning .toast-icon { color: #f59e0b; }

        /* Loading spinner */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #333;
            border-top-color: #dc2626;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(10, 10, 10, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .loading-overlay.show {
            opacity: 1;
            pointer-events: all;
        }

        .loading-content {
            text-align: center;
        }

        .loading-content .loading-spinner {
            width: 60px;
            height: 60px;
            border-width: 4px;
            margin-bottom: 20px;
        }

        .loading-content .loading-text {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 20px;
            color: #fafafa;
            letter-spacing: 2px;
        }
    </style>
</head>
<body>
    <!-- Screen reader announcements -->
    <div id="sr-announcements" aria-live="polite" aria-atomic="true" class="sr-only" style="position: absolute; left: -10000px; width: 1px; height: 1px; overflow: hidden;"></div>

    <div class="min-h-screen flex">
        <!-- Sidebar -->
        <aside class="w-80 bg-void-900 border-r-2 border-void-700 flex flex-col">
            <!-- Logo -->
            <div class="p-6 border-b-2 border-void-700 header-glow relative">
                <div class="absolute top-0 left-0 w-full h-1 bg-blood-400"></div>
                <h1 class="font-display text-4xl text-chalk-100 tracking-widest">GUITAR</h1>
                <p class="font-heading text-2xl text-blood-400 -mt-1 tracking-wide">THEORY MASTER</p>
                <p class="text-xs text-void-400 mt-3 font-mono tracking-wider">V2.0  TEORA MUSICAL</p>
            </div>

            <!-- Levels Navigation - Industrial -->
            <nav class="flex-1 overflow-y-auto p-4 space-y-1" id="levelsNav">
                <button class="level-nav-btn active" data-level="1" aria-label="Nivel 1: Intervalos - Distancias entre notas" aria-current="page">
                    <div class="level-badge bg-blood-400 text-chalk-100">01</div>
                    <div class="level-nav-text">
                        <span class="level-nav-title">Intervalos</span>
                        <span class="level-nav-sub">Distancias entre notas</span>
                    </div>
                </button>

                <button class="level-nav-btn" data-level="2" aria-label="Nivel 2: Escalas - Todas las escalas y modos">
                    <div class="level-badge bg-chalk-100 text-void-950">02</div>
                    <div class="level-nav-text">
                        <span class="level-nav-title">Escalas</span>
                        <span class="level-nav-sub">Todas las escalas y modos</span>
                    </div>
                </button>

                <button class="level-nav-btn" data-level="3" aria-label="Nivel 3: Acordes - Armonizacin y voicings">
                    <div class="level-badge bg-brass-400 text-void-950">03</div>
                    <div class="level-nav-text">
                        <span class="level-nav-title">Acordes</span>
                        <span class="level-nav-sub">Armonizacin y voicings</span>
                    </div>
                </button>

                <button class="level-nav-btn" data-level="4" aria-label="Nivel 4: Modos Griegos - 7 colores de la escala">
                    <div class="level-badge bg-blood-400 text-chalk-100">04</div>
                    <div class="level-nav-text">
                        <span class="level-nav-title">Modos Griegos</span>
                        <span class="level-nav-sub">7 colores de la escala</span>
                    </div>
                </button>

                <button class="level-nav-btn" data-level="5" aria-label="Nivel 5: Pentatnicas - Las 5 posiciones">
                    <div class="level-badge bg-chalk-100 text-void-950">05</div>
                    <div class="level-nav-text">
                        <span class="level-nav-title">Pentatnicas</span>
                        <span class="level-nav-sub">Las 5 posiciones</span>
                    </div>
                </button>

                <button class="level-nav-btn" data-level="6" aria-label="Nivel 6: Crculo de Quintas - Mapa de tonalidades">
                    <div class="level-badge bg-brass-400 text-void-950">06</div>
                    <div class="level-nav-text">
                        <span class="level-nav-title">Crculo de 5as</span>
                        <span class="level-nav-sub">Mapa de tonalidades</span>
                    </div>
                </button>

                <button class="level-nav-btn" data-level="7" aria-label="Nivel 7: Progresiones - Secuencias famosas">
                    <div class="level-badge bg-blood-400 text-chalk-100">07</div>
                    <div class="level-nav-text">
                        <span class="level-nav-title">Progresiones</span>
                        <span class="level-nav-sub">Secuencias famosas</span>
                    </div>
                </button>

                <button class="level-nav-btn" data-level="8" aria-label="Nivel 8: Acordes Sptima - Ms color armnico">
                    <div class="level-badge bg-chalk-100 text-void-950">08</div>
                    <div class="level-nav-text">
                        <span class="level-nav-title">Acordes 7</span>
                        <span class="level-nav-sub">Ms color armnico</span>
                    </div>
                </button>

                <button class="level-nav-btn" data-level="9" aria-label="Nivel 9: Sistema CAGED - Domina el mstil">
                    <div class="level-badge bg-brass-400 text-void-950">09</div>
                    <div class="level-nav-text">
                        <span class="level-nav-title">Sistema CAGED</span>
                        <span class="level-nav-sub">Domina el mstil</span>
                    </div>
                </button>

                <button class="level-nav-btn" data-level="10" aria-label="Nivel 10: Quiz - Pon a prueba tu odo">
                    <div class="level-badge bg-blood-400 text-chalk-100">10</div>
                    <div class="level-nav-text">
                        <span class="level-nav-title">Quiz</span>
                        <span class="level-nav-sub">Pon a prueba tu odo</span>
                    </div>
                </button>

                <button class="level-nav-btn" data-level="11" aria-label="Nivel 11: Acordes Extendidos - Novena, Oncena, Trecena">
                    <div class="level-badge bg-chalk-100 text-void-950">11</div>
                    <div class="level-nav-text">
                        <span class="level-nav-title">Acordes Ext.</span>
                        <span class="level-nav-sub">9, 11, 13</span>
                    </div>
                </button>

                <button class="level-nav-btn" data-level="12" aria-label="Nivel 12: Dominantes Secundarios - Tensin armnica">
                    <div class="level-badge bg-brass-400 text-void-950">12</div>
                    <div class="level-nav-text">
                        <span class="level-nav-title">Dom. Secundarios</span>
                        <span class="level-nav-sub">Tensin armnica</span>
                    </div>
                </button>

                <button class="level-nav-btn" data-level="13" aria-label="Nivel 13: Canciones - Biblioteca de temas">
                    <div class="level-badge bg-blood-400 text-chalk-100">13</div>
                    <div class="level-nav-text">
                        <span class="level-nav-title">Canciones</span>
                        <span class="level-nav-sub">Biblioteca de temas</span>
                    </div>
                </button>

                <button class="level-nav-btn" data-level="14" aria-label="Nivel 14: Ear Training - Entrena tu odo">
                    <div class="level-badge bg-chalk-100 text-void-950">14</div>
                    <div class="level-nav-text">
                        <span class="level-nav-title">Ear Training</span>
                        <span class="level-nav-sub">Entrena tu odo</span>
                    </div>
                </button>

                <button class="level-nav-btn" data-level="15" aria-label="Nivel 15: Jam Session - Practica con bases">
                    <div class="level-badge bg-blood-400 text-chalk-100">15</div>
                    <div class="level-nav-text">
                        <span class="level-nav-title">Jam Session</span>
                        <span class="level-nav-sub">Practica con bases</span>
                    </div>
                </button>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col bg-void-950">
            <!-- Top Bar with Root Select - Industrial -->
            <header class="h-16 bg-void-900 border-b-2 border-void-700 flex items-center justify-between px-6">
                <div class="flex items-center gap-6">
                    <div>
                        <label class="text-xs text-void-400 block mb-1 font-mono tracking-wider uppercase">Nota Raz</label>
                        <select class="custom-select !py-2 !text-sm" id="rootSelect">
                            <option value="0">C (Do)</option>
                            <option value="1">C# / Db</option>
                            <option value="2">D (Re)</option>
                            <option value="3">D# / Eb</option>
                            <option value="4">E (Mi)</option>
                            <option value="5">F (Fa)</option>
                            <option value="6">F# / Gb</option>
                            <option value="7">G (Sol)</option>
                            <option value="8">G# / Ab</option>
                            <option value="9">A (La)</option>
                            <option value="10">A# / Bb</option>
                            <option value="11">B (Si)</option>
                        </select>
                    </div>
                </div>
                <div class="flex items-center gap-8">
                    <div class="flex items-center gap-3">
                        <span class="text-sm text-void-300 font-body uppercase tracking-wide">Notas</span>
                        <div class="toggle-switch active" id="showNotesToggle" role="switch" aria-checked="true" aria-label="Mostrar nombres de notas" tabindex="0"></div>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="text-sm text-void-300 font-body uppercase tracking-wide">Grados</span>
                        <div class="toggle-switch" id="showFunctionsToggle" role="switch" aria-checked="false" aria-label="Mostrar grados de la escala" tabindex="0"></div>
                    </div>
                    <div class="flex items-center gap-3">
                        <button class="btn-secondary !py-2 !px-4 !text-xs" id="metronomeBtn" aria-label="Activar metrnomo">
                            <span id="metronomeIcon"></span>
                            <span id="bpmDisplay">120</span>
                            <span id="metronomeBeatIndicator" class="ml-2 text-xs font-mono" style="min-width: 30px;">1/4</span>
                        </button>
                        <button class="btn-secondary !py-1 !px-3 !text-xs" id="tapTempoBtn" aria-label="Tap Tempo" title="Click varias veces para detectar BPM">
                            TAP
                        </button>
                        <button class="btn-secondary !py-1 !px-3 !text-xs" id="metronomeSettingsBtn" aria-label="Configuracin del metrnomo" title="Comps, subdivisiones, etc.">
                            
                        </button>
                    </div>
                </div>
            </header>

            <!-- Control Panel Area (changes based on level) - Industrial -->
            <div class="bg-void-800/50 border-b-2 border-void-700 p-5" id="controlPanel">
                <!-- Content generated by JS based on current level -->
            </div>

            <!-- Fretboard Area - Industrial -->
            <div class="flex-1 flex flex-col items-center justify-center p-8 overflow-y-auto">
                <!-- Current Display Info -->
                <div class="mb-6 text-center">
                    <h2 class="font-display text-4xl text-chalk-100 tracking-widest" id="displayTitle">SELECCIONA UN NIVEL</h2>
                    <p class="text-void-400 text-sm mt-2 font-body uppercase tracking-wider" id="displaySubtitle">Usa la barra lateral para empezar</p>
                </div>

                <!-- Chord Diagrams Container -->
                <div class="diagrams-container mb-4 hidden" id="diagramsContainer">
                    <!-- Generated by JS -->
                </div>

                <!-- Box/Position Selector -->
                <div class="box-selector hidden mb-4" id="boxSelector">
                    <!-- Generated by JS -->
                </div>

                <!-- Fretboard -->
                <div class="w-full max-w-5xl">
                    <!-- Fret Numbers - Industrial -->
                    <div class="flex mb-3 pl-8">
                        <div class="w-8"></div>
                        <div class="flex flex-1">
                            <div class="flex-[0.6] flex justify-center font-mono text-sm text-void-500 font-semibold"><span style="margin-right: 5px;">0</span></div>
                            <div class="flex-1 flex justify-center font-mono text-sm text-void-500 font-semibold"><span style="margin-right: 3px;">1</span></div>
                            <div class="flex-1 flex justify-center font-mono text-sm text-void-500 font-semibold"><span style="margin-right: 3px;">2</span></div>
                            <div class="flex-1 flex justify-center font-mono text-sm text-void-400 font-bold"><span style="margin-right: 3px;">3</span></div>
                            <div class="flex-1 flex justify-center font-mono text-sm text-void-500 font-semibold"><span style="margin-right: 3px;">4</span></div>
                            <div class="flex-1 flex justify-center font-mono text-sm text-void-400 font-bold"><span style="margin-right: 3px;">5</span></div>
                            <div class="flex-1 flex justify-center font-mono text-sm text-void-500 font-semibold"><span style="margin-right: 3px;">6</span></div>
                            <div class="flex-1 flex justify-center font-mono text-sm text-void-400 font-bold"><span style="margin-right: 3px;">7</span></div>
                            <div class="flex-1 flex justify-center font-mono text-sm text-void-500 font-semibold"><span style="margin-right: 3px;">8</span></div>
                            <div class="flex-1 flex justify-center font-mono text-sm text-void-400 font-bold"><span style="margin-right: 3px;">9</span></div>
                            <div class="flex-1 flex justify-center font-mono text-sm text-void-500 font-semibold"><span style="margin-right: 3px;">10</span></div>
                            <div class="flex-1 flex justify-center font-mono text-sm text-void-500 font-semibold"><span style="margin-right: 3px;">11</span></div>
                            <div class="flex-1 flex justify-center font-mono text-sm text-blood-400 font-bold"><span style="margin-right: 3px;">12</span></div>
                        </div>
                    </div>

                    <!-- Fretboard Container -->
                    <div class="fretboard-container p-4" id="fretboard">
                        <!-- Generated by JS -->
                    </div>

                    <!-- Fret markers - Industrial with rounded -->
                    <div class="flex mt-3 pl-8">
                        <div class="w-8"></div>
                        <div class="flex flex-1">
                            <div class="flex-[0.6]"></div>
                            <div class="flex-1"></div>
                            <div class="flex-1"></div>
                            <div class="flex-1 flex justify-center"><div class="w-3 h-3 rounded-full bg-void-500" style="margin-right: 3px;"></div></div>
                            <div class="flex-1"></div>
                            <div class="flex-1 flex justify-center"><div class="w-3 h-3 rounded-full bg-void-500" style="margin-right: 3px;"></div></div>
                            <div class="flex-1"></div>
                            <div class="flex-1 flex justify-center"><div class="w-3 h-3 rounded-full bg-void-500" style="margin-right: 3px;"></div></div>
                            <div class="flex-1"></div>
                            <div class="flex-1 flex justify-center"><div class="w-3 h-3 rounded-full bg-void-500" style="margin-right: 3px;"></div></div>
                            <div class="flex-1"></div>
                            <div class="flex-1"></div>
                            <div class="flex-1 flex justify-center gap-2" style="margin-right: 3px;"><div class="w-3 h-3 rounded-full bg-blood-500"></div><div class="w-3 h-3 rounded-full bg-blood-500"></div></div>
                        </div>
                    </div>
                </div>

                <!-- Scale/Chord Info Panel - Industrial -->
                <div class="mt-8 w-full max-w-5xl" id="infoPanel">
                    <!-- Generated by JS -->
                </div>
            </div>
        </main>
    </div>

    <!-- TEMPLATES FOR CONTROL PANELS -->
    <template id="tpl-intervals">
        <div class="flex flex-wrap items-center gap-4">
            <span class="text-sm text-void-400 font-body uppercase tracking-wider font-semibold">Intervalo:</span>
            <div class="flex flex-wrap gap-2">
                <button class="interval-btn" data-interval="1">2 m</button>
                <button class="interval-btn" data-interval="2">2 M</button>
                <button class="interval-btn" data-interval="3">3 m</button>
                <button class="interval-btn" data-interval="4">3 M</button>
                <button class="interval-btn" data-interval="5">4 J</button>
                <button class="interval-btn" data-interval="6">Tritono</button>
                <button class="interval-btn" data-interval="7">5 J</button>
                <button class="interval-btn" data-interval="8">6 m</button>
                <button class="interval-btn" data-interval="9">6 M</button>
                <button class="interval-btn" data-interval="10">7 m</button>
                <button class="interval-btn" data-interval="11">7 M</button>
            </div>
        </div>
    </template>

    <template id="tpl-scales">
        <div class="space-y-4">
            <div class="flex flex-wrap items-center gap-4">
                <span class="text-sm text-void-400 font-body uppercase tracking-wider font-semibold">Categora:</span>
                <div class="flex flex-wrap gap-2" id="scaleCatBtnsMain">
                    <button class="scale-cat-btn active" data-category="major">Mayores</button>
                    <button class="scale-cat-btn" data-category="minor">Menores</button>
                    <button class="scale-cat-btn" data-category="modes">Modos Griegos</button>
                    <button class="scale-cat-btn" data-category="pentatonic">Pentatnicas</button>
                    <button class="scale-cat-btn" data-category="exotic">Exticas</button>
                </div>
            </div>
            <div class="flex flex-wrap items-center gap-4">
                <span class="text-sm text-void-400 font-body uppercase tracking-wider font-semibold">Escala:</span>
                <div class="flex flex-wrap gap-2" id="scaleListMain">
                    <!-- Generated by JS -->
                </div>
            </div>
        </div>
    </template>

    <template id="tpl-chords">
        <div class="space-y-3">
            <div class="flex flex-wrap items-center gap-3">
                <span class="text-sm text-slate-400">Grado:</span>
                <div class="flex flex-wrap gap-2">
                    <button class="chord-btn" data-chord="1"><span class="roman">I</span><span class="name">Mayor</span></button>
                    <button class="chord-btn" data-chord="2"><span class="roman">ii</span><span class="name">menor</span></button>
                    <button class="chord-btn" data-chord="3"><span class="roman">iii</span><span class="name">menor</span></button>
                    <button class="chord-btn" data-chord="4"><span class="roman">IV</span><span class="name">Mayor</span></button>
                    <button class="chord-btn" data-chord="5"><span class="roman">V</span><span class="name">Mayor</span></button>
                    <button class="chord-btn" data-chord="6"><span class="roman">vi</span><span class="name">menor</span></button>
                    <button class="chord-btn" data-chord="7"><span class="roman">vii</span><span class="name">dim</span></button>
                </div>
            </div>
        </div>
    </template>

    <template id="tpl-modes">
        <div class="flex flex-wrap items-center gap-3">
            <span class="text-sm text-slate-400">Modo:</span>
            <div class="flex flex-wrap gap-2">
                <button class="mode-btn-simple active" data-mode="1">I Jnico</button>
                <button class="mode-btn-simple" data-mode="2">II Drico</button>
                <button class="mode-btn-simple" data-mode="3">III Frigio</button>
                <button class="mode-btn-simple" data-mode="4">IV Lidio</button>
                <button class="mode-btn-simple" data-mode="5">V Mixolidio</button>
                <button class="mode-btn-simple" data-mode="6">VI Elico</button>
                <button class="mode-btn-simple" data-mode="7">VII Locrio</button>
            </div>
        </div>
    </template>

    <template id="tpl-pentatonics">
        <div class="space-y-3">
            <div class="flex flex-wrap items-center gap-3">
                <span class="text-sm text-slate-400">Tipo:</span>
                <div class="flex flex-wrap gap-2">
                    <button class="chord-btn active" data-penta="minor"><span class="roman">Menor</span></button>
                    <button class="chord-btn" data-penta="major"><span class="roman">Mayor</span></button>
                    <button class="chord-btn" data-penta="blues"><span class="roman">Blues</span></button>
                </div>
            </div>
            <div class="flex flex-wrap items-center gap-3">
                <span class="text-sm text-slate-400">Posicin:</span>
                <div class="flex gap-2" id="pentaBoxBtns">
                    <button class="box-btn active" data-box="0">1</button>
                    <button class="box-btn" data-box="1">2</button>
                    <button class="box-btn" data-box="2">3</button>
                    <button class="box-btn" data-box="3">4</button>
                    <button class="box-btn" data-box="4">5</button>
                </div>
            </div>
        </div>
    </template>

    <template id="tpl-circle">
        <div class="flex items-center justify-center">
            <div class="relative w-56 h-56" id="circleOfFifthsMain">
                <!-- Generated by JS -->
            </div>
            <div class="ml-8 text-sm text-slate-400">
                <p>Haz clic en una nota para cambiar la tonalidad</p>
                <p class="mt-2 text-cyan-400" id="circleInfo">-</p>
            </div>
        </div>
    </template>

    <template id="tpl-progressions">
        <div class="space-y-3">
            <div class="flex flex-wrap items-center gap-3">
                <span class="text-sm text-slate-400">Progresin:</span>
                <div class="flex flex-wrap gap-2">
                    <button class="progression-btn-simple active" data-progression="I-IV-V-I">I-IV-V-I</button>
                    <button class="progression-btn-simple" data-progression="I-V-vi-IV">I-V-vi-IV</button>
                    <button class="progression-btn-simple" data-progression="ii-V-I">ii-V-I</button>
                    <button class="progression-btn-simple" data-progression="I-vi-IV-V">I-vi-IV-V</button>
                    <button class="progression-btn-simple" data-progression="vi-IV-I-V">vi-IV-I-V</button>
                    <button class="progression-btn-simple" data-progression="I-bVII-IV-I">I-bVII-IV</button>
                </div>
            </div>
            <div class="flex flex-wrap items-center gap-3">
                <span class="text-sm text-slate-400">Avanzadas:</span>
                <div class="flex flex-wrap gap-2">
                    <button class="progression-btn-simple" data-progression="i-bVII-bVI-V">Andaluza</button>
                    <button class="progression-btn-simple" data-progression="i-bVI-bIII-bVII">Epic</button>
                    <button class="progression-btn-simple" data-progression="i-iv-v-i">Menor Cls.</button>
                    <button class="progression-btn-simple" data-progression="I-vi-ii-V">Rhythm Ch.</button>
                    <button class="progression-btn-simple" data-progression="I-V-vi-iii-IV-I-IV-V">Canon</button>
                </div>
            </div>
            <div class="flex flex-wrap items-center gap-3">
                <span class="text-sm text-slate-400">Jazz Avanzado:</span>
                <div class="flex flex-wrap gap-2">
                    <button class="progression-btn-simple" data-progression="bII7-I">Tritone Sub</button>
                    <button class="progression-btn-simple" data-progression="I-III7-VImaj7-bII7-I">Coltrane</button>
                    <button class="progression-btn-simple" data-progression="I-vi-ii-V-I-vi-ii-V-IV-iv-I-ii-V-I">Rhythm Full</button>
                    <button class="progression-btn-simple" data-progression="iii7-VI7-ii7-V7-I">iii-VI-ii-V-I</button>
                </div>
            </div>
            <div class="flex flex-wrap items-center gap-3">
                <span class="text-sm text-slate-400">Modal/Rock:</span>
                <div class="flex flex-wrap gap-2">
                    <button class="progression-btn-simple" data-progression="i-IV">Dorian</button>
                    <button class="progression-btn-simple" data-progression="I-bII">Phrygian</button>
                    <button class="progression-btn-simple" data-progression="bVII-IV-I">Mixolidio</button>
                    <button class="progression-btn-simple" data-progression="vi-V-IV-V">Indie</button>
                    <button class="progression-btn-simple" data-progression="i-bVII-bVI-bVII">Modal Menor</button>
                    <button class="progression-btn-simple" data-progression="I-III-vi-IV">Terceras</button>
                </div>
            </div>
            <!-- Controles de reproduccin de progresin -->
            <div class="mt-6 p-4 bg-black bg-opacity-30 rounded-lg border border-red-900 border-opacity-30">
                <div class="flex flex-wrap items-center gap-4 mb-4">
                    <button id="playProgressionBtn" class="px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded font-semibold transition-colors">
                         PLAY
                    </button>
                    <button id="pauseProgressionBtn" class="px-6 py-2 bg-yellow-600 hover:bg-yellow-700 text-white rounded font-semibold transition-colors" disabled>
                         PAUSE
                    </button>
                    <button id="stopProgressionBtn" class="px-6 py-2 bg-red-600 hover:bg-red-700 text-white rounded font-semibold transition-colors" disabled>
                         STOP
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm text-slate-400 mb-2">Tempo (BPM)</label>
                        <div class="flex items-center gap-3">
                            <input type="range" id="progressionBPMSlider" min="40" max="200" value="120"
                                class="flex-1 h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer">
                            <span id="progressionBPMDisplay" class="text-xl font-bold text-red-500 w-12 text-center">120</span>
                        </div>
                    </div>
                    <div class="flex items-center gap-6">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="progressionLoopToggle" class="w-5 h-5">
                            <span class="text-sm text-slate-300">Loop infinito</span>
                        </label>
                        <div class="flex items-center gap-2">
                            <label class="text-sm text-slate-400">Repetir:</label>
                            <input type="number" id="progressionRepeatInput" min="1" max="10" value="1"
                                class="w-16 px-2 py-1 bg-slate-800 text-white rounded border border-slate-600 text-center">
                            <span class="text-sm text-slate-400">veces</span>
                        </div>
                    </div>
                </div>
                <div class="mt-4 p-3 bg-slate-900 bg-opacity-50 rounded">
                    <div class="flex items-center justify-between mb-2">
                        <span id="progressionProgressText" class="text-lg font-bold text-white">Acorde 1 / 4</span>
                        <span id="progressionRepeatText" class="text-sm text-slate-400">Repeticin 1 / 1</span>
                    </div>
                    <div class="w-full h-3 bg-slate-800 rounded-full overflow-hidden">
                        <div id="progressionProgressBar" class="h-full bg-gradient-to-r from-green-500 to-red-500 transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <template id="tpl-seventh">
        <div class="flex flex-wrap items-center gap-3">
            <span class="text-sm text-slate-400">Acorde 7:</span>
            <div class="flex flex-wrap gap-2">
                <button class="chord-btn" data-chord7="1"><span class="roman">Imaj7</span></button>
                <button class="chord-btn" data-chord7="2"><span class="roman">ii-7</span></button>
                <button class="chord-btn" data-chord7="3"><span class="roman">iii-7</span></button>
                <button class="chord-btn" data-chord7="4"><span class="roman">IVmaj7</span></button>
                <button class="chord-btn" data-chord7="5"><span class="roman">V7</span></button>
                <button class="chord-btn" data-chord7="6"><span class="roman">vi-7</span></button>
                <button class="chord-btn" data-chord7="7"><span class="roman">vii7</span></button>
            </div>
        </div>
    </template>

    <template id="tpl-caged">
        <div class="space-y-3">
            <div class="flex flex-wrap items-center gap-3">
                <span class="text-sm text-slate-400">Forma CAGED:</span>
                <div class="flex flex-wrap gap-2">
                    <button class="chord-btn active" data-caged="C"><span class="roman">C</span></button>
                    <button class="chord-btn" data-caged="A"><span class="roman">A</span></button>
                    <button class="chord-btn" data-caged="G"><span class="roman">G</span></button>
                    <button class="chord-btn" data-caged="E"><span class="roman">E</span></button>
                    <button class="chord-btn" data-caged="D"><span class="roman">D</span></button>
                </div>
                <span class="text-xs text-slate-500 ml-4">Orden: C  A  G  E  D  C...</span>
            </div>
            <div class="flex items-center gap-3">
                <span class="text-sm text-void-300">Ver todas las formas</span>
                <div class="toggle-switch" id="cagedShowAllToggle" style="width: 48px; height: 24px; background: #333; border-radius: 12px; position: relative; cursor: pointer; transition: all 0.3s;">
                    <div style="width: 20px; height: 20px; background: #dc2626; border-radius: 50%; position: absolute; top: 2px; left: 2px; transition: all 0.3s;"></div>
                </div>
            </div>
        </div>
    </template>

    <template id="tpl-quiz">
        <div class="space-y-4">
            <div class="flex flex-wrap items-center gap-3">
                <span class="text-sm text-void-400">Categora:</span>
                <div class="flex flex-wrap gap-2">
                    <button class="quiz-cat-btn active" data-category="intervals">Intervalos</button>
                    <button class="quiz-cat-btn" data-category="scales">Escalas</button>
                    <button class="quiz-cat-btn" data-category="chords">Acordes</button>
                    <button class="quiz-cat-btn" data-category="modes">Modos</button>
                    <button class="quiz-cat-btn" data-category="theory">Teora</button>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <span class="text-sm text-void-400">Dificultad:</span>
                <button class="box-btn active" data-diff="easy">Fcil</button>
                <button class="box-btn" data-diff="medium">Medio</button>
                <button class="box-btn" data-diff="hard">Difcil</button>
            </div>
            <div class="flex items-center gap-6 text-sm">
                <span>Puntos: <strong id="quizScore" class="text-blood-400">0</strong></span>
                <span>Racha: <strong id="quizStreak" class="text-brass-400">0</strong></span>
                <span>Mejor: <strong id="quizBest" class="text-chalk-100">0</strong></span>
                <button class="btn-secondary ml-4" id="newQuizBtn">Nueva Pregunta</button>
            </div>
        </div>
    </template>

    <template id="tpl-extended">
        <div class="ext-matrix">
            <div class="ext-matrix-grid">
                <!-- Header row -->
                <div class="ext-matrix-corner"></div>
                <div class="ext-matrix-col-header">Major</div>
                <div class="ext-matrix-col-header">Dom</div>
                <div class="ext-matrix-col-header">Minor</div>
                <div class="ext-matrix-col-header">Alter.</div>
                <!-- 9 row -->
                <div class="ext-matrix-row-header">9</div>
                <button class="ext-matrix-btn active" data-ext="9" data-quality="maj">maj9</button>
                <button class="ext-matrix-btn" data-ext="9" data-quality="dom">9</button>
                <button class="ext-matrix-btn" data-ext="9" data-quality="min">m9</button>
                <button class="ext-matrix-btn" data-ext="9" data-quality="alt">7#9</button>
                <!-- 11 row -->
                <div class="ext-matrix-row-header">11</div>
                <button class="ext-matrix-btn" data-ext="11" data-quality="maj">maj11</button>
                <button class="ext-matrix-btn" data-ext="11" data-quality="dom">11</button>
                <button class="ext-matrix-btn" data-ext="11" data-quality="min">m11</button>
                <button class="ext-matrix-btn" data-ext="11" data-quality="alt">m11</button>
                <!-- 13 row -->
                <div class="ext-matrix-row-header">13</div>
                <button class="ext-matrix-btn" data-ext="13" data-quality="maj">maj13</button>
                <button class="ext-matrix-btn" data-ext="13" data-quality="dom">13</button>
                <button class="ext-matrix-btn" data-ext="13" data-quality="min">m13</button>
                <button class="ext-matrix-btn" data-ext="13" data-quality="alt">13</button>
            </div>
        </div>
    </template>

    <template id="tpl-secondary">
        <div class="space-y-3">
            <div class="flex flex-wrap items-center gap-3">
                <span class="text-sm text-void-400">Dominante de:</span>
                <button class="chord-btn active" data-secondary="ii">V/ii</button>
                <button class="chord-btn" data-secondary="iii">V/iii</button>
                <button class="chord-btn" data-secondary="IV">V/IV</button>
                <button class="chord-btn" data-secondary="V">V/V</button>
                <button class="chord-btn" data-secondary="vi">V/vi</button>
            </div>
            <div class="flex flex-wrap items-center gap-3">
                <span class="text-sm text-void-400">Progresiones:</span>
                <button class="progression-btn-simple" data-secprog="1">V/V  V  I</button>
                <button class="progression-btn-simple" data-secprog="2">I  V/vi  vi</button>
                <button class="progression-btn-simple" data-secprog="3">ii-V secundario</button>
            </div>
        </div>
    </template>

    <template id="tpl-songs">
        <div class="space-y-4">
            <div class="flex flex-wrap items-center gap-3">
                <span class="text-sm text-void-400">Gnero:</span>
                <button class="scale-cat-btn active" data-genre="all">Todos</button>
                <button class="scale-cat-btn" data-genre="metal">Metal</button>
                <button class="scale-cat-btn" data-genre="prog">Progresivo</button>
                <button class="scale-cat-btn" data-genre="rock">Rock</button>
                <button class="scale-cat-btn" data-genre="blues">Blues</button>
                <button class="scale-cat-btn" data-genre="jazz">Jazz</button>
                <button class="scale-cat-btn" data-genre="funk">Funk/Soul</button>
                <button class="scale-cat-btn" data-genre="pop">Pop</button>
                <button class="scale-cat-btn" data-genre="latin">Latino</button>
                <button class="scale-cat-btn" data-genre="country">Country</button>
                <button class="scale-cat-btn" data-genre="reggae">Reggae</button>
            </div>
        </div>
    </template>

    <template id="tpl-ear-training">
        <div class="space-y-4">
            <!-- Header con estilo industrial -->
            <div style="border-left: 3px solid #dc2626; padding-left: 12px; margin-bottom: 20px;">
                <div class="text-xs text-void-400 uppercase tracking-widest mb-1">Entrenamiento Auditivo</div>
                <div class="text-sm text-chalk-100">Desarrolla tu odo musical</div>
            </div>

            <!-- Dificultad -->
            <div class="flex flex-wrap items-center gap-3 mb-4">
                <span class="text-xs text-void-400 uppercase tracking-wider" style="min-width: 90px;">Nivel:</span>
                <button class="scale-cat-btn active" data-ear-level="easy">Principiante</button>
                <button class="scale-cat-btn" data-ear-level="medium">Intermedio</button>
                <button class="scale-cat-btn" data-ear-level="hard">Avanzado</button>
            </div>

            <!-- Controles principales -->
            <div class="grid grid-cols-2 gap-3 mb-6">
                <button id="playIntervalBtn" class="mode-btn-simple" style="background: #dc2626; padding: 14px; font-weight: 600;">
                     REPRODUCIR
                </button>
                <button id="newIntervalBtn" class="mode-btn-simple" style="background: #404040; padding: 14px;">
                     SIGUIENTE
                </button>
            </div>

            <!-- Respuestas -->
            <div style="background: rgba(0,0,0,0.4); padding: 16px; border-radius: 4px; border: 1px solid rgba(220, 38, 38, 0.2);">
                <div class="text-xs text-void-400 uppercase tracking-wider mb-3">Qu intervalo escuchaste?</div>
                <div id="earTrainingAnswers" class="grid grid-cols-2 gap-2">
                    <!-- Botones generados dinmicamente -->
                </div>
            </div>

            <!-- Tips -->
            <div style="background: rgba(220, 38, 38, 0.1); padding: 12px; border-radius: 4px; border-left: 3px solid #dc2626;">
                <div class="text-xs text-void-400 leading-relaxed">
                    <strong style="color: #dc2626;">TIP:</strong> Escucha el salto entre las dos notas.
                    Los intervalos pequeos (2, 3) suenan cercanos, mientras que los grandes (6, 7, 8) tienen un salto ms amplio.
                </div>
            </div>
        </div>
    </template>

    <template id="tpl-jam-session">
        <div class="space-y-4">
            <!-- Header con estilo industrial -->
            <div style="border-left: 3px solid #dc2626; padding-left: 12px; margin-bottom: 20px;">
                <div class="text-xs text-void-400 uppercase tracking-widest mb-1">Jam Session</div>
                <div class="text-sm text-chalk-100">Practica sobre bases profesionales</div>
            </div>

            <!-- Selector de estilo -->
            <div class="mb-4">
                <div class="text-xs text-void-400 uppercase tracking-wider mb-2">Estilo:</div>
                <div class="flex flex-wrap gap-2">
                    <button class="scale-cat-btn active" data-track="blues-12bar">Blues Shuffle</button>
                    <button class="scale-cat-btn" data-track="blues-slow">Slow Blues</button>
                    <button class="scale-cat-btn" data-track="rock-pop">Pop</button>
                    <button class="scale-cat-btn" data-track="rock-driving">Rock</button>
                    <button class="scale-cat-btn" data-track="metal-riff">Metal</button>
                    <button class="scale-cat-btn" data-track="jazz-251">Jazz</button>
                    <button class="scale-cat-btn" data-track="jazz-minor">Jazz Minor</button>
                    <button class="scale-cat-btn" data-track="funk-groove">Funk</button>
                    <button class="scale-cat-btn" data-track="funk-7ths">Funk 7ths</button>
                    <button class="scale-cat-btn" data-track="minor-epic">pico</button>
                    <button class="scale-cat-btn" data-track="latin-bossa">Bossa</button>
                    <button class="scale-cat-btn" data-track="latin-salsa">Salsa</button>
                    <button class="scale-cat-btn" data-track="reggae-one-drop">Reggae</button>
                    <button class="scale-cat-btn" data-track="country-shuffle">Country</button>
                    <button class="scale-cat-btn" data-track="grunge-alternative">Grunge</button>
                </div>
            </div>

            <!-- Controles de reproduccin -->
            <div style="background: rgba(0,0,0,0.4); padding: 16px; border-radius: 4px; border: 1px solid rgba(220, 38, 38, 0.2);">
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <button id="playTrackBtn" class="mode-btn-simple" style="background: #10b981; padding: 14px; font-weight: 600;">
                         PLAY
                    </button>
                    <button id="stopTrackBtn" class="mode-btn-simple" style="background: #dc2626; padding: 14px; font-weight: 600;" disabled>
                         STOP
                    </button>
                </div>

                <!-- Selector de tonalidad -->
                <div class="mb-3">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-xs text-void-400 uppercase tracking-wider">Tonalidad:</span>
                        <select id="jamKeySelector" class="px-3 py-1 bg-slate-800 text-white rounded border border-slate-600">
                            <option value="0">C</option>
                            <option value="1">C# / Db</option>
                            <option value="2">D</option>
                            <option value="3">D# / Eb</option>
                            <option value="4">E</option>
                            <option value="5">F</option>
                            <option value="6">F# / Gb</option>
                            <option value="7">G</option>
                            <option value="8">G# / Ab</option>
                            <option value="9">A</option>
                            <option value="10">A# / Bb</option>
                            <option value="11">B</option>
                        </select>
                    </div>
                </div>

                <!-- Control de BPM -->
                <div class="mb-3">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-xs text-void-400 uppercase tracking-wider">Tempo (BPM):</span>
                        <span id="bpmDisplay" class="text-lg font-bold text-blood-400">120</span>
                    </div>
                    <input type="range" id="bpmSlider" min="40" max="200" value="120"
                           style="width: 100%; accent-color: #dc2626;">
                </div>

                <!-- Toggle de sincronizacin BPM -->
                <div class="flex items-center justify-between mb-3">
                    <span class="text-xs text-void-400 uppercase tracking-wider">Sync con global BPM:</span>
                    <label class="relative inline-block w-12 h-6">
                        <input type="checkbox" id="syncBPMToggle" checked class="opacity-0 w-0 h-0">
                        <span class="slider-sync absolute cursor-pointer top-0 left-0 right-0 bottom-0 bg-void-700 rounded-full transition-all duration-300"
                              style="background: #10b981;">
                            <span class="dot-sync absolute h-5 w-5 left-0.5 bottom-0.5 bg-chalk-100 rounded-full transition-all duration-300"
                                  style="transform: translateX(24px);"></span>
                        </span>
                    </label>
                </div>

                <!-- Toggle de batera -->
                <div class="flex items-center justify-between">
                    <span class="text-xs text-void-400 uppercase tracking-wider">Batera:</span>
                    <label class="relative inline-block w-12 h-6">
                        <input type="checkbox" id="drumsToggle" checked class="opacity-0 w-0 h-0">
                        <span class="slider absolute cursor-pointer top-0 left-0 right-0 bottom-0 bg-void-700 rounded-full transition-all duration-300"
                              style="background: #dc2626;">
                            <span class="dot absolute h-5 w-5 left-0.5 bottom-0.5 bg-chalk-100 rounded-full transition-all duration-300"
                                  style="transform: translateX(24px);"></span>
                        </span>
                    </label>
                </div>
            </div>

            <!-- Visualizacin de progreso en vivo -->
            <div id="jamProgressDisplay" style="display: none; background: rgba(0,0,0,0.5); padding: 20px; border-radius: 8px; border: 2px solid rgba(16, 185, 129, 0.3); margin-bottom: 16px;">
                <!-- Acorde actual grande -->
                <div style="text-align: center; margin-bottom: 16px;">
                    <div style="font-size: 12px; color: #999; margin-bottom: 4px;">ACORDE ACTUAL</div>
                    <div id="currentChordName" style="font-size: 42px; font-weight: bold; color: #10b981; margin-bottom: 8px;">C</div>
                    <div id="currentChordFunction" style="font-size: 14px; color: #ccc;">(Tnica)</div>
                </div>

                <!-- Indicador de comps -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <div style="font-size: 14px; color: #999;">
                        <span>Comps:</span>
                        <span id="currentBarDisplay" style="color: #dc2626; font-weight: bold; margin-left: 8px;">1 / 4</span>
                    </div>
                    <div style="font-size: 14px; color: #999;">
                        <span>Loops:</span>
                        <span id="loopCountDisplay" style="color: #10b981; font-weight: bold; margin-left: 8px;">1</span>
                    </div>
                </div>

                <!-- Beat indicator (4 crculos) -->
                <div style="display: flex; justify-content: center; gap: 12px; margin-bottom: 16px;">
                    <div class="beat-dot" data-beat="0" style="width: 16px; height: 16px; border-radius: 50%; background: #333; transition: all 0.1s;"></div>
                    <div class="beat-dot" data-beat="1" style="width: 16px; height: 16px; border-radius: 50%; background: #333; transition: all 0.1s;"></div>
                    <div class="beat-dot" data-beat="2" style="width: 16px; height: 16px; border-radius: 50%; background: #333; transition: all 0.1s;"></div>
                    <div class="beat-dot" data-beat="3" style="width: 16px; height: 16px; border-radius: 50%; background: #333; transition: all 0.1s;"></div>
                </div>

                <!-- Barra de progreso -->
                <div style="width: 100%; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden;">
                    <div id="jamProgressBar" style="height: 100%; width: 0%; background: linear-gradient(90deg, #10b981, #dc2626); transition: width 0.1s linear;"></div>
                </div>
            </div>

            <!-- Info del track -->
            <div id="jamSessionInfo">
                <!-- Info dinmica del track -->
            </div>

            <!-- Tips -->
            <div style="background: rgba(220, 38, 38, 0.1); padding: 12px; border-radius: 4px; border-left: 3px solid #dc2626;">
                <div class="text-xs text-void-400 leading-relaxed">
                    <strong style="color: #dc2626;">TIP:</strong> El diapasn muestra la escala recomendada.
                    Improvisa libremente y experimenta con diferentes tcnicas: bends, slides, hammer-ons, vibrato.
                </div>
            </div>
        </div>
    </template>

    <!-- CLEANED: Old level cards content removed, now using templates + control panel -->

    <script>
        // ========================================
        // MUSIC THEORY ENGINE
        // ========================================
        const MusicTheory = {
            // Cache para memoizacin
            _cache: new Map(),

            // Funcin auxiliar de memoizacin
            _memoize(fn, key) {
                if (this._cache.has(key)) {
                    return this._cache.get(key);
                }
                const result = fn.call(this);
                this._cache.set(key, result);
                return result;
            },

            // 12 chromatic notes
            notes: ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'],

            // Enharmonic equivalents for display
            enharmonics: {
                'C#': 'Db', 'D#': 'Eb', 'F#': 'Gb', 'G#': 'Ab', 'A#': 'Bb'
            },

            // Scale formulas (intervals from root)
            scales: {
                // === ESCALAS MAYORES ===
                major:      [0, 2, 4, 5, 7, 9, 11],  // W-W-H-W-W-W-H (Jnico)

                // === ESCALAS MENORES ===
                minor:      [0, 2, 3, 5, 7, 8, 10],  // W-H-W-W-H-W-W (Menor Natural / Elico)
                harmonicMinor: [0, 2, 3, 5, 7, 8, 11], // Menor Armnica (7 natural)
                melodicMinor:  [0, 2, 3, 5, 7, 9, 11], // Menor Meldica ascendente
                dorianMinor:   [0, 2, 3, 5, 7, 9, 10], // Menor Drica (6 natural)

                // === MODOS DE LA ESCALA MAYOR ===
                dorian:     [0, 2, 3, 5, 7, 9, 10],  // II grado - menor con 6 natural
                phrygian:   [0, 1, 3, 5, 7, 8, 10],  // III grado - menor con b2
                lydian:     [0, 2, 4, 6, 7, 9, 11],  // IV grado - mayor con #4
                mixolydian: [0, 2, 4, 5, 7, 9, 10],  // V grado - mayor con b7
                locrian:    [0, 1, 3, 5, 6, 8, 10],  // VII grado - menor con b2 y b5

                // === MODOS DE LA MENOR ARMNICA ===
                locrianNat6:    [0, 1, 3, 5, 6, 9, 10],  // II de armnica
                ionianAug:      [0, 2, 4, 5, 8, 9, 11],  // III de armnica (Jnico #5)
                dorianSharp4:   [0, 2, 3, 6, 7, 9, 10],  // IV de armnica (Drico #4)
                phrygianDom:    [0, 1, 4, 5, 7, 8, 10],  // V de armnica (Frigio Dominante/Espaol)
                lydianSharp2:   [0, 3, 4, 6, 7, 9, 11],  // VI de armnica
                superLocrian:   [0, 1, 3, 4, 6, 8, 10],  // VII de armnica (Superlocrio bb7)

                // === MODOS DE LA MENOR MELDICA ===
                dorianB2:       [0, 1, 3, 5, 7, 9, 10],  // II de meldica (Drico b2)
                lydianAug:      [0, 2, 4, 6, 8, 9, 11],  // III de meldica (Lidio #5)
                lydianDom:      [0, 2, 4, 6, 7, 9, 10],  // IV de meldica (Lidio b7)
                mixolydianB6:   [0, 2, 4, 5, 7, 8, 10],  // V de meldica (Mixolidio b6)
                locrianNat2:    [0, 2, 3, 5, 6, 8, 10],  // VI de meldica (Locrio nat2)
                alteredScale:   [0, 1, 3, 4, 6, 8, 10],  // VII de meldica (Superlocrio/Alterada)

                // === PENTATNICAS ===
                pentatonicMajor: [0, 2, 4, 7, 9],    // Mayor pentatnica
                pentatonicMinor: [0, 3, 5, 7, 10],   // Menor pentatnica
                blues:           [0, 3, 5, 6, 7, 10], // Blues (pent menor + blue note)
                bluesMajor:      [0, 2, 3, 4, 7, 9],  // Blues mayor

                // === ESCALAS SIMTRICAS ===
                wholeTone:       [0, 2, 4, 6, 8, 10],    // Tonos enteros (6 notas)
                diminished:      [0, 2, 3, 5, 6, 8, 9, 11], // Disminuida T-S (8 notas)
                diminishedHW:    [0, 1, 3, 4, 6, 7, 9, 10], // Disminuida S-T
                chromatic:       [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11], // Cromtica

                // === ESCALAS EXTICAS ===
                hungarian:       [0, 2, 3, 6, 7, 8, 11],  // Hngara menor (gitana)
                hungarianMajor:  [0, 3, 4, 6, 7, 9, 10],  // Hngara mayor
                byzantine:       [0, 1, 4, 5, 7, 8, 11],  // Bizantina (Doble armnica)
                arabic:          [0, 1, 4, 5, 7, 8, 10],  // rabe (similar a frigio dom)
                japanese:        [0, 1, 5, 7, 8],         // Japonesa (In Sen)
                hirajoshi:       [0, 2, 3, 7, 8],         // Hirajoshi
                egyptian:        [0, 2, 5, 7, 10],        // Egipcia (pentatnica suspendida)
                prometheus:      [0, 2, 4, 6, 9, 10],     // Prometheus
                neapolitan:      [0, 1, 3, 5, 7, 8, 10],  // Napolitana menor
                neapolitanMajor: [0, 1, 3, 5, 7, 9, 11],  // Napolitana mayor
                enigmatic:       [0, 1, 4, 6, 8, 10, 11], // Enigmtica
                persian:         [0, 1, 4, 5, 6, 8, 11],  // Persa
                bebop:           [0, 2, 4, 5, 7, 9, 10, 11], // Bebop dominante (8 notas)
                bebopMajor:      [0, 2, 4, 5, 7, 8, 9, 11],  // Bebop mayor

                // === ESCALAS REGIONALES Y AVANZADAS ===
                bluesHeptatonic: [0, 2, 3, 4, 5, 7, 10],     // Blues heptatnica (pentatnica + 2 y 6)
                ryuKyu:          [0, 4, 5, 7, 11],           // Ryu Kyu (Okinawan) - escala tradicional japonesa
                yo:              [0, 2, 5, 7, 9],            // Yo Scale - pentatnica mayor japonesa
                bhairav:         [0, 1, 4, 5, 7, 8, 11],     // Bhairav Raga - escala india (similar bizantina)
                todi:            [0, 1, 3, 6, 7, 8, 11],     // Todi Raga - escala india meldica
                messiaenMode2:   [0, 1, 3, 4, 6, 7, 9, 10],  // Messiaen Modo 2 (Octatnica)
                messiaenMode3:   [0, 2, 3, 4, 6, 7, 8, 10, 11], // Messiaen Modo 3 (9 notas)
            },

            // Informacin extendida de cada escala
            scaleInfo: {
                // MAYORES
                major: {
                    name: 'Mayor (Jnico)',
                    category: 'major',
                    emotion: 'La luz del amanecer, el hroe que triunfa. Evoca victorias, finales felices y momentos de pura alegra. Es el hogar sonoro de la msica occidental.',
                    formula: 'T-T-S-T-T-T-S',
                    usage: 'Pop, rock, msica clsica. Base de la armona occidental.',
                    chordTypes: ['maj', 'min', 'min', 'maj', 'maj', 'min', 'dim'],
                    parentScale: null,
                    degree: 1,
                    brightness: 6,
                    characteristicNote: '7M',
                    usageContext: ['Pop comercial', 'Himnos', 'Msica infantil', 'Bandas sonoras picas', 'Country']
                },

                // MENORES
                minor: {
                    name: 'Menor Natural (Elico)',
                    category: 'minor',
                    emotion: 'La lluvia en la ventana, recuerdos que duelen dulcemente. Ideal para despedidas, reflexiones nocturnas y ese tipo de tristeza que no quieres soltar.',
                    formula: 'T-S-T-T-S-T-T',
                    usage: 'Baladas, rock alternativo, msica clsica. Relativa menor de la mayor.',
                    chordTypes: ['min', 'dim', 'maj', 'min', 'min', 'maj', 'maj'],
                    parentScale: 'major',
                    degree: 6,
                    brightness: 2,
                    characteristicNote: 'b6',
                    usageContext: ['Baladas', 'Rock alternativo', 'Folk melanclico', 'Msica clsica', 'Indie']
                },
                harmonicMinor: {
                    name: 'Menor Armnica',
                    category: 'minor',
                    emotion: 'El villano de capa que entra en escena, el castillo en la tormenta. Tensin dramtica que exige resolucin, como un suspiro antes del beso.',
                    formula: 'T-S-T-T-S-T-S',
                    usage: 'Msica clsica, metal neoclsico, flamenco. El V7 resuelve mejor al Im.',
                    chordTypes: ['min', 'dim', 'aug', 'min', 'maj', 'maj', 'dim'],
                    parentScale: null,
                    degree: 1,
                    brightness: 3,
                    characteristicNote: '7M',
                    usageContext: ['Metal neoclsico', 'Flamenco', 'Msica clsica', 'Bandas sonoras de suspenso', 'Tango']
                },
                melodicMinor: {
                    name: 'Menor Meldica',
                    category: 'minor',
                    emotion: 'Sofisticacin en penumbra, el jazz club a medianoche. Tristeza elegante que camina con tacones altos, melancola que conoce buenos vinos.',
                    formula: 'T-S-T-T-T-T-S',
                    usage: 'Jazz, fusin. Combina el color menor con la 6 y 7 mayores.',
                    chordTypes: ['min', 'min', 'aug', 'maj', 'maj', 'dim', 'dim'],
                    parentScale: null,
                    degree: 1,
                    brightness: 4,
                    characteristicNote: '6M',
                    usageContext: ['Jazz moderno', 'Fusin', 'Neo-soul', 'Msica de cine sofisticada', 'Bossa nova']
                },

                // MODOS DE LA MAYOR
                dorian: {
                    name: 'Drico',
                    category: 'modes',
                    emotion: 'Tristeza que baila, melancola con groove. Como llorar en la pista de baile o encontrar esperanza en un callejn oscuro.',
                    formula: 'T-S-T-T-T-S-T',
                    usage: 'Jazz, funk, rock. Menor con 6 natural (ms brillante que elico).',
                    chordTypes: ['min', 'min', 'maj', 'maj', 'min', 'dim', 'maj'],
                    parentScale: 'major',
                    degree: 2,
                    brightness: 3,
                    characteristicNote: '6M',
                    usageContext: ['Funk', 'Jazz modal', 'Soul', 'Rock progresivo', 'Hip-hop meldico']
                },
                phrygian: {
                    name: 'Frigio',
                    category: 'modes',
                    emotion: 'El sol de Andaluca sobre piedras antiguas, el bailaor que clava la mirada. Tensin espaola, misterio que huele a azahar.',
                    formula: 'S-T-T-T-S-T-T',
                    usage: 'Flamenco, metal, msica espaola. La b2 da el sonido caracterstico.',
                    chordTypes: ['min', 'maj', 'maj', 'min', 'dim', 'maj', 'min'],
                    parentScale: 'major',
                    degree: 3,
                    brightness: 1,
                    characteristicNote: 'b2',
                    usageContext: ['Flamenco', 'Metal', 'Msica mediterrnea', 'Ambient oscuro', 'Videojuegos picos']
                },
                lydian: {
                    name: 'Lidio',
                    category: 'modes',
                    emotion: 'Flotar entre nubes doradas, el asombro de un nio mirando las estrellas. Magia pura, E.T. volando sobre la luna.',
                    formula: 'T-T-T-S-T-T-S',
                    usage: 'Cine (Spielberg), jazz, prog rock. La #4 evita la gravedad del IV.',
                    chordTypes: ['maj', 'maj', 'min', 'dim', 'maj', 'min', 'min'],
                    parentScale: 'major',
                    degree: 4,
                    brightness: 7,
                    characteristicNote: '#4',
                    usageContext: ['Bandas sonoras mgicas', 'Jazz fusin', 'Rock progresivo', 'Dream pop', 'Ambient espacial']
                },
                mixolydian: {
                    name: 'Mixolidio',
                    category: 'modes',
                    emotion: 'La carretera infinita con el sol en la cara, rock and roll en vena. El riff que hace mover la cabeza sin pensar.',
                    formula: 'T-T-S-T-T-S-T',
                    usage: 'Blues, rock, funk. Mayor con b7 (acorde dominante como tnica).',
                    chordTypes: ['maj', 'min', 'dim', 'maj', 'min', 'min', 'maj'],
                    parentScale: 'major',
                    degree: 5,
                    brightness: 5,
                    characteristicNote: 'b7',
                    usageContext: ['Blues rock', 'Country rock', 'Funk', 'Rock clsico', 'Jam bands']
                },
                locrian: {
                    name: 'Locrio',
                    category: 'modes',
                    emotion: 'El suelo que se desmorona, vrtigo existencial. Inquietud sin reposo, pesadillas lcidas y pasillos infinitos.',
                    formula: 'S-T-T-S-T-T-T',
                    usage: 'Metal, jazz (sobre m7b5). La b5 hace imposible una tnica estable.',
                    chordTypes: ['dim', 'maj', 'min', 'min', 'maj', 'maj', 'min'],
                    parentScale: 'major',
                    degree: 7,
                    brightness: 0,
                    characteristicNote: 'b5',
                    usageContext: ['Metal extremo', 'Jazz sobre m7b5', 'Msica experimental', 'Horror cinematogrfico', 'Djent']
                },

                // MODOS DE LA MENOR ARMNICA
                phrygianDom: {
                    name: 'Frigio Dominante',
                    category: 'harmonicMinorModes',
                    emotion: 'El flamenco ms puro, pies golpeando tierra sagrada. El desierto al atardecer, noches de Las Mil y Una Noches.',
                    formula: 'S-T-S-T-S-T-T',
                    usage: 'Flamenco, metal, msica rabe. Es el V grado de la menor armnica.',
                    chordTypes: ['maj', 'dim', 'min', 'min', 'maj', 'maj', 'dim'],
                    parentScale: 'harmonicMinor',
                    degree: 5,
                    brightness: 2,
                    characteristicNote: 'b2 + 3M',
                    usageContext: ['Flamenco', 'Metal oriental', 'Msica rabe', 'Msica juda', 'Fusin mediterrnea']
                },

                // MODOS DE LA MENOR MELDICA
                lydianDom: {
                    name: 'Lidio Dominante',
                    category: 'melodicMinorModes',
                    emotion: 'Tensin que brilla como nen, el clmax antes de la resolucin. Sofisticacin que sabe a dry martini.',
                    formula: 'T-T-T-S-T-S-T',
                    usage: 'Jazz (sobre 7#11), fusin. Combina lydian y mixolydian.',
                    chordTypes: ['maj', 'min', 'dim', 'min', 'min', 'maj', 'min'],
                    parentScale: 'melodicMinor',
                    degree: 4,
                    brightness: 6,
                    characteristicNote: '#4 + b7',
                    usageContext: ['Jazz sobre 7#11', 'Fusin', 'Neo-soul avanzado', 'Steely Dan', 'Tritono sustituto']
                },
                alteredScale: {
                    name: 'Alterada (Superlocrio)',
                    category: 'melodicMinorModes',
                    emotion: 'Mxima tensin controlada, el equilibrista sobre el abismo. El grito antes del silencio, la tormenta antes de la calma.',
                    formula: 'S-T-S-T-T-T-T',
                    usage: 'Jazz sobre dominantes alterados (7alt). Todas las tensiones alteradas.',
                    chordTypes: ['dim', 'min', 'min', 'maj', 'maj', 'maj', 'min'],
                    parentScale: 'melodicMinor',
                    degree: 7,
                    brightness: 1,
                    characteristicNote: 'b9 + #9 + b5 + #5',
                    usageContext: ['Jazz bebop', 'Jazz contemporneo', 'Fusin avanzada', 'Dominantes V7alt', 'Resoluciones dramticas']
                },

                // PENTATNICAS
                pentatonicMajor: {
                    name: 'Pentatnica Mayor',
                    category: 'pentatonic',
                    emotion: 'Praderas infinitas, porches al atardecer y guitarras acsticas. Simplicidad honesta que sabe a limonada casera.',
                    formula: 'T-T-T-T-T',
                    usage: 'Country, pop, rock. Sin semitonos = sin tensiones.',
                    parentScale: 'major',
                    degree: 1,
                    brightness: 5,
                    characteristicNote: 'Sin 4 ni 7',
                    usageContext: ['Country', 'Pop', 'Folk americano', 'Rock meldico', 'Msica china tradicional']
                },
                pentatonicMinor: {
                    name: 'Pentatnica Menor',
                    category: 'pentatonic',
                    emotion: 'El lenguaje universal del rock, sangre de miles de solos legendarios. Cruda, directa, honesta.',
                    formula: 'T-T-T-T-T',
                    usage: 'Rock, blues, pop. La escala ms usada en solos.',
                    parentScale: 'minor',
                    degree: 1,
                    brightness: 2,
                    characteristicNote: 'b3 + b7',
                    usageContext: ['Rock', 'Blues', 'Metal', 'Pop rock', 'Prcticamente todo']
                },
                blues: {
                    name: 'Blues',
                    category: 'pentatonic',
                    emotion: 'El lamento del delta, whisky y cigarrillos a las 3AM. Dolor que se convierte en arte.',
                    formula: 'T-T-S-S-T-T',
                    usage: 'Blues, rock. Pentatnica menor + blue note (b5).',
                    parentScale: 'pentatonicMinor',
                    degree: 1,
                    specialNotes: { 6: 'blue note (b5)' },
                    brightness: 2,
                    characteristicNote: 'b5 (blue note)',
                    usageContext: ['Blues tradicional', 'Rock blues', 'Jazz blues', 'Soul', 'R&B']
                },

                // SIMTRICAS
                wholeTone: {
                    name: 'Tonos Enteros',
                    category: 'symmetric',
                    emotion: 'Caer en un sueo sin fondo, Alicia en el Pas de las Maravillas. Sin arriba ni abajo, desorientacin onrica.',
                    formula: 'T-T-T-T-T-T',
                    usage: 'Impresionismo (Debussy), jazz sobre 7#5. Solo 2 escalas posibles.',
                    chordTypes: null,
                    brightness: 4,
                    characteristicNote: 'Todos T (sin ancla)',
                    usageContext: ['Impresionismo', 'Transiciones onricas', 'Jazz sobre 7#5', 'Cine surreal', 'Efectos especiales']
                },
                diminished: {
                    name: 'Disminuida (T-S)',
                    category: 'symmetric',
                    emotion: 'Escaleras de Escher, persecuciones por callejones de espejos. Tensin que se repite cada tres semitonos.',
                    formula: 'T-S-T-S-T-S-T-S',
                    usage: 'Jazz sobre dim7, lneas cromticas. Solo 3 escalas posibles.',
                    chordTypes: null,
                    brightness: 3,
                    characteristicNote: 'Simetra cada 3 semitonos',
                    usageContext: ['Jazz sobre dim7', 'Lneas cromticas', 'Metal tcnico', 'Msica de suspenso', 'Transiciones']
                },

                // EXTICAS
                hungarian: {
                    name: 'Hngara Menor',
                    category: 'exotic',
                    emotion: 'Violines gitanos junto al fuego, pasin desbordada bajo las estrellas. Liszt cabalgando hacia el horizonte.',
                    formula: 'T-S-T-S-S-T-S',
                    usage: 'Msica gitana, Liszt, metal neoclsico. Tiene dos aumentadas.',
                    chordTypes: null,
                    brightness: 3,
                    characteristicNote: '#4 + 7M',
                    usageContext: ['Msica gitana', 'Clsica romntica', 'Metal neoclsico', 'Folk del este de Europa', 'Bandas sonoras picas']
                },
                byzantine: {
                    name: 'Bizantina (Doble Armnica)',
                    category: 'exotic',
                    emotion: 'Mezquitas al amanecer, el llamado a la oracin sobre tejados antiguos. Oriente medio, serpientes y bazares.',
                    formula: 'S-T-S-T-S-T-S',
                    usage: 'Msica del medio oriente, metal. Muy cromtica.',
                    chordTypes: null,
                    brightness: 2,
                    characteristicNote: 'b2 + 3M + 7M',
                    usageContext: ['Msica rabe', 'Msica turca', 'Metal oriental', 'Bandas sonoras exticas', 'Klezmer']
                },
                japanese: {
                    name: 'Japonesa (In Sen)',
                    category: 'exotic',
                    emotion: 'Jardines zen bajo la lluvia, cerezos en flor que caen al estanque. Melancola que encuentra paz.',
                    formula: 'S-2T-T-S-2T',
                    usage: 'Msica tradicional japonesa, ambient.',
                    chordTypes: null,
                    brightness: 1,
                    characteristicNote: 'b2 + espacios amplios',
                    usageContext: ['Msica japonesa tradicional', 'Ambient', 'Lo-fi', 'Meditacin', 'Bandas sonoras contemplativas']
                },
                bebop: {
                    name: 'Bebop Dominante',
                    category: 'exotic',
                    emotion: 'Nueva York aos 50, dedos volando sobre las teclas, conversaciones entre genios. Elegancia a 200 BPM.',
                    formula: 'T-T-S-T-T-S-S-S',
                    usage: 'Jazz bebop. 8 notas para que las notas del acorde caigan en tiempo fuerte.',
                    chordTypes: null,
                    brightness: 5,
                    characteristicNote: '7M cromtica',
                    usageContext: ['Jazz bebop', 'Hard bop', 'Jazz standards', 'Walking bass', 'Solos de viento']
                },

                // === ESCALAS REGIONALES Y AVANZADAS ===
                bluesHeptatonic: {
                    name: 'Blues Heptatnica',
                    category: 'exotic',
                    emotion: 'Blues con riqueza armnica expandida. El blues que estudi teora en Berklee pero sigue llorando igual.',
                    formula: 'T-S-S-S-T-1.5T-T',
                    usage: 'Blues moderno, blues-rock. Pentatnica blues + 2 mayor y 6 mayor para ms opciones meldicas.',
                    chordTypes: null,
                    brightness: 3,
                    characteristicNote: '2M + 6M sobre base blues',
                    usageContext: ['Blues rock moderno', 'SRV style', 'Allman Brothers', 'Jazz-blues', 'Blues sofisticado']
                },
                ryuKyu: {
                    name: 'Ryu Kyu (Okinawan)',
                    category: 'exotic',
                    emotion: 'Islas de Okinawa baadas por el mar. Msica folclrica ancestral con escalas pentatnicas nicas.',
                    formula: '2T-S-T-2T',
                    usage: 'Msica tradicional de Okinawa (Japn). Pentatnica con intervalos amplios.',
                    chordTypes: null,
                    brightness: 4,
                    characteristicNote: 'Saltos de tercera mayor',
                    usageContext: ['Msica japonesa tradicional', 'Folk okinawense', 'Ambient japons', 'World music', 'Documentales']
                },
                yo: {
                    name: 'Yo Scale (Japonesa)',
                    category: 'exotic',
                    emotion: 'Primavera en Kioto, templos sintostas, ceremonia del t. Serenidad y elegancia japonesa.',
                    formula: 'T-1.5T-T-T-1.5T',
                    usage: 'Msica tradicional japonesa. Pentatnica mayor japonesa sin semitonos.',
                    chordTypes: null,
                    brightness: 5,
                    characteristicNote: 'Sin semitonos - espaciosa',
                    usageContext: ['Msica tradicional japonesa', 'Koto', 'Shamisen', 'Anime tranquilo', 'Jardines zen']
                },
                bhairav: {
                    name: 'Bhairav Raga',
                    category: 'exotic',
                    emotion: 'Amanecer en el Ganges, ascetas meditando, incienso sagrado. Espiritualidad intensa y devocional.',
                    formula: 'S-1.5T-S-T-S-1.5T-S',
                    usage: 'Msica clsica india. Raga de la maana temprana. Evoca devocin y reverencia.',
                    chordTypes: null,
                    brightness: 2,
                    characteristicNote: 'b2 + 3M + 7M (similar bizantina)',
                    usageContext: ['Msica india clsica', 'Sitar', 'Meditacin', 'Yoga', 'Msica devocional']
                },
                todi: {
                    name: 'Todi Raga',
                    category: 'exotic',
                    emotion: 'Melancola profunda del medioda indio. Amor perdido, nostalgia espiritual, belleza dolorosa.',
                    formula: 'S-T-1.5T-S-S-1.5T-S',
                    usage: 'Msica clsica india. Raga del medioda. Uno de los ragas ms emotivos.',
                    chordTypes: null,
                    brightness: 1,
                    characteristicNote: 'b2 + b3 + #4 + b6',
                    usageContext: ['Msica india clsica', 'Raga medioda', 'Baladas emotivas', 'Meditacin profunda', 'Cine indio']
                },
                messiaenMode2: {
                    name: 'Messiaen Modo 2 (Octatnica)',
                    category: 'symmetric',
                    emotion: 'Vitrales de luz filtrada, arquitectura imposible, Escher sonoro. Simetra que desafa la gravedad tonal.',
                    formula: 'S-T-S-T-S-T-S-T',
                    usage: 'Msica contempornea, Messiaen, Debussy. Escala simtrica de transposicin limitada.',
                    chordTypes: null,
                    brightness: 3,
                    characteristicNote: 'Simetra semitono-tono',
                    usageContext: ['Msica clsica moderna', 'Messiaen', 'Jazz moderno', 'Metal progresivo', 'Bandas sonoras de ciencia ficcin']
                },
                messiaenMode3: {
                    name: 'Messiaen Modo 3',
                    category: 'symmetric',
                    emotion: 'Geometra sagrada, matemticas msticas, catedrales de sonido. Complejidad que sugiere lo divino.',
                    formula: 'T-S-S-T-S-S-T-S-S',
                    usage: 'Msica sacra contempornea. Escala de 9 notas con 3 transposiciones posibles.',
                    chordTypes: null,
                    brightness: 4,
                    characteristicNote: 'Simetra tono-semitono-semitono',
                    usageContext: ['Msica sacra moderna', 'Messiaen', 'Vanguardia', 'rgano litrgico', 'Composicin experimental']
                }
            },

            // Categoras de escalas para la UI
            scaleCategories: {
                major: { name: 'Escalas Mayores', color: '#f97316' },
                minor: { name: 'Escalas Menores', color: '#22d3ee' },
                modes: { name: 'Modos de la Mayor', color: '#fbbf24' },
                harmonicMinorModes: { name: 'Modos de la Menor Armnica', color: '#a855f7' },
                melodicMinorModes: { name: 'Modos de la Menor Meldica', color: '#ec4899' },
                pentatonic: { name: 'Pentatnicas y Blues', color: '#10b981' },
                symmetric: { name: 'Escalas Simtricas', color: '#6366f1' },
                exotic: { name: 'Escalas Exticas', color: '#ef4444' }
            },

            // Obtener armonizacin de cualquier escala
            getScaleHarmonization(root, scaleType) {
                const cacheKey = `harmonization_${root}_${scaleType}`;
                return this._memoize(() => {
                    const scale = this.getScale(root, scaleType);
                    const formula = this.scales[scaleType];
                    const triads = [];

                    for (let degree = 0; degree < scale.length; degree++) {
                        const rootNote = scale[degree].note;
                        const rootInterval = formula[degree];

                        // Buscar la 3 (2 grados arriba en la escala)
                        const thirdDegree = (degree + 2) % scale.length;
                        const thirdNote = scale[thirdDegree].note;
                        const thirdInterval = (formula[thirdDegree] - rootInterval + 12) % 12;

                        // Buscar la 5 (4 grados arriba en la escala)
                        const fifthDegree = (degree + 4) % scale.length;
                        const fifthNote = scale[fifthDegree].note;
                        const fifthInterval = (formula[fifthDegree] - rootInterval + 12) % 12;

                        // Determinar calidad del acorde
                        let quality;
                        if (thirdInterval === 4 && fifthInterval === 7) quality = 'maj';
                        else if (thirdInterval === 3 && fifthInterval === 7) quality = 'min';
                        else if (thirdInterval === 3 && fifthInterval === 6) quality = 'dim';
                        else if (thirdInterval === 4 && fifthInterval === 8) quality = 'aug';
                        else if (thirdInterval === 2 && fifthInterval === 7) quality = 'sus2';
                        else if (thirdInterval === 5 && fifthInterval === 7) quality = 'sus4';
                        else quality = '?';

                        triads.push({
                            degree: degree + 1,
                            root: rootNote,
                            third: thirdNote,
                            fifth: fifthNote,
                            quality: quality,
                            intervals: { third: thirdInterval, fifth: fifthInterval }
                        });
                    }

                    return triads;
                }, cacheKey);
            },

            // Comparar dos escalas
            compareScales(scale1Type, scale2Type) {
                const cacheKey = `compare_${scale1Type}_${scale2Type}`;
                return this._memoize(() => {
                    const formula1 = this.scales[scale1Type];
                    const formula2 = this.scales[scale2Type];

                    const common = formula1.filter(n => formula2.includes(n));
                    const onlyIn1 = formula1.filter(n => !formula2.includes(n));
                    const onlyIn2 = formula2.filter(n => !formula1.includes(n));

                    return {
                        common: common,
                        onlyInFirst: onlyIn1,
                        onlyInSecond: onlyIn2,
                        similarity: (common.length / Math.max(formula1.length, formula2.length) * 100).toFixed(0)
                    };
                }, cacheKey);
            },

            // Obtener escala padre y grado
            getParentInfo(scaleType) {
                const info = this.scaleInfo[scaleType];
                if (!info || !info.parentScale) return null;

                return {
                    parentScale: info.parentScale,
                    degree: info.degree,
                    parentName: this.scaleInfo[info.parentScale]?.name || info.parentScale
                };
            },

            // Interval names
            intervalNames: {
                0: '1 (T)',
                1: '2m',
                2: '2M',
                3: '3m',
                4: '3M',
                5: '4J',
                6: 'TT',
                7: '5J',
                8: '6m',
                9: '6M',
                10: '7m',
                11: '7M',
            },

            // Scale degree names
            degreeNames: ['1', '2', '3', '4', '5', '6', '7'],

            // Chord qualities for major scale harmonization
            chordQualities: ['maj', 'min', 'min', 'maj', 'maj', 'min', 'dim'],
            romanNumerals: ['I', 'ii', 'iii', 'IV', 'V', 'vi', 'vii'],

            // Get note name from index
            getNoteName(index) {
                return this.notes[(index % 12 + 12) % 12];
            },

            // Get note index from name
            getNoteIndex(name) {
                return this.notes.indexOf(name);
            },

            // Calculate interval between two notes
            getInterval(note1, note2) {
                const idx1 = typeof note1 === 'number' ? note1 : this.getNoteIndex(note1);
                const idx2 = typeof note2 === 'number' ? note2 : this.getNoteIndex(note2);
                return ((idx2 - idx1) % 12 + 12) % 12;
            },

            // Get scale notes from root and scale type
            getScale(root, scaleType) {
                const cacheKey = `scale_${root}_${scaleType}`;
                return this._memoize(() => {
                    const rootIndex = typeof root === 'number' ? root : this.getNoteIndex(root);
                    const formula = this.scales[scaleType];
                    return formula.map(interval => ({
                        note: this.getNoteName(rootIndex + interval),
                        interval: interval,
                        degree: formula.indexOf(interval) + 1
                    }));
                }, cacheKey);
            },

            // Get triad from scale degree
            getTriad(root, scaleType, degree) {
                const scale = this.getScale(root, scaleType);
                const rootIndex = degree - 1;
                const thirdIndex = (rootIndex + 2) % 7;
                const fifthIndex = (rootIndex + 4) % 7;

                return {
                    root: scale[rootIndex],
                    third: scale[thirdIndex],
                    fifth: scale[fifthIndex],
                    quality: this.chordQualities[rootIndex],
                    roman: this.romanNumerals[rootIndex]
                };
            },

            // Get all triads for a scale
            getScaleTriads(root, scaleType) {
                return [1, 2, 3, 4, 5, 6, 7].map(degree => this.getTriad(root, scaleType, degree));
            },

            // Get mode from parent scale
            getMode(parentRoot, modeNumber) {
                const parentScale = this.getScale(parentRoot, 'major');
                const modeRoot = parentScale[modeNumber - 1].note;
                const modeNames = ['major', 'dorian', 'phrygian', 'lydian', 'mixolydian', 'minor', 'locrian'];
                return {
                    root: modeRoot,
                    scale: this.getScale(modeRoot, modeNames[modeNumber - 1]),
                    name: modeNames[modeNumber - 1]
                };
            },

            // Circle of fifths order
            circleOfFifths: [0, 7, 2, 9, 4, 11, 6, 1, 8, 3, 10, 5], // C, G, D, A, E, B, F#, C#, G#, D#, A#, F
            circleOfFifthsLabels: ['C', 'G', 'D', 'A', 'E', 'B', 'F#/Gb', 'Db', 'Ab', 'Eb', 'Bb', 'F'],

            // Get relative minor
            getRelativeMinor(majorRoot) {
                return (majorRoot + 9) % 12; // 3 semitones down = 9 semitones up
            },

            // Get relative major
            getRelativeMajor(minorRoot) {
                return (minorRoot + 3) % 12;
            },

            // Seventh chord formulas from scale degree
            seventhChordFormulas: {
                1: [0, 4, 7, 11],  // maj7
                2: [0, 3, 7, 10],  // m7
                3: [0, 3, 7, 10],  // m7
                4: [0, 4, 7, 11],  // maj7
                5: [0, 4, 7, 10],  // dom7
                6: [0, 3, 7, 10],  // m7
                7: [0, 3, 6, 10],  // m7b5 (half-diminished)
            },

            seventhChordNames: ['maj7', 'm7', 'm7', 'maj7', '7', 'm7', '7'],

            // Get seventh chord from scale degree
            getSeventhChord(root, degree) {
                const scale = this.getScale(root, 'major');
                const chordRoot = scale[degree - 1].note;
                const chordRootIndex = this.getNoteIndex(chordRoot);
                const formula = this.seventhChordFormulas[degree];

                return {
                    root: chordRoot,
                    notes: formula.map(interval => ({
                        note: this.getNoteName(chordRootIndex + interval),
                        interval: interval
                    })),
                    quality: this.seventhChordNames[degree - 1],
                    degree: degree
                };
            },

            // CAGED system shapes (positions relative to root on specific strings)
            cagedShapes: {
                'C': {
                    name: 'Forma C',
                    // Positions: [string][fret relative to root position]
                    positions: [
                        { string: 0, fret: 0, degree: 1 },   // E string - root
                        { string: 1, fret: 1, degree: 5 },   // B string
                        { string: 2, fret: 0, degree: 3 },   // G string
                        { string: 3, fret: 2, degree: 1 },   // D string - root
                        { string: 4, fret: 3, degree: 5 },   // A string
                        { string: 5, fret: -1, degree: null }, // E string - muted
                    ],
                    rootString: 4, // Root on A string
                    description: 'Tnica en cuerda 5 (A)'
                },
                'A': {
                    name: 'Forma A',
                    positions: [
                        { string: 0, fret: 0, degree: 5 },
                        { string: 1, fret: 2, degree: 1 },   // root
                        { string: 2, fret: 2, degree: 5 },
                        { string: 3, fret: 2, degree: 1 },   // root
                        { string: 4, fret: 0, degree: 1 },   // root
                        { string: 5, fret: -1, degree: null },
                    ],
                    rootString: 4,
                    description: 'Tnica en cuerda 5 (A)'
                },
                'G': {
                    name: 'Forma G',
                    positions: [
                        { string: 0, fret: 3, degree: 1 },   // root
                        { string: 1, fret: 0, degree: 3 },
                        { string: 2, fret: 0, degree: 1 },   // root
                        { string: 3, fret: 0, degree: 5 },
                        { string: 4, fret: 2, degree: 3 },
                        { string: 5, fret: 3, degree: 1 },   // root
                    ],
                    rootString: 5,
                    description: 'Tnica en cuerda 6 (E)'
                },
                'E': {
                    name: 'Forma E',
                    positions: [
                        { string: 0, fret: 0, degree: 1 },   // root
                        { string: 1, fret: 0, degree: 5 },
                        { string: 2, fret: 1, degree: 3 },
                        { string: 3, fret: 2, degree: 1 },   // root
                        { string: 4, fret: 2, degree: 5 },
                        { string: 5, fret: 0, degree: 1 },   // root
                    ],
                    rootString: 5,
                    description: 'Tnica en cuerda 6 (E)'
                },
                'D': {
                    name: 'Forma D',
                    positions: [
                        { string: 0, fret: 2, degree: 3 },
                        { string: 1, fret: 3, degree: 1 },   // root
                        { string: 2, fret: 2, degree: 5 },
                        { string: 3, fret: 0, degree: 1 },   // root
                        { string: 4, fret: -1, degree: null },
                        { string: 5, fret: -1, degree: null },
                    ],
                    rootString: 3,
                    description: 'Tnica en cuerda 4 (D)'
                }
            },

            // Interval info for level 1 improvements
            intervalInfo: {
                1: { name: '2 menor', semitones: 1, character: 'Disonante, tensin extrema', consonance: 'Disonante', examples: 'Jaws theme, Pink Panther' },
                2: { name: '2 Mayor', semitones: 2, character: 'Paso meldico, neutro', consonance: 'Disonante suave', examples: 'Happy Birthday (primeras notas)' },
                3: { name: '3 menor', semitones: 3, character: 'Triste, melanclico', consonance: 'Consonante imperfecta', examples: 'Greensleeves, Hey Jude' },
                4: { name: '3 Mayor', semitones: 4, character: 'Alegre, brillante', consonance: 'Consonante imperfecta', examples: 'When the Saints, Kumbaya' },
                5: { name: '4 Justa', semitones: 5, character: 'Suspensin, apertura', consonance: 'Consonante perfecta', examples: 'Here Comes the Bride, Amazing Grace' },
                6: { name: 'Tritono', semitones: 6, character: 'Diablico, inestable', consonance: 'Disonante', examples: 'The Simpsons, Maria (West Side Story)' },
                7: { name: '5 Justa', semitones: 7, character: 'Poder, estabilidad', consonance: 'Consonante perfecta', examples: 'Star Wars, Twinkle Twinkle' },
                8: { name: '6 menor', semitones: 8, character: 'Dramtico, intenso', consonance: 'Consonante imperfecta', examples: 'The Entertainer, Love Story' },
                9: { name: '6 Mayor', semitones: 9, character: 'Romntico, dulce', consonance: 'Consonante imperfecta', examples: 'NBC theme, My Bonnie' },
                10: { name: '7 menor', semitones: 10, character: 'Bluesy, con tensin', consonance: 'Disonante suave', examples: 'Star Trek theme, Watermelon Man' },
                11: { name: '7 Mayor', semitones: 11, character: 'Soador, jazz', consonance: 'Disonante', examples: 'Take on Me, Superman theme' }
            },

            // Extended chords for level 11
            extendedChords: {
                'maj9':   { intervals: [0, 4, 7, 11, 14], name: 'Major 9', symbol: 'maj9', formula: '1-3-5-7-9' },
                'min9':   { intervals: [0, 3, 7, 10, 14], name: 'Minor 9', symbol: 'm9', formula: '1-b3-5-b7-9' },
                'dom9':   { intervals: [0, 4, 7, 10, 14], name: 'Dominant 9', symbol: '9', formula: '1-3-5-b7-9' },
                '7#9':    { intervals: [0, 4, 7, 10, 15], name: 'Hendrix Chord', symbol: '7#9', formula: '1-3-5-b7-#9' },
                '7b9':    { intervals: [0, 4, 7, 10, 13], name: 'Dom 7 flat 9', symbol: '7b9', formula: '1-3-5-b7-b9' },
                'min11':  { intervals: [0, 3, 7, 10, 14, 17], name: 'Minor 11', symbol: 'm11', formula: '1-b3-5-b7-9-11' },
                'dom11':  { intervals: [0, 4, 7, 10, 14, 17], name: 'Dominant 11', symbol: '11', formula: '1-3-5-b7-9-11' },
                'maj11':  { intervals: [0, 4, 7, 11, 14, 17], name: 'Major 11', symbol: 'maj11', formula: '1-3-5-7-9-11' },
                'maj13':  { intervals: [0, 4, 7, 11, 14, 21], name: 'Major 13', symbol: 'maj13', formula: '1-3-5-7-9-13' },
                'dom13':  { intervals: [0, 4, 7, 10, 14, 21], name: 'Dominant 13', symbol: '13', formula: '1-3-5-b7-9-13' },
                'min13':  { intervals: [0, 3, 7, 10, 14, 21], name: 'Minor 13', symbol: 'm13', formula: '1-b3-5-b7-9-13' },
            },

            extendedVoicings: {
                'maj9_A':  { frets: [-1, 0, 2, 1, 2, 0], type: 'maj9' },
                'min9_A':  { frets: [-1, 0, 2, 0, 2, 0], type: 'm9' },
                'dom9_E':  { frets: [0, 2, 0, 1, 0, 2], type: '9' },
                '7#9_E':   { frets: [0, 2, 1, 2, 0, -1], type: '7#9' },
                '7b9_E':   { frets: [0, 2, 1, 2, 1, -1], type: '7b9' },
                'min11_A': { frets: [-1, 0, 0, 0, 0, 0], type: 'm11' },
                'dom11_A': { frets: [-1, 0, 0, 1, 0, 0], type: '11' },
                'maj11_A': { frets: [-1, 0, 0, 1, 2, 0], type: 'maj11' },
                'maj13_A': { frets: [-1, 0, 2, 1, 2, 2], type: 'maj13' },
                'dom13_E': { frets: [0, 2, 0, 1, 2, 0], type: '13' },
            },

            // Secondary dominants for level 12
            secondaryDominants: {
                'ii':  { target: 2, rootOffset: 9, name: 'V de ii', roman: 'V/ii', example: 'A7  Dm (en C)', targetChord: 'ii' },
                'iii': { target: 3, rootOffset: 11, name: 'V de iii', roman: 'V/iii', example: 'B7  Em (en C)', targetChord: 'iii' },
                'IV':  { target: 4, rootOffset: 0, name: 'V de IV', roman: 'V/IV', example: 'C7  F (en C)', targetChord: 'IV' },
                'V':   { target: 5, rootOffset: 2, name: 'V de V', roman: 'V/V', example: 'D7  G (en C)', targetChord: 'V' },
                'vi':  { target: 6, rootOffset: 4, name: 'V de vi', roman: 'V/vi', example: 'E7  Am (en C)', targetChord: 'vi' },
            },

            secondaryProgressions: [
                { name: 'V/V  V  I', degrees: ['V/V', 'V', 'I'], description: 'Cadencia extendida - muy comn en clsica y pop' },
                { name: 'I  V/vi  vi', degrees: ['I', 'V/vi', 'vi'], description: 'Dramatiza la llegada al vi (relativo menor)' },
                { name: 'I  V/ii  ii  V  I', degrees: ['I', 'V/ii', 'ii', 'V', 'I'], description: 'ii-V secundario - tpico del jazz' },
            ],

            // Quiz questions for level 10
            quizQuestions: {
                intervals: {
                    easy: [
                        { q: 'Qu intervalo hay entre C y E?', a: '3 Mayor', options: ['3 menor', '3 Mayor', '4 Justa', '2 Mayor'] },
                        { q: 'Qu intervalo hay entre C y G?', a: '5 Justa', options: ['4 Justa', '5 Justa', '6 Mayor', '3 Mayor'] },
                        { q: 'Cuntos semitonos tiene una 4 Justa?', a: '5', options: ['4', '5', '6', '7'] },
                        { q: 'Qu intervalo es el ms consonante?', a: '5 Justa', options: ['2 menor', '5 Justa', 'Tritono', '7 Mayor'] },
                    ],
                    medium: [
                        { q: 'El tritono equivale a:', a: '6 semitonos', options: ['5 semitonos', '6 semitonos', '7 semitonos', '4 semitonos'] },
                        { q: 'Qu intervalo hay entre D y Bb?', a: '6 menor', options: ['5 Justa', '6 menor', '6 Mayor', '7 menor'] },
                        { q: 'Qu intervalo es caracterstico de los acordes mayores?', a: '3 Mayor', options: ['3 menor', '3 Mayor', '2 Mayor', '4 Justa'] },
                    ],
                    hard: [
                        { q: 'Qu intervalo invertido da una 6 Mayor?', a: '3 menor', options: ['3 Mayor', '3 menor', '2 Mayor', '7 menor'] },
                        { q: 'Cuntos semitonos hay entre F# y Eb?', a: '9', options: ['8', '9', '10', '11'] },
                    ]
                },
                scales: {
                    easy: [
                        { q: 'Cuntas notas tiene la escala mayor?', a: '7', options: ['5', '6', '7', '8'] },
                        { q: 'Qu escala usa solo teclas blancas empezando en C?', a: 'C Mayor', options: ['A menor', 'C Mayor', 'G Mayor', 'F Mayor'] },
                        { q: 'Cuntas notas tiene la pentatnica?', a: '5', options: ['4', '5', '6', '7'] },
                    ],
                    medium: [
                        { q: 'Qu escala tiene #4 como nota caracterstica?', a: 'Lidio', options: ['Mixolidio', 'Lidio', 'Drico', 'Frigio'] },
                        { q: 'Qu escala tiene b2 como nota caracterstica?', a: 'Frigio', options: ['Drico', 'Lidio', 'Frigio', 'Locrio'] },
                        { q: 'Qu nota diferencia la menor armnica de la natural?', a: '7 Mayor', options: ['6 Mayor', '7 Mayor', '2 menor', '4 aumentada'] },
                    ],
                    hard: [
                        { q: 'Qu escala es el VII grado de la menor meldica?', a: 'Alterada', options: ['Locrio', 'Alterada', 'Lidio Dom', 'Frigio Dom'] },
                        { q: 'Cuntas escalas disminuidas (T-S) existen?', a: '3', options: ['2', '3', '4', '6'] },
                    ]
                },
                chords: {
                    easy: [
                        { q: 'Qu notas tiene un acorde de C Mayor?', a: 'C-E-G', options: ['C-D-E', 'C-E-G', 'C-F-G', 'C-Eb-G'] },
                        { q: 'Qu tipo de acorde es el ii en una escala mayor?', a: 'menor', options: ['Mayor', 'menor', 'disminuido', 'aumentado'] },
                        { q: 'Cul es el V de C Mayor?', a: 'G', options: ['F', 'G', 'D', 'A'] },
                    ],
                    medium: [
                        { q: 'Qu grado de la escala mayor es disminuido?', a: 'vii', options: ['ii', 'iii', 'vi', 'vii'] },
                        { q: 'Qu intervalos forman un acorde menor?', a: '1-b3-5', options: ['1-3-5', '1-b3-5', '1-3-#5', '1-b3-b5'] },
                    ],
                    hard: [
                        { q: 'Qu acorde es 1-b3-b5?', a: 'disminuido', options: ['menor', 'disminuido', 'semidisminuido', 'menor 7'] },
                        { q: 'Qu nota aade un maj7 a la trada?', a: '7 Mayor', options: ['7 menor', '7 Mayor', '9', '6'] },
                    ]
                },
                modes: {
                    easy: [
                        { q: 'Cul es el primer modo de la escala mayor?', a: 'Jnico', options: ['Drico', 'Jnico', 'Lidio', 'Elico'] },
                        { q: 'Qu modo es igual a la escala menor natural?', a: 'Elico', options: ['Drico', 'Frigio', 'Elico', 'Locrio'] },
                        { q: 'Cuntos modos tiene la escala mayor?', a: '7', options: ['5', '6', '7', '8'] },
                    ],
                    medium: [
                        { q: 'Qu modo tiene sonido "espaol/flamenco"?', a: 'Frigio', options: ['Drico', 'Frigio', 'Lidio', 'Mixolidio'] },
                        { q: 'Qu modo suena ms "brillante"?', a: 'Lidio', options: ['Frigio', 'Locrio', 'Lidio', 'Drico'] },
                        { q: 'D Drico tiene las mismas notas que...?', a: 'C Mayor', options: ['D Mayor', 'C Mayor', 'G Mayor', 'A menor'] },
                    ],
                    hard: [
                        { q: 'Qu modo se usa sobre acordes m7b5?', a: 'Locrio', options: ['Drico', 'Frigio', 'Elico', 'Locrio'] },
                        { q: 'Qu modo es el IV de la menor meldica?', a: 'Lidio Dominante', options: ['Lidio', 'Mixolidio', 'Lidio Dominante', 'Alterada'] },
                    ]
                },
                theory: {
                    easy: [
                        { q: 'Cuntos semitonos hay en una octava?', a: '12', options: ['7', '10', '12', '14'] },
                        { q: 'Qu progresin es I-V-vi-IV?', a: 'Pop Universal', options: ['Blues', 'Pop Universal', 'Jazz', 'Flamenco'] },
                        { q: 'Qu significa "relativo menor"?', a: 'Menor que comparte notas', options: ['Menor paralelo', 'Menor que comparte notas', 'Menor un tono abajo', 'Menor armnica'] },
                    ],
                    medium: [
                        { q: 'Qu es un dominante secundario?', a: 'V de un grado que no es I', options: ['V del I', 'V de un grado que no es I', 'VII del I', 'bVII'] },
                        { q: 'Qu acorde resuelve por tritono al I?', a: 'SubV', options: ['V', 'IV', 'SubV', 'ii'] },
                    ],
                    hard: [
                        { q: 'Qu es una cadencia plagal?', a: 'IV  I', options: ['V  I', 'IV  I', 'ii  V', 'vi  I'] },
                        { q: 'Cul es el tritono sustituto de G7?', a: 'Db7', options: ['C7', 'Db7', 'Ab7', 'F7'] },
                    ]
                }
            },

            // Ear Training data for level 14
            earTraining: {
                intervals: {
                    easy: [
                        { semitones: 4, name: '3 Mayor', abbr: '3M', tip: 'Sonido alegre, como "Oh When the Saints"' },
                        { semitones: 5, name: '4 Justa', abbr: '4J', tip: 'Como el inicio de "Here Comes the Bride"' },
                        { semitones: 7, name: '5 Justa', abbr: '5J', tip: 'Vaco y poderoso, como el power chord' },
                        { semitones: 12, name: '8 (Octava)', abbr: '8J', tip: 'Misma nota, una octava arriba' }
                    ],
                    medium: [
                        { semitones: 2, name: '2 Mayor', abbr: '2M', tip: 'Paso de escala, muy cercano' },
                        { semitones: 3, name: '3 menor', abbr: '3m', tip: 'Sonido triste o melanclico' },
                        { semitones: 9, name: '6 Mayor', abbr: '6M', tip: 'Romntico, como "My Way"' },
                        { semitones: 10, name: '7 menor', abbr: '7m', tip: 'Tensin que pide resolucin' },
                        { semitones: 11, name: '7 Mayor', abbr: '7M', tip: 'Muy tenso, jazz/sofisticado' }
                    ],
                    hard: [
                        { semitones: 1, name: '2 menor', abbr: '2m', tip: 'Tiburn - muy tenso y cercano' },
                        { semitones: 6, name: 'Tritono (4Aum/5Dim)', abbr: 'TT', tip: 'El intervalo del diablo, mxima tensin' },
                        { semitones: 8, name: '6 menor', abbr: '6m', tip: 'Nostlgico, como "The Entertainer"' },
                        { semitones: 13, name: '9 Mayor', abbr: '9M', tip: 'Octava + 2 Mayor' },
                        { semitones: 14, name: '9 menor', abbr: '9m', tip: 'Octava + 2 menor (blues)' },
                        { semitones: 15, name: '10 menor', abbr: '10m', tip: 'Octava + 3 menor' },
                        { semitones: 16, name: '10 Mayor', abbr: '10M', tip: 'Octava + 3 Mayor' }
                    ]
                }
            },

            // Backing Tracks for level 15
            backingTracks: [
                {
                    id: 'blues-12bar',
                    name: '12-Bar Blues Shuffle',
                    bpm: 90,
                    key: 0,
                    progression: ['I7', 'I7', 'I7', 'I7', 'IV7', 'IV7', 'I7', 'I7', 'V7', 'IV7', 'I7', 'V7'],
                    scale: 'blues',
                    style: 'Blues',
                    feel: 'Shuffle',
                    description: 'Blues clsico en 12 compases. Perfecto para practicar licks, bends y vibrato.'
                },
                {
                    id: 'blues-slow',
                    name: 'Slow Blues',
                    bpm: 60,
                    key: 0,
                    progression: ['I7', 'IV7', 'I7', 'I7', 'IV7', 'IV7', 'I7', 'I7', 'V7', 'IV7', 'I7', 'V7'],
                    scale: 'pentatonicMinor',
                    style: 'Blues',
                    feel: 'Ballad',
                    description: 'Blues lento estilo B.B. King. Enfcate en la expresin y el vibrato.'
                },
                {
                    id: 'rock-pop',
                    name: 'Pop Universal I-V-vi-IV',
                    bpm: 120,
                    key: 0,
                    progression: ['I', 'V', 'vi', 'IV'],
                    scale: 'pentatonicMajor',
                    style: 'Pop/Rock',
                    feel: 'Straight',
                    description: 'La progresin ms famosa de todos los tiempos. Usada en miles de hits.'
                },
                {
                    id: 'rock-driving',
                    name: 'Rock Power Chords',
                    bpm: 140,
                    key: 0,
                    progression: ['I', 'bVII', 'IV', 'I'],
                    scale: 'pentatonicMinor',
                    style: 'Rock',
                    feel: 'Driving',
                    description: 'Rock energtico con power chords. Perfecto para riffs agresivos.'
                },
                {
                    id: 'metal-riff',
                    name: 'Metal Riffing',
                    bpm: 160,
                    key: 0,
                    progression: ['i', 'bVI', 'bVII', 'i'],
                    scale: 'phrygian',
                    style: 'Metal',
                    feel: 'Aggressive',
                    description: 'Progresin metal con modo Frigio. Usa palm muting y downpicking.'
                },
                {
                    id: 'jazz-251',
                    name: 'Jazz Standard ii-V-I',
                    bpm: 140,
                    key: 0,
                    progression: ['ii', 'V', 'I', 'I'],
                    scale: 'major',
                    style: 'Jazz',
                    feel: 'Swing',
                    description: 'La cadencia fundamental del jazz. Practica arpegios y cromatismos.'
                },
                {
                    id: 'jazz-minor',
                    name: 'Jazz Minor ii-V-i',
                    bpm: 120,
                    key: 0,
                    progression: ['ii', 'V', 'i', 'i'],
                    scale: 'melodicMinor',
                    style: 'Jazz',
                    feel: 'Swing',
                    description: 'Progresin de jazz menor. Usa escala menor meldica sobre el i.'
                },
                {
                    id: 'funk-groove',
                    name: 'Funk 16th Notes',
                    bpm: 100,
                    key: 0,
                    progression: ['i', 'i', 'i', 'i'],
                    scale: 'pentatonicMinor',
                    style: 'Funk',
                    feel: '16th Groove',
                    description: 'Un solo acorde. Enfcate en el ritmo, ghost notes y sincopa.'
                },
                {
                    id: 'funk-7ths',
                    name: 'Funk 7th Chords',
                    bpm: 110,
                    key: 0,
                    progression: ['i', 'iv', 'i', 'V'],
                    scale: 'dorian',
                    style: 'Funk',
                    feel: 'Syncopated',
                    description: 'Funk con acordes de 7. Usa modo Drico para improvisar.'
                },
                {
                    id: 'minor-epic',
                    name: 'Cinematic Epic',
                    bpm: 75,
                    key: 0,
                    progression: ['i', 'bVI', 'bIII', 'bVII'],
                    scale: 'minor',
                    style: 'Cinematogrfico',
                    feel: 'Epic',
                    description: 'Progresin pica moderna. Perfecta para solos emotivos.'
                },
                {
                    id: 'latin-bossa',
                    name: 'Bossa Nova',
                    bpm: 130,
                    key: 0,
                    progression: ['I', 'ii', 'V', 'I'],
                    scale: 'major',
                    style: 'Latin',
                    feel: 'Bossa',
                    description: 'Ritmo brasileo suave. Practica acordes con 7 y 9.'
                },
                {
                    id: 'latin-salsa',
                    name: 'Salsa Montuno',
                    bpm: 180,
                    key: 0,
                    progression: ['I', 'IV', 'V', 'I'],
                    scale: 'major',
                    style: 'Latin',
                    feel: 'Salsa',
                    description: 'Salsa rpida. Enfcate en notas staccato y sincopa latina.'
                },
                {
                    id: 'reggae-one-drop',
                    name: 'Reggae One Drop',
                    bpm: 80,
                    key: 0,
                    progression: ['I', 'V', 'vi', 'IV'],
                    scale: 'major',
                    style: 'Reggae',
                    feel: 'One Drop',
                    description: 'Reggae clsico. Rasguea en los tiempos 2 y 4 (offbeat).'
                },
                {
                    id: 'country-shuffle',
                    name: 'Country Shuffle',
                    bpm: 110,
                    key: 0,
                    progression: ['I', 'I', 'IV', 'I', 'V', 'IV', 'I', 'V'],
                    scale: 'pentatonicMajor',
                    style: 'Country',
                    feel: 'Shuffle',
                    description: 'Country clsico con bajo alternante. Practica chicken picking.'
                },
                {
                    id: 'grunge-alternative',
                    name: 'Grunge/Alternative',
                    bpm: 95,
                    key: 0,
                    progression: ['i', 'iv', 'bIII', 'bVI'],
                    scale: 'pentatonicMinor',
                    style: 'Grunge',
                    feel: 'Heavy',
                    description: 'Sonido grunge de los 90s. Power chords con distorsin suave.'
                }
            ],

            // Songs for level 13
            songs: [
                // METAL
                { name: 'Master of Puppets', artist: 'Metallica', key: 4, mode: 'minor', progression: ['i', 'bVI', 'bVII', 'i'], progressionChords: ['Em', 'C', 'D', 'Em'], scale: 'minor', genre: 'Thrash Metal', tips: 'Afinacin estndar. Riff principal en E menor con cromatismos. Downpicking a alta velocidad.' },
                { name: 'Raining Blood', artist: 'Slayer', key: 4, mode: 'phrygian', progression: ['i', 'bII', 'i'], progressionChords: ['Em', 'F', 'Em'], scale: 'phrygian', genre: 'Thrash Metal', tips: 'Usa el modo Frigio. El bII (F) crea la tensin caracterstica del metal extremo.' },
                { name: 'Painkiller', artist: 'Judas Priest', key: 4, mode: 'minor', progression: ['i', 'bVII', 'bVI', 'V'], progressionChords: ['Em', 'D', 'C', 'B'], scale: 'harmonicMinor', genre: 'Heavy Metal', tips: 'Menor armnica para el V mayor (B). Tcnica extrema de doble bombo y velocidad.' },
                { name: 'Walk', artist: 'Pantera', key: 4, mode: 'minor', progression: ['i', 'bVII', 'bVI', 'bVII'], progressionChords: ['E5', 'D5', 'C5', 'D5'], scale: 'pentatonicMinor', genre: 'Groove Metal', tips: 'Power chords con palm mute. Groove pesado en 4/4. El groove es ms importante que la velocidad.' },
                { name: 'Chop Suey!', artist: 'System of a Down', key: 7, mode: 'minor', progression: ['i', 'bVI', 'bIII', 'bVII'], progressionChords: ['Gm', 'Eb', 'Bb', 'F'], scale: 'minor', genre: 'Nu Metal', tips: 'Drop C. Cambios dinmicos extremos entre secciones suaves y pesadas.' },
                { name: 'The Trooper', artist: 'Iron Maiden', key: 4, mode: 'minor', progression: ['i', 'bVII', 'bVI', 'bVII'], progressionChords: ['Em', 'D', 'C', 'D'], scale: 'minor', genre: 'Heavy Metal', tips: 'Gallop picking caracterstico. Harmonas de guitarras en terceras.' },
                // PROGRESIVO
                { name: 'Roundabout', artist: 'Yes', key: 4, mode: 'major', progression: ['I', 'IV', 'I', 'IV', 'V'], progressionChords: ['E', 'A', 'E', 'A', 'B'], scale: 'major', genre: 'Rock Progresivo', tips: 'Arpegio fingerpicking en E. Cambios de comps frecuentes.' },
                { name: 'Schism', artist: 'Tool', key: 2, mode: 'minor', progression: ['i', 'bVII', 'bVI'], progressionChords: ['Dm', 'C', 'Bb'], scale: 'minor', genre: 'Metal Progresivo', tips: 'Compases irregulares (5/8, 7/8). Drop D. Polirritmos complejos.' },
                { name: 'Pull Me Under', artist: 'Dream Theater', key: 4, mode: 'minor', progression: ['i', 'bVI', 'bVII', 'i'], progressionChords: ['Em', 'C', 'D', 'Em'], scale: 'minor', genre: 'Metal Progresivo', tips: 'Cambios de tempo y comps. Seccin instrumental extensa con tcnica avanzada.' },
                { name: 'Lateralus', artist: 'Tool', key: 2, mode: 'minor', progression: ['i', 'bVII', 'bVI', 'IV'], progressionChords: ['Dm', 'C', 'Bb', 'G'], scale: 'minor', genre: 'Metal Progresivo', tips: 'Basado en secuencia Fibonacci. Polirritmos. La estructura sigue matemticas complejas.' },
                // ROCK
                { name: 'Comfortably Numb', artist: 'Pink Floyd', key: 11, mode: 'minor', progression: ['i', 'IV', 'bVII', 'bVI'], progressionChords: ['Bm', 'E', 'A', 'G'], scale: 'minor', genre: 'Rock Progresivo', tips: 'Solo icnico en Bm pentatnica. Bends expresivos y vibrato amplio.' },
                { name: 'Eruption', artist: 'Van Halen', key: 9, mode: 'minor', progression: ['Instrumental'], progressionChords: ['Am'], scale: 'pentatonicMinor', genre: 'Hard Rock', tips: 'Tapping, tremolo picking, whammy bar. Am pentatnica. Tcnica revolucionaria.' },
                { name: 'Sweet Child O Mine', artist: "Guns N' Roses", key: 2, mode: 'major', progression: ['I', 'V', 'vi', 'IV'], progressionChords: ['D', 'A', 'Bm', 'G'], scale: 'major', genre: 'Hard Rock', tips: 'Riff en D mayor. Secuencia de arpegio icnica con string skipping.' },
                { name: 'Stairway to Heaven', artist: 'Led Zeppelin', key: 9, mode: 'minor', progression: ['i', 'bVII6', 'bVI', 'bVII'], progressionChords: ['Am', 'G/B', 'C', 'D'], scale: 'minor', genre: 'Rock', tips: 'Arpegio fingerpicking. Progresin descendente de bajo. Construccin dinmica perfecta.' },
                // BLUES
                { name: 'The Thrill Is Gone', artist: 'B.B. King', key: 11, mode: 'minor', progression: ['i', 'iv', 'i', 'V'], progressionChords: ['Bm', 'Em', 'Bm', 'F#7'], scale: 'pentatonicMinor', genre: 'Blues', tips: 'Blues menor en Bm. Vibrato y bends expresivos al estilo B.B. King. Menos notas, ms sentimiento.' },
                { name: 'Cross Road Blues', artist: 'Robert Johnson', key: 9, mode: 'minor', progression: ['I', 'IV', 'I', 'V'], progressionChords: ['A', 'D', 'A', 'E'], scale: 'pentatonicMinor', genre: 'Blues', tips: 'Blues de 12 compases clsico. Fingerpicking estilo Delta Blues. Afinacin abierta opcional.' },
                { name: 'Red House', artist: 'Jimi Hendrix', key: 11, mode: 'major', progression: ['I', 'IV', 'I', 'V'], progressionChords: ['B', 'E', 'B', 'F#'], scale: 'pentatonicMinor', genre: 'Blues Rock', tips: 'Blues lento en B. Bends de un tono y medio. Mezcla de pentatnica mayor y menor.' },
                // JAZZ
                { name: 'Autumn Leaves', artist: 'Joseph Kosma', key: 7, mode: 'minor', progression: ['ii', 'V', 'I', 'IV', 'vii', 'III', 'vi'], progressionChords: ['Am7', 'D7', 'Gmaj7', 'Cmaj7', 'F#m7b5', 'B7', 'Em'], scale: 'minor', genre: 'Jazz', tips: 'Standard de jazz esencial. Progresin ii-V-I en mayor y menor. Base para improvisar con arpegios.' },
                { name: 'So What', artist: 'Miles Davis', key: 2, mode: 'dorian', progression: ['i', 'i'], progressionChords: ['Dm7', 'Ebm7'], scale: 'dorian', genre: 'Cool Jazz', tips: 'Jazz modal. 16 compases en Dm7, 8 en Ebm7, 8 en Dm7. Usa el modo Drico.' },
                { name: 'Girl from Ipanema', artist: 'Tom Jobim', key: 5, mode: 'major', progression: ['I', 'ii', 'I', 'ii'], progressionChords: ['Fmaj7', 'G7', 'Fmaj7', 'Gb7'], scale: 'major', genre: 'Bossa Nova', tips: 'Bossa nova icnica. Ritmo sincopado brasileo. Acordes con 7 y 9. Modulacin cromtica al puente.' },
                { name: 'Take Five', artist: 'Dave Brubeck', key: 4, mode: 'minor', progression: ['i', 'bVII', 'i', 'bVII'], progressionChords: ['Ebm', 'Bbm7', 'Ebm', 'Bbm7'], scale: 'pentatonicMinor', genre: 'Jazz', tips: 'Comps de 5/4. Ostinato de piano en Ebm. Uno de los temas de jazz ms reconocibles.' },
                // FUNK/SOUL
                { name: 'Superstition', artist: 'Stevie Wonder', key: 4, mode: 'minor', progression: ['i', 'bVII', 'IV'], progressionChords: ['Ebm', 'Db', 'Ab'], scale: 'pentatonicMinor', genre: 'Funk', tips: 'Riff de clavinet icnico. Groove funk sincopado. Pentatnica menor con cromatismos.' },
                { name: 'Le Freak', artist: 'Chic', key: 9, mode: 'minor', progression: ['i', 'bVII', 'i', 'bVII'], progressionChords: ['Am7', 'G', 'Am7', 'G'], scale: 'pentatonicMinor', genre: 'Funk', tips: 'Guitarra rtmica funk con acordes parciales. Ritmo disco sincopado. Nile Rodgers style.' },
                { name: "Ain't No Sunshine", artist: 'Bill Withers', key: 9, mode: 'minor', progression: ['i', 'iv', 'V', 'i'], progressionChords: ['Am', 'Dm', 'E7', 'Am'], scale: 'minor', genre: 'Soul', tips: 'Progresin menor simple pero emotiva. Menor armnica en el V (E7). Fingerpicking suave.' },
                // POP
                { name: 'Let It Be', artist: 'The Beatles', key: 0, mode: 'major', progression: ['I', 'V', 'vi', 'IV'], progressionChords: ['C', 'G', 'Am', 'F'], scale: 'major', genre: 'Pop Rock', tips: 'Progresin I-V-vi-IV en C. Acordes abiertos bsicos. Solo pentatnico sobre la progresin.' },
                { name: 'Wonderwall', artist: 'Oasis', key: 4, mode: 'minor', progression: ['i', 'bIII', 'bVII', 'IV'], progressionChords: ['Em7', 'G', 'D', 'A7sus4'], scale: 'minor', genre: 'Pop Rock', tips: 'Rasgueo constante con patrn Down-Down-Up-Up-Down-Up. Capo en traste 2. Acordes suspendidos.' },
                { name: 'Hotel California', artist: 'Eagles', key: 11, mode: 'minor', progression: ['i', 'V', 'bVII', 'IV', 'bVI', 'bIII', 'iv', 'V'], progressionChords: ['Bm', 'F#7', 'A', 'E', 'G', 'D', 'Em', 'F#7'], scale: 'harmonicMinor', genre: 'Rock', tips: 'Arpegio fingerpicking. Progresin de 8 acordes descendente. Solo final con armonas de guitarra en terceras.' },
                // FLAMENCO/LATIN
                { name: 'Entre dos Aguas', artist: 'Paco de Luca', key: 9, mode: 'phrygian', progression: ['i', 'bII', 'bVII', 'i'], progressionChords: ['Am', 'Bb', 'G', 'Am'], scale: 'phrygian', genre: 'Flamenco', tips: 'Rumba flamenca. Tcnica de pulgar y rasgueados. Modo Frigio con cadencia andaluza.' },
                { name: 'Oye Como Va', artist: 'Santana', key: 9, mode: 'dorian', progression: ['i', 'IV', 'i', 'IV'], progressionChords: ['Am7', 'D7', 'Am7', 'D7'], scale: 'dorian', genre: 'Latin Rock', tips: 'Dos acordes: Am7 y D7. Modo Drico. Groove latino con guitarra elctrica. Improvisacin modal.' },
                { name: 'Europa', artist: 'Santana', key: 0, mode: 'minor', progression: ['i', 'bVII', 'bVI', 'V'], progressionChords: ['Cm', 'Bb', 'Ab', 'G'], scale: 'harmonicMinor', genre: 'Latin Rock', tips: 'Balada instrumental. Menor armnica para el V mayor. Vibrato y bends expresivos estilo Santana.' },
                // REGGAE
                { name: 'No Woman No Cry', artist: 'Bob Marley', key: 0, mode: 'major', progression: ['I', 'V', 'vi', 'IV'], progressionChords: ['C', 'G', 'Am', 'F'], scale: 'major', genre: 'Reggae', tips: 'Rasgueo reggae en los tiempos 2 y 4 (offbeat). Acordes abiertos. Ritmo relajado.' },
                { name: 'Three Little Birds', artist: 'Bob Marley', key: 9, mode: 'major', progression: ['I', 'IV', 'I', 'V'], progressionChords: ['A', 'D', 'A', 'E'], scale: 'major', genre: 'Reggae', tips: 'Tres acordes bsicos. Strum en offbeat. Groove reggae simple y efectivo.' },
                // COUNTRY
                { name: 'Folsom Prison Blues', artist: 'Johnny Cash', key: 4, mode: 'major', progression: ['I', 'IV', 'I', 'V'], progressionChords: ['E', 'A', 'E', 'B7'], scale: 'pentatonicMinor', genre: 'Country', tips: 'Boom-chicka pattern con bajo alternante. Country blues con tren rhythm. Pentatnica con sabor country.' },
                { name: 'Jolene', artist: 'Dolly Parton', key: 0, mode: 'minor', progression: ['i', 'bIII', 'iv', 'i'], progressionChords: ['Am', 'C', 'Dm', 'Am'], scale: 'minor', genre: 'Country', tips: 'Fingerpicking rpido en Am. Ritmo urgente. Acordes menores con meloda vocal icnica.' },
                // GRUNGE/ALT
                { name: 'Smells Like Teen Spirit', artist: 'Nirvana', key: 5, mode: 'minor', progression: ['i', 'iv', 'bIII', 'bVI'], progressionChords: ['Fm', 'Bbm', 'Ab', 'Db'], scale: 'pentatonicMinor', genre: 'Grunge', tips: 'Power chords con distorsin. Dinmica suave/fuerte. Patrn rtmico simple pero efectivo.' },
                { name: 'Black Hole Sun', artist: 'Soundgarden', key: 7, mode: 'minor', progression: ['i', 'V', 'bVI', 'bII'], progressionChords: ['Gm', 'D', 'Eb', 'Ab'], scale: 'minor', genre: 'Grunge', tips: 'Acordes inusuales y oscuros. Mezcla de mayor y menor. Drop D tuning. Atmsfera surrealista.' },
                { name: 'The Scientist', artist: 'Coldplay', key: 2, mode: 'major', progression: ['vi', 'IV', 'I', 'V'], progressionChords: ['Bm', 'G', 'D', 'A'], scale: 'major', genre: 'Alternative', tips: 'Arpegio fingerpicking. Progresin emotiva empezando en vi menor. Pedal de delay para ambiente.' },
                { name: 'Seven Nation Army', artist: 'The White Stripes', key: 4, mode: 'minor', progression: ['Riff modal'], progressionChords: ['E5-G5-D5-C5-B5'], scale: 'pentatonicMinor', genre: 'Alternative Rock', tips: 'Riff icnico con octavador. E pentatnica menor. Minimalismo poderoso con dos notas.' },
                // FLAMENCO TRADICIONAL
                { name: 'Tangos de Triana', artist: 'Tradicional', key: 9, mode: 'phrygian', progression: ['i', 'bVII', 'bVI', 'V'], progressionChords: ['Am', 'G', 'F', 'E'], scale: 'phrygian', genre: 'Flamenco', tips: 'Comps de 4/4. Rasgueado flamenco con acentos en 1 y 3. Cadencia andaluza caracterstica.' },
                { name: 'Buleras', artist: 'Paco de Luca', key: 9, mode: 'phrygian', progression: ['i', 'bII', 'i'], progressionChords: ['A', 'Bb', 'A'], scale: 'phrygianDominant', genre: 'Flamenco', tips: 'Comps de 12 tiempos (acentos 3-6-8-10-12). Modo Frigio dominante. Tcnica de pulgar y alzapa.' },
                { name: 'Alegras', artist: 'Tradicional', key: 4, mode: 'major', progression: ['I', 'IV', 'V', 'I'], progressionChords: ['E', 'A', 'B7', 'E'], scale: 'major', genre: 'Flamenco', tips: 'Comps de 12 similar a sole. E mayor con intercambios modales frigios. Palmas y jaleos.' },
                { name: 'Sole', artist: 'Tradicional', key: 4, mode: 'phrygian', progression: ['i', 'bVII', 'bVI', 'V'], progressionChords: ['E', 'D', 'C', 'B'], scale: 'phrygian', genre: 'Flamenco', tips: 'Comps de 12 con acentos 3-6-8-10-12. E Frigio. La "madre" del flamenco. Tempo lento y majestuoso.' },
                { name: 'Rumba Gitana', artist: 'Gipsy Kings', key: 2, mode: 'phrygian', progression: ['i', 'bVII', 'bVI', 'V'], progressionChords: ['Dm', 'C', 'Bb', 'A'], scale: 'phrygian', genre: 'Rumba Flamenca', tips: 'Rumba catalana. Rasgueo: abajo-abajo-arriba-abajo-arriba. Percusin en la guitarra.' },
                // JAZZ/FUSION AVANZADO
                { name: 'All Blues', artist: 'Miles Davis', key: 7, mode: 'mixolydian', progression: ['I7', 'IV7', 'I7', 'V7'], progressionChords: ['G7', 'C7', 'G7', 'D7'], scale: 'mixolydian', genre: 'Jazz Modal', tips: 'Blues modal en 6/8. G Mixolidio. Forma de 12 compases con acordes dominantes. Modal no funcional.' },
                { name: 'Blue Bossa', artist: 'Kenny Dorham', key: 0, mode: 'minor', progression: ['ii', 'V', 'i', 'IV', 'vii', 'III', 'VI', 'ii', 'V'], progressionChords: ['Cm7', 'Fm7', 'Dm7b5', 'G7', 'Ebmaj7', 'Abmaj7', 'Dm7b5', 'G7'], scale: 'dorian', genre: 'Jazz Bossa', tips: 'Bossa nova con ii-V-i en menor. Modulacin a Eb mayor. Ritmo sincopado brasileo.' },
                { name: 'Spain', artist: 'Chick Corea', key: 7, mode: 'lydian', progression: ['I', 'bVII', 'I'], progressionChords: ['Gmaj7', 'F#7', 'Gmaj7'], scale: 'lydian', genre: 'Jazz Fusion', tips: 'Intro con arpegios flamencos en G. Seccin modal Gmaj7 (Lidio). Modulacin a Gmaj7 despus del puente.' },
                { name: 'Chameleon', artist: 'Herbie Hancock', key: 10, mode: 'dorian', progression: ['i', 'IV'], progressionChords: ['Bbm7', 'Eb7'], scale: 'dorian', genre: 'Jazz Funk', tips: 'Riff de bajo funk. Bb Drico. Groove sintetizador. Improvisacin modal sobre ostinato.' },
                { name: 'Cantaloupe Island', artist: 'Herbie Hancock', key: 5, mode: 'dorian', progression: ['i', 'IV'], progressionChords: ['Fm7', 'Db7'], scale: 'dorian', genre: 'Jazz Funk', tips: 'F Drico con IV mayor. Groove funk de 16 compases. Uno de los jazz standards ms accesibles.' },
                { name: 'Strasbourg/St. Denis', artist: 'Roy Hargrove', key: 2, mode: 'dorian', progression: ['i', 'i'], progressionChords: ['Dm7', 'Dm7'], scale: 'dorian', genre: 'Jazz Hip-Hop', tips: 'Vamp modal en Dm7 con feel hip-hop. D Drico. Groove groove groove. Improvisacin libre.' },
                // BOSSA NOVA
                { name: 'Wave', artist: 'Tom Jobim', key: 2, mode: 'major', progression: ['I', 'vi', 'ii', 'V'], progressionChords: ['Dmaj7', 'Bm7', 'Em7', 'A7'], scale: 'major', genre: 'Bossa Nova', tips: 'Bossa clsica. Progresin I-vi-ii-V. Ritmo sincopado brasileo. Acordes con 7 y extensiones.' },
                { name: 'Desafinado', artist: 'Tom Jobim', key: 5, mode: 'major', progression: ['ii', 'V', 'I'], progressionChords: ['Gm7', 'C7', 'Fmaj7'], scale: 'major', genre: 'Bossa Nova', tips: 'Bossa con mltiples ii-V-I. Modulaciones sutiles. Acordes de jazz con 9 y 11.' },
                { name: 'gua de Beber', artist: 'Tom Jobim', key: 9, mode: 'dorian', progression: ['i', 'iv', 'V'], progressionChords: ['Am7', 'Dm7', 'E7'], scale: 'dorian', genre: 'Bossa Nova', tips: 'A Drico con cadencia i-iv-V. Menor con V mayor (prestado de armnica). Ritmo bossa clsico.' },
                // ELECTRNICA/MODERNA
                { name: 'Strobe', artist: 'deadmau5', key: 2, mode: 'dorian', progression: ['i', 'V', 'bVII', 'IV'], progressionChords: ['Dm', 'A', 'C', 'G'], scale: 'dorian', genre: 'Progressive House', tips: 'Progresin electrnica progresiva. D Drico. Construccin lenta de tensin. Minimalismo pico.' },
                { name: 'Midnight City', artist: 'M83', key: 2, mode: 'major', progression: ['I', 'V', 'vi', 'IV'], progressionChords: ['D', 'A', 'Bm', 'G'], scale: 'major', genre: 'Synthwave', tips: 'Progresin pop universal con sintetizadores. Ambiente nostlgico 80s. Delay y reverb.' },
                { name: 'Concerning Hobbits', artist: 'Howard Shore', key: 2, mode: 'mixolydian', progression: ['I', 'bVII', 'I', 'bVII'], progressionChords: ['D', 'C', 'D', 'C'], scale: 'mixolydian', genre: 'Soundtrack', tips: 'D Mixolidio con bVII. Ambiente pastoral. Ritmo de giga irlandesa. Meloda folk.' },
            ],

            // Progressions with chord degrees
            progressions: {
                'I-IV-V-I': {
                    degrees: [1, 4, 5, 1],
                    name: 'Blues Bsico',
                    style: 'Blues/Rock clsico',
                    function: ['T', 'SD', 'D', 'T'],
                    analysis: 'Progresin fundamental. El IV crea tensin suave, el V tensin fuerte que resuelve al I. Base del blues y rock.',
                    songs: ['Johnny B. Goode (Chuck Berry)', 'La Bamba (Ritchie Valens)']
                },
                'I-V-vi-IV': {
                    degrees: [1, 5, 6, 4],
                    name: 'Pop Universal',
                    style: 'Pop moderno',
                    function: ['T', 'D', 'Tm', 'SD'],
                    analysis: 'La progresin ms popular de todos los tiempos. El vi (menor relativo) aade emocin, el IV crea anticipacin antes de volver al I.',
                    songs: ['Let It Be (Beatles)', 'No Woman No Cry (Bob Marley)', 'With or Without You (U2)']
                },
                'ii-V-I': {
                    degrees: [2, 5, 1],
                    name: 'Jazz ii-V-I',
                    style: 'Jazz/Standards',
                    function: ['SD', 'D', 'T'],
                    analysis: 'Cadencia perfecta del jazz. El ii prepara al V (dominante) que resuelve con fuerza al I. Se encadenan mltiples ii-V-I modulando.',
                    songs: ['Autumn Leaves', 'Fly Me to the Moon', 'Take the A Train']
                },
                'I-vi-IV-V': {
                    degrees: [1, 6, 4, 5],
                    name: '50s Doo-wop',
                    style: 'Oldies/Doo-wop',
                    function: ['T', 'Tm', 'SD', 'D'],
                    analysis: 'Progresin circular clsica de los 50s. El vi mantiene la tonalidad, IV y V crean tensin que resuelve al volver al I.',
                    songs: ['Stand by Me (Ben E. King)', 'Earth Angel', 'Blue Moon']
                },
                'vi-IV-I-V': {
                    degrees: [6, 4, 1, 5],
                    name: 'Axis Progression',
                    style: 'Pop pico',
                    function: ['Tm', 'SD', 'T', 'D'],
                    analysis: 'Versin dramtica de I-V-vi-IV. Empezar en vi crea melancola que se eleva al llegar al I. Muy emotiva.',
                    songs: ['Africa (Toto)', 'Poker Face (Lady Gaga)', 'Cheap Thrills (Sia)']
                },
                'I-bVII-IV-I': {
                    degrees: [1, -7, 4, 1],
                    name: 'Rock Mixolidio',
                    style: 'Rock clsico',
                    function: ['T', 'bVII', 'SD', 'T'],
                    analysis: 'El bVII (acorde prestado) viene del modo Mixolidio. Crea sonido rock/bluesy caracterstico.',
                    songs: ['Sweet Home Alabama', 'Hey Jude (puente)']
                },
                'i-bVII-bVI-V': {
                    degrees: [-1, -7, -6, 5],
                    name: 'Andaluza',
                    style: 'Flamenco/Metal',
                    function: ['Tm', 'bVII', 'bVI', 'D'],
                    analysis: 'Cadencia andaluza. Progresin descendente desde i con acordes del modo Frigio. El V mayor (dominante) crea resolucin fuerte.',
                    songs: ['Hit the Lights (Metallica)', 'Flamenco tradicional']
                },
                'i-bVI-bIII-bVII': {
                    degrees: [-1, -6, -3, -7],
                    name: 'Epic/Cinematic',
                    style: 'pico/Cine',
                    function: ['Tm', 'bVI', 'bIII', 'bVII'],
                    analysis: 'Progresin pica moderna. Los acordes mayores (bVI, bIII, bVII) en tonalidad menor crean grandiosidad cinematogrfica.',
                    songs: ['Wake Me Up (Avicii)', 'Numb (Linkin Park)', 'Bandas sonoras picas']
                },
                'i-iv-v-i': {
                    degrees: [-1, -4, -5, -1],
                    name: 'Menor Clsica',
                    style: 'Clsico/Barroco',
                    function: ['Tm', 'SDm', 'Dm', 'Tm'],
                    analysis: 'Progresin menor natural. Todos los acordes diatnicos a la escala menor. Sonido oscuro y clsico.',
                    songs: ['Msica clsica barroca', 'Stairway to Heaven (intro)']
                },
                'I-vi-ii-V': {
                    degrees: [1, 6, 2, 5],
                    name: 'Rhythm Changes',
                    style: 'Jazz/Bebop',
                    function: ['T', 'Tm', 'SD', 'D'],
                    analysis: 'Progresin de jazz bebop. Movimiento suave descendente por terceras que prepara el ii-V-I.',
                    songs: ['I Got Rhythm (Gershwin)', 'Anthropology (Charlie Parker)']
                },
                'I-V-vi-iii-IV-I-IV-V': {
                    degrees: [1, 5, 6, 3, 4, 1, 4, 5],
                    name: 'Canon de Pachelbel',
                    style: 'Barroco/Pop',
                    function: ['T', 'D', 'Tm', 'Dm', 'SD', 'T', 'SD', 'D'],
                    analysis: 'Progresin barroca de 8 acordes. Recorre toda la tonalidad con movimiento de bajo descendente. Usada en miles de canciones modernas.',
                    songs: ['Canon en D (Pachelbel)', 'Basket Case (Green Day)', 'Don\'t Look Back in Anger (Oasis)']
                },
                'bII7-I': {
                    degrees: [-2, 1],
                    name: 'Sustitucin Tritonal',
                    style: 'Jazz avanzado',
                    function: ['SubV', 'T'],
                    analysis: 'Sustitucin del dominante (V7) por su tritono (bII7). El bII7 comparte el tritono con V7 pero crea movimiento cromtico descendente al I. Tcnica fundamental del bebop.',
                    songs: ['Blue Bossa (Kenny Dorham)', 'Satin Doll (Duke Ellington)', 'Misty (Erroll Garner)']
                },
                'I-III7-VImaj7-bII7-I': {
                    degrees: [1, 3, 6, -2, 1],
                    name: 'Cambios Coltrane',
                    style: 'Jazz modal/Coltrane',
                    function: ['T', 'D/vi', 'T', 'SubV', 'T'],
                    analysis: 'Secuencia de tonalidades distantes por terceras mayores (Coltrane Cycles). El III7 modula al VI, el bII7 resuelve al I. Revolucion el jazz moderno.',
                    songs: ['Giant Steps (John Coltrane)', 'Countdown (John Coltrane)', '26-2 (John Coltrane)']
                },
                'I-vi-ii-V-I-vi-ii-V-IV-iv-I-ii-V-I': {
                    degrees: [1, 6, 2, 5, 1, 6, 2, 5, 4, -4, 1, 2, 5, 1],
                    name: 'Rhythm Changes (completo)',
                    style: 'Jazz/Bebop',
                    function: ['T', 'Tm', 'SD', 'D', 'T', 'Tm', 'SD', 'D', 'SD', 'SDm', 'T', 'SD', 'D', 'T'],
                    analysis: 'Forma armnica completa de "I Got Rhythm". Seccin A: I-vi-ii-V circular. Bridge (B): IV-iv-I (cadencia plagal con prstamo modal) seguido de ii-V-I. Estructura AABA estndar del jazz.',
                    songs: ['I Got Rhythm (Gershwin)', 'Anthropology (Parker)', 'Oleo (Rollins)', 'Rhythm-a-ning (Monk)']
                },
                'iii7-VI7-ii7-V7-I': {
                    degrees: [3, 6, 2, 5, 1],
                    name: 'Turnaround Extendido',
                    style: 'Jazz/Standards',
                    function: ['D/vi', 'D/ii', 'SD', 'D', 'T'],
                    analysis: 'Cadena de dominantes secundarias que prepara el ii-V-I. El iii7 funciona como V7/vi, VI7 como V7/ii. Crea momentum armnico hacia la resolucin.',
                    songs: ['Autumn Leaves', 'All the Things You Are', 'Stella by Starlight']
                },
                'i-IV': {
                    degrees: [-1, 4],
                    name: 'Vamp Drico',
                    style: 'Jazz modal/Funk',
                    function: ['Tm', 'SD'],
                    analysis: 'Ostinato modal caracterstico del modo Drico. El IV mayor sobre tnica menor define el sonido drico (6 mayor). Sin funcin de dominante, crea groove hipntico.',
                    songs: ['So What (Miles Davis)', 'Impressions (Coltrane)', 'Oye Como Va (Santana)', 'Get Lucky (Daft Punk)']
                },
                'I-bII': {
                    degrees: [1, -2],
                    name: 'Vamp Frigio',
                    style: 'Flamenco/Metal/Espaol',
                    function: ['T', 'bII'],
                    analysis: 'Movimiento semitonal caracterstico del modo Frigio (2 menor). El bII crea tensin extica sin resolucin. Esencia del flamenco y metal meldico.',
                    songs: ['Master of Puppets (Metallica)', 'Flamenco tradicional', 'Dark Necessities (RHCP)', 'msica espaola']
                },
                'bVII-IV-I': {
                    degrees: [-7, 4, 1],
                    name: 'Plagal Mixolidio',
                    style: 'Rock/Blues-rock',
                    function: ['bVII', 'SD', 'T'],
                    analysis: 'Cadencia plagal (IV-I) precedida del bVII mixolidio. Sonido rock clsico: el bVII viene del acorde prestado del modo mixolidio, el IV crea subdominante fuerte.',
                    songs: ['Sweet Child O\' Mine (GNR)', 'Free Fallin\' (Tom Petty)', 'Hey Jude (Beatles - puente)']
                },
                'vi-V-IV-V': {
                    degrees: [6, 5, 4, 5],
                    name: 'Indie/Alternative',
                    style: 'Indie rock/Alternative',
                    function: ['Tm', 'D', 'SD', 'D'],
                    analysis: 'Progresin indie moderna. Empieza en vi (melancola), V crea tensin, IV alivia, V vuelve a tensar. Movimiento oscilante entre tensin y alivio sin resolucin clara al I.',
                    songs: ['Mr. Brightside (The Killers)', 'When You Were Young (The Killers)', 'Indie rock moderno']
                },
                'i-bVII-bVI-bVII': {
                    degrees: [-1, -7, -6, -7],
                    name: 'Modal Menor Rock',
                    style: 'Rock/Metal progresivo',
                    function: ['Tm', 'bVII', 'bVI', 'bVII'],
                    analysis: 'Progresin elica (menor natural) con nfasis en acordes prestados bVII y bVI. El bVII acta como pivote entre i y bVI. Sonido pico y oscuro del rock progresivo.',
                    songs: ['Comfortably Numb (Pink Floyd)', 'Stairway to Heaven (Led Zeppelin - secciones)', 'Nothing Else Matters (Metallica)']
                },
                'I-III-vi-IV': {
                    degrees: [1, 3, 6, 4],
                    name: 'Ascenso por Terceras',
                    style: 'Pop/Rock meldico',
                    function: ['T', 'Dm', 'Tm', 'SD'],
                    analysis: 'Movimiento ascendente por terceras desde I. El III (mediant) es poco comn y crea color sorprendente. Mantiene emocin elevada antes de resolver con IV.',
                    songs: ['Variaciones pop modernas', 'Power ballads']
                },
            },

            // Real chord voicings (fret positions for each string, -1 = muted, 0 = open)
            // Format: [E6, A5, D4, G3, B2, E1] (low to high)
            chordVoicings: {
                // Major chords (CAGED shapes)
                'C': { frets: [-1, 3, 2, 0, 1, 0], fingers: [0, 3, 2, 0, 1, 0], barreInfo: null, position: 0 },
                'A': { frets: [-1, 0, 2, 2, 2, 0], fingers: [0, 0, 1, 2, 3, 0], barreInfo: null, position: 0 },
                'G': { frets: [3, 2, 0, 0, 0, 3], fingers: [2, 1, 0, 0, 0, 3], barreInfo: null, position: 0 },
                'E': { frets: [0, 2, 2, 1, 0, 0], fingers: [0, 2, 3, 1, 0, 0], barreInfo: null, position: 0 },
                'D': { frets: [-1, -1, 0, 2, 3, 2], fingers: [0, 0, 0, 1, 3, 2], barreInfo: null, position: 0 },
                // Minor chords
                'Am': { frets: [-1, 0, 2, 2, 1, 0], fingers: [0, 0, 2, 3, 1, 0], barreInfo: null, position: 0 },
                'Em': { frets: [0, 2, 2, 0, 0, 0], fingers: [0, 2, 3, 0, 0, 0], barreInfo: null, position: 0 },
                'Dm': { frets: [-1, -1, 0, 2, 3, 1], fingers: [0, 0, 0, 2, 3, 1], barreInfo: null, position: 0 },
                // Barre chord templates (E shape and A shape)
                'E_shape_major': { frets: [0, 2, 2, 1, 0, 0], fingers: [1, 3, 4, 2, 1, 1], barreInfo: { fret: 0, fromString: 0, toString: 5 }, position: 0 },
                'E_shape_minor': { frets: [0, 2, 2, 0, 0, 0], fingers: [1, 3, 4, 1, 1, 1], barreInfo: { fret: 0, fromString: 0, toString: 5 }, position: 0 },
                'A_shape_major': { frets: [-1, 0, 2, 2, 2, 0], fingers: [0, 1, 3, 3, 3, 1], barreInfo: { fret: 0, fromString: 1, toString: 5 }, position: 0 },
                'A_shape_minor': { frets: [-1, 0, 2, 2, 1, 0], fingers: [0, 1, 3, 4, 2, 1], barreInfo: { fret: 0, fromString: 1, toString: 5 }, position: 0 },
            },

            // 7th chord voicings
            seventhVoicings: {
                'maj7_E': { frets: [0, 2, 1, 1, 0, 0], fingers: [0, 3, 1, 2, 0, 0], barreInfo: null, position: 0, type: 'maj7' },
                'maj7_A': { frets: [-1, 0, 2, 1, 2, 0], fingers: [0, 0, 2, 1, 3, 0], barreInfo: null, position: 0, type: 'maj7' },
                'maj7_C': { frets: [-1, 3, 2, 0, 0, 0], fingers: [0, 3, 2, 0, 0, 0], barreInfo: null, position: 0, type: 'maj7' },
                'm7_E': { frets: [0, 2, 0, 0, 0, 0], fingers: [0, 2, 0, 0, 0, 0], barreInfo: null, position: 0, type: 'm7' },
                'm7_A': { frets: [-1, 0, 2, 0, 1, 0], fingers: [0, 0, 2, 0, 1, 0], barreInfo: null, position: 0, type: 'm7' },
                'dom7_E': { frets: [0, 2, 0, 1, 0, 0], fingers: [0, 2, 0, 1, 0, 0], barreInfo: null, position: 0, type: '7' },
                'dom7_A': { frets: [-1, 0, 2, 0, 2, 0], fingers: [0, 0, 1, 0, 2, 0], barreInfo: null, position: 0, type: '7' },
                'm7b5_E': { frets: [-1, -1, 2, 3, 3, 3], fingers: [0, 0, 1, 2, 3, 4], barreInfo: null, position: 0, type: '7' },
            },

            // Pentatonic box positions (fret range relative to root)
            pentatonicBoxes: {
                minor: [
                    { name: 'Box 1 (E shape)', startFret: 0, pattern: [
                        { string: 0, frets: [0, 3] },
                        { string: 1, frets: [0, 3] },
                        { string: 2, frets: [0, 2] },
                        { string: 3, frets: [0, 2] },
                        { string: 4, frets: [0, 2] },
                        { string: 5, frets: [0, 3] },
                    ]},
                    { name: 'Box 2 (D shape)', startFret: 3, pattern: [
                        { string: 0, frets: [0, 2] },
                        { string: 1, frets: [0, 2] },
                        { string: 2, frets: [-1, 2] },
                        { string: 3, frets: [-1, 2] },
                        { string: 4, frets: [-1, 2] },
                        { string: 5, frets: [0, 2] },
                    ]},
                    { name: 'Box 3 (C shape)', startFret: 5, pattern: [
                        { string: 0, frets: [0, 2] },
                        { string: 1, frets: [0, 3] },
                        { string: 2, frets: [0, 2] },
                        { string: 3, frets: [0, 2] },
                        { string: 4, frets: [0, 3] },
                        { string: 5, frets: [0, 2] },
                    ]},
                    { name: 'Box 4 (A shape)', startFret: 7, pattern: [
                        { string: 0, frets: [0, 3] },
                        { string: 1, frets: [0, 2] },
                        { string: 2, frets: [0, 2] },
                        { string: 3, frets: [0, 3] },
                        { string: 4, frets: [0, 2] },
                        { string: 5, frets: [0, 3] },
                    ]},
                    { name: 'Box 5 (G shape)', startFret: 10, pattern: [
                        { string: 0, frets: [0, 2] },
                        { string: 1, frets: [0, 2] },
                        { string: 2, frets: [-1, 2] },
                        { string: 3, frets: [0, 2] },
                        { string: 4, frets: [0, 2] },
                        { string: 5, frets: [0, 2] },
                    ]},
                ],
            },

            // CAGED positions with actual fret positions for C major
            cagedPositions: {
                'C': {
                    startFret: 0,
                    endFret: 3,
                    chord: { frets: [-1, 3, 2, 0, 1, 0], fingers: [0, 3, 2, 0, 1, 0] },
                    rootStrings: [1, 4], // A and B strings
                    description: 'Posicin abierta'
                },
                'A': {
                    startFret: 2,
                    endFret: 5,
                    chord: { frets: [-1, 3, 5, 5, 5, 3], fingers: [0, 1, 3, 3, 3, 1], barreInfo: { fret: 3, fromString: 1, toString: 5 } },
                    rootStrings: [1, 3],
                    description: 'Traste 3 (cejilla)'
                },
                'G': {
                    startFret: 4,
                    endFret: 8,
                    chord: { frets: [8, 7, 5, 5, 5, 8], fingers: [3, 2, 1, 1, 1, 4] },
                    rootStrings: [0, 2, 5],
                    description: 'Traste 5-8'
                },
                'E': {
                    startFret: 7,
                    endFret: 10,
                    chord: { frets: [8, 10, 10, 9, 8, 8], fingers: [1, 3, 4, 2, 1, 1], barreInfo: { fret: 8, fromString: 0, toString: 5 } },
                    rootStrings: [0, 3, 5],
                    description: 'Traste 8 (cejilla)'
                },
                'D': {
                    startFret: 9,
                    endFret: 12,
                    chord: { frets: [-1, -1, 10, 12, 13, 12], fingers: [0, 0, 1, 3, 4, 2] },
                    rootStrings: [2, 4],
                    description: 'Traste 10-13'
                },
            },

            // Get chord voicing for any root note using shape transposition
            getChordVoicing(root, quality, preferredShape = 'E') {
                const rootIndex = typeof root === 'number' ? root : this.getNoteIndex(root);
                const shapeName = quality === 'minor' ? `${preferredShape}_shape_minor` : `${preferredShape}_shape_major`;

                // Base shapes start at different frets
                const basePositions = { 'E': 0, 'A': 0, 'G': 3, 'C': 0, 'D': 0 };
                const basePosition = basePositions[preferredShape] || 0;

                // Calculate transposition
                const transposition = rootIndex + basePosition;

                return {
                    ...this.chordVoicings[shapeName] || this.chordVoicings['E_shape_major'],
                    position: transposition
                };
            }
        };

        // ========================================
        // AUDIO ENGINE - Web Audio API
        // ========================================
        const AudioEngine = {
            audioContext: null,
            masterGain: null,
            enabled: true,
            sampleBuffers: {}, // Cache de buffers de samples

            init() {
                if (!this.audioContext) {
                    try {
                        const AudioContext = window.AudioContext || window.webkitAudioContext;
                        if (!AudioContext) {
                            throw new Error('Web Audio API no soportada en este navegador');
                        }
                        this.audioContext = new AudioContext();
                        this.masterGain = this.audioContext.createGain();
                        this.masterGain.gain.value = 0.3; // Volumen equilibrado
                        this.masterGain.connect(this.audioContext.destination);
                    } catch (e) {
                        console.error('Error inicializando audio:', e);
                        this.showAudioError(e.message);
                        this.enabled = false;
                    }
                }
            },

            showAudioError(message) {
                const existingBanner = document.querySelector('.audio-error-banner');
                if (existingBanner) return;

                const banner = document.createElement('div');
                banner.className = 'audio-error-banner';
                banner.style.cssText = 'position: fixed; top: 10px; left: 50%; transform: translateX(-50%); background: #ff5252; color: white; padding: 12px 24px; border-radius: 4px; z-index: 10000; box-shadow: 0 2px 8px rgba(0,0,0,0.2);';
                banner.textContent = ' Audio no disponible en este navegador';
                document.body.prepend(banner);

                setTimeout(() => {
                    banner.style.opacity = '0';
                    banner.style.transition = 'opacity 0.5s';
                    setTimeout(() => banner.remove(), 500);
                }, 5000);
            },

            // Karplus-Strong OPTIMIZADO - Balance entre calidad y performance
            createGuitarBuffer(frequency, duration) {
                const sampleRate = this.audioContext.sampleRate;
                const maxDuration = Math.min(duration, 1.5); // Reducido para mejor performance
                const bufferLength = Math.ceil(sampleRate * maxDuration);
                const buffer = this.audioContext.createBuffer(1, bufferLength, sampleRate);
                const data = buffer.getChannelData(0);

                // Calcular periodo
                const period = sampleRate / frequency;
                const delayLength = Math.floor(period);
                const tuningError = period - delayLength;

                if (delayLength < 10 || delayLength > sampleRate / 20) {
                    // Fuera de rango - usar fallback
                    return this.createFallbackBuffer(frequency, duration);
                }

                // === 1. EXCITACIN (Pluck) - Mezcla optimizada ===
                for (let i = 0; i < delayLength && i < bufferLength; i++) {
                    const t = i / delayLength;

                    // Forma triangular (pa)
                    const pluckShape = t < 0.5 ? t * 2 : 2 - (t * 2);

                    // Ruido muy reducido (5%)
                    const noise = (Math.random() * 2 - 1) * 0.05;

                    data[i] = (pluckShape + noise) * 0.9;
                }

                // === 2. PROPAGACIN SIMPLIFICADA ===
                // Damping adaptativo (graves duran ms)
                const freqRatio = Math.min(frequency / 800, 1.0);
                const dampingFactor = 0.999 - (freqRatio * 0.0005);

                for (let i = delayLength; i < bufferLength; i++) {
                    // Karplus-Strong bsico optimizado
                    const idx1 = i - delayLength;
                    const idx2 = i - delayLength - 1;

                    if (idx2 >= 0) {
                        // Promedio de dos muestras anteriores
                        data[i] = ((data[idx1] + data[idx2]) * 0.5) * dampingFactor;
                    } else {
                        data[i] = data[idx1] * dampingFactor;
                    }
                }

                // === 3. ENVELOPE + VIBRATO + FADE-OUT SUAVE ===
                const attackSamples = Math.ceil(sampleRate * 0.001);
                const decayFactor = 1.0 + (freqRatio * 0.3);
                const vibratoFreq = 5.0;
                const vibratoDepth = 0.002;

                // Fade-out en los ltimos 50ms para eliminar clicks
                const fadeOutSamples = Math.ceil(sampleRate * 0.05);
                const fadeOutStart = bufferLength - fadeOutSamples;

                for (let i = 0; i < bufferLength; i++) {
                    const t = i / sampleRate;

                    // Envelope
                    let envelope;
                    if (i < attackSamples) {
                        envelope = i / attackSamples;
                    } else {
                        envelope = Math.exp(-t * decayFactor);
                    }

                    // Vibrato
                    const vibrato = Math.sin(2 * Math.PI * vibratoFreq * t) * vibratoDepth;

                    // Fade-out suave al final (elimina clicks/crunch)
                    let fadeOut = 1;
                    if (i > fadeOutStart) {
                        fadeOut = (bufferLength - i) / fadeOutSamples;
                        fadeOut = fadeOut * fadeOut; // Curva cuadrtica suave
                    }

                    // Aplicar todo de una vez
                    data[i] *= envelope * (1 + vibrato) * fadeOut * 0.75;
                }

                return buffer;
            },

            // Buffer simple de fallback para frecuencias problemticas
            createFallbackBuffer(frequency, duration) {
                const sampleRate = this.audioContext.sampleRate;
                const bufferLength = Math.ceil(sampleRate * duration);
                const buffer = this.audioContext.createBuffer(1, bufferLength, sampleRate);
                const data = buffer.getChannelData(0);

                for (let i = 0; i < bufferLength; i++) {
                    const t = i / sampleRate;
                    // Onda triangle simple con decay
                    const phase = (t * frequency) % 1;
                    const triangle = phase < 0.5 ? phase * 4 - 1 : 3 - phase * 4;
                    const envelope = Math.exp(-t * 1.5);
                    data[i] = triangle * envelope * 0.3;
                }

                return buffer;
            },

            // Convierte nota MIDI a frecuencia
            midiToFreq(midiNote) {
                return 440 * Math.pow(2, (midiNote - 69) / 12);
            },

            // Reproduce una nota usando sntesis fsica Karplus-Strong (optimizado para performance)
            playMidiNote(midiNote, duration = 0.7) {
                if (!this.enabled || !this.audioContext) return;

                if (this.audioContext.state === 'suspended') {
                    this.audioContext.resume();
                }

                const frequency = this.midiToFreq(midiNote);
                const now = this.audioContext.currentTime;

                try {
                    // Crear buffer de guitarra usando Karplus-Strong avanzado
                    const buffer = this.createGuitarBuffer(frequency, duration);

                    // BufferSource para reproducir el buffer
                    const source = this.audioContext.createBufferSource();
                    source.buffer = buffer;

                    // === CADENA OPTIMIZADA (3 filtros esenciales) ===

                    // 1. Simulacin de Pastilla - Resonancia tipo single-coil
                    const pickupFilter = this.audioContext.createBiquadFilter();
                    pickupFilter.type = 'peaking';
                    pickupFilter.frequency.value = 2400;
                    pickupFilter.Q.value = 1.5;
                    pickupFilter.gain.value = 3;

                    // 2. Tono - Roll-off natural de agudos
                    const toneFilter = this.audioContext.createBiquadFilter();
                    toneFilter.type = 'lowpass';
                    toneFilter.frequency.value = 5500; // Brillante y claro
                    toneFilter.Q.value = 0.8;

                    // Ganancia suavizada con ramp para evitar clicks
                    const outputGain = this.audioContext.createGain();
                    const dynamicGain = 0.8 - ((frequency - 200) / 12000);
                    const finalGain = Math.max(0.6, Math.min(0.85, dynamicGain));

                    // Fade-in muy corto para eliminar click inicial
                    outputGain.gain.setValueAtTime(0, now);
                    outputGain.gain.linearRampToValueAtTime(finalGain, now + 0.002);

                    // === CADENA ULTRA-EFICIENTE (3 nodos) ===
                    source.connect(pickupFilter);
                    pickupFilter.connect(toneFilter);
                    toneFilter.connect(outputGain);
                    outputGain.connect(this.masterGain);

                    // Reproducir
                    source.start(now);

                } catch (error) {
                    console.error('Error al reproducir nota:', error);
                    this.playSimpleNote(frequency, duration, now);
                }
            },

            // Fallback simple por si hay problemas
            playSimpleNote(frequency, duration, startTime) {
                const osc = this.audioContext.createOscillator();
                const gain = this.audioContext.createGain();

                osc.type = 'triangle';
                osc.frequency.value = frequency;

                gain.gain.setValueAtTime(0, startTime);
                gain.gain.linearRampToValueAtTime(0.3, startTime + 0.01);
                gain.gain.exponentialRampToValueAtTime(0.001, startTime + duration);

                osc.connect(gain);
                gain.connect(this.masterGain);

                osc.start(startTime);
                osc.stop(startTime + duration);
            },

            // Reproduce una nota individual (wrapper con octava)
            playNote(noteIndex, duration = 0.5, octave = 4) {
                const midiNote = 12 * (octave + 1) + noteIndex; // C4 = 60
                this.playMidiNote(midiNote, duration);
            },

            // Reproduce un intervalo (dos notas) - MEJORADO para Ear Training
            playInterval(rootNote, semitones, duration = 0.6, octave = 4) {
                if (!this.enabled || !this.audioContext) return;

                const rootMidi = 12 * (octave + 1) + rootNote;
                const targetMidi = rootMidi + semitones;

                this.playMidiNote(rootMidi, duration);

                setTimeout(() => {
                    this.playMidiNote(targetMidi, duration);
                }, duration * 1000 + 100);
            },

            // Reproduce un acorde (notas simultneas con efecto strum)
            playChord(notes, duration = 1.1) {
                if (!this.enabled || !this.audioContext) return;

                if (this.audioContext.state === 'suspended') {
                    this.audioContext.resume();
                }

                // Limitar acordes a mximo 4 notas para reducir carga
                const maxNotes = Math.min(notes.length, 4);
                const notesToPlay = notes.slice(0, maxNotes);

                // Strum natural (35ms entre cuerdas) - duracin mayor para fade-out completo
                notesToPlay.forEach((noteIndex, i) => {
                    setTimeout(() => {
                        this.playNote(noteIndex % 12, duration * 0.85, 3 + Math.floor(i / 2));
                    }, i * 35);
                });
            },

            // Reproduce una escala ascendente
            playScale(notes, tempo = 200) {
                if (!this.enabled) return;
                notes.forEach((noteObj, i) => {
                    setTimeout(() => {
                        const noteIndex = MusicTheory.getNoteIndex(noteObj.note);
                        this.playNote(noteIndex, 0.3, 4);
                    }, i * tempo);
                });
            },

            // NUEVO: Secuenciador de acordes para Jam Session
            playChordSequence(chordProgression, bpm, rootKey) {
                if (!this.enabled || !this.audioContext) return null;

                const beatDuration = (60 / bpm) * 1000 * 4; // 4 beats por acorde
                let currentBar = 0;

                const intervalId = setInterval(() => {
                    const symbol = chordProgression[currentBar % chordProgression.length];
                    const chordNotes = this.parseChordSymbol(symbol, rootKey);

                    if (chordNotes && chordNotes.length > 0) {
                        this.playChord(chordNotes, 1.5);
                    }

                    currentBar++;
                }, beatDuration);

                return intervalId;
            },

            // NUEVO: Convierte smbolos de acordes (I, V, vi, etc.) a notas MIDI
            parseChordSymbol(symbol, rootKey) {
                const degreeMap = {
                    'I': 0, 'i': 0,
                    'II': 2, 'ii': 2,
                    'III': 4, 'iii': 4,
                    'IV': 5, 'iv': 5,
                    'V': 7, 'v': 7,
                    'VI': 9, 'vi': 9,
                    'VII': 11, 'vii': 11,
                    'bII': 1, 'biii': 3, 'bVI': 8, 'bVII': 10, 'bIII': 3
                };

                // Detectar si es mayor o menor
                const isMinor = symbol.match(/^[ivx]+/) !== null && symbol !== symbol.toUpperCase().replace('b', '');
                const isSeventhChord = symbol.includes('7');

                // Extraer grado romano
                let romanPart = symbol.replace('7', '');
                const degree = degreeMap[romanPart];

                if (degree === undefined) return [];

                const root = (rootKey + degree) % 12;

                // Construir trada
                const third = isMinor ? 3 : 4;
                const notes = [
                    root,
                    (root + third) % 12,
                    (root + 7) % 12
                ];

                // Aadir 7 si es acorde de sptima
                if (isSeventhChord) {
                    const seventh = isMinor ? 10 : 10; // 7 menor para ambos
                    notes.push((root + seventh) % 12);
                }

                return notes;
            },

            // NUEVO: Detener secuenciador
            stopSequence(intervalId) {
                if (intervalId) {
                    clearInterval(intervalId);
                }
            },

            // NUEVO: Sonido de batera simple usando ruido y filtros
            playDrumSound(type) {
                if (!this.enabled || !this.audioContext) return;

                const now = this.audioContext.currentTime;

                if (type === 'kick') {
                    // Bombo: oscilador de baja frecuencia
                    const osc = this.audioContext.createOscillator();
                    const gain = this.audioContext.createGain();

                    osc.frequency.setValueAtTime(150, now);
                    osc.frequency.exponentialRampToValueAtTime(0.01, now + 0.3);

                    gain.gain.setValueAtTime(1, now);
                    gain.gain.exponentialRampToValueAtTime(0.001, now + 0.3);

                    osc.connect(gain);
                    gain.connect(this.masterGain);

                    osc.start(now);
                    osc.stop(now + 0.3);
                }
                else if (type === 'snare') {
                    // Tarola: ruido blanco con filtro
                    const bufferSize = this.audioContext.sampleRate * 0.1;
                    const buffer = this.audioContext.createBuffer(1, bufferSize, this.audioContext.sampleRate);
                    const data = buffer.getChannelData(0);

                    for (let i = 0; i < bufferSize; i++) {
                        data[i] = Math.random() * 2 - 1;
                    }

                    const noise = this.audioContext.createBufferSource();
                    noise.buffer = buffer;

                    const filter = this.audioContext.createBiquadFilter();
                    filter.type = 'highpass';
                    filter.frequency.value = 1000;

                    const gain = this.audioContext.createGain();
                    gain.gain.setValueAtTime(0.3, now);
                    gain.gain.exponentialRampToValueAtTime(0.001, now + 0.1);

                    noise.connect(filter);
                    filter.connect(gain);
                    gain.connect(this.masterGain);

                    noise.start(now);
                    noise.stop(now + 0.1);
                }
                else if (type === 'hihat') {
                    // Hi-hat: ruido blanco corto con filtro agudo
                    const bufferSize = this.audioContext.sampleRate * 0.03;
                    const buffer = this.audioContext.createBuffer(1, bufferSize, this.audioContext.sampleRate);
                    const data = buffer.getChannelData(0);

                    for (let i = 0; i < bufferSize; i++) {
                        data[i] = Math.random() * 2 - 1;
                    }

                    const noise = this.audioContext.createBufferSource();
                    noise.buffer = buffer;

                    const filter = this.audioContext.createBiquadFilter();
                    filter.type = 'highpass';
                    filter.frequency.value = 7000;

                    const gain = this.audioContext.createGain();
                    gain.gain.setValueAtTime(0.15, now);
                    gain.gain.exponentialRampToValueAtTime(0.001, now + 0.03);

                    noise.connect(filter);
                    filter.connect(gain);
                    gain.connect(this.masterGain);

                    noise.start(now);
                    noise.stop(now + 0.03);
                }
            },

            // NUEVO: Obtener patrn de batera segn feel
            getDrumPattern(feel, beat) {
                const patterns = {
                    'straight': {
                        kick: [0, 2],
                        snare: [1, 3],
                        hihat: [0, 0.5, 1, 1.5, 2, 2.5, 3, 3.5]
                    },
                    'shuffle': {
                        kick: [0, 2],
                        snare: [1, 3],
                        hihat: [0, 0.66, 1.33, 2, 2.66, 3.33]
                    },
                    'syncopated': {
                        kick: [0, 1.5, 2.5],
                        snare: [1, 3],
                        hihat: [0.5, 1, 1.5, 2, 2.5, 3, 3.5]
                    },
                    'ballad': {
                        kick: [0, 2],
                        snare: [1, 3],
                        hihat: [0, 1, 2, 3]
                    },
                    'driving': {
                        kick: [0, 0.5, 1, 1.5, 2, 2.5, 3, 3.5],
                        snare: [1, 3],
                        hihat: [0, 0.5, 1, 1.5, 2, 2.5, 3, 3.5]
                    },
                    'aggressive': {
                        kick: [0, 0.5, 1, 1.5, 2, 2.5, 3, 3.5],
                        snare: [1, 3],
                        hihat: [0, 0.5, 1, 1.5, 2, 2.5, 3, 3.5]
                    }
                };

                const pattern = patterns[feel.toLowerCase()] || patterns['straight'];
                return {
                    playKick: pattern.kick.includes(beat),
                    playSnare: pattern.snare.includes(beat),
                    playHihat: pattern.hihat.includes(beat)
                };
            },

            // NUEVO: Secuenciador con batera dinmica
            playChordSequenceWithDrums(chordProgression, bpm, rootKey, feel = 'straight', progressCallback = null) {
                if (!this.enabled || !this.audioContext) return null;

                const beatDuration = (60 / bpm) * 1000;
                const barDuration = beatDuration * 4;
                let currentBar = 0;
                let beatCount = 0;

                const intervals = {
                    chords: null,
                    drums: null,
                    currentBar: 0
                };

                // Acordes (cada 4 beats)
                intervals.chords = setInterval(() => {
                    const symbol = chordProgression[currentBar % chordProgression.length];
                    const chordNotes = this.parseChordSymbol(symbol, rootKey);

                    if (chordNotes && chordNotes.length > 0) {
                        this.playChord(chordNotes, 1.2);
                    }

                    intervals.currentBar = currentBar % chordProgression.length;

                    // Callback para actualizar UI
                    if (progressCallback) {
                        progressCallback({
                            bar: currentBar % chordProgression.length,
                            totalBars: chordProgression.length,
                            loopCount: Math.floor(currentBar / chordProgression.length)
                        });
                    }

                    currentBar++;
                }, barDuration);

                // Batera con subdivisiones (8th notes para hi-hat)
                const subdivisionDuration = beatDuration / 2; // 8th notes
                intervals.drums = setInterval(() => {
                    const beat = (beatCount % 8) / 2; // 0, 0.5, 1, 1.5, 2, 2.5, 3, 3.5
                    const wholeBeat = Math.floor(beat);

                    const pattern = this.getDrumPattern(feel, beat);

                    if (pattern.playKick) {
                        this.playDrumSound('kick');
                    }
                    if (pattern.playSnare) {
                        this.playDrumSound('snare');
                    }
                    if (pattern.playHihat) {
                        this.playDrumSound('hihat');
                    }

                    // Beat indicator callback (solo en beats enteros)
                    if (beat === wholeBeat && progressCallback) {
                        progressCallback({
                            beat: wholeBeat
                        });
                    }

                    beatCount++;
                }, subdivisionDuration);

                return intervals;
            },

            // Toggle audio on/off
            toggle() {
                this.enabled = !this.enabled;
                return this.enabled;
            },

            // Ajustar volumen master
            setVolume(value) {
                if (this.masterGain) {
                    this.masterGain.gain.value = Math.max(0, Math.min(1, value));
                }
            }
        };

        // ========================================
        // CHORD DIAGRAM COMPONENT - HORIZONTAL
        // ========================================
        const ChordDiagram = {
            create(voicing, chordName, position = 0) {
                const container = document.createElement('div');
                container.className = 'chord-diagram';
                container.style.paddingLeft = '40px';

                // Chord name
                const nameDiv = document.createElement('div');
                nameDiv.className = 'chord-name-display';
                nameDiv.innerHTML = `<div class="chord-symbol">${chordName}</div>`;
                container.appendChild(nameDiv);

                // Calculate actual frets
                const actualFrets = voicing.frets.map(f => f === -1 ? -1 : f + position);
                const validFrets = actualFrets.filter(f => f > 0);
                const minFret = validFrets.length > 0 ? Math.min(...validFrets) : 0;
                const maxFret = actualFrets.length > 0 ? Math.max(...actualFrets) : 0;
                const displayStartFret = position > 0 ? minFret : 0;
                const numFrets = Math.max(4, maxFret - displayStartFret + 1);
                const isOpenPosition = displayStartFret === 0;

                // Grid container (horizontal layout)
                const grid = document.createElement('div');
                grid.className = 'chord-diagram-grid';
                grid.style.position = 'relative';

                // String labels (left side)
                const stringLabels = document.createElement('div');
                stringLabels.className = 'string-labels-left';
                const stringNames = ['e', 'B', 'G', 'D', 'A', 'E'];
                stringNames.forEach(name => {
                    const label = document.createElement('div');
                    label.className = 'string-label-item';
                    label.textContent = name;
                    stringLabels.appendChild(label);
                });
                container.appendChild(stringLabels);

                // Create string rows (6 strings, horizontal)
                for (let string = 0; string < 6; string++) {
                    const row = document.createElement('div');
                    row.className = 'string-row';

                    const actualFret = actualFrets[string];

                    // Open/Muted indicator
                    if (actualFret === 0) {
                        const open = document.createElement('div');
                        open.className = 'open-indicator';
                        open.textContent = 'O';
                        row.appendChild(open);
                    } else if (actualFret === -1) {
                        const muted = document.createElement('div');
                        muted.className = 'muted-indicator';
                        muted.textContent = 'X';
                        row.appendChild(muted);
                    }

                    // Create fret cells
                    for (let fret = 0; fret < numFrets; fret++) {
                        const cell = document.createElement('div');
                        cell.className = 'fret-cell';

                        // First fret is the nut if open position
                        if (fret === 0 && isOpenPosition) {
                            cell.classList.add('nut-fret');
                        }

                        const displayFret = actualFret - displayStartFret;

                        // Check for finger dot
                        if (displayFret === fret && actualFret > 0) {
                            const dot = document.createElement('div');
                            dot.className = 'finger-dot';

                            // Check if root note
                            const stringOpenNote = [4, 11, 7, 2, 9, 4][string];
                            const noteAtFret = (stringOpenNote + actualFret) % 12;
                            const rootNote = MusicTheory.getNoteIndex(chordName.replace(/m.*|7.*|maj.*/g, ''));

                            if (noteAtFret === rootNote) {
                                dot.classList.add('root');
                                dot.textContent = 'R';
                            } else {
                                dot.classList.add('note');
                                dot.textContent = voicing.fingers ? voicing.fingers[string] : '';
                            }
                            cell.appendChild(dot);
                        }

                        // Check if open string note on nut fret
                        if (fret === 0 && isOpenPosition && actualFret === 0) {
                            const dot = document.createElement('div');
                            dot.className = 'finger-dot';
                            const stringOpenNote = [4, 11, 7, 2, 9, 4][string];
                            const rootNote = MusicTheory.getNoteIndex(chordName.replace(/m.*|7.*|maj.*/g, ''));
                            if (stringOpenNote === rootNote) {
                                dot.classList.add('root');
                                dot.textContent = 'R';
                            } else {
                                dot.classList.add('note');
                                dot.textContent = 'O';
                            }
                            cell.appendChild(dot);
                        }

                        row.appendChild(cell);
                    }

                    grid.appendChild(row);
                }

                // Barre indication (horizontal)
                if (voicing.barreInfo && position > 0) {
                    const barre = document.createElement('div');
                    barre.className = 'barre-line';
                    const barreCol = voicing.barreInfo.fret;
                    const fromString = voicing.barreInfo.fromString;
                    const toString = voicing.barreInfo.toString;
                    const topString = Math.min(fromString, toString);
                    const bottomString = Math.max(fromString, toString);
                    barre.style.top = `${topString * 32 + 4}px`;
                    barre.style.height = `${(bottomString - topString) * 32 + 24}px`;
                    barre.style.left = `${barreCol * 50 + 25}px`;
                    grid.appendChild(barre);
                }

                container.appendChild(grid);

                // Fret numbers
                const fretNumbers = document.createElement('div');
                fretNumbers.className = 'fret-numbers';
                for (let fret = 0; fret < numFrets; fret++) {
                    const numDiv = document.createElement('div');
                    numDiv.className = 'fret-num';
                    numDiv.textContent = fret + displayStartFret;
                    fretNumbers.appendChild(numDiv);
                }
                container.appendChild(fretNumbers);

                return container;
            },

            // Create multiple diagrams for a progression
            createProgression(chords, currentIndex = 0) {
                const container = document.createElement('div');
                container.className = 'diagrams-container';
                container.style.flexDirection = 'column';
                container.style.gap = '20px';

                chords.forEach((chord, i) => {
                    const wrapper = document.createElement('div');
                    wrapper.style.opacity = i === currentIndex ? '1' : '0.4';
                    wrapper.style.transform = i === currentIndex ? 'scale(1)' : 'scale(0.95)';
                    wrapper.style.transition = 'all 0.3s ease';

                    const diagram = this.create(chord.voicing, chord.name, chord.position);
                    wrapper.appendChild(diagram);
                    container.appendChild(wrapper);
                });

                return container;
            }
        };

        // ========================================
        // FRETBOARD COMPONENT
        // ========================================
        const Fretboard = {
            // Standard tuning (high to low E)
            tuning: [4, 11, 7, 2, 9, 4], // E B G D A E (as semitones from C)
            frets: 13, // 0-12

            // State
            highlightedNotes: new Set(),
            tonicNote: null,
            showNoteNames: true,
            showFunctions: false,
            currentScale: [],
            blueNoteIndex: null, // For blues scale special highlight
            zoneStart: null, // Fret zone start
            zoneEnd: null, // Fret zone end
            specificPositions: null, // Array of {string, fret} for specific note display
            chordHighlight: null, // Set of note indices to highlight as chord tones

            // Initialize fretboard
            init() {
                this.render();
                this.bindEvents();
            },

            // Render fretboard HTML
            render() {
                const fretboard = document.getElementById('fretboard');
                fretboard.innerHTML = '';

                this.tuning.forEach((openNote, stringIndex) => {
                    const stringDiv = document.createElement('div');
                    stringDiv.className = 'string';

                    for (let fret = 0; fret < this.frets; fret++) {
                        const noteIndex = (openNote + fret) % 12;
                        const noteName = MusicTheory.getNoteName(noteIndex);

                        const fretDiv = document.createElement('div');
                        fretDiv.className = 'fret';
                        fretDiv.dataset.string = stringIndex;
                        fretDiv.dataset.fret = fret;
                        fretDiv.dataset.note = noteIndex;

                        const bubble = document.createElement('div');
                        bubble.className = 'note-bubble';
                        bubble.dataset.noteIndex = noteIndex;
                        bubble.textContent = noteName;

                        fretDiv.appendChild(bubble);
                        stringDiv.appendChild(fretDiv);
                    }

                    fretboard.appendChild(stringDiv);
                });
            },

            // Update displayed notes
            updateDisplay() {
                const bubbles = document.querySelectorAll('.note-bubble');
                const frets = document.querySelectorAll('.fret');

                // Reset fret zone highlighting
                frets.forEach(fret => {
                    fret.classList.remove('in-zone', 'zone-start', 'zone-end');
                    const fretNum = parseInt(fret.dataset.fret);
                    if (this.zoneStart !== null && this.zoneEnd !== null) {
                        if (fretNum >= this.zoneStart && fretNum <= this.zoneEnd) {
                            fret.classList.add('in-zone');
                            if (fretNum === this.zoneStart) fret.classList.add('zone-start');
                            if (fretNum === this.zoneEnd) fret.classList.add('zone-end');
                        }
                    }
                });

                bubbles.forEach((bubble) => {
                    const noteIndex = parseInt(bubble.dataset.noteIndex);
                    const noteName = MusicTheory.getNoteName(noteIndex);
                    const fretEl = bubble.closest('.fret');
                    const stringIndex = parseInt(fretEl.dataset.string);
                    const fretNum = parseInt(fretEl.dataset.fret);

                    // Reset classes
                    bubble.classList.remove('visible', 'tonic', 'interval', 'other', 'pulse', 'blue-note', 'dimmed', 'chord-highlight');

                    // Check if we're using specific positions mode
                    if (this.specificPositions) {
                        const isInPosition = this.specificPositions.some(
                            p => p.string === stringIndex && p.fret === fretNum
                        );

                        if (isInPosition) {
                            bubble.classList.add('visible');
                            const scaleNoteForPosition = this.currentScale.find(n =>
                                MusicTheory.getNoteIndex(n.note) === noteIndex
                            );
                            if (noteIndex === this.tonicNote) {
                                bubble.classList.add('tonic', 'pulse');
                            } else {
                                bubble.classList.add('interval');
                            }
                            if (this.showFunctions && scaleNoteForPosition) {
                                bubble.textContent = scaleNoteForPosition.degree ? scaleNoteForPosition.degree.toString() : (scaleNoteForPosition.intervalName || noteName);
                            } else if (this.showNoteNames) {
                                bubble.textContent = noteName;
                            } else {
                                bubble.textContent = '';
                            }
                        }
                        return;
                    }

                    // Check if note should be highlighted
                    const scaleNote = this.currentScale.find(n =>
                        MusicTheory.getNoteIndex(n.note) === noteIndex
                    );

                    if (scaleNote || this.highlightedNotes.has(noteIndex)) {
                        bubble.classList.add('visible');

                        // Check if outside zone (dim it)
                        const inZone = this.zoneStart === null ||
                            (fretNum >= this.zoneStart && fretNum <= this.zoneEnd);

                        if (!inZone) {
                            bubble.classList.add('dimmed');
                        }

                        if (noteIndex === this.tonicNote) {
                            bubble.classList.add('tonic');
                            if (inZone) bubble.classList.add('pulse');
                        } else if (this.blueNoteIndex !== null && noteIndex === this.blueNoteIndex) {
                            bubble.classList.add('blue-note');
                        } else if (scaleNote) {
                            bubble.classList.add('interval');
                        } else {
                            bubble.classList.add('other');
                        }

                        // Highlight chord tones
                        if (this.chordHighlight && this.chordHighlight.has(noteIndex)) {
                            bubble.classList.add('chord-highlight');
                        }

                        // Set display text
                        if (this.showFunctions && scaleNote) {
                            // Show degree number (1-7) for scale notes
                            bubble.textContent = scaleNote.degree ? scaleNote.degree.toString() : (scaleNote.intervalName || noteName);
                        } else if (this.showNoteNames) {
                            bubble.textContent = noteName;
                        } else {
                            bubble.textContent = '';
                        }
                    }
                });

                // Add staggered animation
                const visibleBubbles = document.querySelectorAll('.note-bubble.visible:not(.dimmed)');
                visibleBubbles.forEach((bubble, i) => {
                    bubble.style.transitionDelay = `${i * 15}ms`;
                });
            },

            // Set zone for limited display
            setZone(start, end) {
                this.zoneStart = start;
                this.zoneEnd = end;
            },

            // Clear zone
            clearZone() {
                this.zoneStart = null;
                this.zoneEnd = null;
                this.specificPositions = null;
            },

            // Show specific positions only
            showPositions(positions) {
                this.specificPositions = positions;
                this.updateDisplay();
            },

            // Show scale on fretboard
            showScale(root, scaleType) {
                this.tonicNote = typeof root === 'number' ? root : MusicTheory.getNoteIndex(root);
                this.currentScale = MusicTheory.getScale(root, scaleType);
                this.highlightedNotes.clear();
                this.blueNoteIndex = null;
                this.chordHighlight = null; // Clear chord highlight
                this.clearZone(); // Reset zone
                this.updateDisplay();
            },

            // Show specific interval from root
            showInterval(root, semitones) {
                this.tonicNote = typeof root === 'number' ? root : MusicTheory.getNoteIndex(root);
                const targetNote = (this.tonicNote + semitones) % 12;
                const intervalName = MusicTheory.intervalNames[semitones] || semitones.toString();

                this.currentScale = [
                    { note: MusicTheory.getNoteName(this.tonicNote), degree: 1, intervalName: '1' },
                    { note: MusicTheory.getNoteName(targetNote), degree: 2, intervalName: intervalName }
                ];
                this.highlightedNotes.clear();
                this.updateDisplay();
            },

            // Show triad on fretboard
            showTriad(root, scaleType, degree) {
                const triad = MusicTheory.getTriad(root, scaleType, degree);
                this.tonicNote = MusicTheory.getNoteIndex(triad.root.note);

                this.currentScale = [
                    { note: triad.root.note, degree: 1 },
                    { note: triad.third.note, degree: 3 },
                    { note: triad.fifth.note, degree: 5 }
                ];
                this.highlightedNotes.clear();
                this.updateDisplay();

                return triad;
            },

            // Clear fretboard
            clear() {
                this.highlightedNotes.clear();
                this.currentScale = [];
                this.tonicNote = null;
                this.chordHighlight = null;
                this.updateDisplay();
            },

            // Bind events (toggles are handled by App.bindEvents)
            bindEvents() {
                // Click on note bubbles to play sound
                document.getElementById('fretboard').addEventListener('click', (e) => {
                    const bubble = e.target.closest('.note-bubble');
                    if (bubble && bubble.classList.contains('visible')) {
                        const fretEl = bubble.closest('.fret');
                        const stringIndex = parseInt(fretEl.dataset.string);
                        const fretNum = parseInt(fretEl.dataset.fret);

                        // Afinacin estndar en notas MIDI:
                        // String 0 (ms aguda) = E4 = MIDI 64
                        // String 1 = B3 = MIDI 59
                        // String 2 = G3 = MIDI 55
                        // String 3 = D3 = MIDI 50
                        // String 4 = A2 = MIDI 45
                        // String 5 (ms grave) = E2 = MIDI 40
                        const openStringMidi = [64, 59, 55, 50, 45, 40];

                        // Calcular nota MIDI: nota abierta + trastes
                        const midiNote = openStringMidi[stringIndex] + fretNum;

                        // Reproducir sonido
                        AudioEngine.playMidiNote(midiNote, 0.8);

                        // Efecto visual
                        bubble.style.transform = 'scale(1.3)';
                        setTimeout(() => {
                            bubble.style.transform = '';
                        }, 200);
                    }
                });
            }
        };

        // ========================================
        // APP CONTROLLER
        // ========================================
        const App = {
            // ====== CONSTANTES CONSOLIDADAS ======
            CATEGORY_SCALES: {
                'major': ['major'],
                'minor': ['minor', 'harmonicMinor', 'melodicMinor'],
                'modes': ['dorian', 'phrygian', 'lydian', 'mixolydian', 'locrian'],
                'pentatonic': ['pentatonicMajor', 'pentatonicMinor', 'blues', 'bluesMajor', 'bluesHeptatonic'],
                'exotic': ['phrygianDom', 'hungarian', 'byzantine', 'japanese', 'wholeTone', 'diminished', 'ryuKyu', 'yo', 'bhairav', 'todi'],
                'harmonicMinorModes': ['locrianNat6', 'ionianAug', 'dorianSharp4', 'phrygianDom', 'lydianSharp2', 'superLocrian'],
                'melodicMinorModes': ['dorianB2', 'lydianAug', 'lydianDom', 'mixolydianB6', 'locrianNat2', 'alteredScale'],
                'symmetric': ['wholeTone', 'diminished', 'diminishedHW', 'chromatic', 'messiaenMode2', 'messiaenMode3']
            },
            SCALE_NAMES: {
                'major': 'Mayor', 'minor': 'Menor Natural', 'harmonicMinor': 'Menor Armnica',
                'melodicMinor': 'Menor Meldica', 'dorianMinor': 'Menor Drica',
                'dorian': 'Drico', 'phrygian': 'Frigio', 'lydian': 'Lidio',
                'mixolydian': 'Mixolidio', 'locrian': 'Locrio',
                'locrianNat6': 'Locrio 6', 'ionianAug': 'Jnico #5', 'dorianSharp4': 'Drico #4',
                'phrygianDom': 'Frigio Dominante', 'lydianSharp2': 'Lidio #2', 'superLocrian': 'Superlocrio',
                'dorianB2': 'Drico 2', 'lydianAug': 'Lidio #5', 'lydianDom': 'Lidio Dominante',
                'mixolydianB6': 'Mixolidio 6', 'locrianNat2': 'Locrio 2', 'alteredScale': 'Alterada',
                'pentatonicMajor': 'Pentatnica Mayor', 'pentatonicMinor': 'Pentatnica Menor',
                'blues': 'Blues', 'bluesMajor': 'Blues Mayor', 'bluesHeptatonic': 'Blues Heptatnica',
                'wholeTone': 'Tonos Enteros', 'diminished': 'Disminuida (T-S)',
                'diminishedHW': 'Disminuida (S-T)', 'chromatic': 'Cromtica',
                'hungarian': 'Hngara Menor', 'hungarianMajor': 'Hngara Mayor',
                'byzantine': 'Bizantina', 'arabic': 'rabe', 'japanese': 'Japonesa',
                'hirajoshi': 'Hirajoshi', 'egyptian': 'Egipcia', 'prometheus': 'Prometheus',
                'persian': 'Persa', 'enigmatic': 'Enigmtica', 'neapolitan': 'Napolitana',
                'bebop': 'Bebop Dominante', 'bebopMajor': 'Bebop Mayor',
                'ryuKyu': 'Ryu Kyu', 'yo': 'Yo Scale', 'bhairav': 'Bhairav', 'todi': 'Todi',
                'messiaenMode2': 'Messiaen Modo 2', 'messiaenMode3': 'Messiaen Modo 3'
            },

            // ====== ESTADO ======
            currentRoot: 0,
            currentScale: 'major',
            currentLevel: 1,
            currentInterval: 4,
            currentChord: null,
            currentMode: 1,
            currentPentatonic: 'minor',
            currentBox: 0,
            currentChord7: null,
            currentProgression: null,
            currentProgressionChordIndex: 0,
            // Metronome state
            metronomeRunning: false,
            metronomeBPM: 120,
            metronomeIntervalId: null,
            metronomeTimeSignature: '4/4',
            metronomeSubdivision: 'quarter',
            metronomeAccent: true,
            metronomeCurrentBeat: 0,
            metronomeTapTimes: [],
            // Progression playback state
            progressionPlaying: false,
            progressionPaused: false,
            progressionBPM: 120,
            progressionLoop: false,
            progressionRepeatCount: 1,
            progressionCurrentRepeat: 0,
            progressionIntervalId: null,
            // Global BPM sync
            globalBPM: 120,
            syncMetronomeWithBacking: true,
            // Jam Session visual progress
            jamCurrentBar: 0,
            jamLoopCount: 0,
            jamCurrentBeat: 0,
            jamBeatIntervalId: null,
            currentCAGED: 'C',
            cagedShowAll: false,
            currentScaleCategory: 'major',
            currentLabScale: 'major',
            currentLabCategory: 'major',
            currentLabHarmChord: null,
            compareScale: null,
            eventController: null,
            // Quiz state
            quizCategory: 'intervals',
            quizDifficulty: 'easy',
            quizScore: 0,
            quizStreak: 0,
            quizBest: 0,
            quizAnswered: false,
            // Extended chords state
            currentExtension: '9',
            currentExtQuality: 'maj',
            // Secondary dominants state
            currentSecondary: 'ii',
            currentSecProg: null,
            // Songs state
            songGenreFilter: 'all',
            currentSong: null,
            // Ear Training state
            earTrainingLevel: 'easy',
            earTrainingScore: 0,
            earTrainingStreak: 0,
            earTrainingBest: 0,
            earTrainingCurrentInterval: null,
            earTrainingAnswered: false,
            // Jam Session state
            currentBackingTrack: null,
            backingTrackPlaying: false,
            backingTrackIntervals: null,
            backingTrackBar: 0,
            customBPM: null,
            drumsEnabled: true,

            // ====== HELPERS ======
            resetState(except = []) {
                const defaults = {
                    currentInterval: null, currentChord: null, currentMode: null,
                    currentPentatonic: null, currentChord7: null, currentProgression: null, currentCAGED: null
                };
                Object.keys(defaults).forEach(key => {
                    if (!except.includes(key)) this[key] = defaults[key];
                });
            },

            hideUIElements() {
                document.getElementById('diagramsContainer').classList.add('hidden');
                document.getElementById('boxSelector').classList.add('hidden');
            },

            clearInfoPanel() {
                const panel = document.getElementById('infoPanel');
                if (panel) panel.innerHTML = '';
            },

            updateDisplay(title, subtitle) {
                document.getElementById('displayTitle').textContent = title;
                document.getElementById('displaySubtitle').textContent = subtitle;
            },

            init() {
                Fretboard.init();
                this.loadProgress();
                this.bindEvents();
                this.setupKeyboardNavigation();
                this.loadLevel(this.currentLevel || 1);
                this.showToast('GuitarMaster cargado correctamente', 'success');
            },

            setupKeyboardNavigation() {
                document.addEventListener('keydown', (e) => {
                    // Solo en nivel 7 (progresiones)
                    if (this.currentLevel !== 7) return;

                    const prog = MusicTheory.progressions[this.currentProgression];
                    if (!prog) return;

                    switch(e.key) {
                        case 'ArrowLeft':
                            e.preventDefault();
                            if (!this.progressionPlaying) {
                                this.currentProgressionChordIndex = Math.max(0, this.currentProgressionChordIndex - 1);
                                this.showProgression();
                            }
                            break;

                        case 'ArrowRight':
                            e.preventDefault();
                            if (!this.progressionPlaying) {
                                this.currentProgressionChordIndex = Math.min(prog.degrees.length - 1, this.currentProgressionChordIndex + 1);
                                this.showProgression();
                            }
                            break;

                        case 'Enter':
                            e.preventDefault();
                            if (!this.progressionPlaying) {
                                // Reproducir acorde actual
                                const degree = prog.degrees[this.currentProgressionChordIndex];
                                this.playProgressionChord(degree);
                            }
                            break;

                        case ' ':
                            e.preventDefault();
                            // Toggle reproduccin de progresin
                            if (this.progressionPlaying && !this.progressionPaused) {
                                this.pauseProgression();
                            } else if (this.progressionPaused) {
                                this.playProgression();
                            } else {
                                this.playProgression();
                            }
                            break;

                        case 'Escape':
                            e.preventDefault();
                            if (this.progressionPlaying || this.progressionPaused) {
                                this.stopProgression();
                            }
                            break;
                    }
                });
            },

            // === PERSISTENCIA ===
            saveProgress() {
                const progress = {
                    currentLevel: this.currentLevel,
                    currentRoot: this.currentRoot,
                    quizScore: this.quizScore,
                    quizBest: this.quizBest,
                    earTrainingScore: this.earTrainingScore,
                    earTrainingBest: this.earTrainingBest,
                    timestamp: Date.now()
                };
                try {
                    localStorage.setItem('guitarmaster_progress', JSON.stringify(progress));
                } catch (e) {
                    console.error('Error guardando progreso:', e);
                }
            },

            loadProgress() {
                try {
                    const saved = localStorage.getItem('guitarmaster_progress');
                    if (saved) {
                        const progress = JSON.parse(saved);
                        this.currentLevel = progress.currentLevel || 1;
                        this.currentRoot = progress.currentRoot || 0;
                        this.quizScore = progress.quizScore || 0;
                        this.quizBest = progress.quizBest || 0;
                        this.earTrainingScore = progress.earTrainingScore || 0;
                        this.earTrainingBest = progress.earTrainingBest || 0;
                    }
                } catch (e) {
                    console.error('Error cargando progreso:', e);
                }
            },

            // === TOAST NOTIFICATIONS ===
            showToast(message, type = 'info', duration = 3000) {
                const toast = document.createElement('div');
                toast.className = `toast toast-${type}`;

                const icons = {
                    success: '',
                    error: '',
                    info: '',
                    warning: ''
                };

                toast.innerHTML = `
                    <span class="toast-icon">${icons[type] || icons.info}</span>
                    <div class="toast-content">${message}</div>
                `;

                document.body.appendChild(toast);

                requestAnimationFrame(() => {
                    toast.classList.add('show');
                });

                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 300);
                }, duration);
            },

            // === LOADING OVERLAY ===
            showLoading(text = 'Cargando...') {
                let overlay = document.getElementById('loading-overlay');
                if (!overlay) {
                    overlay = document.createElement('div');
                    overlay.id = 'loading-overlay';
                    overlay.className = 'loading-overlay';
                    overlay.innerHTML = `
                        <div class="loading-content">
                            <div class="loading-spinner"></div>
                            <div class="loading-text">${text}</div>
                        </div>
                    `;
                    document.body.appendChild(overlay);
                }
                requestAnimationFrame(() => {
                    overlay.classList.add('show');
                });
            },

            hideLoading() {
                const overlay = document.getElementById('loading-overlay');
                if (overlay) {
                    overlay.classList.remove('show');
                }
            },

            // === METRONOME ===
            toggleMetronome() {
                if (this.metronomeRunning) {
                    this.stopMetronome();
                } else {
                    this.startMetronome();
                }
            },

            startMetronome() {
                if (this.metronomeRunning) return;

                this.metronomeRunning = true;
                this.metronomeCurrentBeat = 0;

                // Parsear comps
                const [beats, noteValue] = this.metronomeTimeSignature.split('/').map(Number);

                // Calcular intervalo base
                let baseInterval = (60 / this.metronomeBPM) * 1000;

                // Ajustar por subdivisin
                let subdivisionMultiplier = 1;
                if (this.metronomeSubdivision === 'eighth') subdivisionMultiplier = 2;
                else if (this.metronomeSubdivision === 'sixteenth') subdivisionMultiplier = 4;
                else if (this.metronomeSubdivision === 'triplet') subdivisionMultiplier = 3;

                const interval = baseInterval / subdivisionMultiplier;

                const playClick = () => {
                    if (!this.metronomeRunning) return;

                    // Determinar si es acento (primer tiempo)
                    const isAccent = this.metronomeAccent && (this.metronomeCurrentBeat % (beats * subdivisionMultiplier) === 0);

                    // Reproducir sonido de click
                    const freq = isAccent ? 84 : 76; // Nota ms alta para acento
                    const volume = isAccent ? 0.8 : 0.5;
                    AudioEngine.playMidiNote(freq, volume, 'sine', 0.05);

                    // Actualizar indicador visual
                    this.updateMetronomeVisual(beats, subdivisionMultiplier);

                    this.metronomeCurrentBeat++;
                    this.metronomeIntervalId = setTimeout(playClick, interval);
                };

                playClick();

                // Actualizar UI
                const btn = document.getElementById('metronomeBtn');
                if (btn) {
                    btn.classList.add('active');
                    btn.style.borderColor = '#dc2626';
                    btn.style.color = '#dc2626';
                }

                this.showToast(`Metrnomo: ${this.metronomeBPM} BPM - ${this.metronomeTimeSignature}`, 'success', 2000);
            },

            updateMetronomeVisual(beats, subdivisionMultiplier) {
                const indicator = document.getElementById('metronomeBeatIndicator');
                if (!indicator) return;

                const currentBeat = Math.floor((this.metronomeCurrentBeat % (beats * subdivisionMultiplier)) / subdivisionMultiplier) + 1;
                indicator.textContent = `${currentBeat}/${beats}`;

                // Parpadeo visual
                indicator.style.color = (this.metronomeCurrentBeat % (beats * subdivisionMultiplier) === 0) ? '#dc2626' : '#10b981';
            },

            tapTempo() {
                const now = Date.now();
                this.metronomeTapTimes.push(now);

                // Mantener solo ltimos 4 taps
                if (this.metronomeTapTimes.length > 4) {
                    this.metronomeTapTimes.shift();
                }

                // Calcular BPM si hay al menos 2 taps
                if (this.metronomeTapTimes.length >= 2) {
                    const intervals = [];
                    for (let i = 1; i < this.metronomeTapTimes.length; i++) {
                        intervals.push(this.metronomeTapTimes[i] - this.metronomeTapTimes[i - 1]);
                    }
                    const avgInterval = intervals.reduce((a, b) => a + b) / intervals.length;
                    const bpm = Math.round(60000 / avgInterval);

                    // Limitar rango
                    this.metronomeBPM = Math.max(40, Math.min(240, bpm));

                    // Actualizar display
                    const display = document.getElementById('bpmDisplay');
                    if (display) display.textContent = this.metronomeBPM;

                    this.showToast(`Tap Tempo: ${this.metronomeBPM} BPM`, 'info', 1500);

                    // Reiniciar metrnomo si est corriendo
                    if (this.metronomeRunning) {
                        this.stopMetronome();
                        setTimeout(() => this.startMetronome(), 100);
                    }
                }

                // Resetear taps despus de 2 segundos de inactividad
                setTimeout(() => {
                    if (Date.now() - this.metronomeTapTimes[this.metronomeTapTimes.length - 1] > 2000) {
                        this.metronomeTapTimes = [];
                    }
                }, 2000);
            },

            stopMetronome() {
                this.metronomeRunning = false;
                if (this.metronomeIntervalId) {
                    clearTimeout(this.metronomeIntervalId);
                    this.metronomeIntervalId = null;
                }

                // Actualizar UI
                const btn = document.getElementById('metronomeBtn');
                if (btn) {
                    btn.classList.remove('active');
                    btn.style.borderColor = '';
                    btn.style.color = '';
                }
            },

            showMetronomeSettings() {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black/80 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-void-800 border-2 border-void-600 rounded-lg p-6 max-w-md w-full mx-4">
                        <h3 class="text-xl font-display text-accent-400 mb-4">Configuracin del Metrnomo</h3>

                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm text-void-300 mb-2">Comps</label>
                                <select id="timeSignatureSelect" class="w-full bg-void-900 border border-void-600 rounded px-3 py-2 text-white">
                                    <option value="2/4">2/4</option>
                                    <option value="3/4">3/4</option>
                                    <option value="4/4" selected>4/4</option>
                                    <option value="5/4">5/4</option>
                                    <option value="6/8">6/8</option>
                                    <option value="7/8">7/8</option>
                                    <option value="9/8">9/8</option>
                                    <option value="11/8">11/8</option>
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm text-void-300 mb-2">Subdivisin</label>
                                <select id="subdivisionSelect" class="w-full bg-void-900 border border-void-600 rounded px-3 py-2 text-white">
                                    <option value="quarter" selected>Cuartos ()</option>
                                    <option value="eighth">Octavos ()</option>
                                    <option value="sixteenth">Dieciseisavos ()</option>
                                    <option value="triplet">Tresillos ()</option>
                                </select>
                            </div>

                            <div class="flex items-center gap-3">
                                <span class="text-sm text-void-300">Acentuar primer tiempo</span>
                                <div class="toggle-switch ${this.metronomeAccent ? 'active' : ''}" id="accentToggle"></div>
                            </div>

                            <div>
                                <label class="block text-sm text-void-300 mb-2">Presets de Tempo</label>
                                <div class="grid grid-cols-2 gap-2">
                                    <button class="btn-secondary !text-xs" data-bpm="70">Adagio (60-80)</button>
                                    <button class="btn-secondary !text-xs" data-bpm="90">Andante (80-100)</button>
                                    <button class="btn-secondary !text-xs" data-bpm="110">Moderato (100-120)</button>
                                    <button class="btn-secondary !text-xs" data-bpm="130">Allegro (120-140)</button>
                                    <button class="btn-secondary !text-xs" data-bpm="170">Presto (140-200)</button>
                                </div>
                            </div>
                        </div>

                        <div class="flex gap-3 mt-6">
                            <button class="btn-primary flex-1" id="applyMetronomeSettings">Aplicar</button>
                            <button class="btn-secondary flex-1" id="cancelMetronomeSettings">Cancelar</button>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);

                // Set current values
                document.getElementById('timeSignatureSelect').value = this.metronomeTimeSignature;
                document.getElementById('subdivisionSelect').value = this.metronomeSubdivision;

                // Event listeners
                document.getElementById('applyMetronomeSettings').addEventListener('click', () => {
                    this.metronomeTimeSignature = document.getElementById('timeSignatureSelect').value;
                    this.metronomeSubdivision = document.getElementById('subdivisionSelect').value;

                    // Restart metronome if running
                    if (this.metronomeRunning) {
                        this.stopMetronome();
                        setTimeout(() => this.startMetronome(), 100);
                    }

                    document.body.removeChild(modal);
                    this.showToast('Configuracin guardada', 'success', 2000);
                });

                document.getElementById('cancelMetronomeSettings').addEventListener('click', () => {
                    document.body.removeChild(modal);
                });

                // Accent toggle
                document.getElementById('accentToggle').addEventListener('click', () => {
                    this.metronomeAccent = !this.metronomeAccent;
                    document.getElementById('accentToggle').classList.toggle('active');
                });

                // BPM presets
                modal.querySelectorAll('[data-bpm]').forEach(btn => {
                    btn.addEventListener('click', () => {
                        this.metronomeBPM = parseInt(btn.dataset.bpm);
                        const bpmDisplay = document.getElementById('bpmDisplay');
                        if (bpmDisplay) bpmDisplay.textContent = this.metronomeBPM;
                    });
                });

                // Close on backdrop click
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        document.body.removeChild(modal);
                    }
                });
            },

            adjustMetronomeBPM(delta) {
                this.metronomeBPM = Math.max(40, Math.min(240, this.metronomeBPM + delta));
                const bpmDisplay = document.getElementById('bpmDisplay');
                if (bpmDisplay) {
                    bpmDisplay.textContent = this.metronomeBPM;
                }

                // Reiniciar si est corriendo
                if (this.metronomeRunning) {
                    this.stopMetronome();
                    this.startMetronome();
                }
            },

            // Funcin para anunciar mensajes a lectores de pantalla
            announce(message) {
                const announcer = document.getElementById('sr-announcements');
                if (announcer) {
                    announcer.textContent = message;
                    setTimeout(() => {
                        announcer.textContent = '';
                    }, 1000);
                }
            },

            bindEvents() {
                // Root select
                document.getElementById('rootSelect').addEventListener('change', (e) => {
                    this.currentRoot = parseInt(e.target.value);
                    this.refreshCurrentLevel();
                });

                // Toggle switches
                const notesToggle = document.getElementById('showNotesToggle');
                const functionsToggle = document.getElementById('showFunctionsToggle');

                // Toggle con soporte de teclado y ARIA
                const handleToggle = (toggle, updateFn) => {
                    const handler = (e) => {
                        if (e.type === 'keydown' && e.key !== 'Enter' && e.key !== ' ') return;
                        if (e.type === 'keydown') e.preventDefault();

                        toggle.classList.toggle('active');
                        const isActive = toggle.classList.contains('active');
                        toggle.setAttribute('aria-checked', isActive.toString());
                        updateFn(isActive);
                    };
                    toggle.addEventListener('click', handler);
                    toggle.addEventListener('keydown', handler);
                };

                handleToggle(notesToggle, (isActive) => {
                    Fretboard.showNoteNames = isActive;
                    Fretboard.updateDisplay();
                });

                handleToggle(functionsToggle, (isActive) => {
                    Fretboard.showFunctions = isActive;
                    Fretboard.updateDisplay();
                });

                // Metronome button
                const metronomeBtn = document.getElementById('metronomeBtn');
                if (metronomeBtn) {
                    metronomeBtn.addEventListener('click', () => {
                        this.toggleMetronome();
                    });

                    // Ajustar BPM con scroll en el botn
                    metronomeBtn.addEventListener('wheel', (e) => {
                        e.preventDefault();
                        const delta = e.deltaY > 0 ? -5 : 5;
                        this.adjustMetronomeBPM(delta);
                    });
                }

                // Tap Tempo button
                const tapTempoBtn = document.getElementById('tapTempoBtn');
                if (tapTempoBtn) {
                    tapTempoBtn.addEventListener('click', () => {
                        this.tapTempo();
                    });
                }

                // Metronome settings modal
                const metronomeSettingsBtn = document.getElementById('metronomeSettingsBtn');
                if (metronomeSettingsBtn) {
                    metronomeSettingsBtn.addEventListener('click', () => {
                        this.showMetronomeSettings();
                    });
                }

                // Level navigation buttons
                document.querySelectorAll('.level-nav-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const level = parseInt(e.currentTarget.dataset.level);
                        this.loadLevel(level);
                    });
                });
            },

            loadLevel(level) {
                this.currentLevel = level;

                // Cleanup backing track si est corriendo
                if (this.backingTrackPlaying) {
                    this.stopBackingTrack();
                }

                // Cleanup event listeners anteriores
                if (this.eventController) {
                    this.eventController.abort();
                }
                this.eventController = new AbortController();

                // Update sidebar active state y ARIA
                document.querySelectorAll('.level-nav-btn').forEach(btn => {
                    const isActive = parseInt(btn.dataset.level) === level;
                    btn.classList.toggle('active', isActive);
                    if (isActive) {
                        btn.setAttribute('aria-current', 'page');
                    } else {
                        btn.removeAttribute('aria-current');
                    }
                });

                // Hide diagrams by default
                document.getElementById('diagramsContainer').classList.add('hidden');
                document.getElementById('boxSelector').classList.add('hidden');

                // Load appropriate template into control panel
                const controlPanel = document.getElementById('controlPanel');
                const templates = {
                    1: 'tpl-intervals',
                    2: 'tpl-scales',
                    3: 'tpl-chords',
                    4: 'tpl-modes',
                    5: 'tpl-pentatonics',
                    6: 'tpl-circle',
                    7: 'tpl-progressions',
                    8: 'tpl-seventh',
                    9: 'tpl-caged',
                    10: 'tpl-quiz',
                    11: 'tpl-extended',
                    12: 'tpl-secondary',
                    13: 'tpl-songs',
                    14: 'tpl-ear-training',
                    15: 'tpl-jam-session'
                };

                const tplId = templates[level];
                const tpl = document.getElementById(tplId);
                if (tpl) {
                    controlPanel.innerHTML = '';
                    controlPanel.appendChild(tpl.content.cloneNode(true));
                    this.bindLevelEvents(level);
                }

                this.refreshCurrentLevel();
                this.saveProgress();
            },

            bindLevelEvents(level) {
                const controlPanel = document.getElementById('controlPanel');

                switch(level) {
                    case 1: // Intervals
                        controlPanel.querySelectorAll('.interval-btn').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                controlPanel.querySelectorAll('.interval-btn').forEach(b => b.classList.remove('active'));
                                e.currentTarget.classList.add('active');
                                this.currentInterval = parseInt(e.currentTarget.dataset.interval);
                                this.showInterval();
                            });
                        });
                        // Set default active
                        controlPanel.querySelector(`[data-interval="${this.currentInterval}"]`)?.classList.add('active');
                        break;

                    case 2: // Scales
                        this.bindScaleEvents(controlPanel);
                        break;

                    case 3: // Chords
                        controlPanel.querySelectorAll('.chord-btn').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                controlPanel.querySelectorAll('.chord-btn').forEach(b => b.classList.remove('active'));
                                e.currentTarget.classList.add('active');
                                this.currentChord = parseInt(e.currentTarget.dataset.chord);
                                this.showChord();
                            });
                        });
                        break;

                    case 4: // Modes
                        controlPanel.querySelectorAll('.mode-btn-simple').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                controlPanel.querySelectorAll('.mode-btn-simple').forEach(b => b.classList.remove('active'));
                                e.currentTarget.classList.add('active');
                                this.currentMode = parseInt(e.currentTarget.dataset.mode);
                                this.showMode();
                            });
                        });
                        break;

                    case 5: // Pentatonics
                        controlPanel.querySelectorAll('[data-penta]').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                controlPanel.querySelectorAll('[data-penta]').forEach(b => b.classList.remove('active'));
                                e.currentTarget.classList.add('active');
                                this.currentPentatonic = e.currentTarget.dataset.penta;
                                this.showPentatonic();
                            });
                        });
                        controlPanel.querySelectorAll('[data-box]').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                controlPanel.querySelectorAll('[data-box]').forEach(b => b.classList.remove('active'));
                                e.currentTarget.classList.add('active');
                                this.currentBox = parseInt(e.currentTarget.dataset.box);
                                this.showPentatonic();
                            });
                        });
                        break;

                    case 6: // Circle of Fifths
                        this.renderCircleOfFifths();
                        break;

                    case 7: // Progressions
                        controlPanel.querySelectorAll('.progression-btn-simple').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                controlPanel.querySelectorAll('.progression-btn-simple').forEach(b => b.classList.remove('active'));
                                e.currentTarget.classList.add('active');
                                this.currentProgression = e.currentTarget.dataset.progression;
                                this.currentProgressionChordIndex = 0;
                                this.stopProgression(); // Detener reproduccin si est activa
                                this.showProgression();
                            });
                        });

                        // Event listeners para controles de reproduccin
                        document.getElementById('playProgressionBtn')?.addEventListener('click', () => {
                            this.playProgression();
                        });
                        document.getElementById('pauseProgressionBtn')?.addEventListener('click', () => {
                            this.pauseProgression();
                        });
                        document.getElementById('stopProgressionBtn')?.addEventListener('click', () => {
                            this.stopProgression();
                        });

                        // BPM slider
                        const bpmSlider = document.getElementById('progressionBPMSlider');
                        const bpmDisplay = document.getElementById('progressionBPMDisplay');
                        if (bpmSlider && bpmDisplay) {
                            bpmSlider.value = this.progressionBPM;
                            bpmDisplay.textContent = this.progressionBPM;
                            bpmSlider.addEventListener('input', (e) => {
                                this.progressionBPM = parseInt(e.target.value);
                                bpmDisplay.textContent = this.progressionBPM;
                            });
                        }

                        // Loop toggle
                        document.getElementById('progressionLoopToggle')?.addEventListener('change', (e) => {
                            this.progressionLoop = e.target.checked;
                        });

                        // Repeat count
                        document.getElementById('progressionRepeatInput')?.addEventListener('change', (e) => {
                            this.progressionRepeatCount = parseInt(e.target.value) || 1;
                        });

                        break;

                    case 8: // Seventh chords
                        controlPanel.querySelectorAll('[data-chord7]').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                controlPanel.querySelectorAll('[data-chord7]').forEach(b => b.classList.remove('active'));
                                e.currentTarget.classList.add('active');
                                this.currentChord7 = parseInt(e.currentTarget.dataset.chord7);
                                this.showSeventhChord();
                            });
                        });
                        break;

                    case 9: // CAGED
                        controlPanel.querySelectorAll('[data-caged]').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                controlPanel.querySelectorAll('[data-caged]').forEach(b => b.classList.remove('active'));
                                e.currentTarget.classList.add('active');
                                this.currentCAGED = e.currentTarget.dataset.caged;
                                this.showCAGEDShape();
                            });
                        });

                        // Toggle para mostrar todas las formas
                        const cagedToggle = document.getElementById('cagedShowAllToggle');
                        if (cagedToggle) {
                            const toggleDot = cagedToggle.querySelector('div');
                            cagedToggle.addEventListener('click', () => {
                                this.cagedShowAll = !this.cagedShowAll;
                                if (this.cagedShowAll) {
                                    cagedToggle.style.background = '#dc2626';
                                    toggleDot.style.left = '26px';
                                } else {
                                    cagedToggle.style.background = '#333';
                                    toggleDot.style.left = '2px';
                                }
                                this.showCAGEDShape();
                            });
                        }
                        break;

                    case 10: // Quiz
                        controlPanel.querySelectorAll('.quiz-cat-btn').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                controlPanel.querySelectorAll('.quiz-cat-btn').forEach(b => b.classList.remove('active'));
                                e.currentTarget.classList.add('active');
                                this.quizCategory = e.currentTarget.dataset.category;
                                this.generateQuizQuestion();
                            });
                        });
                        controlPanel.querySelectorAll('[data-diff]').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                controlPanel.querySelectorAll('[data-diff]').forEach(b => b.classList.remove('active'));
                                e.currentTarget.classList.add('active');
                                this.quizDifficulty = e.currentTarget.dataset.diff;
                                this.generateQuizQuestion();
                            });
                        });
                        document.getElementById('newQuizBtn')?.addEventListener('click', () => {
                            this.generateQuizQuestion();
                        });
                        break;

                    case 11: // Extended Chords
                        controlPanel.querySelectorAll('.ext-matrix-btn').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                controlPanel.querySelectorAll('.ext-matrix-btn').forEach(b => b.classList.remove('active'));
                                e.currentTarget.classList.add('active');
                                this.currentExtension = e.currentTarget.dataset.ext;
                                this.currentExtQuality = e.currentTarget.dataset.quality;
                                this.showExtendedChord();
                            });
                        });
                        break;

                    case 12: // Secondary Dominants
                        controlPanel.querySelectorAll('[data-secondary]').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                controlPanel.querySelectorAll('[data-secondary]').forEach(b => b.classList.remove('active'));
                                e.currentTarget.classList.add('active');
                                this.currentSecondary = e.currentTarget.dataset.secondary;
                                this.currentSecProg = null;
                                controlPanel.querySelectorAll('[data-secprog]').forEach(b => b.classList.remove('active'));
                                this.showSecondaryDominant();
                            });
                        });
                        controlPanel.querySelectorAll('[data-secprog]').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                controlPanel.querySelectorAll('[data-secprog]').forEach(b => b.classList.remove('active'));
                                e.currentTarget.classList.add('active');
                                this.currentSecProg = parseInt(e.currentTarget.dataset.secprog);
                                this.currentSecondary = null;
                                controlPanel.querySelectorAll('[data-secondary]').forEach(b => b.classList.remove('active'));
                                this.showSecondaryProgression();
                            });
                        });
                        break;

                    case 13: // Songs
                        controlPanel.querySelectorAll('[data-genre]').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                controlPanel.querySelectorAll('[data-genre]').forEach(b => b.classList.remove('active'));
                                e.currentTarget.classList.add('active');
                                this.songGenreFilter = e.currentTarget.dataset.genre;
                                this.renderSongList();
                            });
                        });
                        break;

                    case 14: // Ear Training
                        controlPanel.querySelectorAll('[data-ear-level]').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                controlPanel.querySelectorAll('[data-ear-level]').forEach(b => b.classList.remove('active'));
                                e.currentTarget.classList.add('active');
                                this.earTrainingLevel = e.currentTarget.dataset.earLevel;
                                this.showEarTraining();
                            });
                        });
                        document.getElementById('playIntervalBtn')?.addEventListener('click', () => {
                            this.playCurrentInterval();
                        });
                        document.getElementById('newIntervalBtn')?.addEventListener('click', () => {
                            this.showEarTraining();
                        });
                        break;

                    case 15: // Jam Session
                        controlPanel.querySelectorAll('[data-track]').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                controlPanel.querySelectorAll('[data-track]').forEach(b => b.classList.remove('active'));
                                e.currentTarget.classList.add('active');
                                const trackId = e.currentTarget.dataset.track;
                                this.currentBackingTrack = MusicTheory.backingTracks.find(t => t.id === trackId);

                                // Resetear BPM custom al cambiar track
                                this.customBPM = null;
                                const bpmSlider = document.getElementById('bpmSlider');
                                const bpmDisplay = document.getElementById('bpmDisplay');
                                if (bpmSlider && this.currentBackingTrack) {
                                    const bpm = this.syncMetronomeWithBacking ? this.globalBPM : this.currentBackingTrack.bpm;
                                    bpmSlider.value = bpm;
                                    if (bpmDisplay) bpmDisplay.textContent = bpm;
                                }

                                this.showJamSession();
                            });
                        });

                        // Selector de tonalidad
                        const keySelector = document.getElementById('jamKeySelector');
                        if (keySelector) {
                            keySelector.value = this.currentRoot;
                            keySelector.addEventListener('change', (e) => {
                                this.currentRoot = parseInt(e.target.value);
                                this.showJamSession();

                                // Si est tocando, reiniciar con nueva tonalidad
                                if (this.backingTrackPlaying) {
                                    this.changeBackingTrackBPM(this.customBPM || this.currentBackingTrack.bpm);
                                }
                            });
                        }

                        document.getElementById('playTrackBtn')?.addEventListener('click', () => {
                            this.playBackingTrack();
                        });

                        document.getElementById('stopTrackBtn')?.addEventListener('click', () => {
                            this.stopBackingTrack();
                        });

                        // Toggle de sincronizacin BPM
                        const syncToggle = document.getElementById('syncBPMToggle');
                        if (syncToggle) {
                            const syncSlider = syncToggle.parentElement.querySelector('.slider-sync');
                            const syncDot = syncToggle.parentElement.querySelector('.dot-sync');

                            syncToggle.checked = this.syncMetronomeWithBacking;
                            if (this.syncMetronomeWithBacking) {
                                syncSlider.style.background = '#10b981';
                                syncDot.style.transform = 'translateX(24px)';
                            } else {
                                syncSlider.style.background = '#333';
                                syncDot.style.transform = 'translateX(0)';
                            }

                            syncToggle.addEventListener('change', (e) => {
                                this.syncMetronomeWithBacking = e.target.checked;
                                if (this.syncMetronomeWithBacking) {
                                    syncSlider.style.background = '#10b981';
                                    syncDot.style.transform = 'translateX(24px)';

                                    // Actualizar BPM al global
                                    const bpmSlider = document.getElementById('bpmSlider');
                                    const bpmDisplay = document.getElementById('bpmDisplay');
                                    if (bpmSlider) bpmSlider.value = this.globalBPM;
                                    if (bpmDisplay) bpmDisplay.textContent = this.globalBPM;
                                    this.customBPM = null;
                                } else {
                                    syncSlider.style.background = '#333';
                                    syncDot.style.transform = 'translateX(0)';
                                }
                            });
                        }

                        // BPM Slider con debounce
                        const bpmSlider = document.getElementById('bpmSlider');
                        const bpmDisplay = document.getElementById('bpmDisplay');
                        let bpmChangeTimeout = null;

                        if (bpmSlider && bpmDisplay) {
                            bpmSlider.addEventListener('input', (e) => {
                                const newBPM = parseInt(e.target.value);
                                bpmDisplay.textContent = newBPM;

                                // Actualizar BPM inmediatamente en UI
                                if (this.syncMetronomeWithBacking) {
                                    this.globalBPM = newBPM;
                                    this.metronomeBPM = newBPM;
                                } else {
                                    this.customBPM = newBPM;
                                }

                                // Debounce para aplicar cambio
                                if (bpmChangeTimeout) clearTimeout(bpmChangeTimeout);
                                bpmChangeTimeout = setTimeout(() => {
                                    if (this.backingTrackPlaying) {
                                        this.changeBackingTrackBPM(newBPM);
                                    }
                                }, 300);
                            });

                            // Inicializar BPM
                            if (this.currentBackingTrack) {
                                const bpm = this.syncMetronomeWithBacking ? this.globalBPM : this.currentBackingTrack.bpm;
                                bpmSlider.value = bpm;
                                bpmDisplay.textContent = bpm;
                            }
                        }

                        // Drums Toggle
                        const drumsToggle = document.getElementById('drumsToggle');
                        if (drumsToggle) {
                            const slider = drumsToggle.nextElementSibling;
                            const dot = slider?.querySelector('.dot');

                            drumsToggle.addEventListener('change', (e) => {
                                this.drumsEnabled = e.target.checked;

                                if (slider && dot) {
                                    if (this.drumsEnabled) {
                                        slider.style.background = '#dc2626';
                                        dot.style.transform = 'translateX(24px)';
                                    } else {
                                        slider.style.background = '#404040';
                                        dot.style.transform = 'translateX(0)';
                                    }
                                }

                                // Si est reproduciendo, reiniciar con/sin batera
                                if (this.backingTrackPlaying) {
                                    this.stopBackingTrack();
                                    setTimeout(() => this.playBackingTrack(), 100);
                                }
                            });
                        }
                        break;
                }
            },

            bindScaleEvents(container) {
                // Category buttons
                container.querySelectorAll('.scale-cat-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        container.querySelectorAll('.scale-cat-btn').forEach(b => b.classList.remove('active'));
                        e.currentTarget.classList.add('active');
                        this.currentScaleCategory = e.currentTarget.dataset.category;
                        this.renderScaleButtons(container);
                    });
                });

                this.renderScaleButtons(container);
            },

            renderScaleButtons(container) {
                const scaleList = container.querySelector('#scaleListMain');
                if (!scaleList) return;

                const scales = this.CATEGORY_SCALES[this.currentScaleCategory] || [];
                scaleList.innerHTML = '';

                scales.forEach(scaleKey => {
                    const btn = document.createElement('button');
                    btn.className = `mode-btn-simple ${scaleKey === this.currentScale ? 'active' : ''}`;
                    btn.dataset.scale = scaleKey;
                    btn.textContent = this.SCALE_NAMES[scaleKey] || scaleKey;
                    btn.addEventListener('click', () => {
                        scaleList.querySelectorAll('.mode-btn-simple').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        this.currentScale = scaleKey;
                        this.showScale();
                    });
                    scaleList.appendChild(btn);
                });
            },

            refreshCurrentLevel() {
                switch(this.currentLevel) {
                    case 1: this.showIntervals(); break;
                    case 2: this.showScale(); break;
                    case 3: this.showHarmonization(); break;
                    case 4: this.showMode(); break;
                    case 5: this.showPentatonic(); break;
                    case 6: this.showCircleOfFifths(); break;
                    case 7: this.showProgressions(); break;
                    case 8: this.showSeventhChords(); break;
                    case 9: this.showCAGEDShape(); break;
                    case 10: this.showQuiz(); break;
                    case 11: this.showExtendedChord(); break;
                    case 12: this.showSecondaryDominant(); break;
                    case 13: this.showSongs(); break;
                    case 14: this.showEarTraining(); break;
                    case 15: this.showJamSession(); break;
                    default: this.showScale();
                }
            },

            showScale() {
                const rootName = MusicTheory.getNoteName(this.currentRoot);
                const info = MusicTheory.scaleInfo[this.currentScale];

                // Hide diagrams and box selector for regular scale view
                document.getElementById('diagramsContainer').classList.add('hidden');
                document.getElementById('boxSelector').classList.add('hidden');

                Fretboard.showScale(this.currentRoot, this.currentScale);

                const noteCount = MusicTheory.scales[this.currentScale].length;
                document.getElementById('displayTitle').textContent =
                    `Escala de ${rootName} ${this.SCALE_NAMES[this.currentScale] || this.currentScale}`;
                document.getElementById('displaySubtitle').textContent =
                    `${noteCount} notas - Frmula: ${MusicTheory.scales[this.currentScale].map(i => MusicTheory.intervalNames[i]).join(' - ')}`;

                // Show detailed scale info panel
                this.showScaleInfoPanel(info, this.currentScale);
            },

            showScaleInfoPanel(info, scaleKey) {
                const panel = document.getElementById('infoPanel');
                if (!panel) return;

                if (!info) {
                    panel.innerHTML = '';
                    return;
                }

                // Generate brightness bar (0-7 scale, Locrio=0, Lidio=7)
                const brightness = info.brightness !== undefined ? info.brightness : 4;
                const brightnessPercent = (brightness / 7) * 100;
                const brightnessLabels = ['Muy Oscuro', 'Oscuro', 'Semi-Oscuro', 'Neutral', 'Semi-Brillante', 'Brillante', 'Muy Brillante', 'Mximo Brillo'];
                const brightnessLabel = brightnessLabels[brightness] || 'Neutral';

                // Generate usage context tags
                const usageContextHTML = info.usageContext ?
                    info.usageContext.map(ctx => `<span class="context-tag">${ctx}</span>`).join('')
                    : '';

                // Generate characteristic note display
                const charNote = info.characteristicNote || '-';

                // Build the panel HTML with new styling
                panel.innerHTML = `
                    <div class="scale-info-box">
                        <!-- Header with emotion -->
                        <div class="info-header">
                            <div class="info-title">${info.name || scaleKey}</div>
                            <div class="info-emotion">"${info.emotion || ''}"</div>
                        </div>

                        <!-- Main info grid -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Left column -->
                            <div class="space-y-3">
                                <!-- Brightness meter -->
                                <div class="info-section">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="info-label" style="margin-bottom: 0;">Brillo Modal</span>
                                        <span class="info-value" style="font-size: 13px; color: #d4a574;">${brightness}/7 - ${brightnessLabel}</span>
                                    </div>
                                    <div class="brightness-bar">
                                        <div class="brightness-fill" style="width: ${brightnessPercent}%;"></div>
                                    </div>
                                    <div class="flex justify-between mt-2" style="font-size: 10px; color: #666;">
                                        <span>Locrio</span>
                                        <span>Lidio</span>
                                    </div>
                                </div>

                                <!-- Characteristic Note -->
                                <div class="info-section accent">
                                    <div class="info-label">Nota Caracterstica</div>
                                    <div class="info-value highlight" style="font-size: 22px;">${charNote}</div>
                                    <div class="info-description">El intervalo que define su sonido nico</div>
                                </div>

                                <!-- Formula -->
                                <div class="info-section">
                                    <div class="info-label">Frmula Intervlica</div>
                                    <div class="info-value" style="font-size: 14px; letter-spacing: 2px;">${info.formula || '-'}</div>
                                </div>
                            </div>

                            <!-- Right column -->
                            <div class="space-y-3">
                                <!-- Usage -->
                                <div class="info-section">
                                    <div class="info-label">Uso Prctico</div>
                                    <p style="font-family: 'Barlow Condensed', sans-serif; font-size: 14px; color: #ccc; line-height: 1.6;">${info.usage || ''}</p>
                                </div>

                                <!-- Usage Context Tags -->
                                <div class="info-section">
                                    <div class="info-label">Estilos y Contextos</div>
                                    <div class="flex flex-wrap" style="margin-top: 8px;">${usageContextHTML || '<span style="color: #666; font-size: 13px;">-</span>'}</div>
                                </div>

                                ${info.parentScale ? `
                                <!-- Parent Scale Info -->
                                <div class="parent-scale-box">
                                    <div class="info-label" style="color: #dc2626;">Escala Madre</div>
                                    <p style="font-family: 'Barlow Condensed', sans-serif; font-size: 14px; color: #ccc;">
                                        Deriva del grado <span style="font-weight: 700; color: #dc2626;">${info.degree || '?'}</span>
                                        de la escala <span style="font-weight: 700; color: #dc2626;">${MusicTheory.scaleInfo[info.parentScale]?.name || info.parentScale}</span>
                                    </p>
                                </div>
                                ` : ''}
                            </div>
                        </div>

                        <!-- Chord construction explanation -->
                        ${info.chordTypes ? `
                        <div style="border-top: 1px solid #333; padding-top: 16px; margin-top: 16px;">
                            <div class="info-label">Armonizacin - Cmo nacen los acordes</div>
                            <p style="font-family: 'Barlow Condensed', sans-serif; font-size: 12px; color: #666; margin: 8px 0 12px 0;">Cada grado de la escala genera un acorde al apilar terceras. El tipo depende de los intervalos disponibles.</p>
                            <div class="flex flex-wrap gap-2" id="harmonizationChords">
                                ${info.chordTypes.map((type, i) => {
                                    const romanNumerals = ['I', 'ii', 'iii', 'IV', 'V', 'vi', 'vii'];
                                    const typeName = type === 'maj' ? 'Mayor' : type === 'min' ? 'menor' : type === 'dim' ? 'dim' : type === 'aug' ? 'aug' : type;
                                    return `<button class="harm-chord-btn type-${type}" data-degree="${i + 1}" data-quality="${type}">
                                        <div style="font-size: 15px; font-weight: 700;">${romanNumerals[i] || (i+1)}</div>
                                        <div class="chord-quality">${typeName}</div>
                                    </button>`;
                                }).join('')}
                            </div>
                        </div>
                        ` : ''}
                    </div>
                `;

                // Bind chord click events
                setTimeout(() => {
                    const container = document.getElementById('harmonizationChords');
                    if (container) {
                        container.querySelectorAll('[data-degree]').forEach(btn => {
                            btn.addEventListener('click', () => {
                                const degree = parseInt(btn.dataset.degree);
                                this.showHarmonizationChord(scaleKey, degree);
                            });
                        });
                    }
                }, 0);
            },

            showHarmonizationChord(scaleKey, degree) {
                const harmonization = MusicTheory.getScaleHarmonization(this.currentRoot, scaleKey);
                if (!harmonization || !harmonization[degree - 1]) return;

                const chord = harmonization[degree - 1];
                const chordRootIndex = MusicTheory.getNoteIndex(chord.root);
                const qualityNames = { maj: 'Mayor', min: 'menor', dim: 'disminuido', aug: 'aumentado' };

                // Keep the scale visible, just highlight chord tones
                Fretboard.showScale(this.currentRoot, scaleKey);

                // Set chord highlight for the chord tones
                Fretboard.chordHighlight = new Set([
                    MusicTheory.getNoteIndex(chord.root),
                    MusicTheory.getNoteIndex(chord.third),
                    MusicTheory.getNoteIndex(chord.fifth)
                ]);
                Fretboard.updateDisplay();

                // Show chord diagram if available
                const voicingKey = chord.quality === 'min' ? chord.root + 'm' : chord.root;
                let voicing = MusicTheory.chordVoicings[voicingKey];
                let position = 0;

                if (!voicing && (chord.quality === 'maj' || chord.quality === 'min')) {
                    const shape = chord.quality === 'min' ? 'E_shape_minor' : 'E_shape_major';
                    voicing = MusicTheory.chordVoicings[shape];
                    position = (chordRootIndex - 4 + 12) % 12;
                }

                const diagramContainer = document.getElementById('diagramsContainer');
                if (diagramContainer && voicing) {
                    diagramContainer.innerHTML = '';
                    diagramContainer.classList.remove('hidden');
                    const chordSuffix = chord.quality === 'min' ? 'm' : chord.quality === 'dim' ? '' : chord.quality === 'aug' ? '+' : '';
                    const chordName = chord.root + chordSuffix;
                    const diagram = ChordDiagram.create(voicing, chordName, position);
                    diagramContainer.appendChild(diagram);
                } else if (diagramContainer) {
                    diagramContainer.classList.add('hidden');
                }

                const rootName = MusicTheory.getNoteName(this.currentRoot);
                const info = MusicTheory.scaleInfo[scaleKey];
                const chordSuffix = chord.quality === 'min' ? 'm' : chord.quality === 'dim' ? '' : chord.quality === 'aug' ? '+' : '';
                const romanNumerals = ['I', 'ii', 'iii', 'IV', 'V', 'vi', 'vii'];

                this.updateDisplay(
                    `${romanNumerals[degree - 1]} - ${chord.root}${chordSuffix} (${qualityNames[chord.quality] || chord.quality})`,
                    `Grado ${degree} de ${rootName} ${info?.name || scaleKey} | Notas: ${chord.root} - ${chord.third} - ${chord.fifth}`
                );
            },

            showIntervals() {
                this.resetState(['currentInterval']);
                this.hideUIElements();
                if (this.currentInterval === null) {
                    this.currentInterval = 4;
                    document.querySelector('[data-interval="4"]')?.classList.add('active');
                }
                this.showInterval();
            },

            showInterval() {
                const rootName = MusicTheory.getNoteName(this.currentRoot);
                const intervalName = MusicTheory.intervalNames[this.currentInterval];
                const targetNote = MusicTheory.getNoteName(this.currentRoot + this.currentInterval);

                Fretboard.clearZone();
                Fretboard.showInterval(this.currentRoot, this.currentInterval);

                // Also show descending interval
                const descendingNote = MusicTheory.getNoteName((this.currentRoot - this.currentInterval + 12) % 12);
                const descendingSemitones = 12 - this.currentInterval;

                this.updateDisplay(
                    `${intervalName} desde ${rootName}`,
                    `Ascendente: ${rootName}  ${targetNote} (${this.currentInterval} st) | Descendente: ${rootName}  ${descendingNote} (${descendingSemitones} st)`
                );
                this.showIntervalInfo(this.currentInterval);
            },

            showMajorScale() {
                this.resetState();
                this.currentScale = 'major';
                const scaleSelect = document.getElementById('scaleSelect');
                if (scaleSelect) scaleSelect.value = 'major';
                this.showScale();
            },

            showHarmonization() {
                this.resetState(['currentChord']);
                if (this.currentChord === null) {
                    this.currentChord = 1;
                    document.querySelector('[data-chord="1"]')?.classList.add('active');
                }
                this.showChord();
            },

            showChord() {
                const triad = MusicTheory.getTriad(this.currentRoot, 'major', this.currentChord);
                const rootName = MusicTheory.getNoteName(this.currentRoot);
                const chordRoot = triad.root.note;

                const qualityNames = { maj: 'Mayor', min: 'menor', dim: 'disminuido' };
                const harmonicFunctions = {
                    1: 'Tnica (reposo, estabilidad)',
                    2: 'Subdominante (movimiento suave)',
                    3: 'Tnica / Dominante (ambiguo)',
                    4: 'Subdominante (tensin media)',
                    5: 'Dominante (mxima tensin)',
                    6: 'Tnica menor (reposo menor)',
                    7: 'Dominante (tensin extrema por tritono)'
                };
                const tensions = {
                    1: '9, #11 (lidio), 13',
                    2: '9, 11, 13',
                    3: '11 (b9 evitada)',
                    4: '9, #11 (lidio), 13',
                    5: '9, b9, #9, #11, 13, b13',
                    6: '9, 11 (b13 evitada)',
                    7: '11, b13'
                };
                const voicingKey = triad.quality === 'min' ? `${chordRoot}m` : chordRoot;

                // Show chord diagram
                const diagramContainer = document.getElementById('diagramsContainer');
                diagramContainer.innerHTML = '';
                diagramContainer.classList.remove('hidden');

                // Get voicing - use open chord if available, otherwise barre
                let voicing = MusicTheory.chordVoicings[voicingKey];
                let position = 0;

                if (!voicing) {
                    // Use barre chord shape - E shape root is on 6th string (E = index 4)
                    const shape = triad.quality === 'min' ? 'E_shape_minor' : 'E_shape_major';
                    voicing = MusicTheory.chordVoicings[shape];
                    // Calculate position: distance from E (4) to target note
                    const targetIndex = MusicTheory.getNoteIndex(chordRoot);
                    position = (targetIndex - 4 + 12) % 12;
                }

                const chordName = triad.quality === 'min' ? `${chordRoot}m` : chordRoot;
                const diagram = ChordDiagram.create(voicing, chordName, position);
                diagramContainer.appendChild(diagram);

                // Show chord notes on fretboard with zone
                Fretboard.tonicNote = MusicTheory.getNoteIndex(chordRoot);
                Fretboard.currentScale = [
                    { note: triad.root.note, degree: 1 },
                    { note: triad.third.note, degree: 3 },
                    { note: triad.fifth.note, degree: 5 }
                ];
                Fretboard.highlightedNotes.clear();
                Fretboard.setZone(position, position + 4);
                Fretboard.specificPositions = null;
                Fretboard.updateDisplay();

                this.updateDisplay(
                    `${triad.roman} de ${rootName} Mayor: ${chordName} ${qualityNames[triad.quality]}`,
                    `Notas: ${triad.root.note} (T) - ${triad.third.note} (3) - ${triad.fifth.note} (5) | ${harmonicFunctions[this.currentChord]}`
                );
                document.getElementById('boxSelector').classList.add('hidden');

                // Show function and tension info
                const panel = document.getElementById('infoPanel');
                if (panel) {
                    panel.innerHTML = `
                        <div class="scale-info-box">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="info-section accent">
                                    <div class="info-label">Funcin Armnica</div>
                                    <div class="info-value" style="font-size: 15px;">${harmonicFunctions[this.currentChord]}</div>
                                </div>
                                <div class="info-section">
                                    <div class="info-label">Tensiones Disponibles</div>
                                    <div class="info-value" style="font-size: 15px;">${tensions[this.currentChord]}</div>
                                    <div class="info-description" style="margin-top: 4px;">Notas que se pueden aadir al acorde para enriquecerlo</div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            },

            showModes() {
                this.resetState(['currentMode']);
                this.hideUIElements();
                if (this.currentMode === null) {
                    this.currentMode = 1;
                    document.querySelector('[data-mode="1"]')?.classList.add('active');
                }
                this.showMode();
            },

            showMode() {
                const modeNames = ['Jnico', 'Drico', 'Frigio', 'Lidio', 'Mixolidio', 'Elico', 'Locrio'];
                const scaleTypes = ['major', 'dorian', 'phrygian', 'lydian', 'mixolydian', 'minor', 'locrian'];
                const romanNumerals = ['I', 'II', 'III', 'IV', 'V', 'VI', 'VII'];
                const charChords = ['Imaj7', 'IVmaj7 (lydian chord)', 'bIImaj7', 'IImaj7', 'bVIImaj7', 'bIIImaj7', 'bVmaj7'];
                const modeExamples = [
                    'Happy Birthday, Twinkle Twinkle',
                    'So What (Miles Davis), Scarborough Fair',
                    'White Rabbit (Jefferson Airplane), flamenco',
                    'Flying (E.T.), The Simpsons Theme',
                    'Norwegian Wood (Beatles), Sweet Home Alabama',
                    'Stairway to Heaven, All Along the Watchtower',
                    'Raro en uso meldico. YYZ (Rush) en pasajes'
                ];

                const rootName = MusicTheory.getNoteName(this.currentRoot);
                this.currentScale = scaleTypes[this.currentMode - 1];

                Fretboard.showScale(this.currentRoot, this.currentScale);

                const scaleSelect = document.getElementById('scaleSelect');
                if (scaleSelect) scaleSelect.value = this.currentScale;

                // Determine what note changes vs Jnico
                const majorFormula = MusicTheory.scales['major'];
                const modeFormula = MusicTheory.scales[this.currentScale];
                const differences = [];
                for (let i = 0; i < Math.min(majorFormula.length, modeFormula.length); i++) {
                    if (majorFormula[i] !== modeFormula[i]) {
                        const diff = modeFormula[i] - majorFormula[i];
                        differences.push(`grado ${i+1}: ${diff > 0 ? '+' : ''}${diff} st`);
                    }
                }
                const diffText = differences.length > 0 ? differences.join(', ') : 'Igual al Jnico (Mayor)';

                this.updateDisplay(
                    `${rootName} ${modeNames[this.currentMode - 1]}`,
                    `Modo ${this.currentMode} - Grado ${romanNumerals[this.currentMode - 1]} | Acorde caracterstico: ${charChords[this.currentMode - 1]}`
                );
                // Mostrar info del modo
                const info = MusicTheory.scaleInfo[this.currentScale];
                this.showScaleInfoPanel(info, this.currentScale);

                // Add mode comparison below the info panel
                const panel = document.getElementById('infoPanel');
                if (panel) {
                    const compDiv = document.createElement('div');
                    compDiv.className = 'scale-info-box';
                    compDiv.style.marginTop = '16px';
                    compDiv.innerHTML = `
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="info-section accent">
                                <div class="info-label">Diferencia vs Jnico (Mayor)</div>
                                <div class="info-description" style="color: #ccc;">${diffText}</div>
                            </div>
                            <div class="info-section">
                                <div class="info-label">Acorde Caracterstico</div>
                                <div class="info-value" style="font-size: 16px;">${charChords[this.currentMode - 1]}</div>
                            </div>
                            <div class="info-section">
                                <div class="info-label">Canciones/Artistas</div>
                                <div class="info-description" style="color: #ccc; font-size: 13px;">${modeExamples[this.currentMode - 1]}</div>
                            </div>
                        </div>
                    `;
                    panel.appendChild(compDiv);
                }
            },

            // ========== PENTATNICAS ==========

            showPentatonics() {
                this.resetState(['currentPentatonic']);
                if (this.currentPentatonic === null) {
                    this.currentPentatonic = 'minor';
                    document.querySelector('[data-penta="minor"]')?.classList.add('active');
                }
                this.currentBox = 0;
                this.showPentatonic();
            },

            showPentatonic() {
                const rootName = MusicTheory.getNoteName(this.currentRoot);
                const scaleMap = {
                    'minor': 'pentatonicMinor',
                    'major': 'pentatonicMajor',
                    'blues': 'blues'
                };
                const nameMap = {
                    'minor': 'Pentatnica Menor',
                    'major': 'Pentatnica Mayor',
                    'blues': 'Blues'
                };

                const scaleType = scaleMap[this.currentPentatonic];

                // Hide chord diagrams
                document.getElementById('diagramsContainer').classList.add('hidden');

                // Show box selector for pentatonic minor
                const boxSelector = document.getElementById('boxSelector');
                if (this.currentPentatonic === 'minor' || this.currentPentatonic === 'blues') {
                    boxSelector.classList.remove('hidden');
                    boxSelector.innerHTML = '';
                    for (let i = 0; i < 5; i++) {
                        const btn = document.createElement('button');
                        btn.className = `box-btn ${i === this.currentBox ? 'active' : ''}`;
                        btn.textContent = i + 1;
                        btn.addEventListener('click', () => {
                            this.currentBox = i;
                            document.querySelectorAll('.box-btn').forEach(b => b.classList.remove('active'));
                            btn.classList.add('active');
                            this.showPentatonic();
                        });
                        boxSelector.appendChild(btn);
                    }

                    // Show specific box
                    const boxes = MusicTheory.pentatonicBoxes.minor;
                    const box = boxes[this.currentBox];
                    const rootFret = this.currentRoot; // Simplified: root on 6th string

                    // Calculate positions for this box
                    const positions = [];
                    box.pattern.forEach(p => {
                        p.frets.forEach(f => {
                            if (f >= 0) {
                                const actualFret = (box.startFret + f + rootFret) % 12;
                                positions.push({ string: p.string, fret: actualFret });
                                // Also add octave position if in range
                                if (actualFret + 12 < 13) {
                                    positions.push({ string: p.string, fret: actualFret + 12 });
                                }
                            }
                        });
                    });

                    // Set zone
                    const startFret = (box.startFret + rootFret) % 12;
                    Fretboard.tonicNote = this.currentRoot;
                    Fretboard.currentScale = MusicTheory.getScale(this.currentRoot, scaleType);
                    Fretboard.setZone(Math.max(0, startFret), Math.min(12, startFret + 4));

                    if (this.currentPentatonic === 'blues') {
                        Fretboard.blueNoteIndex = (this.currentRoot + 6) % 12;
                    } else {
                        Fretboard.blueNoteIndex = null;
                    }

                    Fretboard.updateDisplay();

                    this.updateDisplay(
                        `${rootName} ${nameMap[this.currentPentatonic]} - ${box.name}`,
                        `Posicin ${this.currentBox + 1} de 5 | Trastes ${startFret}-${startFret + 3}`
                    );
                } else {
                    boxSelector.classList.add('hidden');
                    Fretboard.showScale(this.currentRoot, scaleType);
                    this.updateDisplay(
                        `${rootName} ${nameMap[this.currentPentatonic]}`,
                        `5 notas - Relativa de ${MusicTheory.getNoteName((this.currentRoot + 3) % 12)} Pent. Menor`
                    );
                }
                // Mostrar info de la escala pentatnica/blues
                const info = MusicTheory.scaleInfo[scaleType];
                this.showScaleInfoPanel(info, scaleType);
            },

            // ========== CRCULO DE QUINTAS ==========

            showCircleOfFifths() {
                this.resetState();
                this.hideUIElements();
                Fretboard.showScale(this.currentRoot, 'major');

                const rootName = MusicTheory.getNoteName(this.currentRoot);
                const relativeMinor = MusicTheory.getNoteName(MusicTheory.getRelativeMinor(this.currentRoot));

                // Key signature info
                const keySignatures = {
                    0: '0 alteraciones', 7: '1 # (F#)', 2: '2 # (F#, C#)', 9: '3 # (F#, C#, G#)',
                    4: '4 # (F#, C#, G#, D#)', 11: '5 # (F#, C#, G#, D#, A#)', 6: '6 #/b',
                    1: '7 # / 5 b', 8: '4 b (Bb, Eb, Ab, Db)', 3: '3 b (Bb, Eb, Ab)',
                    10: '2 b (Bb, Eb)', 5: '1 b (Bb)'
                };

                this.updateDisplay(
                    `Tonalidad: ${rootName} Mayor`,
                    `Relativo menor: ${relativeMinor}m | ${keySignatures[this.currentRoot] || ''}`
                );
                this.renderCircleOfFifths();

                // Show diatonic chords and neighbor keys
                const triads = MusicTheory.getScaleTriads(this.currentRoot, 'major');
                const romanNumerals = ['I', 'ii', 'iii', 'IV', 'V', 'vi', 'vii'];
                const qualitySymbols = { maj: '', min: 'm', dim: '' };

                const neighborUp = MusicTheory.getNoteName((this.currentRoot + 7) % 12);
                const neighborDown = MusicTheory.getNoteName((this.currentRoot + 5) % 12);

                const panel = document.getElementById('infoPanel');
                if (panel) {
                    panel.innerHTML = `
                        <div class="scale-info-box">
                            <div class="info-header">
                                <div class="info-title">Tonalidad ${rootName} Mayor</div>
                                <div class="info-emotion">Armadura: ${keySignatures[this.currentRoot] || 'N/A'}</div>
                            </div>
                            <div class="info-section" style="margin-bottom: 12px;">
                                <div class="info-label">Acordes Diatnicos</div>
                                <div class="flex flex-wrap gap-2 mt-2">
                                    ${triads.map((t, i) => `
                                        <div style="padding: 8px 12px; background: #1a1a1a; border: 2px solid #333; border-radius: 8px; text-align: center; min-width: 55px;">
                                            <div style="font-family: 'Bebas Neue'; font-size: 18px; color: #fafafa;">${romanNumerals[i]}</div>
                                            <div style="font-family: 'IBM Plex Mono'; font-size: 12px; color: #dc2626;">${t.root.note}${qualitySymbols[t.quality] || ''}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="info-section">
                                    <div class="info-label">Tonalidades Vecinas (modulacin fcil)</div>
                                    <div class="info-description" style="color: #ccc; margin-top: 4px;">
                                         <strong>${neighborDown} Mayor</strong> (IV, subdominante) |
                                        <strong>${neighborUp} Mayor</strong> (V, dominante) 
                                    </div>
                                    <div class="info-description" style="color: #888; margin-top: 4px;">
                                        Relativo menor: <strong>${relativeMinor}m</strong>
                                    </div>
                                </div>
                                <div class="info-section accent">
                                    <div class="info-label">Armadura</div>
                                    <div class="info-value" style="font-size: 15px;">${keySignatures[this.currentRoot] || 'N/A'}</div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            },

            renderCircleOfFifths() {
                // Try both possible container IDs
                let container = document.getElementById('circleOfFifthsMain');
                if (!container) container = document.getElementById('circleOfFifths');
                if (!container) return;

                container.innerHTML = '';
                const centerX = 110;
                const centerY = 110;
                const outerRadius = 90;
                const innerRadius = 60;

                // Major keys (outer circle)
                MusicTheory.circleOfFifths.forEach((noteIndex, i) => {
                    const angle = (i * 30 - 90) * Math.PI / 180;
                    const x = centerX + outerRadius * Math.cos(angle) - 16;
                    const y = centerY + outerRadius * Math.sin(angle) - 16;

                    const btn = document.createElement('button');
                    btn.className = `circle-note ${noteIndex === this.currentRoot ? 'active' : ''}`;
                    btn.style.left = `${x}px`;
                    btn.style.top = `${y}px`;
                    btn.textContent = MusicTheory.circleOfFifthsLabels[i];
                    btn.dataset.note = noteIndex;
                    btn.addEventListener('click', () => {
                        this.currentRoot = noteIndex;
                        document.getElementById('rootSelect').value = noteIndex;
                        this.showCircleOfFifths();
                    });
                    container.appendChild(btn);
                });

                // Minor keys (inner circle)
                MusicTheory.circleOfFifths.forEach((noteIndex, i) => {
                    const minorNote = MusicTheory.getRelativeMinor(noteIndex);
                    const angle = (i * 30 - 90) * Math.PI / 180;
                    const x = centerX + innerRadius * Math.cos(angle) - 13;
                    const y = centerY + innerRadius * Math.sin(angle) - 13;

                    const minorLabels = ['Am', 'Em', 'Bm', 'F#m', 'C#m', 'G#m', 'Ebm', 'Bbm', 'Fm', 'Cm', 'Gm', 'Dm'];
                    const btn = document.createElement('button');
                    const isRelativeOfCurrent = minorNote === MusicTheory.getRelativeMinor(this.currentRoot);
                    btn.className = `circle-note minor ${isRelativeOfCurrent ? 'active' : ''}`;
                    btn.style.left = `${x}px`;
                    btn.style.top = `${y}px`;
                    btn.textContent = minorLabels[i];
                    btn.dataset.note = minorNote;
                    btn.addEventListener('click', () => {
                        this.currentRoot = MusicTheory.getRelativeMajor(minorNote);
                        document.getElementById('rootSelect').value = this.currentRoot;
                        this.showCircleOfFifths();
                    });
                    container.appendChild(btn);
                });
            },

            // ========== ACORDES DE SPTIMA ==========

            showSeventhChords() {
                this.resetState(['currentChord7']);
                if (this.currentChord7 === null) {
                    this.currentChord7 = 1;
                    document.querySelector('[data-chord7="1"]')?.classList.add('active');
                }
                this.showSeventhChord();
            },

            showSeventhChord() {
                const chord = MusicTheory.getSeventhChord(this.currentRoot, this.currentChord7);
                const rootName = MusicTheory.getNoteName(this.currentRoot);
                const chordRootIndex = MusicTheory.getNoteIndex(chord.root);

                // Hide box selector
                document.getElementById('boxSelector').classList.add('hidden');

                // Show chord diagram
                const diagramContainer = document.getElementById('diagramsContainer');
                diagramContainer.innerHTML = '';
                diagramContainer.classList.remove('hidden');

                // Get appropriate voicing
                const voicingTypes = {
                    1: 'maj7_E', 2: 'm7_A', 3: 'm7_E', 4: 'maj7_A',
                    5: 'dom7_E', 6: 'm7_A', 7: 'm7b5_E'
                };
                const voicingKey = voicingTypes[this.currentChord7];
                const voicing = MusicTheory.seventhVoicings[voicingKey];
                // E shapes: root on 6th string (E=4), A shapes: root on 5th string (A=9)
                const isAShape = voicingKey.includes('_A');
                const baseNote = isAShape ? 9 : 4; // A=9, E=4
                const position = (chordRootIndex - baseNote + 12) % 12;

                const chordName = `${chord.root}${chord.quality}`;
                const diagram = ChordDiagram.create(voicing, chordName, position);
                diagramContainer.appendChild(diagram);

                // Show chord on fretboard with zone
                Fretboard.tonicNote = chordRootIndex;
                Fretboard.currentScale = chord.notes.map((n, i) => ({
                    note: n.note,
                    degree: i + 1
                }));
                Fretboard.highlightedNotes.clear();
                Fretboard.setZone(position, position + 4);
                Fretboard.specificPositions = null;
                Fretboard.updateDisplay();

                const romanNumerals = ['I', 'ii', 'iii', 'IV', 'V', 'vi', 'vii'];
                this.updateDisplay(
                    `${romanNumerals[this.currentChord7 - 1]}${chord.quality} de ${rootName} Mayor: ${chord.root}${chord.quality}`,
                    `Notas: ${chord.notes.map(n => n.note).join(' - ')} | Tipo: ${chord.quality}`
                );
                this.clearInfoPanel();
            },

            // ========== PROGRESIONES ==========

            showProgressions() {
                this.resetState(['currentProgression']);
                if (!this.currentProgression) {
                    this.currentProgression = 'I-IV-V-I';
                    document.querySelector('[data-progression="I-IV-V-I"]')?.classList.add('active');
                }
                this.showProgression();
            },

            showProgression() {
                if (!this.currentProgression) return;

                const prog = MusicTheory.progressions[this.currentProgression];
                if (!prog) return;
                const rootName = MusicTheory.getNoteName(this.currentRoot);

                // Hide box selector
                document.getElementById('boxSelector').classList.add('hidden');

                // Build all chords for the progression
                const chords = prog.degrees.map(degree => {
                    let chordRoot, quality, triad;

                    // Handle flat degrees from minor key
                    const flatDegreeOffsets = {
                        '-1': { offset: 0, quality: 'min' },    // i
                        '-3': { offset: 3, quality: 'maj' },    // bIII
                        '-4': { offset: 5, quality: 'min' },    // iv
                        '-5': { offset: 7, quality: 'min' },    // v
                        '-6': { offset: 8, quality: 'maj' },    // bVI
                        '-7': { offset: 10, quality: 'maj' },   // bVII
                    };

                    if (flatDegreeOffsets[String(degree)]) {
                        const info = flatDegreeOffsets[String(degree)];
                        chordRoot = MusicTheory.getNoteName((this.currentRoot + info.offset) % 12);
                        quality = info.quality;
                        const thirdOffset = quality === 'min' ? 3 : 4;
                        triad = {
                            root: { note: chordRoot },
                            third: { note: MusicTheory.getNoteName((this.currentRoot + info.offset + thirdOffset) % 12) },
                            fifth: { note: MusicTheory.getNoteName((this.currentRoot + info.offset + 7) % 12) }
                        };
                    } else if (degree > 0) {
                        triad = MusicTheory.getTriad(this.currentRoot, 'major', degree);
                        chordRoot = triad.root.note;
                        quality = triad.quality;
                    } else {
                        // Fallback
                        chordRoot = MusicTheory.getNoteName(this.currentRoot);
                        quality = 'maj';
                        triad = { root: { note: chordRoot }, third: { note: chordRoot }, fifth: { note: chordRoot } };
                    }

                    const voicingKey = quality === 'min' ? `${chordRoot}m` : chordRoot;
                    let voicing = MusicTheory.chordVoicings[voicingKey];
                    let position = 0;

                    if (!voicing) {
                        const shape = quality === 'min' ? 'E_shape_minor' : 'E_shape_major';
                        voicing = MusicTheory.chordVoicings[shape];
                        // Calculate position: distance from E (4) to target note
                        const targetIndex = MusicTheory.getNoteIndex(chordRoot);
                        position = (targetIndex - 4 + 12) % 12;
                    }

                    return {
                        name: quality === 'min' ? `${chordRoot}m` : chordRoot,
                        voicing,
                        position,
                        triad
                    };
                });

                // Show all chord diagrams
                const diagramContainer = document.getElementById('diagramsContainer');
                diagramContainer.innerHTML = '';
                diagramContainer.classList.remove('hidden');
                diagramContainer.classList.add('scrollable-horizontal');

                chords.forEach((chord, i) => {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'chord-wrapper';
                    wrapper.style.cursor = 'pointer';
                    wrapper.style.position = 'relative';
                    wrapper.style.transition = 'all 0.2s';

                    if (i === this.currentProgressionChordIndex) {
                        wrapper.classList.add('active-chord');
                        wrapper.style.opacity = '1';
                        // Borde animado para acorde activo
                        if (this.progressionPlaying && !this.progressionPaused) {
                            wrapper.style.border = '3px solid #10b981';
                            wrapper.style.boxShadow = '0 0 15px rgba(16, 185, 129, 0.5)';
                        }
                    } else {
                        wrapper.style.opacity = '0.6';
                    }

                    wrapper.addEventListener('click', () => {
                        if (!this.progressionPlaying) {
                            this.currentProgressionChordIndex = i;
                            this.showProgression();
                        }
                    });

                    // Hover effects
                    wrapper.addEventListener('mouseenter', () => {
                        if (!this.progressionPlaying) {
                            wrapper.style.transform = 'scale(1.15)';
                            wrapper.style.zIndex = '100';
                            wrapper.style.opacity = '1';
                        }
                    });

                    wrapper.addEventListener('mouseleave', () => {
                        if (!this.progressionPlaying) {
                            wrapper.style.transform = 'scale(1)';
                            wrapper.style.zIndex = '1';
                            if (i !== this.currentProgressionChordIndex) {
                                wrapper.style.opacity = '0.6';
                            }
                        }
                    });

                    // Numeracin del acorde
                    const numberBadge = document.createElement('div');
                    numberBadge.style.cssText = `
                        position: absolute;
                        top: -8px;
                        left: 50%;
                        transform: translateX(-50%);
                        width: 24px;
                        height: 24px;
                        border-radius: 50%;
                        background: ${this.getChordFunctionColor(prog, i)};
                        color: white;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-weight: bold;
                        font-size: 12px;
                        z-index: 10;
                    `;
                    numberBadge.textContent = i + 1;
                    wrapper.appendChild(numberBadge);

                    // Tooltip con notas del acorde
                    const tooltip = document.createElement('div');
                    const chordNotes = [chord.triad.root.note, chord.triad.third.note, chord.triad.fifth.note].join(' - ');
                    tooltip.style.cssText = `
                        position: absolute;
                        bottom: -30px;
                        left: 50%;
                        transform: translateX(-50%);
                        background: rgba(0, 0, 0, 0.9);
                        color: white;
                        padding: 6px 12px;
                        border-radius: 4px;
                        font-size: 11px;
                        white-space: nowrap;
                        opacity: 0;
                        pointer-events: none;
                        transition: opacity 0.2s;
                        z-index: 200;
                    `;
                    tooltip.textContent = chordNotes;
                    wrapper.appendChild(tooltip);

                    wrapper.addEventListener('mouseenter', () => {
                        tooltip.style.opacity = '1';
                    });

                    wrapper.addEventListener('mouseleave', () => {
                        tooltip.style.opacity = '0';
                    });

                    const diagram = ChordDiagram.create(chord.voicing, chord.name, chord.position);

                    // Clase compact si hay ms de 4 acordes
                    if (chords.length > 4) {
                        diagram.classList.add('compact');
                    }

                    wrapper.appendChild(diagram);
                    diagramContainer.appendChild(wrapper);
                });

                // Auto-scroll al acorde activo
                setTimeout(() => {
                    const active = diagramContainer.querySelector('.active-chord');
                    if (active) {
                        active.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
                    }
                }, 100);

                // Show current chord on fretboard
                const currentChord = chords[this.currentProgressionChordIndex];
                const chordRootIndex = MusicTheory.getNoteIndex(currentChord.name.replace('m', ''));

                Fretboard.tonicNote = chordRootIndex;
                Fretboard.currentScale = [
                    { note: currentChord.triad.root.note, degree: 1 },
                    { note: currentChord.triad.third.note, degree: 3 },
                    { note: currentChord.triad.fifth.note, degree: 5 }
                ];
                Fretboard.highlightedNotes.clear();
                Fretboard.setZone(currentChord.position, currentChord.position + 4);
                Fretboard.specificPositions = null;
                Fretboard.updateDisplay();

                const styleLabel = prog.style ? ` | Estilo: ${prog.style}` : '';
                const funcLabel = prog.function ? ` | Funcin: ${prog.function[this.currentProgressionChordIndex]}` : '';
                this.updateDisplay(
                    `Progresin ${this.currentProgression} en ${rootName}`,
                    `${prog.name}${styleLabel} | Acorde ${this.currentProgressionChordIndex + 1}/${prog.degrees.length}: ${currentChord.name}${funcLabel}`
                );
                this.clearInfoPanel();

                // NUEVO: Anlisis de progresin
                this.renderProgressionAnalysis(prog, currentChord, this.currentProgressionChordIndex);
            },

            // NUEVO: Renderizar anlisis de progresin
            renderProgressionAnalysis(prog, currentChord, chordIndex) {
                const infoPanel = document.getElementById('infoPanel');
                if (!infoPanel || !prog.function || !prog.analysis) return;

                infoPanel.classList.remove('hidden');

                const functionColors = {
                    'T': '#10b981',   // Verde - Tnica
                    'Tm': '#10b981',  // Verde - Tnica menor
                    'SD': '#f59e0b',  // Amarillo - Subdominante
                    'SDm': '#f59e0b', // Amarillo - Subdominante menor
                    'D': '#dc2626',   // Rojo - Dominante
                    'Dm': '#dc2626',  // Rojo - Dominante menor
                    'bVII': '#8b5cf6', // Prpura - Acorde prestado
                    'bVI': '#8b5cf6',
                    'bIII': '#8b5cf6'
                };

                const functionLabels = {
                    'T': 'Tnica (Reposo)',
                    'Tm': 'Tnica menor (Reposo)',
                    'SD': 'Subdominante (Tensin suave)',
                    'SDm': 'Subdominante menor',
                    'D': 'Dominante (Tensin fuerte)',
                    'Dm': 'Dominante menor',
                    'bVII': 'Acorde prestado',
                    'bVI': 'Acorde prestado',
                    'bIII': 'Acorde prestado'
                };

                // Crear chips de acordes con colores
                const chordChips = prog.degrees.map((degree, i) => {
                    const func = prog.function[i];
                    const color = functionColors[func] || '#666';
                    const isActive = i === chordIndex;
                    const opacity = isActive ? '1' : '0.5';
                    const romanNumeral = this.getRomanNumeral(degree);

                    return `
                        <div style="
                            display: inline-block;
                            padding: 8px 16px;
                            margin: 4px;
                            background: ${color};
                            color: white;
                            border-radius: 6px;
                            font-weight: bold;
                            opacity: ${opacity};
                            ${isActive ? 'transform: scale(1.1);' : ''}
                            transition: all 0.2s;
                        ">
                            ${romanNumeral}
                        </div>
                    `;
                }).join('');

                const currentFunction = prog.function[chordIndex];
                const functionDesc = functionLabels[currentFunction] || currentFunction;

                // Verificar estado de colapso desde localStorage
                const isCollapsed = localStorage.getItem('progressionPanelCollapsed') === 'true';

                infoPanel.innerHTML = `
                    <div style="position: relative;">
                        <button id="toggleProgressionPanel" style="
                            position: absolute;
                            top: -40px;
                            right: 0;
                            padding: 8px 16px;
                            background: rgba(220, 38, 38, 0.2);
                            border: 1px solid rgba(220, 38, 38, 0.4);
                            border-radius: 4px;
                            color: #dc2626;
                            cursor: pointer;
                            font-size: 12px;
                            font-weight: 600;
                            transition: all 0.2s;
                        " onmouseover="this.style.background='rgba(220, 38, 38, 0.3)'" onmouseout="this.style.background='rgba(220, 38, 38, 0.2)'">
                            ${isCollapsed ? ' Mostrar Anlisis' : ' Ocultar Anlisis'}
                        </button>

                        <div id="progressionPanelContent" style="
                            max-height: ${isCollapsed ? '0' : '1000px'};
                            overflow: hidden;
                            transition: max-height 0.3s ease-in-out, opacity 0.3s;
                            opacity: ${isCollapsed ? '0' : '1'};
                        ">
                            <div class="info-section" style="background: rgba(0,0,0,0.3); padding: 20px; border-radius: 8px; margin-bottom: 16px;">
                                <div class="info-label" style="color: #dc2626; margin-bottom: 12px;">ANLISIS ARMNICO</div>
                                <div style="margin-bottom: 16px;">
                                    ${chordChips}
                                </div>
                                <div style="margin-bottom: 12px; padding: 12px; background: rgba(220,38,38,0.1); border-left: 3px solid ${functionColors[currentFunction]}; border-radius: 4px;">
                                    <strong style="color: ${functionColors[currentFunction]};">Acorde actual:</strong>
                                    ${functionDesc}
                                </div>
                                <div style="color: #ccc; font-size: 14px; line-height: 1.6;">
                                    ${prog.analysis}
                                </div>
                            </div>

                            ${prog.songs ? `
                                <div class="info-section" style="background: rgba(0,0,0,0.2); padding: 16px; border-radius: 8px;">
                                    <div class="info-label" style="color: #dc2626; margin-bottom: 8px;">CANCIONES FAMOSAS</div>
                                    <div style="color: #aaa; font-size: 13px; line-height: 1.8;">
                                        ${prog.songs.map(song => ` ${song}`).join('<br>')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;

                // Agregar event listener para el botn de toggle
                setTimeout(() => {
                    const toggleBtn = document.getElementById('toggleProgressionPanel');
                    const content = document.getElementById('progressionPanelContent');
                    if (toggleBtn && content) {
                        toggleBtn.addEventListener('click', () => {
                            const isCurrentlyCollapsed = content.style.maxHeight === '0px';
                            content.style.maxHeight = isCurrentlyCollapsed ? '1000px' : '0';
                            content.style.opacity = isCurrentlyCollapsed ? '1' : '0';
                            toggleBtn.textContent = isCurrentlyCollapsed ? ' Ocultar Anlisis' : ' Mostrar Anlisis';
                            localStorage.setItem('progressionPanelCollapsed', !isCurrentlyCollapsed);
                        });
                    }
                }, 0);
            },

            // NUEVO: Convertir grado numrico a romano
            getRomanNumeral(degree) {
                const romanMap = {
                    '-1': 'i', '-3': 'bIII', '-4': 'iv', '-5': 'v', '-6': 'bVI', '-7': 'bVII',
                    '1': 'I', '2': 'ii', '3': 'iii', '4': 'IV', '5': 'V', '6': 'vi', '7': 'vii'
                };
                return romanMap[String(degree)] || degree;
            },

            // ========== REPRODUCCIN AUTOMTICA DE PROGRESIONES ==========

            playProgression() {
                if (this.progressionPlaying && !this.progressionPaused) return;

                const prog = MusicTheory.progressions[this.currentProgression];
                if (!prog) return;

                // Si est pausado, reanudar
                if (this.progressionPaused) {
                    this.progressionPaused = false;
                    this.progressionPlaying = true;
                    this.updateProgressionControls();
                    this.startProgressionPlayback(prog);
                    return;
                }

                // Iniciar desde el principio
                this.progressionPlaying = true;
                this.progressionPaused = false;
                this.currentProgressionChordIndex = 0;
                this.progressionCurrentRepeat = 0;
                this.updateProgressionControls();
                this.startProgressionPlayback(prog);
            },

            startProgressionPlayback(prog) {
                const beatDuration = (60 / this.progressionBPM) * 4000; // 4 beats por acorde
                const chords = prog.degrees;

                const playNextChord = () => {
                    if (!this.progressionPlaying || this.progressionPaused) return;

                    // Tocar acorde actual
                    const degree = chords[this.currentProgressionChordIndex];
                    this.playProgressionChord(degree);

                    // Actualizar UI
                    this.showProgression();
                    this.updateProgressionProgress();

                    // Avanzar al siguiente acorde
                    this.currentProgressionChordIndex++;

                    if (this.currentProgressionChordIndex >= chords.length) {
                        // Fin de la progresin
                        this.currentProgressionChordIndex = 0;
                        this.progressionCurrentRepeat++;

                        // Verificar si debe continuar
                        const shouldContinue = this.progressionLoop ||
                            (this.progressionCurrentRepeat < this.progressionRepeatCount);

                        if (!shouldContinue) {
                            this.stopProgression();
                            return;
                        }

                        this.updateProgressionProgress();
                    }

                    // Programar siguiente acorde
                    this.progressionIntervalId = setTimeout(playNextChord, beatDuration);
                };

                // Iniciar reproduccin
                playNextChord();
            },

            playProgressionChord(degree) {
                // Similar a showProgression, pero solo toca el acorde
                const flatDegreeOffsets = {
                    '-1': { offset: 0, quality: 'min' },
                    '-3': { offset: 3, quality: 'maj' },
                    '-4': { offset: 5, quality: 'min' },
                    '-5': { offset: 7, quality: 'min' },
                    '-6': { offset: 8, quality: 'maj' },
                    '-7': { offset: 10, quality: 'maj' },
                };

                let chordRoot, quality;

                if (flatDegreeOffsets[String(degree)]) {
                    const info = flatDegreeOffsets[String(degree)];
                    chordRoot = MusicTheory.getNoteName((this.currentRoot + info.offset) % 12);
                    quality = info.quality;
                } else if (degree > 0) {
                    const triad = MusicTheory.getTriad(this.currentRoot, 'major', degree);
                    chordRoot = triad.root.note;
                    quality = triad.quality;
                } else {
                    chordRoot = MusicTheory.getNoteName(this.currentRoot);
                    quality = 'maj';
                }

                const voicingKey = quality === 'min' ? `${chordRoot}m` : chordRoot;
                const voicing = MusicTheory.chordVoicings[voicingKey];

                if (voicing) {
                    AudioEngine.playChordVoicing(voicing, 1.5);
                }
            },

            pauseProgression() {
                if (!this.progressionPlaying || this.progressionPaused) return;

                this.progressionPaused = true;
                this.progressionPlaying = false;

                if (this.progressionIntervalId) {
                    clearTimeout(this.progressionIntervalId);
                    this.progressionIntervalId = null;
                }

                this.updateProgressionControls();
            },

            stopProgression() {
                this.progressionPlaying = false;
                this.progressionPaused = false;
                this.currentProgressionChordIndex = 0;
                this.progressionCurrentRepeat = 0;

                if (this.progressionIntervalId) {
                    clearTimeout(this.progressionIntervalId);
                    this.progressionIntervalId = null;
                }

                this.updateProgressionControls();
                this.updateProgressionProgress();
                this.showProgression();
            },

            updateProgressionProgress() {
                const prog = MusicTheory.progressions[this.currentProgression];
                if (!prog) return;

                const total = prog.degrees.length;
                const current = this.currentProgressionChordIndex + 1;
                const percentage = (this.currentProgressionChordIndex / total) * 100;

                const progressText = document.getElementById('progressionProgressText');
                const progressBar = document.getElementById('progressionProgressBar');
                const repeatText = document.getElementById('progressionRepeatText');

                if (progressText) {
                    progressText.textContent = `Acorde ${current} / ${total}`;
                }

                if (progressBar) {
                    progressBar.style.width = `${percentage}%`;

                    // Color segn funcin
                    const func = prog.function ? prog.function[this.currentProgressionChordIndex] : null;
                    const colors = {
                        'T': '#10b981', 'Tm': '#10b981',
                        'SD': '#f59e0b', 'SDm': '#f59e0b',
                        'D': '#dc2626', 'Dm': '#dc2626'
                    };
                    progressBar.style.background = colors[func] || '#666';
                }

                if (repeatText) {
                    const currentRep = this.progressionCurrentRepeat + 1;
                    const totalReps = this.progressionLoop ? '' : this.progressionRepeatCount;
                    repeatText.textContent = `Repeticin ${currentRep} / ${totalReps}`;
                }
            },

            updateProgressionControls() {
                const playBtn = document.getElementById('playProgressionBtn');
                const pauseBtn = document.getElementById('pauseProgressionBtn');
                const stopBtn = document.getElementById('stopProgressionBtn');

                if (playBtn) playBtn.disabled = this.progressionPlaying && !this.progressionPaused;
                if (pauseBtn) pauseBtn.disabled = !this.progressionPlaying || this.progressionPaused;
                if (stopBtn) stopBtn.disabled = !this.progressionPlaying && !this.progressionPaused;
            },

            getChordFunctionColor(prog, index) {
                if (!prog.function) return '#666';
                const func = prog.function[index];
                const colors = {
                    'T': '#10b981', 'Tm': '#10b981',
                    'SD': '#f59e0b', 'SDm': '#f59e0b',
                    'D': '#dc2626', 'Dm': '#dc2626',
                    'bVII': '#8b5cf6', 'bVI': '#8b5cf6', 'bIII': '#8b5cf6'
                };
                return colors[func] || '#666';
            },

            // ========== SISTEMA CAGED ==========

            showCAGED() {
                this.resetState(['currentCAGED']);
                if (this.currentCAGED === null) {
                    this.currentCAGED = 'C';
                    document.querySelector('[data-caged="C"]')?.classList.add('active');
                }
                this.showCAGEDShape();
            },

            calculateCAGEDPosition(shape, root) {
                const transposition = root;
                const position = shape === 'C' ? transposition :
                    shape === 'A' ? transposition + 3 :
                    shape === 'G' ? transposition + 5 :
                    shape === 'E' ? transposition + 8 :
                    transposition + 10; // D
                return position % 12;
            },

            showCAGEDShape() {
                const rootName = MusicTheory.getNoteName(this.currentRoot);

                // Hide box selector
                document.getElementById('boxSelector').classList.add('hidden');

                // Show chord diagram
                const diagramContainer = document.getElementById('diagramsContainer');
                diagramContainer.innerHTML = '';
                diagramContainer.classList.remove('hidden');

                if (this.cagedShowAll) {
                    // Mostrar todas las 5 formas simultneamente
                    diagramContainer.classList.add('scrollable-horizontal');
                    const cagedOrder = ['C', 'A', 'G', 'E', 'D'];

                    cagedOrder.forEach(shape => {
                        const baseVoicing = MusicTheory.chordVoicings[shape];
                        const position = this.calculateCAGEDPosition(shape, this.currentRoot);

                        const wrapper = document.createElement('div');
                        wrapper.className = 'chord-wrapper';
                        if (shape === this.currentCAGED) {
                            wrapper.classList.add('active-chord');
                        } else {
                            wrapper.style.opacity = '0.7';
                        }

                        const diagram = ChordDiagram.create(baseVoicing, `${rootName} (${shape})`, position);
                        wrapper.appendChild(diagram);

                        // Label de posicin
                        const posLabel = document.createElement('div');
                        posLabel.textContent = `Posicin ${position}`;
                        posLabel.style.cssText = 'text-align: center; font-size: 11px; color: #888; margin-top: 4px; font-weight: 600;';
                        wrapper.appendChild(posLabel);

                        diagramContainer.appendChild(wrapper);
                    });

                    // Mostrar la forma activa en el fretboard
                    const adjustedPosition = this.calculateCAGEDPosition(this.currentCAGED, this.currentRoot);
                    Fretboard.tonicNote = this.currentRoot;
                    Fretboard.currentScale = MusicTheory.getScale(this.currentRoot, 'major');
                    Fretboard.highlightedNotes.clear();
                    const zoneStart = Math.max(0, adjustedPosition);
                    const zoneEnd = Math.min(12, adjustedPosition + 4);
                    Fretboard.setZone(zoneStart, zoneEnd);
                    Fretboard.specificPositions = null;
                    Fretboard.updateDisplay();

                    this.updateDisplay(
                        `${rootName} Mayor - Sistema CAGED Completo`,
                        `Forma activa: ${this.currentCAGED} | Ver todas las formas en el mstil`
                    );
                } else {
                    // Mostrar solo la forma actual
                    diagramContainer.classList.remove('scrollable-horizontal');

                    const baseVoicing = MusicTheory.chordVoicings[this.currentCAGED];
                    const adjustedPosition = this.calculateCAGEDPosition(this.currentCAGED, this.currentRoot);

                    const diagram = ChordDiagram.create(baseVoicing, rootName, adjustedPosition);
                    diagramContainer.appendChild(diagram);

                    // Show major scale with zone highlighting
                    Fretboard.tonicNote = this.currentRoot;
                    Fretboard.currentScale = MusicTheory.getScale(this.currentRoot, 'major');
                    Fretboard.highlightedNotes.clear();

                    // Set zone based on CAGED position
                    const zoneStart = Math.max(0, adjustedPosition);
                    const zoneEnd = Math.min(12, adjustedPosition + 4);
                    Fretboard.setZone(zoneStart, zoneEnd);
                    Fretboard.specificPositions = null;
                    Fretboard.updateDisplay();

                    this.updateDisplay(
                        `${rootName} Mayor - Forma ${this.currentCAGED}`,
                        `Posicin: Traste ${adjustedPosition} | Orden: C  A  G  E  D  C...`
                    );
                }
                this.clearInfoPanel();
            },

            // ========== NIVEL 1 - INTERVALOS MEJORADO ==========

            showIntervalInfo(interval) {
                const info = MusicTheory.intervalInfo[interval];
                if (!info) return;
                const panel = document.getElementById('infoPanel');
                if (!panel) return;
                panel.innerHTML = `
                    <div class="scale-info-box">
                        <div class="info-header">
                            <div class="info-title">${info.name}</div>
                            <div class="info-emotion">${info.semitones} semitono${info.semitones > 1 ? 's' : ''}</div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="info-section accent">
                                <div class="info-label">Carcter Sonoro</div>
                                <div class="info-value" style="font-size: 15px;">${info.character}</div>
                            </div>
                            <div class="info-section">
                                <div class="info-label">Consonancia</div>
                                <div class="info-value" style="font-size: 15px;">${info.consonance}</div>
                            </div>
                            <div class="info-section">
                                <div class="info-label">Reconocimiento</div>
                                <div class="info-description" style="color: #ccc; font-size: 14px;">${info.examples}</div>
                            </div>
                        </div>
                    </div>
                `;
            },

            // ========== NIVEL 10 - QUIZ ==========

            showQuiz() {
                this.resetState();
                this.hideUIElements();
                Fretboard.clear();
                this.updateDisplay('QUIZ INTERACTIVO', 'Pon a prueba tus conocimientos de teora musical');
                this.generateQuizQuestion();
            },

            generateQuizQuestion() {
                this.quizAnswered = false;
                const questions = MusicTheory.quizQuestions[this.quizCategory];
                if (!questions) return;

                const diffQuestions = questions[this.quizDifficulty] || questions.easy;
                if (!diffQuestions || diffQuestions.length === 0) return;

                const q = diffQuestions[Math.floor(Math.random() * diffQuestions.length)];
                this.currentQuizQuestion = q;

                const panel = document.getElementById('infoPanel');
                if (!panel) return;

                // Shuffle options
                const shuffled = [...q.options].sort(() => Math.random() - 0.5);

                panel.innerHTML = `
                    <div class="quiz-question-box">
                        <div style="font-family: 'Barlow Condensed', sans-serif; font-size: 12px; color: #666; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px;">
                            ${this.quizCategory}  ${this.quizDifficulty === 'easy' ? 'Fcil' : this.quizDifficulty === 'medium' ? 'Medio' : 'Difcil'}
                        </div>
                        <div style="font-family: 'Barlow Condensed', sans-serif; font-size: 22px; color: #fafafa; font-weight: 600; margin-bottom: 20px;">
                            ${q.q}
                        </div>
                        <div id="quizOptions">
                            ${shuffled.map((opt, i) => `
                                <button class="quiz-option" data-answer="${opt}" data-correct="${opt === q.a}">
                                    <span style="font-weight: 700; color: #666; margin-right: 12px;">${String.fromCharCode(65 + i)}.</span>
                                    ${opt}
                                </button>
                            `).join('')}
                        </div>
                        <div id="quizFeedback" style="margin-top: 16px; display: none;"></div>
                    </div>
                `;

                // Bind option clicks
                panel.querySelectorAll('.quiz-option').forEach(btn => {
                    btn.addEventListener('click', () => this.answerQuiz(btn));
                });

                this.updateDisplay('QUIZ INTERACTIVO', `Categora: ${this.quizCategory} | Dificultad: ${this.quizDifficulty}`);
            },

            answerQuiz(btn) {
                if (this.quizAnswered) return;
                this.quizAnswered = true;

                const isCorrect = btn.dataset.correct === 'true';
                const options = document.querySelectorAll('.quiz-option');

                options.forEach(opt => {
                    opt.classList.add('disabled');
                    if (opt.dataset.correct === 'true') {
                        opt.classList.add('correct');
                    }
                });

                if (isCorrect) {
                    btn.classList.add('correct');
                    const points = this.quizDifficulty === 'easy' ? 10 : this.quizDifficulty === 'medium' ? 20 : 30;
                    this.quizScore += points;
                    this.quizStreak++;
                    if (this.quizStreak > this.quizBest) this.quizBest = this.quizStreak;

                    // Streak bonus
                    if (this.quizStreak >= 3) {
                        this.quizScore += this.quizStreak * 5;
                        this.announce(`Correcto! Ganaste ${points} puntos. Racha de ${this.quizStreak}. Bonus: ${this.quizStreak * 5} puntos.`);
                    } else {
                        this.announce(`Correcto! Ganaste ${points} puntos.`);
                    }
                } else {
                    btn.classList.add('incorrect');
                    this.quizStreak = 0;
                    this.announce(`Incorrecto. La respuesta correcta era: ${this.currentQuizQuestion.a}`);
                }

                // Update score display
                const scoreEl = document.getElementById('quizScore');
                const streakEl = document.getElementById('quizStreak');
                const bestEl = document.getElementById('quizBest');
                if (scoreEl) scoreEl.textContent = this.quizScore;
                if (streakEl) streakEl.textContent = this.quizStreak;
                if (bestEl) bestEl.textContent = this.quizBest;

                // Guardar progreso
                this.saveProgress();

                // Show feedback
                const feedback = document.getElementById('quizFeedback');
                if (feedback) {
                    feedback.style.display = 'block';
                    feedback.innerHTML = `
                        <div style="padding: 12px; border-radius: 10px; background: ${isCorrect ? 'rgba(34, 197, 94, 0.1)' : 'rgba(220, 38, 38, 0.1)'}; border: 1px solid ${isCorrect ? '#22c55e' : '#dc2626'};">
                            <span style="font-weight: 700; color: ${isCorrect ? '#22c55e' : '#dc2626'};">
                                ${isCorrect ? 'Correcto!' : 'Incorrecto'}
                            </span>
                            <span style="color: #ccc; margin-left: 8px;">
                                La respuesta es: <strong>${this.currentQuizQuestion.a}</strong>
                                ${this.quizStreak >= 3 ? ` | Racha de ${this.quizStreak}! (+${this.quizStreak * 5} bonus)` : ''}
                            </span>
                        </div>
                    `;
                }
            },

            // ========== NIVEL 11 - ACORDES EXTENDIDOS ==========

            showExtendedChord() {
                this.resetState();
                this.hideUIElements();

                const rootName = MusicTheory.getNoteName(this.currentRoot);
                const ext = this.currentExtension;
                const qual = this.currentExtQuality;

                // Map quality+extension to chord key
                const chordMap = {
                    'maj-9': 'maj9', 'dom-9': 'dom9', 'min-9': 'min9', 'alt-9': '7#9',
                    'maj-11': 'maj11', 'dom-11': 'dom11', 'min-11': 'min11', 'alt-11': 'min11',
                    'maj-13': 'maj13', 'dom-13': 'dom13', 'min-13': 'min13', 'alt-13': 'dom13',
                };
                const altMap = {
                    'alt-9': '7#9',
                };

                const chordKey = altMap[`${qual}-${ext}`] || chordMap[`${qual}-${ext}`] || 'dom9';
                const chordData = MusicTheory.extendedChords[chordKey];

                if (!chordData) return;

                // Show notes on fretboard
                Fretboard.tonicNote = this.currentRoot;
                Fretboard.currentScale = chordData.intervals.map((interval, i) => ({
                    note: MusicTheory.getNoteName(this.currentRoot + interval),
                    degree: i + 1
                }));
                Fretboard.highlightedNotes.clear();
                Fretboard.clearZone();
                Fretboard.specificPositions = null;
                Fretboard.updateDisplay();

                // Show voicing diagram if available
                const voicingMap = {
                    'maj9': 'maj9_A', 'min9': 'min9_A', 'dom9': 'dom9_E',
                    '7#9': '7#9_E', '7b9': '7b9_E', 'min11': 'min11_A',
                    'dom11': 'dom11_A', 'maj11': 'maj11_A', 'maj13': 'maj13_A', 'dom13': 'dom13_E',
                };
                const voicingKey = voicingMap[chordKey];
                const voicing = voicingKey ? MusicTheory.extendedVoicings[voicingKey] : null;

                const diagramContainer = document.getElementById('diagramsContainer');
                if (voicing && diagramContainer) {
                    diagramContainer.innerHTML = '';
                    diagramContainer.classList.remove('hidden');
                    const isAShape = voicingKey.includes('_A');
                    const baseNote = isAShape ? 9 : 4;
                    const position = (this.currentRoot - baseNote + 12) % 12;
                    const chordName = `${rootName}${chordData.symbol}`;
                    const diagram = ChordDiagram.create({ frets: voicing.frets, fingers: null, barreInfo: null }, chordName, position);
                    diagramContainer.appendChild(diagram);
                }

                this.updateDisplay(
                    `${rootName} ${chordData.name}`,
                    `Frmula: ${chordData.formula} | Notas: ${chordData.intervals.map(i => MusicTheory.getNoteName(this.currentRoot + i)).join(' - ')}`
                );

                // Info panel
                const panel = document.getElementById('infoPanel');
                if (panel) {
                    const tensionInfo = {
                        '9': 'La 9 aade color y amplitud. Disponible en acordes mayores, menores y dominantes.',
                        '11': 'La 11 aade suspensin. En acordes mayores suele ser "evitada" (tensin #11 es preferida = Lidio).',
                        '13': 'La 13 aade riqueza. En dominantes, aporta un color dulce pre-resolucin.',
                    };
                    const qualInfo = {
                        'maj': 'Sonido sofisticado, brillante. Comn en jazz, bossa nova, neo-soul.',
                        'dom': 'Sonido con tensin dominante. Perfecto para resoluciones VI con color.',
                        'min': 'Sonido melanclico pero rico. Esencial en jazz modal y R&B.',
                        'alt': 'Sonido extremadamente tenso. Dominantes alterados con #9/b9 para mxima resolucin.',
                    };
                    const degreeNames = ['1', '3', '5', '7', '9', '11', '13'];
                    const extensionDegrees = ['7', '9', '11', '13'];
                    panel.innerHTML = `
                        <div class="scale-info-box">
                            <div class="info-header">
                                <div class="info-title">${chordData.name}</div>
                                <div class="info-emotion">${chordData.formula}</div>
                            </div>
                            <div class="info-section" style="margin-top: 12px;">
                                <div class="info-label" style="font-size: 14px; margin-bottom: 8px;">Notas del acorde</div>
                                <div class="flex flex-wrap gap-4 mt-2">
                                    ${chordData.intervals.map((interval, i) => {
                                        const noteName = MusicTheory.getNoteName(this.currentRoot + interval);
                                        const degree = degreeNames[i] || '';
                                        const isRoot = i === 0;
                                        const isExtension = extensionDegrees.includes(degree);
                                        const bgStyle = isRoot
                                            ? 'background: linear-gradient(135deg, #dc2626, #991b1b); border-color: #dc2626;'
                                            : 'background: #1a1a1a; border-color: ' + (isExtension ? '#d4a574' : '#333') + ';';
                                        return `<div style="padding: 14px 18px; ${bgStyle} border: 2px solid; border-radius: 10px; text-align: center; min-width: 60px;">
                                            <div style="font-family: 'Bebas Neue', sans-serif; font-size: 24px; font-weight: 400; color: #fafafa; line-height: 1;">${noteName}</div>
                                            <div style="font-size: 12px; color: ${isExtension ? '#d4a574' : '#888'}; margin-top: 4px; font-weight: ${isExtension ? '700' : '400'};">${degree}</div>
                                        </div>`;
                                    }).join('')}
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4" style="margin-top: 16px;">
                                <div class="info-section accent">
                                    <div class="info-label" style="font-size: 14px;">Sobre la extensin ${ext}</div>
                                    <div class="info-description" style="color: #ccc; font-size: 14px; line-height: 1.5;">${tensionInfo[ext] || ''}</div>
                                </div>
                                <div class="info-section">
                                    <div class="info-label" style="font-size: 14px;">Calidad: ${qual}</div>
                                    <div class="info-description" style="color: #ccc; font-size: 14px; line-height: 1.5;">${qualInfo[qual] || ''}</div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            },

            // ========== NIVEL 12 - DOMINANTES SECUNDARIOS ==========

            showSecondaryDominant() {
                this.hideUIElements();

                if (!this.currentSecondary) {
                    this.currentSecondary = 'ii';
                }

                const rootName = MusicTheory.getNoteName(this.currentRoot);
                const secDom = MusicTheory.secondaryDominants[this.currentSecondary];
                if (!secDom) return;

                // Calculate the secondary dominant root
                const secDomRoot = (this.currentRoot + secDom.rootOffset) % 12;
                const secDomRootName = MusicTheory.getNoteName(secDomRoot);

                // Calculate target chord root
                const scale = MusicTheory.getScale(this.currentRoot, 'major');
                const targetRoot = scale[secDom.target - 1].note;
                const targetRootIndex = MusicTheory.getNoteIndex(targetRoot);

                // Show dominant 7 chord on fretboard
                const dom7intervals = [0, 4, 7, 10]; // dom7
                Fretboard.tonicNote = secDomRoot;
                Fretboard.currentScale = dom7intervals.map((interval, i) => ({
                    note: MusicTheory.getNoteName(secDomRoot + interval),
                    degree: i + 1
                }));
                Fretboard.highlightedNotes.clear();
                Fretboard.clearZone();
                Fretboard.specificPositions = null;
                Fretboard.updateDisplay();

                // Show chord diagrams (dominante + resolucin lado a lado)
                const diagramContainer = document.getElementById('diagramsContainer');
                diagramContainer.innerHTML = '';
                diagramContainer.classList.remove('hidden');

                const pairContainer = document.createElement('div');
                pairContainer.className = 'flex items-center gap-4';
                pairContainer.style.justifyContent = 'center';
                pairContainer.style.flexWrap = 'wrap';

                // Dominante
                const domWrapper = document.createElement('div');
                domWrapper.className = 'chord-wrapper dominant-wrapper';
                const domVoicing = MusicTheory.seventhVoicings['dom7_E'];
                const domPosition = (secDomRoot - 4 + 12) % 12;
                const domDiagram = ChordDiagram.create(domVoicing, `${secDomRootName}7`, domPosition);
                domWrapper.appendChild(domDiagram);

                const domLabel = document.createElement('div');
                domLabel.textContent = 'Dominante Secundario';
                domLabel.style.cssText = 'text-align: center; font-size: 12px; color: #d97706; margin-top: 8px; font-weight: 600;';
                domWrapper.appendChild(domLabel);

                // Flecha
                const arrow = document.createElement('div');
                arrow.innerHTML = '';
                arrow.style.cssText = 'font-size: 48px; color: #dc2626; font-weight: bold;';

                // Resolucin (acorde objetivo)
                const targetQuality = secDom.target === 2 || secDom.target === 3 || secDom.target === 6 ? 'm' : '';
                const targetWrapper = document.createElement('div');
                targetWrapper.className = 'chord-wrapper target-wrapper';

                // Obtener voicing para el acorde objetivo
                let targetVoicing;
                if (targetQuality === 'm') {
                    targetVoicing = MusicTheory.chordVoicings['E_shape_minor'];
                } else {
                    targetVoicing = MusicTheory.chordVoicings['E_shape_major'];
                }
                const targetPosition = (targetRootIndex - 4 + 12) % 12;
                const targetDiagram = ChordDiagram.create(targetVoicing, `${targetRoot}${targetQuality}`, targetPosition);
                targetWrapper.appendChild(targetDiagram);

                const targetLabel = document.createElement('div');
                targetLabel.textContent = 'Resolucin';
                targetLabel.style.cssText = 'text-align: center; font-size: 12px; color: #22c55e; margin-top: 8px; font-weight: 600;';
                targetWrapper.appendChild(targetLabel);

                pairContainer.appendChild(domWrapper);
                pairContainer.appendChild(arrow);
                pairContainer.appendChild(targetWrapper);

                diagramContainer.appendChild(pairContainer);

                // Example in current key
                const exampleInKey = `${secDomRootName}7  ${targetRoot}${secDom.target === 6 || secDom.target === 2 || secDom.target === 3 ? 'm' : ''}`;

                this.updateDisplay(
                    `${secDom.roman} en ${rootName} Mayor`,
                    `${secDom.name}: ${exampleInKey} | Dominante que resuelve al grado ${this.currentSecondary}`
                );

                // Info panel
                const panel = document.getElementById('infoPanel');
                if (panel) {
                    const targetQuality = secDom.target === 2 || secDom.target === 3 || secDom.target === 6 ? 'm' : '';
                    panel.innerHTML = `
                        <div class="scale-info-box">
                            <div class="info-header">
                                <div class="info-title">${secDom.roman}  ${secDom.name}</div>
                                <div class="info-emotion">Dominante Secundario en ${rootName} Mayor</div>
                            </div>
                            <div class="flex items-center justify-center gap-4 my-6">
                                <div class="sec-dom-chord dominant">
                                    <div style="font-family: 'Bebas Neue'; font-size: 24px; color: #d97706;">${secDomRootName}7</div>
                                    <div style="font-size: 10px; color: #888;">${secDom.roman}</div>
                                </div>
                                <div class="sec-dom-arrow"></div>
                                <div class="sec-dom-chord target">
                                    <div style="font-family: 'Bebas Neue'; font-size: 24px; color: #22c55e;">${targetRoot}${targetQuality}</div>
                                    <div style="font-size: 10px; color: #888;">${this.currentSecondary}</div>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="info-section accent">
                                    <div class="info-label">Qu es?</div>
                                    <div class="info-description" style="color: #ccc;">
                                        Un dominante secundario es un acorde V7 que resuelve a un grado
                                        que no es el I. Crea tensin momentnea "prestada" de otra tonalidad.
                                    </div>
                                </div>
                                <div class="info-section">
                                    <div class="info-label">Efecto armnico</div>
                                    <div class="info-description" style="color: #ccc;">
                                        ${secDomRootName}7 contiene un tritono que resuelve naturalmente
                                        a ${targetRoot}${targetQuality}. Es como hacer una mini-modulacin
                                        temporal al grado ${this.currentSecondary}.
                                    </div>
                                </div>
                            </div>
                            <div class="info-section" style="margin-top: 12px;">
                                <div class="info-label">Notas del ${secDomRootName}7</div>
                                <div class="flex flex-wrap gap-3 mt-2">
                                    ${dom7intervals.map((interval, i) => {
                                        const noteName = MusicTheory.getNoteName(secDomRoot + interval);
                                        const names = ['1 (Raz)', '3 Mayor', '5 Justa', '7 menor'];
                                        return `<div style="padding: 8px 14px; background: ${i === 0 ? '#dc2626' : '#1a1a1a'}; border: 2px solid ${i === 0 ? '#dc2626' : '#333'}; border-radius: 8px; text-align: center;">
                                            <div style="font-family: 'IBM Plex Mono'; font-size: 14px; font-weight: 700; color: #fafafa;">${noteName}</div>
                                            <div style="font-size: 10px; color: #888; margin-top: 2px;">${names[i]}</div>
                                        </div>`;
                                    }).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                }
            },

            showSecondaryProgression() {
                if (!this.currentSecProg) return;
                const prog = MusicTheory.secondaryProgressions[this.currentSecProg - 1];
                if (!prog) return;

                this.hideUIElements();
                const rootName = MusicTheory.getNoteName(this.currentRoot);
                const scale = MusicTheory.getScale(this.currentRoot, 'major');

                // Build chords
                const degreeMap = {
                    'I': { root: 0, quality: '' },
                    'ii': { root: 1, quality: 'm' },
                    'iii': { root: 2, quality: 'm' },
                    'IV': { root: 3, quality: '' },
                    'V': { root: 4, quality: '' },
                    'vi': { root: 5, quality: 'm' },
                    'V/ii': { root: -1, quality: '7', secTarget: 'ii' },
                    'V/iii': { root: -1, quality: '7', secTarget: 'iii' },
                    'V/IV': { root: -1, quality: '7', secTarget: 'IV' },
                    'V/V': { root: -1, quality: '7', secTarget: 'V' },
                    'V/vi': { root: -1, quality: '7', secTarget: 'vi' },
                };

                const chordNames = prog.degrees.map(deg => {
                    const info = degreeMap[deg];
                    if (!info) return deg;
                    if (info.secTarget) {
                        const secDom = MusicTheory.secondaryDominants[info.secTarget];
                        const secRoot = MusicTheory.getNoteName((this.currentRoot + secDom.rootOffset) % 12);
                        return `${secRoot}${info.quality}`;
                    }
                    return `${scale[info.root].note}${info.quality}`;
                });

                this.updateDisplay(
                    `${prog.name} en ${rootName}`,
                    `${prog.description} | ${chordNames.join('  ')}`
                );

                // Show in info panel
                const panel = document.getElementById('infoPanel');
                if (panel) {
                    panel.innerHTML = `
                        <div class="scale-info-box">
                            <div class="info-header">
                                <div class="info-title">${prog.name}</div>
                                <div class="info-emotion">${prog.description}</div>
                            </div>
                            <div class="flex flex-wrap items-center justify-center gap-3 my-6">
                                ${prog.degrees.map((deg, i) => {
                                    const isSecondary = deg.startsWith('V/');
                                    const chord = chordNames[i];
                                    return `
                                        ${i > 0 ? '<div class="sec-dom-arrow"></div>' : ''}
                                        <div class="sec-dom-chord ${isSecondary ? 'dominant' : deg === 'I' ? 'target' : ''}">
                                            <div style="font-family: 'Bebas Neue'; font-size: 22px; color: ${isSecondary ? '#d97706' : '#fafafa'};">${chord}</div>
                                            <div style="font-size: 10px; color: #888;">${deg}</div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                }

                Fretboard.showScale(this.currentRoot, 'major');
            },

            // ========== NIVEL 13 - CANCIONES ==========

            showSongs() {
                this.resetState();
                this.hideUIElements();
                this.updateDisplay('BIBLIOTECA DE CANCIONES', 'Analiza la teora detrs de canciones reales');
                this.renderSongList();
            },

            renderSongList() {
                const panel = document.getElementById('infoPanel');
                if (!panel) return;

                let songs = [...MusicTheory.songs];

                // Filter by genre
                if (this.songGenreFilter !== 'all') {
                    const genreMap = {
                        'metal': ['Thrash Metal', 'Heavy Metal', 'Groove Metal', 'Nu Metal'],
                        'prog': ['Rock Progresivo', 'Metal Progresivo'],
                        'rock': ['Hard Rock', 'Rock', 'Grunge', 'Alternative'],
                        'blues': ['Blues', 'Blues Rock'],
                        'jazz': ['Jazz', 'Bossa Nova', 'Cool Jazz'],
                        'funk': ['Funk', 'Soul', 'Funk/Soul'],
                        'pop': ['Pop', 'Pop Rock', 'Soft Rock'],
                        'latin': ['Flamenco', 'Latin', 'Latin Rock'],
                        'country': ['Country', 'Country Rock'],
                        'reggae': ['Reggae'],
                    };
                    const genres = genreMap[this.songGenreFilter] || [];
                    songs = songs.filter(s => genres.includes(s.genre));
                }

                const genreColor = (genre) => {
                    if (genre.includes('Metal') || genre.includes('Nu')) return 'metal';
                    if (genre.includes('Progresivo')) return 'prog';
                    if (genre.includes('Blues')) return 'blues';
                    if (genre.includes('Jazz') || genre.includes('Bossa') || genre.includes('Cool')) return 'jazz';
                    if (genre.includes('Funk') || genre.includes('Soul')) return 'funk';
                    if (genre.includes('Pop') || genre.includes('Soft')) return 'pop';
                    if (genre.includes('Flamenco') || genre.includes('Latin')) return 'latin';
                    if (genre.includes('Country')) return 'country';
                    if (genre.includes('Reggae')) return 'reggae';
                    if (genre.includes('Grunge') || genre.includes('Alternative')) return 'grunge';
                    return 'rock';
                };

                panel.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        ${songs.map((song, i) => `
                            <div class="song-card ${this.currentSong === i ? 'active' : ''}" data-song="${i}">
                                <div class="flex items-start justify-between mb-2">
                                    <div>
                                        <div style="font-family: 'Barlow Condensed'; font-size: 17px; font-weight: 700; color: #fafafa; text-transform: uppercase;">${song.name}</div>
                                        <div style="font-size: 13px; color: #888;">${song.artist}</div>
                                    </div>
                                    <span class="genre-badge ${genreColor(song.genre)}">${song.genre}</span>
                                </div>
                                <div class="flex items-center justify-between mt-3">
                                    <div style="font-family: 'IBM Plex Mono'; font-size: 12px; color: #666;">
                                        ${MusicTheory.getNoteName(song.key)} ${song.mode === 'major' ? 'Mayor' : 'menor'}
                                    </div>
                                </div>
                                <div style="font-family: 'IBM Plex Mono'; font-size: 11px; color: #555; margin-top: 6px;">
                                    ${song.progressionChords.join('  ')}
                                </div>
                            </div>
                        `).join('')}
                        ${songs.length === 0 ? '<div style="color: #666; grid-column: 1/-1; text-align: center; padding: 40px;">No hay canciones con estos filtros</div>' : ''}
                    </div>
                `;

                // Bind card clicks
                panel.querySelectorAll('.song-card').forEach(card => {
                    card.addEventListener('click', () => {
                        const songIndex = parseInt(card.dataset.song);
                        this.currentSong = songIndex;
                        panel.querySelectorAll('.song-card').forEach(c => c.classList.remove('active'));
                        card.classList.add('active');
                        this.showSongDetail(MusicTheory.songs[songIndex]);
                    });
                });
            },

            showSongDetail(song) {
                const rootName = MusicTheory.getNoteName(song.key);
                const scaleType = song.scale || 'minor';

                // Show scale on fretboard
                Fretboard.showScale(song.key, scaleType);

                this.updateDisplay(
                    `${song.name}  ${song.artist}`,
                    `${rootName} ${song.mode === 'major' ? 'Mayor' : 'menor'} | ${song.genre} | ${song.progressionChords.join('  ')}`
                );

                // Show chord diagrams
                const diagramContainer = document.getElementById('diagramsContainer');
                if (diagramContainer && song.progressionChords[0] !== 'Instrumental') {
                    diagramContainer.innerHTML = '';
                    diagramContainer.classList.remove('hidden');

                    song.progressionChords.forEach(chordStr => {
                        const cleanName = chordStr.replace(/5$/, '').replace(/\/.*/, '');
                        const isMinor = cleanName.endsWith('m') || chordStr.includes('m');
                        const rootNote = cleanName.replace(/m$/, '').replace(/b$/, 'b');
                        const rootIdx = MusicTheory.getNoteIndex(rootNote);

                        let voicingKey = isMinor ? `${rootNote}m` : rootNote;
                        let voicing = MusicTheory.chordVoicings[voicingKey];
                        let position = 0;

                        if (!voicing) {
                            const shape = isMinor ? 'E_shape_minor' : 'E_shape_major';
                            voicing = MusicTheory.chordVoicings[shape];
                            position = (rootIdx - 4 + 12) % 12;
                        }

                        if (voicing) {
                            const diagram = ChordDiagram.create(voicing, chordStr, position);
                            diagram.style.display = 'inline-block';
                            diagram.style.margin = '0 8px';
                            diagramContainer.appendChild(diagram);
                        }
                    });
                }

                // Scroll detail into view with tips in info panel supplement
                const panel = document.getElementById('infoPanel');
                if (panel) {
                    // Keep the song cards, add detail below
                    const existing = panel.querySelector('.song-detail-box');
                    if (existing) existing.remove();

                    const detailBox = document.createElement('div');
                    detailBox.className = 'song-detail-box scale-info-box';
                    detailBox.style.marginTop = '20px';
                    detailBox.innerHTML = `
                        <div class="info-header">
                            <div class="info-title">${song.name}</div>
                            <div class="info-emotion">${song.artist}  ${song.genre}</div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="info-section accent">
                                <div class="info-label">Progresin</div>
                                <div class="info-value" style="font-size: 16px;">${song.progression.join('  ')}</div>
                                <div class="info-description" style="margin-top: 8px;">Acordes: ${song.progressionChords.join('  ')}</div>
                            </div>
                            <div class="info-section">
                                <div class="info-label">Escala Base</div>
                                <div class="info-value" style="font-size: 16px;">${rootName} ${App.SCALE_NAMES[scaleType] || scaleType}</div>
                            </div>
                        </div>
                        <div class="info-section" style="margin-top: 12px;">
                            <div class="info-label">Tips para tocar</div>
                            <div class="info-description" style="color: #ccc; font-size: 15px; line-height: 1.6;">${song.tips}</div>
                        </div>
                    `;
                    panel.appendChild(detailBox);
                }
            },

            // ========== LABORATORIO DE ESCALAS ==========

            initScaleLab() {
                this.renderScaleCategories();
                this.renderScaleList('major');
                this.populateCompareSelect();
            },

            renderScaleCategories() {
                const container = document.getElementById('scaleCategoryBtns');
                if (!container) return;
                // Usa CATEGORY_SCALES consolidado
            },

            renderScaleList(category) {
                const container = document.getElementById('scaleListContainer');
                if (!container) return;

                container.innerHTML = '';
                const scales = this.CATEGORY_SCALES[category] || [];

                scales.forEach(scaleKey => {
                    const info = MusicTheory.scaleInfo[scaleKey];
                    const item = document.createElement('div');
                    item.className = `scale-list-item ${scaleKey === this.currentLabScale ? 'active' : ''}`;
                    item.dataset.scale = scaleKey;

                    const name = info ? info.name : scaleKey;
                    const emotion = info ? info.emotion : '';

                    item.innerHTML = `
                        <div class="scale-name">${name}</div>
                        <div class="scale-emotion">${emotion}</div>
                    `;

                    item.addEventListener('click', () => {
                        document.querySelectorAll('.scale-list-item').forEach(i => i.classList.remove('active'));
                        item.classList.add('active');
                        this.currentLabScale = scaleKey;
                        this.showScaleInfo(scaleKey);
                        this.showScaleHarmonization(scaleKey);
                        this.updateComparison();
                    });

                    container.appendChild(item);
                });

                // Auto-select first scale if none selected
                if (scales.length > 0 && !scales.includes(this.currentLabScale)) {
                    this.currentLabScale = scales[0];
                    container.querySelector('.scale-list-item')?.classList.add('active');
                }

                this.showScaleInfo(this.currentLabScale);
                this.showScaleHarmonization(this.currentLabScale);
            },

            showScaleInfo(scaleKey) {
                const infoBox = document.getElementById('scaleInfoBox');
                if (!infoBox) return;

                const info = MusicTheory.scaleInfo[scaleKey];
                const formula = MusicTheory.scales[scaleKey];

                if (!info && !formula) {
                    infoBox.classList.add('hidden');
                    return;
                }

                infoBox.classList.remove('hidden');

                document.getElementById('scaleInfoName').textContent = info?.name || scaleKey;
                document.getElementById('scaleInfoCategory').textContent =
                    MusicTheory.scaleCategories[info?.category]?.name || info?.category || '';
                document.getElementById('scaleInfoFormula').textContent = info?.formula ||
                    formula.map(i => MusicTheory.intervalNames[i]).join(' - ');
                document.getElementById('scaleInfoEmotion').textContent = info?.emotion || '';
                document.getElementById('scaleInfoUsage').textContent = info?.usage || '';

                // Show parent info if exists
                const parentInfo = MusicTheory.getParentInfo(scaleKey);
                const parentSection = document.getElementById('scaleInfoParent');
                if (parentInfo) {
                    parentSection.classList.remove('hidden');
                    document.getElementById('scaleInfoParentText').textContent =
                        `${parentInfo.parentName} (grado ${parentInfo.degree})`;
                } else {
                    parentSection.classList.add('hidden');
                }
            },

            showScaleHarmonization(scaleKey) {
                const section = document.getElementById('scaleHarmonizationSection');
                const container = document.getElementById('scaleHarmonizationChords');
                if (!section || !container) return;

                const formula = MusicTheory.scales[scaleKey];

                // Only show for 7-note scales
                if (formula.length !== 7) {
                    section.classList.add('hidden');
                    return;
                }

                section.classList.remove('hidden');
                container.innerHTML = '';

                const harmonization = MusicTheory.getScaleHarmonization(this.currentRoot, scaleKey);
                const romanNumerals = ['I', 'II', 'III', 'IV', 'V', 'VI', 'VII'];
                const qualitySymbols = {
                    'maj': '', 'min': 'm', 'dim': '', 'aug': '+', 'sus2': 'sus2', 'sus4': 'sus4', '?': '?'
                };

                harmonization.forEach((chord, i) => {
                    const btn = document.createElement('button');
                    btn.className = `harm-chord-btn ${this.currentLabHarmChord === i ? 'active' : ''}`;
                    btn.innerHTML = `
                        <span>${chord.root}${qualitySymbols[chord.quality]}</span>
                        <span class="chord-quality">${romanNumerals[i]}${qualitySymbols[chord.quality]}</span>
                    `;
                    btn.addEventListener('click', () => {
                        document.querySelectorAll('.harm-chord-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        this.currentLabHarmChord = i;
                        this.showLabChord(chord);
                    });
                    container.appendChild(btn);
                });
            },

            showLabChord(chord) {
                const chordRootIndex = MusicTheory.getNoteIndex(chord.root);
                const qualityNames = { maj: 'Mayor', min: 'menor', dim: 'disminuido', aug: 'aumentado' };

                // Show on fretboard
                Fretboard.tonicNote = chordRootIndex;
                Fretboard.currentScale = [
                    { note: chord.root, degree: 1 },
                    { note: chord.third, degree: 3 },
                    { note: chord.fifth, degree: 5 }
                ];
                Fretboard.highlightedNotes.clear();
                Fretboard.clearZone();
                Fretboard.specificPositions = null;
                Fretboard.blueNoteIndex = null;
                Fretboard.updateDisplay();

                // Show chord diagram if possible
                const voicingKey = chord.quality === 'min' ? `${chord.root}m` : chord.root;
                let voicing = MusicTheory.chordVoicings[voicingKey];
                let position = 0;

                if (!voicing) {
                    const shape = chord.quality === 'min' ? 'E_shape_minor' : 'E_shape_major';
                    voicing = MusicTheory.chordVoicings[shape];
                    // Calculate position: distance from E (4) to target note
                    position = (chordRootIndex - 4 + 12) % 12;
                }

                const diagramContainer = document.getElementById('diagramsContainer');
                if (diagramContainer && voicing) {
                    diagramContainer.innerHTML = '';
                    diagramContainer.classList.remove('hidden');
                    const chordName = chord.quality === 'min' ? `${chord.root}m` : chord.root;
                    const diagram = ChordDiagram.create(voicing, chordName, position);
                    diagramContainer.appendChild(diagram);
                }

                const rootName = MusicTheory.getNoteName(this.currentRoot);
                const info = MusicTheory.scaleInfo[this.currentLabScale];
                document.getElementById('displayTitle').textContent =
                    `Acorde ${chord.degree} de ${rootName} ${info?.name || this.currentLabScale}`;
                document.getElementById('displaySubtitle').textContent =
                    `${chord.root} ${qualityNames[chord.quality] || chord.quality} | Notas: ${chord.root} - ${chord.third} - ${chord.fifth}`;
            },

            populateCompareSelect() {
                const select = document.getElementById('compareScaleSelect');
                if (!select) return;

                select.innerHTML = '<option value="">Selecciona para comparar...</option>';

                const categories = {
                    'Mayores': ['major'],
                    'Menores': ['minor', 'harmonicMinor', 'melodicMinor'],
                    'Modos': ['dorian', 'phrygian', 'lydian', 'mixolydian', 'locrian'],
                    'Pentatnicas': ['pentatonicMajor', 'pentatonicMinor', 'blues'],
                    'Simtricas': ['wholeTone', 'diminished'],
                    'Exticas': ['hungarian', 'byzantine', 'phrygianDom', 'japanese']
                };

                Object.entries(categories).forEach(([catName, scales]) => {
                    const optgroup = document.createElement('optgroup');
                    optgroup.label = catName;
                    scales.forEach(scaleKey => {
                        const info = MusicTheory.scaleInfo[scaleKey];
                        const option = document.createElement('option');
                        option.value = scaleKey;
                        option.textContent = info?.name || scaleKey;
                        optgroup.appendChild(option);
                    });
                    select.appendChild(optgroup);
                });

                select.addEventListener('change', (e) => {
                    this.compareScale = e.target.value || null;
                    this.updateComparison();
                });
            },

            updateComparison() {
                const resultDiv = document.getElementById('scaleComparisonResult');
                if (!resultDiv) return;

                if (!this.compareScale) {
                    resultDiv.classList.add('hidden');
                    return;
                }

                const comparison = MusicTheory.compareScales(this.currentLabScale, this.compareScale);
                resultDiv.classList.remove('hidden');

                document.getElementById('scaleSimilarity').textContent = `${comparison.similarity}%`;
                document.getElementById('scaleCommonNotes').textContent =
                    comparison.common.map(i => MusicTheory.intervalNames[i]).join(', ') || 'Ninguna';
                document.getElementById('scaleOnlyFirst').textContent =
                    comparison.onlyInFirst.map(i => MusicTheory.intervalNames[i]).join(', ') || 'Ninguna';
                document.getElementById('scaleOnlySecond').textContent =
                    comparison.onlyInSecond.map(i => MusicTheory.intervalNames[i]).join(', ') || 'Ninguna';
            },

            showScaleLab() {
                this.resetState();
                this.currentLabHarmChord = null;
                this.hideUIElements();

                const scaleSelect = document.getElementById('scaleSelect');
                if (scaleSelect) scaleSelect.value = this.currentLabScale;
                this.currentScale = this.currentLabScale;

                Fretboard.showScale(this.currentRoot, this.currentLabScale);

                const rootName = MusicTheory.getNoteName(this.currentRoot);
                const info = MusicTheory.scaleInfo[this.currentLabScale];
                const formula = MusicTheory.scales[this.currentLabScale];

                this.updateDisplay(
                    `${rootName} ${info?.name || this.currentLabScale}`,
                    `${formula.length} notas | ${info?.emotion || ''} | Frmula: ${formula.map(i => MusicTheory.intervalNames[i]).join('-')}`
                );
            },

            // ========== NIVEL 14 - EAR TRAINING ==========

            showEarTraining() {
                this.resetState();
                this.hideUIElements();
                this.earTrainingAnswered = false;

                // Generar intervalo aleatorio
                const intervals = MusicTheory.earTraining.intervals[this.earTrainingLevel];
                const randomInterval = intervals[Math.floor(Math.random() * intervals.length)];
                this.earTrainingCurrentInterval = randomInterval;

                // Generar nota raz aleatoria
                const randomRoot = Math.floor(Math.random() * 12);

                this.updateDisplay(
                    `EAR TRAINING - ${this.earTrainingLevel.toUpperCase()}`,
                    `Puntuacin: ${this.earTrainingScore} | Racha: ${this.earTrainingStreak} | Mejor: ${this.earTrainingBest}`
                );

                this.renderEarTrainingPanel();
            },

            renderEarTrainingPanel() {
                const panel = document.getElementById('earTrainingAnswers');
                if (!panel) return;

                const intervals = MusicTheory.earTraining.intervals[this.earTrainingLevel];
                panel.innerHTML = intervals.map(interval => `
                    <button class="mode-btn-simple"
                            onclick="app.checkEarTrainingAnswer(${interval.semitones})"
                            style="padding: 12px 8px; text-align: center; font-size: 13px; line-height: 1.3;"
                            ${this.earTrainingAnswered ? 'disabled' : ''}
                            title="${interval.tip || ''}">
                        <div style="font-weight: 600;">${interval.name}</div>
                        <div style="font-size: 10px; color: #999; margin-top: 2px;">${interval.semitones} semitonos</div>
                    </button>
                `).join('');
            },

            playCurrentInterval() {
                if (!this.earTrainingCurrentInterval) return;
                const randomRoot = Math.floor(Math.random() * 12);
                AudioEngine.playInterval(randomRoot, this.earTrainingCurrentInterval.semitones, 0.6, 4);
            },

            checkEarTrainingAnswer(semitones) {
                if (this.earTrainingAnswered) return;

                this.earTrainingAnswered = true;
                const correct = semitones === this.earTrainingCurrentInterval.semitones;

                if (correct) {
                    this.earTrainingScore += 10;
                    this.earTrainingStreak++;
                    if (this.earTrainingStreak > this.earTrainingBest) {
                        this.earTrainingBest = this.earTrainingStreak;
                    }

                    this.updateDisplay(
                        `CORRECTO! ${this.earTrainingCurrentInterval.name}`,
                        `Puntuacin: ${this.earTrainingScore} | Racha: ${this.earTrainingStreak} | Mejor: ${this.earTrainingBest}`
                    );
                } else {
                    this.earTrainingStreak = 0;
                    this.updateDisplay(
                        `Incorrecto. Era: ${this.earTrainingCurrentInterval.name}`,
                        `Puntuacin: ${this.earTrainingScore} | Racha: ${this.earTrainingStreak} | Mejor: ${this.earTrainingBest}`
                    );
                }

                // Auto-advance despus de 1.5s
                setTimeout(() => {
                    this.showEarTraining();
                }, 1500);
            },

            // ========== NIVEL 15 - JAM SESSION ==========

            showJamSession() {
                this.resetState();
                this.hideUIElements();

                if (!this.currentBackingTrack) {
                    this.currentBackingTrack = MusicTheory.backingTracks[0];
                }

                const track = this.currentBackingTrack;

                // Usar BPM custom o el del track
                const bpm = this.customBPM || track.bpm;

                // Mostrar escala recomendada en diapasn para CUALQUIER tonalidad
                Fretboard.showScale(this.currentRoot, track.scale);

                const rootName = MusicTheory.getNoteName(this.currentRoot);

                this.updateDisplay(
                    `${track.name} - ${rootName}`,
                    `${bpm} BPM | ${track.style} | Feel: ${track.feel} | Escala: ${this.SCALE_NAMES[track.scale]}`
                );

                this.renderJamSessionPanel(track, rootName, bpm);
            },

            renderJamSessionPanel(track, rootName, bpm) {
                const panel = document.getElementById('jamSessionInfo');
                if (!panel) return;

                const chordNames = track.progression.map(symbol => {
                    return `${rootName}${symbol}`;
                }).join('  ');

                panel.innerHTML = `
                    <div style="background: rgba(0,0,0,0.4); padding: 16px; border-radius: 4px; border: 1px solid rgba(220, 38, 38, 0.2);">
                        <div class="text-xs text-void-400 uppercase tracking-wider mb-3">Progresin Actual:</div>
                        <div style="font-size: 16px; font-weight: 600; margin-bottom: 12px; color: #dc2626;">${chordNames}</div>

                        <div class="grid grid-cols-2 gap-4 mb-3" style="font-size: 12px;">
                            <div>
                                <span class="text-void-400">Estilo:</span>
                                <span class="text-chalk-100 font-semibold ml-2">${track.style}</span>
                            </div>
                            <div>
                                <span class="text-void-400">Feel:</span>
                                <span class="text-chalk-100 font-semibold ml-2">${track.feel}</span>
                            </div>
                        </div>

                        <div style="color: #999; font-size: 13px; line-height: 1.5; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.1);">
                            ${track.description}
                        </div>
                    </div>
                `;
            },

            playBackingTrack() {
                // Primero detener cualquier track que est corriendo
                if (this.backingTrackPlaying) {
                    this.stopBackingTrack();
                }

                const track = this.currentBackingTrack;
                const bpm = this.syncMetronomeWithBacking ? this.globalBPM : (this.customBPM || track.bpm);
                this.backingTrackPlaying = true;

                // Resetear contadores
                this.jamCurrentBar = 0;
                this.jamLoopCount = 0;
                this.jamCurrentBeat = 0;

                // Mostrar panel de progreso
                const progressDisplay = document.getElementById('jamProgressDisplay');
                if (progressDisplay) {
                    progressDisplay.style.display = 'block';
                }

                // Callback para actualizar progreso visual
                const progressCallback = (data) => {
                    if (data.bar !== undefined) {
                        this.jamCurrentBar = data.bar;
                        this.jamLoopCount = data.loopCount || 0;
                        this.updateJamProgress();
                    }
                    if (data.beat !== undefined) {
                        this.jamCurrentBeat = data.beat;
                        this.updateBeatIndicator(data.beat);
                    }
                };

                // Iniciar secuenciador con o sin batera
                if (this.drumsEnabled) {
                    this.backingTrackIntervals = AudioEngine.playChordSequenceWithDrums(
                        track.progression,
                        bpm,
                        this.currentRoot,
                        track.feel.toLowerCase(),
                        progressCallback
                    );
                } else {
                    this.backingTrackIntervals = {
                        chords: AudioEngine.playChordSequence(
                            track.progression,
                            bpm,
                            this.currentRoot
                        ),
                        drums: null,
                        currentBar: 0
                    };
                }

                const playBtn = document.getElementById('playTrackBtn');
                if (playBtn) playBtn.disabled = true;
                const stopBtn = document.getElementById('stopTrackBtn');
                if (stopBtn) stopBtn.disabled = false;
            },

            updateJamProgress() {
                const track = this.currentBackingTrack;
                if (!track) return;

                const rootName = MusicTheory.getNoteName(this.currentRoot);
                const currentChordSymbol = track.progression[this.jamCurrentBar];
                const chordName = `${rootName}${currentChordSymbol}`;

                // Actualizar nombre del acorde
                const chordNameEl = document.getElementById('currentChordName');
                if (chordNameEl) chordNameEl.textContent = chordName;

                // Funcin armnica (simple)
                const chordFunction = currentChordSymbol.includes('I') ? 'Tnica' :
                                     currentChordSymbol.includes('IV') ? 'Subdominante' :
                                     currentChordSymbol.includes('V') ? 'Dominante' : 'Acorde';
                const functionEl = document.getElementById('currentChordFunction');
                if (functionEl) functionEl.textContent = `(${chordFunction})`;

                // Actualizar comps
                const barDisplay = document.getElementById('currentBarDisplay');
                if (barDisplay) {
                    barDisplay.textContent = `${this.jamCurrentBar + 1} / ${track.progression.length}`;
                }

                // Actualizar contador de loops
                const loopDisplay = document.getElementById('loopCountDisplay');
                if (loopDisplay) {
                    loopDisplay.textContent = this.jamLoopCount + 1;
                }

                // Barra de progreso
                const progressBar = document.getElementById('jamProgressBar');
                if (progressBar) {
                    const percentage = ((this.jamCurrentBar + 1) / track.progression.length) * 100;
                    progressBar.style.width = `${percentage}%`;
                }
            },

            updateBeatIndicator(beat) {
                const dots = document.querySelectorAll('.beat-dot');
                dots.forEach((dot, i) => {
                    if (i === beat) {
                        dot.style.background = i === 0 ? '#dc2626' : '#10b981'; // Beat 1 rojo, otros verde
                        dot.style.transform = 'scale(1.5)';
                        dot.style.boxShadow = `0 0 10px ${i === 0 ? '#dc2626' : '#10b981'}`;
                    } else {
                        dot.style.background = '#333';
                        dot.style.transform = 'scale(1)';
                        dot.style.boxShadow = 'none';
                    }
                });
            },

            async stopBackingTrack() {
                if (!this.backingTrackPlaying) return;

                // Fade out suave antes de detener
                if (AudioEngine.masterGain) {
                    const currentGain = AudioEngine.masterGain.gain.value;
                    const currentTime = AudioEngine.audioContext.currentTime;

                    AudioEngine.masterGain.gain.setValueAtTime(currentGain, currentTime);
                    AudioEngine.masterGain.gain.linearRampToValueAtTime(0.01, currentTime + 0.2);

                    await new Promise(resolve => setTimeout(resolve, 200));
                }

                if (this.backingTrackIntervals) {
                    if (this.backingTrackIntervals.chords) {
                        clearInterval(this.backingTrackIntervals.chords);
                    }
                    if (this.backingTrackIntervals.drums) {
                        clearInterval(this.backingTrackIntervals.drums);
                    }
                }

                this.backingTrackPlaying = false;
                this.backingTrackIntervals = null;

                // Ocultar panel de progreso
                const progressDisplay = document.getElementById('jamProgressDisplay');
                if (progressDisplay) {
                    progressDisplay.style.display = 'none';
                }

                // Restaurar volumen
                if (AudioEngine.masterGain) {
                    const currentTime = AudioEngine.audioContext.currentTime;
                    AudioEngine.masterGain.gain.setValueAtTime(0.01, currentTime);
                    AudioEngine.masterGain.gain.linearRampToValueAtTime(0.5, currentTime + 0.2);
                }

                const playBtn = document.getElementById('playTrackBtn');
                if (playBtn) playBtn.disabled = false;
                const stopBtn = document.getElementById('stopTrackBtn');
                if (stopBtn) stopBtn.disabled = true;
            },

            async changeBackingTrackBPM(newBPM) {
                if (!this.backingTrackPlaying) {
                    this.customBPM = newBPM;
                    return;
                }

                // Fade out gradual
                if (AudioEngine.masterGain) {
                    const currentGain = AudioEngine.masterGain.gain.value;
                    const currentTime = AudioEngine.audioContext.currentTime;

                    AudioEngine.masterGain.gain.setValueAtTime(currentGain, currentTime);
                    AudioEngine.masterGain.gain.linearRampToValueAtTime(0.01, currentTime + 0.2);

                    await new Promise(resolve => setTimeout(resolve, 200));
                }

                // Cambiar BPM y reiniciar
                await this.stopBackingTrack();
                this.customBPM = newBPM;
                this.playBackingTrack();

                // Fade in gradual
                if (AudioEngine.masterGain) {
                    const currentTime = AudioEngine.audioContext.currentTime;
                    AudioEngine.masterGain.gain.setValueAtTime(0.01, currentTime);
                    AudioEngine.masterGain.gain.linearRampToValueAtTime(0.5, currentTime + 0.2);
                }
            }
        };

        // Initialize app when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            AudioEngine.init();
            App.init();
        });
    </script>
</body>
</html>
