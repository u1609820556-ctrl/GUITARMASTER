<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guitar Theory Master</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Archivo+Black&family=IBM+Plex+Mono:wght@400;500;600;700&family=Barlow+Condensed:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        void: {
                            950: '#0a0a0a',
                            900: '#121212',
                            800: '#1a1a1a',
                            700: '#252525',
                            600: '#333333',
                            500: '#4a4a4a',
                            400: '#666666',
                            300: '#888888',
                        },
                        blood: {
                            400: '#dc2626',
                            500: '#b91c1c',
                            600: '#991b1b',
                        },
                        brass: {
                            400: '#d4a574',
                            500: '#c4956a',
                            600: '#a67c52',
                        },
                        chalk: {
                            100: '#fafafa',
                            200: '#e5e5e5',
                            300: '#cccccc',
                        }
                    },
                    fontFamily: {
                        'display': ['Bebas Neue', 'sans-serif'],
                        'heading': ['Archivo Black', 'sans-serif'],
                        'body': ['Barlow Condensed', 'sans-serif'],
                        'mono': ['IBM Plex Mono', 'monospace'],
                    }
                }
            }
        }
    </script>
    <style>
        :root {
            /* Studio Vinyl Modernist Palette */
            --vinyl-black: #0a0a0a;
            --studio-gray: #1a1a1a;
            --tape-red: #dc2626;
            --vumeter-green: #10b981;
            --steel: #404040;
            --chrome: #888888;
            --paper: #fafafa;
            --key-highlight: #eab308;
            --chord-active: #3b82f6;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Barlow Condensed', sans-serif;
            background: #0a0a0a;
            color: #e5e5e5;
            min-height: 100vh;
            overflow-x: hidden;
            letter-spacing: 0.02em;
        }

        /* Noise texture overlay */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            opacity: 0.035;
            z-index: 9999;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 400 400' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
        }

        /* Custom scrollbar - industrial */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #121212;
            border-left: 1px solid #252525;
        }
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #dc2626 0%, #991b1b 100%);
            border: 1px solid #0a0a0a;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #ef4444 0%, #b91c1c 100%);
        }

        /* Fretboard styles - dark rosewood industrial with rounded */
        .fretboard-container {
            background: linear-gradient(180deg, #1a1412 0%, #0d0a08 100%);
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid #333;
            box-shadow:
                inset 0 0 60px rgba(0,0,0,0.8),
                0 0 0 1px #0a0a0a,
                0 20px 60px rgba(0,0,0,0.7);
        }

        .fretboard-container::before {
            content: '';
            position: absolute;
            inset: 0;
            background-image:
                url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='5' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E"),
                repeating-linear-gradient(90deg, transparent 0px, transparent 40px, rgba(0,0,0,0.1) 40px, rgba(0,0,0,0.1) 41px);
            opacity: 0.12;
            pointer-events: none;
        }

        .string {
            position: relative;
            display: flex;
            align-items: center;
            height: 42px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.02);
        }

        .string::before {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            top: 50%;
            height: 2px;
            background: linear-gradient(90deg,
                rgba(200, 180, 160, 0.2) 0%,
                rgba(220, 200, 180, 0.7) 8%,
                rgba(200, 180, 160, 0.5) 50%,
                rgba(180, 160, 140, 0.3) 100%
            );
            transform: translateY(-50%);
            box-shadow: 0 1px 3px rgba(0,0,0,0.6);
        }

        .string:nth-child(1)::before { height: 1px; opacity: 0.85; }
        .string:nth-child(2)::before { height: 1.5px; opacity: 0.8; }
        .string:nth-child(3)::before { height: 2px; opacity: 0.75; }
        .string:nth-child(4)::before { height: 2.5px; opacity: 0.7; background: linear-gradient(90deg, rgba(180, 165, 150, 0.2) 0%, rgba(190, 175, 160, 0.65) 8%, rgba(170, 155, 140, 0.45) 50%, rgba(160, 145, 130, 0.25) 100%); }
        .string:nth-child(5)::before { height: 3px; opacity: 0.65; background: linear-gradient(90deg, rgba(160, 150, 140, 0.2) 0%, rgba(170, 160, 150, 0.55) 8%, rgba(150, 140, 130, 0.35) 50%, rgba(140, 130, 120, 0.18) 100%); }
        .string:nth-child(6)::before { height: 3.5px; opacity: 0.6; background: linear-gradient(90deg, rgba(150, 140, 130, 0.2) 0%, rgba(160, 150, 140, 0.45) 8%, rgba(140, 130, 120, 0.28) 50%, rgba(130, 120, 110, 0.15) 100%); }

        .fret {
            position: relative;
            flex: 1;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            border-right: 3px solid #555;
            box-shadow: inset -2px 0 6px rgba(0,0,0,0.4), inset 2px 0 4px rgba(255,255,255,0.02);
        }

        .fret:first-child {
            flex: 0.6;
            background: linear-gradient(90deg, #f0ead6 0%, #d8cdb8 50%, #c4b89a 100%);
            border-right: 6px solid #1a1a1a;
            box-shadow: inset -4px 0 10px rgba(0,0,0,0.5), 4px 0 12px rgba(0,0,0,0.4);
        }

        .fret-marker {
            position: absolute;
            bottom: -30px;
            left: 50%;
            transform: translateX(-50%);
            width: 12px;
            height: 12px;
            background: radial-gradient(circle, #e8e0d0 0%, #b8a888 100%);
            border-radius: 50%;
            opacity: 0.8;
            box-shadow: 0 2px 4px rgba(0,0,0,0.4);
        }

        .note-bubble {
            position: relative;
            z-index: 10;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 12px;
            font-weight: 700;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            opacity: 0;
            transform: scale(0);
            text-transform: uppercase;
        }

        .note-bubble.visible {
            opacity: 1;
            transform: scale(1);
        }

        .note-bubble.tonic {
            background: #dc2626;
            color: #fafafa;
            box-shadow:
                0 0 0 3px #0a0a0a,
                0 0 20px rgba(220, 38, 38, 0.6),
                0 4px 15px rgba(0,0,0,0.4);
            border: none;
        }

        .note-bubble.interval {
            background: #fafafa;
            color: #0a0a0a;
            box-shadow:
                0 0 0 2px #0a0a0a,
                0 4px 12px rgba(0,0,0,0.4);
            border: none;
        }

        .note-bubble.other {
            background: #444;
            color: #bbb;
            box-shadow:
                0 2px 8px rgba(0,0,0,0.3);
            border: none;
        }

        .note-bubble:hover {
            transform: scale(1.2);
            z-index: 20;
        }

        /* Finger badge on note bubbles */
        .finger-badge {
            position: absolute;
            bottom: -8px;
            right: -8px;
            width: 18px;
            height: 18px;
            background: #3b82f6;
            color: #fff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 700;
            border: 2px solid #0a0a0a;
            box-shadow: 0 2px 6px rgba(0,0,0,0.4);
            z-index: 15;
        }

        /* CAGED position highlights */
        .fret.caged-c {
            background: rgba(220, 38, 38, 0.1);
            border-left: 3px solid #dc2626;
        }

        .fret.caged-a {
            background: rgba(234, 88, 12, 0.1);
            border-left: 3px solid #ea580c;
        }

        .fret.caged-g {
            background: rgba(234, 179, 8, 0.1);
            border-left: 3px solid #eab308;
        }

        .fret.caged-e {
            background: rgba(34, 197, 94, 0.1);
            border-left: 3px solid #22c55e;
        }

        .fret.caged-d {
            background: rgba(59, 130, 246, 0.1);
            border-left: 3px solid #3b82f6;
        }

        /* CAGED SVG node styles */
        .caged-node {
            transition: all 0.3s ease;
        }

        .caged-node:hover circle {
            filter: brightness(1.2);
            cursor: pointer;
        }

        .caged-node.active circle {
            stroke: #84cc16 !important;
            stroke-width: 4 !important;
        }

        .caged-connection {
            transition: all 0.3s ease;
        }

        .caged-connection:hover {
            stroke: #94a3b8 !important;
            stroke-width: 3 !important;
            cursor: pointer;
        }

        /* Position marker label */
        .position-marker {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            font-weight: 700;
            font-family: 'IBM Plex Mono', monospace;
            padding: 4px 8px;
            border-radius: 4px;
            white-space: nowrap;
            z-index: 5;
        }

        .position-marker.caged-c {
            background: #dc2626;
            color: #fff;
        }

        .position-marker.caged-a {
            background: #ea580c;
            color: #fff;
        }

        .position-marker.caged-g {
            background: #eab308;
            color: #000;
        }

        .position-marker.caged-e {
            background: #22c55e;
            color: #000;
        }

        .position-marker.caged-d {
            background: #3b82f6;
            color: #fff;
        }

        /* Picking direction animations */
        @keyframes pickDown {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(5px); }
        }

        @keyframes pickUp {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .note-bubble.pick-down {
            animation: pickDown 0.3s ease-in-out;
        }

        .note-bubble.pick-up {
            animation: pickUp 0.3s ease-in-out;
        }

        /* Level cards - industrial with rounded */
        .level-card {
            background: #121212;
            border: 2px solid #252525;
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.2s ease;
        }

        .level-card:hover {
            border-color: #444;
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
        }

        .level-card.active {
            border-color: #dc2626;
            box-shadow: 0 0 30px rgba(220, 38, 38, 0.2);
        }

        .level-header {
            padding: 16px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: background 0.2s ease;
            border-left: 4px solid transparent;
        }

        .level-header:hover {
            background: rgba(255,255,255,0.03);
            border-left-color: #dc2626;
        }

        .level-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease;
        }

        .level-card.expanded .level-content {
            max-height: 2000px;
        }

        .level-badge {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Bebas Neue', sans-serif;
            font-weight: 400;
            font-size: 18px;
            letter-spacing: 1px;
        }

        /* Buttons - industrial with rounded */
        .btn-primary {
            background: #dc2626;
            color: #fafafa;
            padding: 12px 24px;
            border-radius: 10px;
            font-family: 'Bebas Neue', sans-serif;
            font-weight: 400;
            font-size: 16px;
            letter-spacing: 2px;
            text-transform: uppercase;
            border: 2px solid #dc2626;
            cursor: pointer;
            transition: all 0.15s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .btn-primary:hover {
            background: transparent;
            color: #dc2626;
            transform: translateY(-2px);
            box-shadow: 0 0 20px rgba(220, 38, 38, 0.3);
        }

        .btn-secondary {
            background: transparent;
            color: #e5e5e5;
            padding: 10px 18px;
            border-radius: 8px;
            font-family: 'Barlow Condensed', sans-serif;
            font-weight: 600;
            font-size: 14px;
            letter-spacing: 1px;
            text-transform: uppercase;
            border: 2px solid #444;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .btn-secondary:hover {
            border-color: #dc2626;
            color: #dc2626;
        }

        /* Select dropdown - industrial with rounded */
        .custom-select {
            appearance: none;
            background: #1a1a1a;
            border: 2px solid #333;
            border-radius: 10px;
            padding: 12px 44px 12px 16px;
            color: #fafafa;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23dc2626'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 18px;
            transition: all 0.15s ease;
        }

        .custom-select:hover {
            border-color: #555;
        }

        .custom-select:focus {
            outline: none;
            border-color: #dc2626;
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.15);
        }

        /* Toggle switch - industrial with rounded */
        .toggle-switch {
            position: relative;
            width: 48px;
            height: 26px;
            background: #252525;
            border-radius: 13px;
            border: 2px solid #333;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .toggle-switch.active {
            background: #dc2626;
            border-color: #dc2626;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 18px;
            height: 18px;
            background: #fafafa;
            border-radius: 50%;
            transition: transform 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .toggle-switch.active::after {
            transform: translateX(22px);
        }

        /* Interval buttons - industrial with rounded */
        .interval-btn {
            padding: 10px 16px;
            border-radius: 8px;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 13px;
            font-weight: 600;
            border: 2px solid #333;
            background: #1a1a1a;
            color: #999;
            cursor: pointer;
            transition: all 0.15s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .interval-btn:hover {
            border-color: #666;
            color: #fafafa;
            background: #252525;
        }

        .interval-btn.active {
            background: #fafafa;
            color: #0a0a0a;
            border-color: #fafafa;
            font-weight: 700;
        }

        /* Chord button - industrial with rounded */
        .chord-btn {
            padding: 14px 18px;
            border-radius: 10px;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 13px;
            font-weight: 500;
            border: 2px solid #333;
            background: #151515;
            color: #ccc;
            cursor: pointer;
            transition: all 0.15s ease;
            text-align: center;
            min-width: 70px;
        }

        .chord-btn:hover {
            border-color: #dc2626;
            color: #fafafa;
            background: #1a1a1a;
            transform: translateY(-2px);
        }

        .chord-btn.active {
            background: #dc2626;
            color: #fafafa;
            border-color: #dc2626;
            box-shadow: 0 0 20px rgba(220, 38, 38, 0.3);
        }

        .chord-btn .roman {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 22px;
            font-weight: 400;
            display: block;
            margin-bottom: 4px;
            letter-spacing: 1px;
        }

        .chord-btn .name {
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 11px;
            opacity: 0.7;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Mode button - industrial with rounded */
        .mode-btn {
            padding: 14px 18px;
            border-radius: 10px;
            border: 2px solid #333;
            border-left: 4px solid #444;
            background: #151515;
            color: #ccc;
            cursor: pointer;
            transition: all 0.15s ease;
            text-align: left;
        }

        .mode-btn:hover {
            border-color: #d4a574;
            border-left-color: #d4a574;
            background: #1a1a1a;
            transform: translateX(4px);
        }

        .mode-btn.active {
            border-color: #d4a574;
            border-left-color: #d4a574;
            background: rgba(212, 165, 116, 0.1);
        }

        .mode-btn .mode-name {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 20px;
            color: #d4a574;
            margin-bottom: 4px;
            letter-spacing: 1px;
        }

        .mode-btn .mode-degree {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Animations - sharper, more industrial */
        @keyframes pulse-glow {
            0%, 100% {
                box-shadow:
                    0 0 0 2px #0a0a0a,
                    0 0 0 4px #dc2626,
                    0 4px 20px rgba(220, 38, 38, 0.5);
            }
            50% {
                box-shadow:
                    0 0 0 2px #0a0a0a,
                    0 0 0 6px #dc2626,
                    0 4px 30px rgba(220, 38, 38, 0.7);
            }
        }

        .note-bubble.tonic.pulse {
            animation: pulse-glow 1.5s ease-in-out infinite;
        }

        @keyframes fade-in-up {
            from {
                opacity: 0;
                transform: translateY(15px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in-up {
            animation: fade-in-up 0.3s ease-out forwards;
        }

        @keyframes slide-in-left {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .slide-in-left {
            animation: slide-in-left 0.25s ease-out forwards;
        }

        /* Theory text - improved readability */
        .theory-text {
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 16px;
            line-height: 1.8;
            color: #bbb;
            font-weight: 400;
        }

        .theory-text strong {
            color: #fafafa;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .theory-text em {
            color: #dc2626;
            font-style: normal;
            font-weight: 600;
        }

        .formula-box {
            background: #121212;
            border: 2px solid #333;
            border-left: 4px solid #dc2626;
            border-radius: 10px;
            padding: 16px 20px;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 16px;
            font-weight: 600;
            color: #fafafa;
            letter-spacing: 3px;
            text-align: center;
            margin: 16px 0;
        }

        /* ============================================
           JAM SESSION - STUDIO VINYL MODERNIST
           ============================================ */

        #jamSessionFullLayout {
            display: none;
            width: 100%;
            min-height: 100vh;
            background: var(--vinyl-black);
        }

        #jamSessionFullLayout.active {
            display: block !important;
        }

        .jam-session-layout {
            display: grid;
            grid-template-columns: 200px 1fr;
            gap: 0;
            height: 100vh;
            overflow: hidden;
        }

        /* SIDEBAR DE TRACKS */
        .jam-sidebar {
            background: var(--studio-gray);
            border-right: 1px solid var(--steel);
            display: flex;
            flex-direction: column;
            position: sticky;
            top: 0;
            height: 100vh;
        }

        .jam-sidebar-header {
            padding: 16px;
            border-bottom: 1px solid var(--steel);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-label {
            font-family: 'DM Sans', sans-serif;
            font-size: 11px;
            font-weight: 500;
            letter-spacing: 0.1em;
            color: var(--chrome);
        }

        .sidebar-count {
            font-family: 'JetBrains Mono', monospace;
            font-size: 10px;
            color: var(--chrome);
            background: rgba(255,255,255,0.05);
            padding: 2px 6px;
            border-radius: 3px;
        }

        .jam-tracklist {
            overflow-y: auto;
            padding: 8px;
            flex: 1;
        }

        .jam-track-item {
            width: 100%;
            background: transparent;
            border: 1px solid transparent;
            padding: 12px 10px;
            text-align: left;
            cursor: pointer;
            transition: all 0.15s ease;
            display: flex;
            flex-direction: column;
            gap: 4px;
            border-radius: 4px;
            margin-bottom: 4px;
        }

        .jam-track-item:hover {
            background: rgba(255,255,255,0.03);
            border-color: var(--steel);
        }

        .jam-track-item.active {
            background: rgba(220, 38, 38, 0.15);
            border-color: var(--tape-red);
            box-shadow: inset 2px 0 0 var(--tape-red);
        }

        .jam-track-item:active {
            animation: pulse 0.2s ease;
        }

        .track-name {
            font-family: 'DM Sans', sans-serif;
            font-size: 13px;
            font-weight: 500;
            color: var(--paper);
            line-height: 1.3;
        }

        .jam-track-item.active .track-name {
            color: var(--tape-red);
        }

        .track-bpm {
            font-family: 'JetBrains Mono', monospace;
            font-size: 10px;
            color: var(--chrome);
            letter-spacing: 0.05em;
        }

        .track-bpm::after {
            content: ' BPM';
            opacity: 0.5;
        }

        /* ÁREA PRINCIPAL */
        .jam-main-area {
            padding: 20px 24px;
            overflow-y: auto;
        }

        /* KEY INFO BAR */
        .jam-keyinfo-bar {
            background: var(--studio-gray);
            border: 1px solid var(--steel);
            border-radius: 8px;
            padding: 20px 24px;
            display: grid;
            grid-template-columns: 280px 1fr 320px;
            gap: 32px;
            align-items: center;
            margin-bottom: 20px;
        }

        .key-display {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .key-label {
            font-family: 'DM Sans', sans-serif;
            font-size: 10px;
            font-weight: 500;
            letter-spacing: 0.15em;
            color: var(--chrome);
        }

        .key-value {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 28px;
            font-weight: 700;
            color: var(--key-highlight);
            line-height: 1;
            text-transform: uppercase;
            letter-spacing: -0.02em;
            transition: color 0.3s ease, transform 0.2s ease;
        }

        .key-value.updating {
            transform: scale(1.05);
        }

        /* PROGRESSION DISPLAY */
        .progression-display {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding-left: 32px;
            border-left: 1px solid var(--steel);
        }

        .progression-label {
            font-family: 'DM Sans', sans-serif;
            font-size: 10px;
            font-weight: 500;
            letter-spacing: 0.15em;
            color: var(--chrome);
        }

        .progression-chords {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .prog-chord {
            font-family: 'JetBrains Mono', monospace;
            font-size: 16px;
            font-weight: 600;
            color: var(--paper);
            background: rgba(255,255,255,0.05);
            padding: 4px 10px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .prog-chord.active {
            background: var(--chord-active);
            color: var(--vinyl-black);
            transform: scale(1.1);
        }

        .prog-separator {
            font-family: 'JetBrains Mono', monospace;
            color: var(--chrome);
            opacity: 0.4;
        }

        /* CONTROLS */
        .jam-controls {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding-left: 32px;
            border-left: 1px solid var(--steel);
        }

        .control-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .ctrl-btn {
            width: 40px;
            height: 40px;
            border-radius: 6px;
            border: 1px solid var(--steel);
            background: rgba(255,255,255,0.05);
            color: var(--paper);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .ctrl-btn:hover:not(:disabled) {
            background: rgba(255,255,255,0.1);
            border-color: var(--paper);
        }

        .ctrl-play {
            background: var(--vumeter-green);
            border-color: var(--vumeter-green);
        }

        .ctrl-play:hover:not(:disabled) {
            background: #14b88c;
            box-shadow: 0 0 12px rgba(16, 185, 129, 0.4);
        }

        .ctrl-play:not(:disabled) {
            animation: playGlow 2s ease-in-out infinite;
        }

        .ctrl-stop {
            background: var(--tape-red);
            border-color: var(--tape-red);
        }

        .ctrl-stop:hover:not(:disabled) {
            background: #c81e1e;
        }

        .ctrl-stop:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .ctrl-select {
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            background: rgba(255,255,255,0.05);
            color: var(--paper);
            border: 1px solid var(--steel);
            border-radius: 4px;
            padding: 8px 10px;
            cursor: pointer;
        }

        .ctrl-select option {
            background: var(--vinyl-black);
            color: var(--paper);
        }

        .ctrl-slider {
            flex: 1;
            height: 4px;
            background: rgba(255,255,255,0.1);
            border-radius: 2px;
            accent-color: var(--tape-red);
        }

        .bpm-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            font-weight: 600;
            color: var(--tape-red) !important;
            min-width: 40px;
            text-align: center;
            display: inline-block !important;
            opacity: 1 !important;
            visibility: visible !important;
        }

        .ctrl-toggle {
            display: flex;
            align-items: center;
            gap: 6px;
            font-family: 'DM Sans', sans-serif;
            font-size: 10px;
            font-weight: 500;
            letter-spacing: 0.1em;
            color: var(--chrome);
            cursor: pointer;
        }

        .ctrl-toggle input[type="checkbox"] {
            width: 14px;
            height: 14px;
            accent-color: var(--vumeter-green);
        }

        /* LIVE PROGRESS PANEL */
        .jam-live-progress {
            background: rgba(10, 10, 10, 0.95);
            border: 1px solid var(--vumeter-green);
            border-radius: 8px;
            padding: 20px 24px;
            margin-bottom: 16px;
            display: none;
            backdrop-filter: blur(10px);
        }

        .jam-live-progress.active {
            display: block;
            animation: slideDown 0.3s ease;
        }

        .live-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .live-label {
            font-family: 'DM Sans', sans-serif;
            font-size: 10px;
            font-weight: 700;
            letter-spacing: 0.15em;
            color: var(--vumeter-green);
            background: rgba(16, 185, 129, 0.15);
            padding: 4px 10px;
            border-radius: 3px;
        }

        .live-stats {
            display: flex;
            gap: 16px;
        }

        .live-stat {
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            color: var(--chrome);
        }

        .live-stat span {
            color: var(--paper);
            font-weight: 600;
            margin-left: 4px;
        }

        .live-chord {
            text-align: center;
            margin-bottom: 20px;
        }

        .live-chord-name {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 56px;
            font-weight: 700;
            color: var(--chord-active);
            line-height: 1;
            margin-bottom: 8px;
            text-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
        }

        .live-chord-function {
            font-family: 'DM Sans', sans-serif;
            font-size: 14px;
            color: var(--chrome);
        }

        .live-beats {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin-bottom: 16px;
        }

        .beat-pip {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            transition: all 0.1s ease;
        }

        .beat-pip.active {
            background: var(--vumeter-green);
            box-shadow: 0 0 12px rgba(16, 185, 129, 0.6);
            transform: scale(1.3);
            animation: beatPulse 0.15s ease;
        }

        .live-progress-track {
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
        }

        .live-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--vumeter-green), var(--chord-active));
            width: 0%;
            transition: width 0.1s linear;
        }

        /* TIP */
        .jam-tip {
            font-family: 'DM Sans', sans-serif;
            font-size: 11px;
            color: var(--chrome);
            background: rgba(220, 38, 38, 0.08);
            border-left: 2px solid var(--tape-red);
            padding: 12px 16px;
            border-radius: 4px;
            margin-top: 16px;
        }

        .jam-tip strong {
            color: var(--tape-red);
            font-weight: 600;
        }

        /* Asegurar que el diapasón en Jam Session se vea correctamente */
        #jamFretboard {
            min-height: 400px;
        }

        #jamFretboard .string {
            display: flex;
            gap: 0;
            margin-bottom: 16px;
            align-items: center;
        }

        #jamFretboard .fret {
            flex: 1;
            min-width: 60px;
            height: 60px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            border-right: 2px solid rgba(255, 255, 255, 0.1);
        }

        #jamFretboard .fret:first-child {
            flex: 0.6;
            min-width: 40px;
        }

        #jamFretboard .note-bubble {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        /* Burbujas visibles */
        #jamFretboard .note-bubble.visible {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        #jamFretboard .note-bubble.tonic {
            background: var(--tape-red);
            color: var(--vinyl-black);
        }

        #jamFretboard .note-bubble.interval {
            background: rgba(255, 255, 255, 0.9);
            color: var(--vinyl-black);
        }

        #jamFretboard .note-bubble.pulse {
            animation: fretPulse 1.5s ease-in-out infinite;
        }

        @keyframes fretPulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 rgba(220, 38, 38, 0.4); }
            50% { transform: scale(1.1); box-shadow: 0 0 20px rgba(220, 38, 38, 0.6); }
        }

        /* FRETBOARD EN JAM SESSION */
        .jam-fretboard-container {
            margin-bottom: 20px;
            border-radius: 8px;
            overflow: visible;
            border: 1px solid var(--steel);
            background: linear-gradient(180deg, #1a1412 0%, #0d0a08 100%);
            padding: 16px;
        }

        .jam-fretboard-container .fretboard-container {
            background: transparent;
        }

        /* Asegurar que el diapasón del Jam Session se vea correctamente */
        #jamFretboard .string {
            display: flex;
            margin-bottom: 12px;
        }

        #jamFretboard .fret {
            flex: 1;
            position: relative;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* ANIMATIONS */
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(0.98); }
        }

        @keyframes playGlow {
            0%, 100% { box-shadow: 0 0 8px rgba(16, 185, 129, 0.3); }
            50% { box-shadow: 0 0 16px rgba(16, 185, 129, 0.6); }
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes beatPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.5); }
            100% { transform: scale(1.3); }
        }

        /* Header glow effect - industrial */
        .header-glow {
            position: relative;
        }

        .header-glow::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent 0%, #dc2626 50%, transparent 100%);
            opacity: 0.6;
        }

        /* String labels */
        .string-label {
            width: 32px;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 13px;
            font-weight: 600;
            color: #666;
            text-align: center;
        }

        /* Progression button - industrial with rounded */
        .progression-btn {
            padding: 12px 16px;
            border-radius: 10px;
            border: 2px solid #333;
            background: #151515;
            color: #ccc;
            cursor: pointer;
            transition: all 0.15s ease;
            text-align: left;
        }

        .progression-btn:hover {
            border-color: #fafafa;
            background: #1a1a1a;
            color: #fafafa;
        }

        .progression-btn.active {
            border-color: #fafafa;
            background: #fafafa;
            color: #0a0a0a;
        }

        /* Circle of fifths - industrial with rounded */
        .circle-note {
            position: absolute;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.15s ease;
            background: #252525;
            color: #ccc;
            border: 2px solid #333;
        }

        .circle-note:hover {
            transform: scale(1.15);
            border-color: #dc2626;
            color: #fafafa;
        }

        .circle-note.active {
            background: #dc2626;
            color: #fafafa;
            border-color: #dc2626;
            box-shadow: 0 0 20px rgba(220, 38, 38, 0.5);
        }

        .circle-note.minor {
            font-size: 10px;
            width: 30px;
            height: 30px;
            background: #1a1a1a;
            color: #888;
        }

        .circle-note.minor.active {
            background: #fafafa;
            color: #0a0a0a;
            border-color: #fafafa;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.3);
        }

        /* Blue note special highlight */
        .note-bubble.blue-note {
            background: #d4a574;
            color: #0a0a0a;
            box-shadow:
                0 0 0 2px #0a0a0a,
                0 0 0 4px #d4a574,
                0 4px 15px rgba(212, 165, 116, 0.5);
        }

        /* Chord highlight for harmonization */
        .note-bubble.chord-highlight {
            box-shadow:
                0 0 0 3px #0a0a0a,
                0 0 0 6px #d4a574,
                0 4px 20px rgba(212, 165, 116, 0.6);
            transform: scale(1.15);
            z-index: 10;
        }

        /* Progression info panel - industrial with rounded */
        .progression-info {
            background: #121212;
            border: 2px solid #252525;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }

        .chord-in-progression {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 56px;
            height: 56px;
            border-radius: 12px;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 20px;
            font-weight: 400;
            letter-spacing: 1px;
            transition: all 0.2s ease;
            border: 2px solid #333;
        }

        .chord-in-progression.current {
            background: #dc2626;
            color: #fafafa;
            border-color: #dc2626;
            transform: scale(1.1);
            box-shadow: 0 0 25px rgba(220, 38, 38, 0.5);
        }

        .chord-in-progression:not(.current) {
            background: #1a1a1a;
            color: #888;
        }

        /* Chord Diagram Component - HORIZONTAL like fretboard */
        .chord-diagram {
            background: linear-gradient(180deg, #1a1412 0%, #0d0a08 100%);
            border-radius: 12px;
            border: 2px solid #333;
            padding: 16px;
            display: inline-block;
            position: relative;
            box-shadow:
                inset 0 0 40px rgba(0,0,0,0.6),
                0 0 0 1px #0a0a0a,
                0 10px 30px rgba(0,0,0,0.5);
        }

        .chord-diagram::before {
            content: '';
            position: absolute;
            inset: 0;
            background-image:
                url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='5' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
            opacity: 0.1;
            pointer-events: none;
            border-radius: 12px;
        }

        .chord-diagram-grid {
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .chord-diagram .nut {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 8px;
            background: linear-gradient(90deg, #f0ead6 0%, #c4b89a 100%);
            border-radius: 2px;
            box-shadow: 4px 0 10px rgba(0,0,0,0.4);
            z-index: 5;
        }

        .chord-diagram .string-row {
            display: flex;
            align-items: center;
            height: 32px;
            position: relative;
            border-bottom: 1px solid rgba(255, 255, 255, 0.02);
        }

        .chord-diagram .string-row::before {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            top: 50%;
            height: 2px;
            background: linear-gradient(90deg,
                rgba(200, 180, 160, 0.2) 0%,
                rgba(220, 200, 180, 0.7) 15%,
                rgba(200, 180, 160, 0.5) 50%,
                rgba(180, 160, 140, 0.3) 100%
            );
            transform: translateY(-50%);
            box-shadow: 0 1px 3px rgba(0,0,0,0.6);
        }

        .chord-diagram .string-row:nth-child(1)::before { height: 1px; opacity: 0.85; }
        .chord-diagram .string-row:nth-child(2)::before { height: 1.5px; opacity: 0.8; }
        .chord-diagram .string-row:nth-child(3)::before { height: 2px; opacity: 0.75; }
        .chord-diagram .string-row:nth-child(4)::before { height: 2.5px; opacity: 0.7; background: linear-gradient(90deg, rgba(180, 165, 150, 0.2) 0%, rgba(190, 175, 160, 0.65) 15%, rgba(170, 155, 140, 0.45) 50%, rgba(160, 145, 130, 0.25) 100%); }
        .chord-diagram .string-row:nth-child(5)::before { height: 3px; opacity: 0.65; background: linear-gradient(90deg, rgba(160, 150, 140, 0.2) 0%, rgba(170, 160, 150, 0.55) 15%, rgba(150, 140, 130, 0.35) 50%, rgba(140, 130, 120, 0.18) 100%); }
        .chord-diagram .string-row:nth-child(6)::before { height: 3.5px; opacity: 0.6; background: linear-gradient(90deg, rgba(150, 140, 130, 0.2) 0%, rgba(160, 150, 140, 0.45) 15%, rgba(140, 130, 120, 0.28) 50%, rgba(130, 120, 110, 0.15) 100%); }

        .chord-diagram .fret-cell {
            position: relative;
            width: 50px;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            border-right: 3px solid #555;
            box-shadow: inset -2px 0 6px rgba(0,0,0,0.4), inset 2px 0 4px rgba(255,255,255,0.02);
        }

        .chord-diagram .fret-cell.nut-fret {
            width: 35px;
            background: linear-gradient(90deg, #f0ead6 0%, #d8cdb8 50%, #c4b89a 100%);
            border-right: 5px solid #1a1a1a;
            box-shadow: inset -4px 0 10px rgba(0,0,0,0.5), 4px 0 12px rgba(0,0,0,0.4);
        }

        .chord-diagram .finger-dot {
            width: 26px;
            height: 26px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 11px;
            font-weight: 700;
            z-index: 10;
            position: relative;
            text-transform: uppercase;
        }

        .chord-diagram .finger-dot.root {
            background: #dc2626;
            color: #fafafa;
            box-shadow:
                0 0 0 2px #0a0a0a,
                0 0 15px rgba(220, 38, 38, 0.6),
                0 3px 10px rgba(0,0,0,0.4);
        }

        .chord-diagram .finger-dot.note {
            background: #fafafa;
            color: #0a0a0a;
            box-shadow:
                0 0 0 2px #0a0a0a,
                0 3px 10px rgba(0,0,0,0.4);
        }

        .chord-diagram .open-indicator {
            position: absolute;
            left: -24px;
            width: 18px;
            height: 18px;
            border: 2px solid #fafafa;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: #fafafa;
            font-weight: 600;
        }

        .chord-diagram .muted-indicator {
            position: absolute;
            left: -24px;
            font-size: 16px;
            color: #666;
            font-weight: bold;
        }

        .chord-diagram .barre-line {
            position: absolute;
            width: 20px;
            background: #fafafa;
            border-radius: 10px;
            z-index: 5;
            box-shadow: 0 2px 8px rgba(0,0,0,0.5);
            left: 50%;
            transform: translateX(-50%);
        }

        .chord-diagram .fret-numbers {
            display: flex;
            padding-left: 35px;
            margin-top: 6px;
        }

        .chord-diagram .fret-num {
            width: 50px;
            text-align: center;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 11px;
            font-weight: 600;
            color: #666;
        }

        .chord-diagram .string-labels-left {
            position: absolute;
            left: -28px;
            top: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
        }

        .chord-diagram .string-label-item {
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 11px;
            font-weight: 600;
            color: #666;
        }

        /* Chord name display - industrial */
        .chord-name-display {
            text-align: center;
            margin-bottom: 12px;
        }

        .chord-name-display .chord-symbol {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 36px;
            color: #fafafa;
            letter-spacing: 2px;
        }

        .chord-name-display .chord-type {
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 13px;
            font-weight: 500;
            color: #888;
            margin-top: 4px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        /* Position indicator - industrial with rounded */
        .position-indicator {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 8px 16px;
            background: #1a1a1a;
            border: 2px solid #333;
            border-left: 4px solid #dc2626;
            border-radius: 20px;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 13px;
            font-weight: 600;
            color: #fafafa;
            margin: 10px 0;
        }

        /* Fretboard zone highlight */
        .fret.in-zone {
            background: rgba(220, 38, 38, 0.06);
        }

        .fret.zone-start {
            border-left: 3px solid rgba(220, 38, 38, 0.6);
        }

        .fret.zone-end {
            border-right: 3px solid rgba(220, 38, 38, 0.6);
        }

        /* Box/Position selector - industrial with rounded */
        .box-selector {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin: 16px 0;
        }

        .box-btn {
            width: 44px;
            height: 44px;
            border-radius: 10px;
            border: 2px solid #333;
            background: #1a1a1a;
            color: #888;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 20px;
            font-weight: 400;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .box-btn:hover {
            border-color: #666;
            color: #fafafa;
        }

        .box-btn.active {
            background: #dc2626;
            color: #fafafa;
            border-color: #dc2626;
            box-shadow: 0 0 15px rgba(220, 38, 38, 0.4);
        }

        /* Diagrams container */
        .diagrams-container {
            display: flex;
            flex-direction: row;
            gap: 16px;
            justify-content: center;
            align-items: flex-start;
            flex-wrap: wrap;
            max-width: 100%;
            overflow-x: auto;
            padding: 8px;
        }

        .diagrams-container.scrollable-horizontal {
            flex-wrap: nowrap;
            overflow-x: auto;
            overflow-y: hidden;
            padding-bottom: 12px;
        }

        .diagrams-container.scrollable-horizontal::-webkit-scrollbar {
            height: 8px;
        }

        .diagrams-container.scrollable-horizontal::-webkit-scrollbar-thumb {
            background: linear-gradient(90deg, #dc2626 0%, #991b1b 100%);
            border-radius: 4px;
        }

        .chord-diagram.compact {
            min-width: 140px;
            max-width: 160px;
            padding: 12px;
        }

        .chord-diagram.compact .chord-name-display .chord-symbol {
            font-size: 28px;
        }

        .chord-diagram.compact .fret-cell {
            width: 40px;
        }

        .chord-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: all 0.3s ease;
        }

        .chord-wrapper.active-chord {
            transform: scale(1.05);
        }

        /* Interval label on fretboard */
        .note-bubble .interval-label {
            font-size: 10px;
            font-weight: 600;
            opacity: 0.9;
        }

        /* Dimmed notes (outside current zone) */
        .note-bubble.dimmed {
            opacity: 0.2;
            transform: scale(0.65);
        }

        /* Simplified Sidebar Navigation - industrial with rounded */
        .level-nav-btn {
            display: flex;
            align-items: center;
            gap: 14px;
            width: 100%;
            padding: 14px 16px;
            border-radius: 12px;
            border: 2px solid transparent;
            background: rgba(18, 18, 18, 0.6);
            cursor: pointer;
            transition: all 0.15s ease;
            text-align: left;
        }

        .level-nav-btn:hover {
            background: rgba(26, 26, 26, 0.9);
            border-color: #333;
        }

        .level-nav-btn.active {
            background: #1a1a1a;
            border-color: #dc2626;
            box-shadow: 0 0 20px rgba(220, 38, 38, 0.15);
        }

        .level-nav-text {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .level-nav-title {
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 15px;
            font-weight: 600;
            color: #e5e5e5;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .level-nav-sub {
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 12px;
            color: #666;
            font-weight: 400;
        }

        .level-nav-btn.active .level-nav-title {
            color: #dc2626;
        }

        /* Simple mode buttons - industrial with rounded */
        .mode-btn-simple, .progression-btn-simple {
            padding: 10px 16px;
            border-radius: 8px;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 12px;
            font-weight: 600;
            border: 2px solid #333;
            background: #151515;
            color: #999;
            cursor: pointer;
            transition: all 0.15s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .mode-btn-simple:hover, .progression-btn-simple:hover {
            border-color: #666;
            color: #fafafa;
            background: #1a1a1a;
        }

        .mode-btn-simple.active, .progression-btn-simple.active {
            background: #fafafa;
            color: #0a0a0a;
            border-color: #fafafa;
            font-weight: 700;
        }

        /* Ear training exercise tabs */
        .ear-exercise-tab {
            padding: 10px 16px;
            border-radius: 8px;
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 14px;
            font-weight: 600;
            border: 2px solid #333;
            background: #151515;
            color: #888;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .ear-exercise-tab:hover {
            border-color: #dc2626;
            color: #e5e5e5;
        }

        .ear-exercise-tab.active {
            background: #dc2626;
            border-color: #dc2626;
            color: #fafafa;
        }

        /* Scale category buttons - industrial with rounded */
        .scale-cat-btn {
            padding: 8px 14px;
            border-radius: 8px;
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 13px;
            font-weight: 600;
            border: 2px solid #333;
            background: #151515;
            color: #888;
            cursor: pointer;
            transition: all 0.15s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .scale-cat-btn:hover {
            border-color: #d4a574;
            color: #d4a574;
        }

        .scale-cat-btn.active {
            background: #d4a574;
            color: #0a0a0a;
            border-color: #d4a574;
            font-weight: 700;
        }

        /* Scale list item - industrial with rounded */
        .scale-list-item {
            padding: 12px 14px;
            border-radius: 10px;
            border: 2px solid #252525;
            background: #151515;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .scale-list-item:hover {
            border-color: #444;
            background: #1a1a1a;
        }

        .scale-list-item.active {
            border-color: #dc2626;
            background: rgba(220, 38, 38, 0.08);
        }

        .scale-list-item .scale-name {
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 15px;
            font-weight: 600;
            color: #fafafa;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .scale-list-item .scale-emotion {
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 12px;
            color: #666;
            margin-top: 4px;
            font-weight: 400;
        }

        /* Scale info box - matching app theme */
        .scale-info-box {
            background: linear-gradient(180deg, #1a1412 0%, #0d0a08 100%);
            border: 2px solid #333;
            border-radius: 12px;
            padding: 20px;
            position: relative;
            box-shadow:
                inset 0 0 40px rgba(0,0,0,0.5),
                0 0 0 1px #0a0a0a,
                0 10px 30px rgba(0,0,0,0.4);
        }

        .scale-info-box::before {
            content: '';
            position: absolute;
            inset: 0;
            background-image:
                url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='5' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
            opacity: 0.08;
            pointer-events: none;
            border-radius: 12px;
        }

        .scale-info-box .info-header {
            border-bottom: 1px solid #333;
            padding-bottom: 16px;
            margin-bottom: 16px;
        }

        .scale-info-box .info-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 28px;
            color: #dc2626;
            letter-spacing: 2px;
            margin-bottom: 8px;
        }

        .scale-info-box .info-emotion {
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 15px;
            color: #e5e5e5;
            font-style: italic;
        }

        .scale-info-box .info-section {
            background: #151515;
            border: 2px solid #252525;
            border-radius: 10px;
            padding: 14px;
            margin-bottom: 12px;
        }

        .scale-info-box .info-section.accent {
            border-left: 4px solid #dc2626;
        }

        .scale-info-box .info-label {
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 11px;
            font-weight: 600;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 8px;
        }

        .scale-info-box .info-value {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 16px;
            font-weight: 600;
            color: #fafafa;
        }

        .scale-info-box .info-value.highlight {
            color: #dc2626;
        }

        .scale-info-box .info-description {
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 13px;
            color: #e5e5e5;
            margin-top: 6px;
        }

        .scale-info-box .brightness-bar {
            height: 8px;
            background: #1a1a1a;
            border-radius: 4px;
            overflow: hidden;
            border: 1px solid #333;
        }

        .scale-info-box .brightness-fill {
            height: 100%;
            border-radius: 4px;
            background: linear-gradient(90deg, #333 0%, #dc2626 50%, #d4a574 100%);
            transition: width 0.5s ease;
        }

        .scale-info-box .context-tag {
            display: inline-block;
            padding: 6px 12px;
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 12px;
            font-weight: 600;
            color: #ccc;
            background: #1a1a1a;
            border: 2px solid #333;
            border-radius: 20px;
            margin: 3px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .scale-info-box .parent-scale-box {
            background: linear-gradient(90deg, rgba(220, 38, 38, 0.15) 0%, transparent 100%);
            border-left: 4px solid #dc2626;
            border-radius: 8px;
            padding: 12px 14px;
        }

        /* Harmonization chord buttons - matching app theme */
        .harm-chord-btn {
            padding: 12px 16px;
            border-radius: 10px;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 13px;
            font-weight: 600;
            border: 2px solid #333;
            background: #151515;
            color: #ccc;
            cursor: pointer;
            transition: all 0.15s ease;
            text-align: center;
            min-width: 64px;
        }

        .harm-chord-btn:hover {
            border-color: #dc2626;
            color: #fafafa;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .harm-chord-btn.active {
            background: #dc2626;
            color: #fafafa;
            border-color: #dc2626;
            box-shadow: 0 0 15px rgba(220, 38, 38, 0.4);
        }

        .harm-chord-btn.type-maj {
            border-color: #22c55e30;
        }
        .harm-chord-btn.type-maj:hover, .harm-chord-btn.type-maj.active {
            border-color: #22c55e;
            box-shadow: 0 0 12px rgba(34, 197, 94, 0.3);
        }

        .harm-chord-btn.type-min {
            border-color: #3b82f630;
        }
        .harm-chord-btn.type-min:hover, .harm-chord-btn.type-min.active {
            border-color: #3b82f6;
            box-shadow: 0 0 12px rgba(59, 130, 246, 0.3);
        }

        .harm-chord-btn.type-dim {
            border-color: #dc262630;
        }
        .harm-chord-btn.type-dim:hover, .harm-chord-btn.type-dim.active {
            border-color: #dc2626;
            box-shadow: 0 0 12px rgba(220, 38, 38, 0.3);
        }

        .harm-chord-btn .chord-quality {
            font-size: 10px;
            opacity: 0.7;
            display: block;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            margin-top: 4px;
        }

        /* Scale comparison colors - industrial */
        .note-common { color: #4ade80; }
        .note-only-first { color: #dc2626; }
        .note-only-second { color: #d4a574; }

        /* Note highlight for comparison mode */
        .note-bubble.comparison-common {
            background: #4ade80 !important;
            color: #0a0a0a !important;
            box-shadow: 0 0 0 2px #0a0a0a, 0 0 15px rgba(74, 222, 128, 0.5) !important;
        }

        .note-bubble.comparison-different {
            background: #d4a574 !important;
            color: #0a0a0a !important;
            box-shadow: 0 0 0 2px #0a0a0a, 0 0 15px rgba(212, 165, 116, 0.5) !important;
        }

        /* Custom selection styling */
        ::selection {
            background: #dc2626;
            color: #fafafa;
        }

        /* Quiz styles */
        .quiz-cat-btn {
            padding: 8px 14px;
            border-radius: 8px;
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 13px;
            font-weight: 600;
            border: 2px solid #333;
            background: #151515;
            color: #888;
            cursor: pointer;
            transition: all 0.15s ease;
            text-transform: uppercase;
        }
        .quiz-cat-btn:hover { border-color: #dc2626; color: #dc2626; }
        .quiz-cat-btn.active { background: #dc2626; color: #fafafa; border-color: #dc2626; }

        .quiz-question-box {
            background: #121212;
            border: 2px solid #333;
            border-left: 4px solid #dc2626;
            border-radius: 12px;
            padding: 24px;
            margin: 20px 0;
        }

        .quiz-option {
            padding: 12px 20px;
            border-radius: 10px;
            border: 2px solid #333;
            background: #1a1a1a;
            color: #ccc;
            cursor: pointer;
            transition: all 0.15s ease;
            margin: 8px 0;
            display: block;
            width: 100%;
            text-align: left;
        }
        .quiz-option:hover { border-color: #666; color: #fafafa; }
        .quiz-option.correct { border-color: #22c55e; background: rgba(34, 197, 94, 0.15); color: #22c55e; }
        .quiz-option.incorrect { border-color: #dc2626; background: rgba(220, 38, 38, 0.15); color: #dc2626; }
        .quiz-option.disabled { pointer-events: none; opacity: 0.6; }

        /* Song card */
        .song-card {
            background: #121212;
            border: 2px solid #252525;
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.15s ease;
            min-width: 200px;
        }
        .song-card:hover { border-color: #444; transform: translateY(-2px); }
        .song-card.active { border-color: #dc2626; box-shadow: 0 0 20px rgba(220, 38, 38, 0.2); }

        .genre-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .genre-badge.metal { background: #991b1b; color: #fafafa; }
        .genre-badge.prog { background: #7c3aed; color: #fafafa; }
        .genre-badge.rock { background: #d97706; color: #fafafa; }
        .genre-badge.blues { background: #1e40af; color: #fafafa; }
        .genre-badge.jazz { background: #a67c52; color: #0a0a0a; }
        .genre-badge.funk { background: #9333ea; color: #fafafa; }
        .genre-badge.pop { background: #dc2626; color: #fafafa; }
        .genre-badge.latin { background: #b91c1c; color: #fafafa; }
        .genre-badge.country { background: #92400e; color: #fafafa; }
        .genre-badge.reggae { background: #166534; color: #fafafa; }
        .genre-badge.grunge { background: #333333; color: #fafafa; }

        /* Lick Library Styles */
        .lick-library-container {
            padding: 20px;
        }

        .library-header {
            margin-bottom: 24px;
        }

        .library-filters {
            background: #121212;
            border: 2px solid #252525;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 24px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-select {
            background: #1a1a1a;
            border: 2px solid #333;
            border-radius: 8px;
            color: #e5e5e5;
            padding: 8px 12px;
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .filter-select:hover {
            border-color: #dc2626;
        }

        .filter-select:focus {
            outline: none;
            border-color: #dc2626;
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
        }

        .lick-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .lick-card {
            background: #121212;
            border: 2px solid #252525;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .lick-card:hover {
            border-color: #dc2626;
            transform: translateY(-4px);
            box-shadow: 0 4px 20px rgba(220, 38, 38, 0.2);
        }

        .lick-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .lick-icon {
            font-size: 32px;
        }

        .lick-difficulty {
            font-size: 11px;
            font-weight: 700;
            font-family: 'IBM Plex Mono', monospace;
            letter-spacing: 0.5px;
        }

        .lick-card-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 20px;
            color: #fafafa;
            line-height: 1.2;
        }

        .lick-card-meta {
            display: flex;
            gap: 12px;
            font-size: 12px;
            color: #888;
            font-family: 'IBM Plex Mono', monospace;
        }

        .lick-genre {
            text-transform: uppercase;
            font-weight: 600;
        }

        .lick-bpm {
            color: #dc2626;
            font-weight: 600;
        }

        .lick-card-description {
            font-size: 14px;
            color: #aaa;
            line-height: 1.5;
            flex-grow: 1;
        }

        .lick-view-btn {
            margin-top: auto;
        }

        /* Lick Modal */
        .lick-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.9);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .lick-modal.hidden {
            display: none;
        }

        /* Chord Lab Styles */
        .chord-lab-mode-btn {
            padding: 0.5rem 1rem;
            background: transparent;
            color: #94a3b8;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
        }

        .chord-lab-mode-btn:hover {
            color: #cbd5e1;
        }

        .chord-lab-mode-btn.active {
            color: #84cc16;
            border-bottom-color: #84cc16;
        }

        .chord-lab-quality-btn,
        .chord-lab-filter-btn {
            padding: 0.375rem 0.75rem;
            background: #1e293b;
            color: #cbd5e1;
            border: 1px solid #334155;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
        }

        .chord-lab-quality-btn:hover,
        .chord-lab-filter-btn:hover {
            background: #334155;
            border-color: #475569;
        }

        .chord-lab-quality-btn.active,
        .chord-lab-filter-btn.active {
            background: #84cc16;
            color: #0a0a0a;
            border-color: #84cc16;
        }

        .chord-lab-voicing-card {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 0.5rem;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .chord-lab-voicing-card:hover {
            border-color: #84cc16;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(132, 204, 22, 0.2);
        }

        .chord-lab-voicing-card.selected {
            border-color: #84cc16;
            border-width: 2px;
            background: rgba(132, 204, 22, 0.1);
        }

        .chord-lab-voicing-card.compare-a {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }

        .chord-lab-voicing-card.compare-b {
            border-color: #f59e0b;
            background: rgba(245, 158, 11, 0.1);
        }

        .chord-lab-voicing-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
        }

        .chord-lab-voicing-title {
            font-weight: 600;
            color: #e2e8f0;
            font-size: 1rem;
        }

        .chord-lab-voicing-subtitle {
            font-size: 0.75rem;
            color: #94a3b8;
            margin-top: 0.125rem;
        }

        .chord-lab-play-btn {
            padding: 0.375rem 0.75rem;
            background: #84cc16;
            color: #0a0a0a;
            border: none;
            border-radius: 0.375rem;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 600;
            transition: all 0.2s;
        }

        .chord-lab-play-btn:hover {
            background: #a3e635;
        }

        .chord-lab-metadata {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid #334155;
            font-size: 0.875rem;
        }

        .chord-lab-metadata-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.375rem;
            color: #94a3b8;
        }

        .chord-lab-metadata-label {
            font-weight: 500;
        }

        .chord-lab-metadata-value {
            color: #cbd5e1;
        }

        .initial-chord-btn {
            padding: 1rem;
            background: #1e293b;
            color: #cbd5e1;
            border: 1px solid #334155;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1.125rem;
            font-weight: 600;
        }

        .initial-chord-btn:hover {
            background: #334155;
            border-color: #84cc16;
            transform: translateY(-2px);
        }

        .emotion-btn {
            padding: 1rem;
            background: #1e293b;
            border: 2px solid #334155;
            border-radius: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .emotion-btn:hover {
            background: #334155;
            border-color: #84cc16;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(132, 204, 22, 0.2);
        }

        .suggestion-card {
            padding: 1rem;
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 0.5rem;
            transition: all 0.2s;
        }

        .suggestion-card:hover {
            border-color: #84cc16;
            box-shadow: 0 4px 12px rgba(132, 204, 22, 0.2);
        }

        .progression-chord-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            background: #334155;
            border: 1px solid #475569;
            border-radius: 0.375rem;
        }

        .progression-chord-chip .chord-name {
            font-weight: 600;
            color: #84cc16;
        }

        .progression-chord-chip .remove-chord {
            background: none;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            font-size: 1.25rem;
            line-height: 1;
            padding: 0;
        }

        .progression-chord-chip .remove-chord:hover {
            color: #ef4444;
        }

        .ctrl-btn-small {
            padding: 0.375rem 0.75rem;
            background: #84cc16;
            color: #0a0a0a;
            border: none;
            border-radius: 0.375rem;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 600;
            transition: all 0.2s;
        }

        .ctrl-btn-small:hover {
            background: #a3e635;
        }

        .chord-lab-difficulty-bar {
            height: 6px;
            background: #334155;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 0.25rem;
        }

        .chord-lab-difficulty-fill {
            height: 100%;
            background: linear-gradient(90deg, #84cc16, #facc15, #f59e0b, #ef4444);
            transition: width 0.3s;
        }

        .chord-lab-exercise-btn {
            padding: 1.5rem;
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }

        .chord-lab-exercise-btn:hover {
            border-color: #84cc16;
            background: #334155;
        }

        /* Progression Lab Pro Styles */
        .progression-mode-btn {
            padding: 0.5rem 1rem;
            background: transparent;
            color: #94a3b8;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
        }

        .progression-mode-btn:hover {
            color: #cbd5e1;
        }

        .progression-mode-btn.active {
            color: #84cc16;
            border-bottom-color: #84cc16;
        }

        .initial-chord-btn {
            padding: 0.75rem;
            background: #1e293b;
            color: #cbd5e1;
            border: 1px solid #334155;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
            font-weight: 500;
            text-align: center;
        }

        .initial-chord-btn:hover {
            background: #334155;
            border-color: #84cc16;
            transform: translateY(-1px);
        }

        .emotion-btn {
            padding: 1rem;
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .emotion-btn:hover {
            border-color: #84cc16;
            background: #334155;
            transform: translateY(-2px);
        }

        .emotion-btn.selected {
            border-color: #84cc16;
            background: rgba(132, 204, 22, 0.1);
        }

        .suggestion-card {
            padding: 1rem;
            background: #1e293b;
            border: 2px solid #334155;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .suggestion-card:hover {
            border-color: #84cc16;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(132, 204, 22, 0.2);
        }

        .suggestion-card.excellent {
            border-color: #10b981;
        }

        .suggestion-card.good {
            border-color: #f59e0b;
        }

        .suggestion-card.interesting {
            border-color: #3b82f6;
        }

        .suggestion-card.unexpected {
            border-color: #ef4444;
        }

        .progression-chord-item {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: #1e293b;
            border: 2px solid #334155;
            border-radius: 0.375rem;
            font-weight: 500;
            position: relative;
        }

        .progression-chord-item:hover {
            border-color: #84cc16;
        }

        .progression-chord-item .function-label {
            font-size: 0.625rem;
            color: #94a3b8;
            position: absolute;
            top: -0.5rem;
            left: 0.5rem;
            background: #0f172a;
            padding: 0 0.25rem;
        }

        .progression-chord-item .remove-btn {
            color: #94a3b8;
            cursor: pointer;
            font-size: 0.875rem;
            padding: 0.125rem 0.25rem;
            border-radius: 0.25rem;
            transition: all 0.2s;
        }

        .progression-chord-item .remove-btn:hover {
            color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }

        .free-mode-chord-btn {
            padding: 0.75rem;
            background: #1e293b;
            border: 2px solid #334155;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            font-size: 0.875rem;
            font-weight: 500;
            position: relative;
        }

        .free-mode-chord-btn:hover {
            transform: translateY(-1px);
        }

        .free-mode-chord-btn.compat-excellent {
            border-color: #10b981;
            background: rgba(16, 185, 129, 0.05);
        }

        .free-mode-chord-btn.compat-good {
            border-color: #f59e0b;
            background: rgba(245, 158, 11, 0.05);
        }

        .free-mode-chord-btn.compat-interesting {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.05);
        }

        .free-mode-chord-btn.compat-unexpected {
            border-color: #ef4444;
            background: rgba(239, 68, 68, 0.05);
        }

        .free-mode-chord-btn .compat-badge {
            position: absolute;
            top: -0.375rem;
            right: -0.375rem;
            width: 1rem;
            height: 1rem;
            border-radius: 50%;
            font-size: 0.625rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* FASE 4: Estilos para badges de extensiones */
        .extension-badge {
            display: inline-block;
            font-size: 0.625rem;
            color: #f59e0b;
            background: rgba(245, 158, 11, 0.15);
            padding: 0.125rem 0.375rem;
            border-radius: 0.25rem;
            margin-top: 0.25rem;
            font-weight: 600;
        }

        .emotional-tags {
            font-size: 0.625rem;
            color: #64748b;
            margin-top: 0.25rem;
        }

        .chord-analysis-item {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            padding: 0.5rem;
            background: #1e293b;
            border-radius: 0.375rem;
            border: 1px solid #334155;
        }

        .chord-function {
            font-size: 0.75rem;
            color: #94a3b8;
            font-weight: 600;
        }

        .extensions-badge {
            font-size: 0.625rem;
            color: #f59e0b;
            background: rgba(245, 158, 11, 0.15);
            padding: 0.125rem 0.375rem;
            border-radius: 0.25rem;
            width: fit-content;
            font-weight: 600;
        }

        #voice-leading-viz {
            position: relative;
        }

        .voice-line {
            stroke-width: 2;
            opacity: 0.7;
            transition: all 0.3s;
        }

        .voice-line.smooth {
            stroke: #10b981;
        }

        .voice-line.moderate {
            stroke: #f59e0b;
        }

        .voice-line.challenging {
            stroke: #ef4444;
        }

        /* Chord Builder Styles */
        .chord-builder-fret {
            background: #1e293b;
            border: 2px solid #334155;
            border-radius: 4px;
            color: #94a3b8;
            font-size: 10px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chord-builder-fret:hover {
            background: #334155;
            border-color: #84cc16;
            transform: scale(1.1);
        }

        .chord-builder-fret.selected {
            background: #84cc16;
            border-color: #84cc16;
            color: #0a0a0a;
            font-weight: 600;
            transform: scale(1.15);
        }

        #chord-lab-caged-svg-container svg {
            max-width: 600px;
            height: 600px;
        }

        .caged-node {
            cursor: pointer;
            transition: all 0.2s;
        }

        .caged-node:hover circle {
            fill: #a3e635;
        }

        .caged-node.active circle {
            fill: #84cc16;
            stroke-width: 3;
        }

        .caged-connection {
            cursor: pointer;
            transition: all 0.2s;
        }

        .caged-connection:hover {
            stroke: #84cc16;
            stroke-width: 3;
        }

        .lick-modal-content {
            background: #0a0a0a;
            border: 2px solid #333;
            border-radius: 16px;
            padding: 32px;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .lick-modal-close {
            position: absolute;
            top: 16px;
            right: 16px;
            background: #dc2626;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            font-size: 24px;
            color: #fff;
            cursor: pointer;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }

        .lick-modal-close:hover {
            background: #b91c1c;
            transform: rotate(90deg);
        }

        .lick-detail-meta {
            font-family: 'Barlow Condensed', sans-serif;
        }

        /* Tab Notation Styles */
        .tab-notation-container {
            background: #121212;
            border: 2px solid #333;
            border-radius: 12px;
            padding: 20px;
        }

        .tab-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 18px;
            color: #dc2626;
            margin-bottom: 12px;
        }

        .tab-notation-svg {
            display: block;
            margin: 0 auto;
        }

        .tab-controls {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #333;
        }

        .tab-play-btn,
        .tab-loop-btn {
            background: #dc2626;
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .tab-play-btn:hover,
        .tab-loop-btn:hover {
            background: #b91c1c;
            transform: translateY(-1px);
        }

        .tab-loop-btn.active {
            background: #10b981;
        }

        .tempo-control {
            display: flex;
            flex-direction: column;
            gap: 4px;
            flex-grow: 1;
        }

        .tempo-control label {
            font-size: 12px;
            color: #888;
            font-family: 'Barlow Condensed', sans-serif;
        }

        .tempo-value {
            color: #dc2626;
            font-weight: 700;
        }

        .tempo-slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #333;
            outline: none;
            -webkit-appearance: none;
        }

        .tempo-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #dc2626;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .tempo-slider::-webkit-slider-thumb:hover {
            background: #b91c1c;
            transform: scale(1.2);
        }

        .tempo-slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #dc2626;
            cursor: pointer;
            border: none;
            transition: all 0.15s ease;
        }

        .tempo-slider::-moz-range-thumb:hover {
            background: #b91c1c;
            transform: scale(1.2);
        }

        /* Estilo personalizado del thumb del slider del metrónomo */
        #metronomeBPMSlider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #dc2626;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        #metronomeBPMSlider::-webkit-slider-thumb:hover {
            background: #b91c1c;
            transform: scale(1.2);
        }

        #metronomeBPMSlider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #dc2626;
            cursor: pointer;
            border: none;
            transition: all 0.15s ease;
        }

        #metronomeBPMSlider::-moz-range-thumb:hover {
            background: #b91c1c;
            transform: scale(1.2);
        }

        .mini-fretboard {
            background: #0a0a0a;
            padding: 20px;
            border-radius: 8px;
        }

        /* Extended chord matrix */
        .ext-matrix-grid {
            display: grid;
            grid-template-columns: auto repeat(4, 1fr);
            gap: 6px;
            max-width: 500px;
        }
        .ext-matrix-corner { }
        .ext-matrix-col-header {
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 11px;
            font-weight: 700;
            color: #d4a574;
            text-transform: uppercase;
            text-align: center;
            padding: 4px 0;
            letter-spacing: 0.5px;
        }
        .ext-matrix-row-header {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 18px;
            color: #dc2626;
            display: flex;
            align-items: center;
            padding-right: 8px;
        }
        .ext-matrix-btn {
            background: #1a1a1a;
            border: 2px solid #333;
            border-radius: 8px;
            color: #e5e5e5;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 13px;
            font-weight: 600;
            padding: 8px 6px;
            cursor: pointer;
            transition: all 0.15s ease;
            text-align: center;
        }
        .ext-matrix-btn:hover {
            border-color: #dc2626;
            background: #252525;
            color: #fafafa;
        }
        .ext-matrix-btn.active {
            background: #dc2626;
            border-color: #dc2626;
            color: #fafafa;
            box-shadow: 0 0 12px rgba(220, 38, 38, 0.3);
        }

        /* Extended chord info */
        .ext-chord-info {
            background: #121212;
            border: 2px solid #333;
            border-radius: 12px;
            padding: 16px;
            margin-top: 16px;
        }

        /* Secondary dominant arrows */
        .sec-dom-arrow {
            font-size: 24px;
            color: #666;
            margin: 0 8px;
        }

        .sec-dom-chord {
            padding: 12px 16px;
            border-radius: 10px;
            border: 2px solid #333;
            background: #1a1a1a;
            text-align: center;
            min-width: 60px;
        }
        .sec-dom-chord.dominant { border-color: #d97706; background: rgba(217, 119, 6, 0.1); }
        .sec-dom-chord.target { border-color: #22c55e; background: rgba(34, 197, 94, 0.1); }

        /* Additional visual enhancements */
        .section-divider {
            height: 2px;
            background: linear-gradient(90deg, transparent 0%, #333 20%, #333 80%, transparent 100%);
            margin: 20px 0;
        }

        /* Glow effects for important elements */
        .glow-red {
            box-shadow: 0 0 20px rgba(220, 38, 38, 0.4);
        }

        .glow-white {
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.2);
        }

        /* Border accents */
        .border-accent-left {
            border-left: 4px solid #dc2626;
        }

        .border-accent-top {
            border-top: 2px solid #dc2626;
        }

        /* Text utilities */
        .text-display {
            font-family: 'Bebas Neue', sans-serif;
            letter-spacing: 2px;
        }

        .text-mono {
            font-family: 'IBM Plex Mono', monospace;
        }

        .text-body {
            font-family: 'Barlow Condensed', sans-serif;
        }

        /* Subtle hover states for interactive elements */
        .hover-lift:hover {
            transform: translateY(-2px);
        }

        .hover-glow:hover {
            box-shadow: 0 0 25px rgba(220, 38, 38, 0.3);
        }

        /* Responsive styles for chord diagrams */
        @media (max-width: 768px) {
            .diagrams-container {
                gap: 12px;
            }

            .chord-diagram {
                min-width: 140px;
                max-width: 160px;
            }
        }

        @media (max-width: 480px) {
            .diagrams-container {
                flex-direction: column;
                flex-wrap: nowrap;
            }

            .chord-diagram {
                width: 100%;
                max-width: 280px;
            }

            .diagrams-container.scrollable-horizontal {
                flex-direction: column;
                overflow-x: hidden;
            }
        }

        /* Toggle switch styles para el toggle de batería */
        .slider {
            position: relative;
            display: block;
            cursor: pointer;
            user-select: none;
        }

        .slider .dot {
            transition: transform 0.3s ease;
        }

        input[type="checkbox"]:checked + .slider {
            background-color: #dc2626 !important;
        }

        input[type="checkbox"]:checked + .slider .dot {
            transform: translateX(24px) !important;
        }

        input[type="checkbox"]:not(:checked) + .slider {
            background-color: #404040 !important;
        }

        input[type="checkbox"]:not(:checked) + .slider .dot {
            transform: translateX(0) !important;
        }

        /* Estilos para el slider de BPM */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            height: 6px;
            background: #333;
            border-radius: 3px;
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            background: #dc2626;
            cursor: pointer;
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(220, 38, 38, 0.5);
        }

        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: #dc2626;
            cursor: pointer;
            border-radius: 50%;
            border: none;
            box-shadow: 0 0 10px rgba(220, 38, 38, 0.5);
        }

        input[type="range"]:hover::-webkit-slider-thumb {
            box-shadow: 0 0 15px rgba(220, 38, 38, 0.8);
        }

        input[type="range"]:hover::-moz-range-thumb {
            box-shadow: 0 0 15px rgba(220, 38, 38, 0.8);
        }

        /* Toast notifications */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            min-width: 300px;
            max-width: 400px;
            background: #1a1a1a;
            border: 2px solid #333;
            border-left: 4px solid #dc2626;
            border-radius: 12px;
            padding: 16px 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.6);
            transform: translateX(500px);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 10000;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .toast.show {
            transform: translateX(0);
            opacity: 1;
        }

        .toast.toast-success {
            border-left-color: #22c55e;
        }

        .toast.toast-error {
            border-left-color: #dc2626;
        }

        .toast.toast-info {
            border-left-color: #3b82f6;
        }

        .toast.toast-warning {
            border-left-color: #f59e0b;
        }

        .toast-icon {
            font-size: 20px;
            flex-shrink: 0;
        }

        .toast-content {
            flex: 1;
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 14px;
            color: #e5e5e5;
            line-height: 1.5;
        }

        .toast-success .toast-icon { color: #22c55e; }
        .toast-error .toast-icon { color: #dc2626; }
        .toast-info .toast-icon { color: #3b82f6; }
        .toast-warning .toast-icon { color: #f59e0b; }

        /* Loading spinner */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #333;
            border-top-color: #dc2626;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(10, 10, 10, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .loading-overlay.show {
            opacity: 1;
            pointer-events: all;
        }

        .loading-content {
            text-align: center;
        }

        .loading-content .loading-spinner {
            width: 60px;
            height: 60px;
            border-width: 4px;
            margin-bottom: 20px;
        }

        .loading-content .loading-text {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 20px;
            color: #fafafa;
            letter-spacing: 2px;
        }

        /* ========================================
           RESPONSIVE STYLES - MOBILE OPTIMIZATION
           ======================================== */

        /* Tablet (768px - 1024px) */
        @media (max-width: 1024px) {
            aside {
                width: 200px;
            }

            .level-nav-btn {
                padding: 12px;
            }

            .level-nav-title {
                font-size: 14px;
            }

            .level-nav-sub {
                font-size: 11px;
            }

            header {
                padding: 0 16px;
                flex-wrap: wrap;
                height: auto;
                min-height: 64px;
            }

            .fret {
                min-width: 50px;
            }

            .lick-grid {
                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            }
        }

        /* Mobile Landscape (480px - 768px) */
        @media (max-width: 768px) {
            /* Hide sidebar on mobile, show as overlay when needed */
            aside {
                position: fixed;
                left: -280px;
                top: 0;
                height: 100vh;
                width: 280px;
                z-index: 1000;
                transition: left 0.3s ease;
            }

            aside.mobile-open {
                left: 0;
                box-shadow: 4px 0 20px rgba(0,0,0,0.5);
            }

            /* Mobile menu button */
            body::after {
                content: '☰';
                position: fixed;
                top: 16px;
                left: 16px;
                width: 44px;
                height: 44px;
                background: #dc2626;
                color: #fff;
                border-radius: 8px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 24px;
                cursor: pointer;
                z-index: 999;
            }

            main {
                margin-left: 0;
            }

            header {
                flex-direction: column;
                gap: 12px;
                padding: 12px;
            }

            header > div {
                width: 100%;
                justify-content: space-between;
            }

            /* Touch targets minimum 44x44px */
            button, .ctrl-btn, .mode-btn-simple, .scale-cat-btn {
                min-height: 44px;
                min-width: 44px;
                padding: 12px 16px;
            }

            .note-bubble {
                width: 44px;
                height: 44px;
                font-size: 14px;
            }

            /* Stack controls vertically */
            .flex.gap-3, .flex.gap-4, .flex.gap-6 {
                flex-direction: column;
                gap: 12px;
            }

            /* Fretboard adjustments */
            .fret {
                min-width: 40px;
            }

            /* Lick Library mobile */
            .lick-grid {
                grid-template-columns: 1fr;
            }

            .lick-modal-content {
                padding: 20px;
                max-height: 95vh;
            }

            /* Ear training mobile */
            #earTrainingAnswers {
                grid-template-columns: 1fr;
                gap: 8px;
            }

            .ear-exercise-tab {
                font-size: 12px;
                padding: 8px 12px;
            }

            /* Jam Session mobile adaptations */
            .jam-session-layout {
                flex-direction: column;
            }

            .jam-sidebar {
                width: 100%;
                max-height: 40vh;
                overflow-y: auto;
            }

            .jam-content {
                width: 100%;
            }

            .jam-track-grid {
                grid-template-columns: 1fr;
            }

            .jam-keyinfo-bar {
                flex-direction: column;
                gap: 8px;
                padding: 12px;
            }

            .jam-controls {
                flex-direction: column;
                gap: 12px;
            }
        }

        /* Mobile Portrait (< 480px) */
        @media (max-width: 480px) {
            /* Fluid typography */
            h1, .text-3xl { font-size: clamp(20px, 5vw, 28px); }
            h2, .text-2xl { font-size: clamp(18px, 4vw, 24px); }
            h3, .text-xl { font-size: clamp(16px, 3.5vw, 20px); }
            .text-lg { font-size: clamp(14px, 3vw, 18px); }
            .text-base { font-size: clamp(12px, 2.5vw, 16px); }
            .text-sm { font-size: clamp(11px, 2vw, 14px); }
            .text-xs { font-size: clamp(10px, 1.8vw, 12px); }

            /* Vertical fretboard option */
            .fretboard-vertical {
                transform: rotate(90deg);
                transform-origin: center;
                width: 100vh;
                height: 100vw;
                position: relative;
            }

            .fretboard-vertical .note-bubble {
                transform: rotate(-90deg);
            }

            /* Sidebar full width */
            aside {
                width: 100%;
                left: -100%;
            }

            aside.mobile-open {
                left: 0;
            }

            /* Single column layouts */
            .grid-cols-2, .grid-cols-3, .grid-cols-4 {
                grid-template-columns: 1fr !important;
            }

            /* Compact controls */
            .control-panel {
                padding: 12px;
            }

            /* Tab notation mobile */
            .tab-notation-svg {
                max-width: 100%;
                height: auto;
            }

            .tab-controls {
                flex-direction: column;
                gap: 8px;
            }

            .tempo-control {
                width: 100%;
            }

            /* Song cards mobile */
            .song-card {
                padding: 12px;
            }

            /* Library filters mobile */
            .library-filters {
                flex-direction: column;
                gap: 12px;
            }

            .filter-group {
                width: 100%;
            }

            .filter-select {
                width: 100%;
            }

            /* Modal full screen on mobile */
            .lick-modal {
                padding: 0;
            }

            .lick-modal-content {
                width: 100%;
                max-width: 100%;
                height: 100vh;
                max-height: 100vh;
                border-radius: 0;
                padding: 16px;
            }

            /* Bottom drawer for Jam Session sidebar */
            .jam-sidebar-mobile-drawer {
                position: fixed;
                bottom: -60vh;
                left: 0;
                width: 100%;
                height: 60vh;
                background: #0a0a0a;
                border-top: 2px solid #333;
                transition: bottom 0.3s ease;
                z-index: 900;
                overflow-y: auto;
            }

            .jam-sidebar-mobile-drawer.open {
                bottom: 0;
            }

            /* Reduce animations on mobile for performance */
            * {
                animation-duration: 0.15s !important;
                transition-duration: 0.15s !important;
            }

            .note-bubble.pulse {
                animation: none !important;
            }

            /* Increase spacing between interactive elements */
            .flex.gap-2 {
                gap: 12px;
            }

            /* Compact header */
            header {
                padding: 8px;
            }

            .custom-select {
                font-size: 12px;
                padding: 8px;
            }

            /* Metronome controls mobile */
            .metronome-controls {
                flex-direction: column;
                gap: 12px;
            }

            #bpmDisplay {
                font-size: clamp(32px, 8vw, 48px);
            }
        }

        /* Landscape orientation specific */
        @media (max-width: 768px) and (orientation: landscape) {
            .fretboard-container {
                max-height: 60vh;
                overflow-y: auto;
            }

            aside {
                height: 100vh;
            }

            .jam-sidebar {
                max-height: 100vh;
            }
        }

        /* High DPI screens */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            .note-bubble {
                border-width: 1px;
            }

            .fret {
                border-width: 2px;
            }
        }

        /* Reduce motion for accessibility */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }

            .note-bubble.pulse {
                animation: none !important;
            }
        }

        /* Dark mode support (already dark, but for compatibility) */
        @media (prefers-color-scheme: dark) {
            /* App is already dark themed */
        }

        /* Print styles */
        @media print {
            aside, header, .ctrl-btn, button {
                display: none;
            }

            .fretboard-container {
                border: 1px solid #000;
            }

            .note-bubble {
                border: 1px solid #000 !important;
            }
        }
    </style>
</head>
<body>
    <!-- Screen reader announcements -->
    <div id="sr-announcements" aria-live="polite" aria-atomic="true" class="sr-only" style="position: absolute; left: -10000px; width: 1px; height: 1px; overflow: hidden;"></div>

    <div class="min-h-screen flex">
        <!-- Sidebar -->
        <aside class="w-80 bg-void-900 border-r-2 border-void-700 flex flex-col">
            <!-- Logo -->
            <div class="p-6 border-b-2 border-void-700 header-glow relative">
                <div class="absolute top-0 left-0 w-full h-1 bg-blood-400"></div>
                <h1 class="font-display text-4xl text-chalk-100 tracking-widest">GUITAR</h1>
                <p class="font-heading text-2xl text-blood-400 -mt-1 tracking-wide">THEORY MASTER</p>
                <p class="text-xs text-void-400 mt-3 font-mono tracking-wider">V2.0 — TEORÍA MUSICAL</p>
            </div>

            <!-- Levels Navigation - Industrial -->
            <nav class="flex-1 overflow-y-auto p-4 space-y-1" id="levelsNav">
                <button class="level-nav-btn active" data-level="1" aria-label="Nivel 1: Intervalos - Distancias entre notas" aria-current="page">
                    <div class="level-badge bg-blood-400 text-chalk-100">01</div>
                    <div class="level-nav-text">
                        <span class="level-nav-title">Intervalos</span>
                        <span class="level-nav-sub">Distancias entre notas</span>
                    </div>
                </button>

                <button class="level-nav-btn" data-level="2" aria-label="Nivel 2: Escalas - Todas las escalas y modos">
                    <div class="level-badge bg-chalk-100 text-void-950">02</div>
                    <div class="level-nav-text">
                        <span class="level-nav-title">Escalas</span>
                        <span class="level-nav-sub">Todas las escalas y modos</span>
                    </div>
                </button>

                <button class="level-nav-btn" data-level="3" aria-label="Nivel 3: Acordes - Armonización y voicings">
                    <div class="level-badge bg-brass-400 text-void-950">03</div>
                    <div class="level-nav-text">
                        <span class="level-nav-title">Acordes</span>
                        <span class="level-nav-sub">Armonización y voicings</span>
                    </div>
                </button>

                <button class="level-nav-btn" data-level="4" aria-label="Nivel 4: Modos Griegos - 7 colores de la escala">
                    <div class="level-badge bg-blood-400 text-chalk-100">04</div>
                    <div class="level-nav-text">
                        <span class="level-nav-title">Modos Griegos</span>
                        <span class="level-nav-sub">7 colores de la escala</span>
                    </div>
                </button>

                <button class="level-nav-btn" data-level="5" aria-label="Nivel 5: Pentatónicas - Las 5 posiciones">
                    <div class="level-badge bg-chalk-100 text-void-950">05</div>
                    <div class="level-nav-text">
                        <span class="level-nav-title">Pentatónicas</span>
                        <span class="level-nav-sub">Las 5 posiciones</span>
                    </div>
                </button>

                <button class="level-nav-btn" data-level="6" aria-label="Nivel 6: Círculo de Quintas - Mapa de tonalidades">
                    <div class="level-badge bg-brass-400 text-void-950">06</div>
                    <div class="level-nav-text">
                        <span class="level-nav-title">Círculo de 5as</span>
                        <span class="level-nav-sub">Mapa de tonalidades</span>
                    </div>
                </button>

                <button class="level-nav-btn" data-level="7" aria-label="Nivel 7: Progresiones - Secuencias famosas">
                    <div class="level-badge bg-blood-400 text-chalk-100">07</div>
                    <div class="level-nav-text">
                        <span class="level-nav-title">Progresiones</span>
                        <span class="level-nav-sub">Secuencias famosas</span>
                    </div>
                </button>

                <button class="level-nav-btn" data-level="8" aria-label="Nivel 8: Acordes Séptima - Más color armónico">
                    <div class="level-badge bg-chalk-100 text-void-950">08</div>
                    <div class="level-nav-text">
                        <span class="level-nav-title">Acordes 7ª</span>
                        <span class="level-nav-sub">Más color armónico</span>
                    </div>
                </button>

                <button class="level-nav-btn" data-level="9" aria-label="Nivel 9: Sistema CAGED - Domina el mástil">
                    <div class="level-badge bg-brass-400 text-void-950">09</div>
                    <div class="level-nav-text">
                        <span class="level-nav-title">Sistema CAGED</span>
                        <span class="level-nav-sub">Domina el mástil</span>
                    </div>
                </button>

                <button class="level-nav-btn" data-level="10" aria-label="Nivel 10: Quiz - Pon a prueba tu oído">
                    <div class="level-badge bg-blood-400 text-chalk-100">10</div>
                    <div class="level-nav-text">
                        <span class="level-nav-title">Quiz</span>
                        <span class="level-nav-sub">Pon a prueba tu oído</span>
                    </div>
                </button>

                <button class="level-nav-btn" data-level="11" aria-label="Nivel 11: Acordes Extendidos - Novena, Oncena, Trecena">
                    <div class="level-badge bg-chalk-100 text-void-950">11</div>
                    <div class="level-nav-text">
                        <span class="level-nav-title">Acordes Ext.</span>
                        <span class="level-nav-sub">9ª, 11ª, 13ª</span>
                    </div>
                </button>

                <button class="level-nav-btn" data-level="12" aria-label="Nivel 12: Dominantes Secundarios - Tensión armónica">
                    <div class="level-badge bg-brass-400 text-void-950">12</div>
                    <div class="level-nav-text">
                        <span class="level-nav-title">Dom. Secundarios</span>
                        <span class="level-nav-sub">Tensión armónica</span>
                    </div>
                </button>

                <button class="level-nav-btn" data-level="13" aria-label="Nivel 13: Canciones - Biblioteca de temas">
                    <div class="level-badge bg-blood-400 text-chalk-100">13</div>
                    <div class="level-nav-text">
                        <span class="level-nav-title">Canciones</span>
                        <span class="level-nav-sub">Biblioteca de temas</span>
                    </div>
                </button>

                <button class="level-nav-btn" data-level="14" aria-label="Nivel 14: Ear Training - Entrena tu oído">
                    <div class="level-badge bg-chalk-100 text-void-950">14</div>
                    <div class="level-nav-text">
                        <span class="level-nav-title">Ear Training</span>
                        <span class="level-nav-sub">Entrena tu oído</span>
                    </div>
                </button>

                <button class="level-nav-btn" data-level="15" aria-label="Nivel 15: Jam Session - Practica con bases">
                    <div class="level-badge bg-blood-400 text-chalk-100">15</div>
                    <div class="level-nav-text">
                        <span class="level-nav-title">Jam Session</span>
                        <span class="level-nav-sub">Practica con bases</span>
                    </div>
                </button>

                <button class="level-nav-btn" data-level="16" aria-label="Nivel 16: Chord Lab - Sistema de visualización de voicings">
                    <div class="level-badge bg-sage-500 text-chalk-100">16</div>
                    <div class="level-nav-text">
                        <span class="level-nav-title">Chord Lab</span>
                        <span class="level-nav-sub">Voicings completos</span>
                    </div>
                </button>

                <button class="level-nav-btn" data-level="17" aria-label="Nivel 17: Lick Library - Biblioteca de licks">
                    <div class="level-badge bg-blood-400 text-chalk-100">17</div>
                    <div class="level-nav-text">
                        <span class="level-nav-title">Lick Library</span>
                        <span class="level-nav-sub">Tabs interactivos</span>
                    </div>
                </button>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col bg-void-950">
            <!-- Top Bar with Root Select - Industrial -->
            <header class="h-16 bg-void-900 border-b-2 border-void-700 flex items-center justify-between px-6">
                <div class="flex items-center gap-6">
                    <div>
                        <label class="text-xs text-void-400 block mb-1 font-mono tracking-wider uppercase">Nota Raíz</label>
                        <select class="custom-select !py-2 !text-sm" id="rootSelect">
                            <option value="0">C (Do)</option>
                            <option value="1">C# / Db</option>
                            <option value="2">D (Re)</option>
                            <option value="3">D# / Eb</option>
                            <option value="4">E (Mi)</option>
                            <option value="5">F (Fa)</option>
                            <option value="6">F# / Gb</option>
                            <option value="7">G (Sol)</option>
                            <option value="8">G# / Ab</option>
                            <option value="9">A (La)</option>
                            <option value="10">A# / Bb</option>
                            <option value="11">B (Si)</option>
                        </select>
                    </div>

                    <div>
                        <label class="text-xs text-void-400 block mb-1 font-mono tracking-wider uppercase">Afinación</label>
                        <select class="custom-select !py-2 !text-sm" id="tuningSelect">
                            <option value="standard">Standard (E)</option>
                            <option value="dropD">Drop D</option>
                            <option value="dropC">Drop C</option>
                            <option value="dropB">Drop B</option>
                            <option value="dropA">Drop A</option>
                            <option value="dadgad">DADGAD</option>
                            <option value="openG">Open G</option>
                            <option value="openD">Open D</option>
                            <option value="halfStep">Half Step Down</option>
                            <option value="wholeStep">Whole Step Down</option>
                        </select>
                    </div>
                </div>
                <div class="flex items-center gap-8">
                    <div class="flex items-center gap-3">
                        <span class="text-sm text-void-300 font-body uppercase tracking-wide">Notas</span>
                        <div class="toggle-switch active" id="showNotesToggle" role="switch" aria-checked="true" aria-label="Mostrar nombres de notas" tabindex="0"></div>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="text-sm text-void-300 font-body uppercase tracking-wide">Grados</span>
                        <div class="toggle-switch" id="showFunctionsToggle" role="switch" aria-checked="false" aria-label="Mostrar grados de la escala" tabindex="0"></div>
                    </div>
                    <div class="flex items-center gap-3">
                        <button class="btn-secondary !py-2 !px-4 !text-xs" id="metronomeBtn" aria-label="Activar metrónomo">
                            <span id="metronomeIcon">♪</span>
                            <span id="bpmDisplay">120</span>
                            <span id="metronomeBeatIndicator" class="ml-2 text-xs font-mono" style="min-width: 30px;">1/4</span>
                        </button>
                        <button class="btn-secondary !py-1 !px-3 !text-xs" id="tapTempoBtn" aria-label="Tap Tempo" title="Click varias veces para detectar BPM">
                            TAP
                        </button>
                        <button class="btn-secondary !py-1 !px-3 !text-xs" id="metronomeSettingsBtn" aria-label="Configuración del metrónomo" title="Compás, subdivisiones, etc.">
                            ⚙
                        </button>
                    </div>
                </div>
            </header>

            <!-- Control Panel Area (changes based on level) - Industrial -->
            <div class="bg-void-800/50 border-b-2 border-void-700 p-5" id="controlPanel">
                <!-- Content generated by JS based on current level -->
            </div>

            <!-- Fretboard Area - Industrial -->
            <div id="mainFretboardArea" class="flex-1 flex flex-col items-center justify-center p-8 overflow-y-auto">
                <!-- Current Display Info -->
                <div class="mb-6 text-center">
                    <h2 class="font-display text-4xl text-chalk-100 tracking-widest" id="displayTitle">SELECCIONA UN NIVEL</h2>
                    <p class="text-void-400 text-sm mt-2 font-body uppercase tracking-wider" id="displaySubtitle">Usa la barra lateral para empezar</p>
                </div>

                <!-- Chord Diagrams Container -->
                <div class="diagrams-container mb-4 hidden" id="diagramsContainer">
                    <!-- Generated by JS -->
                </div>

                <!-- Box/Position Selector -->
                <div class="box-selector hidden mb-4" id="boxSelector">
                    <!-- Generated by JS -->
                </div>

                <!-- Fretboard -->
                <div class="w-full max-w-5xl">
                    <!-- Fret Numbers - Industrial -->
                    <div class="flex mb-3 pl-8">
                        <div class="w-8"></div>
                        <div class="flex flex-1">
                            <div class="flex-[0.6] flex justify-center font-mono text-sm text-void-500 font-semibold"><span style="margin-right: 5px;">0</span></div>
                            <div class="flex-1 flex justify-center font-mono text-sm text-void-500 font-semibold"><span style="margin-right: 3px;">1</span></div>
                            <div class="flex-1 flex justify-center font-mono text-sm text-void-500 font-semibold"><span style="margin-right: 3px;">2</span></div>
                            <div class="flex-1 flex justify-center font-mono text-sm text-void-400 font-bold"><span style="margin-right: 3px;">3</span></div>
                            <div class="flex-1 flex justify-center font-mono text-sm text-void-500 font-semibold"><span style="margin-right: 3px;">4</span></div>
                            <div class="flex-1 flex justify-center font-mono text-sm text-void-400 font-bold"><span style="margin-right: 3px;">5</span></div>
                            <div class="flex-1 flex justify-center font-mono text-sm text-void-500 font-semibold"><span style="margin-right: 3px;">6</span></div>
                            <div class="flex-1 flex justify-center font-mono text-sm text-void-400 font-bold"><span style="margin-right: 3px;">7</span></div>
                            <div class="flex-1 flex justify-center font-mono text-sm text-void-500 font-semibold"><span style="margin-right: 3px;">8</span></div>
                            <div class="flex-1 flex justify-center font-mono text-sm text-void-400 font-bold"><span style="margin-right: 3px;">9</span></div>
                            <div class="flex-1 flex justify-center font-mono text-sm text-void-500 font-semibold"><span style="margin-right: 3px;">10</span></div>
                            <div class="flex-1 flex justify-center font-mono text-sm text-void-500 font-semibold"><span style="margin-right: 3px;">11</span></div>
                            <div class="flex-1 flex justify-center font-mono text-sm text-blood-400 font-bold"><span style="margin-right: 3px;">12</span></div>
                        </div>
                    </div>

                    <!-- Fretboard Container -->
                    <div class="fretboard-container p-4" id="fretboard">
                        <!-- Generated by JS -->
                    </div>

                    <!-- Fret markers - Industrial with rounded -->
                    <div class="flex mt-3 pl-8">
                        <div class="w-8"></div>
                        <div class="flex flex-1">
                            <div class="flex-[0.6]"></div>
                            <div class="flex-1"></div>
                            <div class="flex-1"></div>
                            <div class="flex-1 flex justify-center"><div class="w-3 h-3 rounded-full bg-void-500" style="margin-right: 3px;"></div></div>
                            <div class="flex-1"></div>
                            <div class="flex-1 flex justify-center"><div class="w-3 h-3 rounded-full bg-void-500" style="margin-right: 3px;"></div></div>
                            <div class="flex-1"></div>
                            <div class="flex-1 flex justify-center"><div class="w-3 h-3 rounded-full bg-void-500" style="margin-right: 3px;"></div></div>
                            <div class="flex-1"></div>
                            <div class="flex-1 flex justify-center"><div class="w-3 h-3 rounded-full bg-void-500" style="margin-right: 3px;"></div></div>
                            <div class="flex-1"></div>
                            <div class="flex-1"></div>
                            <div class="flex-1 flex justify-center gap-2" style="margin-right: 3px;"><div class="w-3 h-3 rounded-full bg-blood-500"></div><div class="w-3 h-3 rounded-full bg-blood-500"></div></div>
                        </div>
                    </div>
                </div>

                <!-- Scale/Chord Info Panel - Industrial -->
                <div class="mt-8 w-full max-w-5xl" id="infoPanel">
                    <!-- Generated by JS -->
                </div>
            </div>
        </main>

        <!-- JAM SESSION FULL LAYOUT (nivel 15) -->
        <div id="jamSessionFullLayout">
            <!-- El template se cargará aquí -->
        </div>
    </div>

    <!-- TEMPLATES FOR CONTROL PANELS -->
    <template id="tpl-intervals">
        <div class="flex flex-wrap items-center gap-4">
            <span class="text-sm text-void-400 font-body uppercase tracking-wider font-semibold">Intervalo:</span>
            <div class="flex flex-wrap gap-2">
                <button class="interval-btn" data-interval="1">2ª m</button>
                <button class="interval-btn" data-interval="2">2ª M</button>
                <button class="interval-btn" data-interval="3">3ª m</button>
                <button class="interval-btn" data-interval="4">3ª M</button>
                <button class="interval-btn" data-interval="5">4ª J</button>
                <button class="interval-btn" data-interval="6">Tritono</button>
                <button class="interval-btn" data-interval="7">5ª J</button>
                <button class="interval-btn" data-interval="8">6ª m</button>
                <button class="interval-btn" data-interval="9">6ª M</button>
                <button class="interval-btn" data-interval="10">7ª m</button>
                <button class="interval-btn" data-interval="11">7ª M</button>
            </div>
        </div>
    </template>

    <template id="tpl-scales">
        <div class="space-y-4">
            <div class="flex flex-wrap items-center gap-4">
                <span class="text-sm text-void-400 font-body uppercase tracking-wider font-semibold">Categoría:</span>
                <div class="flex flex-wrap gap-2" id="scaleCatBtnsMain">
                    <button class="scale-cat-btn active" data-category="major">Mayores</button>
                    <button class="scale-cat-btn" data-category="minor">Menores</button>
                    <button class="scale-cat-btn" data-category="modes">Modos Griegos</button>
                    <button class="scale-cat-btn" data-category="pentatonic">Pentatónicas</button>
                    <button class="scale-cat-btn" data-category="exotic">Exóticas</button>
                </div>
            </div>
            <div class="flex flex-wrap items-center gap-4">
                <span class="text-sm text-void-400 font-body uppercase tracking-wider font-semibold">Escala:</span>
                <div class="flex flex-wrap gap-2" id="scaleListMain">
                    <!-- Generated by JS -->
                </div>
            </div>
        </div>
    </template>

    <template id="tpl-chords">
        <div class="space-y-3">
            <div class="flex flex-wrap items-center gap-3">
                <span class="text-sm text-slate-400">Grado:</span>
                <div class="flex flex-wrap gap-2">
                    <button class="chord-btn" data-chord="1"><span class="roman">I</span><span class="name">Mayor</span></button>
                    <button class="chord-btn" data-chord="2"><span class="roman">ii</span><span class="name">menor</span></button>
                    <button class="chord-btn" data-chord="3"><span class="roman">iii</span><span class="name">menor</span></button>
                    <button class="chord-btn" data-chord="4"><span class="roman">IV</span><span class="name">Mayor</span></button>
                    <button class="chord-btn" data-chord="5"><span class="roman">V</span><span class="name">Mayor</span></button>
                    <button class="chord-btn" data-chord="6"><span class="roman">vi</span><span class="name">menor</span></button>
                    <button class="chord-btn" data-chord="7"><span class="roman">vii°</span><span class="name">dim</span></button>
                </div>
            </div>
        </div>
    </template>

    <template id="tpl-modes">
        <div class="flex flex-wrap items-center gap-3">
            <span class="text-sm text-slate-400">Modo:</span>
            <div class="flex flex-wrap gap-2">
                <button class="mode-btn-simple active" data-mode="1">I Jónico</button>
                <button class="mode-btn-simple" data-mode="2">II Dórico</button>
                <button class="mode-btn-simple" data-mode="3">III Frigio</button>
                <button class="mode-btn-simple" data-mode="4">IV Lidio</button>
                <button class="mode-btn-simple" data-mode="5">V Mixolidio</button>
                <button class="mode-btn-simple" data-mode="6">VI Eólico</button>
                <button class="mode-btn-simple" data-mode="7">VII Locrio</button>
            </div>
        </div>
    </template>

    <template id="tpl-pentatonics">
        <div class="space-y-3">
            <div class="flex flex-wrap items-center gap-3">
                <span class="text-sm text-slate-400">Tipo:</span>
                <div class="flex flex-wrap gap-2">
                    <button class="chord-btn active" data-penta="minor"><span class="roman">Menor</span></button>
                    <button class="chord-btn" data-penta="major"><span class="roman">Mayor</span></button>
                    <button class="chord-btn" data-penta="blues"><span class="roman">Blues</span></button>
                </div>
            </div>
            <div class="flex flex-wrap items-center gap-3">
                <span class="text-sm text-slate-400">Posición:</span>
                <div class="flex gap-2" id="pentaBoxBtns">
                    <button class="box-btn active" data-box="0">1</button>
                    <button class="box-btn" data-box="1">2</button>
                    <button class="box-btn" data-box="2">3</button>
                    <button class="box-btn" data-box="3">4</button>
                    <button class="box-btn" data-box="4">5</button>
                </div>
            </div>
        </div>
    </template>

    <template id="tpl-circle">
        <div class="flex items-center justify-center">
            <div class="relative w-56 h-56" id="circleOfFifthsMain">
                <!-- Generated by JS -->
            </div>
            <div class="ml-8 text-sm text-slate-400">
                <p>Haz clic en una nota para cambiar la tonalidad</p>
                <p class="mt-2 text-cyan-400" id="circleInfo">-</p>
            </div>
        </div>
    </template>

    <template id="tpl-progressions">
        <div class="space-y-3">
            <div class="flex flex-wrap items-center gap-3">
                <span class="text-sm text-slate-400">Progresión:</span>
                <div class="flex flex-wrap gap-2">
                    <button class="progression-btn-simple active" data-progression="I-IV-V-I">I-IV-V-I</button>
                    <button class="progression-btn-simple" data-progression="I-V-vi-IV">I-V-vi-IV</button>
                    <button class="progression-btn-simple" data-progression="ii-V-I">ii-V-I</button>
                    <button class="progression-btn-simple" data-progression="I-vi-IV-V">I-vi-IV-V</button>
                    <button class="progression-btn-simple" data-progression="vi-IV-I-V">vi-IV-I-V</button>
                    <button class="progression-btn-simple" data-progression="I-bVII-IV-I">I-bVII-IV</button>
                </div>
            </div>
            <div class="flex flex-wrap items-center gap-3">
                <span class="text-sm text-slate-400">Avanzadas:</span>
                <div class="flex flex-wrap gap-2">
                    <button class="progression-btn-simple" data-progression="i-bVII-bVI-V">Andaluza</button>
                    <button class="progression-btn-simple" data-progression="i-bVI-bIII-bVII">Epic</button>
                    <button class="progression-btn-simple" data-progression="i-iv-v-i">Menor Clás.</button>
                    <button class="progression-btn-simple" data-progression="I-vi-ii-V">Rhythm Ch.</button>
                    <button class="progression-btn-simple" data-progression="I-V-vi-iii-IV-I-IV-V">Canon</button>
                </div>
            </div>
            <div class="flex flex-wrap items-center gap-3">
                <span class="text-sm text-slate-400">Jazz Avanzado:</span>
                <div class="flex flex-wrap gap-2">
                    <button class="progression-btn-simple" data-progression="bII7-I">Tritone Sub</button>
                    <button class="progression-btn-simple" data-progression="I-III7-VImaj7-bII7-I">Coltrane</button>
                    <button class="progression-btn-simple" data-progression="I-vi-ii-V-I-vi-ii-V-IV-iv-I-ii-V-I">Rhythm Full</button>
                    <button class="progression-btn-simple" data-progression="iii7-VI7-ii7-V7-I">iii-VI-ii-V-I</button>
                </div>
            </div>
            <div class="flex flex-wrap items-center gap-3">
                <span class="text-sm text-slate-400">Modal/Rock:</span>
                <div class="flex flex-wrap gap-2">
                    <button class="progression-btn-simple" data-progression="i-IV">Dorian</button>
                    <button class="progression-btn-simple" data-progression="I-bII">Phrygian</button>
                    <button class="progression-btn-simple" data-progression="bVII-IV-I">Mixolidio</button>
                    <button class="progression-btn-simple" data-progression="vi-V-IV-V">Indie</button>
                    <button class="progression-btn-simple" data-progression="i-bVII-bVI-bVII">Modal Menor</button>
                    <button class="progression-btn-simple" data-progression="I-III-vi-IV">Terceras</button>
                </div>
            </div>
            <!-- Controles de reproducción de progresión -->
            <div class="mt-6 p-4 bg-black bg-opacity-30 rounded-lg border border-red-900 border-opacity-30">
                <div class="flex flex-wrap items-center gap-4 mb-4">
                    <button id="playProgressionBtn" class="px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded font-semibold transition-colors">
                        ▶️ PLAY
                    </button>
                    <button id="pauseProgressionBtn" class="px-6 py-2 bg-yellow-600 hover:bg-yellow-700 text-white rounded font-semibold transition-colors" disabled>
                        ⏸️ PAUSE
                    </button>
                    <button id="stopProgressionBtn" class="px-6 py-2 bg-red-600 hover:bg-red-700 text-white rounded font-semibold transition-colors" disabled>
                        ⏹️ STOP
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm text-slate-400 mb-2">Tempo (BPM)</label>
                        <div class="flex items-center gap-3">
                            <input type="range" id="progressionBPMSlider" min="40" max="200" value="120"
                                class="flex-1 h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer">
                            <span id="progressionBPMDisplay" class="text-xl font-bold text-red-500 w-12 text-center">120</span>
                        </div>
                    </div>
                    <div class="flex items-center gap-6">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="progressionLoopToggle" class="w-5 h-5">
                            <span class="text-sm text-slate-300">Loop infinito</span>
                        </label>
                        <div class="flex items-center gap-2">
                            <label class="text-sm text-slate-400">Repetir:</label>
                            <input type="number" id="progressionRepeatInput" min="1" max="10" value="1"
                                class="w-16 px-2 py-1 bg-slate-800 text-white rounded border border-slate-600 text-center">
                            <span class="text-sm text-slate-400">veces</span>
                        </div>
                    </div>
                </div>
                <div class="mt-4 p-3 bg-slate-900 bg-opacity-50 rounded">
                    <div class="flex items-center justify-between mb-2">
                        <span id="progressionProgressText" class="text-lg font-bold text-white">Acorde 1 / 4</span>
                        <span id="progressionRepeatText" class="text-sm text-slate-400">Repetición 1 / 1</span>
                    </div>
                    <div class="w-full h-3 bg-slate-800 rounded-full overflow-hidden">
                        <div id="progressionProgressBar" class="h-full bg-gradient-to-r from-green-500 to-red-500 transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <template id="tpl-seventh">
        <div class="flex flex-wrap items-center gap-3">
            <span class="text-sm text-slate-400">Acorde 7ª:</span>
            <div class="flex flex-wrap gap-2">
                <button class="chord-btn" data-chord7="1"><span class="roman">Imaj7</span></button>
                <button class="chord-btn" data-chord7="2"><span class="roman">ii-7</span></button>
                <button class="chord-btn" data-chord7="3"><span class="roman">iii-7</span></button>
                <button class="chord-btn" data-chord7="4"><span class="roman">IVmaj7</span></button>
                <button class="chord-btn" data-chord7="5"><span class="roman">V7</span></button>
                <button class="chord-btn" data-chord7="6"><span class="roman">vi-7</span></button>
                <button class="chord-btn" data-chord7="7"><span class="roman">viiø7</span></button>
            </div>
        </div>
    </template>

    <template id="tpl-caged">
        <div class="space-y-6">
            <!-- Sección 1: Introducción didáctica -->
            <div class="p-4 bg-blue-900/20 border border-blue-700 rounded-lg">
                <h3 class="text-xl font-medium text-sage-400 mb-3">
                    🎸 ¿Qué es el Sistema CAGED?
                </h3>
                <p class="text-sm text-chalk-200 mb-2">
                    El Sistema CAGED te permite tocar el mismo acorde en 5 formas diferentes
                    a lo largo del diapasón. Las letras representan las formas básicas:
                </p>
                <div class="grid grid-cols-5 gap-2 my-4">
                    <div class="p-2 bg-void-800 rounded text-center">
                        <div class="text-2xl font-bold" style="color: #ef4444">C</div>
                        <div class="text-xs text-void-400">Abierta y brillante</div>
                    </div>
                    <div class="p-2 bg-void-800 rounded text-center">
                        <div class="text-2xl font-bold" style="color: #f59e0b">A</div>
                        <div class="text-xs text-void-400">Full y potente</div>
                    </div>
                    <div class="p-2 bg-void-800 rounded text-center">
                        <div class="text-2xl font-bold" style="color: #eab308">G</div>
                        <div class="text-xs text-void-400">Rica y resonante</div>
                    </div>
                    <div class="p-2 bg-void-800 rounded text-center">
                        <div class="text-2xl font-bold" style="color: #84cc16">E</div>
                        <div class="text-xs text-void-400">Versátil y móvil</div>
                    </div>
                    <div class="p-2 bg-void-800 rounded text-center">
                        <div class="text-2xl font-bold" style="color: #06b6d4">D</div>
                        <div class="text-xs text-void-400">Aguda y penetrante</div>
                    </div>
                </div>
                <p class="text-sm text-void-300">
                    💡 <strong>El truco:</strong> Estas formas se repiten en orden circular por todo
                    el mástil. Domina este sistema y podrás tocar cualquier acorde en cualquier lugar.
                </p>
            </div>

            <!-- Sección 2: Visualizador interactivo -->
            <div>
                <h3 class="text-lg font-medium text-sage-400 mb-3">
                    Visualizador Interactivo
                </h3>
                <p class="text-sm text-void-300 mb-3">
                    Haz click en los nodos para ver cada forma. Click en las líneas para ver transiciones.
                </p>
                <div id="caged-svg-container" class="flex justify-center mb-4">
                    <!-- SVG generado por renderCAGEDMap() -->
                </div>

                <!-- Botón Tour CAGED -->
                <div class="text-center mb-4">
                    <button id="caged-tour-btn" class="px-6 py-2 bg-sage-600 hover:bg-sage-500 text-chalk-100 rounded-lg font-medium">
                        🎵 Tour Completo CAGED (C→A→G→E→D)
                    </button>
                </div>

                <!-- Panel de información dinámica -->
                <div id="caged-info-panel" class="p-4 bg-void-800 rounded-lg hidden">
                    <!-- Contenido dinámico -->
                </div>
            </div>

            <!-- Sección 3: Toggle "Ver todas las formas" -->
            <div class="p-4 bg-sage-900/20 border border-sage-600 rounded-lg">
                <div class="flex items-center justify-between mb-3">
                    <div>
                        <h3 class="text-lg font-medium text-sage-400">Ver Todas las Formas</h3>
                        <p class="text-sm text-void-400">Compara las 5 posiciones CAGED simultáneamente</p>
                    </div>
                    <button id="cagedShowAllToggle" class="relative inline-flex h-8 w-16 items-center rounded-full bg-void-700 transition-colors">
                        <span class="inline-block h-6 w-6 transform rounded-full bg-chalk-100 transition-transform translate-x-1" id="caged-toggle-dot"></span>
                    </button>
                </div>

                <!-- Diagramas de todas las formas -->
                <div id="caged-all-diagrams" class="hidden mt-4">
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-3" id="caged-diagrams-container">
                        <!-- Diagramas generados dinámicamente -->
                    </div>
                </div>
            </div>

            <!-- Sección 4: Ejercicio práctico -->
            <div class="p-4 bg-void-800 rounded-lg">
                <h3 class="text-lg font-medium text-sage-400 mb-3">
                    🎯 Ejercicio: Encuentra el patrón
                </h3>
                <p class="text-sm text-chalk-200 mb-3">
                    Prueba tocar un acorde C mayor usando las 5 formas CAGED en orden:
                </p>
                <ol class="text-sm text-void-300 space-y-2 ml-6 list-decimal">
                    <li>Forma C (posición abierta) - Traste 0</li>
                    <li>Forma A (barre en 3er traste) - Traste 3</li>
                    <li>Forma G (barre en 5º traste) - Traste 5</li>
                    <li>Forma E (barre en 8º traste) - Traste 8</li>
                    <li>Forma D (barre en 10º traste) - Traste 10</li>
                </ol>
                <div class="mt-4 p-3 bg-blue-900/20 border border-blue-700 rounded">
                    <strong class="text-blue-400">💡 Reto avanzado:</strong>
                    <p class="text-sm text-chalk-200 mt-1">
                        ¿Puedes tocar una progresión I-IV-V (C-F-G) usando solo formas E?
                    </p>
                </div>
            </div>
        </div>
    </template>

    <template id="tpl-quiz">
        <div class="space-y-4">
            <div class="flex flex-wrap items-center gap-3">
                <span class="text-sm text-void-400">Categoría:</span>
                <div class="flex flex-wrap gap-2">
                    <button class="quiz-cat-btn active" data-category="intervals">Intervalos</button>
                    <button class="quiz-cat-btn" data-category="scales">Escalas</button>
                    <button class="quiz-cat-btn" data-category="chords">Acordes</button>
                    <button class="quiz-cat-btn" data-category="modes">Modos</button>
                    <button class="quiz-cat-btn" data-category="theory">Teoría</button>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <span class="text-sm text-void-400">Dificultad:</span>
                <button class="box-btn active" data-diff="easy">Fácil</button>
                <button class="box-btn" data-diff="medium">Medio</button>
                <button class="box-btn" data-diff="hard">Difícil</button>
            </div>
            <div class="flex items-center gap-6 text-sm">
                <span>Puntos: <strong id="quizScore" class="text-blood-400">0</strong></span>
                <span>Racha: <strong id="quizStreak" class="text-brass-400">0</strong></span>
                <span>Mejor: <strong id="quizBest" class="text-chalk-100">0</strong></span>
                <button class="btn-secondary ml-4" id="newQuizBtn">Nueva Pregunta</button>
            </div>
        </div>
    </template>

    <template id="tpl-extended">
        <div class="ext-matrix">
            <div class="ext-matrix-grid">
                <!-- Header row -->
                <div class="ext-matrix-corner"></div>
                <div class="ext-matrix-col-header">Major</div>
                <div class="ext-matrix-col-header">Dom</div>
                <div class="ext-matrix-col-header">Minor</div>
                <div class="ext-matrix-col-header">Alter.</div>
                <!-- 9ª row -->
                <div class="ext-matrix-row-header">9ª</div>
                <button class="ext-matrix-btn active" data-ext="9" data-quality="maj">maj9</button>
                <button class="ext-matrix-btn" data-ext="9" data-quality="dom">9</button>
                <button class="ext-matrix-btn" data-ext="9" data-quality="min">m9</button>
                <button class="ext-matrix-btn" data-ext="9" data-quality="alt">7#9</button>
                <!-- 11ª row -->
                <div class="ext-matrix-row-header">11ª</div>
                <button class="ext-matrix-btn" data-ext="11" data-quality="maj">maj11</button>
                <button class="ext-matrix-btn" data-ext="11" data-quality="dom">11</button>
                <button class="ext-matrix-btn" data-ext="11" data-quality="min">m11</button>
                <button class="ext-matrix-btn" data-ext="11" data-quality="alt">m11</button>
                <!-- 13ª row -->
                <div class="ext-matrix-row-header">13ª</div>
                <button class="ext-matrix-btn" data-ext="13" data-quality="maj">maj13</button>
                <button class="ext-matrix-btn" data-ext="13" data-quality="dom">13</button>
                <button class="ext-matrix-btn" data-ext="13" data-quality="min">m13</button>
                <button class="ext-matrix-btn" data-ext="13" data-quality="alt">13</button>
            </div>
        </div>
    </template>

    <template id="tpl-chord-lab">
        <div class="space-y-4">
            <!-- Mode Tabs -->
            <div class="flex gap-2 border-b border-void-700 pb-2">
                <button class="chord-lab-mode-btn active" data-mode="explorer">
                    🔍 Explorer
                </button>
                <button class="chord-lab-mode-btn" data-mode="progression-builder">
                    🎵 Progression Lab
                </button>
                <button class="chord-lab-mode-btn" data-mode="chord-builder">
                    🎨 Chord Builder
                </button>
                <button class="chord-lab-mode-btn" data-mode="practice">
                    💪 Practice
                </button>
            </div>

            <!-- Mode: Explorer -->
            <div id="chord-lab-explorer" class="chord-lab-mode">
                <!-- Filters -->
                <div class="space-y-3">
                    <div class="flex flex-wrap items-center gap-3">
                        <span class="text-sm text-void-400">Root:</span>
                        <select id="chord-lab-root" class="px-3 py-1.5 bg-void-800 text-chalk-100 rounded border border-void-600">
                            <option value="C">C</option>
                            <option value="C#">C#</option>
                            <option value="D">D</option>
                            <option value="Eb">Eb</option>
                            <option value="E">E</option>
                            <option value="F">F</option>
                            <option value="F#">F#</option>
                            <option value="G">G</option>
                            <option value="Ab">Ab</option>
                            <option value="A">A</option>
                            <option value="Bb">Bb</option>
                            <option value="B">B</option>
                        </select>
                        <span class="text-sm text-void-400 ml-4">Quality:</span>
                        <button class="chord-lab-quality-btn active" data-quality="maj">Major</button>
                        <button class="chord-lab-quality-btn" data-quality="min">Minor</button>
                        <button class="chord-lab-quality-btn" data-quality="7">7th</button>
                        <button class="chord-lab-quality-btn" data-quality="maj7">maj7</button>
                        <button class="chord-lab-quality-btn" data-quality="m7">m7</button>
                        <button class="chord-lab-quality-btn" data-quality="9">9th</button>
                        <button class="chord-lab-quality-btn" data-quality="11">11th</button>
                        <button class="chord-lab-quality-btn" data-quality="13">13th</button>
                    </div>
                </div>

                <!-- Voicings Grid -->
                <div id="chord-lab-voicings-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mt-4">
                    <!-- Populated by JS -->
                </div>

                <!-- Comparison Panel (shown when A/B mode active) -->
                <div id="chord-lab-comparison" class="hidden mt-6 p-4 bg-void-800 rounded-lg border border-sage-500">
                    <h3 class="text-lg font-medium text-sage-400 mb-3">A/B Comparison</h3>
                    <div class="grid grid-cols-2 gap-6">
                        <div id="chord-lab-compare-a"></div>
                        <div id="chord-lab-compare-b"></div>
                    </div>
                    <div class="mt-4 flex gap-3">
                        <button id="chord-lab-play-both" class="px-4 py-2 bg-sage-600 hover:bg-sage-500 text-chalk-100 rounded">
                            ▶▶ Play Both
                        </button>
                        <button id="chord-lab-clear-comparison" class="px-4 py-2 bg-void-700 hover:bg-void-600 text-chalk-100 rounded">
                            Clear
                        </button>
                    </div>
                </div>
            </div>

            <!-- Mode: Progression Lab Pro -->
            <div id="chord-lab-progression-builder" class="chord-lab-mode hidden">
                <!-- Sub-tabs for Guided/Free modes -->
                <div class="flex gap-2 border-b border-void-700 pb-2 mb-4">
                    <button class="progression-mode-btn active" data-submode="guided">
                        🎯 Guiado
                    </button>
                    <button class="progression-mode-btn" data-submode="free">
                        🎨 Libre
                    </button>
                </div>

                <!-- Main Layout: Progression + Analysis -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                    <!-- LEFT: Progression Chain Panel -->
                    <div class="lg:col-span-2 space-y-4">
                        <!-- Progression Chain -->
                        <div class="p-4 bg-void-800 rounded-lg border border-sage-600">
                            <div class="flex justify-between items-center mb-3">
                                <h3 class="text-lg font-medium text-sage-400">🎵 Progresión</h3>
                                <div class="text-xs text-void-400">
                                    <span id="progression-key-display">Tonalidad: C</span>
                                </div>
                            </div>

                            <div id="progression-chain" class="flex items-center gap-2 flex-wrap min-h-[60px] p-3 bg-void-900 rounded">
                                <span class="text-sm text-void-400">Añade acordes para comenzar...</span>
                            </div>

                            <!-- Voice Leading Visualization -->
                            <div id="voice-leading-viz" class="mt-4 p-3 bg-void-900 rounded hidden">
                                <div class="text-xs text-sage-400 mb-2">Voice Leading:</div>
                                <svg id="voice-leading-svg" width="100%" height="60" class="overflow-visible"></svg>
                            </div>

                            <!-- Controls -->
                            <div class="mt-4 flex flex-wrap gap-2">
                                <button id="play-progression" class="px-4 py-2 bg-sage-600 hover:bg-sage-500 text-chalk-100 rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                    ▶ Play
                                </button>
                                <button id="save-progression" class="px-3 py-2 bg-blue-600 hover:bg-blue-500 text-chalk-100 rounded text-sm disabled:opacity-50" disabled>
                                    💾 Save
                                </button>
                                <button id="load-progression" class="px-3 py-2 bg-teal-600 hover:bg-teal-500 text-chalk-100 rounded text-sm">
                                    📂 Load
                                </button>
                                <button id="transpose-progression" class="px-3 py-2 bg-purple-600 hover:bg-purple-500 text-chalk-100 rounded text-sm disabled:opacity-50" disabled>
                                    🔄 Transpose
                                </button>
                                <button id="reverse-progression" class="px-3 py-2 bg-amber-600 hover:bg-amber-500 text-chalk-100 rounded text-sm disabled:opacity-50" disabled>
                                    ↩️ Reverse
                                </button>
                                <button id="mutate-progression" class="px-3 py-2 bg-indigo-600 hover:bg-indigo-500 text-chalk-100 rounded text-sm disabled:opacity-50" disabled>
                                    🎲 Mutate
                                </button>
                                <button id="clear-progression" class="px-3 py-2 bg-red-600 hover:bg-red-500 text-chalk-100 rounded text-sm disabled:opacity-50" disabled>
                                    🗑️ Clear
                                </button>
                            </div>
                        </div>

                        <!-- GUIDED MODE Content -->
                        <div id="guided-mode-content" class="space-y-4">
                            <!-- Step 1: Initial Chord (only shown when empty) -->
                            <div id="initial-chord-selector" class="p-4 bg-void-800 rounded-lg">
                                <h3 class="text-sm font-medium text-sage-400 mb-3">1️⃣ Acorde Inicial</h3>
                                <div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-2">
                                    <button class="initial-chord-btn" data-chord="C" data-quality="maj">C</button>
                                    <button class="initial-chord-btn" data-chord="Cm" data-quality="min">Cm</button>
                                    <button class="initial-chord-btn" data-chord="D" data-quality="maj">D</button>
                                    <button class="initial-chord-btn" data-chord="Dm" data-quality="min">Dm</button>
                                    <button class="initial-chord-btn" data-chord="E" data-quality="maj">E</button>
                                    <button class="initial-chord-btn" data-chord="Em" data-quality="min">Em</button>
                                    <button class="initial-chord-btn" data-chord="F" data-quality="maj">F</button>
                                    <button class="initial-chord-btn" data-chord="Fm" data-quality="min">Fm</button>
                                    <button class="initial-chord-btn" data-chord="G" data-quality="maj">G</button>
                                    <button class="initial-chord-btn" data-chord="Gm" data-quality="min">Gm</button>
                                    <button class="initial-chord-btn" data-chord="A" data-quality="maj">A</button>
                                    <button class="initial-chord-btn" data-chord="Am" data-quality="min">Am</button>
                                </div>
                            </div>

                            <!-- Step 2: Emotion Selector -->
                            <div id="emotion-selector" class="p-4 bg-void-800 rounded-lg hidden">
                                <h3 class="text-sm font-medium text-sage-400 mb-3">2️⃣ Color/Emoción</h3>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                                    <button class="emotion-btn" data-emotion="bright">
                                        <div class="text-xl mb-1">☀️</div>
                                        <div class="text-xs font-medium">Brillante</div>
                                    </button>
                                    <button class="emotion-btn" data-emotion="dark">
                                        <div class="text-xl mb-1">🌙</div>
                                        <div class="text-xs font-medium">Oscuro</div>
                                    </button>
                                    <button class="emotion-btn" data-emotion="tense">
                                        <div class="text-xl mb-1">⚡</div>
                                        <div class="text-xs font-medium">Tenso</div>
                                    </button>
                                    <button class="emotion-btn" data-emotion="resolved">
                                        <div class="text-xl mb-1">✨</div>
                                        <div class="text-xs font-medium">Resolutivo</div>
                                    </button>
                                </div>
                            </div>

                            <!-- Step 3: Chord Suggestions -->
                            <div id="chord-suggestions" class="hidden">
                                <h3 class="text-sm font-medium text-sage-400 mb-3">3️⃣ Sugerencias</h3>
                                <div id="suggestions-grid" class="grid grid-cols-1 md:grid-cols-2 gap-3"></div>
                            </div>
                        </div>

                        <!-- FREE MODE Content -->
                        <div id="free-mode-content" class="hidden">
                            <div class="p-4 bg-void-800 rounded-lg">
                                <h3 class="text-sm font-medium text-sage-400 mb-3">🎨 Paleta de Acordes</h3>
                                <div class="space-y-3">
                                    <!-- Key selector -->
                                    <div class="flex items-center gap-3">
                                        <span class="text-xs text-void-400">Tonalidad:</span>
                                        <select id="free-mode-key" class="px-2 py-1 bg-void-900 text-chalk-100 rounded border border-void-600 text-sm">
                                            <option value="C">C</option>
                                            <option value="D">D</option>
                                            <option value="E">E</option>
                                            <option value="F">F</option>
                                            <option value="G">G</option>
                                            <option value="A">A</option>
                                            <option value="B">B</option>
                                        </select>
                                    </div>

                                    <!-- Chord palette with color-coding -->
                                    <div id="free-mode-palette" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2">
                                        <!-- Populated by JS with color-coded compatibility -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- RIGHT: Analysis Panel -->
                    <div class="space-y-4">
                        <!-- Harmonic Analysis -->
                        <div class="p-4 bg-void-800 rounded-lg border border-sage-600">
                            <h3 class="text-sm font-medium text-sage-400 mb-3">📊 Análisis</h3>
                            <div id="analysis-content" class="space-y-3 text-xs">
                                <div class="text-void-400">Añade acordes para ver análisis...</div>
                            </div>
                        </div>

                        <!-- Voice Leading Details -->
                        <div id="voice-leading-panel" class="p-4 bg-void-800 rounded-lg border border-amber-600 hidden">
                            <h3 class="text-sm font-medium text-amber-400 mb-3">🎼 Voice Leading</h3>
                            <div id="voice-leading-content" class="space-y-2 text-xs"></div>
                        </div>

                        <!-- Story/Narrative -->
                        <div id="progression-story" class="p-4 bg-sage-900/20 rounded-lg border border-sage-600 hidden">
                            <h3 class="text-sm font-medium text-sage-400 mb-2">📖 Historia</h3>
                            <div id="story-content" class="text-xs text-void-300 leading-relaxed"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Mode: Practice Builder -->
            <div id="chord-lab-practice" class="chord-lab-mode hidden">
                <div class="space-y-4">
                    <div>
                        <h3 class="text-lg font-medium text-sage-400 mb-3">Practice Exercises</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <button class="chord-lab-exercise-btn" data-exercise="shape-shifting">
                                <div class="text-base font-medium">Shape Shifting</div>
                                <div class="text-sm text-void-400">Same chord, different forms</div>
                            </button>
                            <button class="chord-lab-exercise-btn" data-exercise="position-trainer">
                                <div class="text-base font-medium">Position Trainer</div>
                                <div class="text-sm text-void-400">Random chord quiz</div>
                            </button>
                            <button class="chord-lab-exercise-btn" data-exercise="progression-voicings">
                                <div class="text-base font-medium">Progression Voicings</div>
                                <div class="text-sm text-void-400">Best shapes for songs</div>
                            </button>
                        </div>
                    </div>
                    <div id="chord-lab-practice-area" class="p-4 bg-void-800 rounded-lg hidden">
                        <!-- Practice content loaded here -->
                    </div>
                </div>
            </div>

            <!-- Mode: Chord Builder -->
            <div id="chord-lab-chord-builder" class="chord-lab-mode hidden">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                    <!-- LEFT: Interactive Fretboard -->
                    <div class="lg:col-span-2 space-y-4">
                        <div class="p-4 bg-void-800 rounded-lg border border-sage-600">
                            <h3 class="text-sm font-medium text-sage-400 mb-3">🎸 Diapasón Interactivo</h3>
                            <p class="text-xs text-void-400 mb-4">Click en las notas para construir tu acorde</p>

                            <!-- Interactive Fretboard -->
                            <div id="chord-builder-fretboard" class="relative">
                                <!-- Populated by JS -->
                            </div>

                            <div class="mt-4 flex gap-2">
                                <button id="chord-builder-play" class="px-4 py-2 bg-sage-600 hover:bg-sage-500 text-chalk-100 rounded text-sm">
                                    ▶ Play
                                </button>
                                <button id="chord-builder-clear" class="px-3 py-2 bg-void-700 hover:bg-void-600 text-chalk-100 rounded text-sm">
                                    Clear
                                </button>
                                <button id="chord-builder-save" class="px-3 py-2 bg-blue-600 hover:bg-blue-500 text-chalk-100 rounded text-sm">
                                    💾 Save
                                </button>
                            </div>
                        </div>

                        <!-- Suggestions Panel -->
                        <div id="chord-builder-suggestions" class="p-4 bg-void-800 rounded-lg hidden">
                            <h3 class="text-sm font-medium text-sage-400 mb-3">💡 Sugerencias</h3>
                            <div id="chord-builder-suggestions-content" class="space-y-2 text-xs">
                                <!-- Populated by JS -->
                            </div>
                        </div>
                    </div>

                    <!-- RIGHT: Analysis & Info -->
                    <div class="space-y-4">
                        <!-- Chord Identification -->
                        <div class="p-4 bg-void-800 rounded-lg border border-sage-600">
                            <h3 class="text-sm font-medium text-sage-400 mb-3">🎯 Identificación</h3>
                            <div id="chord-builder-identification" class="space-y-3">
                                <div>
                                    <div class="text-void-400 text-xs mb-1">Acorde:</div>
                                    <div id="chord-builder-name" class="text-2xl font-bold text-chalk-100">
                                        ---
                                    </div>
                                </div>
                                <div>
                                    <div class="text-void-400 text-xs mb-1">Notas:</div>
                                    <div id="chord-builder-notes" class="text-sm text-chalk-200">
                                        Selecciona notas...
                                    </div>
                                </div>
                                <div>
                                    <div class="text-void-400 text-xs mb-1">Intervalos:</div>
                                    <div id="chord-builder-intervals" class="text-sm text-chalk-200">
                                        ---
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Voicing Analysis -->
                        <div id="chord-builder-analysis" class="p-4 bg-void-800 rounded-lg hidden">
                            <h3 class="text-sm font-medium text-sage-400 mb-3">📊 Análisis</h3>
                            <div id="chord-builder-analysis-content" class="space-y-2 text-xs">
                                <!-- Populated by JS -->
                            </div>
                        </div>

                        <!-- Saved Voicings Library -->
                        <div class="p-4 bg-void-800 rounded-lg">
                            <h3 class="text-sm font-medium text-sage-400 mb-3">📚 Mis Voicings</h3>
                            <div id="chord-builder-library" class="space-y-2">
                                <div class="text-xs text-void-400 text-center py-4">
                                    Guarda voicings para crear tu biblioteca
                                </div>
                            </div>
                        </div>

                        <!-- Famous Voicings -->
                        <div class="p-4 bg-void-800 rounded-lg">
                            <h3 class="text-sm font-medium text-sage-400 mb-3">⭐ Voicings Famosos</h3>
                            <div id="chord-builder-famous" class="space-y-1">
                                <button class="w-full text-left px-2 py-1 text-xs bg-void-900 hover:bg-void-700 rounded" data-voicing="Dsus2_bright">
                                    Dsus2 - Wonderwall
                                </button>
                                <button class="w-full text-left px-2 py-1 text-xs bg-void-900 hover:bg-void-700 rounded" data-voicing="Em7_beatles">
                                    Em7 - Something
                                </button>
                                <button class="w-full text-left px-2 py-1 text-xs bg-void-900 hover:bg-void-700 rounded" data-voicing="Gmaj7_bright">
                                    Gmaj7 - Bright
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Shared Fretboard Display -->
            <div id="chord-lab-fretboard-display" class="mt-6">
                <h3 class="text-lg font-medium text-sage-400 mb-3">Fretboard View</h3>
                <div id="chord-lab-fretboard-container"></div>

                <!-- Chord Story Panel -->
                <div id="chord-story-panel" class="mt-4 p-4 bg-sage-900/20 border border-sage-600 rounded-lg hidden">
                    <h4 class="text-lg font-medium text-sage-400 mb-3">📖 Historia de este acorde</h4>
                    <div id="chord-story-content" class="space-y-2 text-sm">
                        <!-- Contenido dinámico -->
                    </div>
                </div>
            </div>
        </div>
    </template>

    <template id="tpl-secondary">
        <div class="space-y-3">
            <div class="flex flex-wrap items-center gap-3">
                <span class="text-sm text-void-400">Dominante de:</span>
                <button class="chord-btn active" data-secondary="ii">V/ii</button>
                <button class="chord-btn" data-secondary="iii">V/iii</button>
                <button class="chord-btn" data-secondary="IV">V/IV</button>
                <button class="chord-btn" data-secondary="V">V/V</button>
                <button class="chord-btn" data-secondary="vi">V/vi</button>
            </div>
            <div class="flex flex-wrap items-center gap-3">
                <span class="text-sm text-void-400">Progresiones:</span>
                <button class="progression-btn-simple" data-secprog="1">V/V → V → I</button>
                <button class="progression-btn-simple" data-secprog="2">I → V/vi → vi</button>
                <button class="progression-btn-simple" data-secprog="3">ii-V secundario</button>
            </div>
        </div>
    </template>

    <template id="tpl-songs">
        <div class="space-y-4">
            <div class="flex flex-wrap items-center gap-3">
                <span class="text-sm text-void-400">Género:</span>
                <button class="scale-cat-btn active" data-genre="all">Todos</button>
                <button class="scale-cat-btn" data-genre="metal">Metal</button>
                <button class="scale-cat-btn" data-genre="prog">Progresivo</button>
                <button class="scale-cat-btn" data-genre="rock">Rock</button>
                <button class="scale-cat-btn" data-genre="blues">Blues</button>
                <button class="scale-cat-btn" data-genre="jazz">Jazz</button>
                <button class="scale-cat-btn" data-genre="funk">Funk/Soul</button>
                <button class="scale-cat-btn" data-genre="pop">Pop</button>
                <button class="scale-cat-btn" data-genre="latin">Latino</button>
                <button class="scale-cat-btn" data-genre="country">Country</button>
                <button class="scale-cat-btn" data-genre="reggae">Reggae</button>
            </div>
        </div>
    </template>

    <template id="tpl-ear-training">
        <div class="space-y-4">
            <!-- Header con estilo industrial -->
            <div style="border-left: 3px solid #dc2626; padding-left: 12px; margin-bottom: 20px;">
                <div class="text-xs text-void-400 uppercase tracking-widest mb-1">Entrenamiento Auditivo</div>
                <div class="text-sm text-chalk-100">Desarrolla tu oído musical</div>
            </div>

            <!-- Tabs de tipo de ejercicio -->
            <div class="flex flex-wrap items-center gap-2 mb-4">
                <button class="ear-exercise-tab active" data-exercise="intervals">Intervalos</button>
                <button class="ear-exercise-tab" data-exercise="chords">Acordes</button>
                <button class="ear-exercise-tab" data-exercise="progressions">Progresiones</button>
                <button class="ear-exercise-tab" data-exercise="melodic">Melodía</button>
                <button class="ear-exercise-tab" data-exercise="rhythmic">Ritmo</button>
            </div>

            <!-- Dificultad -->
            <div class="flex flex-wrap items-center gap-3 mb-4">
                <span class="text-xs text-void-400 uppercase tracking-wider" style="min-width: 90px;">Nivel:</span>
                <button class="scale-cat-btn active" data-ear-level="easy">Principiante</button>
                <button class="scale-cat-btn" data-ear-level="medium">Intermedio</button>
                <button class="scale-cat-btn" data-ear-level="hard">Avanzado</button>
            </div>

            <!-- Controles principales -->
            <div class="grid grid-cols-2 gap-3 mb-6">
                <button id="playIntervalBtn" class="mode-btn-simple" style="background: #dc2626; padding: 14px; font-weight: 600;">
                    ▶ REPRODUCIR
                </button>
                <button id="newIntervalBtn" class="mode-btn-simple" style="background: #404040; padding: 14px;">
                    ⏭ SIGUIENTE
                </button>
            </div>

            <!-- Respuestas -->
            <div style="background: rgba(0,0,0,0.4); padding: 16px; border-radius: 4px; border: 1px solid rgba(220, 38, 38, 0.2);">
                <div class="text-xs text-void-400 uppercase tracking-wider mb-3" id="earQuestionLabel">¿Qué intervalo escuchaste?</div>
                <div id="earTrainingAnswers" class="grid grid-cols-2 gap-2">
                    <!-- Botones generados dinámicamente -->
                </div>
            </div>

            <!-- Tips -->
            <div id="earTipBox" style="background: rgba(220, 38, 38, 0.1); padding: 12px; border-radius: 4px; border-left: 3px solid #dc2626;">
                <div class="text-xs text-void-400 leading-relaxed">
                    <strong style="color: #dc2626;">TIP:</strong> <span id="earTipText">Escucha el salto entre las dos notas.
                    Los intervalos pequeños (2ª, 3ª) suenan cercanos, mientras que los grandes (6ª, 7ª, 8ª) tienen un salto más amplio.</span>
                </div>
            </div>
        </div>
    </template>

    <template id="tpl-jam-session">
        <div class="jam-session-layout">
            <!-- SIDEBAR DE TRACKS -->
            <div class="jam-sidebar">
                <div class="jam-sidebar-header">
                    <span class="sidebar-label">TRACKS</span>
                    <span class="sidebar-count" id="jamTrackCount">17</span>
                </div>
                <div id="jamTrackGrid" class="jam-tracklist">
                    <!-- Generado dinámicamente -->
                </div>
            </div>

            <!-- ÁREA PRINCIPAL -->
            <div class="jam-main-area">
                <!-- KEY INFO BAR (3 columnas: KEY | PROGRESSION | CONTROLS) -->
                <div class="jam-keyinfo-bar">
                    <div class="key-display">
                        <div class="key-label">KEY</div>
                        <div id="jamKeyDisplay" class="key-value">C MAYOR</div>
                    </div>

                    <div class="progression-display">
                        <div class="progression-label">PROGRESSION</div>
                        <div id="jamProgressionDisplay" class="progression-chords"></div>
                    </div>

                    <div class="jam-controls">
                        <div class="control-row">
                            <button id="playTrackBtn" class="ctrl-btn ctrl-play">▶</button>
                            <button id="stopTrackBtn" class="ctrl-btn ctrl-stop" disabled>■</button>
                            <select id="jamKeySelector" class="ctrl-select">
                                <option value="0">C</option>
                                <option value="1">C# / Db</option>
                                <option value="2">D</option>
                                <option value="3">D# / Eb</option>
                                <option value="4">E</option>
                                <option value="5">F</option>
                                <option value="6">F# / Gb</option>
                                <option value="7">G</option>
                                <option value="8">G# / Ab</option>
                                <option value="9">A</option>
                                <option value="10">A# / Bb</option>
                                <option value="11">B</option>
                            </select>
                        </div>
                        <div class="control-row">
                            <input type="range" id="bpmSlider" class="ctrl-slider" min="40" max="200" value="120" />
                            <span id="jamBpmDisplay" class="bpm-value"></span>
                            <label class="ctrl-toggle">
                                <input type="checkbox" id="syncBPMToggle" checked />
                                <span>SYNC</span>
                            </label>
                            <label class="ctrl-toggle">
                                <input type="checkbox" id="drumsToggle" checked />
                                <span>DRUMS</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- FRETBOARD CONTAINER (MAXIMIZADO) -->
                <div class="jam-fretboard-container">
                    <!-- Fret numbers -->
                    <div style="display: flex; padding-left: 32px; margin-bottom: 8px;">
                        <div style="width: 32px;"></div>
                        <div style="flex: 1; display: flex;">
                            <div style="flex: 0.6;"></div>
                            <div style="flex: 1; text-align: center; font-family: 'JetBrains Mono', monospace; font-size: 11px; color: #666;">1</div>
                            <div style="flex: 1; text-align: center; font-family: 'JetBrains Mono', monospace; font-size: 11px; color: #666;">2</div>
                            <div style="flex: 1; text-align: center; font-family: 'JetBrains Mono', monospace; font-size: 11px; color: #666; font-weight: bold;">3</div>
                            <div style="flex: 1; text-align: center; font-family: 'JetBrains Mono', monospace; font-size: 11px; color: #666;">4</div>
                            <div style="flex: 1; text-align: center; font-family: 'JetBrains Mono', monospace; font-size: 11px; color: #666; font-weight: bold;">5</div>
                            <div style="flex: 1; text-align: center; font-family: 'JetBrains Mono', monospace; font-size: 11px; color: #666;">6</div>
                            <div style="flex: 1; text-align: center; font-family: 'JetBrains Mono', monospace; font-size: 11px; color: #666; font-weight: bold;">7</div>
                            <div style="flex: 1; text-align: center; font-family: 'JetBrains Mono', monospace; font-size: 11px; color: #666;">8</div>
                            <div style="flex: 1; text-align: center; font-family: 'JetBrains Mono', monospace; font-size: 11px; color: #666; font-weight: bold;">9</div>
                            <div style="flex: 1; text-align: center; font-family: 'JetBrains Mono', monospace; font-size: 11px; color: #666;">10</div>
                            <div style="flex: 1; text-align: center; font-family: 'JetBrains Mono', monospace; font-size: 11px; color: #666;">11</div>
                            <div style="flex: 1; text-align: center; font-family: 'JetBrains Mono', monospace; font-size: 11px; color: #dc2626; font-weight: bold;">12</div>
                        </div>
                    </div>

                    <!-- Fretboard -->
                    <div id="jamFretboard" class="fretboard-container" style="padding: 16px;">
                        <!-- Generated by JS -->
                    </div>

                    <!-- Fret markers -->
                    <div style="display: flex; margin-top: 12px; padding-left: 32px;">
                        <div style="width: 32px;"></div>
                        <div style="flex: 1; display: flex;">
                            <div style="flex: 0.6;"></div>
                            <div style="flex: 1;"></div>
                            <div style="flex: 1;"></div>
                            <div style="flex: 1; display: flex; justify-content: center;"><div style="width: 12px; height: 12px; border-radius: 50%; background: #404040;"></div></div>
                            <div style="flex: 1;"></div>
                            <div style="flex: 1; display: flex; justify-content: center;"><div style="width: 12px; height: 12px; border-radius: 50%; background: #404040;"></div></div>
                            <div style="flex: 1;"></div>
                            <div style="flex: 1; display: flex; justify-content: center;"><div style="width: 12px; height: 12px; border-radius: 50%; background: #404040;"></div></div>
                            <div style="flex: 1;"></div>
                            <div style="flex: 1; display: flex; justify-content: center;"><div style="width: 12px; height: 12px; border-radius: 50%; background: #404040;"></div></div>
                            <div style="flex: 1;"></div>
                            <div style="flex: 1;"></div>
                            <div style="flex: 1; display: flex; justify-content: center; gap: 8px;"><div style="width: 12px; height: 12px; border-radius: 50%; background: #dc2626;"></div><div style="width: 12px; height: 12px; border-radius: 50%; background: #dc2626;"></div></div>
                        </div>
                    </div>
                </div>

                <!-- LIVE PROGRESS (aparece cuando está playing) -->
                <div id="jamProgressDisplay" class="jam-live-progress">
                    <div class="live-header">
                        <span class="live-label">LIVE</span>
                        <span class="live-stats">
                            <span class="live-stat">Bar <span id="currentBarDisplay">1/4</span></span>
                            <span class="live-stat">Loop <span id="loopCountDisplay">1</span></span>
                        </span>
                    </div>

                    <div class="live-chord">
                        <div id="currentChordName" class="live-chord-name">C</div>
                        <div id="currentChordFunction" class="live-chord-function">Tónica</div>
                    </div>

                    <div class="live-beats">
                        <div class="beat-pip" data-beat="0"></div>
                        <div class="beat-pip" data-beat="1"></div>
                        <div class="beat-pip" data-beat="2"></div>
                        <div class="beat-pip" data-beat="3"></div>
                    </div>

                    <div class="live-progress-track">
                        <div id="jamProgressBar" class="live-progress-fill"></div>
                    </div>
                </div>

                <!-- TIP COMPACTO -->
                <div class="jam-tip">
                    <strong>TIP:</strong> El diapasón muestra la escala recomendada para improvisar.
                </div>
            </div>
        </div>
    </template>

    <template id="tpl-lick-library">
        <div class="lick-library-container space-y-6">
            <div class="library-header">
                <h2 class="text-3xl font-display text-chalk-100 mb-2">LICK LIBRARY</h2>
                <p class="text-void-300 font-body">Biblioteca de licks con tabs interactivos. Aprende técnicas avanzadas paso a paso.</p>
            </div>

            <!-- Filtros -->
            <div class="library-filters flex flex-wrap gap-4 items-center">
                <div class="filter-group">
                    <label class="text-sm text-void-400 font-body uppercase tracking-wider font-semibold">Género:</label>
                    <select id="lickGenreFilter" class="filter-select">
                        <option value="all">Todos</option>
                        <option value="metal">Metal</option>
                        <option value="rock">Rock</option>
                        <option value="jazz">Jazz</option>
                        <option value="fusion">Fusion</option>
                        <option value="progressive">Progressive</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label class="text-sm text-void-400 font-body uppercase tracking-wider font-semibold">Técnica:</label>
                    <select id="lickTechniqueFilter" class="filter-select">
                        <option value="all">Todas</option>
                        <option value="sweep">Sweep Picking</option>
                        <option value="tapping">Tapping</option>
                        <option value="alternate">Alternate Picking</option>
                        <option value="legato">Legato</option>
                        <option value="rhythm">Rhythm</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label class="text-sm text-void-400 font-body uppercase tracking-wider font-semibold">Dificultad:</label>
                    <select id="lickDifficultyFilter" class="filter-select">
                        <option value="all">Todas</option>
                        <option value="easy">Principiante</option>
                        <option value="medium">Intermedio</option>
                        <option value="hard">Avanzado</option>
                        <option value="expert">Experto</option>
                    </select>
                </div>
            </div>

            <!-- Grid de licks -->
            <div id="lickGrid" class="lick-grid"></div>

            <!-- Lick detail view (modal) -->
            <div id="lickDetailModal" class="lick-modal hidden">
                <div class="lick-modal-content">
                    <button class="lick-modal-close">&times;</button>
                    <div id="lickDetailContent"></div>
                </div>
            </div>
        </div>
    </template>

    <!-- CLEANED: Old level cards content removed, now using templates + control panel -->

    <script>
        // ========================================
        // MUSIC THEORY ENGINE
        // ========================================
        const MusicTheory = {
            // Cache para memoización
            _cache: new Map(),

            // Función auxiliar de memoización
            _memoize(fn, key) {
                if (this._cache.has(key)) {
                    return this._cache.get(key);
                }
                const result = fn.call(this);
                this._cache.set(key, result);
                return result;
            },

            // 12 chromatic notes
            notes: ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'],

            // Enharmonic equivalents for display
            enharmonics: {
                'C#': 'Db', 'D#': 'Eb', 'F#': 'Gb', 'G#': 'Ab', 'A#': 'Bb'
            },

            // Scale formulas (intervals from root)
            scales: {
                // === ESCALAS MAYORES ===
                major:      [0, 2, 4, 5, 7, 9, 11],  // W-W-H-W-W-W-H (Jónico)

                // === ESCALAS MENORES ===
                minor:      [0, 2, 3, 5, 7, 8, 10],  // W-H-W-W-H-W-W (Menor Natural / Eólico)
                harmonicMinor: [0, 2, 3, 5, 7, 8, 11], // Menor Armónica (7 natural)
                melodicMinor:  [0, 2, 3, 5, 7, 9, 11], // Menor Melódica ascendente
                dorianMinor:   [0, 2, 3, 5, 7, 9, 10], // Menor Dórica (6 natural)

                // === MODOS DE LA ESCALA MAYOR ===
                dorian:     [0, 2, 3, 5, 7, 9, 10],  // II grado - menor con 6 natural
                phrygian:   [0, 1, 3, 5, 7, 8, 10],  // III grado - menor con b2
                lydian:     [0, 2, 4, 6, 7, 9, 11],  // IV grado - mayor con #4
                mixolydian: [0, 2, 4, 5, 7, 9, 10],  // V grado - mayor con b7
                locrian:    [0, 1, 3, 5, 6, 8, 10],  // VII grado - menor con b2 y b5

                // === MODOS DE LA MENOR ARMÓNICA ===
                locrianNat6:    [0, 1, 3, 5, 6, 9, 10],  // II de armónica
                ionianAug:      [0, 2, 4, 5, 8, 9, 11],  // III de armónica (Jónico #5)
                dorianSharp4:   [0, 2, 3, 6, 7, 9, 10],  // IV de armónica (Dórico #4)
                phrygianDom:    [0, 1, 4, 5, 7, 8, 10],  // V de armónica (Frigio Dominante/Español)
                lydianSharp2:   [0, 3, 4, 6, 7, 9, 11],  // VI de armónica
                superLocrian:   [0, 1, 3, 4, 6, 8, 10],  // VII de armónica (Superlocrio bb7)

                // === MODOS DE LA MENOR MELÓDICA ===
                dorianB2:       [0, 1, 3, 5, 7, 9, 10],  // II de melódica (Dórico b2)
                lydianAug:      [0, 2, 4, 6, 8, 9, 11],  // III de melódica (Lidio #5)
                lydianDom:      [0, 2, 4, 6, 7, 9, 10],  // IV de melódica (Lidio b7)
                mixolydianB6:   [0, 2, 4, 5, 7, 8, 10],  // V de melódica (Mixolidio b6)
                locrianNat2:    [0, 2, 3, 5, 6, 8, 10],  // VI de melódica (Locrio nat2)
                alteredScale:   [0, 1, 3, 4, 6, 8, 10],  // VII de melódica (Superlocrio/Alterada)

                // === PENTATÓNICAS ===
                pentatonicMajor: [0, 2, 4, 7, 9],    // Mayor pentatónica
                pentatonicMinor: [0, 3, 5, 7, 10],   // Menor pentatónica
                blues:           [0, 3, 5, 6, 7, 10], // Blues (pent menor + blue note)
                bluesMajor:      [0, 2, 3, 4, 7, 9],  // Blues mayor

                // === ESCALAS SIMÉTRICAS ===
                wholeTone:       [0, 2, 4, 6, 8, 10],    // Tonos enteros (6 notas)
                diminished:      [0, 2, 3, 5, 6, 8, 9, 11], // Disminuida T-S (8 notas)
                diminishedHW:    [0, 1, 3, 4, 6, 7, 9, 10], // Disminuida S-T
                chromatic:       [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11], // Cromática

                // === ESCALAS EXÓTICAS ===
                hungarian:       [0, 2, 3, 6, 7, 8, 11],  // Húngara menor (gitana)
                hungarianMajor:  [0, 3, 4, 6, 7, 9, 10],  // Húngara mayor
                byzantine:       [0, 1, 4, 5, 7, 8, 11],  // Bizantina (Doble armónica)
                arabic:          [0, 1, 4, 5, 7, 8, 10],  // Árabe (similar a frigio dom)
                japanese:        [0, 1, 5, 7, 8],         // Japonesa (In Sen)
                hirajoshi:       [0, 2, 3, 7, 8],         // Hirajoshi
                egyptian:        [0, 2, 5, 7, 10],        // Egipcia (pentatónica suspendida)
                prometheus:      [0, 2, 4, 6, 9, 10],     // Prometheus
                neapolitan:      [0, 1, 3, 5, 7, 8, 10],  // Napolitana menor
                neapolitanMajor: [0, 1, 3, 5, 7, 9, 11],  // Napolitana mayor
                enigmatic:       [0, 1, 4, 6, 8, 10, 11], // Enigmática
                persian:         [0, 1, 4, 5, 6, 8, 11],  // Persa
                bebop:           [0, 2, 4, 5, 7, 9, 10, 11], // Bebop dominante (8 notas)
                bebopMajor:      [0, 2, 4, 5, 7, 8, 9, 11],  // Bebop mayor

                // === ESCALAS REGIONALES Y AVANZADAS ===
                bluesHeptatonic: [0, 2, 3, 4, 5, 7, 10],     // Blues heptatónica (pentatónica + 2ª y 6ª)
                ryuKyu:          [0, 4, 5, 7, 11],           // Ryu Kyu (Okinawan) - escala tradicional japonesa
                yo:              [0, 2, 5, 7, 9],            // Yo Scale - pentatónica mayor japonesa
                bhairav:         [0, 1, 4, 5, 7, 8, 11],     // Bhairav Raga - escala india (similar bizantina)
                todi:            [0, 1, 3, 6, 7, 8, 11],     // Todi Raga - escala india melódica
                messiaenMode2:   [0, 1, 3, 4, 6, 7, 9, 10],  // Messiaen Modo 2 (Octatónica)
                messiaenMode3:   [0, 2, 3, 4, 6, 7, 8, 10, 11], // Messiaen Modo 3 (9 notas)
            },

            // Información extendida de cada escala
            scaleInfo: {
                // MAYORES
                major: {
                    name: 'Mayor (Jónico)',
                    category: 'major',
                    emotion: 'La luz del amanecer, el héroe que triunfa. Evoca victorias, finales felices y momentos de pura alegría. Es el hogar sonoro de la música occidental.',
                    formula: 'T-T-S-T-T-T-S',
                    usage: 'Pop, rock, música clásica. Base de la armonía occidental.',
                    chordTypes: ['maj', 'min', 'min', 'maj', 'maj', 'min', 'dim'],
                    parentScale: null,
                    degree: 1,
                    brightness: 6,
                    characteristicNote: '7M',
                    usageContext: ['Pop comercial', 'Himnos', 'Música infantil', 'Bandas sonoras épicas', 'Country']
                },

                // MENORES
                minor: {
                    name: 'Menor Natural (Eólico)',
                    category: 'minor',
                    emotion: 'La lluvia en la ventana, recuerdos que duelen dulcemente. Ideal para despedidas, reflexiones nocturnas y ese tipo de tristeza que no quieres soltar.',
                    formula: 'T-S-T-T-S-T-T',
                    usage: 'Baladas, rock alternativo, música clásica. Relativa menor de la mayor.',
                    chordTypes: ['min', 'dim', 'maj', 'min', 'min', 'maj', 'maj'],
                    parentScale: 'major',
                    degree: 6,
                    brightness: 2,
                    characteristicNote: 'b6',
                    usageContext: ['Baladas', 'Rock alternativo', 'Folk melancólico', 'Música clásica', 'Indie']
                },
                harmonicMinor: {
                    name: 'Menor Armónica',
                    category: 'minor',
                    emotion: 'El villano de capa que entra en escena, el castillo en la tormenta. Tensión dramática que exige resolución, como un suspiro antes del beso.',
                    formula: 'T-S-T-T-S-T½-S',
                    usage: 'Música clásica, metal neoclásico, flamenco. El V7 resuelve mejor al Im.',
                    chordTypes: ['min', 'dim', 'aug', 'min', 'maj', 'maj', 'dim'],
                    parentScale: null,
                    degree: 1,
                    brightness: 3,
                    characteristicNote: '7M',
                    usageContext: ['Metal neoclásico', 'Flamenco', 'Música clásica', 'Bandas sonoras de suspenso', 'Tango']
                },
                melodicMinor: {
                    name: 'Menor Melódica',
                    category: 'minor',
                    emotion: 'Sofisticación en penumbra, el jazz club a medianoche. Tristeza elegante que camina con tacones altos, melancolía que conoce buenos vinos.',
                    formula: 'T-S-T-T-T-T-S',
                    usage: 'Jazz, fusión. Combina el color menor con la 6ª y 7ª mayores.',
                    chordTypes: ['min', 'min', 'aug', 'maj', 'maj', 'dim', 'dim'],
                    parentScale: null,
                    degree: 1,
                    brightness: 4,
                    characteristicNote: '6M',
                    usageContext: ['Jazz moderno', 'Fusión', 'Neo-soul', 'Música de cine sofisticada', 'Bossa nova']
                },

                // MODOS DE LA MAYOR
                dorian: {
                    name: 'Dórico',
                    category: 'modes',
                    emotion: 'Tristeza que baila, melancolía con groove. Como llorar en la pista de baile o encontrar esperanza en un callejón oscuro.',
                    formula: 'T-S-T-T-T-S-T',
                    usage: 'Jazz, funk, rock. Menor con 6ª natural (más brillante que eólico).',
                    chordTypes: ['min', 'min', 'maj', 'maj', 'min', 'dim', 'maj'],
                    parentScale: 'major',
                    degree: 2,
                    brightness: 3,
                    characteristicNote: '6M',
                    usageContext: ['Funk', 'Jazz modal', 'Soul', 'Rock progresivo', 'Hip-hop melódico']
                },
                phrygian: {
                    name: 'Frigio',
                    category: 'modes',
                    emotion: 'El sol de Andalucía sobre piedras antiguas, el bailaor que clava la mirada. Tensión española, misterio que huele a azahar.',
                    formula: 'S-T-T-T-S-T-T',
                    usage: 'Flamenco, metal, música española. La b2 da el sonido característico.',
                    chordTypes: ['min', 'maj', 'maj', 'min', 'dim', 'maj', 'min'],
                    parentScale: 'major',
                    degree: 3,
                    brightness: 1,
                    characteristicNote: 'b2',
                    usageContext: ['Flamenco', 'Metal', 'Música mediterránea', 'Ambient oscuro', 'Videojuegos épicos']
                },
                lydian: {
                    name: 'Lidio',
                    category: 'modes',
                    emotion: 'Flotar entre nubes doradas, el asombro de un niño mirando las estrellas. Magia pura, E.T. volando sobre la luna.',
                    formula: 'T-T-T-S-T-T-S',
                    usage: 'Cine (Spielberg), jazz, prog rock. La #4 evita la gravedad del IV.',
                    chordTypes: ['maj', 'maj', 'min', 'dim', 'maj', 'min', 'min'],
                    parentScale: 'major',
                    degree: 4,
                    brightness: 7,
                    characteristicNote: '#4',
                    usageContext: ['Bandas sonoras mágicas', 'Jazz fusión', 'Rock progresivo', 'Dream pop', 'Ambient espacial']
                },
                mixolydian: {
                    name: 'Mixolidio',
                    category: 'modes',
                    emotion: 'La carretera infinita con el sol en la cara, rock and roll en vena. El riff que hace mover la cabeza sin pensar.',
                    formula: 'T-T-S-T-T-S-T',
                    usage: 'Blues, rock, funk. Mayor con b7 (acorde dominante como tónica).',
                    chordTypes: ['maj', 'min', 'dim', 'maj', 'min', 'min', 'maj'],
                    parentScale: 'major',
                    degree: 5,
                    brightness: 5,
                    characteristicNote: 'b7',
                    usageContext: ['Blues rock', 'Country rock', 'Funk', 'Rock clásico', 'Jam bands']
                },
                locrian: {
                    name: 'Locrio',
                    category: 'modes',
                    emotion: 'El suelo que se desmorona, vértigo existencial. Inquietud sin reposo, pesadillas lúcidas y pasillos infinitos.',
                    formula: 'S-T-T-S-T-T-T',
                    usage: 'Metal, jazz (sobre m7b5). La b5 hace imposible una tónica estable.',
                    chordTypes: ['dim', 'maj', 'min', 'min', 'maj', 'maj', 'min'],
                    parentScale: 'major',
                    degree: 7,
                    brightness: 0,
                    characteristicNote: 'b5',
                    usageContext: ['Metal extremo', 'Jazz sobre m7b5', 'Música experimental', 'Horror cinematográfico', 'Djent']
                },

                // MODOS DE LA MENOR ARMÓNICA
                phrygianDom: {
                    name: 'Frigio Dominante',
                    category: 'harmonicMinorModes',
                    emotion: 'El flamenco más puro, pies golpeando tierra sagrada. El desierto al atardecer, noches de Las Mil y Una Noches.',
                    formula: 'S-T½-S-T-S-T-T',
                    usage: 'Flamenco, metal, música árabe. Es el V grado de la menor armónica.',
                    chordTypes: ['maj', 'dim', 'min', 'min', 'maj', 'maj', 'dim'],
                    parentScale: 'harmonicMinor',
                    degree: 5,
                    brightness: 2,
                    characteristicNote: 'b2 + 3M',
                    usageContext: ['Flamenco', 'Metal oriental', 'Música árabe', 'Música judía', 'Fusión mediterránea']
                },

                // MODOS DE LA MENOR MELÓDICA
                lydianDom: {
                    name: 'Lidio Dominante',
                    category: 'melodicMinorModes',
                    emotion: 'Tensión que brilla como neón, el clímax antes de la resolución. Sofisticación que sabe a dry martini.',
                    formula: 'T-T-T-S-T-S-T',
                    usage: 'Jazz (sobre 7#11), fusión. Combina lydian y mixolydian.',
                    chordTypes: ['maj', 'min', 'dim', 'min', 'min', 'maj', 'min'],
                    parentScale: 'melodicMinor',
                    degree: 4,
                    brightness: 6,
                    characteristicNote: '#4 + b7',
                    usageContext: ['Jazz sobre 7#11', 'Fusión', 'Neo-soul avanzado', 'Steely Dan', 'Tritono sustituto']
                },
                alteredScale: {
                    name: 'Alterada (Superlocrio)',
                    category: 'melodicMinorModes',
                    emotion: 'Máxima tensión controlada, el equilibrista sobre el abismo. El grito antes del silencio, la tormenta antes de la calma.',
                    formula: 'S-T-S-T-T-T-T',
                    usage: 'Jazz sobre dominantes alterados (7alt). Todas las tensiones alteradas.',
                    chordTypes: ['dim', 'min', 'min', 'maj', 'maj', 'maj', 'min'],
                    parentScale: 'melodicMinor',
                    degree: 7,
                    brightness: 1,
                    characteristicNote: 'b9 + #9 + b5 + #5',
                    usageContext: ['Jazz bebop', 'Jazz contemporáneo', 'Fusión avanzada', 'Dominantes V7alt', 'Resoluciones dramáticas']
                },

                // PENTATÓNICAS
                pentatonicMajor: {
                    name: 'Pentatónica Mayor',
                    category: 'pentatonic',
                    emotion: 'Praderas infinitas, porches al atardecer y guitarras acústicas. Simplicidad honesta que sabe a limonada casera.',
                    formula: 'T-T-T½-T-T½',
                    usage: 'Country, pop, rock. Sin semitonos = sin tensiones.',
                    parentScale: 'major',
                    degree: 1,
                    brightness: 5,
                    characteristicNote: 'Sin 4 ni 7',
                    usageContext: ['Country', 'Pop', 'Folk americano', 'Rock melódico', 'Música china tradicional']
                },
                pentatonicMinor: {
                    name: 'Pentatónica Menor',
                    category: 'pentatonic',
                    emotion: 'El lenguaje universal del rock, sangre de miles de solos legendarios. Cruda, directa, honesta.',
                    formula: 'T½-T-T-T½-T',
                    usage: 'Rock, blues, pop. La escala más usada en solos.',
                    parentScale: 'minor',
                    degree: 1,
                    brightness: 2,
                    characteristicNote: 'b3 + b7',
                    usageContext: ['Rock', 'Blues', 'Metal', 'Pop rock', 'Prácticamente todo']
                },
                blues: {
                    name: 'Blues',
                    category: 'pentatonic',
                    emotion: 'El lamento del delta, whisky y cigarrillos a las 3AM. Dolor que se convierte en arte.',
                    formula: 'T½-T-S-S-T½-T',
                    usage: 'Blues, rock. Pentatónica menor + blue note (b5).',
                    parentScale: 'pentatonicMinor',
                    degree: 1,
                    specialNotes: { 6: 'blue note (b5)' },
                    brightness: 2,
                    characteristicNote: 'b5 (blue note)',
                    usageContext: ['Blues tradicional', 'Rock blues', 'Jazz blues', 'Soul', 'R&B']
                },

                // SIMÉTRICAS
                wholeTone: {
                    name: 'Tonos Enteros',
                    category: 'symmetric',
                    emotion: 'Caer en un sueño sin fondo, Alicia en el País de las Maravillas. Sin arriba ni abajo, desorientación onírica.',
                    formula: 'T-T-T-T-T-T',
                    usage: 'Impresionismo (Debussy), jazz sobre 7#5. Solo 2 escalas posibles.',
                    chordTypes: null,
                    brightness: 4,
                    characteristicNote: 'Todos T (sin ancla)',
                    usageContext: ['Impresionismo', 'Transiciones oníricas', 'Jazz sobre 7#5', 'Cine surreal', 'Efectos especiales']
                },
                diminished: {
                    name: 'Disminuida (T-S)',
                    category: 'symmetric',
                    emotion: 'Escaleras de Escher, persecuciones por callejones de espejos. Tensión que se repite cada tres semitonos.',
                    formula: 'T-S-T-S-T-S-T-S',
                    usage: 'Jazz sobre dim7, líneas cromáticas. Solo 3 escalas posibles.',
                    chordTypes: null,
                    brightness: 3,
                    characteristicNote: 'Simetría cada 3 semitonos',
                    usageContext: ['Jazz sobre dim7', 'Líneas cromáticas', 'Metal técnico', 'Música de suspenso', 'Transiciones']
                },

                // EXÓTICAS
                hungarian: {
                    name: 'Húngara Menor',
                    category: 'exotic',
                    emotion: 'Violines gitanos junto al fuego, pasión desbordada bajo las estrellas. Liszt cabalgando hacia el horizonte.',
                    formula: 'T-S-T½-S-S-T½-S',
                    usage: 'Música gitana, Liszt, metal neoclásico. Tiene dos aumentadas.',
                    chordTypes: null,
                    brightness: 3,
                    characteristicNote: '#4 + 7M',
                    usageContext: ['Música gitana', 'Clásica romántica', 'Metal neoclásico', 'Folk del este de Europa', 'Bandas sonoras épicas']
                },
                byzantine: {
                    name: 'Bizantina (Doble Armónica)',
                    category: 'exotic',
                    emotion: 'Mezquitas al amanecer, el llamado a la oración sobre tejados antiguos. Oriente medio, serpientes y bazares.',
                    formula: 'S-T½-S-T-S-T½-S',
                    usage: 'Música del medio oriente, metal. Muy cromática.',
                    chordTypes: null,
                    brightness: 2,
                    characteristicNote: 'b2 + 3M + 7M',
                    usageContext: ['Música árabe', 'Música turca', 'Metal oriental', 'Bandas sonoras exóticas', 'Klezmer']
                },
                japanese: {
                    name: 'Japonesa (In Sen)',
                    category: 'exotic',
                    emotion: 'Jardines zen bajo la lluvia, cerezos en flor que caen al estanque. Melancolía que encuentra paz.',
                    formula: 'S-2T-T-S-2T',
                    usage: 'Música tradicional japonesa, ambient.',
                    chordTypes: null,
                    brightness: 1,
                    characteristicNote: 'b2 + espacios amplios',
                    usageContext: ['Música japonesa tradicional', 'Ambient', 'Lo-fi', 'Meditación', 'Bandas sonoras contemplativas']
                },
                bebop: {
                    name: 'Bebop Dominante',
                    category: 'exotic',
                    emotion: 'Nueva York años 50, dedos volando sobre las teclas, conversaciones entre genios. Elegancia a 200 BPM.',
                    formula: 'T-T-S-T-T-S-S-S',
                    usage: 'Jazz bebop. 8 notas para que las notas del acorde caigan en tiempo fuerte.',
                    chordTypes: null,
                    brightness: 5,
                    characteristicNote: '7M cromática',
                    usageContext: ['Jazz bebop', 'Hard bop', 'Jazz standards', 'Walking bass', 'Solos de viento']
                },

                // === ESCALAS REGIONALES Y AVANZADAS ===
                bluesHeptatonic: {
                    name: 'Blues Heptatónica',
                    category: 'exotic',
                    emotion: 'Blues con riqueza armónica expandida. El blues que estudió teoría en Berklee pero sigue llorando igual.',
                    formula: 'T-S-S-S-T-1.5T-T',
                    usage: 'Blues moderno, blues-rock. Pentatónica blues + 2ª mayor y 6ª mayor para más opciones melódicas.',
                    chordTypes: null,
                    brightness: 3,
                    characteristicNote: '2M + 6M sobre base blues',
                    usageContext: ['Blues rock moderno', 'SRV style', 'Allman Brothers', 'Jazz-blues', 'Blues sofisticado']
                },
                ryuKyu: {
                    name: 'Ryu Kyu (Okinawan)',
                    category: 'exotic',
                    emotion: 'Islas de Okinawa bañadas por el mar. Música folclórica ancestral con escalas pentatónicas únicas.',
                    formula: '2T-S-T-2T',
                    usage: 'Música tradicional de Okinawa (Japón). Pentatónica con intervalos amplios.',
                    chordTypes: null,
                    brightness: 4,
                    characteristicNote: 'Saltos de tercera mayor',
                    usageContext: ['Música japonesa tradicional', 'Folk okinawense', 'Ambient japonés', 'World music', 'Documentales']
                },
                yo: {
                    name: 'Yo Scale (Japonesa)',
                    category: 'exotic',
                    emotion: 'Primavera en Kioto, templos sintoístas, ceremonia del té. Serenidad y elegancia japonesa.',
                    formula: 'T-1.5T-T-T-1.5T',
                    usage: 'Música tradicional japonesa. Pentatónica mayor japonesa sin semitonos.',
                    chordTypes: null,
                    brightness: 5,
                    characteristicNote: 'Sin semitonos - espaciosa',
                    usageContext: ['Música tradicional japonesa', 'Koto', 'Shamisen', 'Anime tranquilo', 'Jardines zen']
                },
                bhairav: {
                    name: 'Bhairav Raga',
                    category: 'exotic',
                    emotion: 'Amanecer en el Ganges, ascetas meditando, incienso sagrado. Espiritualidad intensa y devocional.',
                    formula: 'S-1.5T-S-T-S-1.5T-S',
                    usage: 'Música clásica india. Raga de la mañana temprana. Evoca devoción y reverencia.',
                    chordTypes: null,
                    brightness: 2,
                    characteristicNote: 'b2 + 3M + 7M (similar bizantina)',
                    usageContext: ['Música india clásica', 'Sitar', 'Meditación', 'Yoga', 'Música devocional']
                },
                todi: {
                    name: 'Todi Raga',
                    category: 'exotic',
                    emotion: 'Melancolía profunda del mediodía indio. Amor perdido, nostalgia espiritual, belleza dolorosa.',
                    formula: 'S-T-1.5T-S-S-1.5T-S',
                    usage: 'Música clásica india. Raga del mediodía. Uno de los ragas más emotivos.',
                    chordTypes: null,
                    brightness: 1,
                    characteristicNote: 'b2 + b3 + #4 + b6',
                    usageContext: ['Música india clásica', 'Raga mediodía', 'Baladas emotivas', 'Meditación profunda', 'Cine indio']
                },
                messiaenMode2: {
                    name: 'Messiaen Modo 2 (Octatónica)',
                    category: 'symmetric',
                    emotion: 'Vitrales de luz filtrada, arquitectura imposible, Escher sonoro. Simetría que desafía la gravedad tonal.',
                    formula: 'S-T-S-T-S-T-S-T',
                    usage: 'Música contemporánea, Messiaen, Debussy. Escala simétrica de transposición limitada.',
                    chordTypes: null,
                    brightness: 3,
                    characteristicNote: 'Simetría semitono-tono',
                    usageContext: ['Música clásica moderna', 'Messiaen', 'Jazz moderno', 'Metal progresivo', 'Bandas sonoras de ciencia ficción']
                },
                messiaenMode3: {
                    name: 'Messiaen Modo 3',
                    category: 'symmetric',
                    emotion: 'Geometría sagrada, matemáticas místicas, catedrales de sonido. Complejidad que sugiere lo divino.',
                    formula: 'T-S-S-T-S-S-T-S-S',
                    usage: 'Música sacra contemporánea. Escala de 9 notas con 3 transposiciones posibles.',
                    chordTypes: null,
                    brightness: 4,
                    characteristicNote: 'Simetría tono-semitono-semitono',
                    usageContext: ['Música sacra moderna', 'Messiaen', 'Vanguardia', 'Órgano litúrgico', 'Composición experimental']
                }
            },

            // Categorías de escalas para la UI
            scaleCategories: {
                major: { name: 'Escalas Mayores', color: '#f97316' },
                minor: { name: 'Escalas Menores', color: '#22d3ee' },
                modes: { name: 'Modos de la Mayor', color: '#fbbf24' },
                harmonicMinorModes: { name: 'Modos de la Menor Armónica', color: '#a855f7' },
                melodicMinorModes: { name: 'Modos de la Menor Melódica', color: '#ec4899' },
                pentatonic: { name: 'Pentatónicas y Blues', color: '#10b981' },
                symmetric: { name: 'Escalas Simétricas', color: '#6366f1' },
                exotic: { name: 'Escalas Exóticas', color: '#ef4444' }
            },

            // Chord Lab - Voicing metadata
            chordLabVoicings: {
                // Major triads
                'C_shape_major': {
                    name: 'C Shape',
                    frets: [0, 3, 2, 0, 1, 0],
                    fingers: [0, 3, 2, 0, 1, 0],
                    baseFret: 0,
                    register: 'low',
                    difficulty: 1,
                    brightness: 8,
                    bestFor: ['rhythm', 'open-sound'],
                    genres: ['folk', 'country', 'pop'],
                    tension: 'low',
                    movable: false,
                    commonUse: 'Open position songs'
                },
                'A_shape_major': {
                    name: 'A Shape',
                    frets: [0, 0, 2, 2, 2, 0],
                    fingers: [0, 0, 1, 2, 3, 0],
                    baseFret: 0,
                    register: 'low',
                    difficulty: 2,
                    brightness: 7,
                    bestFor: ['rhythm', 'strumming'],
                    genres: ['rock', 'folk', 'blues'],
                    tension: 'low',
                    movable: false,
                    commonUse: 'Strumming patterns'
                },
                'G_shape_major': {
                    name: 'G Shape',
                    frets: [3, 2, 0, 0, 0, 3],
                    fingers: [2, 1, 0, 0, 0, 3],
                    baseFret: 0,
                    register: 'low',
                    difficulty: 2,
                    brightness: 9,
                    bestFor: ['full-sound', 'bright'],
                    genres: ['folk', 'country', 'rock'],
                    tension: 'low',
                    movable: false,
                    commonUse: 'Full, ringing chords'
                },
                'E_shape_major_barre': {
                    name: 'E Shape (Barre)',
                    frets: [1, 1, 1, 1, 1, 1],
                    fingers: [1, 1, 2, 3, 4, 1],
                    baseFret: 1,
                    register: 'mid',
                    difficulty: 6,
                    brightness: 6,
                    bestFor: ['movable', 'any-key'],
                    genres: ['rock', 'pop', 'metal'],
                    tension: 'medium',
                    movable: true,
                    commonUse: 'Movable up the neck'
                },
                'D_shape_major': {
                    name: 'D Shape',
                    frets: [-1, -1, 0, 2, 3, 2],
                    fingers: [0, 0, 0, 1, 3, 2],
                    baseFret: 0,
                    register: 'mid',
                    difficulty: 3,
                    brightness: 8,
                    bestFor: ['bright', 'cutting'],
                    genres: ['folk', 'country', 'bluegrass'],
                    tension: 'low',
                    movable: false,
                    commonUse: 'Bright, high voicing'
                },
                'E_shape_major': {
                    name: 'E Shape',
                    frets: [0, 2, 2, 1, 0, 0],
                    fingers: [0, 2, 3, 1, 0, 0],
                    baseFret: 0,
                    register: 'low',
                    difficulty: 2,
                    brightness: 7,
                    bestFor: ['full-sound', 'open'],
                    genres: ['rock', 'folk', 'blues'],
                    tension: 'low',
                    movable: false,
                    commonUse: 'Open E chord, full resonance'
                },
                // Minor shapes
                'Am_shape': {
                    name: 'Am Shape',
                    frets: [0, 0, 2, 2, 1, 0],
                    fingers: [0, 0, 2, 3, 1, 0],
                    baseFret: 0,
                    register: 'low',
                    difficulty: 2,
                    brightness: 5,
                    bestFor: ['sad', 'melancholic'],
                    genres: ['folk', 'rock', 'pop'],
                    tension: 'low',
                    movable: false,
                    commonUse: 'Standard minor sound'
                },
                'Em_shape': {
                    name: 'Em Shape',
                    frets: [0, 2, 2, 0, 0, 0],
                    fingers: [0, 2, 3, 0, 0, 0],
                    baseFret: 0,
                    register: 'low',
                    difficulty: 1,
                    brightness: 6,
                    bestFor: ['dark', 'full'],
                    genres: ['rock', 'metal', 'folk'],
                    tension: 'low',
                    movable: false,
                    commonUse: 'Open, dark sound'
                },
                'Dm_shape': {
                    name: 'Dm Shape',
                    frets: [-1, -1, 0, 2, 3, 1],
                    fingers: [0, 0, 0, 2, 3, 1],
                    baseFret: 0,
                    register: 'mid',
                    difficulty: 3,
                    brightness: 4,
                    bestFor: ['melancholic', 'somber'],
                    genres: ['folk', 'classical', 'jazz'],
                    tension: 'medium',
                    movable: false,
                    commonUse: 'Sad, reflective'
                },
                // 7th chords
                'E_shape_maj7': {
                    name: 'E Shape maj7',
                    frets: [0, 2, 1, 1, 0, 0],
                    fingers: [0, 2, 1, 3, 0, 0],
                    baseFret: 0,
                    register: 'low',
                    difficulty: 4,
                    brightness: 8,
                    bestFor: ['jazz', 'sophisticated'],
                    genres: ['jazz', 'bossa', 'r&b'],
                    tension: 'low',
                    movable: false,
                    commonUse: 'Smooth, jazzy'
                },
                'E_shape_dom7': {
                    name: 'E Shape 7',
                    frets: [0, 2, 0, 1, 0, 0],
                    fingers: [0, 2, 0, 1, 0, 0],
                    baseFret: 0,
                    register: 'low',
                    difficulty: 3,
                    brightness: 7,
                    bestFor: ['blues', 'dominant'],
                    genres: ['blues', 'rock', 'country'],
                    tension: 'medium',
                    movable: false,
                    commonUse: 'Blues, V chord'
                },
                'A_shape_maj7': {
                    name: 'A Shape maj7',
                    frets: [0, 0, 2, 1, 2, 0],
                    fingers: [0, 0, 2, 1, 3, 0],
                    baseFret: 0,
                    register: 'low',
                    difficulty: 4,
                    brightness: 7,
                    bestFor: ['smooth', 'dreamy'],
                    genres: ['jazz', 'pop', 'r&b'],
                    tension: 'low',
                    movable: false,
                    commonUse: 'Lush, full maj7'
                },
                'A_shape_m7': {
                    name: 'A Shape m7',
                    frets: [0, 0, 2, 0, 1, 0],
                    fingers: [0, 0, 2, 0, 1, 0],
                    baseFret: 0,
                    register: 'low',
                    difficulty: 2,
                    brightness: 5,
                    bestFor: ['mellow', 'cool-jazz'],
                    genres: ['jazz', 'soul', 'r&b'],
                    tension: 'low',
                    movable: false,
                    commonUse: 'ii chord in jazz'
                },
                // Extensions
                'Cmaj9': {
                    name: 'maj9',
                    frets: [0, 3, 2, 0, 0, 0],
                    fingers: [0, 3, 2, 0, 0, 0],
                    baseFret: 0,
                    register: 'low',
                    difficulty: 3,
                    brightness: 9,
                    bestFor: ['modern', 'lush'],
                    genres: ['jazz', 'neo-soul', 'r&b'],
                    tension: 'low',
                    movable: false,
                    commonUse: 'Rich, modern I chord'
                },
                'C9': {
                    name: '9',
                    frets: [0, 3, 2, 3, 3, 0],
                    fingers: [0, 2, 1, 3, 4, 0],
                    baseFret: 0,
                    register: 'low',
                    difficulty: 5,
                    brightness: 7,
                    bestFor: ['funk', 'r&b'],
                    genres: ['funk', 'r&b', 'jazz'],
                    tension: 'medium',
                    movable: false,
                    commonUse: 'Funky V chord'
                },
                'C11': {
                    name: '11',
                    frets: [0, 3, 3, 3, 1, 0],
                    fingers: [0, 2, 3, 4, 1, 0],
                    baseFret: 0,
                    register: 'low',
                    difficulty: 6,
                    brightness: 6,
                    bestFor: ['tension', 'modal'],
                    genres: ['jazz', 'fusion', 'modern'],
                    tension: 'high',
                    movable: false,
                    commonUse: 'Suspended, tense'
                },
                'Cmaj13': {
                    name: 'maj13',
                    frets: [0, 3, 2, 2, 0, 0],
                    fingers: [0, 3, 2, 4, 0, 0],
                    baseFret: 0,
                    register: 'low',
                    difficulty: 7,
                    brightness: 9,
                    bestFor: ['complex', 'colorful'],
                    genres: ['jazz', 'bossa', 'sophisticated'],
                    tension: 'low',
                    movable: false,
                    commonUse: 'Lush ending chord'
                },
                // Additional voicings for variety
                'A_shape_major_high': {
                    name: 'A Shape (High)',
                    frets: [-1, 0, 2, 2, 2, 0],
                    fingers: [0, 0, 1, 2, 3, 0],
                    baseFret: 0,
                    register: 'high',
                    difficulty: 2,
                    brightness: 9,
                    bestFor: ['bright', 'jangly'],
                    genres: ['indie', 'alt-rock', 'pop'],
                    tension: 'low',
                    movable: false,
                    commonUse: 'High position alternative to standard A'
                },
                'E_shape_minor_barre': {
                    name: 'Em Shape (Barre)',
                    frets: [1, 1, 1, 1, 1, 1],
                    fingers: [1, 1, 3, 4, 2, 1],
                    baseFret: 1,
                    register: 'mid',
                    difficulty: 6,
                    brightness: 5,
                    bestFor: ['dark', 'powerful'],
                    genres: ['metal', 'rock', 'hard-rock'],
                    tension: 'medium',
                    movable: true,
                    commonUse: 'Movable minor, heavy sound'
                },
                'D_shape_maj7': {
                    name: 'D Shape maj7',
                    frets: [-1, -1, 0, 2, 2, 2],
                    fingers: [0, 0, 0, 1, 2, 3],
                    baseFret: 0,
                    register: 'high',
                    difficulty: 4,
                    brightness: 9,
                    bestFor: ['dreamy', 'ethereal'],
                    genres: ['indie', 'dream-pop', 'shoegaze'],
                    tension: 'low',
                    movable: false,
                    commonUse: 'High, shimmering maj7'
                },
                'G_shape_m7': {
                    name: 'Gm7 Shape',
                    frets: [3, 1, 3, 3, 3, 1],
                    fingers: [3, 1, 2, 4, 5, 1],
                    baseFret: 0,
                    register: 'mid',
                    difficulty: 8,
                    brightness: 6,
                    bestFor: ['jazz', 'sophisticated'],
                    genres: ['jazz', 'fusion', 'r&b'],
                    tension: 'medium',
                    movable: false,
                    commonUse: 'Full m7, all six strings'
                },
                // CAGED m7 completo
                'C_shape_m7': {
                    name: 'Cm7 Shape',
                    frets: [0, 3, 1, 3, 4, 3],
                    fingers: [0, 2, 1, 3, 4, 3],
                    baseFret: 0,
                    register: 'low',
                    difficulty: 7,
                    brightness: 5,
                    bestFor: ['jazz', 'full-sound'],
                    genres: ['jazz', 'soul', 'r&b'],
                    tension: 'low',
                    movable: false,
                    commonUse: 'Rich m7 with open low E'
                },
                'E_shape_m7': {
                    name: 'Em7 Shape',
                    frets: [0, 2, 0, 0, 0, 0],
                    fingers: [0, 2, 0, 0, 0, 0],
                    baseFret: 0,
                    register: 'low',
                    difficulty: 1,
                    brightness: 6,
                    bestFor: ['open', 'relaxed'],
                    genres: ['folk', 'rock', 'pop'],
                    tension: 'low',
                    movable: false,
                    commonUse: 'Most open m7 sound'
                },
                'D_shape_m7': {
                    name: 'Dm7 Shape',
                    frets: [-1, -1, 0, 2, 1, 1],
                    fingers: [0, 0, 0, 3, 1, 2],
                    baseFret: 0,
                    register: 'mid',
                    difficulty: 3,
                    brightness: 5,
                    bestFor: ['intimate', 'mellow'],
                    genres: ['jazz', 'bossa', 'soul'],
                    tension: 'low',
                    movable: false,
                    commonUse: 'Classic ii chord'
                },
                // CAGED dom7 completo
                'C_shape_dom7': {
                    name: 'C7 Shape',
                    frets: [0, 3, 2, 3, 1, 0],
                    fingers: [0, 3, 2, 4, 1, 0],
                    baseFret: 0,
                    register: 'low',
                    difficulty: 4,
                    brightness: 7,
                    bestFor: ['blues', 'dominant'],
                    genres: ['blues', 'rock', 'country'],
                    tension: 'medium',
                    movable: false,
                    commonUse: 'Open C7, blues classic'
                },
                'A_shape_dom7': {
                    name: 'A7 Shape',
                    frets: [0, 0, 2, 0, 2, 0],
                    fingers: [0, 0, 2, 0, 3, 0],
                    baseFret: 0,
                    register: 'low',
                    difficulty: 2,
                    brightness: 7,
                    bestFor: ['blues', 'country'],
                    genres: ['blues', 'country', 'rock'],
                    tension: 'medium',
                    movable: false,
                    commonUse: 'Cowboy chord dom7'
                },
                'G_shape_dom7': {
                    name: 'G7 Shape',
                    frets: [3, 2, 0, 0, 0, 1],
                    fingers: [3, 2, 0, 0, 0, 1],
                    baseFret: 0,
                    register: 'low',
                    difficulty: 3,
                    brightness: 8,
                    bestFor: ['bright', 'bluesy'],
                    genres: ['blues', 'rock', 'folk'],
                    tension: 'medium',
                    movable: false,
                    commonUse: 'Classic G7 with open strings'
                },
                'D_shape_dom7': {
                    name: 'D7 Shape',
                    frets: [-1, -1, 0, 2, 1, 2],
                    fingers: [0, 0, 0, 2, 1, 3],
                    baseFret: 0,
                    register: 'mid',
                    difficulty: 3,
                    brightness: 8,
                    bestFor: ['bright', 'cutting'],
                    genres: ['folk', 'bluegrass', 'country'],
                    tension: 'medium',
                    movable: false,
                    commonUse: 'High register dom7'
                },
                // CAGED maj7 completo
                'C_shape_maj7': {
                    name: 'Cmaj7 Shape',
                    frets: [0, 3, 2, 0, 0, 0],
                    fingers: [0, 3, 2, 0, 0, 0],
                    baseFret: 0,
                    register: 'low',
                    difficulty: 3,
                    brightness: 8,
                    bestFor: ['dreamy', 'sophisticated'],
                    genres: ['jazz', 'pop', 'r&b'],
                    tension: 'low',
                    movable: false,
                    commonUse: 'Open Cmaj7, very lush'
                },
                'G_shape_maj7': {
                    name: 'Gmaj7 Shape',
                    frets: [3, 2, 0, 0, 0, 2],
                    fingers: [2, 1, 0, 0, 0, 3],
                    baseFret: 0,
                    register: 'low',
                    difficulty: 3,
                    brightness: 9,
                    bestFor: ['bright', 'full'],
                    genres: ['jazz', 'pop', 'indie'],
                    tension: 'low',
                    movable: false,
                    commonUse: 'Bright, open maj7'
                },
                // Drop 2 voicings
                'Drop2_Cmaj7_root': {
                    name: 'Drop 2 maj7 (root pos)',
                    frets: [-1, 3, 5, 4, 5, -1],
                    fingers: [0, 1, 3, 2, 4, 0],
                    baseFret: 0,
                    register: 'mid',
                    difficulty: 6,
                    brightness: 7,
                    bestFor: ['jazz', 'voice-leading'],
                    genres: ['jazz', 'fusion', 'sophisticated'],
                    tension: 'low',
                    movable: true,
                    commonUse: 'Jazz standard voicing'
                },
                'Drop2_Cmaj7_3rd': {
                    name: 'Drop 2 maj7 (3rd inv)',
                    frets: [-1, 3, 4, 5, 5, -1],
                    fingers: [0, 1, 2, 3, 4, 0],
                    baseFret: 0,
                    register: 'mid',
                    difficulty: 6,
                    brightness: 8,
                    bestFor: ['jazz', 'smooth'],
                    genres: ['jazz', 'bossa', 'latin'],
                    tension: 'low',
                    movable: true,
                    commonUse: 'Voice leading inversion'
                },
                'Drop2_C7_root': {
                    name: 'Drop 2 dom7 (root pos)',
                    frets: [-1, 3, 5, 3, 5, -1],
                    fingers: [0, 1, 3, 2, 4, 0],
                    baseFret: 0,
                    register: 'mid',
                    difficulty: 6,
                    brightness: 7,
                    bestFor: ['jazz', 'bebop'],
                    genres: ['jazz', 'bebop', 'swing'],
                    tension: 'medium',
                    movable: true,
                    commonUse: 'Classic jazz dom7'
                },
                'Drop2_Cm7_root': {
                    name: 'Drop 2 m7 (root pos)',
                    frets: [-1, 3, 5, 3, 4, -1],
                    fingers: [0, 1, 4, 2, 3, 0],
                    baseFret: 0,
                    register: 'mid',
                    difficulty: 6,
                    brightness: 6,
                    bestFor: ['jazz', 'cool'],
                    genres: ['jazz', 'soul', 'r&b'],
                    tension: 'low',
                    movable: true,
                    commonUse: 'ii chord in jazz'
                },
                'Drop2_Cm7b5_root': {
                    name: 'Drop 2 m7b5 (root pos)',
                    frets: [-1, 3, 4, 3, 4, -1],
                    fingers: [0, 2, 3, 1, 4, 0],
                    baseFret: 0,
                    register: 'mid',
                    difficulty: 7,
                    brightness: 5,
                    bestFor: ['jazz', 'tension'],
                    genres: ['jazz', 'bebop', 'modern'],
                    tension: 'high',
                    movable: true,
                    commonUse: 'Half-diminished, ii in minor'
                },
                // Suspended chords
                'Csus2': {
                    name: 'sus2',
                    frets: [0, 3, 0, 0, 3, 3],
                    fingers: [0, 2, 0, 0, 3, 4],
                    baseFret: 0,
                    register: 'low',
                    difficulty: 3,
                    brightness: 8,
                    bestFor: ['modern', 'open'],
                    genres: ['indie', 'alt-rock', 'pop'],
                    tension: 'low',
                    movable: false,
                    commonUse: 'Modern, ambiguous sound'
                },
                'Csus4': {
                    name: 'sus4',
                    frets: [0, 3, 3, 0, 1, 1],
                    fingers: [0, 3, 4, 0, 1, 2],
                    baseFret: 0,
                    register: 'low',
                    difficulty: 4,
                    brightness: 7,
                    bestFor: ['tension', 'anticipation'],
                    genres: ['rock', 'pop', 'folk'],
                    tension: 'medium',
                    movable: false,
                    commonUse: 'Suspended, wants to resolve'
                },
                'C7sus4': {
                    name: '7sus4',
                    frets: [0, 3, 3, 3, 1, 1],
                    fingers: [0, 2, 3, 4, 1, 1],
                    baseFret: 0,
                    register: 'low',
                    difficulty: 5,
                    brightness: 7,
                    bestFor: ['funk', 'modal'],
                    genres: ['funk', 'rock', 'jazz'],
                    tension: 'medium',
                    movable: false,
                    commonUse: 'Dominant sus, funky'
                },
                'Asus2': {
                    name: 'Asus2',
                    frets: [0, 0, 2, 2, 0, 0],
                    fingers: [0, 0, 1, 2, 0, 0],
                    baseFret: 0,
                    register: 'low',
                    difficulty: 2,
                    brightness: 9,
                    bestFor: ['bright', 'open'],
                    genres: ['indie', 'rock', 'pop'],
                    tension: 'low',
                    movable: false,
                    commonUse: 'Very open, jangly'
                },
                'Asus4': {
                    name: 'Asus4',
                    frets: [0, 0, 2, 2, 3, 0],
                    fingers: [0, 0, 1, 2, 3, 0],
                    baseFret: 0,
                    register: 'low',
                    difficulty: 2,
                    brightness: 7,
                    bestFor: ['anticipation', 'folk'],
                    genres: ['folk', 'country', 'rock'],
                    tension: 'medium',
                    movable: false,
                    commonUse: 'Classic sus4 resolution'
                },
                // Add chords
                'Cadd9': {
                    name: 'add9',
                    frets: [0, 3, 2, 0, 3, 0],
                    fingers: [0, 2, 1, 0, 3, 0],
                    baseFret: 0,
                    register: 'low',
                    difficulty: 3,
                    brightness: 9,
                    bestFor: ['modern', 'colorful'],
                    genres: ['pop', 'indie', 'alt-rock'],
                    tension: 'low',
                    movable: false,
                    commonUse: 'Add color without 7th'
                },
                'Amadd9': {
                    name: 'madd9',
                    frets: [0, 0, 2, 4, 1, 0],
                    fingers: [0, 0, 2, 4, 1, 0],
                    baseFret: 0,
                    register: 'low',
                    difficulty: 4,
                    brightness: 7,
                    bestFor: ['dreamy', 'sad'],
                    genres: ['indie', 'alternative', 'emo'],
                    tension: 'low',
                    movable: false,
                    commonUse: 'Minor with sweetness'
                },
                'Dadd9': {
                    name: 'Dadd9',
                    frets: [-1, -1, 0, 2, 3, 0],
                    fingers: [0, 0, 0, 1, 2, 0],
                    baseFret: 0,
                    register: 'mid',
                    difficulty: 2,
                    brightness: 9,
                    bestFor: ['bright', 'simple'],
                    genres: ['pop', 'folk', 'indie'],
                    tension: 'low',
                    movable: false,
                    commonUse: 'Easy, beautiful voicing'
                },
                'C6': {
                    name: '6',
                    frets: [0, 3, 2, 2, 1, 0],
                    fingers: [0, 3, 2, 4, 1, 0],
                    baseFret: 0,
                    register: 'low',
                    difficulty: 4,
                    brightness: 8,
                    bestFor: ['jazzy', 'retro'],
                    genres: ['jazz', 'swing', 'vintage'],
                    tension: 'low',
                    movable: false,
                    commonUse: 'Jazz ending chord'
                },
                'Am6': {
                    name: 'm6',
                    frets: [0, 0, 2, 2, 1, 2],
                    fingers: [0, 0, 2, 3, 1, 4],
                    baseFret: 0,
                    register: 'low',
                    difficulty: 4,
                    brightness: 6,
                    bestFor: ['sophisticated', 'jazzy'],
                    genres: ['jazz', 'bossa', 'latin'],
                    tension: 'low',
                    movable: false,
                    commonUse: 'Minor tonic substitute'
                },
                // Altered chords (Jazz)
                'C7sharp9': {
                    name: '7#9 (Hendrix)',
                    frets: [0, 3, 2, 3, 3, 4],
                    fingers: [0, 2, 1, 3, 3, 4],
                    baseFret: 0,
                    register: 'low',
                    difficulty: 7,
                    brightness: 6,
                    bestFor: ['bluesy', 'hendrix'],
                    genres: ['blues', 'rock', 'funk'],
                    tension: 'high',
                    movable: false,
                    commonUse: 'Purple Haze chord'
                },
                'E7sharp9': {
                    name: 'E7#9',
                    frets: [0, 2, 0, 1, 3, 0],
                    fingers: [0, 2, 0, 1, 4, 0],
                    baseFret: 0,
                    register: 'low',
                    difficulty: 5,
                    brightness: 7,
                    bestFor: ['bluesy', 'tense'],
                    genres: ['blues', 'rock', 'jazz'],
                    tension: 'high',
                    movable: false,
                    commonUse: 'Blues-rock staple'
                },
                'C7flat9': {
                    name: '7b9',
                    frets: [0, 3, 2, 3, 2, 0],
                    fingers: [0, 3, 2, 4, 1, 0],
                    baseFret: 0,
                    register: 'low',
                    difficulty: 6,
                    brightness: 5,
                    bestFor: ['tense', 'dark'],
                    genres: ['jazz', 'bebop', 'modern'],
                    tension: 'high',
                    movable: false,
                    commonUse: 'Altered dominant'
                },
                'C7sharp5': {
                    name: '7#5 (augmented)',
                    frets: [0, 3, 2, 3, 3, 0],
                    fingers: [0, 2, 1, 3, 4, 0],
                    baseFret: 0,
                    register: 'low',
                    difficulty: 5,
                    brightness: 7,
                    bestFor: ['tension', 'unstable'],
                    genres: ['jazz', 'modern', 'experimental'],
                    tension: 'high',
                    movable: false,
                    commonUse: 'Chromatic approach'
                },
                'C7flat5': {
                    name: '7b5',
                    frets: [0, 3, 2, 3, 1, -1],
                    fingers: [0, 3, 2, 4, 1, 0],
                    baseFret: 0,
                    register: 'low',
                    difficulty: 5,
                    brightness: 6,
                    bestFor: ['tense', 'tritone'],
                    genres: ['jazz', 'bebop', 'blues'],
                    tension: 'high',
                    movable: false,
                    commonUse: 'Tritone substitution'
                },
                // Extended voicings
                'Cmaj9_rich': {
                    name: 'maj9 (rich)',
                    frets: [0, 3, 0, 0, 0, 0],
                    fingers: [0, 1, 0, 0, 0, 0],
                    baseFret: 0,
                    register: 'low',
                    difficulty: 1,
                    brightness: 10,
                    bestFor: ['open', 'spacious'],
                    genres: ['indie', 'shoegaze', 'ambient'],
                    tension: 'low',
                    movable: false,
                    commonUse: 'Maximum openness'
                },
                'Dm9': {
                    name: 'm9',
                    frets: [-1, -1, 0, 2, 1, 0],
                    fingers: [0, 0, 0, 2, 1, 0],
                    baseFret: 0,
                    register: 'mid',
                    difficulty: 3,
                    brightness: 6,
                    bestFor: ['jazzy', 'smooth'],
                    genres: ['jazz', 'neo-soul', 'r&b'],
                    tension: 'low',
                    movable: false,
                    commonUse: 'Lush minor color'
                },
                'Am9': {
                    name: 'Am9',
                    frets: [0, 0, 2, 4, 1, 3],
                    fingers: [0, 0, 2, 4, 1, 3],
                    baseFret: 0,
                    register: 'low',
                    difficulty: 5,
                    brightness: 7,
                    bestFor: ['modern', 'lush'],
                    genres: ['neo-soul', 'r&b', 'jazz'],
                    tension: 'low',
                    movable: false,
                    commonUse: 'Rich minor extension'
                },
                'C9sus4': {
                    name: '9sus4',
                    frets: [0, 3, 3, 0, 3, 3],
                    fingers: [0, 1, 2, 0, 3, 4],
                    baseFret: 0,
                    register: 'low',
                    difficulty: 5,
                    brightness: 8,
                    bestFor: ['modal', 'ambiguous'],
                    genres: ['fusion', 'modern-jazz', 'progressive'],
                    tension: 'medium',
                    movable: false,
                    commonUse: 'Modal, no 3rd'
                },
                'C13sus4': {
                    name: '13sus4',
                    frets: [0, 3, 3, 2, 3, 3],
                    fingers: [0, 2, 3, 1, 4, 5],
                    baseFret: 0,
                    register: 'low',
                    difficulty: 8,
                    brightness: 8,
                    bestFor: ['complex', 'fusion'],
                    genres: ['fusion', 'jazz', 'modern'],
                    tension: 'medium',
                    movable: false,
                    commonUse: 'Very colorful, complex'
                },
                // Power chords and Rock voicings
                'C5_power': {
                    name: 'Power Chord (5)',
                    frets: [0, 3, 5, 5, -1, -1],
                    fingers: [0, 1, 3, 4, 0, 0],
                    baseFret: 0,
                    register: 'low',
                    difficulty: 3,
                    brightness: 5,
                    bestFor: ['rock', 'heavy'],
                    genres: ['rock', 'metal', 'punk'],
                    tension: 'low',
                    movable: true,
                    commonUse: 'Rock/metal staple'
                },
                'A5_power': {
                    name: 'A5 Power',
                    frets: [0, 0, 2, 2, -1, -1],
                    fingers: [0, 0, 1, 1, 0, 0],
                    baseFret: 0,
                    register: 'low',
                    difficulty: 2,
                    brightness: 5,
                    bestFor: ['heavy', 'simple'],
                    genres: ['metal', 'hard-rock', 'punk'],
                    tension: 'low',
                    movable: true,
                    commonUse: 'Easy power chord'
                },
                'E5_power': {
                    name: 'E5 Power',
                    frets: [0, 2, 2, -1, -1, -1],
                    fingers: [0, 1, 2, 0, 0, 0],
                    baseFret: 0,
                    register: 'low',
                    difficulty: 1,
                    brightness: 5,
                    bestFor: ['heavy', 'minimal'],
                    genres: ['metal', 'punk', 'hard-rock'],
                    tension: 'low',
                    movable: true,
                    commonUse: 'Simplest power chord'
                },
                'D5_power': {
                    name: 'D5 Power',
                    frets: [-1, -1, 0, 2, 3, -1],
                    fingers: [0, 0, 0, 1, 2, 0],
                    baseFret: 0,
                    register: 'mid',
                    difficulty: 1,
                    brightness: 6,
                    bestFor: ['heavy', 'bright'],
                    genres: ['rock', 'metal', 'punk'],
                    tension: 'low',
                    movable: true,
                    commonUse: 'High register power chord'
                },
                'G5_power': {
                    name: 'G5 Power',
                    frets: [3, 5, 5, -1, -1, -1],
                    fingers: [1, 3, 4, 0, 0, 0],
                    baseFret: 0,
                    register: 'low',
                    difficulty: 2,
                    brightness: 5,
                    bestFor: ['heavy', 'full'],
                    genres: ['metal', 'rock', 'grunge'],
                    tension: 'low',
                    movable: true,
                    commonUse: 'Thick power chord'
                },
                // More inversions for voice leading
                'Cmaj_1st_inv': {
                    name: 'C major (1st inv)',
                    frets: [-1, 3, 2, 0, 1, 0],
                    fingers: [0, 3, 2, 0, 1, 0],
                    baseFret: 0,
                    register: 'mid',
                    difficulty: 3,
                    brightness: 8,
                    bestFor: ['voice-leading', 'smooth'],
                    genres: ['jazz', 'classical', 'sophisticated'],
                    tension: 'low',
                    movable: false,
                    commonUse: 'Bass on 3rd (E), smooth transitions'
                },
                'Cmaj_2nd_inv': {
                    name: 'C major (2nd inv)',
                    frets: [-1, -1, -1, 5, 5, 5],
                    fingers: [0, 0, 0, 1, 2, 3],
                    baseFret: 0,
                    register: 'high',
                    difficulty: 3,
                    brightness: 9,
                    bestFor: ['voice-leading', 'bright'],
                    genres: ['pop', 'jazz', 'modern'],
                    tension: 'low',
                    movable: true,
                    commonUse: 'Bass on 5th (G), highest voicing'
                },
                'Am_1st_inv': {
                    name: 'A minor (1st inv)',
                    frets: [-1, 0, 2, 2, 1, 0],
                    fingers: [0, 0, 2, 3, 1, 0],
                    baseFret: 0,
                    register: 'mid',
                    difficulty: 2,
                    brightness: 6,
                    bestFor: ['voice-leading', 'transitions'],
                    genres: ['folk', 'classical', 'pop'],
                    tension: 'low',
                    movable: false,
                    commonUse: 'Bass on 3rd (C), smooth minor'
                },
                'Am_2nd_inv': {
                    name: 'A minor (2nd inv)',
                    frets: [-1, -1, -1, 2, 1, 0],
                    fingers: [0, 0, 0, 3, 2, 1],
                    baseFret: 0,
                    register: 'high',
                    difficulty: 2,
                    brightness: 7,
                    bestFor: ['voice-leading', 'delicate'],
                    genres: ['classical', 'fingerstyle', 'indie'],
                    tension: 'low',
                    movable: false,
                    commonUse: 'Bass on 5th (E), minimal voicing'
                },
                'Em_1st_inv': {
                    name: 'E minor (1st inv)',
                    frets: [0, 2, 2, 0, 0, 0],
                    fingers: [0, 1, 2, 0, 0, 0],
                    baseFret: 0,
                    register: 'low',
                    difficulty: 1,
                    brightness: 6,
                    bestFor: ['open', 'transitions'],
                    genres: ['folk', 'rock', 'classical'],
                    tension: 'low',
                    movable: false,
                    commonUse: 'Bass on 3rd (G), very common'
                },
                'Dm_1st_inv': {
                    name: 'D minor (1st inv)',
                    frets: [-1, -1, 0, 2, 3, 1],
                    fingers: [0, 0, 0, 2, 3, 1],
                    baseFret: 0,
                    register: 'mid',
                    difficulty: 3,
                    brightness: 5,
                    bestFor: ['voice-leading', 'classical'],
                    genres: ['classical', 'jazz', 'folk'],
                    tension: 'low',
                    movable: false,
                    commonUse: 'Bass on 3rd (F), smooth minor movement'
                },
                // More 7th inversions for jazz
                'Cmaj7_1st_inv': {
                    name: 'Cmaj7 (1st inv)',
                    frets: [-1, 3, 5, 4, 0, 0],
                    fingers: [0, 1, 4, 3, 0, 0],
                    baseFret: 0,
                    register: 'mid',
                    difficulty: 5,
                    brightness: 8,
                    bestFor: ['jazz', 'voice-leading'],
                    genres: ['jazz', 'bossa', 'sophisticated'],
                    tension: 'low',
                    movable: true,
                    commonUse: 'Bass on 3rd (E), smooth jazz'
                },
                'Cmaj7_2nd_inv': {
                    name: 'Cmaj7 (2nd inv)',
                    frets: [-1, -1, 5, 5, 5, 7],
                    fingers: [0, 0, 1, 1, 1, 3],
                    baseFret: 0,
                    register: 'high',
                    difficulty: 6,
                    brightness: 9,
                    bestFor: ['jazz', 'bright'],
                    genres: ['jazz', 'fusion', 'modern'],
                    tension: 'low',
                    movable: true,
                    commonUse: 'Bass on 5th (G), high and bright'
                },
                'Cmaj7_3rd_inv': {
                    name: 'Cmaj7 (3rd inv)',
                    frets: [-1, -1, -1, 0, 0, 0],
                    fingers: [0, 0, 0, 0, 0, 0],
                    baseFret: 0,
                    register: 'high',
                    difficulty: 1,
                    brightness: 10,
                    bestFor: ['minimal', 'ethereal'],
                    genres: ['ambient', 'indie', 'experimental'],
                    tension: 'low',
                    movable: false,
                    commonUse: 'Bass on 7th (B), extremely minimal'
                },
                'C7_1st_inv': {
                    name: 'C7 (1st inv)',
                    frets: [-1, 3, 5, 3, 5, 3],
                    fingers: [0, 1, 3, 1, 4, 1],
                    baseFret: 0,
                    register: 'mid',
                    difficulty: 7,
                    brightness: 7,
                    bestFor: ['jazz', 'blues'],
                    genres: ['jazz', 'blues', 'swing'],
                    tension: 'medium',
                    movable: true,
                    commonUse: 'Bass on 3rd (E), full jazz voicing'
                },
                'Cm7_1st_inv': {
                    name: 'Cm7 (1st inv)',
                    frets: [-1, 3, 5, 3, 4, 3],
                    fingers: [0, 1, 4, 2, 3, 1],
                    baseFret: 0,
                    register: 'mid',
                    difficulty: 7,
                    brightness: 6,
                    bestFor: ['jazz', 'smooth'],
                    genres: ['jazz', 'soul', 'neo-soul'],
                    tension: 'low',
                    movable: true,
                    commonUse: 'Bass on 3rd (Eb), ii chord inversion'
                },
                // Extended chords for modern/jazz sounds
                'Dm11': {
                    name: 'm11',
                    frets: [-1, -1, 0, 0, 1, 1],
                    fingers: [0, 0, 0, 0, 1, 2],
                    baseFret: 0,
                    register: 'mid',
                    difficulty: 2,
                    brightness: 7,
                    bestFor: ['modal', 'spacious'],
                    genres: ['jazz', 'fusion', 'neo-soul'],
                    tension: 'low',
                    movable: false,
                    commonUse: 'Open, modal sound'
                },
                'Em11': {
                    name: 'Em11',
                    frets: [0, 0, 0, 0, 0, 0],
                    fingers: [0, 0, 0, 0, 0, 0],
                    baseFret: 0,
                    register: 'low',
                    difficulty: 1,
                    brightness: 9,
                    bestFor: ['open', 'ambient'],
                    genres: ['ambient', 'post-rock', 'experimental'],
                    tension: 'low',
                    movable: false,
                    commonUse: 'Maximum openness, all strings'
                },
                'Am11': {
                    name: 'Am11',
                    frets: [0, 0, 0, 0, 1, 0],
                    fingers: [0, 0, 0, 0, 1, 0],
                    baseFret: 0,
                    register: 'low',
                    difficulty: 1,
                    brightness: 8,
                    bestFor: ['open', 'modern'],
                    genres: ['indie', 'ambient', 'neo-soul'],
                    tension: 'low',
                    movable: false,
                    commonUse: 'Super open minor sound'
                },
                'Gmaj13': {
                    name: 'Gmaj13',
                    frets: [3, 2, 0, 0, 0, 0],
                    fingers: [2, 1, 0, 0, 0, 0],
                    baseFret: 0,
                    register: 'low',
                    difficulty: 2,
                    brightness: 10,
                    bestFor: ['lush', 'full'],
                    genres: ['jazz', 'sophisticated', 'pop'],
                    tension: 'low',
                    movable: false,
                    commonUse: 'Maximum color, all extensions'
                },
                'E13': {
                    name: 'E13',
                    frets: [0, 2, 0, 1, 2, 0],
                    fingers: [0, 2, 0, 1, 3, 0],
                    baseFret: 0,
                    register: 'low',
                    difficulty: 3,
                    brightness: 8,
                    bestFor: ['dominant', 'complex'],
                    genres: ['jazz', 'blues', 'funk'],
                    tension: 'medium',
                    movable: false,
                    commonUse: 'Full dominant with extensions'
                },
                'A13': {
                    name: 'A13',
                    frets: [0, 0, 2, 1, 2, 2],
                    fingers: [0, 0, 2, 1, 3, 4],
                    baseFret: 0,
                    register: 'low',
                    difficulty: 4,
                    brightness: 8,
                    bestFor: ['jazzy', 'colorful'],
                    genres: ['jazz', 'swing', 'bebop'],
                    tension: 'medium',
                    movable: false,
                    commonUse: 'Rich dominant color'
                },
                // Cluster chords (experimental)
                'C_cluster_1': {
                    name: 'C Cluster (dense)',
                    frets: [0, 3, 4, 5, 6, -1],
                    fingers: [0, 1, 2, 3, 4, 0],
                    baseFret: 0,
                    register: 'low',
                    difficulty: 5,
                    brightness: 4,
                    bestFor: ['dissonant', 'modern'],
                    genres: ['experimental', 'avant-garde', 'noise'],
                    tension: 'high',
                    movable: false,
                    commonUse: 'Maximum dissonance, chromatic'
                },
                'C_cluster_2': {
                    name: 'C Cluster (open)',
                    frets: [0, 3, 2, 0, 1, 0],
                    fingers: [0, 3, 2, 0, 1, 0],
                    baseFret: 0,
                    register: 'low',
                    difficulty: 3,
                    brightness: 8,
                    bestFor: ['colorful', 'modern'],
                    genres: ['indie', 'experimental', 'shoegaze'],
                    tension: 'medium',
                    movable: false,
                    commonUse: 'Controlled dissonance'
                },
                // Polychords
                'C_over_G': {
                    name: 'C/G (polychord)',
                    frets: [3, 3, 2, 0, 1, 0],
                    fingers: [3, 4, 2, 0, 1, 0],
                    baseFret: 0,
                    register: 'low',
                    difficulty: 4,
                    brightness: 8,
                    bestFor: ['complex', 'modern'],
                    genres: ['progressive', 'jazz-fusion', 'modern'],
                    tension: 'medium',
                    movable: false,
                    commonUse: 'Two chords at once'
                },
                'Dm_over_C': {
                    name: 'Dm/C',
                    frets: [-1, 3, 0, 2, 3, 1],
                    fingers: [0, 3, 0, 2, 4, 1],
                    baseFret: 0,
                    register: 'mid',
                    difficulty: 5,
                    brightness: 6,
                    bestFor: ['tension', 'sus'],
                    genres: ['jazz', 'modern', 'progressive'],
                    tension: 'medium',
                    movable: false,
                    commonUse: 'Suspended feeling, complex'
                },
                'F_over_G': {
                    name: 'F/G (sus)',
                    frets: [3, 3, 3, 2, 1, 1],
                    fingers: [3, 4, 5, 2, 1, 1],
                    baseFret: 0,
                    register: 'mid',
                    difficulty: 7,
                    brightness: 7,
                    bestFor: ['modal', 'tension'],
                    genres: ['jazz', 'fusion', 'modal'],
                    tension: 'high',
                    movable: false,
                    commonUse: 'Unresolved tension'
                },
                // Diminished chords
                'Cdim7': {
                    name: 'dim7',
                    frets: [-1, 3, 4, 2, 4, 2],
                    fingers: [0, 2, 4, 1, 3, 1],
                    baseFret: 0,
                    register: 'mid',
                    difficulty: 6,
                    brightness: 4,
                    bestFor: ['passing', 'tension'],
                    genres: ['jazz', 'classical', 'bebop'],
                    tension: 'high',
                    movable: true,
                    commonUse: 'Passing chord, symmetrical'
                },
                'Bdim7': {
                    name: 'Bdim7',
                    frets: [-1, 2, 3, 1, 3, 1],
                    fingers: [0, 2, 4, 1, 3, 1],
                    baseFret: 0,
                    register: 'mid',
                    difficulty: 6,
                    brightness: 4,
                    bestFor: ['chromatic', 'passing'],
                    genres: ['jazz', 'swing', 'classical'],
                    tension: 'high',
                    movable: true,
                    commonUse: 'Common passing diminished'
                },
                // Augmented chords
                'Caug': {
                    name: 'aug',
                    frets: [-1, 3, 2, 1, 1, 0],
                    fingers: [0, 4, 3, 1, 2, 0],
                    baseFret: 0,
                    register: 'mid',
                    difficulty: 5,
                    brightness: 6,
                    bestFor: ['tension', 'unstable'],
                    genres: ['jazz', 'modern', 'experimental'],
                    tension: 'high',
                    movable: false,
                    commonUse: 'Whole tone feeling, unstable'
                },
                'Eaug': {
                    name: 'Eaug',
                    frets: [0, 3, 2, 1, 1, 0],
                    fingers: [0, 4, 3, 1, 2, 0],
                    baseFret: 0,
                    register: 'low',
                    difficulty: 5,
                    brightness: 6,
                    bestFor: ['tension', 'chromatic'],
                    genres: ['jazz', 'bebop', 'modern'],
                    tension: 'high',
                    movable: false,
                    commonUse: 'Augmented resolution'
                },
                // Special voicings
                'Dsus2_bright': {
                    name: 'Dsus2 (Wonderwall)',
                    frets: [-1, -1, 0, 2, 3, 0],
                    fingers: [0, 0, 0, 1, 2, 0],
                    baseFret: 0,
                    register: 'mid',
                    difficulty: 2,
                    brightness: 10,
                    bestFor: ['jangly', 'bright'],
                    genres: ['indie', 'brit-pop', 'alternative'],
                    tension: 'low',
                    movable: false,
                    commonUse: 'Oasis, Wonderwall sound'
                },
                'Em7_beatles': {
                    name: 'Em7 (Something)',
                    frets: [0, 2, 2, 0, 3, 0],
                    fingers: [0, 2, 3, 0, 4, 0],
                    baseFret: 0,
                    register: 'low',
                    difficulty: 3,
                    brightness: 7,
                    bestFor: ['melodic', 'classic'],
                    genres: ['rock', 'classic-rock', 'pop'],
                    tension: 'low',
                    movable: false,
                    commonUse: 'Beatles signature voicing'
                },
                'Gmaj7_bright': {
                    name: 'Gmaj7 (bright)',
                    frets: [3, -1, 0, 0, 0, 2],
                    fingers: [2, 0, 0, 0, 0, 1],
                    baseFret: 0,
                    register: 'low',
                    difficulty: 2,
                    brightness: 10,
                    bestFor: ['open', 'jangly'],
                    genres: ['indie', 'folk', 'pop'],
                    tension: 'low',
                    movable: false,
                    commonUse: 'Maximum brightness with open strings'
                },

                // ========================================
                // FASE 1: VOICINGS PREMIUM CON EXTENSIONES
                // ========================================

                // DOMINANTES CON 9NA
                'E_shape_dom9': {
                    name: 'E9 Shape (movable)',
                    frets: [0, 2, 0, 1, 0, 2],
                    fingers: [0, 2, 0, 1, 0, 3],
                    baseFret: 0,
                    register: 'low',
                    difficulty: 4,
                    brightness: 7,
                    tension: 'medium',
                    movable: true,
                    extensions: ['9'],
                    emotionalTags: ['funky', 'rich', 'dominant'],
                    commonUse: 'Funky dom9 voicing with characteristic 9th'
                },

                'A_shape_dom9': {
                    name: 'A9 Shape (movable)',
                    frets: [-1, 0, 2, 1, 0, 0],
                    fingers: [0, 0, 3, 2, 0, 0],
                    baseFret: 0,
                    register: 'mid',
                    difficulty: 3,
                    brightness: 8,
                    tension: 'medium',
                    movable: true,
                    extensions: ['9'],
                    emotionalTags: ['funky', 'sophisticated'],
                    commonUse: 'Classic dom9 shape - warm and rich'
                },

                'G_shape_dom9': {
                    name: 'G9 (open)',
                    frets: [3, 0, 0, 0, 0, 1],
                    fingers: [2, 0, 0, 0, 0, 1],
                    baseFret: 0,
                    register: 'low',
                    difficulty: 2,
                    brightness: 7,
                    tension: 'medium',
                    movable: false,
                    extensions: ['9'],
                    emotionalTags: ['funky', 'bright'],
                    commonUse: 'Open G9 - very bright and chimey'
                },

                // DOMINANTES CON 13VA
                'E_shape_dom13': {
                    name: 'E13 Shape (movable)',
                    frets: [0, 2, 2, 1, 2, 2],
                    fingers: [0, 2, 3, 1, 4, 4],
                    baseFret: 0,
                    register: 'mid',
                    difficulty: 5,
                    brightness: 8,
                    tension: 'high',
                    movable: true,
                    extensions: ['9', '13'],
                    emotionalTags: ['jazzy', 'complex', 'colorful'],
                    commonUse: 'Complex dom13 voicing with rich color'
                },

                'A_shape_dom13': {
                    name: 'A13 Shape (movable)',
                    frets: [-1, 0, 2, 0, 2, 2],
                    fingers: [0, 0, 2, 0, 3, 4],
                    baseFret: 0,
                    register: 'mid',
                    difficulty: 4,
                    brightness: 8,
                    tension: 'high',
                    movable: true,
                    extensions: ['9', '13'],
                    emotionalTags: ['jazzy', 'sophisticated'],
                    commonUse: 'Classic dom13 shape - full and lush'
                },

                'G_shape_dom13': {
                    name: 'G13 (open)',
                    frets: [3, 0, 0, 0, 0, 0],
                    fingers: [2, 0, 0, 0, 0, 0],
                    baseFret: 0,
                    register: 'low',
                    difficulty: 1,
                    brightness: 9,
                    tension: 'medium',
                    movable: false,
                    extensions: ['9', '13'],
                    emotionalTags: ['bright', 'open', 'jazzy'],
                    commonUse: 'Simple open G13 - maximum brightness'
                },

                // MAYORES CON 9NA
                'E_shape_maj9': {
                    name: 'Emaj9 Shape (movable)',
                    frets: [0, 2, 1, 1, 0, 2],
                    fingers: [0, 3, 1, 2, 0, 4],
                    baseFret: 0,
                    register: 'low',
                    difficulty: 4,
                    brightness: 8,
                    tension: 'low',
                    movable: true,
                    extensions: ['9'],
                    emotionalTags: ['modern', 'spacious', 'colorful'],
                    commonUse: 'Modern maj9 voicing - very spacious'
                },

                'A_shape_maj9': {
                    name: 'Amaj9 Shape (movable)',
                    frets: [-1, 0, 2, 1, 0, 0],
                    fingers: [0, 0, 2, 1, 0, 0],
                    baseFret: 0,
                    register: 'mid',
                    difficulty: 2,
                    brightness: 8,
                    tension: 'low',
                    movable: true,
                    extensions: ['9'],
                    emotionalTags: ['modern', 'lush'],
                    commonUse: 'Easy maj9 shape - warm and sophisticated'
                },

                'C_shape_maj9': {
                    name: 'Cmaj9 (open)',
                    frets: [-1, 3, 2, 0, 3, 0],
                    fingers: [0, 2, 1, 0, 3, 0],
                    baseFret: 0,
                    register: 'mid',
                    difficulty: 3,
                    brightness: 9,
                    tension: 'low',
                    movable: false,
                    extensions: ['9'],
                    emotionalTags: ['modern', 'bright', 'dreamy'],
                    commonUse: 'Open Cmaj9 - shimming and beautiful'
                },

                // MAYORES CON 13VA
                'E_shape_maj13': {
                    name: 'Emaj13 Shape (movable)',
                    frets: [0, 2, 1, 1, 2, 2],
                    fingers: [0, 2, 1, 1, 3, 4],
                    baseFret: 0,
                    register: 'mid',
                    difficulty: 5,
                    brightness: 9,
                    tension: 'low',
                    movable: true,
                    extensions: ['9', '13'],
                    emotionalTags: ['complex', 'luxurious', 'jazzy'],
                    commonUse: 'Luxurious maj13 voicing - full spectrum'
                },

                'A_shape_maj13': {
                    name: 'Amaj13 Shape (movable)',
                    frets: [-1, 0, 2, 1, 2, 2],
                    fingers: [0, 0, 2, 1, 3, 4],
                    baseFret: 0,
                    register: 'mid',
                    difficulty: 4,
                    brightness: 8,
                    tension: 'low',
                    movable: true,
                    extensions: ['9', '13'],
                    emotionalTags: ['sophisticated', 'colorful'],
                    commonUse: 'Rich maj13 - sophisticated and warm'
                },

                'C_shape_maj13': {
                    name: 'Cmaj13 (open)',
                    frets: [-1, 3, 2, 0, 0, 0],
                    fingers: [0, 3, 2, 0, 0, 0],
                    baseFret: 0,
                    register: 'mid',
                    difficulty: 2,
                    brightness: 9,
                    tension: 'low',
                    movable: false,
                    extensions: ['9', '13'],
                    emotionalTags: ['bright', 'luxurious'],
                    commonUse: 'Simple open Cmaj13 - lush and bright'
                },

                // MENORES CON 9NA
                'E_shape_m9': {
                    name: 'Em9 Shape (movable)',
                    frets: [0, 2, 0, 0, 0, 2],
                    fingers: [0, 2, 0, 0, 0, 3],
                    baseFret: 0,
                    register: 'low',
                    difficulty: 3,
                    brightness: 6,
                    tension: 'low',
                    movable: true,
                    extensions: ['9'],
                    emotionalTags: ['lush', 'sophisticated', 'ambient'],
                    commonUse: 'Lush m9 voicing - ambient and spacious'
                },

                'A_shape_m9': {
                    name: 'Am9 Shape (movable)',
                    frets: [-1, 0, 2, 0, 0, 0],
                    fingers: [0, 0, 2, 0, 0, 0],
                    baseFret: 0,
                    register: 'mid',
                    difficulty: 2,
                    brightness: 7,
                    tension: 'low',
                    movable: true,
                    extensions: ['9'],
                    emotionalTags: ['smooth', 'modern'],
                    commonUse: 'Easy m9 shape - smooth and sophisticated'
                },

                'Em_shape_m9': {
                    name: 'Em9 (open)',
                    frets: [0, 2, 0, 0, 0, 0],
                    fingers: [0, 2, 0, 0, 0, 0],
                    baseFret: 0,
                    register: 'low',
                    difficulty: 1,
                    brightness: 7,
                    tension: 'low',
                    movable: false,
                    extensions: ['9'],
                    emotionalTags: ['ambient', 'spacious'],
                    commonUse: 'Simple Em9 - ethereal and open'
                },

                // MENORES CON 11VA
                'E_shape_m11': {
                    name: 'Em11 Shape (movable)',
                    frets: [0, 2, 0, 0, 3, 0],
                    fingers: [0, 2, 0, 0, 3, 0],
                    baseFret: 0,
                    register: 'low',
                    difficulty: 3,
                    brightness: 6,
                    tension: 'low',
                    movable: true,
                    extensions: ['9', '11'],
                    emotionalTags: ['spacious', 'modal', 'floating'],
                    commonUse: 'Spacious m11 voicing - modal and floating'
                },

                'A_shape_m11': {
                    name: 'Am11 Shape (movable)',
                    frets: [-1, 0, 0, 0, 0, 0],
                    fingers: [0, 0, 0, 0, 0, 0],
                    baseFret: 0,
                    register: 'mid',
                    difficulty: 1,
                    brightness: 6,
                    tension: 'low',
                    movable: true,
                    extensions: ['9', '11'],
                    emotionalTags: ['floating', 'suspended'],
                    commonUse: 'Ultra-simple m11 - pure and floating'
                },

                'Em_shape_m11': {
                    name: 'Em11 (open)',
                    frets: [0, 0, 0, 0, 0, 0],
                    fingers: [0, 0, 0, 0, 0, 0],
                    baseFret: 0,
                    register: 'low',
                    difficulty: 1,
                    brightness: 7,
                    tension: 'low',
                    movable: false,
                    extensions: ['9', '11'],
                    emotionalTags: ['ethereal', 'suspended'],
                    commonUse: 'All open strings - maximum resonance'
                }
            },

            // CAGED relationship map with didactic explanations
            cagedRelationshipMap: {
                'C': {
                    next: 'A',
                    prev: 'D',
                    sameNotes: ['G'],
                    color: '#ef4444',
                    soundCharacter: 'Abierta y brillante',
                    whenToUse: 'Canciones en tonalidades abiertas (C, G, D). Ideal para folk y country.',
                    transitionToNext: {
                        to: 'A',
                        fretMove: 'Mueve la forma 3 trastes arriba',
                        soundChange: 'Sonido más denso, menos cuerdas al aire',
                        difficulty: 'Fácil - solo cambias dedos',
                        tip: 'La nota raíz pasa de cuerda 5 (A) a cuerda 5 (A) pero en diferente traste'
                    }
                },
                'A': {
                    next: 'G',
                    prev: 'C',
                    sameNotes: ['E'],
                    color: '#f59e0b',
                    soundCharacter: 'Full y potente',
                    whenToUse: 'Raíz en cuerda 5. Perfecta para strumming y power chords.',
                    transitionToNext: {
                        to: 'G',
                        fretMove: 'Comprime hacia agudos',
                        soundChange: 'Suena más brillante y abierta',
                        difficulty: 'Media - cambio grande de forma',
                        tip: 'La forma G usa muchas cuerdas al aire, suena más "ringing"'
                    }
                },
                'G': {
                    next: 'E',
                    prev: 'A',
                    sameNotes: ['D', 'C'],
                    color: '#eab308',
                    soundCharacter: 'Rica y resonante',
                    whenToUse: 'Máximo aprovechamiento de cuerdas al aire. Sonido completo.',
                    transitionToNext: {
                        to: 'E',
                        fretMove: 'Forma barre en trastes altos',
                        soundChange: 'Pierde resonancia de aire, gana movilidad',
                        difficulty: 'Alta - requiere barre completo',
                        tip: 'E shape es la forma más versátil - puedes moverla a cualquier tono'
                    }
                },
                'E': {
                    next: 'D',
                    prev: 'G',
                    sameNotes: ['A'],
                    color: '#84cc16',
                    soundCharacter: 'Versátil y móvil',
                    whenToUse: 'Cuando necesitas cambiar de tono fácilmente. Raíz en cuerda 6.',
                    transitionToNext: {
                        to: 'D',
                        fretMove: 'Sube hacia agudos, elimina cuerdas graves',
                        soundChange: 'Sonido más agudo y cortante',
                        difficulty: 'Media - menos cuerdas pero posición incómoda',
                        tip: 'D shape tiene la raíz en cuerda 4, suena "thin" pero brillante'
                    }
                },
                'D': {
                    next: 'C',
                    prev: 'E',
                    sameNotes: ['G'],
                    color: '#06b6d4',
                    soundCharacter: 'Aguda y penetrante',
                    whenToUse: 'Solos y melodías. Se "corta" en la mezcla.',
                    transitionToNext: {
                        to: 'C',
                        fretMove: 'Vuelve a posición abierta',
                        soundChange: 'Recuperas graves y resonancia',
                        difficulty: 'Fácil - vuelves a lo familiar',
                        tip: 'El ciclo CAGED completo recorre todo el diapasón'
                    }
                }
            },

            // Calculate CAGED position on fretboard based on shape and root note
            calculateCAGEDPosition(shape, root = 'C') {
                const rootIndex = this.notes.indexOf(root);
                const shapeOffsets = { 'C': 0, 'A': 3, 'G': 5, 'E': 8, 'D': 10 };
                const offset = shapeOffsets[shape] || 0;
                return (rootIndex + offset) % 12;
            },

            // Didactic comparisons between voicings
            voicingComparisons: {
                'E_shape_maj7_vs_A_shape_maj7': {
                    title: 'E shape vs A shape maj7',
                    soundDifference: 'E shape suena más brillante y espaciosa. A shape más compacta y cálida.',
                    registerDifference: 'E shape en registro bajo, A shape más condensada',
                    useCases: {
                        'E_shape_maj7': 'Usa en intros lentas, ballads. Ejemplo: "Something" - Beatles',
                        'A_shape_maj7': 'Mejor para comping jazz, más sutil. Ejemplo: acordes de bossa nova'
                    },
                    voiceLeading: 'Desde E a A shape, la 7ª mayor se mueve mínimamente - smooth transition',
                    practiceExercise: 'Toca I-vi-ii-V alternando shapes. Escucha cómo cambia el carácter.'
                },
                'C_shape_major_vs_E_shape_major_barre': {
                    title: 'Open C vs Barre E shape',
                    soundDifference: 'C abierta: resonante, armónicos naturales. E barre: controlada, sin aire.',
                    registerDifference: 'C abierta solo funciona en C. E shape puedes moverla a cualquier tono.',
                    useCases: {
                        'C_shape_major': 'Canciones acústicas, folk. Máxima resonancia.',
                        'E_shape_major_barre': 'Rock, pop. Cuando necesitas cambiar de tonalidad.'
                    },
                    voiceLeading: 'E shape tiene raíz en bajo (cuerda 6). C shape en cuerda 5.',
                    practiceExercise: 'Toca C-F-G primero todo abierto, luego todo con barres. Nota la diferencia.'
                },
                'low_register_vs_high_register': {
                    title: 'Registro bajo vs alto (mismo acorde)',
                    soundDifference: 'Registro bajo: potente, lleno, "big". Alto: brillante, cortante, "thin".',
                    registerDifference: 'El mismo Cmaj7 suena totalmente diferente en traste 0 vs traste 10',
                    useCases: {
                        'E_shape_maj7': 'Bajo: intros, versos, fundamento',
                        'D_shape_maj7': 'Alto: solos, highlights, cortes en la mezcla'
                    },
                    voiceLeading: 'Para crear movimiento en una progresión, alterna registros',
                    practiceExercise: 'Toca I-IV-V subiendo de registro. Traste 0→5→10. Escucha el viaje.'
                },
                'Drop2_vs_Open': {
                    title: 'Drop 2 vs Open Voicing',
                    soundDifference: 'Drop 2: compacto, controlado, jazz. Open: espacioso, resonante, folk.',
                    registerDifference: 'Drop 2 en mid-register. Open usa cuerdas al aire.',
                    useCases: {
                        'Drop2_Cmaj7_root': 'Jazz comping, voice leading preciso',
                        'C_shape_maj7': 'Folk, pop, máxima resonancia'
                    },
                    voiceLeading: 'Drop 2 permite smooth voice leading. Open chords saltan más.',
                    practiceExercise: 'ii-V-I en drop 2 (minimal movement) vs open (big jumps)'
                },
                'sus2_vs_sus4': {
                    title: 'sus2 vs sus4: ¿cuál suena más moderna?',
                    soundDifference: 'sus2: abierta, ambigua, moderna. sus4: clásica, quiere resolver.',
                    registerDifference: 'sus2 suena "indie/alt". sus4 suena "classic rock".',
                    useCases: {
                        'Csus2': 'Indie, alt-rock, sonido flotante. Ejemplo: The Police',
                        'Csus4': 'Classic rock, folk, resolución dramática. Ejemplo: "Pinball Wizard"'
                    },
                    voiceLeading: 'sus4 → major es clásico. sus2 se queda suspendida.',
                    practiceExercise: 'Csus2 - C - Csus2 (indie vibe) vs Csus4 - C (rock vibe)'
                },
                'maj7_vs_dom7': {
                    title: 'maj7 vs dom7: smooth vs tension',
                    soundDifference: 'maj7: lush, smooth, stable. dom7: tensa, quiere resolver.',
                    registerDifference: 'maj7 = I chord. dom7 = V chord.',
                    useCases: {
                        'E_shape_maj7': 'Tónica, ending, smooth. "no necesita ir a ningún lado"',
                        'E_shape_dom7': 'Dominante, V chord, "necesita resolver"'
                    },
                    voiceLeading: 'dom7 → I es la resolución más fuerte en armonía',
                    practiceExercise: 'Cmaj7 (reposa) vs C7 (tensa). C7 → Fmaj7 (resuelve)'
                },
                '9_vs_add9': {
                    title: '9 vs add9: extensión vs adición',
                    soundDifference: '9: incluye la 7ª, más complejo. add9: solo añade color, más simple.',
                    registerDifference: 'C9 tiene C-E-G-Bb-D. Cadd9 tiene C-E-G-D.',
                    useCases: {
                        'C9': 'Funk, R&B, necesitas la tensión de la 7ª',
                        'Cadd9': 'Pop, indie, quieres color sin tensión'
                    },
                    voiceLeading: 'C9 funciona como dominante. Cadd9 como tónica colorida.',
                    practiceExercise: 'C9 → F (funkea). Cadd9 → Amadd9 (pop moderno)'
                },
                'jazz_vs_rock_voicing': {
                    title: 'Jazz voicing vs Rock voicing (mismo acorde)',
                    soundDifference: 'Jazz: drop 2, compact, mid-register. Rock: open/barre, full, extremos.',
                    registerDifference: 'Jazz evita extremos. Rock los abraza.',
                    useCases: {
                        'Drop2_Cmaj7_root': 'Jazz: clarity, no mud, voice leading',
                        'C_shape_major': 'Rock: full, powerful, no te importa el voice leading'
                    },
                    voiceLeading: 'Jazz: cada nota importa. Rock: el "chunk" completo importa.',
                    practiceExercise: 'Mismo progresión, dos estilos diferentes'
                },
                'bright_vs_dark': {
                    title: 'Voicing brillante vs oscura',
                    soundDifference: 'Brillante: muchas cuerdas al aire, agudos. Oscura: graves, spacing cerrado.',
                    registerDifference: 'Brightness no es solo pitch, es spacing de intervalos',
                    useCases: {
                        'G_shape_major': 'Brillante: feliz, energética. Ejemplo: "Here Comes The Sun"',
                        'Dm_shape': 'Oscura: melancólica, densa. Ejemplo: "Hurt" - Johnny Cash'
                    },
                    voiceLeading: 'Para journey emocional, ve de dark → bright',
                    practiceExercise: 'Am (oscuro) → Asus2 (brillante). Mismo root, mood opuesto.'
                },
                'simple_vs_complex': {
                    title: 'Tríada simple vs Acorde de 13ª',
                    soundDifference: 'Tríada: clara, definida, directa. 13th: rica, colorida, ambigua.',
                    registerDifference: 'Simple: 3 notas. Complejo: 6-7 notas.',
                    useCases: {
                        'C_shape_major': 'Cuando quieres claridad. Punk, power pop.',
                        'Cmaj13': 'Cuando quieres color. Jazz, neo-soul, ending lush.'
                    },
                    voiceLeading: 'Más notas = más color, pero menos clarity',
                    practiceExercise: 'Simplifica progresión compleja. Luego hazla compleja. Escucha el trade-off.'
                },
                'power_chord_vs_full_barre': {
                    title: 'Power Chord (5) vs Full Barre',
                    soundDifference: 'Power: neutral, heavy, sin 3ª. Barre: full, mayor/menor definido.',
                    registerDifference: 'Power chord no es mayor ni menor - ambiguo',
                    useCases: {
                        'C5_power': 'Metal, punk, heavy. Distorsión friendly.',
                        'E_shape_major_barre': 'Rock, pop. Cuando quieres armonía clara.'
                    },
                    voiceLeading: 'Power chords con distorsión = clarity. Full chords = mud.',
                    practiceExercise: 'Riff en power chords. Luego full barre. Con distorsión, escucha qué pasa.'
                },
                'hendrix_chord': {
                    title: '7#9 (Hendrix) - El acorde imposible',
                    soundDifference: 'Combina 3ª mayor y menor simultáneamente. "Blue note" en acorde.',
                    registerDifference: 'Funciona en blues, funk, rock. Muy característico.',
                    useCases: {
                        'E7sharp9': 'Purple Haze. Blues-rock. Hendrix signature.',
                        'E_shape_dom7': 'Blues normal, más tradicional.'
                    },
                    voiceLeading: 'Úsalo como dominante con extra edge',
                    practiceExercise: 'E7#9 → A7. Classic Hendrix move. Escucha la tensión.'
                }
            },

            // Sound journey explanations
            soundJourneys: {
                'register_journey': {
                    title: 'Viaje por registros: mismo acorde, diferentes alturas',
                    explanation: 'El mismo Cmaj7 suena completamente diferente en registro bajo vs alto',
                    steps: [
                        {
                            voicing: 'E_shape_maj7',
                            fret: 0,
                            description: 'Registro bajo - sonido lleno, "big", perfecto para intro',
                            feeling: 'Cálido, envolvente, como un abrazo sonoro'
                        },
                        {
                            voicing: 'A_shape_maj7',
                            fret: 3,
                            description: 'Registro medio - balance perfecto, uso general',
                            feeling: 'Natural, conversacional, como hablar'
                        },
                        {
                            voicing: 'D_shape_major',
                            fret: 10,
                            description: 'Registro alto - brillante, cortante, para solos',
                            feeling: 'Agudo, penetrante, como un grito'
                        }
                    ],
                    exercise: 'Toca una progresión I-IV-V subiendo por registros. Escucha cómo el mood cambia.',
                    realExample: 'Hotel California alterna registros para crear movimiento'
                },
                'brightness_journey': {
                    title: 'De oscuro a brillante: cambiando el color',
                    explanation: 'Mismo acorde, diferente "color" o "brillo"',
                    steps: [
                        {
                            voicing: 'Dm_shape',
                            brightness: 4,
                            description: 'Oscuro - notas graves, spacing cerrado',
                            emotion: 'Melancólico, introspectivo, triste'
                        },
                        {
                            voicing: 'Am_shape',
                            brightness: 5,
                            description: 'Neutro - balance entre graves y agudos',
                            emotion: 'Pensativo, reflexivo'
                        },
                        {
                            voicing: 'Em_shape',
                            brightness: 6,
                            description: 'Brillante - más cuerdas al aire, armónicos',
                            emotion: 'Esperanzador, menos pesado'
                        }
                    ],
                    exercise: 'Toca Dm → Am → Em escuchando cómo "se ilumina" el sonido',
                    realExample: 'Pink Floyd usa voicings oscuros para momentos pesados, brillantes para climax'
                },
                'complexity_journey': {
                    title: 'De simple a complejo: añadiendo color',
                    explanation: 'Mismo root, pero añadimos extensiones gradualmente',
                    steps: [
                        {
                            voicing: 'C_shape_major',
                            description: 'Tríada simple - C, E, G. Clara, directa.',
                            feeling: 'Sencillo, honesto, power pop'
                        },
                        {
                            voicing: 'C_shape_maj7',
                            description: 'Añade 7ª mayor (B). Suena más sofisticado.',
                            feeling: 'Smooth, jazzy, pero aún accesible'
                        },
                        {
                            voicing: 'Cmaj9',
                            description: 'Añade 9ª (D). Color moderno.',
                            feeling: 'Lush, neo-soul, contemporáneo'
                        },
                        {
                            voicing: 'C11',
                            description: 'Añade 11ª (F). Mucha tensión.',
                            feeling: 'Modal, ambiguo, fusion'
                        },
                        {
                            voicing: 'Cmaj13',
                            description: 'Máxima extensión. Todas las notas disponibles.',
                            feeling: 'Extremadamente colorido, casi demasiado'
                        }
                    ],
                    exercise: 'Toca C → Cmaj7 → Cmaj9 → C11 → Cmaj13. Escucha cómo se va llenando de color.',
                    realExample: 'Steely Dan usa extensiones extremas. The Ramones solo power chords. Ambos válidos.'
                },
                'tension_journey': {
                    title: 'De estable a tenso: journey emocional',
                    explanation: 'Cómo crear tensión armónica progresivamente',
                    steps: [
                        {
                            voicing: 'C_shape_maj7',
                            description: 'Inicio: Cmaj7. Totalmente estable, home.',
                            feeling: 'Relajado, en paz, resolved'
                        },
                        {
                            voicing: 'C_shape_dom7',
                            description: 'C7: añade tensión (7ª menor), quiere moverse.',
                            feeling: 'Ligeramente inquieto, quiere resolver'
                        },
                        {
                            voicing: 'C7sus4',
                            description: 'C7sus4: quita la 3ª, añade 4ª. Ambiguo.',
                            feeling: 'Suspendido, en el aire'
                        },
                        {
                            voicing: 'C7flat9',
                            description: 'C7b9: alteración cromática. Dark.',
                            feeling: 'Tense, inquietante, necesita resolver YA'
                        },
                        {
                            voicing: 'C7sharp9',
                            description: 'C7#9: blue note, clash disonante.',
                            feeling: 'Máxima tensión, bluesy, casi doloroso'
                        }
                    ],
                    exercise: 'Cmaj7 → C7 → C7#9 → Fmaj7. Tensión crece, luego resuelve. Dramático.',
                    realExample: 'Hendrix usa 7#9 para máxima tensión antes de resolver'
                },
                'genre_journey': {
                    title: 'Journey por géneros: Folk → Rock → Jazz → Metal',
                    explanation: 'Cómo el mismo acorde cambia de personalidad',
                    steps: [
                        {
                            voicing: 'C_shape_major',
                            genre: 'Folk',
                            description: 'Open C. Cuerdas al aire, acústica.',
                            feeling: 'Cálido, familiar, campfire songs'
                        },
                        {
                            voicing: 'E_shape_major_barre',
                            genre: 'Rock',
                            description: 'Barre completo. Eléctrica, drive.',
                            feeling: 'Powerful, controlado, arena rock'
                        },
                        {
                            voicing: 'Drop2_Cmaj7_root',
                            genre: 'Jazz',
                            description: 'Drop 2. Comping, mid-register, no extremos.',
                            feeling: 'Sophisticated, urbano, smoky club'
                        },
                        {
                            voicing: 'C5_power',
                            genre: 'Metal',
                            description: 'Power chord. Sin 3ª, con distorsión.',
                            feeling: 'Brutal, heavy, mosh pit'
                        }
                    ],
                    exercise: 'Mismo progresión I-IV-V en 4 estilos. Escucha cómo voicings definen género.',
                    realExample: 'I-V-vi-IV: "Let It Be" (folk) vs "Smells Like Teen Spirit" (rock) - mismos acordes, voicings diferentes'
                }
            },

            // Practical scenarios
            practicalScenarios: {
                'writing_ballad': {
                    title: 'Escribiendo una balada',
                    situation: 'Quieres un intro emotiva en C',
                    options: [
                        {
                            voicing: 'E_shape_maj7',
                            why: 'Apertura amplia, sonido lleno, muy emotivo',
                            example: 'Como "Let It Be" - Beatles'
                        },
                        {
                            voicing: 'G_shape_major',
                            why: 'Más brillante, optimista, menos dramático',
                            example: 'Como "Good Riddance" - Green Day'
                        }
                    ],
                    recommendation: 'Prueba E shape maj7 para intro, luego G shape para verso'
                },
                'funk_rhythm': {
                    title: 'Groove funk',
                    situation: 'Necesitas acordes percusivos y funky',
                    options: [
                        {
                            voicing: 'C9',
                            why: 'Tensión de 9ª, spacing perfecto para muting',
                            example: 'Como Nile Rodgers - Chic'
                        },
                        {
                            voicing: 'A_shape_m7',
                            why: 'Forma compacta, fácil de mutear',
                            example: 'Como John Frusciante - RHCP'
                        }
                    ],
                    recommendation: 'Usa 9ths y 7ths en shapes medios (fret 5-12) para mejor groove'
                },
                'jazz_comping': {
                    title: 'Comping jazz',
                    situation: 'ii-V-I en Cmaj, quieres smooth voice leading',
                    options: [
                        {
                            progression: 'Dm7 (fret 5, A shape) → G7 (fret 3, E shape) → Cmaj7 (fret 3, A shape)',
                            why: 'Movimiento mínimo, notas comunes se mantienen',
                            example: 'Como Joe Pass'
                        },
                        {
                            progression: 'Dm7 (fret 10, drop 2) → G7 (fret 10, drop 2) → Cmaj7 (fret 8, drop 2)',
                            why: 'Todas en mismo registro, muy smooth',
                            example: 'Como Wes Montgomery'
                        }
                    ],
                    recommendation: 'Para empezar, usa shapes en frets 3-7, son más cómodas'
                },
                'rock_power_intro': {
                    title: 'Intro épica de rock',
                    situation: 'Quieres una apertura poderosa, tipo arena rock',
                    options: [
                        {
                            voicing: 'E_shape_major_barre',
                            why: 'Barre completo en registro bajo. Máximo power.',
                            example: 'Como "Smells Like Teen Spirit" - Nirvana'
                        },
                        {
                            voicing: 'C5_power',
                            why: 'Power chord con distorsión. Brutal, directo.',
                            example: 'Como "Enter Sandman" - Metallica'
                        }
                    ],
                    recommendation: 'Power chord para metal/punk. Full barre para classic rock.'
                },
                'bossa_nova_comping': {
                    title: 'Comping bossa nova',
                    situation: 'Quieres ese sonido suave, brasileño',
                    options: [
                        {
                            voicing: 'A_shape_maj7',
                            why: 'Voicing compacto, fácil de mutear para síncopa',
                            example: 'Como João Gilberto - "Girl from Ipanema"'
                        },
                        {
                            voicing: 'Drop2_Cmaj7_3rd',
                            why: 'Inversión smooth, sonido sofisticado',
                            example: 'Como Stan Getz - "Desafinado"'
                        }
                    ],
                    recommendation: 'Usa maj7, m7, dom7 en mid-register. Evita open strings para control.'
                },
                'blues_progression': {
                    title: 'Blues en G (I-IV-V)',
                    situation: 'Progresión 12-bar blues, qué voicings usar',
                    options: [
                        {
                            progression: 'G7 (open) → C7 (open) → D7 (open)',
                            why: 'Blues tradicional. Máxima resonancia.',
                            example: 'Como Robert Johnson - acoustic blues'
                        },
                        {
                            progression: 'G7 (barre fret 3) → C7 (barre fret 8) → D7 (barre fret 10)',
                            why: 'Blues eléctrico. Todas barres, más controlado.',
                            example: 'Como B.B. King - electric blues'
                        },
                        {
                            progression: 'G7#9 → C7#9 → D7#9',
                            why: 'Hendrix-style. Máxima tensión bluesy.',
                            example: 'Como "Red House" - Jimi Hendrix'
                        }
                    ],
                    recommendation: 'Acoustic blues: open. Electric blues: barres. Hendrix style: 7#9.'
                },
                'neo_soul_chords': {
                    title: 'Acordes neo-soul modernos',
                    situation: 'Quieres ese sonido D\'Angelo / Erykah Badu',
                    options: [
                        {
                            voicing: 'Amadd9',
                            why: 'Color moderno sin demasiada tensión',
                            example: 'Como D\'Angelo - "Brown Sugar"'
                        },
                        {
                            voicing: 'Dm9',
                            why: 'Extensión lush, muy neo-soul',
                            example: 'Como Erykah Badu - "On & On"'
                        },
                        {
                            voicing: 'Drop2_Cm7_root',
                            why: 'Jazz voicing aplicado a R&B',
                            example: 'Como Robert Glasper'
                        }
                    ],
                    recommendation: 'Usa add9, maj9, m9. Evita tríadas simples. Mid-to-high register.'
                },
                'ambient_shoegaze': {
                    title: 'Texturas ambient/shoegaze',
                    situation: 'Quieres acordes espaciosos, etéreos',
                    options: [
                        {
                            voicing: 'Cmaj9_rich',
                            why: 'Máxima apertura, muchas cuerdas al aire',
                            example: 'Como My Bloody Valentine - "Only Shallow"'
                        },
                        {
                            voicing: 'Asus2',
                            why: 'Suspendida, flotante, ambigua',
                            example: 'Como Slowdive - "Alison"'
                        },
                        {
                            voicing: 'D_shape_maj7',
                            why: 'High register, shimmery',
                            example: 'Como Sigur Rós'
                        }
                    ],
                    recommendation: 'Open strings, sus2, maj9, delay/reverb. Deja que suenen.'
                },
                'metal_riff': {
                    title: 'Riff de metal pesado',
                    situation: 'Necesitas clarity con distorsión extrema',
                    options: [
                        {
                            voicing: 'C5_power',
                            why: 'Sin 3ª = no mud. Perfect para distorsión.',
                            example: 'Como Black Sabbath - "Iron Man"'
                        },
                        {
                            voicing: 'E_shape_major_barre',
                            why: 'Full chord = mud con distorsión. Evitar.',
                            example: 'NO hagas esto en metal extremo'
                        }
                    ],
                    recommendation: 'Con distorsión alta: power chords ONLY. Evita 3ªs y extensiones.'
                },
                'singer_songwriter': {
                    title: 'Cantautor acústico',
                    situation: 'Guitarra + voz, quieres acompañamiento simple pero bonito',
                    options: [
                        {
                            voicing: 'C_shape_major',
                            why: 'Open C. Simple, resonante, no compites con la voz.',
                            example: 'Como Ed Sheeran - "Thinking Out Loud"'
                        },
                        {
                            voicing: 'Cadd9',
                            why: 'Un poco más de color, pero aún simple',
                            example: 'Como John Mayer - "Your Body Is A Wonderland"'
                        },
                        {
                            voicing: 'Drop2_Cmaj7_root',
                            why: 'Demasiado complejo para cantautor simple. Evitar.',
                            example: 'Guarda esto para jazz instrumental'
                        }
                    ],
                    recommendation: 'Open chords + ocasional add9. Mantén simple, deja espacio a la voz.'
                },
                'indie_alternative': {
                    title: 'Indie/Alternative vibes',
                    situation: 'Quieres sonido The Smiths, Radiohead, Arctic Monkeys',
                    options: [
                        {
                            voicing: 'Asus2',
                            why: 'Jangly, open, signature indie sound',
                            example: 'Como The Smiths - "How Soon Is Now"'
                        },
                        {
                            voicing: 'Dadd9',
                            why: 'Bright, high register, cutting',
                            example: 'Como Radiohead - "Creep"'
                        },
                        {
                            voicing: 'A_shape_major_high',
                            why: 'High voicing sin bajos',
                            example: 'Como Arctic Monkeys - riffs agudos'
                        }
                    ],
                    recommendation: 'sus2, add9, high voicings. Evita bass-heavy chords.'
                },
                'reggae_ska': {
                    title: 'Reggae/Ska upstrokes',
                    situation: 'Ese "chunk-chunk" característico',
                    options: [
                        {
                            voicing: 'E_shape_major_barre',
                            why: 'Barre completo, fácil de mutear para staccato',
                            example: 'Como Bob Marley - "Three Little Birds"'
                        },
                        {
                            voicing: 'A_shape_major',
                            why: 'Mid-register, percusivo',
                            example: 'Como The Skatalites'
                        }
                    ],
                    recommendation: 'Barres en mid-register. Upstrokes en offbeat. Heavy muting.'
                }
            },

            // Genre-specific tips
            genreTips: {
                'jazz': {
                    preferredVoicings: ['Drop2_Cmaj7_root', 'Drop2_C7_root', 'Drop2_Cm7_root', 'A_shape_m7', 'Drop2_Cm7b5_root'],
                    avoidVoicings: ['C_shape_major', 'G_shape_major', 'C5_power'],
                    registerPreference: 'mid',
                    explanation: 'Jazz usa voicings compactos en registros medios para clarity. Drop 2 voicings son el estándar.',
                    tips: [
                        'Evita cuerdas al aire - pierdes control de voice leading',
                        'Usa inversiones para smooth voice leading',
                        'Mid-register (frets 3-12) para no pelear con bajo',
                        'Extensions (9, 11, 13) son esenciales'
                    ],
                    famousSongs: [
                        'Autumn Leaves - usa drop 2 voicings',
                        'Girl from Ipanema - maj7 y m7 en mid-register'
                    ]
                },
                'blues': {
                    preferredVoicings: ['E_shape_dom7', 'A_shape_dom7', 'C_shape_dom7', 'E7sharp9', 'C7flat9'],
                    avoidVoicings: ['Cmaj9', 'Drop2_Cmaj7_root', 'Cmaj13'],
                    registerPreference: 'low',
                    explanation: 'Blues usa dominantes 7ths y variantes alteradas. Open chords en acoustic, barres en electric.',
                    tips: [
                        'Dom7 es el acorde fundamental del blues',
                        '7#9 (Hendrix chord) para extra bluesy feel',
                        'Acoustic blues: open chords. Electric: barres.',
                        'Bends y slides entre voicings son clave'
                    ],
                    famousSongs: [
                        'Red House - Hendrix usa 7#9 extensively',
                        'Sweet Home Chicago - progresión clásica I7-IV7-V7'
                    ]
                },
                'funk': {
                    preferredVoicings: ['C9', 'C7sus4', 'A_shape_m7', 'Drop2_C7_root'],
                    avoidVoicings: ['C_shape_major', 'G_shape_major', 'Cmaj9_rich'],
                    registerPreference: 'mid',
                    explanation: 'Funk necesita voicings compactos que se pueden mutear fácilmente para groove percusivo.',
                    tips: [
                        '9ths y 7sus4 son los acordes funk signature',
                        'Mid-register (frets 5-12) para mejor muting',
                        'Compact voicings - evita cuerdas al aire',
                        'El muting es TAN importante como las notas'
                    ],
                    famousSongs: [
                        'Le Freak - Nile Rodgers usa 9ths compactos',
                        'Give It Away - Frusciante, m7 shapes en mid-register'
                    ]
                },
                'metal': {
                    preferredVoicings: ['C5_power', 'A5_power', 'E_shape_minor_barre'],
                    avoidVoicings: ['Cmaj13', 'C9', 'Amadd9', 'Drop2_Cmaj7_root'],
                    registerPreference: 'low',
                    explanation: 'Metal con distorsión alta necesita power chords (sin 3ª) para evitar mud.',
                    tips: [
                        'Power chords ONLY con distorsión extrema',
                        'Full chords = mud. 3ªs y extensions se vuelven disonantes.',
                        'Low register para heaviness',
                        'Palm muting para tight rhythm'
                    ],
                    famousSongs: [
                        'Master of Puppets - todos power chords',
                        'Iron Man - riff clásico en power chords'
                    ]
                },
                'folk': {
                    preferredVoicings: ['C_shape_major', 'G_shape_major', 'D_shape_major', 'Am_shape', 'Em_shape'],
                    avoidVoicings: ['Drop2_Cmaj7_root', 'C7sharp9', 'C5_power'],
                    registerPreference: 'low',
                    explanation: 'Folk abraza open chords con cuerdas al aire para máxima resonancia acústica.',
                    tips: [
                        'Open chords = folk sound',
                        'Cuerdas al aire dan ese ring característico',
                        'Simple es mejor - tríadas, no extensions',
                        'Capo para cambiar tonalidad sin perder open strings'
                    ],
                    famousSongs: [
                        'Blowin in the Wind - todas open chords',
                        'Fast Car - Cadd9, G, Em, D - simple pero efectivo'
                    ]
                },
                'indie': {
                    preferredVoicings: ['Asus2', 'Cadd9', 'Dadd9', 'A_shape_major_high', 'D_shape_maj7'],
                    avoidVoicings: ['C5_power', 'Drop2_C7_root', 'C_shape_dom7'],
                    registerPreference: 'mid-high',
                    explanation: 'Indie usa sus2, add9 y high voicings para ese sonido jangly y moderno.',
                    tips: [
                        'sus2 es THE indie chord',
                        'add9 en vez de maj7 para color sin jazz',
                        'High voicings para jangly sound',
                        'Evita bass-heavy chords'
                    ],
                    famousSongs: [
                        'How Soon Is Now - Asus2 signature riff',
                        'Creep - voicings en high register'
                    ]
                },
                'neo-soul': {
                    preferredVoicings: ['Amadd9', 'Dm9', 'Am9', 'Drop2_Cm7_root', 'Cmaj9'],
                    avoidVoicings: ['C_shape_major', 'C5_power', 'E_shape_major_barre'],
                    registerPreference: 'mid',
                    explanation: 'Neo-soul combina jazz harmony con R&B groove - extensions son esenciales.',
                    tips: [
                        'add9, maj9, m9 son signature neo-soul',
                        'Drop 2 voicings de jazz aplicados a R&B',
                        'Evita tríadas simples',
                        'Voice leading smooth entre acordes'
                    ],
                    famousSongs: [
                        'Brown Sugar - D\'Angelo usa add9 extensively',
                        'On & On - Erykah Badu, m9 y maj9'
                    ]
                },
                'pop': {
                    preferredVoicings: ['C_shape_major', 'Cadd9', 'E_shape_major_barre', 'A_shape_major'],
                    avoidVoicings: ['Drop2_Cmaj7_root', 'C7sharp9', 'Cmaj13'],
                    registerPreference: 'low-mid',
                    explanation: 'Pop usa voicings simples y familiares - clarity sobre complejidad.',
                    tips: [
                        'Simple chords - todo el mundo las conoce',
                        'Ocasional add9 para color moderno',
                        'Barres para cambios de tonalidad',
                        'Melody está en la voz, no sobre-compliques'
                    ],
                    famousSongs: [
                        'Let It Be - open chords clásicas',
                        'Thinking Out Loud - mix de open y add9'
                    ]
                },
                'ambient': {
                    preferredVoicings: ['Cmaj9_rich', 'Asus2', 'D_shape_maj7', 'Csus2', 'Am9'],
                    avoidVoicings: ['C5_power', 'C_shape_dom7', 'E7sharp9'],
                    registerPreference: 'spread',
                    explanation: 'Ambient busca espaciosidad y textura - open voicings con muchas cuerdas al aire.',
                    tips: [
                        'Máximas cuerdas al aire posibles',
                        'sus2, maj9 - sonidos flotantes',
                        'Deja que los acordes respiren - mucho sustain',
                        'Delay/reverb son parte del voicing'
                    ],
                    famousSongs: [
                        'Only Shallow - My Bloody Valentine',
                        'Alison - Slowdive, sus2 textures'
                    ]
                },
                'country': {
                    preferredVoicings: ['C_shape_major', 'G_shape_major', 'D_shape_major', 'A_shape_dom7', 'E_shape_dom7'],
                    avoidVoicings: ['Drop2_Cmaj7_root', 'C7sharp9', 'Amadd9'],
                    registerPreference: 'low',
                    explanation: 'Country usa open chords y dom7s - sonido bright y twangy.',
                    tips: [
                        'Open chords con cuerdas al aire',
                        'Dom7 shapes para V chords',
                        'High register D shapes para chicken pickin',
                        'Bright tone - usa tríadas simples'
                    ],
                    famousSongs: [
                        'Jolene - todas open chords',
                        'Friends in Low Places - progresión simple'
                    ]
                }
            },

            // Emotional qualities mapping for Progression Builder
            emotionalQualities: {
                'misterioso': {
                    name: 'Misterioso',
                    description: 'Sonidos ambiguos, modales, con tensión suspendida',
                    brightness: [1, 4],
                    tension: ['medium', 'high'],
                    preferredQualities: ['m7', 'm7b5', 'sus2', 'dim', 'min'],
                    avoidQualities: ['maj', 'maj7'],
                    modes: ['phrygian', 'locrian', 'dorian'],
                    examples: 'Como "Riders on the Storm" - The Doors'
                },
                'abierto': {
                    name: 'Abierto/Espacioso',
                    description: 'Sonidos con aire, cuerdas al aire, reverberación',
                    brightness: [7, 10],
                    tension: ['low'],
                    preferredQualities: ['maj', 'sus2', 'add9'],
                    avoidQualities: ['dim', 'm7b5', '7'],
                    voicingPreference: 'open chords con cuerdas al aire',
                    examples: 'Como "Wonderwall" - Oasis'
                },
                'alegre': {
                    name: 'Alegre/Brillante',
                    description: 'Mayor, optimista, energético',
                    brightness: [6, 9],
                    tension: ['low'],
                    preferredQualities: ['maj', 'maj7'],
                    avoidQualities: ['min', 'dim'],
                    modes: ['ionian', 'lydian', 'mixolydian'],
                    examples: 'Como "Don\'t Stop Believin\'" - Journey'
                },
                'melancólico': {
                    name: 'Melancólico/Triste',
                    description: 'Menor, introspectivo, emotivo',
                    brightness: [2, 5],
                    tension: ['low', 'medium'],
                    preferredQualities: ['min', 'm7'],
                    avoidQualities: ['maj', 'maj7'],
                    modes: ['aeolian', 'phrygian', 'dorian'],
                    examples: 'Como "Hurt" - Johnny Cash'
                },
                'tenso': {
                    name: 'Tenso/Dramático',
                    description: 'Disonancia, acordes alterados, inestabilidad',
                    brightness: [3, 7],
                    tension: ['high'],
                    preferredQualities: ['dim', '7', 'm7b5'],
                    avoidQualities: ['maj', 'maj7'],
                    examples: 'Como "Black Hole Sun" - Soundgarden'
                }
            },

            // Harmonic transitions explained
            harmonicTransitions: {
                'I-IV': {
                    function: 'T→SD',
                    feeling: 'Movimiento hacia afuera, expansión',
                    brightness_change: 1,
                    tension_change: 0,
                    examples: ['Let It Be - Beatles (C→F)', 'Wonderwall - Oasis (Em→G)'],
                    voiceLeadingTip: 'Nota común en cuerda G, movimiento suave'
                },
                'I-V': {
                    function: 'T→D',
                    feeling: 'Tensión, pregunta, anticipación',
                    brightness_change: 0,
                    tension_change: 1,
                    examples: ['Sweet Home Alabama (D→A)', 'Wild Thing (A→E)'],
                    voiceLeadingTip: 'Raíz salta quinta, muy estable'
                },
                'V-I': {
                    function: 'D→T',
                    feeling: 'Resolución, llegada a casa, cierre',
                    brightness_change: 0,
                    tension_change: -2,
                    examples: ['Cualquier cadencia perfecta', 'Final de canciones clásicas'],
                    voiceLeadingTip: 'La más fuerte resolución en música occidental'
                },
                'I-vi': {
                    function: 'T→Tm',
                    feeling: 'Giro melancólico, de mayor a menor',
                    brightness_change: -2,
                    tension_change: 0,
                    examples: ['50s Progression (C→Am)', 'Stand By Me'],
                    voiceLeadingTip: 'Notas comunes, cambio sutil'
                },
                'IV-I': {
                    function: 'SD→T',
                    feeling: 'Resolución plagal, "Amén", conclusión suave',
                    brightness_change: -1,
                    tension_change: 0,
                    examples: ['Hey Jude - Beatles (ending)', 'Let It Be'],
                    voiceLeadingTip: 'Menos dramático que V→I, más modal'
                },
                'vi-IV': {
                    function: 'Tm→SD',
                    feeling: 'Esperanza emergiendo de tristeza',
                    brightness_change: 2,
                    tension_change: 0,
                    examples: ['Axis of Awesome 4 chords (vi-IV-I-V)'],
                    voiceLeadingTip: 'Salto descendente suave de tercera'
                },
                'ii-V': {
                    function: 'SD→D',
                    feeling: 'Setup de jazz, preparación para resolución',
                    brightness_change: 0,
                    tension_change: 1,
                    examples: ['Autumn Leaves', 'All the Things You Are'],
                    voiceLeadingTip: 'Movimiento de 4ta, smooth voice leading'
                },
                'I-ii': {
                    function: 'T→SD',
                    feeling: 'Suave, íntimo, movimiento pequeño',
                    brightness_change: -1,
                    tension_change: 0,
                    examples: ['The Scientist - Coldplay'],
                    voiceLeadingTip: 'Cambio mínimo, muy smooth'
                },
                'V-vi': {
                    function: 'D→Tm',
                    feeling: 'Cadencia rota, sorpresa, evita resolución',
                    brightness_change: -1,
                    tension_change: -1,
                    examples: ['Creep - Radiohead'],
                    voiceLeadingTip: 'Evita la tónica esperada, giro inesperado'
                }
            },

            // Obtener armonización de cualquier escala
            getScaleHarmonization(root, scaleType) {
                const cacheKey = `harmonization_${root}_${scaleType}`;
                return this._memoize(() => {
                    const scale = this.getScale(root, scaleType);
                    const formula = this.scales[scaleType];
                    const triads = [];

                    for (let degree = 0; degree < scale.length; degree++) {
                        const rootNote = scale[degree].note;
                        const rootInterval = formula[degree];

                        // Buscar la 3ª (2 grados arriba en la escala)
                        const thirdDegree = (degree + 2) % scale.length;
                        const thirdNote = scale[thirdDegree].note;
                        const thirdInterval = (formula[thirdDegree] - rootInterval + 12) % 12;

                        // Buscar la 5ª (4 grados arriba en la escala)
                        const fifthDegree = (degree + 4) % scale.length;
                        const fifthNote = scale[fifthDegree].note;
                        const fifthInterval = (formula[fifthDegree] - rootInterval + 12) % 12;

                        // Determinar calidad del acorde
                        let quality;
                        if (thirdInterval === 4 && fifthInterval === 7) quality = 'maj';
                        else if (thirdInterval === 3 && fifthInterval === 7) quality = 'min';
                        else if (thirdInterval === 3 && fifthInterval === 6) quality = 'dim';
                        else if (thirdInterval === 4 && fifthInterval === 8) quality = 'aug';
                        else if (thirdInterval === 2 && fifthInterval === 7) quality = 'sus2';
                        else if (thirdInterval === 5 && fifthInterval === 7) quality = 'sus4';
                        else quality = '?';

                        triads.push({
                            degree: degree + 1,
                            root: rootNote,
                            third: thirdNote,
                            fifth: fifthNote,
                            quality: quality,
                            intervals: { third: thirdInterval, fifth: fifthInterval }
                        });
                    }

                    return triads;
                }, cacheKey);
            },

            // Comparar dos escalas
            compareScales(scale1Type, scale2Type) {
                const cacheKey = `compare_${scale1Type}_${scale2Type}`;
                return this._memoize(() => {
                    const formula1 = this.scales[scale1Type];
                    const formula2 = this.scales[scale2Type];

                    const common = formula1.filter(n => formula2.includes(n));
                    const onlyIn1 = formula1.filter(n => !formula2.includes(n));
                    const onlyIn2 = formula2.filter(n => !formula1.includes(n));

                    return {
                        common: common,
                        onlyInFirst: onlyIn1,
                        onlyInSecond: onlyIn2,
                        similarity: (common.length / Math.max(formula1.length, formula2.length) * 100).toFixed(0)
                    };
                }, cacheKey);
            },

            // Obtener escala padre y grado
            getParentInfo(scaleType) {
                const info = this.scaleInfo[scaleType];
                if (!info || !info.parentScale) return null;

                return {
                    parentScale: info.parentScale,
                    degree: info.degree,
                    parentName: this.scaleInfo[info.parentScale]?.name || info.parentScale
                };
            },

            // Interval names
            intervalNames: {
                0: '1 (T)',
                1: '2m',
                2: '2M',
                3: '3m',
                4: '3M',
                5: '4J',
                6: 'TT',
                7: '5J',
                8: '6m',
                9: '6M',
                10: '7m',
                11: '7M',
            },

            // Scale degree names
            degreeNames: ['1', '2', '3', '4', '5', '6', '7'],

            // Chord qualities for major scale harmonization
            chordQualities: ['maj', 'min', 'min', 'maj', 'maj', 'min', 'dim'],
            romanNumerals: ['I', 'ii', 'iii', 'IV', 'V', 'vi', 'vii°'],

            // Get note name from index
            getNoteName(index) {
                return this.notes[(index % 12 + 12) % 12];
            },

            // Get note index from name
            getNoteIndex(name) {
                return this.notes.indexOf(name);
            },

            // Calculate interval between two notes
            getInterval(note1, note2) {
                const idx1 = typeof note1 === 'number' ? note1 : this.getNoteIndex(note1);
                const idx2 = typeof note2 === 'number' ? note2 : this.getNoteIndex(note2);
                return ((idx2 - idx1) % 12 + 12) % 12;
            },

            // Get scale notes from root and scale type
            getScale(root, scaleType) {
                const cacheKey = `scale_${root}_${scaleType}`;
                return this._memoize(() => {
                    const rootIndex = typeof root === 'number' ? root : this.getNoteIndex(root);
                    const formula = this.scales[scaleType];
                    return formula.map(interval => ({
                        note: this.getNoteName(rootIndex + interval),
                        interval: interval,
                        degree: formula.indexOf(interval) + 1
                    }));
                }, cacheKey);
            },

            // Get triad from scale degree
            getTriad(root, scaleType, degree) {
                const scale = this.getScale(root, scaleType);
                const rootIndex = degree - 1;
                const thirdIndex = (rootIndex + 2) % 7;
                const fifthIndex = (rootIndex + 4) % 7;

                return {
                    root: scale[rootIndex],
                    third: scale[thirdIndex],
                    fifth: scale[fifthIndex],
                    quality: this.chordQualities[rootIndex],
                    roman: this.romanNumerals[rootIndex]
                };
            },

            // Get all triads for a scale
            getScaleTriads(root, scaleType) {
                return [1, 2, 3, 4, 5, 6, 7].map(degree => this.getTriad(root, scaleType, degree));
            },

            // Get mode from parent scale
            getMode(parentRoot, modeNumber) {
                const parentScale = this.getScale(parentRoot, 'major');
                const modeRoot = parentScale[modeNumber - 1].note;
                const modeNames = ['major', 'dorian', 'phrygian', 'lydian', 'mixolydian', 'minor', 'locrian'];
                return {
                    root: modeRoot,
                    scale: this.getScale(modeRoot, modeNames[modeNumber - 1]),
                    name: modeNames[modeNumber - 1]
                };
            },

            // Circle of fifths order
            circleOfFifths: [0, 7, 2, 9, 4, 11, 6, 1, 8, 3, 10, 5], // C, G, D, A, E, B, F#, C#, G#, D#, A#, F
            circleOfFifthsLabels: ['C', 'G', 'D', 'A', 'E', 'B', 'F#/Gb', 'Db', 'Ab', 'Eb', 'Bb', 'F'],

            // Get relative minor
            getRelativeMinor(majorRoot) {
                return (majorRoot + 9) % 12; // 3 semitones down = 9 semitones up
            },

            // Get relative major
            getRelativeMajor(minorRoot) {
                return (minorRoot + 3) % 12;
            },

            // Seventh chord formulas from scale degree
            seventhChordFormulas: {
                1: [0, 4, 7, 11],  // maj7
                2: [0, 3, 7, 10],  // m7
                3: [0, 3, 7, 10],  // m7
                4: [0, 4, 7, 11],  // maj7
                5: [0, 4, 7, 10],  // dom7
                6: [0, 3, 7, 10],  // m7
                7: [0, 3, 6, 10],  // m7b5 (half-diminished)
            },

            seventhChordNames: ['maj7', 'm7', 'm7', 'maj7', '7', 'm7', 'ø7'],

            // Get seventh chord from scale degree
            getSeventhChord(root, degree) {
                const scale = this.getScale(root, 'major');
                const chordRoot = scale[degree - 1].note;
                const chordRootIndex = this.getNoteIndex(chordRoot);
                const formula = this.seventhChordFormulas[degree];

                return {
                    root: chordRoot,
                    notes: formula.map(interval => ({
                        note: this.getNoteName(chordRootIndex + interval),
                        interval: interval
                    })),
                    quality: this.seventhChordNames[degree - 1],
                    degree: degree
                };
            },

            // CAGED system shapes (positions relative to root on specific strings)
            cagedShapes: {
                'C': {
                    name: 'Forma C',
                    // Positions: [string][fret relative to root position]
                    positions: [
                        { string: 0, fret: 0, degree: 1 },   // E string - root
                        { string: 1, fret: 1, degree: 5 },   // B string
                        { string: 2, fret: 0, degree: 3 },   // G string
                        { string: 3, fret: 2, degree: 1 },   // D string - root
                        { string: 4, fret: 3, degree: 5 },   // A string
                        { string: 5, fret: -1, degree: null }, // E string - muted
                    ],
                    rootString: 4, // Root on A string
                    description: 'Tónica en cuerda 5 (A)'
                },
                'A': {
                    name: 'Forma A',
                    positions: [
                        { string: 0, fret: 0, degree: 5 },
                        { string: 1, fret: 2, degree: 1 },   // root
                        { string: 2, fret: 2, degree: 5 },
                        { string: 3, fret: 2, degree: 1 },   // root
                        { string: 4, fret: 0, degree: 1 },   // root
                        { string: 5, fret: -1, degree: null },
                    ],
                    rootString: 4,
                    description: 'Tónica en cuerda 5 (A)'
                },
                'G': {
                    name: 'Forma G',
                    positions: [
                        { string: 0, fret: 3, degree: 1 },   // root
                        { string: 1, fret: 0, degree: 3 },
                        { string: 2, fret: 0, degree: 1 },   // root
                        { string: 3, fret: 0, degree: 5 },
                        { string: 4, fret: 2, degree: 3 },
                        { string: 5, fret: 3, degree: 1 },   // root
                    ],
                    rootString: 5,
                    description: 'Tónica en cuerda 6 (E)'
                },
                'E': {
                    name: 'Forma E',
                    positions: [
                        { string: 0, fret: 0, degree: 1 },   // root
                        { string: 1, fret: 0, degree: 5 },
                        { string: 2, fret: 1, degree: 3 },
                        { string: 3, fret: 2, degree: 1 },   // root
                        { string: 4, fret: 2, degree: 5 },
                        { string: 5, fret: 0, degree: 1 },   // root
                    ],
                    rootString: 5,
                    description: 'Tónica en cuerda 6 (E)'
                },
                'D': {
                    name: 'Forma D',
                    positions: [
                        { string: 0, fret: 2, degree: 3 },
                        { string: 1, fret: 3, degree: 1 },   // root
                        { string: 2, fret: 2, degree: 5 },
                        { string: 3, fret: 0, degree: 1 },   // root
                        { string: 4, fret: -1, degree: null },
                        { string: 5, fret: -1, degree: null },
                    ],
                    rootString: 3,
                    description: 'Tónica en cuerda 4 (D)'
                }
            },

            // Interval info for level 1 improvements
            intervalInfo: {
                1: { name: '2ª menor', semitones: 1, character: 'Disonante, tensión extrema', consonance: 'Disonante', examples: 'Jaws theme, Pink Panther' },
                2: { name: '2ª Mayor', semitones: 2, character: 'Paso melódico, neutro', consonance: 'Disonante suave', examples: 'Happy Birthday (primeras notas)' },
                3: { name: '3ª menor', semitones: 3, character: 'Triste, melancólico', consonance: 'Consonante imperfecta', examples: 'Greensleeves, Hey Jude' },
                4: { name: '3ª Mayor', semitones: 4, character: 'Alegre, brillante', consonance: 'Consonante imperfecta', examples: 'When the Saints, Kumbaya' },
                5: { name: '4ª Justa', semitones: 5, character: 'Suspensión, apertura', consonance: 'Consonante perfecta', examples: 'Here Comes the Bride, Amazing Grace' },
                6: { name: 'Tritono', semitones: 6, character: 'Diabólico, inestable', consonance: 'Disonante', examples: 'The Simpsons, Maria (West Side Story)' },
                7: { name: '5ª Justa', semitones: 7, character: 'Poder, estabilidad', consonance: 'Consonante perfecta', examples: 'Star Wars, Twinkle Twinkle' },
                8: { name: '6ª menor', semitones: 8, character: 'Dramático, intenso', consonance: 'Consonante imperfecta', examples: 'The Entertainer, Love Story' },
                9: { name: '6ª Mayor', semitones: 9, character: 'Romántico, dulce', consonance: 'Consonante imperfecta', examples: 'NBC theme, My Bonnie' },
                10: { name: '7ª menor', semitones: 10, character: 'Bluesy, con tensión', consonance: 'Disonante suave', examples: 'Star Trek theme, Watermelon Man' },
                11: { name: '7ª Mayor', semitones: 11, character: 'Soñador, jazz', consonance: 'Disonante', examples: 'Take on Me, Superman theme' }
            },

            // Extended chords for level 11
            extendedChords: {
                'maj9':   { intervals: [0, 4, 7, 11, 14], name: 'Major 9', symbol: 'maj9', formula: '1-3-5-7-9' },
                'min9':   { intervals: [0, 3, 7, 10, 14], name: 'Minor 9', symbol: 'm9', formula: '1-b3-5-b7-9' },
                'dom9':   { intervals: [0, 4, 7, 10, 14], name: 'Dominant 9', symbol: '9', formula: '1-3-5-b7-9' },
                '7#9':    { intervals: [0, 4, 7, 10, 15], name: 'Hendrix Chord', symbol: '7#9', formula: '1-3-5-b7-#9' },
                '7b9':    { intervals: [0, 4, 7, 10, 13], name: 'Dom 7 flat 9', symbol: '7b9', formula: '1-3-5-b7-b9' },
                'min11':  { intervals: [0, 3, 7, 10, 14, 17], name: 'Minor 11', symbol: 'm11', formula: '1-b3-5-b7-9-11' },
                'dom11':  { intervals: [0, 4, 7, 10, 14, 17], name: 'Dominant 11', symbol: '11', formula: '1-3-5-b7-9-11' },
                'maj11':  { intervals: [0, 4, 7, 11, 14, 17], name: 'Major 11', symbol: 'maj11', formula: '1-3-5-7-9-11' },
                'maj13':  { intervals: [0, 4, 7, 11, 14, 21], name: 'Major 13', symbol: 'maj13', formula: '1-3-5-7-9-13' },
                'dom13':  { intervals: [0, 4, 7, 10, 14, 21], name: 'Dominant 13', symbol: '13', formula: '1-3-5-b7-9-13' },
                'min13':  { intervals: [0, 3, 7, 10, 14, 21], name: 'Minor 13', symbol: 'm13', formula: '1-b3-5-b7-9-13' },
            },

            extendedVoicings: {
                'maj9_A':  { frets: [-1, 0, 2, 1, 2, 0], type: 'maj9' },
                'min9_A':  { frets: [-1, 0, 2, 0, 2, 0], type: 'm9' },
                'dom9_E':  { frets: [0, 2, 0, 1, 0, 2], type: '9' },
                '7#9_E':   { frets: [0, 2, 1, 2, 0, -1], type: '7#9' },
                '7b9_E':   { frets: [0, 2, 1, 2, 1, -1], type: '7b9' },
                'min11_A': { frets: [-1, 0, 0, 0, 0, 0], type: 'm11' },
                'dom11_A': { frets: [-1, 0, 0, 1, 0, 0], type: '11' },
                'maj11_A': { frets: [-1, 0, 0, 1, 2, 0], type: 'maj11' },
                'maj13_A': { frets: [-1, 0, 2, 1, 2, 2], type: 'maj13' },
                'dom13_E': { frets: [0, 2, 0, 1, 2, 0], type: '13' },
            },

            // Secondary dominants for level 12
            secondaryDominants: {
                'ii':  { target: 2, rootOffset: 9, name: 'V de ii', roman: 'V/ii', example: 'A7 → Dm (en C)', targetChord: 'ii' },
                'iii': { target: 3, rootOffset: 11, name: 'V de iii', roman: 'V/iii', example: 'B7 → Em (en C)', targetChord: 'iii' },
                'IV':  { target: 4, rootOffset: 0, name: 'V de IV', roman: 'V/IV', example: 'C7 → F (en C)', targetChord: 'IV' },
                'V':   { target: 5, rootOffset: 2, name: 'V de V', roman: 'V/V', example: 'D7 → G (en C)', targetChord: 'V' },
                'vi':  { target: 6, rootOffset: 4, name: 'V de vi', roman: 'V/vi', example: 'E7 → Am (en C)', targetChord: 'vi' },
            },

            secondaryProgressions: [
                { name: 'V/V → V → I', degrees: ['V/V', 'V', 'I'], description: 'Cadencia extendida - muy común en clásica y pop' },
                { name: 'I → V/vi → vi', degrees: ['I', 'V/vi', 'vi'], description: 'Dramatiza la llegada al vi (relativo menor)' },
                { name: 'I → V/ii → ii → V → I', degrees: ['I', 'V/ii', 'ii', 'V', 'I'], description: 'ii-V secundario - típico del jazz' },
            ],

            // Quiz questions for level 10
            quizQuestions: {
                intervals: {
                    easy: [
                        { q: '¿Qué intervalo hay entre C y E?', a: '3ª Mayor', options: ['3ª menor', '3ª Mayor', '4ª Justa', '2ª Mayor'] },
                        { q: '¿Qué intervalo hay entre C y G?', a: '5ª Justa', options: ['4ª Justa', '5ª Justa', '6ª Mayor', '3ª Mayor'] },
                        { q: '¿Cuántos semitonos tiene una 4ª Justa?', a: '5', options: ['4', '5', '6', '7'] },
                        { q: '¿Qué intervalo es el más consonante?', a: '5ª Justa', options: ['2ª menor', '5ª Justa', 'Tritono', '7ª Mayor'] },
                    ],
                    medium: [
                        { q: 'El tritono equivale a:', a: '6 semitonos', options: ['5 semitonos', '6 semitonos', '7 semitonos', '4 semitonos'] },
                        { q: '¿Qué intervalo hay entre D y Bb?', a: '6ª menor', options: ['5ª Justa', '6ª menor', '6ª Mayor', '7ª menor'] },
                        { q: '¿Qué intervalo es característico de los acordes mayores?', a: '3ª Mayor', options: ['3ª menor', '3ª Mayor', '2ª Mayor', '4ª Justa'] },
                    ],
                    hard: [
                        { q: '¿Qué intervalo invertido da una 6ª Mayor?', a: '3ª menor', options: ['3ª Mayor', '3ª menor', '2ª Mayor', '7ª menor'] },
                        { q: '¿Cuántos semitonos hay entre F# y Eb?', a: '9', options: ['8', '9', '10', '11'] },
                    ]
                },
                scales: {
                    easy: [
                        { q: '¿Cuántas notas tiene la escala mayor?', a: '7', options: ['5', '6', '7', '8'] },
                        { q: '¿Qué escala usa solo teclas blancas empezando en C?', a: 'C Mayor', options: ['A menor', 'C Mayor', 'G Mayor', 'F Mayor'] },
                        { q: '¿Cuántas notas tiene la pentatónica?', a: '5', options: ['4', '5', '6', '7'] },
                    ],
                    medium: [
                        { q: '¿Qué escala tiene #4 como nota característica?', a: 'Lidio', options: ['Mixolidio', 'Lidio', 'Dórico', 'Frigio'] },
                        { q: '¿Qué escala tiene b2 como nota característica?', a: 'Frigio', options: ['Dórico', 'Lidio', 'Frigio', 'Locrio'] },
                        { q: '¿Qué nota diferencia la menor armónica de la natural?', a: '7ª Mayor', options: ['6ª Mayor', '7ª Mayor', '2ª menor', '4ª aumentada'] },
                    ],
                    hard: [
                        { q: '¿Qué escala es el VII grado de la menor melódica?', a: 'Alterada', options: ['Locrio', 'Alterada', 'Lidio Dom', 'Frigio Dom'] },
                        { q: '¿Cuántas escalas disminuidas (T-S) existen?', a: '3', options: ['2', '3', '4', '6'] },
                    ]
                },
                chords: {
                    easy: [
                        { q: '¿Qué notas tiene un acorde de C Mayor?', a: 'C-E-G', options: ['C-D-E', 'C-E-G', 'C-F-G', 'C-Eb-G'] },
                        { q: '¿Qué tipo de acorde es el ii en una escala mayor?', a: 'menor', options: ['Mayor', 'menor', 'disminuido', 'aumentado'] },
                        { q: '¿Cuál es el V de C Mayor?', a: 'G', options: ['F', 'G', 'D', 'A'] },
                    ],
                    medium: [
                        { q: '¿Qué grado de la escala mayor es disminuido?', a: 'vii°', options: ['ii', 'iii', 'vi', 'vii°'] },
                        { q: '¿Qué intervalos forman un acorde menor?', a: '1-b3-5', options: ['1-3-5', '1-b3-5', '1-3-#5', '1-b3-b5'] },
                    ],
                    hard: [
                        { q: '¿Qué acorde es 1-b3-b5?', a: 'disminuido', options: ['menor', 'disminuido', 'semidisminuido', 'menor 7'] },
                        { q: '¿Qué nota añade un maj7 a la tríada?', a: '7ª Mayor', options: ['7ª menor', '7ª Mayor', '9ª', '6ª'] },
                    ]
                },
                modes: {
                    easy: [
                        { q: '¿Cuál es el primer modo de la escala mayor?', a: 'Jónico', options: ['Dórico', 'Jónico', 'Lidio', 'Eólico'] },
                        { q: '¿Qué modo es igual a la escala menor natural?', a: 'Eólico', options: ['Dórico', 'Frigio', 'Eólico', 'Locrio'] },
                        { q: '¿Cuántos modos tiene la escala mayor?', a: '7', options: ['5', '6', '7', '8'] },
                    ],
                    medium: [
                        { q: '¿Qué modo tiene sonido "español/flamenco"?', a: 'Frigio', options: ['Dórico', 'Frigio', 'Lidio', 'Mixolidio'] },
                        { q: '¿Qué modo suena más "brillante"?', a: 'Lidio', options: ['Frigio', 'Locrio', 'Lidio', 'Dórico'] },
                        { q: '¿D Dórico tiene las mismas notas que...?', a: 'C Mayor', options: ['D Mayor', 'C Mayor', 'G Mayor', 'A menor'] },
                    ],
                    hard: [
                        { q: '¿Qué modo se usa sobre acordes m7b5?', a: 'Locrio', options: ['Dórico', 'Frigio', 'Eólico', 'Locrio'] },
                        { q: '¿Qué modo es el IV de la menor melódica?', a: 'Lidio Dominante', options: ['Lidio', 'Mixolidio', 'Lidio Dominante', 'Alterada'] },
                    ]
                },
                theory: {
                    easy: [
                        { q: '¿Cuántos semitonos hay en una octava?', a: '12', options: ['7', '10', '12', '14'] },
                        { q: '¿Qué progresión es I-V-vi-IV?', a: 'Pop Universal', options: ['Blues', 'Pop Universal', 'Jazz', 'Flamenco'] },
                        { q: '¿Qué significa "relativo menor"?', a: 'Menor que comparte notas', options: ['Menor paralelo', 'Menor que comparte notas', 'Menor un tono abajo', 'Menor armónica'] },
                    ],
                    medium: [
                        { q: '¿Qué es un dominante secundario?', a: 'V de un grado que no es I', options: ['V del I', 'V de un grado que no es I', 'VII del I', 'bVII'] },
                        { q: '¿Qué acorde resuelve por tritono al I?', a: 'SubV', options: ['V', 'IV', 'SubV', 'ii'] },
                    ],
                    hard: [
                        { q: '¿Qué es una cadencia plagal?', a: 'IV → I', options: ['V → I', 'IV → I', 'ii → V', 'vi → I'] },
                        { q: '¿Cuál es el tritono sustituto de G7?', a: 'Db7', options: ['C7', 'Db7', 'Ab7', 'F7'] },
                    ]
                }
            },

            // Ear Training data for level 14
            earTraining: {
                intervals: {
                    easy: [
                        { semitones: 4, name: '3ª Mayor', abbr: '3M', tip: 'Sonido alegre, como "Oh When the Saints"' },
                        { semitones: 5, name: '4ª Justa', abbr: '4J', tip: 'Como el inicio de "Here Comes the Bride"' },
                        { semitones: 7, name: '5ª Justa', abbr: '5J', tip: 'Vacío y poderoso, como el power chord' },
                        { semitones: 12, name: '8ª (Octava)', abbr: '8J', tip: 'Misma nota, una octava arriba' }
                    ],
                    medium: [
                        { semitones: 2, name: '2ª Mayor', abbr: '2M', tip: 'Paso de escala, muy cercano' },
                        { semitones: 3, name: '3ª menor', abbr: '3m', tip: 'Sonido triste o melancólico' },
                        { semitones: 9, name: '6ª Mayor', abbr: '6M', tip: 'Romántico, como "My Way"' },
                        { semitones: 10, name: '7ª menor', abbr: '7m', tip: 'Tensión que pide resolución' },
                        { semitones: 11, name: '7ª Mayor', abbr: '7M', tip: 'Muy tenso, jazz/sofisticado' }
                    ],
                    hard: [
                        { semitones: 1, name: '2ª menor', abbr: '2m', tip: 'Tiburón - muy tenso y cercano' },
                        { semitones: 6, name: 'Tritono (4ªAum/5ªDim)', abbr: 'TT', tip: 'El intervalo del diablo, máxima tensión' },
                        { semitones: 8, name: '6ª menor', abbr: '6m', tip: 'Nostálgico, como "The Entertainer"' },
                        { semitones: 13, name: '9ª Mayor', abbr: '9M', tip: 'Octava + 2ª Mayor' },
                        { semitones: 14, name: '9ª menor', abbr: '9m', tip: 'Octava + 2ª menor (blues)' },
                        { semitones: 15, name: '10ª menor', abbr: '10m', tip: 'Octava + 3ª menor' },
                        { semitones: 16, name: '10ª Mayor', abbr: '10M', tip: 'Octava + 3ª Mayor' }
                    ]
                },

                // Chord Quality Recognition
                chordQualities: {
                    easy: [
                        { intervals: [0, 4, 7], name: 'Mayor', abbr: 'M', tip: 'Alegre y estable' },
                        { intervals: [0, 3, 7], name: 'Menor', abbr: 'm', tip: 'Triste y melancólico' }
                    ],
                    medium: [
                        { intervals: [0, 3, 6], name: 'Disminuido', abbr: 'dim', tip: 'Tenso e inestable' },
                        { intervals: [0, 4, 8], name: 'Aumentado', abbr: 'aug', tip: 'Suspensión misteriosa' },
                        { intervals: [0, 2, 7], name: 'Sus2', abbr: 'sus2', tip: 'Abierto y flotante' },
                        { intervals: [0, 5, 7], name: 'Sus4', abbr: 'sus4', tip: 'Suspensión que pide resolución' }
                    ],
                    hard: [
                        { intervals: [0, 4, 7, 11], name: 'Mayor 7', abbr: 'maj7', tip: 'Sofisticado y jazzy' },
                        { intervals: [0, 3, 7, 10], name: 'Menor 7', abbr: 'm7', tip: 'Melancólico pero suave' },
                        { intervals: [0, 4, 7, 10], name: 'Dominante 7', abbr: '7', tip: 'Tensión que resuelve' },
                        { intervals: [0, 3, 6, 10], name: 'Semidisminuido', abbr: 'm7b5', tip: 'Modo locrio, muy tenso' },
                        { intervals: [0, 3, 6, 9], name: 'Disminuido 7', abbr: 'dim7', tip: 'Simétrico y muy tenso' },
                        { intervals: [0, 4, 7, 9], name: 'Mayor 6', abbr: '6', tip: 'Alegre vintage' },
                        { intervals: [0, 3, 7, 11], name: 'Menor(maj7)', abbr: 'm(maj7)', tip: 'Armónico menor, misterioso' },
                        { intervals: [0, 4, 7, 10, 13], name: 'Dominante 7b9', abbr: '7b9', tip: 'Muy tenso, blues/metal' },
                        { intervals: [0, 2, 7, 11], name: 'Sus2(maj7)', abbr: 'sus2(maj7)', tip: 'Lydian, etéreo' }
                    ]
                },

                // Progression Identification
                progressions: {
                    easy: [
                        { pattern: ['I', 'IV', 'V'], name: 'I-IV-V', tip: 'La progresión más básica del rock/blues' },
                        { pattern: ['I', 'V', 'vi', 'IV'], name: 'I-V-vi-IV', tip: 'Pop universal - miles de hits' },
                        { pattern: ['I', 'vi', 'IV', 'V'], name: 'I-vi-IV-V', tip: '50s progression, doo-wop' },
                        { pattern: ['vi', 'IV', 'I', 'V'], name: 'vi-IV-I-V', tip: 'Empieza en menor, muy dramático' }
                    ],
                    medium: [
                        { pattern: ['ii', 'V', 'I'], name: 'ii-V-I', tip: 'Cadencia de jazz, la más importante' },
                        { pattern: ['I', 'vi', 'ii', 'V'], name: 'I-vi-ii-V', tip: 'Circle progression, jazz clásico' },
                        { pattern: ['I', 'bVII', 'IV'], name: 'I-bVII-IV', tip: 'Mixolidio, rock modal' },
                        { pattern: ['i', 'bVI', 'bVII'], name: 'i-bVI-bVII', tip: 'Metal natural minor' },
                        { pattern: ['vi', 'IV', 'I', 'V'], name: 'vi-IV-I-V', tip: 'Empieza en relativo menor' }
                    ],
                    hard: [
                        { pattern: ['i', 'bVI', 'bIII', 'bVII'], name: 'i-bVI-bIII-bVII', tip: 'Progresión épica moderna' },
                        { pattern: ['I', 'bII', 'bVII', 'I'], name: 'I-bII-bVII-I', tip: 'Phrygian dominant, metal/oriental' },
                        { pattern: ['ii', 'V', 'I', 'vi'], name: 'ii-V-I-vi', tip: 'Jazz con deceptive cadence' },
                        { pattern: ['I', 'IV', 'bVII', 'IV'], name: 'I-IV-bVII-IV', tip: 'Dorian vamp, modal' },
                        { pattern: ['i', 'iv', 'i', 'V'], name: 'i-iv-i-V', tip: 'Menor natural, funk/soul' }
                    ]
                },

                // Melodic Dictation Patterns
                melodicPatterns: {
                    easy: [
                        { notes: [0, 2, 4, 2], name: 'Ascenso-Descenso', tip: 'Do-Re-Mi-Re' },
                        { notes: [0, 0, 4, 4], name: 'Terceras Repetidas', tip: 'Do-Do-Mi-Mi' },
                        { notes: [7, 5, 4, 0], name: 'Descenso Escala', tip: 'Sol-Fa-Mi-Do' },
                        { notes: [0, 4, 7, 4], name: 'Arpegio Mayor', tip: 'Do-Mi-Sol-Mi' }
                    ],
                    medium: [
                        { notes: [0, 3, 5, 7], name: 'Pentatónica Menor', tip: 'Patrón blues básico' },
                        { notes: [0, 7, 5, 3], name: 'Descenso Pentatónico', tip: 'Do-Sol-Fa-Mib' },
                        { notes: [0, 2, 5, 7], name: 'Saltos Amplios', tip: 'Intervalos grandes' },
                        { notes: [7, 9, 11, 12], name: 'Ascenso Alto', tip: 'Sol-La-Si-Do' }
                    ],
                    hard: [
                        { notes: [0, 1, 4, 6], name: 'Cromático + Salto', tip: 'Approach notes jazzísticos' },
                        { notes: [0, 7, 3, 10], name: 'Intervalos Amplios', tip: '5ª, 3m, 7m' },
                        { notes: [0, 11, 9, 7], name: 'Descenso Cromático', tip: 'Do-Si-La-Sol' },
                        { notes: [0, 4, 9, 14], name: 'Arpegio Extendido', tip: 'Do-Mi-La-Re' }
                    ]
                },

                // Rhythmic Dictation Patterns
                rhythmicPatterns: {
                    easy: [
                        { hits: [1, 0, 1, 0, 1, 0, 1, 0], name: 'Quarter Notes', tip: 'Negras simples' },
                        { hits: [1, 1, 1, 1, 1, 1, 1, 1], name: 'Eighth Notes', tip: 'Corcheas constantes' },
                        { hits: [1, 0, 0, 1, 0, 0, 1, 0], name: 'Dotted Quarter', tip: 'Negra con puntillo' },
                        { hits: [1, 1, 0, 1, 1, 0, 1, 0], name: 'Simple Syncopation', tip: 'Síncopa básica' }
                    ],
                    medium: [
                        { hits: [1, 0, 1, 1, 0, 1, 0, 1], name: 'Shuffle/Swing', tip: 'Feeling ternario' },
                        { hits: [1, 1, 1, 0, 1, 1, 0, 1], name: 'Funk Syncopation', tip: 'Síncopa funk' },
                        { hits: [1, 0, 0, 1, 1, 0, 0, 1], name: 'Triplet Feel', tip: 'Tresillos implícitos' },
                        { hits: [1, 1, 0, 0, 1, 1, 1, 0], name: 'Latin Clave', tip: 'Patrón de clave' }
                    ],
                    hard: [
                        { hits: [1, 1, 1, 1, 0, 1, 1, 1, 0, 1, 0, 1, 1, 1, 1, 1], name: 'Sixteenth Funk', tip: 'Semicorcheas con síncopa' },
                        { hits: [1, 0, 1, 1, 1, 0, 1, 0, 1, 1, 0, 1, 0, 1, 1, 0], name: 'Complex Latin', tip: 'Ritmo latino complejo' },
                        { hits: [1, 1, 0, 1, 0, 1, 1, 0, 1, 0, 1, 1, 1, 0, 1, 0], name: 'Polyrhythmic', tip: 'Acentos polirítmicos' },
                        { hits: [1, 0, 0, 1, 1, 1, 0, 1, 1, 0, 1, 0, 0, 1, 1, 1], name: 'Advanced Syncopation', tip: 'Síncopa avanzada' }
                    ]
                }
            },

            // Backing Tracks for level 15
            backingTracks: [
                {
                    id: 'blues-12bar',
                    name: '12-Bar Blues Shuffle',
                    bpm: 90,
                    key: 0,
                    progression: ['I7', 'I7', 'I7', 'I7', 'IV7', 'IV7', 'I7', 'I7', 'V7', 'IV7', 'I7', 'V7'],
                    scale: 'blues',
                    style: 'Blues',
                    feel: 'Shuffle',
                    description: 'Blues clásico en 12 compases. Perfecto para practicar licks, bends y vibrato.'
                },
                {
                    id: 'blues-slow',
                    name: 'Slow Blues',
                    bpm: 60,
                    key: 0,
                    progression: ['I7', 'IV7', 'I7', 'I7', 'IV7', 'IV7', 'I7', 'I7', 'V7', 'IV7', 'I7', 'V7'],
                    scale: 'pentatonicMinor',
                    style: 'Blues',
                    feel: 'Ballad',
                    description: 'Blues lento estilo B.B. King. Enfócate en la expresión y el vibrato.'
                },
                {
                    id: 'rock-pop',
                    name: 'Pop Universal I-V-vi-IV',
                    bpm: 120,
                    key: 0,
                    progression: ['I', 'V', 'vi', 'IV'],
                    scale: 'pentatonicMajor',
                    style: 'Pop/Rock',
                    feel: 'Straight',
                    description: 'La progresión más famosa de todos los tiempos. Usada en miles de hits.'
                },
                {
                    id: 'rock-driving',
                    name: 'Rock Power Chords',
                    bpm: 140,
                    key: 0,
                    progression: ['I', 'bVII', 'IV', 'I'],
                    scale: 'pentatonicMinor',
                    style: 'Rock',
                    feel: 'Driving',
                    description: 'Rock energético con power chords. Perfecto para riffs agresivos.'
                },
                {
                    id: 'metal-riff',
                    name: 'Metal Riffing',
                    bpm: 160,
                    key: 0,
                    progression: ['i', 'bVI', 'bVII', 'i'],
                    scale: 'phrygian',
                    style: 'Metal',
                    feel: 'Aggressive',
                    description: 'Progresión metal con modo Frigio. Usa palm muting y downpicking.'
                },
                {
                    id: 'jazz-251',
                    name: 'Jazz Standard ii-V-I',
                    bpm: 140,
                    key: 0,
                    progression: ['ii', 'V', 'I', 'I'],
                    scale: 'major',
                    style: 'Jazz',
                    feel: 'Swing',
                    description: 'La cadencia fundamental del jazz. Practica arpegios y cromatismos.'
                },
                {
                    id: 'jazz-minor',
                    name: 'Jazz Minor ii-V-i',
                    bpm: 120,
                    key: 0,
                    progression: ['ii', 'V', 'i', 'i'],
                    scale: 'melodicMinor',
                    style: 'Jazz',
                    feel: 'Swing',
                    description: 'Progresión de jazz menor. Usa escala menor melódica sobre el i.'
                },
                {
                    id: 'funk-groove',
                    name: 'Funk 16th Notes',
                    bpm: 100,
                    key: 0,
                    progression: ['i', 'i', 'i', 'i'],
                    scale: 'pentatonicMinor',
                    style: 'Funk',
                    feel: '16th Groove',
                    description: 'Un solo acorde. Enfócate en el ritmo, ghost notes y sincopa.'
                },
                {
                    id: 'funk-7ths',
                    name: 'Funk 7th Chords',
                    bpm: 110,
                    key: 0,
                    progression: ['i', 'iv', 'i', 'V'],
                    scale: 'dorian',
                    style: 'Funk',
                    feel: 'Syncopated',
                    description: 'Funk con acordes de 7ª. Usa modo Dórico para improvisar.'
                },
                {
                    id: 'minor-epic',
                    name: 'Cinematic Epic',
                    bpm: 75,
                    key: 0,
                    progression: ['i', 'bVI', 'bIII', 'bVII'],
                    scale: 'minor',
                    style: 'Cinematográfico',
                    feel: 'Epic',
                    description: 'Progresión épica moderna. Perfecta para solos emotivos.'
                },
                {
                    id: 'latin-bossa',
                    name: 'Bossa Nova',
                    bpm: 130,
                    key: 0,
                    progression: ['I', 'ii', 'V', 'I'],
                    scale: 'major',
                    style: 'Latin',
                    feel: 'Bossa',
                    description: 'Ritmo brasileño suave. Practica acordes con 7ª y 9ª.'
                },
                {
                    id: 'latin-salsa',
                    name: 'Salsa Montuno',
                    bpm: 180,
                    key: 0,
                    progression: ['I', 'IV', 'V', 'I'],
                    scale: 'major',
                    style: 'Latin',
                    feel: 'Salsa',
                    description: 'Salsa rápida. Enfócate en notas staccato y sincopa latina.'
                },
                {
                    id: 'reggae-one-drop',
                    name: 'Reggae One Drop',
                    bpm: 80,
                    key: 0,
                    progression: ['I', 'V', 'vi', 'IV'],
                    scale: 'major',
                    style: 'Reggae',
                    feel: 'One Drop',
                    description: 'Reggae clásico. Rasguea en los tiempos 2 y 4 (offbeat).'
                },
                {
                    id: 'country-shuffle',
                    name: 'Country Shuffle',
                    bpm: 110,
                    key: 0,
                    progression: ['I', 'I', 'IV', 'I', 'V', 'IV', 'I', 'V'],
                    scale: 'pentatonicMajor',
                    style: 'Country',
                    feel: 'Shuffle',
                    description: 'Country clásico con bajo alternante. Practica chicken picking.'
                },
                {
                    id: 'grunge-alternative',
                    name: 'Grunge/Alternative',
                    bpm: 95,
                    key: 0,
                    progression: ['i', 'iv', 'bIII', 'bVI'],
                    scale: 'pentatonicMinor',
                    style: 'Grunge',
                    feel: 'Heavy',
                    description: 'Sonido grunge de los 90s. Power chords con distorsión suave.'
                }
            ],

            // Songs for level 13
            songs: [
                // METAL
                { name: 'Master of Puppets', artist: 'Metallica', key: 4, mode: 'minor', progression: ['i', 'bVI', 'bVII', 'i'], progressionChords: ['Em', 'C', 'D', 'Em'], scale: 'minor', genre: 'Thrash Metal', tips: 'Afinación estándar. Riff principal en E menor con cromatismos. Downpicking a alta velocidad.' },
                { name: 'Raining Blood', artist: 'Slayer', key: 4, mode: 'phrygian', progression: ['i', 'bII', 'i'], progressionChords: ['Em', 'F', 'Em'], scale: 'phrygian', genre: 'Thrash Metal', tips: 'Usa el modo Frigio. El bII (F) crea la tensión característica del metal extremo.' },
                { name: 'Painkiller', artist: 'Judas Priest', key: 4, mode: 'minor', progression: ['i', 'bVII', 'bVI', 'V'], progressionChords: ['Em', 'D', 'C', 'B'], scale: 'harmonicMinor', genre: 'Heavy Metal', tips: 'Menor armónica para el V mayor (B). Técnica extrema de doble bombo y velocidad.' },
                { name: 'Walk', artist: 'Pantera', key: 4, mode: 'minor', progression: ['i', 'bVII', 'bVI', 'bVII'], progressionChords: ['E5', 'D5', 'C5', 'D5'], scale: 'pentatonicMinor', genre: 'Groove Metal', tips: 'Power chords con palm mute. Groove pesado en 4/4. El groove es más importante que la velocidad.' },
                { name: 'Chop Suey!', artist: 'System of a Down', key: 7, mode: 'minor', progression: ['i', 'bVI', 'bIII', 'bVII'], progressionChords: ['Gm', 'Eb', 'Bb', 'F'], scale: 'minor', genre: 'Nu Metal', tips: 'Drop C. Cambios dinámicos extremos entre secciones suaves y pesadas.' },
                { name: 'The Trooper', artist: 'Iron Maiden', key: 4, mode: 'minor', progression: ['i', 'bVII', 'bVI', 'bVII'], progressionChords: ['Em', 'D', 'C', 'D'], scale: 'minor', genre: 'Heavy Metal', tips: 'Gallop picking característico. Harmonías de guitarras en terceras.' },
                // PROGRESIVO
                { name: 'Roundabout', artist: 'Yes', key: 4, mode: 'major', progression: ['I', 'IV', 'I', 'IV', 'V'], progressionChords: ['E', 'A', 'E', 'A', 'B'], scale: 'major', genre: 'Rock Progresivo', tips: 'Arpegio fingerpicking en E. Cambios de compás frecuentes.' },
                { name: 'Schism', artist: 'Tool', key: 2, mode: 'minor', progression: ['i', 'bVII', 'bVI'], progressionChords: ['Dm', 'C', 'Bb'], scale: 'minor', genre: 'Metal Progresivo', tips: 'Compases irregulares (5/8, 7/8). Drop D. Polirritmos complejos.' },
                { name: 'Pull Me Under', artist: 'Dream Theater', key: 4, mode: 'minor', progression: ['i', 'bVI', 'bVII', 'i'], progressionChords: ['Em', 'C', 'D', 'Em'], scale: 'minor', genre: 'Metal Progresivo', tips: 'Cambios de tempo y compás. Sección instrumental extensa con técnica avanzada.' },
                { name: 'Lateralus', artist: 'Tool', key: 2, mode: 'minor', progression: ['i', 'bVII', 'bVI', 'IV'], progressionChords: ['Dm', 'C', 'Bb', 'G'], scale: 'minor', genre: 'Metal Progresivo', tips: 'Basado en secuencia Fibonacci. Polirritmos. La estructura sigue matemáticas complejas.' },
                // ROCK
                { name: 'Comfortably Numb', artist: 'Pink Floyd', key: 11, mode: 'minor', progression: ['i', 'IV', 'bVII', 'bVI'], progressionChords: ['Bm', 'E', 'A', 'G'], scale: 'minor', genre: 'Rock Progresivo', tips: 'Solo icónico en Bm pentatónica. Bends expresivos y vibrato amplio.' },
                { name: 'Eruption', artist: 'Van Halen', key: 9, mode: 'minor', progression: ['Instrumental'], progressionChords: ['Am'], scale: 'pentatonicMinor', genre: 'Hard Rock', tips: 'Tapping, tremolo picking, whammy bar. Am pentatónica. Técnica revolucionaria.' },
                { name: 'Sweet Child O Mine', artist: "Guns N' Roses", key: 2, mode: 'major', progression: ['I', 'V', 'vi', 'IV'], progressionChords: ['D', 'A', 'Bm', 'G'], scale: 'major', genre: 'Hard Rock', tips: 'Riff en D mayor. Secuencia de arpegio icónica con string skipping.' },
                { name: 'Stairway to Heaven', artist: 'Led Zeppelin', key: 9, mode: 'minor', progression: ['i', 'bVII6', 'bVI', 'bVII'], progressionChords: ['Am', 'G/B', 'C', 'D'], scale: 'minor', genre: 'Rock', tips: 'Arpegio fingerpicking. Progresión descendente de bajo. Construcción dinámica perfecta.' },
                // BLUES
                { name: 'The Thrill Is Gone', artist: 'B.B. King', key: 11, mode: 'minor', progression: ['i', 'iv', 'i', 'V'], progressionChords: ['Bm', 'Em', 'Bm', 'F#7'], scale: 'pentatonicMinor', genre: 'Blues', tips: 'Blues menor en Bm. Vibrato y bends expresivos al estilo B.B. King. Menos notas, más sentimiento.' },
                { name: 'Cross Road Blues', artist: 'Robert Johnson', key: 9, mode: 'minor', progression: ['I', 'IV', 'I', 'V'], progressionChords: ['A', 'D', 'A', 'E'], scale: 'pentatonicMinor', genre: 'Blues', tips: 'Blues de 12 compases clásico. Fingerpicking estilo Delta Blues. Afinación abierta opcional.' },
                { name: 'Red House', artist: 'Jimi Hendrix', key: 11, mode: 'major', progression: ['I', 'IV', 'I', 'V'], progressionChords: ['B', 'E', 'B', 'F#'], scale: 'pentatonicMinor', genre: 'Blues Rock', tips: 'Blues lento en B. Bends de un tono y medio. Mezcla de pentatónica mayor y menor.' },
                // JAZZ
                { name: 'Autumn Leaves', artist: 'Joseph Kosma', key: 7, mode: 'minor', progression: ['ii', 'V', 'I', 'IV', 'vii°', 'III', 'vi'], progressionChords: ['Am7', 'D7', 'Gmaj7', 'Cmaj7', 'F#m7b5', 'B7', 'Em'], scale: 'minor', genre: 'Jazz', tips: 'Standard de jazz esencial. Progresión ii-V-I en mayor y menor. Base para improvisar con arpegios.' },
                { name: 'So What', artist: 'Miles Davis', key: 2, mode: 'dorian', progression: ['i', 'i'], progressionChords: ['Dm7', 'Ebm7'], scale: 'dorian', genre: 'Cool Jazz', tips: 'Jazz modal. 16 compases en Dm7, 8 en Ebm7, 8 en Dm7. Usa el modo Dórico.' },
                { name: 'Girl from Ipanema', artist: 'Tom Jobim', key: 5, mode: 'major', progression: ['I', 'ii', 'I', 'ii'], progressionChords: ['Fmaj7', 'G7', 'Fmaj7', 'Gb7'], scale: 'major', genre: 'Bossa Nova', tips: 'Bossa nova icónica. Ritmo sincopado brasileño. Acordes con 7ª y 9ª. Modulación cromática al puente.' },
                { name: 'Take Five', artist: 'Dave Brubeck', key: 4, mode: 'minor', progression: ['i', 'bVII', 'i', 'bVII'], progressionChords: ['Ebm', 'Bbm7', 'Ebm', 'Bbm7'], scale: 'pentatonicMinor', genre: 'Jazz', tips: 'Compás de 5/4. Ostinato de piano en Ebm. Uno de los temas de jazz más reconocibles.' },
                // FUNK/SOUL
                { name: 'Superstition', artist: 'Stevie Wonder', key: 4, mode: 'minor', progression: ['i', 'bVII', 'IV'], progressionChords: ['Ebm', 'Db', 'Ab'], scale: 'pentatonicMinor', genre: 'Funk', tips: 'Riff de clavinet icónico. Groove funk sincopado. Pentatónica menor con cromatismos.' },
                { name: 'Le Freak', artist: 'Chic', key: 9, mode: 'minor', progression: ['i', 'bVII', 'i', 'bVII'], progressionChords: ['Am7', 'G', 'Am7', 'G'], scale: 'pentatonicMinor', genre: 'Funk', tips: 'Guitarra rítmica funk con acordes parciales. Ritmo disco sincopado. Nile Rodgers style.' },
                { name: "Ain't No Sunshine", artist: 'Bill Withers', key: 9, mode: 'minor', progression: ['i', 'iv', 'V', 'i'], progressionChords: ['Am', 'Dm', 'E7', 'Am'], scale: 'minor', genre: 'Soul', tips: 'Progresión menor simple pero emotiva. Menor armónica en el V (E7). Fingerpicking suave.' },
                // POP
                { name: 'Let It Be', artist: 'The Beatles', key: 0, mode: 'major', progression: ['I', 'V', 'vi', 'IV'], progressionChords: ['C', 'G', 'Am', 'F'], scale: 'major', genre: 'Pop Rock', tips: 'Progresión I-V-vi-IV en C. Acordes abiertos básicos. Solo pentatónico sobre la progresión.' },
                { name: 'Wonderwall', artist: 'Oasis', key: 4, mode: 'minor', progression: ['i', 'bIII', 'bVII', 'IV'], progressionChords: ['Em7', 'G', 'D', 'A7sus4'], scale: 'minor', genre: 'Pop Rock', tips: 'Rasgueo constante con patrón Down-Down-Up-Up-Down-Up. Capo en traste 2. Acordes suspendidos.' },
                { name: 'Hotel California', artist: 'Eagles', key: 11, mode: 'minor', progression: ['i', 'V', 'bVII', 'IV', 'bVI', 'bIII', 'iv', 'V'], progressionChords: ['Bm', 'F#7', 'A', 'E', 'G', 'D', 'Em', 'F#7'], scale: 'harmonicMinor', genre: 'Rock', tips: 'Arpegio fingerpicking. Progresión de 8 acordes descendente. Solo final con armonías de guitarra en terceras.' },
                // FLAMENCO/LATIN
                { name: 'Entre dos Aguas', artist: 'Paco de Lucía', key: 9, mode: 'phrygian', progression: ['i', 'bII', 'bVII', 'i'], progressionChords: ['Am', 'Bb', 'G', 'Am'], scale: 'phrygian', genre: 'Flamenco', tips: 'Rumba flamenca. Técnica de pulgar y rasgueados. Modo Frigio con cadencia andaluza.' },
                { name: 'Oye Como Va', artist: 'Santana', key: 9, mode: 'dorian', progression: ['i', 'IV', 'i', 'IV'], progressionChords: ['Am7', 'D7', 'Am7', 'D7'], scale: 'dorian', genre: 'Latin Rock', tips: 'Dos acordes: Am7 y D7. Modo Dórico. Groove latino con guitarra eléctrica. Improvisación modal.' },
                { name: 'Europa', artist: 'Santana', key: 0, mode: 'minor', progression: ['i', 'bVII', 'bVI', 'V'], progressionChords: ['Cm', 'Bb', 'Ab', 'G'], scale: 'harmonicMinor', genre: 'Latin Rock', tips: 'Balada instrumental. Menor armónica para el V mayor. Vibrato y bends expresivos estilo Santana.' },
                // REGGAE
                { name: 'No Woman No Cry', artist: 'Bob Marley', key: 0, mode: 'major', progression: ['I', 'V', 'vi', 'IV'], progressionChords: ['C', 'G', 'Am', 'F'], scale: 'major', genre: 'Reggae', tips: 'Rasgueo reggae en los tiempos 2 y 4 (offbeat). Acordes abiertos. Ritmo relajado.' },
                { name: 'Three Little Birds', artist: 'Bob Marley', key: 9, mode: 'major', progression: ['I', 'IV', 'I', 'V'], progressionChords: ['A', 'D', 'A', 'E'], scale: 'major', genre: 'Reggae', tips: 'Tres acordes básicos. Strum en offbeat. Groove reggae simple y efectivo.' },
                // COUNTRY
                { name: 'Folsom Prison Blues', artist: 'Johnny Cash', key: 4, mode: 'major', progression: ['I', 'IV', 'I', 'V'], progressionChords: ['E', 'A', 'E', 'B7'], scale: 'pentatonicMinor', genre: 'Country', tips: 'Boom-chicka pattern con bajo alternante. Country blues con tren rhythm. Pentatónica con sabor country.' },
                { name: 'Jolene', artist: 'Dolly Parton', key: 0, mode: 'minor', progression: ['i', 'bIII', 'iv', 'i'], progressionChords: ['Am', 'C', 'Dm', 'Am'], scale: 'minor', genre: 'Country', tips: 'Fingerpicking rápido en Am. Ritmo urgente. Acordes menores con melodía vocal icónica.' },
                // GRUNGE/ALT
                { name: 'Smells Like Teen Spirit', artist: 'Nirvana', key: 5, mode: 'minor', progression: ['i', 'iv', 'bIII', 'bVI'], progressionChords: ['Fm', 'Bbm', 'Ab', 'Db'], scale: 'pentatonicMinor', genre: 'Grunge', tips: 'Power chords con distorsión. Dinámica suave/fuerte. Patrón rítmico simple pero efectivo.' },
                { name: 'Black Hole Sun', artist: 'Soundgarden', key: 7, mode: 'minor', progression: ['i', 'V', 'bVI', 'bII'], progressionChords: ['Gm', 'D', 'Eb', 'Ab'], scale: 'minor', genre: 'Grunge', tips: 'Acordes inusuales y oscuros. Mezcla de mayor y menor. Drop D tuning. Atmósfera surrealista.' },
                { name: 'The Scientist', artist: 'Coldplay', key: 2, mode: 'major', progression: ['vi', 'IV', 'I', 'V'], progressionChords: ['Bm', 'G', 'D', 'A'], scale: 'major', genre: 'Alternative', tips: 'Arpegio fingerpicking. Progresión emotiva empezando en vi menor. Pedal de delay para ambiente.' },
                { name: 'Seven Nation Army', artist: 'The White Stripes', key: 4, mode: 'minor', progression: ['Riff modal'], progressionChords: ['E5-G5-D5-C5-B5'], scale: 'pentatonicMinor', genre: 'Alternative Rock', tips: 'Riff icónico con octavador. E pentatónica menor. Minimalismo poderoso con dos notas.' },
                // FLAMENCO TRADICIONAL
                { name: 'Tangos de Triana', artist: 'Tradicional', key: 9, mode: 'phrygian', progression: ['i', 'bVII', 'bVI', 'V'], progressionChords: ['Am', 'G', 'F', 'E'], scale: 'phrygian', genre: 'Flamenco', tips: 'Compás de 4/4. Rasgueado flamenco con acentos en 1 y 3. Cadencia andaluza característica.' },
                { name: 'Bulerías', artist: 'Paco de Lucía', key: 9, mode: 'phrygian', progression: ['i', 'bII', 'i'], progressionChords: ['A', 'Bb', 'A'], scale: 'phrygianDominant', genre: 'Flamenco', tips: 'Compás de 12 tiempos (acentos 3-6-8-10-12). Modo Frigio dominante. Técnica de pulgar y alzapúa.' },
                { name: 'Alegrías', artist: 'Tradicional', key: 4, mode: 'major', progression: ['I', 'IV', 'V', 'I'], progressionChords: ['E', 'A', 'B7', 'E'], scale: 'major', genre: 'Flamenco', tips: 'Compás de 12 similar a soleá. E mayor con intercambios modales frigios. Palmas y jaleos.' },
                { name: 'Soleá', artist: 'Tradicional', key: 4, mode: 'phrygian', progression: ['i', 'bVII', 'bVI', 'V'], progressionChords: ['E', 'D', 'C', 'B'], scale: 'phrygian', genre: 'Flamenco', tips: 'Compás de 12 con acentos 3-6-8-10-12. E Frigio. La "madre" del flamenco. Tempo lento y majestuoso.' },
                { name: 'Rumba Gitana', artist: 'Gipsy Kings', key: 2, mode: 'phrygian', progression: ['i', 'bVII', 'bVI', 'V'], progressionChords: ['Dm', 'C', 'Bb', 'A'], scale: 'phrygian', genre: 'Rumba Flamenca', tips: 'Rumba catalana. Rasgueo: abajo-abajo-arriba-abajo-arriba. Percusión en la guitarra.' },
                // JAZZ/FUSION AVANZADO
                { name: 'All Blues', artist: 'Miles Davis', key: 7, mode: 'mixolydian', progression: ['I7', 'IV7', 'I7', 'V7'], progressionChords: ['G7', 'C7', 'G7', 'D7'], scale: 'mixolydian', genre: 'Jazz Modal', tips: 'Blues modal en 6/8. G Mixolidio. Forma de 12 compases con acordes dominantes. Modal no funcional.' },
                { name: 'Blue Bossa', artist: 'Kenny Dorham', key: 0, mode: 'minor', progression: ['ii', 'V', 'i', 'IV', 'vii°', 'III', 'VI', 'ii', 'V'], progressionChords: ['Cm7', 'Fm7', 'Dm7b5', 'G7', 'Ebmaj7', 'Abmaj7', 'Dm7b5', 'G7'], scale: 'dorian', genre: 'Jazz Bossa', tips: 'Bossa nova con ii-V-i en menor. Modulación a Eb mayor. Ritmo sincopado brasileño.' },
                { name: 'Spain', artist: 'Chick Corea', key: 7, mode: 'lydian', progression: ['I', 'bVII', 'I'], progressionChords: ['Gmaj7', 'F#7', 'Gmaj7'], scale: 'lydian', genre: 'Jazz Fusion', tips: 'Intro con arpegios flamencos en G. Sección modal Gmaj7 (Lidio). Modulación a Gmaj7 después del puente.' },
                { name: 'Chameleon', artist: 'Herbie Hancock', key: 10, mode: 'dorian', progression: ['i', 'IV'], progressionChords: ['Bbm7', 'Eb7'], scale: 'dorian', genre: 'Jazz Funk', tips: 'Riff de bajo funk. Bb Dórico. Groove sintetizador. Improvisación modal sobre ostinato.' },
                { name: 'Cantaloupe Island', artist: 'Herbie Hancock', key: 5, mode: 'dorian', progression: ['i', 'IV'], progressionChords: ['Fm7', 'Db7'], scale: 'dorian', genre: 'Jazz Funk', tips: 'F Dórico con IV mayor. Groove funk de 16 compases. Uno de los jazz standards más accesibles.' },
                { name: 'Strasbourg/St. Denis', artist: 'Roy Hargrove', key: 2, mode: 'dorian', progression: ['i', 'i'], progressionChords: ['Dm7', 'Dm7'], scale: 'dorian', genre: 'Jazz Hip-Hop', tips: 'Vamp modal en Dm7 con feel hip-hop. D Dórico. Groove groove groove. Improvisación libre.' },
                // BOSSA NOVA
                { name: 'Wave', artist: 'Tom Jobim', key: 2, mode: 'major', progression: ['I', 'vi', 'ii', 'V'], progressionChords: ['Dmaj7', 'Bm7', 'Em7', 'A7'], scale: 'major', genre: 'Bossa Nova', tips: 'Bossa clásica. Progresión I-vi-ii-V. Ritmo sincopado brasileño. Acordes con 7ª y extensiones.' },
                { name: 'Desafinado', artist: 'Tom Jobim', key: 5, mode: 'major', progression: ['ii', 'V', 'I'], progressionChords: ['Gm7', 'C7', 'Fmaj7'], scale: 'major', genre: 'Bossa Nova', tips: 'Bossa con múltiples ii-V-I. Modulaciones sutiles. Acordes de jazz con 9ª y 11ª.' },
                { name: 'Água de Beber', artist: 'Tom Jobim', key: 9, mode: 'dorian', progression: ['i', 'iv', 'V'], progressionChords: ['Am7', 'Dm7', 'E7'], scale: 'dorian', genre: 'Bossa Nova', tips: 'A Dórico con cadencia i-iv-V. Menor con V mayor (prestado de armónica). Ritmo bossa clásico.' },
                // ELECTRÓNICA/MODERNA
                { name: 'Strobe', artist: 'deadmau5', key: 2, mode: 'dorian', progression: ['i', 'V', 'bVII', 'IV'], progressionChords: ['Dm', 'A', 'C', 'G'], scale: 'dorian', genre: 'Progressive House', tips: 'Progresión electrónica progresiva. D Dórico. Construcción lenta de tensión. Minimalismo épico.' },
                { name: 'Midnight City', artist: 'M83', key: 2, mode: 'major', progression: ['I', 'V', 'vi', 'IV'], progressionChords: ['D', 'A', 'Bm', 'G'], scale: 'major', genre: 'Synthwave', tips: 'Progresión pop universal con sintetizadores. Ambiente nostálgico 80s. Delay y reverb.' },
                { name: 'Concerning Hobbits', artist: 'Howard Shore', key: 2, mode: 'mixolydian', progression: ['I', 'bVII', 'I', 'bVII'], progressionChords: ['D', 'C', 'D', 'C'], scale: 'mixolydian', genre: 'Soundtrack', tips: 'D Mixolidio con bVII. Ambiente pastoral. Ritmo de giga irlandesa. Melodía folk.' },
            ],

            // Progressions with chord degrees
            progressions: {
                'I-IV-V-I': {
                    degrees: [1, 4, 5, 1],
                    name: 'Blues Básico',
                    style: 'Blues/Rock clásico',
                    function: ['T', 'SD', 'D', 'T'],
                    analysis: 'Progresión fundamental. El IV crea tensión suave, el V tensión fuerte que resuelve al I. Base del blues y rock.',
                    songs: ['Johnny B. Goode (Chuck Berry)', 'La Bamba (Ritchie Valens)']
                },
                'I-V-vi-IV': {
                    degrees: [1, 5, 6, 4],
                    name: 'Pop Universal',
                    style: 'Pop moderno',
                    function: ['T', 'D', 'Tm', 'SD'],
                    analysis: 'La progresión más popular de todos los tiempos. El vi (menor relativo) añade emoción, el IV crea anticipación antes de volver al I.',
                    songs: ['Let It Be (Beatles)', 'No Woman No Cry (Bob Marley)', 'With or Without You (U2)']
                },
                'ii-V-I': {
                    degrees: [2, 5, 1],
                    name: 'Jazz ii-V-I',
                    style: 'Jazz/Standards',
                    function: ['SD', 'D', 'T'],
                    analysis: 'Cadencia perfecta del jazz. El ii prepara al V (dominante) que resuelve con fuerza al I. Se encadenan múltiples ii-V-I modulando.',
                    songs: ['Autumn Leaves', 'Fly Me to the Moon', 'Take the A Train']
                },
                'I-vi-IV-V': {
                    degrees: [1, 6, 4, 5],
                    name: '50s Doo-wop',
                    style: 'Oldies/Doo-wop',
                    function: ['T', 'Tm', 'SD', 'D'],
                    analysis: 'Progresión circular clásica de los 50s. El vi mantiene la tonalidad, IV y V crean tensión que resuelve al volver al I.',
                    songs: ['Stand by Me (Ben E. King)', 'Earth Angel', 'Blue Moon']
                },
                'vi-IV-I-V': {
                    degrees: [6, 4, 1, 5],
                    name: 'Axis Progression',
                    style: 'Pop épico',
                    function: ['Tm', 'SD', 'T', 'D'],
                    analysis: 'Versión dramática de I-V-vi-IV. Empezar en vi crea melancolía que se eleva al llegar al I. Muy emotiva.',
                    songs: ['Africa (Toto)', 'Poker Face (Lady Gaga)', 'Cheap Thrills (Sia)']
                },
                'I-bVII-IV-I': {
                    degrees: [1, -7, 4, 1],
                    name: 'Rock Mixolidio',
                    style: 'Rock clásico',
                    function: ['T', 'bVII', 'SD', 'T'],
                    analysis: 'El bVII (acorde prestado) viene del modo Mixolidio. Crea sonido rock/bluesy característico.',
                    songs: ['Sweet Home Alabama', 'Hey Jude (puente)']
                },
                'i-bVII-bVI-V': {
                    degrees: [-1, -7, -6, 5],
                    name: 'Andaluza',
                    style: 'Flamenco/Metal',
                    function: ['Tm', 'bVII', 'bVI', 'D'],
                    analysis: 'Cadencia andaluza. Progresión descendente desde i con acordes del modo Frigio. El V mayor (dominante) crea resolución fuerte.',
                    songs: ['Hit the Lights (Metallica)', 'Flamenco tradicional']
                },
                'i-bVI-bIII-bVII': {
                    degrees: [-1, -6, -3, -7],
                    name: 'Epic/Cinematic',
                    style: 'Épico/Cine',
                    function: ['Tm', 'bVI', 'bIII', 'bVII'],
                    analysis: 'Progresión épica moderna. Los acordes mayores (bVI, bIII, bVII) en tonalidad menor crean grandiosidad cinematográfica.',
                    songs: ['Wake Me Up (Avicii)', 'Numb (Linkin Park)', 'Bandas sonoras épicas']
                },
                'i-iv-v-i': {
                    degrees: [-1, -4, -5, -1],
                    name: 'Menor Clásica',
                    style: 'Clásico/Barroco',
                    function: ['Tm', 'SDm', 'Dm', 'Tm'],
                    analysis: 'Progresión menor natural. Todos los acordes diatónicos a la escala menor. Sonido oscuro y clásico.',
                    songs: ['Música clásica barroca', 'Stairway to Heaven (intro)']
                },
                'I-vi-ii-V': {
                    degrees: [1, 6, 2, 5],
                    name: 'Rhythm Changes',
                    style: 'Jazz/Bebop',
                    function: ['T', 'Tm', 'SD', 'D'],
                    analysis: 'Progresión de jazz bebop. Movimiento suave descendente por terceras que prepara el ii-V-I.',
                    songs: ['I Got Rhythm (Gershwin)', 'Anthropology (Charlie Parker)']
                },
                'I-V-vi-iii-IV-I-IV-V': {
                    degrees: [1, 5, 6, 3, 4, 1, 4, 5],
                    name: 'Canon de Pachelbel',
                    style: 'Barroco/Pop',
                    function: ['T', 'D', 'Tm', 'Dm', 'SD', 'T', 'SD', 'D'],
                    analysis: 'Progresión barroca de 8 acordes. Recorre toda la tonalidad con movimiento de bajo descendente. Usada en miles de canciones modernas.',
                    songs: ['Canon en D (Pachelbel)', 'Basket Case (Green Day)', 'Don\'t Look Back in Anger (Oasis)']
                },
                'bII7-I': {
                    degrees: [-2, 1],
                    name: 'Sustitución Tritonal',
                    style: 'Jazz avanzado',
                    function: ['SubV', 'T'],
                    analysis: 'Sustitución del dominante (V7) por su tritono (bII7). El bII7 comparte el tritono con V7 pero crea movimiento cromático descendente al I. Técnica fundamental del bebop.',
                    songs: ['Blue Bossa (Kenny Dorham)', 'Satin Doll (Duke Ellington)', 'Misty (Erroll Garner)']
                },
                'I-III7-VImaj7-bII7-I': {
                    degrees: [1, 3, 6, -2, 1],
                    name: 'Cambios Coltrane',
                    style: 'Jazz modal/Coltrane',
                    function: ['T', 'D/vi', 'T', 'SubV', 'T'],
                    analysis: 'Secuencia de tonalidades distantes por terceras mayores (Coltrane Cycles). El III7 modula al VI, el bII7 resuelve al I. Revolucionó el jazz moderno.',
                    songs: ['Giant Steps (John Coltrane)', 'Countdown (John Coltrane)', '26-2 (John Coltrane)']
                },
                'I-vi-ii-V-I-vi-ii-V-IV-iv-I-ii-V-I': {
                    degrees: [1, 6, 2, 5, 1, 6, 2, 5, 4, -4, 1, 2, 5, 1],
                    name: 'Rhythm Changes (completo)',
                    style: 'Jazz/Bebop',
                    function: ['T', 'Tm', 'SD', 'D', 'T', 'Tm', 'SD', 'D', 'SD', 'SDm', 'T', 'SD', 'D', 'T'],
                    analysis: 'Forma armónica completa de "I Got Rhythm". Sección A: I-vi-ii-V circular. Bridge (B): IV-iv-I (cadencia plagal con préstamo modal) seguido de ii-V-I. Estructura AABA estándar del jazz.',
                    songs: ['I Got Rhythm (Gershwin)', 'Anthropology (Parker)', 'Oleo (Rollins)', 'Rhythm-a-ning (Monk)']
                },
                'iii7-VI7-ii7-V7-I': {
                    degrees: [3, 6, 2, 5, 1],
                    name: 'Turnaround Extendido',
                    style: 'Jazz/Standards',
                    function: ['D/vi', 'D/ii', 'SD', 'D', 'T'],
                    analysis: 'Cadena de dominantes secundarias que prepara el ii-V-I. El iii7 funciona como V7/vi, VI7 como V7/ii. Crea momentum armónico hacia la resolución.',
                    songs: ['Autumn Leaves', 'All the Things You Are', 'Stella by Starlight']
                },
                'i-IV': {
                    degrees: [-1, 4],
                    name: 'Vamp Dórico',
                    style: 'Jazz modal/Funk',
                    function: ['Tm', 'SD'],
                    analysis: 'Ostinato modal característico del modo Dórico. El IV mayor sobre tónica menor define el sonido dórico (6ª mayor). Sin función de dominante, crea groove hipnótico.',
                    songs: ['So What (Miles Davis)', 'Impressions (Coltrane)', 'Oye Como Va (Santana)', 'Get Lucky (Daft Punk)']
                },
                'I-bII': {
                    degrees: [1, -2],
                    name: 'Vamp Frigio',
                    style: 'Flamenco/Metal/Español',
                    function: ['T', 'bII'],
                    analysis: 'Movimiento semitonal característico del modo Frigio (2ª menor). El bII crea tensión exótica sin resolución. Esencia del flamenco y metal melódico.',
                    songs: ['Master of Puppets (Metallica)', 'Flamenco tradicional', 'Dark Necessities (RHCP)', 'música española']
                },
                'bVII-IV-I': {
                    degrees: [-7, 4, 1],
                    name: 'Plagal Mixolidio',
                    style: 'Rock/Blues-rock',
                    function: ['bVII', 'SD', 'T'],
                    analysis: 'Cadencia plagal (IV-I) precedida del bVII mixolidio. Sonido rock clásico: el bVII viene del acorde prestado del modo mixolidio, el IV crea subdominante fuerte.',
                    songs: ['Sweet Child O\' Mine (GNR)', 'Free Fallin\' (Tom Petty)', 'Hey Jude (Beatles - puente)']
                },
                'vi-V-IV-V': {
                    degrees: [6, 5, 4, 5],
                    name: 'Indie/Alternative',
                    style: 'Indie rock/Alternative',
                    function: ['Tm', 'D', 'SD', 'D'],
                    analysis: 'Progresión indie moderna. Empieza en vi (melancolía), V crea tensión, IV alivia, V vuelve a tensar. Movimiento oscilante entre tensión y alivio sin resolución clara al I.',
                    songs: ['Mr. Brightside (The Killers)', 'When You Were Young (The Killers)', 'Indie rock moderno']
                },
                'i-bVII-bVI-bVII': {
                    degrees: [-1, -7, -6, -7],
                    name: 'Modal Menor Rock',
                    style: 'Rock/Metal progresivo',
                    function: ['Tm', 'bVII', 'bVI', 'bVII'],
                    analysis: 'Progresión eólica (menor natural) con énfasis en acordes prestados bVII y bVI. El bVII actúa como pivote entre i y bVI. Sonido épico y oscuro del rock progresivo.',
                    songs: ['Comfortably Numb (Pink Floyd)', 'Stairway to Heaven (Led Zeppelin - secciones)', 'Nothing Else Matters (Metallica)']
                },
                'I-III-vi-IV': {
                    degrees: [1, 3, 6, 4],
                    name: 'Ascenso por Terceras',
                    style: 'Pop/Rock melódico',
                    function: ['T', 'Dm', 'Tm', 'SD'],
                    analysis: 'Movimiento ascendente por terceras desde I. El III (mediant) es poco común y crea color sorprendente. Mantiene emoción elevada antes de resolver con IV.',
                    songs: ['Variaciones pop modernas', 'Power ballads']
                },
            },

            // Real chord voicings (fret positions for each string, -1 = muted, 0 = open)
            // Format: [E6, A5, D4, G3, B2, E1] (low to high)
            chordVoicings: {
                // Major chords (CAGED shapes)
                'C': { frets: [-1, 3, 2, 0, 1, 0], fingers: [0, 3, 2, 0, 1, 0], barreInfo: null, position: 0 },
                'A': { frets: [-1, 0, 2, 2, 2, 0], fingers: [0, 0, 1, 2, 3, 0], barreInfo: null, position: 0 },
                'G': { frets: [3, 2, 0, 0, 0, 3], fingers: [2, 1, 0, 0, 0, 3], barreInfo: null, position: 0 },
                'E': { frets: [0, 2, 2, 1, 0, 0], fingers: [0, 2, 3, 1, 0, 0], barreInfo: null, position: 0 },
                'D': { frets: [-1, -1, 0, 2, 3, 2], fingers: [0, 0, 0, 1, 3, 2], barreInfo: null, position: 0 },
                // Minor chords
                'Am': { frets: [-1, 0, 2, 2, 1, 0], fingers: [0, 0, 2, 3, 1, 0], barreInfo: null, position: 0 },
                'Em': { frets: [0, 2, 2, 0, 0, 0], fingers: [0, 2, 3, 0, 0, 0], barreInfo: null, position: 0 },
                'Dm': { frets: [-1, -1, 0, 2, 3, 1], fingers: [0, 0, 0, 2, 3, 1], barreInfo: null, position: 0 },
                // Barre chord templates (E shape and A shape)
                'E_shape_major': { frets: [0, 2, 2, 1, 0, 0], fingers: [1, 3, 4, 2, 1, 1], barreInfo: { fret: 0, fromString: 0, toString: 5 }, position: 0 },
                'E_shape_minor': { frets: [0, 2, 2, 0, 0, 0], fingers: [1, 3, 4, 1, 1, 1], barreInfo: { fret: 0, fromString: 0, toString: 5 }, position: 0 },
                'A_shape_major': { frets: [-1, 0, 2, 2, 2, 0], fingers: [0, 1, 3, 3, 3, 1], barreInfo: { fret: 0, fromString: 1, toString: 5 }, position: 0 },
                'A_shape_minor': { frets: [-1, 0, 2, 2, 1, 0], fingers: [0, 1, 3, 4, 2, 1], barreInfo: { fret: 0, fromString: 1, toString: 5 }, position: 0 },
            },

            // 7th chord voicings
            seventhVoicings: {
                'maj7_E': { frets: [0, 2, 1, 1, 0, 0], fingers: [0, 3, 1, 2, 0, 0], barreInfo: null, position: 0, type: 'maj7' },
                'maj7_A': { frets: [-1, 0, 2, 1, 2, 0], fingers: [0, 0, 2, 1, 3, 0], barreInfo: null, position: 0, type: 'maj7' },
                'maj7_C': { frets: [-1, 3, 2, 0, 0, 0], fingers: [0, 3, 2, 0, 0, 0], barreInfo: null, position: 0, type: 'maj7' },
                'm7_E': { frets: [0, 2, 0, 0, 0, 0], fingers: [0, 2, 0, 0, 0, 0], barreInfo: null, position: 0, type: 'm7' },
                'm7_A': { frets: [-1, 0, 2, 0, 1, 0], fingers: [0, 0, 2, 0, 1, 0], barreInfo: null, position: 0, type: 'm7' },
                'dom7_E': { frets: [0, 2, 0, 1, 0, 0], fingers: [0, 2, 0, 1, 0, 0], barreInfo: null, position: 0, type: '7' },
                'dom7_A': { frets: [-1, 0, 2, 0, 2, 0], fingers: [0, 0, 1, 0, 2, 0], barreInfo: null, position: 0, type: '7' },
                'm7b5_E': { frets: [-1, -1, 2, 3, 3, 3], fingers: [0, 0, 1, 2, 3, 4], barreInfo: null, position: 0, type: 'ø7' },
            },

            // Pentatonic box positions (fret range relative to root)
            pentatonicBoxes: {
                minor: [
                    { name: 'Box 1 (E shape)', startFret: 0, pattern: [
                        { string: 0, frets: [0, 3] },
                        { string: 1, frets: [0, 3] },
                        { string: 2, frets: [0, 2] },
                        { string: 3, frets: [0, 2] },
                        { string: 4, frets: [0, 2] },
                        { string: 5, frets: [0, 3] },
                    ]},
                    { name: 'Box 2 (D shape)', startFret: 3, pattern: [
                        { string: 0, frets: [0, 2] },
                        { string: 1, frets: [0, 2] },
                        { string: 2, frets: [-1, 2] },
                        { string: 3, frets: [-1, 2] },
                        { string: 4, frets: [-1, 2] },
                        { string: 5, frets: [0, 2] },
                    ]},
                    { name: 'Box 3 (C shape)', startFret: 5, pattern: [
                        { string: 0, frets: [0, 2] },
                        { string: 1, frets: [0, 3] },
                        { string: 2, frets: [0, 2] },
                        { string: 3, frets: [0, 2] },
                        { string: 4, frets: [0, 3] },
                        { string: 5, frets: [0, 2] },
                    ]},
                    { name: 'Box 4 (A shape)', startFret: 7, pattern: [
                        { string: 0, frets: [0, 3] },
                        { string: 1, frets: [0, 2] },
                        { string: 2, frets: [0, 2] },
                        { string: 3, frets: [0, 3] },
                        { string: 4, frets: [0, 2] },
                        { string: 5, frets: [0, 3] },
                    ]},
                    { name: 'Box 5 (G shape)', startFret: 10, pattern: [
                        { string: 0, frets: [0, 2] },
                        { string: 1, frets: [0, 2] },
                        { string: 2, frets: [-1, 2] },
                        { string: 3, frets: [0, 2] },
                        { string: 4, frets: [0, 2] },
                        { string: 5, frets: [0, 2] },
                    ]},
                ],
            },

            // CAGED positions with actual fret positions for C major
            cagedPositions: {
                'C': {
                    startFret: 0,
                    endFret: 3,
                    chord: { frets: [-1, 3, 2, 0, 1, 0], fingers: [0, 3, 2, 0, 1, 0] },
                    rootStrings: [1, 4], // A and B strings
                    description: 'Posición abierta'
                },
                'A': {
                    startFret: 2,
                    endFret: 5,
                    chord: { frets: [-1, 3, 5, 5, 5, 3], fingers: [0, 1, 3, 3, 3, 1], barreInfo: { fret: 3, fromString: 1, toString: 5 } },
                    rootStrings: [1, 3],
                    description: 'Traste 3 (cejilla)'
                },
                'G': {
                    startFret: 4,
                    endFret: 8,
                    chord: { frets: [8, 7, 5, 5, 5, 8], fingers: [3, 2, 1, 1, 1, 4] },
                    rootStrings: [0, 2, 5],
                    description: 'Traste 5-8'
                },
                'E': {
                    startFret: 7,
                    endFret: 10,
                    chord: { frets: [8, 10, 10, 9, 8, 8], fingers: [1, 3, 4, 2, 1, 1], barreInfo: { fret: 8, fromString: 0, toString: 5 } },
                    rootStrings: [0, 3, 5],
                    description: 'Traste 8 (cejilla)'
                },
                'D': {
                    startFret: 9,
                    endFret: 12,
                    chord: { frets: [-1, -1, 10, 12, 13, 12], fingers: [0, 0, 1, 3, 4, 2] },
                    rootStrings: [2, 4],
                    description: 'Traste 10-13'
                },
            },

            // Get chord voicing for any root note using shape transposition
            getChordVoicing(root, quality, preferredShape = 'E') {
                const rootIndex = typeof root === 'number' ? root : this.getNoteIndex(root);
                const shapeName = quality === 'minor' ? `${preferredShape}_shape_minor` : `${preferredShape}_shape_major`;

                // Base shapes start at different frets
                const basePositions = { 'E': 0, 'A': 0, 'G': 3, 'C': 0, 'D': 0 };
                const basePosition = basePositions[preferredShape] || 0;

                // Calculate transposition
                const transposition = rootIndex + basePosition;

                return {
                    ...this.chordVoicings[shapeName] || this.chordVoicings['E_shape_major'],
                    position: transposition
                };
            },

            // Lick Library - Level 17
            licks: [
                // SWEEP PICKING
                {
                    id: 'sweep-major-3string',
                    name: '3-String Major Sweep (Yngwie Style)',
                    genre: 'metal',
                    technique: 'sweep',
                    difficulty: 'easy',
                    bpm: 80,
                    description: 'Arpegio mayor básico de 3 cuerdas. Fundamental para sweep picking.',
                    key: 'A',
                    tabs: [
                        { time: 0, string: 2, fret: 14, technique: 'down' },
                        { time: 0.25, string: 1, fret: 13, technique: 'down' },
                        { time: 0.5, string: 0, fret: 12, technique: 'down' },
                        { time: 0.75, string: 1, fret: 13, technique: 'up' },
                        { time: 1, string: 2, fret: 14, technique: 'up' }
                    ],
                    fingering: [4, 3, 1, 3, 4],
                    position: 12
                },
                {
                    id: 'sweep-minor-5string',
                    name: '5-String Minor Sweep (Petrucci)',
                    genre: 'metal',
                    technique: 'sweep',
                    difficulty: 'medium',
                    bpm: 70,
                    description: 'Arpegio menor de 5 cuerdas estilo Dream Theater.',
                    key: 'Am',
                    tabs: [
                        { time: 0, string: 4, fret: 12, technique: 'down' },
                        { time: 0.2, string: 3, fret: 14, technique: 'down' },
                        { time: 0.4, string: 2, fret: 14, technique: 'down' },
                        { time: 0.6, string: 1, fret: 13, technique: 'down' },
                        { time: 0.8, string: 0, fret: 12, technique: 'down' },
                        { time: 1, string: 1, fret: 13, technique: 'up' },
                        { time: 1.2, string: 2, fret: 14, technique: 'up' },
                        { time: 1.4, string: 3, fret: 14, technique: 'up' },
                        { time: 1.6, string: 4, fret: 12, technique: 'up' }
                    ],
                    fingering: [1, 3, 2, 1, 1, 1, 2, 3, 1],
                    position: 12
                },
                {
                    id: 'sweep-dim7',
                    name: 'Diminished 7th Sweep (Jason Becker)',
                    genre: 'metal',
                    technique: 'sweep',
                    difficulty: 'hard',
                    bpm: 90,
                    description: 'Arpegio disminuido con patterns simétricos.',
                    key: 'Edim7',
                    tabs: [
                        { time: 0, string: 4, fret: 12, technique: 'down' },
                        { time: 0.166, string: 3, fret: 14, technique: 'down' },
                        { time: 0.333, string: 2, fret: 13, technique: 'down' },
                        { time: 0.5, string: 1, fret: 12, technique: 'down' },
                        { time: 0.666, string: 0, fret: 11, technique: 'down' },
                        { time: 0.833, string: 0, fret: 14, technique: 'pulloff' },
                        { time: 1, string: 1, fret: 15, technique: 'up' },
                        { time: 1.166, string: 2, fret: 16, technique: 'up' },
                        { time: 1.333, string: 3, fret: 17, technique: 'up' },
                        { time: 1.5, string: 4, fret: 15, technique: 'up' }
                    ],
                    fingering: [1, 3, 2, 1, 1, 4, 1, 2, 3, 1],
                    position: 11
                },
                {
                    id: 'sweep-cascade-6string',
                    name: '6-String Arpeggio Cascade (Gambale)',
                    genre: 'jazz',
                    technique: 'sweep',
                    difficulty: 'expert',
                    bpm: 100,
                    description: 'Cascada completa de 6 cuerdas con economy picking.',
                    key: 'Cmaj7',
                    tabs: [
                        { time: 0, string: 5, fret: 8, technique: 'down' },
                        { time: 0.125, string: 4, fret: 10, technique: 'down' },
                        { time: 0.25, string: 3, fret: 9, technique: 'down' },
                        { time: 0.375, string: 2, fret: 9, technique: 'down' },
                        { time: 0.5, string: 1, fret: 8, technique: 'down' },
                        { time: 0.625, string: 0, fret: 7, technique: 'down' },
                        { time: 0.75, string: 0, fret: 10, technique: 'hammeron' },
                        { time: 0.875, string: 1, fret: 12, technique: 'up' },
                        { time: 1, string: 2, fret: 12, technique: 'up' },
                        { time: 1.125, string: 3, fret: 12, technique: 'up' },
                        { time: 1.25, string: 4, fret: 14, technique: 'up' },
                        { time: 1.375, string: 5, fret: 12, technique: 'up' }
                    ],
                    fingering: [1, 3, 2, 2, 1, 1, 4, 4, 3, 3, 4, 2],
                    position: 7
                },

                // TAPPING
                {
                    id: 'tap-vanhalen-basic',
                    name: 'Van Halen Basic Tapping',
                    genre: 'rock',
                    technique: 'tapping',
                    difficulty: 'easy',
                    bpm: 100,
                    description: 'Tapping básico estilo Eruption. Tap con índice derecho.',
                    key: 'Em',
                    tabs: [
                        { time: 0, string: 0, fret: 12, technique: 'tap' },
                        { time: 0.25, string: 0, fret: 8, technique: 'pulloff' },
                        { time: 0.5, string: 0, fret: 5, technique: 'pulloff' },
                        { time: 0.75, string: 0, fret: 12, technique: 'tap' },
                        { time: 1, string: 0, fret: 8, technique: 'pulloff' },
                        { time: 1.25, string: 0, fret: 5, technique: 'pulloff' },
                        { time: 1.5, string: 1, fret: 12, technique: 'tap' },
                        { time: 1.75, string: 1, fret: 8, technique: 'pulloff' },
                        { time: 2, string: 1, fret: 5, technique: 'pulloff' }
                    ],
                    fingering: [0, 2, 1, 0, 2, 1, 0, 2, 1],
                    position: 5
                },
                {
                    id: 'tap-petrucci-8finger',
                    name: 'Petrucci 8-Finger Tapping',
                    genre: 'metal',
                    technique: 'tapping',
                    difficulty: 'hard',
                    bpm: 80,
                    description: '8-finger tapping estilo Dream Theater usando ambas manos.',
                    key: 'Em',
                    tabs: [
                        { time: 0, string: 0, fret: 5, technique: 'hammer' },
                        { time: 0.125, string: 0, fret: 8, technique: 'hammer' },
                        { time: 0.25, string: 0, fret: 12, technique: 'tap' },
                        { time: 0.375, string: 0, fret: 15, technique: 'tap' },
                        { time: 0.5, string: 1, fret: 5, technique: 'hammer' },
                        { time: 0.625, string: 1, fret: 8, technique: 'hammer' },
                        { time: 0.75, string: 1, fret: 12, technique: 'tap' },
                        { time: 0.875, string: 1, fret: 15, technique: 'tap' },
                        { time: 1, string: 2, fret: 5, technique: 'hammer' },
                        { time: 1.125, string: 2, fret: 9, technique: 'hammer' },
                        { time: 1.25, string: 2, fret: 12, technique: 'tap' },
                        { time: 1.375, string: 2, fret: 16, technique: 'tap' }
                    ],
                    fingering: [1, 2, 0, 0, 1, 2, 0, 0, 1, 3, 0, 0],
                    position: 5
                },
                {
                    id: 'tap-tosin-thumb',
                    name: 'Tosin Abasi Thumb Tapping',
                    genre: 'progressive',
                    technique: 'tapping',
                    difficulty: 'expert',
                    bpm: 90,
                    description: 'Tapping con pulgar estilo Animals as Leaders.',
                    key: 'Cmaj7',
                    tabs: [
                        { time: 0, string: 2, fret: 9, technique: 'thumb' },
                        { time: 0.25, string: 1, fret: 8, technique: 'pluck' },
                        { time: 0.5, string: 0, fret: 7, technique: 'pluck' },
                        { time: 0.75, string: 2, fret: 12, technique: 'thumb' },
                        { time: 1, string: 1, fret: 12, technique: 'pluck' },
                        { time: 1.25, string: 0, fret: 12, technique: 'pluck' },
                        { time: 1.5, string: 2, fret: 14, technique: 'thumb' },
                        { time: 1.75, string: 1, fret: 13, technique: 'pluck' }
                    ],
                    fingering: [2, 1, 1, 3, 2, 2, 4, 3],
                    position: 7
                },

                // ALTERNATE PICKING
                {
                    id: 'alt-gilbert-spider',
                    name: 'Chromatic Spider (Paul Gilbert)',
                    genre: 'rock',
                    technique: 'alternate',
                    difficulty: 'medium',
                    bpm: 80,
                    description: 'Ejercicio cromático para sincronización mano izquierda/derecha.',
                    key: 'Chromatic',
                    tabs: [
                        { time: 0, string: 5, fret: 5, technique: 'down' },
                        { time: 0.125, string: 5, fret: 6, technique: 'up' },
                        { time: 0.25, string: 5, fret: 7, technique: 'down' },
                        { time: 0.375, string: 5, fret: 8, technique: 'up' },
                        { time: 0.5, string: 4, fret: 5, technique: 'down' },
                        { time: 0.625, string: 4, fret: 6, technique: 'up' },
                        { time: 0.75, string: 4, fret: 7, technique: 'down' },
                        { time: 0.875, string: 4, fret: 8, technique: 'up' },
                        { time: 1, string: 3, fret: 5, technique: 'down' },
                        { time: 1.125, string: 3, fret: 6, technique: 'up' },
                        { time: 1.25, string: 3, fret: 7, technique: 'down' },
                        { time: 1.375, string: 3, fret: 8, technique: 'up' }
                    ],
                    fingering: [1, 2, 3, 4, 1, 2, 3, 4, 1, 2, 3, 4],
                    position: 5
                },
                {
                    id: 'alt-outside-picking',
                    name: 'Outside Picking Pattern (Troy Grady)',
                    genre: 'rock',
                    technique: 'alternate',
                    difficulty: 'hard',
                    bpm: 100,
                    description: 'Outside picking para string skipping eficiente.',
                    key: 'Em',
                    tabs: [
                        { time: 0, string: 0, fret: 12, technique: 'down' },
                        { time: 0.125, string: 2, fret: 12, technique: 'up' },
                        { time: 0.25, string: 0, fret: 15, technique: 'down' },
                        { time: 0.375, string: 2, fret: 14, technique: 'up' },
                        { time: 0.5, string: 0, fret: 12, technique: 'down' },
                        { time: 0.625, string: 2, fret: 12, technique: 'up' },
                        { time: 0.75, string: 1, fret: 13, technique: 'down' },
                        { time: 0.875, string: 3, fret: 14, technique: 'up' }
                    ],
                    fingering: [1, 1, 4, 3, 1, 1, 2, 3],
                    position: 12
                },
                {
                    id: 'alt-string-skipping',
                    name: 'String Skipping Run (Eric Johnson)',
                    genre: 'rock',
                    technique: 'alternate',
                    difficulty: 'hard',
                    bpm: 90,
                    description: 'Saltos de cuerda con alternate picking preciso.',
                    key: 'A',
                    tabs: [
                        { time: 0, string: 5, fret: 5, technique: 'down' },
                        { time: 0.166, string: 3, fret: 6, technique: 'up' },
                        { time: 0.333, string: 5, fret: 7, technique: 'down' },
                        { time: 0.5, string: 3, fret: 7, technique: 'up' },
                        { time: 0.666, string: 5, fret: 9, technique: 'down' },
                        { time: 0.833, string: 3, fret: 9, technique: 'up' },
                        { time: 1, string: 4, fret: 7, technique: 'down' },
                        { time: 1.166, string: 2, fret: 6, technique: 'up' }
                    ],
                    fingering: [1, 2, 3, 3, 4, 4, 3, 1],
                    position: 5
                },

                // LEGATO
                {
                    id: 'legato-govan-run',
                    name: 'Guthrie Govan Legato Run',
                    genre: 'fusion',
                    technique: 'legato',
                    difficulty: 'hard',
                    bpm: 70,
                    description: 'Legato fluido de 3 notas por cuerda estilo Govan.',
                    key: 'G',
                    tabs: [
                        { time: 0, string: 2, fret: 12, technique: 'hammer' },
                        { time: 0.166, string: 2, fret: 14, technique: 'hammer' },
                        { time: 0.333, string: 2, fret: 15, technique: 'hammer' },
                        { time: 0.5, string: 1, fret: 12, technique: 'hammer' },
                        { time: 0.666, string: 1, fret: 13, technique: 'hammer' },
                        { time: 0.833, string: 1, fret: 15, technique: 'hammer' },
                        { time: 1, string: 0, fret: 12, technique: 'hammer' },
                        { time: 1.166, string: 0, fret: 14, technique: 'hammer' },
                        { time: 1.333, string: 0, fret: 15, technique: 'hammer' }
                    ],
                    fingering: [1, 3, 4, 1, 2, 4, 1, 3, 4],
                    position: 12
                },
                {
                    id: 'legato-holdsworth-intervals',
                    name: 'Allan Holdsworth Intervallic Legato',
                    genre: 'fusion',
                    technique: 'legato',
                    difficulty: 'expert',
                    bpm: 60,
                    description: 'Legato con intervalos amplios estilo Holdsworth.',
                    key: 'C',
                    tabs: [
                        { time: 0, string: 2, fret: 5, technique: 'hammer' },
                        { time: 0.25, string: 2, fret: 9, technique: 'hammer' },
                        { time: 0.5, string: 1, fret: 6, technique: 'pulloff' },
                        { time: 0.75, string: 2, fret: 10, technique: 'hammer' },
                        { time: 1, string: 1, fret: 8, technique: 'pulloff' },
                        { time: 1.25, string: 0, fret: 7, technique: 'hammer' },
                        { time: 1.5, string: 0, fret: 12, technique: 'hammer' }
                    ],
                    fingering: [1, 4, 1, 4, 2, 1, 4],
                    position: 5
                },
                {
                    id: 'legato-plini-melodic',
                    name: 'Plini Melodic Legato',
                    genre: 'progressive',
                    technique: 'legato',
                    difficulty: 'medium',
                    bpm: 80,
                    description: 'Legato melódico moderno con sound lydian.',
                    key: 'F Lydian',
                    tabs: [
                        { time: 0, string: 1, fret: 13, technique: 'hammer' },
                        { time: 0.25, string: 1, fret: 15, technique: 'hammer' },
                        { time: 0.5, string: 0, fret: 12, technique: 'pulloff' },
                        { time: 0.75, string: 0, fret: 13, technique: 'hammer' },
                        { time: 1, string: 0, fret: 15, technique: 'hammer' },
                        { time: 1.25, string: 1, fret: 17, technique: 'bend' },
                        { time: 1.75, string: 1, fret: 17, technique: 'release' }
                    ],
                    fingering: [1, 3, 1, 2, 4, 4, 4],
                    position: 12
                },

                // METAL RIFFS
                {
                    id: 'metal-meshuggah-poly',
                    name: 'Meshuggah Polyrhythmic Riff',
                    genre: 'metal',
                    technique: 'rhythm',
                    difficulty: 'hard',
                    bpm: 120,
                    description: 'Riff polirítmico con palm muting. Enfócate en la sincronización.',
                    key: 'Eb',
                    tabs: [
                        { time: 0, string: 5, fret: 0, technique: 'palm' },
                        { time: 0.166, string: 5, fret: 0, technique: 'palm' },
                        { time: 0.333, string: 5, fret: 0, technique: 'palm' },
                        { time: 0.5, string: 5, fret: 3, technique: 'palm' },
                        { time: 0.75, string: 5, fret: 0, technique: 'palm' },
                        { time: 0.916, string: 5, fret: 0, technique: 'palm' },
                        { time: 1.083, string: 5, fret: 0, technique: 'palm' },
                        { time: 1.25, string: 5, fret: 1, technique: 'palm' }
                    ],
                    fingering: [0, 0, 0, 3, 0, 0, 0, 1],
                    position: 0
                },
                {
                    id: 'metal-periphery-djent',
                    name: 'Periphery Djent Pattern',
                    genre: 'metal',
                    technique: 'rhythm',
                    difficulty: 'hard',
                    bpm: 140,
                    description: 'Pattern djent moderno en Drop C con muting preciso.',
                    key: 'Drop C',
                    tabs: [
                        { time: 0, string: 5, fret: 0, technique: 'palm' },
                        { time: 0.125, string: 4, fret: 2, technique: 'chord' },
                        { time: 0.25, string: 5, fret: 0, technique: 'palm' },
                        { time: 0.375, string: 5, fret: 0, technique: 'palm' },
                        { time: 0.5, string: 4, fret: 4, technique: 'chord' },
                        { time: 0.75, string: 5, fret: 0, technique: 'palm' },
                        { time: 0.875, string: 4, fret: 2, technique: 'chord' }
                    ],
                    fingering: [0, 1, 0, 0, 3, 0, 1],
                    position: 0
                }
            ],

            // NEW: Suggest next chords based on emotion and harmonic context
            // ===== TRANSPOSITION SYSTEM =====

            // Transpose a voicing from one root to another
            transposeVoicing(voicing, fromRoot, toRoot) {
                if (!voicing || !voicing.frets) {
                    console.error('Invalid voicing for transposition:', voicing);
                    return null;
                }

                // Calculate chromatic offset
                const fromIndex = typeof fromRoot === 'number' ? fromRoot : this.getNoteIndex(fromRoot);
                const toIndex = typeof toRoot === 'number' ? toRoot : this.getNoteIndex(toRoot);
                const offset = (toIndex - fromIndex + 12) % 12;

                if (offset === 0) {
                    return voicing; // No transposition needed
                }

                // Transpose each fret
                const transposedFrets = voicing.frets.map(fret => {
                    if (fret === -1) return -1; // Muted string stays muted
                    if (fret === 0 && !voicing.movable) {
                        // Open string in non-movable voicing: cannot transpose
                        return fret + offset;
                    }
                    return fret + offset;
                });

                // Create transposed voicing with preserved metadata (FASE 2)
                const transposed = {
                    ...voicing,
                    frets: transposedFrets,
                    baseFret: voicing.baseFret + offset,
                    transposed: true,
                    originalRoot: fromRoot,
                    newRoot: toRoot,
                    source: 'transposed',
                    // NUEVO: Preservar metadata crítica
                    extensions: voicing.extensions || [],
                    emotionalTags: voicing.emotionalTags || [],
                    brightness: voicing.brightness,
                    tension: voicing.tension,
                    register: voicing.register
                };

                return transposed;
            },

            // Get a voicing for a specific chord and quality, with transposition support
            getVoicingForChord(targetRoot, quality) {
                // Try to find a voicing in the target key first
                const targetRootName = typeof targetRoot === 'number' ? this.getNoteName(targetRoot) : targetRoot;

                // Direct lookup attempts (expanded for extensions)
                const directKeys = [
                    `${targetRootName}_shape_${quality}`,
                    `${targetRootName}_shape_dom${quality}`,  // For dom9, dom13
                    `${targetRootName}_shape_maj${quality}`,  // For maj9, maj13
                    `${targetRootName}_shape_m${quality}`,    // For m9, m11
                    `${targetRootName}${quality}`,
                    `${targetRootName}m_shape`,               // For Dm_shape, Em_shape, etc.
                    `${targetRootName}_shape_major`,
                    `${targetRootName}_shape_minor`,          // For quality='minor'
                    `${targetRootName}_shape_maj7`,
                    `${targetRootName}maj7`,
                    `${targetRootName}7`,
                    `${targetRootName}m7`,
                    `${targetRootName}add9`,
                    `${targetRootName}sus2`,
                    `${targetRootName}sus4`
                ];

                for (const key of directKeys) {
                    if (this.chordLabVoicings[key]) {
                        return { key, voicing: this.chordLabVoicings[key], transposed: false };
                    }
                }

                // If not found, find a movable voicing and transpose it
                // FASE 2: Mapeo expandido con nuevos voicings de extensiones
                const qualityVoicings = {
                    'maj': ['C_shape_major', 'A_shape_major', 'E_shape_major_barre', 'G_shape_major'],
                    'min': ['Am_shape', 'Em_shape', 'E_shape_minor_barre'],
                    '7': ['G_shape_dom7', 'C_shape_dom7', 'A_shape_dom7', 'E_shape_dom7'],
                    'maj7': ['C_shape_maj7', 'A_shape_maj7', 'E_shape_maj7'],
                    'm7': ['A_shape_m7', 'C_shape_m7', 'E_shape_m7'],
                    // NUEVOS: Extensiones 9
                    '9': ['E_shape_dom9', 'A_shape_dom9', 'G_shape_dom9', 'C9'],
                    'maj9': ['E_shape_maj9', 'A_shape_maj9', 'C_shape_maj9', 'Cmaj9'],
                    'm9': ['E_shape_m9', 'A_shape_m9', 'Em_shape_m9'],
                    // NUEVOS: Extensiones 13
                    '13': ['E_shape_dom13', 'A_shape_dom13', 'G_shape_dom13'],
                    'maj13': ['E_shape_maj13', 'A_shape_maj13', 'C_shape_maj13'],
                    // NUEVOS: Extensiones 11
                    'm11': ['E_shape_m11', 'A_shape_m11', 'Em_shape_m11'],
                    // Existentes
                    'sus2': ['Csus2', 'Asus2'],
                    'sus4': ['Csus4', 'Asus4'],
                    'add9': ['Cadd9', 'Amadd9'],
                    '6': ['C6', 'Am6'],
                    'dim7': ['Cdim7', 'Bdim7'],
                    'aug': ['Caug', 'Eaug']
                };

                const voicingKeys = qualityVoicings[quality] || qualityVoicings['maj'];

                for (const key of voicingKeys) {
                    const baseVoicing = this.chordLabVoicings[key];
                    if (baseVoicing && baseVoicing.movable) {
                        // Extract base root from key (e.g., "C" from "C_shape_major")
                        let baseRoot = key.charAt(0);
                        if (key.charAt(1) === '#' || key.charAt(1) === 'b') {
                            baseRoot += key.charAt(1);
                        }

                        const transposed = this.transposeVoicing(baseVoicing, baseRoot, targetRootName);
                        if (transposed) {
                            return { key: `${key}_transposed_to_${targetRootName}`, voicing: transposed, transposed: true };
                        }
                    }
                }

                // Fallback: return first voicing for quality
                const fallbackKey = voicingKeys[0];
                return {
                    key: fallbackKey,
                    voicing: this.chordLabVoicings[fallbackKey] || this.chordLabVoicings['C_shape_major'],
                    transposed: false
                };
            },

            // Transpose an entire progression
            transposeProgression(progression, fromKey, toKey) {
                if (!progression || progression.length === 0) return [];

                const fromIndex = typeof fromKey === 'number' ? fromKey : this.getNoteIndex(fromKey);
                const toIndex = typeof toKey === 'number' ? toKey : this.getNoteIndex(toKey);

                return progression.map(chordData => {
                    // Support both 'chord' and 'root' field names
                    const chordRoot = chordData.chord || chordData.root;
                    const originalRoot = typeof chordRoot === 'number' ? chordRoot : this.getNoteIndex(chordRoot);
                    const newRoot = (originalRoot + (toIndex - fromIndex) + 12) % 12;
                    const newRootName = this.getNoteName(newRoot);

                    const transposedVoicing = chordData.voicing ?
                        this.transposeVoicing(chordData.voicing, originalRoot, newRoot) :
                        null;

                    return {
                        ...chordData,
                        chord: newRootName,
                        root: newRootName,
                        voicing: transposedVoicing
                    };
                });
            },

            // ===== HARMONIC SUGGESTION ENGINE =====

            // Get chord function in a key (I, ii, V, etc.)
            getChordFunction(chordRoot, key, quality = 'maj') {
                const keyIndex = typeof key === 'number' ? key : this.getNoteIndex(key);
                const chordIndex = typeof chordRoot === 'number' ? chordRoot : this.getNoteIndex(chordRoot);

                const interval = (chordIndex - keyIndex + 12) % 12;

                // Map intervals to functions
                const functionMap = {
                    0: 'I',    // Tonic
                    2: 'ii',   // Supertonic
                    4: 'iii',  // Mediant
                    5: 'IV',   // Subdominant
                    7: 'V',    // Dominant
                    9: 'vi',   // Submediant
                    11: 'vii°' // Leading tone
                };

                // Special cases for borrowed chords
                const borrowedMap = {
                    3: 'bIII',  // Borrowed from parallel minor
                    6: 'bV',    // Neapolitan
                    8: 'bVI',   // Borrowed
                    10: 'bVII'  // Subtonic
                };

                return functionMap[interval] || borrowedMap[interval] || 'altered';
            },

            // Calculate compatibility between two chords
            calculateCompatibility(currentChord, nextFunction, key) {
                const currentFunction = this.getChordFunction(currentChord.root || currentChord, key, currentChord.quality);

                // Transition probability matrix (based on functional harmony)
                const transitions = {
                    'I': { 'I': 70, 'ii': 85, 'iii': 70, 'IV': 90, 'V': 85, 'vi': 90, 'vii°': 60 },
                    'ii': { 'I': 60, 'ii': 40, 'iii': 50, 'IV': 70, 'V': 95, 'vi': 60, 'vii°': 70 },
                    'iii': { 'I': 50, 'ii': 70, 'iii': 40, 'IV': 75, 'V': 60, 'vi': 85, 'vii°': 50 },
                    'IV': { 'I': 80, 'ii': 75, 'iii': 50, 'IV': 60, 'V': 90, 'vi': 70, 'vii°': 75 },
                    'V': { 'I': 100, 'ii': 40, 'iii': 50, 'IV': 65, 'V': 50, 'vi': 80, 'vii°': 40 },
                    'vi': { 'I': 70, 'ii': 85, 'iii': 75, 'IV': 85, 'V': 75, 'vi': 50, 'vii°': 60 },
                    'vii°': { 'I': 95, 'ii': 50, 'iii': 65, 'IV': 50, 'V': 60, 'vi': 70, 'vii°': 30 }
                };

                const score = (transitions[currentFunction] && transitions[currentFunction][nextFunction]) || 50;

                // Categorize
                if (score >= 85) return { score, category: 'excellent', color: '#10b981' };
                if (score >= 70) return { score, category: 'good', color: '#f59e0b' };
                if (score >= 50) return { score, category: 'interesting', color: '#3b82f6' };
                return { score, category: 'unexpected', color: '#ef4444' };
            },

            // Suggest next chords based on current chord and context
            suggestNextChords(currentChord, key, context = {}) {
                const keyIndex = typeof key === 'number' ? key : this.getNoteIndex(key);
                const currentRoot = typeof currentChord === 'object' ? currentChord.root : currentChord;
                const currentQuality = typeof currentChord === 'object' ? currentChord.quality : 'maj';
                const currentFunction = this.getChordFunction(currentRoot, key, currentQuality);

                // Define probable transitions based on function
                const transitionRules = {
                    'I': ['ii', 'iii', 'IV', 'V', 'vi'],
                    'ii': ['V', 'vii°', 'IV'],
                    'iii': ['vi', 'IV', 'ii'],
                    'IV': ['I', 'V', 'ii', 'vii°'],
                    'V': ['I', 'vi', 'IV'],
                    'vi': ['ii', 'IV', 'V', 'I'],
                    'vii°': ['I', 'iii']
                };

                let suggestedFunctions = transitionRules[currentFunction] || ['I', 'IV', 'V'];

                // Apply emotional filter if provided
                if (context.emotion) {
                    suggestedFunctions = this.filterByEmotion(suggestedFunctions, context.emotion);
                }

                // Convert functions to actual chords
                const functionToInterval = {
                    'I': 0, 'ii': 2, 'iii': 4, 'IV': 5,
                    'V': 7, 'vi': 9, 'vii°': 11,
                    'bIII': 3, 'bVI': 8, 'bVII': 10
                };

                const functionToQuality = {
                    'I': 'maj', 'ii': 'min', 'iii': 'min', 'IV': 'maj',
                    'V': '7', 'vi': 'min', 'vii°': 'dim',
                    'bIII': 'maj', 'bVI': 'maj', 'bVII': 'maj'
                };

                // FASE 3: Sistema Emocional Expandido
                // Layer 2: Emociones por calidad de acorde
                const qualityEmotions = {
                    'maj':   ['pure', 'clear', 'stable'],
                    'maj7':  ['dreamy', 'sophisticated', 'lush'],
                    'maj9':  ['modern', 'spacious', 'colorful'],
                    'maj13': ['complex', 'luxurious', 'jazzy'],
                    '6':     ['nostalgic', 'sweet', 'vintage'],
                    'add9':  ['bright', 'contemporary'],
                    '7':     ['bluesy', 'dominant', 'driving'],
                    '9':     ['funky', 'sophisticated', 'rich'],
                    '13':    ['jazzy', 'complex', 'colorful'],
                    'min':   ['dark', 'sad', 'simple'],
                    'm7':    ['smooth', 'mellow', 'jazzy'],
                    'm9':    ['lush', 'sophisticated', 'ambient'],
                    'm11':   ['spacious', 'modal', 'floating'],
                    'dim':   ['unstable', 'dissonant', 'transitional'],
                    'aug':   ['surreal', 'ambiguous', 'dreamlike'],
                    'sus2':  ['open', 'bright', 'ethereal'],
                    'sus4':  ['suspended', 'anticipation', 'floating']
                };

                // Layer 3: Descripciones contextuales específicas
                const contextualDescriptions = {
                    'V_7_to_I':    'Resolución clásica V7→I - la cadencia más fuerte',
                    'V_9_to_I':    'Resolución rica V9→I - color añadido por la 9na',
                    'V_13_to_I':   'Resolución completa V13→I - máximo color (9na + 13va)',
                    'ii_m7_to_V':  'Preparación ii-V clásica - progresión jazz fundamental',
                    'ii_m9_to_V':  'Preparación ii9-V sofisticada - color moderno añadido',
                    'I_maj7_to_vi': 'Tónica sofisticada a relativo menor - elegante',
                    'I_maj9_to_vi': 'Tónica moderna a relativo menor - espaciosa',
                    'vi_m9_to_ii': 'Círculo de quintas rico - movimiento fluido con extensiones',
                    'IV_maj9_to_I': 'Resolución plagal moderna - "Amén" sofisticado',
                    'V_sus4_to_I': 'Suspensión resuelta - tensión y liberación',
                    'I_6_to_vi':   'Movimiento vintage - sonido nostálgico años 50',
                    'ii_to_V_7':   'Setup clásico ii-V7 - preparación fundamental',
                    'ii_to_V_9':   'Setup sofisticado ii-V9 - color añadido',
                    'ii_to_V_13':  'Setup complejo ii-V13 - máxima sofisticación jazz'
                };

                // Quality variations for more sophisticated suggestions
                const qualityVariations = {
                    'I': ['maj', 'maj7', 'maj9', '6', 'add9'],
                    'ii': ['min', 'm7', 'm9'],
                    'iii': ['min', 'm7'],
                    'IV': ['maj', 'maj7', 'maj9', '6', 'add9'],
                    'V': ['7', '9', '13', 'sus4'],
                    'vi': ['min', 'm7', 'm9'],
                    'vii°': ['dim', 'm7b5'],
                    'bIII': ['maj', 'maj7'],
                    'bVI': ['maj', 'maj7'],
                    'bVII': ['maj', '7']
                };

                const suggestions = [];

                suggestedFunctions.forEach(func => {
                    const interval = functionToInterval[func];
                    const chordRoot = (keyIndex + interval) % 12;
                    const chordRootName = this.getNoteName(chordRoot);

                    // Get base quality
                    const baseQuality = functionToQuality[func];

                    // Get compatibility score
                    const compatibility = this.calculateCompatibility(currentRoot, func, key);

                    // Add base quality suggestion
                    const voicingResult = this.getVoicingForChord(chordRootName, baseQuality);

                    let voiceLeading = null;
                    if (currentChord.voicing && voicingResult.voicing) {
                        voiceLeading = this.calculateVoiceLeading(currentChord.voicing, voicingResult.voicing);
                    }

                    // Generar tags emocionales combinados
                    const emotionalTags = this.generateEmotionalTags(func, baseQuality, voicingResult.voicing);

                    suggestions.push({
                        chord: chordRootName,
                        quality: baseQuality,
                        function: func,
                        compatibility: compatibility,
                        voicing: voicingResult.voicing,
                        voicingKey: voicingResult.key,
                        voiceLeading: voiceLeading,
                        explanation: this.explainTransition(currentFunction, currentQuality, func, baseQuality, compatibility.category),
                        emotionalTags: emotionalTags
                    });

                    // Add quality variations (limit to top 3 functions to avoid too many suggestions)
                    if (suggestions.length < 10) {
                        const variations = qualityVariations[func] || [baseQuality];
                        variations.slice(1, 3).forEach(quality => {
                            const varVoicingResult = this.getVoicingForChord(chordRootName, quality);
                            const varEmotionalTags = this.generateEmotionalTags(func, quality, varVoicingResult.voicing);

                            suggestions.push({
                                chord: chordRootName,
                                quality: quality,
                                function: func,
                                compatibility: { ...compatibility, score: compatibility.score - 5 }, // Slightly lower score for variations
                                voicing: varVoicingResult.voicing,
                                voicingKey: varVoicingResult.key,
                                voiceLeading: null,
                                explanation: this.explainTransition(currentFunction, currentQuality, func, quality, compatibility.category),
                                emotionalTags: varEmotionalTags
                            });
                        });
                    }
                });

                // Sort by compatibility score (descending) and limit to top 12
                return suggestions.sort((a, b) => b.compatibility.score - a.compatibility.score).slice(0, 12);
            },

            // Filter suggestions by emotion
            filterByEmotion(functions, emotion) {
                const emotionMap = {
                    'happy': ['I', 'IV', 'V', 'vi'],
                    'sad': ['vi', 'ii', 'iii', 'bVI'],
                    'dark': ['vi', 'iii', 'vii°', 'bVI'],
                    'bright': ['I', 'IV', 'V'],
                    'tense': ['V', 'vii°', 'ii'],
                    'resolved': ['I', 'IV'],
                    'mysterious': ['iii', 'vi', 'bIII', 'bVI'],
                    'energetic': ['V', 'I', 'IV']
                };

                const preferred = emotionMap[emotion] || functions;
                return functions.filter(f => preferred.includes(f)).concat(
                    functions.filter(f => !preferred.includes(f))
                );
            },

            // Explain why a transition works
            // FASE 3: Sistema contextual expandido con cualidades
            explainTransition(fromFunction, fromQuality, toFunction, toQuality, category) {
                // Primero buscar descripción contextual específica con cualidades
                const contextKey = `${fromFunction}_${fromQuality}_to_${toFunction}`;

                // contextualDescriptions está definido en suggestNextChords, pero necesitamos acceso aquí
                const contextualDescriptions = {
                    'V_7_to_I':    'Resolución clásica V7→I - la cadencia más fuerte',
                    'V_9_to_I':    'Resolución rica V9→I - color añadido por la 9na',
                    'V_13_to_I':   'Resolución completa V13→I - máximo color (9na + 13va)',
                    'ii_m7_to_V':  'Preparación ii-V clásica - progresión jazz fundamental',
                    'ii_m9_to_V':  'Preparación ii9-V sofisticada - color moderno añadido',
                    'I_maj7_to_vi': 'Tónica sofisticada a relativo menor - elegante',
                    'I_maj9_to_vi': 'Tónica moderna a relativo menor - espaciosa',
                    'vi_m9_to_ii': 'Círculo de quintas rico - movimiento fluido con extensiones',
                    'IV_maj9_to_I': 'Resolución plagal moderna - "Amén" sofisticado',
                    'V_sus4_to_I': 'Suspensión resuelta - tensión y liberación',
                    'I_6_to_vi':   'Movimiento vintage - sonido nostálgico años 50',
                    'ii_to_V_7':   'Setup clásico ii-V7 - preparación fundamental',
                    'ii_to_V_9':   'Setup sofisticado ii-V9 - color añadido',
                    'ii_to_V_13':  'Setup complejo ii-V13 - máxima sofisticación jazz'
                };

                if (contextualDescriptions[contextKey]) {
                    return contextualDescriptions[contextKey];
                }

                // Fallback a explicaciones funcionales básicas
                const explanations = {
                    'I_IV': 'Progresión plagal clásica - movimiento suave y resolutivo',
                    'I_V': 'Tensión hacia dominante - genera expectativa de regreso',
                    'I_vi': 'Giro menor - añade melancolía sin perder estabilidad',
                    'I_ii': 'Preparación suave para dominante - muy común en jazz',
                    'ii_V': 'Cadencia ii-V - la progresión más fuerte en jazz',
                    'V_I': 'Resolución dominante-tónica - la más fuerte en música occidental',
                    'V_vi': 'Cadencia rota - sorpresa emotiva, evita resolución',
                    'IV_I': 'Cadencia plagal ("Amén") - resolución tranquila',
                    'IV_V': 'Preparación para resolución - genera momentum',
                    'vi_ii': 'Círculo de quintas descendente - movimiento fluido',
                    'vi_IV': 'Progresión pop moderna - vi-IV-I-V muy popular',
                    'iii_vi': 'Movimiento descendente menor - mantiene oscuridad'
                };

                const key = `${fromFunction}_${toFunction}`;
                const baseExplanation = explanations[key] || this.getGenericExplanation(category);

                // Añadir nota sobre la cualidad si es diferente del básico
                if (toQuality && toQuality !== 'maj' && toQuality !== 'min' && toQuality !== '7') {
                    return `${baseExplanation} (variación ${toQuality})`;
                }

                return baseExplanation;
            },

            // Generic explanation based on compatibility
            getGenericExplanation(category) {
                const generic = {
                    'excellent': 'Transición muy natural y fluida según teoría armónica clásica',
                    'good': 'Movimiento coherente que funciona bien en la mayoría de contextos',
                    'interesting': 'Progresión menos común pero interesante - añade color',
                    'unexpected': 'Cambio sorpresivo - úsalo para impacto dramático'
                };
                return generic[category] || 'Transición experimental';
            },

            // FASE 3: Generar tags emocionales combinados (función, cualidad, voicing)
            generateEmotionalTags(chordFunction, quality, voicing) {
                const tags = [];

                // Layer 1: Función armónica
                const functionalTags = {
                    'I': ['resolved', 'bright', 'stable'],
                    'ii': ['smooth', 'preparatory'],
                    'iii': ['ambiguous', 'mysterious'],
                    'IV': ['lifting', 'expansive'],
                    'V': ['tense', 'expectant'],
                    'vi': ['sad', 'introspective'],
                    'vii°': ['unstable', 'leading']
                };
                if (functionalTags[chordFunction]) {
                    tags.push(...functionalTags[chordFunction]);
                }

                // Layer 2: Cualidad del acorde
                const qualityEmotions = {
                    'maj':   ['pure', 'clear', 'stable'],
                    'maj7':  ['dreamy', 'sophisticated', 'lush'],
                    'maj9':  ['modern', 'spacious', 'colorful'],
                    'maj13': ['complex', 'luxurious', 'jazzy'],
                    '6':     ['nostalgic', 'sweet', 'vintage'],
                    'add9':  ['bright', 'contemporary'],
                    '7':     ['bluesy', 'dominant', 'driving'],
                    '9':     ['funky', 'sophisticated', 'rich'],
                    '13':    ['jazzy', 'complex', 'colorful'],
                    'min':   ['dark', 'sad', 'simple'],
                    'm7':    ['smooth', 'mellow', 'jazzy'],
                    'm9':    ['lush', 'sophisticated', 'ambient'],
                    'm11':   ['spacious', 'modal', 'floating'],
                    'dim':   ['unstable', 'dissonant', 'transitional'],
                    'aug':   ['surreal', 'ambiguous', 'dreamlike'],
                    'sus2':  ['open', 'bright', 'ethereal'],
                    'sus4':  ['suspended', 'anticipation', 'floating']
                };
                if (qualityEmotions[quality]) {
                    tags.push(...qualityEmotions[quality]);
                }

                // Layer 3: Metadata del voicing (si está disponible)
                if (voicing) {
                    if (voicing.register === 'high') {
                        tags.push('bright', 'cutting');
                    } else if (voicing.register === 'low') {
                        tags.push('warm', 'foundational');
                    }

                    // Layer 4: Extensiones
                    if (voicing.extensions) {
                        if (voicing.extensions.includes('9')) tags.push('colorful', 'modern');
                        if (voicing.extensions.includes('11')) tags.push('modal', 'suspended');
                        if (voicing.extensions.includes('13')) tags.push('jazzy', 'complex');
                    }

                    // Tags del voicing si existen
                    if (voicing.emotionalTags) {
                        tags.push(...voicing.emotionalTags);
                    }
                }

                // Remove duplicates and return top 5
                return [...new Set(tags)].slice(0, 5);
            },

            // Calculate voice leading between two voicings
            calculateVoiceLeading(voicingA, voicingB) {
                if (!voicingA || !voicingB || !voicingA.frets || !voicingB.frets) {
                    return null;
                }

                const openStringNotes = [4, 9, 2, 7, 11, 4]; // E A D G B E
                let totalMovement = 0;
                let commonTones = 0;
                let movingVoices = 0;

                // Compare each string
                for (let i = 0; i < 6; i++) {
                    const fretA = voicingA.frets[i];
                    const fretB = voicingB.frets[i];

                    // Skip muted strings
                    if (fretA === -1 || fretB === -1) continue;

                    const noteA = (openStringNotes[i] + fretA) % 12;
                    const noteB = (openStringNotes[i] + fretB) % 12;

                    if (noteA === noteB) {
                        commonTones++;
                    } else {
                        const semitones = Math.abs(noteA - noteB);
                        const movement = Math.min(semitones, 12 - semitones);
                        totalMovement += movement;
                        movingVoices++;
                    }
                }

                const smoothness = Math.max(0, 100 - (totalMovement * 8));
                let recommendation = 'excellent';
                if (totalMovement > 4) recommendation = 'good';
                if (totalMovement > 8) recommendation = 'moderate';
                if (totalMovement > 12) recommendation = 'challenging';

                return {
                    movement: totalMovement,
                    commonTones: commonTones,
                    movingVoices: movingVoices,
                    smoothness: smoothness,
                    recommendation: recommendation,
                    description: this.describeVoiceLeading(totalMovement, commonTones)
                };
            },

            // Describe voice leading quality
            describeVoiceLeading(movement, commonTones) {
                if (commonTones >= 2 && movement <= 3) {
                    return `Excelente: ${commonTones} notas comunes, movimiento mínimo`;
                }
                if (movement <= 5) {
                    return `Bueno: movimiento suave de ${movement} semitonos`;
                }
                if (movement <= 10) {
                    return `Moderado: movimiento de ${movement} semitonos, practicable`;
                }
                return `Desafiante: salto grande de ${movement} semitonos`;
            },

            // ===== CHORD IDENTIFICATION ENGINE =====

            identifyChordFromNotes(noteIndices) {
                if (noteIndices.length < 2) return null;

                // Get unique notes sorted
                const uniqueNotes = [...new Set(noteIndices)].sort((a, b) => a - b);

                // Try each note as potential root
                const interpretations = [];

                for (let rootIdx = 0; rootIdx < uniqueNotes.length; rootIdx++) {
                    const root = uniqueNotes[rootIdx];
                    const intervals = uniqueNotes.map(n => (n - root + 12) % 12).sort((a, b) => a - b);

                    // Match against known chord patterns
                    const quality = this.matchChordPattern(intervals);

                    if (quality) {
                        interpretations.push({
                            root: this.getNoteName(root),
                            rootIndex: root,
                            quality: quality,
                            intervals: intervals,
                            confidence: this.calculateChordConfidence(intervals, quality)
                        });
                    }
                }

                // Return best match
                if (interpretations.length === 0) return null;

                interpretations.sort((a, b) => b.confidence - a.confidence);
                return interpretations[0];
            },

            matchChordPattern(intervals) {
                // Chord patterns: intervals from root
                const patterns = {
                    // Triads
                    'maj': [0, 4, 7],
                    'min': [0, 3, 7],
                    'dim': [0, 3, 6],
                    'aug': [0, 4, 8],
                    'sus2': [0, 2, 7],
                    'sus4': [0, 5, 7],

                    // 7th chords
                    'maj7': [0, 4, 7, 11],
                    '7': [0, 4, 7, 10],
                    'm7': [0, 3, 7, 10],
                    'dim7': [0, 3, 6, 9],
                    'm7b5': [0, 3, 6, 10],

                    // Extensions
                    'add9': [0, 2, 4, 7],
                    '9': [0, 2, 4, 7, 10],
                    'maj9': [0, 2, 4, 7, 11],
                    'm9': [0, 2, 3, 7, 10],
                    '6': [0, 4, 7, 9],
                    'm6': [0, 3, 7, 9],

                    // Power chord
                    '5': [0, 7]
                };

                // Find best match
                let bestMatch = null;
                let bestScore = 0;

                for (const [quality, pattern] of Object.entries(patterns)) {
                    const score = this.matchPatternScore(intervals, pattern);
                    if (score > bestScore) {
                        bestScore = score;
                        bestMatch = quality;
                    }
                }

                // Require at least 60% match
                return bestScore >= 0.6 ? bestMatch : null;
            },

            matchPatternScore(intervals, pattern) {
                // Calculate how well intervals match pattern
                let matches = 0;
                let total = Math.max(intervals.length, pattern.length);

                for (const interval of pattern) {
                    if (intervals.includes(interval)) {
                        matches++;
                    }
                }

                // Bonus for exact match
                if (matches === pattern.length && intervals.length === pattern.length) {
                    return 1.0;
                }

                return matches / total;
            },

            calculateChordConfidence(intervals, quality) {
                // Higher confidence if:
                // 1. Root is present (0)
                // 2. Pattern matches well
                // 3. No unexpected intervals

                let confidence = 0.5;

                if (intervals[0] === 0) confidence += 0.3; // Root present

                const patterns = {
                    'maj': [0, 4, 7],
                    'min': [0, 3, 7],
                    '7': [0, 4, 7, 10],
                    'maj7': [0, 4, 7, 11]
                    // ... etc
                };

                const pattern = patterns[quality];
                if (pattern) {
                    const score = this.matchPatternScore(intervals, pattern);
                    confidence += score * 0.2;
                }

                return Math.min(confidence, 1.0);
            }
        };

        // ========================================
        // AUDIO ENGINE - Web Audio API
        // ========================================
        const AudioEngine = {
            audioContext: null,
            masterGain: null,
            enabled: true,
            sampleBuffers: {}, // Cache de buffers de samples

            init() {
                if (!this.audioContext) {
                    try {
                        const AudioContext = window.AudioContext || window.webkitAudioContext;
                        if (!AudioContext) {
                            throw new Error('Web Audio API no soportada en este navegador');
                        }
                        this.audioContext = new AudioContext();
                        this.masterGain = this.audioContext.createGain();
                        this.masterGain.gain.value = 0.3; // Volumen equilibrado
                        this.masterGain.connect(this.audioContext.destination);
                    } catch (e) {
                        console.error('Error inicializando audio:', e);
                        this.showAudioError(e.message);
                        this.enabled = false;
                    }
                }
            },

            showAudioError(message) {
                const existingBanner = document.querySelector('.audio-error-banner');
                if (existingBanner) return;

                const banner = document.createElement('div');
                banner.className = 'audio-error-banner';
                banner.style.cssText = 'position: fixed; top: 10px; left: 50%; transform: translateX(-50%); background: #ff5252; color: white; padding: 12px 24px; border-radius: 4px; z-index: 10000; box-shadow: 0 2px 8px rgba(0,0,0,0.2);';
                banner.textContent = '⚠️ Audio no disponible en este navegador';
                document.body.prepend(banner);

                setTimeout(() => {
                    banner.style.opacity = '0';
                    banner.style.transition = 'opacity 0.5s';
                    setTimeout(() => banner.remove(), 500);
                }, 5000);
            },

            // Karplus-Strong OPTIMIZADO - Balance entre calidad y performance
            createGuitarBuffer(frequency, duration) {
                const sampleRate = this.audioContext.sampleRate;
                const maxDuration = Math.min(duration, 1.5); // Reducido para mejor performance
                const bufferLength = Math.ceil(sampleRate * maxDuration);
                const buffer = this.audioContext.createBuffer(1, bufferLength, sampleRate);
                const data = buffer.getChannelData(0);

                // Calcular periodo
                const period = sampleRate / frequency;
                const delayLength = Math.floor(period);
                const tuningError = period - delayLength;

                if (delayLength < 10 || delayLength > sampleRate / 20) {
                    // Fuera de rango - usar fallback
                    return this.createFallbackBuffer(frequency, duration);
                }

                // === 1. EXCITACIÓN (Pluck) - Mezcla optimizada ===
                for (let i = 0; i < delayLength && i < bufferLength; i++) {
                    const t = i / delayLength;

                    // Forma triangular (púa)
                    const pluckShape = t < 0.5 ? t * 2 : 2 - (t * 2);

                    // Ruido muy reducido (5%)
                    const noise = (Math.random() * 2 - 1) * 0.05;

                    data[i] = (pluckShape + noise) * 0.9;
                }

                // === 2. PROPAGACIÓN SIMPLIFICADA ===
                // Damping adaptativo (graves duran más)
                const freqRatio = Math.min(frequency / 800, 1.0);
                const dampingFactor = 0.999 - (freqRatio * 0.0005);

                for (let i = delayLength; i < bufferLength; i++) {
                    // Karplus-Strong básico optimizado
                    const idx1 = i - delayLength;
                    const idx2 = i - delayLength - 1;

                    if (idx2 >= 0) {
                        // Promedio de dos muestras anteriores
                        data[i] = ((data[idx1] + data[idx2]) * 0.5) * dampingFactor;
                    } else {
                        data[i] = data[idx1] * dampingFactor;
                    }
                }

                // === 3. ENVELOPE + VIBRATO + FADE-OUT SUAVE ===
                const attackSamples = Math.ceil(sampleRate * 0.001);
                const decayFactor = 1.0 + (freqRatio * 0.3);
                const vibratoFreq = 5.0;
                const vibratoDepth = 0.002;

                // Fade-out en los últimos 50ms para eliminar clicks
                const fadeOutSamples = Math.ceil(sampleRate * 0.05);
                const fadeOutStart = bufferLength - fadeOutSamples;

                for (let i = 0; i < bufferLength; i++) {
                    const t = i / sampleRate;

                    // Envelope
                    let envelope;
                    if (i < attackSamples) {
                        envelope = i / attackSamples;
                    } else {
                        envelope = Math.exp(-t * decayFactor);
                    }

                    // Vibrato
                    const vibrato = Math.sin(2 * Math.PI * vibratoFreq * t) * vibratoDepth;

                    // Fade-out suave al final (elimina clicks/crunch)
                    let fadeOut = 1;
                    if (i > fadeOutStart) {
                        fadeOut = (bufferLength - i) / fadeOutSamples;
                        fadeOut = fadeOut * fadeOut; // Curva cuadrática suave
                    }

                    // Aplicar todo de una vez
                    data[i] *= envelope * (1 + vibrato) * fadeOut * 0.75;
                }

                return buffer;
            },

            // Buffer simple de fallback para frecuencias problemáticas
            createFallbackBuffer(frequency, duration) {
                const sampleRate = this.audioContext.sampleRate;
                const bufferLength = Math.ceil(sampleRate * duration);
                const buffer = this.audioContext.createBuffer(1, bufferLength, sampleRate);
                const data = buffer.getChannelData(0);

                for (let i = 0; i < bufferLength; i++) {
                    const t = i / sampleRate;
                    // Onda triangle simple con decay
                    const phase = (t * frequency) % 1;
                    const triangle = phase < 0.5 ? phase * 4 - 1 : 3 - phase * 4;
                    const envelope = Math.exp(-t * 1.5);
                    data[i] = triangle * envelope * 0.3;
                }

                return buffer;
            },

            // Convierte nota MIDI a frecuencia
            midiToFreq(midiNote) {
                return 440 * Math.pow(2, (midiNote - 69) / 12);
            },

            // Reproduce una nota usando síntesis física Karplus-Strong (optimizado para performance)
            playMidiNote(midiNote, duration = 0.7) {
                if (!this.enabled || !this.audioContext) return;

                if (this.audioContext.state === 'suspended') {
                    this.audioContext.resume();
                }

                const frequency = this.midiToFreq(midiNote);
                const now = this.audioContext.currentTime;

                try {
                    // Crear buffer de guitarra usando Karplus-Strong avanzado
                    const buffer = this.createGuitarBuffer(frequency, duration);

                    // BufferSource para reproducir el buffer
                    const source = this.audioContext.createBufferSource();
                    source.buffer = buffer;

                    // === CADENA OPTIMIZADA (3 filtros esenciales) ===

                    // 1. Simulación de Pastilla - Resonancia tipo single-coil
                    const pickupFilter = this.audioContext.createBiquadFilter();
                    pickupFilter.type = 'peaking';
                    pickupFilter.frequency.value = 2400;
                    pickupFilter.Q.value = 1.5;
                    pickupFilter.gain.value = 3;

                    // 2. Tono - Roll-off natural de agudos
                    const toneFilter = this.audioContext.createBiquadFilter();
                    toneFilter.type = 'lowpass';
                    toneFilter.frequency.value = 5500; // Brillante y claro
                    toneFilter.Q.value = 0.8;

                    // Ganancia suavizada con ramp para evitar clicks
                    const outputGain = this.audioContext.createGain();
                    const dynamicGain = 0.8 - ((frequency - 200) / 12000);
                    const finalGain = Math.max(0.6, Math.min(0.85, dynamicGain));

                    // Fade-in muy corto para eliminar click inicial
                    outputGain.gain.setValueAtTime(0, now);
                    outputGain.gain.linearRampToValueAtTime(finalGain, now + 0.002);

                    // === CADENA ULTRA-EFICIENTE (3 nodos) ===
                    source.connect(pickupFilter);
                    pickupFilter.connect(toneFilter);
                    toneFilter.connect(outputGain);
                    outputGain.connect(this.masterGain);

                    // Reproducir
                    source.start(now);

                } catch (error) {
                    console.error('Error al reproducir nota:', error);
                    this.playSimpleNote(frequency, duration, now);
                }
            },

            // Fallback simple por si hay problemas
            playSimpleNote(frequency, duration, startTime) {
                const osc = this.audioContext.createOscillator();
                const gain = this.audioContext.createGain();

                osc.type = 'triangle';
                osc.frequency.value = frequency;

                gain.gain.setValueAtTime(0, startTime);
                gain.gain.linearRampToValueAtTime(0.3, startTime + 0.01);
                gain.gain.exponentialRampToValueAtTime(0.001, startTime + duration);

                osc.connect(gain);
                gain.connect(this.masterGain);

                osc.start(startTime);
                osc.stop(startTime + duration);
            },

            // Reproduce una nota individual (wrapper con octava)
            playNote(noteIndex, duration = 0.5, octave = 4) {
                const midiNote = 12 * (octave + 1) + noteIndex; // C4 = 60
                this.playMidiNote(midiNote, duration);
            },

            // Reproduce un intervalo (dos notas) - MEJORADO para Ear Training
            playInterval(rootNote, semitones, duration = 0.6, octave = 4) {
                if (!this.enabled || !this.audioContext) return;

                const rootMidi = 12 * (octave + 1) + rootNote;
                const targetMidi = rootMidi + semitones;

                this.playMidiNote(rootMidi, duration);

                setTimeout(() => {
                    this.playMidiNote(targetMidi, duration);
                }, duration * 1000 + 100);
            },

            // Reproduce un acorde (notas simultáneas con efecto strum)
            playChord(notes, duration = 1.1) {
                if (!this.enabled || !this.audioContext) return;

                if (this.audioContext.state === 'suspended') {
                    this.audioContext.resume();
                }

                // Limitar acordes a máximo 4 notas para reducir carga
                const maxNotes = Math.min(notes.length, 4);
                const notesToPlay = notes.slice(0, maxNotes);

                // Strum natural (35ms entre cuerdas) - duración mayor para fade-out completo
                notesToPlay.forEach((noteIndex, i) => {
                    setTimeout(() => {
                        this.playNote(noteIndex % 12, duration * 0.85, 3 + Math.floor(i / 2));
                    }, i * 35);
                });
            },

            // Reproduce una escala ascendente
            playScale(notes, tempo = 200) {
                if (!this.enabled) return;
                notes.forEach((noteObj, i) => {
                    setTimeout(() => {
                        const noteIndex = MusicTheory.getNoteIndex(noteObj.note);
                        this.playNote(noteIndex, 0.3, 4);
                    }, i * tempo);
                });
            },

            // NUEVO: Secuenciador de acordes para Jam Session
            playChordSequence(chordProgression, bpm, rootKey) {
                if (!this.enabled || !this.audioContext) return null;

                const beatDuration = (60 / bpm) * 1000 * 4; // 4 beats por acorde
                let currentBar = 0;

                const intervalId = setInterval(() => {
                    const symbol = chordProgression[currentBar % chordProgression.length];
                    const chordNotes = this.parseChordSymbol(symbol, rootKey);

                    if (chordNotes && chordNotes.length > 0) {
                        this.playChord(chordNotes, 1.5);
                    }

                    currentBar++;
                }, beatDuration);

                return intervalId;
            },

            // NUEVO: Convierte símbolos de acordes (I, V, vi, etc.) a notas MIDI
            parseChordSymbol(symbol, rootKey) {
                const degreeMap = {
                    'I': 0, 'i': 0,
                    'II': 2, 'ii': 2,
                    'III': 4, 'iii': 4,
                    'IV': 5, 'iv': 5,
                    'V': 7, 'v': 7,
                    'VI': 9, 'vi': 9,
                    'VII': 11, 'vii': 11,
                    'bII': 1, 'biii': 3, 'bVI': 8, 'bVII': 10, 'bIII': 3
                };

                // Detectar si es mayor o menor
                const isMinor = symbol.match(/^[ivx]+/) !== null && symbol !== symbol.toUpperCase().replace('b', '');
                const isSeventhChord = symbol.includes('7');

                // Extraer grado romano
                let romanPart = symbol.replace('7', '');
                const degree = degreeMap[romanPart];

                if (degree === undefined) return [];

                const root = (rootKey + degree) % 12;

                // Construir tríada
                const third = isMinor ? 3 : 4;
                const notes = [
                    root,
                    (root + third) % 12,
                    (root + 7) % 12
                ];

                // Añadir 7ª si es acorde de séptima
                if (isSeventhChord) {
                    const seventh = isMinor ? 10 : 10; // 7ª menor para ambos
                    notes.push((root + seventh) % 12);
                }

                return notes;
            },

            // NUEVO: Detener secuenciador
            stopSequence(intervalId) {
                if (intervalId) {
                    clearInterval(intervalId);
                }
            },

            // NUEVO: Sonido de batería simple usando ruido y filtros
            playDrumSound(type) {
                if (!this.enabled || !this.audioContext) return;

                const now = this.audioContext.currentTime;

                if (type === 'kick') {
                    // Bombo: oscilador de baja frecuencia
                    const osc = this.audioContext.createOscillator();
                    const gain = this.audioContext.createGain();

                    osc.frequency.setValueAtTime(150, now);
                    osc.frequency.exponentialRampToValueAtTime(0.01, now + 0.3);

                    gain.gain.setValueAtTime(1, now);
                    gain.gain.exponentialRampToValueAtTime(0.001, now + 0.3);

                    osc.connect(gain);
                    gain.connect(this.masterGain);

                    osc.start(now);
                    osc.stop(now + 0.3);
                }
                else if (type === 'snare') {
                    // Tarola: ruido blanco con filtro
                    const bufferSize = this.audioContext.sampleRate * 0.1;
                    const buffer = this.audioContext.createBuffer(1, bufferSize, this.audioContext.sampleRate);
                    const data = buffer.getChannelData(0);

                    for (let i = 0; i < bufferSize; i++) {
                        data[i] = Math.random() * 2 - 1;
                    }

                    const noise = this.audioContext.createBufferSource();
                    noise.buffer = buffer;

                    const filter = this.audioContext.createBiquadFilter();
                    filter.type = 'highpass';
                    filter.frequency.value = 1000;

                    const gain = this.audioContext.createGain();
                    gain.gain.setValueAtTime(0.3, now);
                    gain.gain.exponentialRampToValueAtTime(0.001, now + 0.1);

                    noise.connect(filter);
                    filter.connect(gain);
                    gain.connect(this.masterGain);

                    noise.start(now);
                    noise.stop(now + 0.1);
                }
                else if (type === 'hihat') {
                    // Hi-hat: ruido blanco corto con filtro agudo
                    const bufferSize = this.audioContext.sampleRate * 0.03;
                    const buffer = this.audioContext.createBuffer(1, bufferSize, this.audioContext.sampleRate);
                    const data = buffer.getChannelData(0);

                    for (let i = 0; i < bufferSize; i++) {
                        data[i] = Math.random() * 2 - 1;
                    }

                    const noise = this.audioContext.createBufferSource();
                    noise.buffer = buffer;

                    const filter = this.audioContext.createBiquadFilter();
                    filter.type = 'highpass';
                    filter.frequency.value = 7000;

                    const gain = this.audioContext.createGain();
                    gain.gain.setValueAtTime(0.15, now);
                    gain.gain.exponentialRampToValueAtTime(0.001, now + 0.03);

                    noise.connect(filter);
                    filter.connect(gain);
                    gain.connect(this.masterGain);

                    noise.start(now);
                    noise.stop(now + 0.03);
                }
            },

            // NUEVO: Obtener patrón de batería según feel
            getDrumPattern(feel, beat) {
                const patterns = {
                    'straight': {
                        kick: [0, 2],
                        snare: [1, 3],
                        hihat: [0, 0.5, 1, 1.5, 2, 2.5, 3, 3.5]
                    },
                    'shuffle': {
                        kick: [0, 2],
                        snare: [1, 3],
                        hihat: [0, 0.66, 1.33, 2, 2.66, 3.33]
                    },
                    'syncopated': {
                        kick: [0, 1.5, 2.5],
                        snare: [1, 3],
                        hihat: [0.5, 1, 1.5, 2, 2.5, 3, 3.5]
                    },
                    'ballad': {
                        kick: [0, 2],
                        snare: [1, 3],
                        hihat: [0, 1, 2, 3]
                    },
                    'driving': {
                        kick: [0, 0.5, 1, 1.5, 2, 2.5, 3, 3.5],
                        snare: [1, 3],
                        hihat: [0, 0.5, 1, 1.5, 2, 2.5, 3, 3.5]
                    },
                    'aggressive': {
                        kick: [0, 0.5, 1, 1.5, 2, 2.5, 3, 3.5],
                        snare: [1, 3],
                        hihat: [0, 0.5, 1, 1.5, 2, 2.5, 3, 3.5]
                    }
                };

                const pattern = patterns[feel.toLowerCase()] || patterns['straight'];
                return {
                    playKick: pattern.kick.includes(beat),
                    playSnare: pattern.snare.includes(beat),
                    playHihat: pattern.hihat.includes(beat)
                };
            },

            // NUEVO: Secuenciador con batería dinámica
            playChordSequenceWithDrums(chordProgression, bpm, rootKey, feel = 'straight', progressCallback = null) {
                if (!this.enabled || !this.audioContext) return null;

                const beatDuration = (60 / bpm) * 1000;
                const barDuration = beatDuration * 4;
                let currentBar = 0;
                let beatCount = 0;

                const intervals = {
                    chords: null,
                    drums: null,
                    currentBar: 0
                };

                // Acordes (cada 4 beats)
                intervals.chords = setInterval(() => {
                    const symbol = chordProgression[currentBar % chordProgression.length];
                    const chordNotes = this.parseChordSymbol(symbol, rootKey);

                    if (chordNotes && chordNotes.length > 0) {
                        this.playChord(chordNotes, 1.2);
                    }

                    intervals.currentBar = currentBar % chordProgression.length;

                    // Callback para actualizar UI
                    if (progressCallback) {
                        progressCallback({
                            bar: currentBar % chordProgression.length,
                            totalBars: chordProgression.length,
                            loopCount: Math.floor(currentBar / chordProgression.length)
                        });
                    }

                    currentBar++;
                }, barDuration);

                // Batería con subdivisiones (8th notes para hi-hat)
                const subdivisionDuration = beatDuration / 2; // 8th notes
                intervals.drums = setInterval(() => {
                    const beat = (beatCount % 8) / 2; // 0, 0.5, 1, 1.5, 2, 2.5, 3, 3.5
                    const wholeBeat = Math.floor(beat);

                    const pattern = this.getDrumPattern(feel, beat);

                    if (pattern.playKick) {
                        this.playDrumSound('kick');
                    }
                    if (pattern.playSnare) {
                        this.playDrumSound('snare');
                    }
                    if (pattern.playHihat) {
                        this.playDrumSound('hihat');
                    }

                    // Beat indicator callback (solo en beats enteros)
                    if (beat === wholeBeat && progressCallback) {
                        progressCallback({
                            beat: wholeBeat
                        });
                    }

                    beatCount++;
                }, subdivisionDuration);

                return intervals;
            },

            // Toggle audio on/off
            toggle() {
                this.enabled = !this.enabled;
                return this.enabled;
            },

            // Ajustar volumen master
            setVolume(value) {
                if (this.masterGain) {
                    this.masterGain.gain.value = Math.max(0, Math.min(1, value));
                }
            },

            // NUEVOS MÉTODOS PARA LICK LIBRARY Y EAR TRAINING

            // Reproduce una línea de tablatura con técnicas
            playTabLine(tabs, bpm, loopCount = 1) {
                if (!this.enabled || !this.audioContext) return null;

                const standardTuning = [64, 59, 55, 50, 45, 40]; // E A D G B E en MIDI
                const beatDuration = (60 / bpm) * 1000;
                let currentLoop = 0;

                const playLoop = () => {
                    tabs.forEach(tab => {
                        setTimeout(() => {
                            const midiNote = standardTuning[tab.string] + tab.fret;
                            const noteIndex = midiNote % 12;
                            const octave = Math.floor(midiNote / 12);

                            // Duración según técnica
                            let duration = 0.3;
                            if (tab.technique === 'bend' || tab.technique === 'vibrato') {
                                duration = 0.8;
                            } else if (tab.technique === 'palm') {
                                duration = 0.15;
                            }

                            this.playNote(noteIndex, duration, octave);
                        }, tab.time * beatDuration * 4); // 4 beats de referencia
                    });
                };

                // Loop inicial
                playLoop();

                // Loops adicionales si se requieren
                if (loopCount > 1) {
                    const totalDuration = Math.max(...tabs.map(t => t.time)) * beatDuration * 4;
                    const intervalId = setInterval(() => {
                        currentLoop++;
                        if (currentLoop >= loopCount) {
                            clearInterval(intervalId);
                            return;
                        }
                        playLoop();
                    }, totalDuration + 100); // Small pause between loops
                    return intervalId;
                }

                return null;
            },

            // Reproduce un chord quality para ear training
            playChordQuality(rootNote, intervals) {
                if (!this.enabled) return;
                const chordNotes = intervals.map(i => (rootNote + i) % 12);
                this.playChord(chordNotes, 1.5);
            },

            // Reproduce un acorde desde un voicing (posiciones de trastes)
            playChordVoicing(voicing, duration = 1.5) {
                if (!this.enabled || !this.audioContext) return;

                if (this.audioContext.state === 'suspended') {
                    this.audioContext.resume();
                }

                const standardTuning = [64, 59, 55, 50, 45, 40]; // E A D G B E en MIDI
                const midiNotes = [];

                // Convertir frets a notas MIDI completas (manteniendo octava)
                voicing.frets.forEach((fret, stringIndex) => {
                    if (fret >= 0) { // -1 significa cuerda silenciada
                        const midiNote = standardTuning[stringIndex] + fret;
                        midiNotes.push(midiNote);
                    }
                });

                if (midiNotes.length > 0) {
                    this.playChordFromMidi(midiNotes, duration);
                }
            },

            // Reproduce un acorde desde notas MIDI directas (con octava correcta)
            playChordFromMidi(midiNotes, duration = 1.5) {
                if (!this.enabled || !this.audioContext) return;

                if (this.audioContext.state === 'suspended') {
                    this.audioContext.resume();
                }

                // FIX: Ordenar de grave a agudo para downstroke natural (menor a mayor)
                // a - b = orden ascendente (grave a agudo) = downstroke natural
                const sortedNotes = [...midiNotes].sort((a, b) => a - b);

                // Strum con delay entre cuerdas (35ms)
                sortedNotes.forEach((midiNote, i) => {
                    setTimeout(() => {
                        this.playMidiNote(midiNote, duration);
                    }, i * 35);
                });
            },

            // Reproduce una progresión para ear training
            playProgressionEarTraining(pattern, rootKey, bpm = 80) {
                if (!this.enabled || !this.audioContext) return null;

                const beatDuration = (60 / bpm) * 1000 * 4;
                let currentIndex = 0;

                const intervalId = setInterval(() => {
                    if (currentIndex >= pattern.length) {
                        clearInterval(intervalId);
                        return;
                    }

                    const symbol = pattern[currentIndex];
                    const chordNotes = this.parseChordSymbol(symbol, rootKey);

                    if (chordNotes && chordNotes.length > 0) {
                        this.playChord(chordNotes, 1.2);
                    }

                    currentIndex++;
                }, beatDuration);

                return intervalId;
            },

            // Reproduce un patrón rítmico
            playRhythmPattern(hits, bpm = 80) {
                if (!this.enabled || !this.audioContext) return;

                const beatDuration = (60 / bpm) * 1000;

                hits.forEach((shouldHit, i) => {
                    if (shouldHit) {
                        setTimeout(() => {
                            // Usa un click/clave simple
                            const osc = this.audioContext.createOscillator();
                            const gain = this.audioContext.createGain();

                            osc.connect(gain);
                            gain.connect(this.masterGain);

                            osc.frequency.value = 1200; // High click
                            gain.gain.value = 0.3;

                            osc.start();
                            gain.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.05);
                            osc.stop(this.audioContext.currentTime + 0.05);
                        }, i * (beatDuration / 4)); // 16th notes
                    }
                });
            }
        };

        // ========================================
        // CHORD DIAGRAM COMPONENT - HORIZONTAL
        // ========================================
        const ChordDiagram = {
            create(voicing, chordName, position = 0) {
                const container = document.createElement('div');
                container.className = 'chord-diagram';
                container.style.paddingLeft = '40px';

                // Chord name
                const nameDiv = document.createElement('div');
                nameDiv.className = 'chord-name-display';
                nameDiv.innerHTML = `<div class="chord-symbol">${chordName}</div>`;
                container.appendChild(nameDiv);

                // Calculate actual frets
                const actualFrets = voicing.frets.map(f => f === -1 ? -1 : f + position);
                const validFrets = actualFrets.filter(f => f > 0);
                const minFret = validFrets.length > 0 ? Math.min(...validFrets) : 0;
                const maxFret = actualFrets.length > 0 ? Math.max(...actualFrets) : 0;
                const displayStartFret = position > 0 ? minFret : 0;
                const numFrets = Math.max(4, maxFret - displayStartFret + 1);
                const isOpenPosition = displayStartFret === 0;

                // Grid container (horizontal layout)
                const grid = document.createElement('div');
                grid.className = 'chord-diagram-grid';
                grid.style.position = 'relative';

                // String labels (left side)
                const stringLabels = document.createElement('div');
                stringLabels.className = 'string-labels-left';
                const stringNames = ['e', 'B', 'G', 'D', 'A', 'E'];
                stringNames.forEach(name => {
                    const label = document.createElement('div');
                    label.className = 'string-label-item';
                    label.textContent = name;
                    stringLabels.appendChild(label);
                });
                container.appendChild(stringLabels);

                // Create string rows (6 strings, horizontal)
                for (let string = 0; string < 6; string++) {
                    const row = document.createElement('div');
                    row.className = 'string-row';

                    const actualFret = actualFrets[string];

                    // Open/Muted indicator
                    if (actualFret === 0) {
                        const open = document.createElement('div');
                        open.className = 'open-indicator';
                        open.textContent = 'O';
                        row.appendChild(open);
                    } else if (actualFret === -1) {
                        const muted = document.createElement('div');
                        muted.className = 'muted-indicator';
                        muted.textContent = 'X';
                        row.appendChild(muted);
                    }

                    // Create fret cells
                    for (let fret = 0; fret < numFrets; fret++) {
                        const cell = document.createElement('div');
                        cell.className = 'fret-cell';

                        // First fret is the nut if open position
                        if (fret === 0 && isOpenPosition) {
                            cell.classList.add('nut-fret');
                        }

                        const displayFret = actualFret - displayStartFret;

                        // Check for finger dot
                        if (displayFret === fret && actualFret > 0) {
                            const dot = document.createElement('div');
                            dot.className = 'finger-dot';

                            // Check if root note
                            const stringOpenNote = [4, 11, 7, 2, 9, 4][string];
                            const noteAtFret = (stringOpenNote + actualFret) % 12;
                            const rootNote = MusicTheory.getNoteIndex(chordName.replace(/m.*|7.*|maj.*/g, ''));

                            if (noteAtFret === rootNote) {
                                dot.classList.add('root');
                                dot.textContent = 'R';
                            } else {
                                dot.classList.add('note');
                                dot.textContent = voicing.fingers ? voicing.fingers[string] : '';
                            }
                            cell.appendChild(dot);
                        }

                        // Check if open string note on nut fret
                        if (fret === 0 && isOpenPosition && actualFret === 0) {
                            const dot = document.createElement('div');
                            dot.className = 'finger-dot';
                            const stringOpenNote = [4, 11, 7, 2, 9, 4][string];
                            const rootNote = MusicTheory.getNoteIndex(chordName.replace(/m.*|7.*|maj.*/g, ''));
                            if (stringOpenNote === rootNote) {
                                dot.classList.add('root');
                                dot.textContent = 'R';
                            } else {
                                dot.classList.add('note');
                                dot.textContent = 'O';
                            }
                            cell.appendChild(dot);
                        }

                        row.appendChild(cell);
                    }

                    grid.appendChild(row);
                }

                // Barre indication (horizontal)
                if (voicing.barreInfo && position > 0) {
                    const barre = document.createElement('div');
                    barre.className = 'barre-line';
                    const barreCol = voicing.barreInfo.fret;
                    const fromString = voicing.barreInfo.fromString;
                    const toString = voicing.barreInfo.toString;
                    const topString = Math.min(fromString, toString);
                    const bottomString = Math.max(fromString, toString);
                    barre.style.top = `${topString * 32 + 4}px`;
                    barre.style.height = `${(bottomString - topString) * 32 + 24}px`;
                    barre.style.left = `${barreCol * 50 + 25}px`;
                    grid.appendChild(barre);
                }

                container.appendChild(grid);

                // Fret numbers
                const fretNumbers = document.createElement('div');
                fretNumbers.className = 'fret-numbers';
                for (let fret = 0; fret < numFrets; fret++) {
                    const numDiv = document.createElement('div');
                    numDiv.className = 'fret-num';
                    numDiv.textContent = fret + displayStartFret;
                    fretNumbers.appendChild(numDiv);
                }
                container.appendChild(fretNumbers);

                return container;
            },

            // Create multiple diagrams for a progression
            createProgression(chords, currentIndex = 0) {
                const container = document.createElement('div');
                container.className = 'diagrams-container';
                container.style.flexDirection = 'column';
                container.style.gap = '20px';

                chords.forEach((chord, i) => {
                    const wrapper = document.createElement('div');
                    wrapper.style.opacity = i === currentIndex ? '1' : '0.4';
                    wrapper.style.transform = i === currentIndex ? 'scale(1)' : 'scale(0.95)';
                    wrapper.style.transition = 'all 0.3s ease';

                    const diagram = this.create(chord.voicing, chord.name, chord.position);
                    wrapper.appendChild(diagram);
                    container.appendChild(wrapper);
                });

                return container;
            }
        };

        // ========================================
        // CHORD LAB STATE
        // ========================================
        const ChordLabState = {
            currentMode: 'explorer',
            currentRoot: 'C',
            currentQuality: 'maj',
            comparisonA: null,
            comparisonB: null,
            selectedVoicing: null
        };

        const ProgressionBuilderState = {
            progression: [],
            currentKey: 'C',
            lastEmotion: null,
            subMode: 'guided' // 'guided' or 'free'
        };

        const ChordBuilderState = {
            selectedNotes: [], // [{string: 0-5, fret: 0-12, note: 'C'}]
            currentChord: null,
            savedVoicings: []
        };

        // ========================================
        // TAB NOTATION COMPONENT
        // ========================================
        const TabNotation = {
            create(tabs, lickName = '', bpm = 80) {
                const container = document.createElement('div');
                container.className = 'tab-notation-container';

                // Título
                if (lickName) {
                    const title = document.createElement('div');
                    title.className = 'tab-title';
                    title.textContent = lickName;
                    container.appendChild(title);
                }

                // SVG container
                const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                svg.setAttribute('class', 'tab-notation-svg');
                svg.setAttribute('width', '100%');
                svg.setAttribute('height', '200');
                svg.setAttribute('viewBox', '0 0 800 200');

                const strings = 6;
                const stringSpacing = 25;
                const startY = 40;
                const startX = 60;
                const noteSpacing = 60;

                // Dibujar las 6 líneas (cuerdas)
                for (let i = 0; i < strings; i++) {
                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    line.setAttribute('x1', startX);
                    line.setAttribute('y1', startY + i * stringSpacing);
                    line.setAttribute('x2', 750);
                    line.setAttribute('y2', startY + i * stringSpacing);
                    line.setAttribute('stroke', '#444');
                    line.setAttribute('stroke-width', '1');
                    svg.appendChild(line);
                }

                // Labels de cuerdas (E A D G B e)
                const stringNames = ['e', 'B', 'G', 'D', 'A', 'E'];
                stringNames.forEach((name, i) => {
                    const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    text.setAttribute('x', 30);
                    text.setAttribute('y', startY + i * stringSpacing + 5);
                    text.setAttribute('fill', '#888');
                    text.setAttribute('font-size', '14');
                    text.setAttribute('font-weight', 'bold');
                    text.textContent = name;
                    svg.appendChild(text);
                });

                // Agrupar notas por tiempo para posicionamiento
                const sortedTabs = [...tabs].sort((a, b) => a.time - b.time);
                const timePositions = {};
                let currentX = startX + 40;

                sortedTabs.forEach((tab, i) => {
                    if (!timePositions[tab.time]) {
                        timePositions[tab.time] = currentX;
                        currentX += noteSpacing;
                    }
                });

                // Dibujar notas
                sortedTabs.forEach((tab) => {
                    const x = timePositions[tab.time];
                    const y = startY + (5 - tab.string) * stringSpacing;

                    // Círculo de fondo
                    const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                    circle.setAttribute('cx', x);
                    circle.setAttribute('cy', y);
                    circle.setAttribute('r', '12');
                    circle.setAttribute('fill', '#dc2626');
                    circle.setAttribute('stroke', '#fff');
                    circle.setAttribute('stroke-width', '2');
                    svg.appendChild(circle);

                    // Número de traste
                    const fretText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    fretText.setAttribute('x', x);
                    fretText.setAttribute('y', y + 5);
                    fretText.setAttribute('text-anchor', 'middle');
                    fretText.setAttribute('fill', '#fff');
                    fretText.setAttribute('font-size', '14');
                    fretText.setAttribute('font-weight', 'bold');
                    fretText.textContent = tab.fret;
                    svg.appendChild(fretText);

                    // Símbolo de técnica
                    if (tab.technique) {
                        const techSymbol = this.getTechniqueSymbol(tab.technique);
                        if (techSymbol) {
                            const techText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                            techText.setAttribute('x', x);
                            techText.setAttribute('y', y - 20);
                            techText.setAttribute('text-anchor', 'middle');
                            techText.setAttribute('fill', '#eab308');
                            techText.setAttribute('font-size', '12');
                            techText.setAttribute('font-style', 'italic');
                            techText.textContent = techSymbol;
                            svg.appendChild(techText);
                        }
                    }

                    // Flecha de picking direction (down/up)
                    if (tab.technique === 'down' || tab.technique === 'up') {
                        const arrow = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                        arrow.setAttribute('x', x);
                        arrow.setAttribute('y', y + 30);
                        arrow.setAttribute('text-anchor', 'middle');
                        arrow.setAttribute('fill', '#10b981');
                        arrow.setAttribute('font-size', '16');
                        arrow.textContent = tab.technique === 'down' ? '↓' : '↑';
                        svg.appendChild(arrow);
                    }
                });

                container.appendChild(svg);

                // Controles de reproducción
                const controls = document.createElement('div');
                controls.className = 'tab-controls';
                controls.innerHTML = `
                    <button class="tab-play-btn ctrl-btn">▶ Play</button>
                    <button class="tab-loop-btn ctrl-btn">🔁 Loop</button>
                    <div class="tempo-control">
                        <label>Tempo: <span class="tempo-value">${bpm}</span> BPM</label>
                        <input type="range" class="tempo-slider" min="50" max="200" value="${bpm}" step="5">
                    </div>
                `;
                container.appendChild(controls);

                return container;
            },

            getTechniqueSymbol(technique) {
                const symbols = {
                    'bend': 'b',
                    'release': 'r',
                    'hammeron': 'h',
                    'hammer': 'h',
                    'pulloff': 'p',
                    'slide': '/',
                    'vibrato': '~',
                    'tap': 'T',
                    'palm': 'P.M.',
                    'thumb': 'T'
                };
                return symbols[technique] || '';
            }
        };

        // ========================================
        // FRETBOARD COMPONENT
        // ========================================
        const Fretboard = {
            // Standard tuning (high to low E)
            tuning: [4, 11, 7, 2, 9, 4], // E B G D A E (as semitones from C)
            frets: 13, // 0-12

            // State
            highlightedNotes: new Set(),
            tonicNote: null,
            showNoteNames: true,
            showFunctions: false,
            currentScale: [],
            blueNoteIndex: null, // For blues scale special highlight
            zoneStart: null, // Fret zone start
            zoneEnd: null, // Fret zone end
            specificPositions: null, // Array of {string, fret} for specific note display
            chordHighlight: null, // Set of note indices to highlight as chord tones

            // Initialize fretboard
            init() {
                this.render();
                this.bindEvents();
            },

            // Render fretboard HTML
            render(containerId = 'fretboard') {
                const fretboard = document.getElementById(containerId);
                if (!fretboard) return;

                fretboard.innerHTML = '';

                this.tuning.forEach((openNote, stringIndex) => {
                    const stringDiv = document.createElement('div');
                    stringDiv.className = 'string';

                    for (let fret = 0; fret < this.frets; fret++) {
                        const noteIndex = (openNote + fret) % 12;
                        const noteName = MusicTheory.getNoteName(noteIndex);

                        const fretDiv = document.createElement('div');
                        fretDiv.className = 'fret';
                        fretDiv.dataset.string = stringIndex;
                        fretDiv.dataset.fret = fret;
                        fretDiv.dataset.note = noteIndex;

                        const bubble = document.createElement('div');
                        bubble.className = 'note-bubble';
                        bubble.dataset.noteIndex = noteIndex;
                        bubble.textContent = noteName;

                        fretDiv.appendChild(bubble);
                        stringDiv.appendChild(fretDiv);
                    }

                    fretboard.appendChild(stringDiv);
                });
            },

            // Update displayed notes
            updateDisplay() {
                const bubbles = document.querySelectorAll('.note-bubble');
                const frets = document.querySelectorAll('.fret');

                // Reset fret zone highlighting
                frets.forEach(fret => {
                    fret.classList.remove('in-zone', 'zone-start', 'zone-end');
                    const fretNum = parseInt(fret.dataset.fret);
                    if (this.zoneStart !== null && this.zoneEnd !== null) {
                        if (fretNum >= this.zoneStart && fretNum <= this.zoneEnd) {
                            fret.classList.add('in-zone');
                            if (fretNum === this.zoneStart) fret.classList.add('zone-start');
                            if (fretNum === this.zoneEnd) fret.classList.add('zone-end');
                        }
                    }
                });

                bubbles.forEach((bubble) => {
                    const noteIndex = parseInt(bubble.dataset.noteIndex);
                    const noteName = MusicTheory.getNoteName(noteIndex);
                    const fretEl = bubble.closest('.fret');
                    const stringIndex = parseInt(fretEl.dataset.string);
                    const fretNum = parseInt(fretEl.dataset.fret);

                    // Reset classes
                    bubble.classList.remove('visible', 'tonic', 'interval', 'other', 'pulse', 'blue-note', 'dimmed', 'chord-highlight');

                    // Check if we're using specific positions mode
                    if (this.specificPositions) {
                        const isInPosition = this.specificPositions.some(
                            p => p.string === stringIndex && p.fret === fretNum
                        );

                        if (isInPosition) {
                            bubble.classList.add('visible');
                            const scaleNoteForPosition = this.currentScale.find(n =>
                                MusicTheory.getNoteIndex(n.note) === noteIndex
                            );
                            if (noteIndex === this.tonicNote) {
                                bubble.classList.add('tonic', 'pulse');
                            } else {
                                bubble.classList.add('interval');
                            }
                            if (this.showFunctions && scaleNoteForPosition) {
                                bubble.textContent = scaleNoteForPosition.degree ? scaleNoteForPosition.degree.toString() : (scaleNoteForPosition.intervalName || noteName);
                            } else if (this.showNoteNames) {
                                bubble.textContent = noteName;
                            } else {
                                bubble.textContent = '';
                            }
                        }
                        return;
                    }

                    // Check if note should be highlighted
                    const scaleNote = this.currentScale.find(n =>
                        MusicTheory.getNoteIndex(n.note) === noteIndex
                    );

                    if (scaleNote || this.highlightedNotes.has(noteIndex)) {
                        bubble.classList.add('visible');

                        // Check if outside zone (dim it)
                        const inZone = this.zoneStart === null ||
                            (fretNum >= this.zoneStart && fretNum <= this.zoneEnd);

                        if (!inZone) {
                            bubble.classList.add('dimmed');
                        }

                        if (noteIndex === this.tonicNote) {
                            bubble.classList.add('tonic');
                            if (inZone) bubble.classList.add('pulse');
                        } else if (this.blueNoteIndex !== null && noteIndex === this.blueNoteIndex) {
                            bubble.classList.add('blue-note');
                        } else if (scaleNote) {
                            bubble.classList.add('interval');
                        } else {
                            bubble.classList.add('other');
                        }

                        // Highlight chord tones
                        if (this.chordHighlight && this.chordHighlight.has(noteIndex)) {
                            bubble.classList.add('chord-highlight');
                        }

                        // Set display text
                        if (this.showFunctions && scaleNote) {
                            // Show degree number (1-7) for scale notes
                            bubble.textContent = scaleNote.degree ? scaleNote.degree.toString() : (scaleNote.intervalName || noteName);
                        } else if (this.showNoteNames) {
                            bubble.textContent = noteName;
                        } else {
                            bubble.textContent = '';
                        }
                    }
                });

                // Add staggered animation
                const visibleBubbles = document.querySelectorAll('.note-bubble.visible:not(.dimmed)');
                visibleBubbles.forEach((bubble, i) => {
                    bubble.style.transitionDelay = `${i * 15}ms`;
                });
            },

            // Set zone for limited display
            setZone(start, end) {
                this.zoneStart = start;
                this.zoneEnd = end;
            },

            // Clear zone
            clearZone() {
                this.zoneStart = null;
                this.zoneEnd = null;
                this.specificPositions = null;
            },

            // Show specific positions only
            showPositions(positions) {
                this.specificPositions = positions;
                this.updateDisplay();
            },

            // Show scale on fretboard
            showScale(root, scaleType) {
                this.tonicNote = typeof root === 'number' ? root : MusicTheory.getNoteIndex(root);
                this.currentScale = MusicTheory.getScale(root, scaleType);
                this.highlightedNotes.clear();
                this.blueNoteIndex = null;
                this.chordHighlight = null; // Clear chord highlight
                this.clearZone(); // Reset zone
                this.updateDisplay();
            },

            // Show specific interval from root
            showInterval(root, semitones) {
                this.tonicNote = typeof root === 'number' ? root : MusicTheory.getNoteIndex(root);
                const targetNote = (this.tonicNote + semitones) % 12;
                const intervalName = MusicTheory.intervalNames[semitones] || semitones.toString();

                this.currentScale = [
                    { note: MusicTheory.getNoteName(this.tonicNote), degree: 1, intervalName: '1' },
                    { note: MusicTheory.getNoteName(targetNote), degree: 2, intervalName: intervalName }
                ];
                this.highlightedNotes.clear();
                this.updateDisplay();
            },

            // Show triad on fretboard
            showTriad(root, scaleType, degree) {
                const triad = MusicTheory.getTriad(root, scaleType, degree);
                this.tonicNote = MusicTheory.getNoteIndex(triad.root.note);

                this.currentScale = [
                    { note: triad.root.note, degree: 1 },
                    { note: triad.third.note, degree: 3 },
                    { note: triad.fifth.note, degree: 5 }
                ];
                this.highlightedNotes.clear();
                this.updateDisplay();

                return triad;
            },

            // Clear fretboard
            clear() {
                this.highlightedNotes.clear();
                this.currentScale = [];
                this.tonicNote = null;
                this.chordHighlight = null;
                this.updateDisplay();
            },

            // Bind events (toggles are handled by App.bindEvents)
            bindEvents() {
                // Click on note bubbles to play sound
                document.getElementById('fretboard').addEventListener('click', (e) => {
                    const bubble = e.target.closest('.note-bubble');
                    if (bubble && bubble.classList.contains('visible')) {
                        const fretEl = bubble.closest('.fret');
                        const stringIndex = parseInt(fretEl.dataset.string);
                        const fretNum = parseInt(fretEl.dataset.fret);

                        // Afinación estándar en notas MIDI:
                        // String 0 (más aguda) = E4 = MIDI 64
                        // String 1 = B3 = MIDI 59
                        // String 2 = G3 = MIDI 55
                        // String 3 = D3 = MIDI 50
                        // String 4 = A2 = MIDI 45
                        // String 5 (más grave) = E2 = MIDI 40
                        const openStringMidi = [64, 59, 55, 50, 45, 40];

                        // Calcular nota MIDI: nota abierta + trastes
                        const midiNote = openStringMidi[stringIndex] + fretNum;

                        // Reproducir sonido
                        AudioEngine.playMidiNote(midiNote, 0.8);

                        // Efecto visual
                        bubble.style.transform = 'scale(1.3)';
                        setTimeout(() => {
                            bubble.style.transform = '';
                        }, 200);
                    }
                });
            },

            // ========== NUEVAS FUNCIONALIDADES ==========

            // Alternative tunings
            tunings: {
                'standard': { name: 'Standard (E A D G B E)', notes: [4, 11, 7, 2, 9, 4] },
                'dropD': { name: 'Drop D (D A D G B E)', notes: [4, 11, 7, 2, 9, 2] },
                'dropC': { name: 'Drop C (C G C F A D)', notes: [2, 9, 5, 0, 7, 0] },
                'dropB': { name: 'Drop B (B F# B E G# C#)', notes: [1, 8, 4, 11, 6, 11] },
                'dropA': { name: 'Drop A (A E A D F# B)', notes: [11, 6, 2, 9, 4, 9] },
                'dadgad': { name: 'DADGAD (D A D G A D)', notes: [2, 9, 7, 2, 9, 2] },
                'openG': { name: 'Open G (D G D G B D)', notes: [2, 11, 7, 2, 7, 2] },
                'openD': { name: 'Open D (D A D F# A D)', notes: [2, 9, 6, 2, 9, 2] },
                'halfStep': { name: 'Half Step Down (Eb Ab Db Gb Bb Eb)', notes: [3, 10, 6, 1, 8, 3] },
                'wholeStep': { name: 'Whole Step Down (D G C F A D)', notes: [2, 9, 5, 0, 7, 2] }
            },

            currentTuning: 'standard',

            // Change tuning
            setTuning(tuningKey) {
                if (!this.tunings[tuningKey]) return;

                this.currentTuning = tuningKey;
                this.tuning = this.tunings[tuningKey].notes;

                // Re-render fretboard with new tuning
                this.render();
                this.updateDisplay();
            },

            // Finger numbers for positions
            fingeringData: {}, // Store fingering per string/fret

            // Set fingering for specific positions
            setFingering(positions) {
                // positions: [{ string, fret, finger }]
                this.fingeringData = {};
                positions.forEach(pos => {
                    const key = `${pos.string}-${pos.fret}`;
                    this.fingeringData[key] = pos.finger;
                });
                this.updateDisplay();
            },

            // Clear fingering
            clearFingering() {
                this.fingeringData = {};
                this.updateDisplay();
            },

            // CAGED position markers
            cagedPositions: {
                'C': { frets: [0, 3], color: '#dc2626', name: 'C Shape' },
                'A': { frets: [5, 7], color: '#ea580c', name: 'A Shape' },
                'G': { frets: [7, 10], color: '#eab308', name: 'G Shape' },
                'E': { frets: [10, 12], color: '#22c55e', name: 'E Shape' },
                'D': { frets: [12, 15], color: '#3b82f6', name: 'D Shape' }
            },

            currentCagedPosition: null,

            // Show CAGED position
            showCAGEDPosition(shape) {
                if (!this.cagedPositions[shape]) return;

                this.currentCagedPosition = shape;
                const pos = this.cagedPositions[shape];
                this.setZone(pos.frets[0], pos.frets[1]);
                this.updateDisplay();
            },

            // Clear CAGED position
            clearCAGEDPosition() {
                this.currentCagedPosition = null;
                this.clearZone();
                this.updateDisplay();
            },

            // Enhanced updateDisplay with fingering and position markers
            updateDisplayEnhanced() {
                const bubbles = document.querySelectorAll('.note-bubble');
                const frets = document.querySelectorAll('.fret');

                // Add CAGED position markers
                frets.forEach(fret => {
                    fret.classList.remove('caged-c', 'caged-a', 'caged-g', 'caged-e', 'caged-d');

                    if (this.currentCagedPosition) {
                        const fretNum = parseInt(fret.dataset.fret);
                        const pos = this.cagedPositions[this.currentCagedPosition];
                        if (fretNum >= pos.frets[0] && fretNum <= pos.frets[1]) {
                            fret.classList.add(`caged-${this.currentCagedPosition.toLowerCase()}`);
                        }
                    }
                });

                // Add finger numbers to visible bubbles
                bubbles.forEach((bubble) => {
                    const fretEl = bubble.closest('.fret');
                    const stringIndex = parseInt(fretEl.dataset.string);
                    const fretNum = parseInt(fretEl.dataset.fret);
                    const key = `${stringIndex}-${fretNum}`;

                    // Remove existing finger badge
                    const existingBadge = bubble.querySelector('.finger-badge');
                    if (existingBadge) existingBadge.remove();

                    // Add finger number if available and bubble is visible
                    if (this.fingeringData[key] && bubble.classList.contains('visible')) {
                        const badge = document.createElement('div');
                        badge.className = 'finger-badge';
                        badge.textContent = this.fingeringData[key];
                        bubble.appendChild(badge);
                    }
                });

                // Call original update logic
                this.updateDisplay();
            }
        };

        // ========================================
        // APP CONTROLLER
        // ========================================
        const App = {
            // ====== CONSTANTES CONSOLIDADAS ======
            CATEGORY_SCALES: {
                'major': ['major'],
                'minor': ['minor', 'harmonicMinor', 'melodicMinor'],
                'modes': ['dorian', 'phrygian', 'lydian', 'mixolydian', 'locrian'],
                'pentatonic': ['pentatonicMajor', 'pentatonicMinor', 'blues', 'bluesMajor', 'bluesHeptatonic'],
                'exotic': ['phrygianDom', 'hungarian', 'byzantine', 'japanese', 'wholeTone', 'diminished', 'ryuKyu', 'yo', 'bhairav', 'todi'],
                'harmonicMinorModes': ['locrianNat6', 'ionianAug', 'dorianSharp4', 'phrygianDom', 'lydianSharp2', 'superLocrian'],
                'melodicMinorModes': ['dorianB2', 'lydianAug', 'lydianDom', 'mixolydianB6', 'locrianNat2', 'alteredScale'],
                'symmetric': ['wholeTone', 'diminished', 'diminishedHW', 'chromatic', 'messiaenMode2', 'messiaenMode3']
            },
            SCALE_NAMES: {
                'major': 'Mayor', 'minor': 'Menor Natural', 'harmonicMinor': 'Menor Armónica',
                'melodicMinor': 'Menor Melódica', 'dorianMinor': 'Menor Dórica',
                'dorian': 'Dórico', 'phrygian': 'Frigio', 'lydian': 'Lidio',
                'mixolydian': 'Mixolidio', 'locrian': 'Locrio',
                'locrianNat6': 'Locrio ♮6', 'ionianAug': 'Jónico #5', 'dorianSharp4': 'Dórico #4',
                'phrygianDom': 'Frigio Dominante', 'lydianSharp2': 'Lidio #2', 'superLocrian': 'Superlocrio',
                'dorianB2': 'Dórico ♭2', 'lydianAug': 'Lidio #5', 'lydianDom': 'Lidio Dominante',
                'mixolydianB6': 'Mixolidio ♭6', 'locrianNat2': 'Locrio ♮2', 'alteredScale': 'Alterada',
                'pentatonicMajor': 'Pentatónica Mayor', 'pentatonicMinor': 'Pentatónica Menor',
                'blues': 'Blues', 'bluesMajor': 'Blues Mayor', 'bluesHeptatonic': 'Blues Heptatónica',
                'wholeTone': 'Tonos Enteros', 'diminished': 'Disminuida (T-S)',
                'diminishedHW': 'Disminuida (S-T)', 'chromatic': 'Cromática',
                'hungarian': 'Húngara Menor', 'hungarianMajor': 'Húngara Mayor',
                'byzantine': 'Bizantina', 'arabic': 'Árabe', 'japanese': 'Japonesa',
                'hirajoshi': 'Hirajoshi', 'egyptian': 'Egipcia', 'prometheus': 'Prometheus',
                'persian': 'Persa', 'enigmatic': 'Enigmática', 'neapolitan': 'Napolitana',
                'bebop': 'Bebop Dominante', 'bebopMajor': 'Bebop Mayor',
                'ryuKyu': 'Ryu Kyu', 'yo': 'Yo Scale', 'bhairav': 'Bhairav', 'todi': 'Todi',
                'messiaenMode2': 'Messiaen Modo 2', 'messiaenMode3': 'Messiaen Modo 3'
            },

            // ====== ESTADO ======
            currentRoot: 0,
            currentScale: 'major',
            currentLevel: 1,
            currentInterval: 4,
            currentChord: null,
            currentMode: 1,
            currentPentatonic: 'minor',
            currentBox: 0,
            templates: {}, // Template storage
            currentChord7: null,
            currentProgression: null,
            currentProgressionChordIndex: 0,
            // Metronome state
            metronomeRunning: false,
            metronomeBPM: 120,
            metronomeIntervalId: null,
            metronomeTimeSignature: '4/4',
            metronomeSubdivision: 'quarter',
            metronomeAccent: true,
            metronomeCurrentBeat: 0,
            metronomeTapTimes: [],
            // Progression playback state
            progressionPlaying: false,
            progressionPaused: false,
            progressionBPM: 120,
            progressionLoop: false,
            progressionRepeatCount: 1,
            progressionCurrentRepeat: 0,
            progressionIntervalId: null,
            // Global BPM sync
            globalBPM: 120,
            syncMetronomeWithBacking: true,
            // Jam Session visual progress
            jamCurrentBar: 0,
            jamLoopCount: 0,
            jamCurrentBeat: 0,
            jamBeatIntervalId: null,
            jamTrackCategory: 'all',
            currentCAGED: 'C',
            cagedShowAll: false,
            currentScaleCategory: 'major',
            currentLabScale: 'major',
            currentLabCategory: 'major',
            currentLabHarmChord: null,
            compareScale: null,
            eventController: null,
            // Quiz state
            quizCategory: 'intervals',
            quizDifficulty: 'easy',
            quizScore: 0,
            quizStreak: 0,
            quizBest: 0,
            quizAnswered: false,
            // Extended chords state
            currentExtension: '9',
            currentExtQuality: 'maj',
            // Secondary dominants state
            currentSecondary: 'ii',
            currentSecProg: null,
            // Songs state
            songGenreFilter: 'all',
            currentSong: null,
            // Ear Training state
            earTrainingLevel: 'easy',
            earTrainingScore: 0,
            earTrainingStreak: 0,
            earTrainingBest: 0,
            earTrainingCurrentInterval: null,
            earTrainingAnswered: false,
            // Jam Session state
            currentBackingTrack: null,
            backingTrackPlaying: false,
            backingTrackIntervals: null,
            backingTrackBar: 0,
            customBPM: null,
            drumsEnabled: true,

            // ====== HELPERS ======
            resetState(except = []) {
                const defaults = {
                    currentInterval: null, currentChord: null, currentMode: null,
                    currentPentatonic: null, currentChord7: null, currentProgression: null, currentCAGED: null
                };
                Object.keys(defaults).forEach(key => {
                    if (!except.includes(key)) this[key] = defaults[key];
                });
            },

            hideUIElements() {
                document.getElementById('diagramsContainer').classList.add('hidden');
                document.getElementById('boxSelector').classList.add('hidden');
            },

            clearInfoPanel() {
                const panel = document.getElementById('infoPanel');
                if (panel) panel.innerHTML = '';
            },

            clearAllContentContainers() {
                // Limpiar TODOS los contenedores de contenido dinámico
                const containers = [
                    'infoPanel',           // Usado por la mayoría de niveles (2,6,7,8,10,11,12,13)
                    'jamSessionInfo',      // Nivel 15 (Jam Session) - panel de info
                    'jamTrackGrid',        // Nivel 15 (Jam Session) - grid de tracks
                    'earTrainingAnswers',  // Nivel 14 (Ear Training) - respuestas
                    'diagramsContainer'    // Diagramas de acordes (para limpieza completa)
                ];

                containers.forEach(id => {
                    const container = document.getElementById(id);
                    if (container) {
                        container.innerHTML = '';
                    }
                });
            },

            updateDisplay(title, subtitle) {
                document.getElementById('displayTitle').textContent = title;
                document.getElementById('displaySubtitle').textContent = subtitle;
            },

            init() {
                console.log('[Init] Starting initialization, currentLevel:', this.currentLevel);
                Fretboard.init();
                this.loadProgress();           // Load saved progress (updates currentLevel)
                this.bindEvents();             // Bind all event listeners
                this.setupKeyboardNavigation();
                this.registerTemplates();      // Register all templates including Chord Lab
                // Load the saved level (or default to 1 if no save exists)
                this.loadLevel(this.currentLevel);  // Uses the level from loadProgress()
                this.showToast('GuitarMaster cargado correctamente', 'success');
            },

            registerTemplates() {
                // Register Chord Lab template
                const chordLabTpl = document.getElementById('tpl-chord-lab');
                if (chordLabTpl) {
                    this.templates['chord-lab'] = chordLabTpl.innerHTML;
                }
            },

            setupKeyboardNavigation() {
                document.addEventListener('keydown', (e) => {
                    // Solo en nivel 7 (progresiones)
                    if (this.currentLevel !== 7) return;

                    const prog = MusicTheory.progressions[this.currentProgression];
                    if (!prog) return;

                    switch(e.key) {
                        case 'ArrowLeft':
                            e.preventDefault();
                            if (!this.progressionPlaying) {
                                this.currentProgressionChordIndex = Math.max(0, this.currentProgressionChordIndex - 1);
                                this.showProgression();
                            }
                            break;

                        case 'ArrowRight':
                            e.preventDefault();
                            if (!this.progressionPlaying) {
                                this.currentProgressionChordIndex = Math.min(prog.degrees.length - 1, this.currentProgressionChordIndex + 1);
                                this.showProgression();
                            }
                            break;

                        case 'Enter':
                            e.preventDefault();
                            if (!this.progressionPlaying) {
                                // Reproducir acorde actual
                                const degree = prog.degrees[this.currentProgressionChordIndex];
                                this.playProgressionChord(degree);
                            }
                            break;

                        case ' ':
                            e.preventDefault();
                            // Toggle reproducción de progresión
                            if (this.progressionPlaying && !this.progressionPaused) {
                                this.pauseProgression();
                            } else if (this.progressionPaused) {
                                this.playProgression();
                            } else {
                                this.playProgression();
                            }
                            break;

                        case 'Escape':
                            e.preventDefault();
                            if (this.progressionPlaying || this.progressionPaused) {
                                this.stopProgression();
                            }
                            break;
                    }
                });
            },

            // === PERSISTENCIA ===
            saveProgress() {
                const progress = {
                    currentLevel: this.currentLevel,
                    currentRoot: this.currentRoot,
                    quizScore: this.quizScore,
                    quizBest: this.quizBest,
                    earTrainingScore: this.earTrainingScore,
                    earTrainingBest: this.earTrainingBest,
                    timestamp: Date.now()
                };
                try {
                    localStorage.setItem('guitarmaster_progress', JSON.stringify(progress));
                } catch (e) {
                    console.error('Error guardando progreso:', e);
                }
            },

            loadProgress() {
                try {
                    const saved = localStorage.getItem('guitarmaster_progress');
                    if (saved) {
                        const progress = JSON.parse(saved);
                        this.currentLevel = progress.currentLevel || 1;
                        this.currentRoot = progress.currentRoot || 0;
                        this.quizScore = progress.quizScore || 0;
                        this.quizBest = progress.quizBest || 0;
                        this.earTrainingScore = progress.earTrainingScore || 0;
                        this.earTrainingBest = progress.earTrainingBest || 0;
                    }
                } catch (e) {
                    console.error('Error cargando progreso:', e);
                }
            },

            // === TOAST NOTIFICATIONS ===
            showToast(message, type = 'info', duration = 3000) {
                const toast = document.createElement('div');
                toast.className = `toast toast-${type}`;

                const icons = {
                    success: '✓',
                    error: '✗',
                    info: 'ℹ',
                    warning: '⚠'
                };

                toast.innerHTML = `
                    <span class="toast-icon">${icons[type] || icons.info}</span>
                    <div class="toast-content">${message}</div>
                `;

                document.body.appendChild(toast);

                requestAnimationFrame(() => {
                    toast.classList.add('show');
                });

                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 300);
                }, duration);
            },

            // === LOADING OVERLAY ===
            showLoading(text = 'Cargando...') {
                let overlay = document.getElementById('loading-overlay');
                if (!overlay) {
                    overlay = document.createElement('div');
                    overlay.id = 'loading-overlay';
                    overlay.className = 'loading-overlay';
                    overlay.innerHTML = `
                        <div class="loading-content">
                            <div class="loading-spinner"></div>
                            <div class="loading-text">${text}</div>
                        </div>
                    `;
                    document.body.appendChild(overlay);
                }
                requestAnimationFrame(() => {
                    overlay.classList.add('show');
                });
            },

            hideLoading() {
                const overlay = document.getElementById('loading-overlay');
                if (overlay) {
                    overlay.classList.remove('show');
                }
            },

            // === METRONOME ===
            toggleMetronome() {
                if (this.metronomeRunning) {
                    this.stopMetronome();
                } else {
                    this.startMetronome();
                }
            },

            startMetronome() {
                if (this.metronomeRunning) return;

                this.metronomeRunning = true;
                this.metronomeCurrentBeat = 0;

                // Parsear compás
                const [beats, noteValue] = this.metronomeTimeSignature.split('/').map(Number);

                // Calcular intervalo base
                let baseInterval = (60 / this.metronomeBPM) * 1000;

                // Ajustar por subdivisión
                let subdivisionMultiplier = 1;
                if (this.metronomeSubdivision === 'eighth') subdivisionMultiplier = 2;
                else if (this.metronomeSubdivision === 'sixteenth') subdivisionMultiplier = 4;
                else if (this.metronomeSubdivision === 'triplet') subdivisionMultiplier = 3;

                const interval = baseInterval / subdivisionMultiplier;

                const playClick = () => {
                    if (!this.metronomeRunning) return;

                    // Determinar si es acento (primer tiempo)
                    const isAccent = this.metronomeAccent && (this.metronomeCurrentBeat % (beats * subdivisionMultiplier) === 0);

                    // Reproducir sonido de click
                    const freq = isAccent ? 84 : 76; // Nota más alta para acento
                    const volume = isAccent ? 0.8 : 0.5;
                    AudioEngine.playMidiNote(freq, volume, 'sine', 0.05);

                    // Actualizar indicador visual
                    this.updateMetronomeVisual(beats, subdivisionMultiplier);

                    this.metronomeCurrentBeat++;
                    this.metronomeIntervalId = setTimeout(playClick, interval);
                };

                playClick();

                // Actualizar UI
                const btn = document.getElementById('metronomeBtn');
                if (btn) {
                    btn.classList.add('active');
                    btn.style.borderColor = '#dc2626';
                    btn.style.color = '#dc2626';
                }

                this.showToast(`Metrónomo: ${this.metronomeBPM} BPM - ${this.metronomeTimeSignature}`, 'success', 2000);
            },

            updateMetronomeVisual(beats, subdivisionMultiplier) {
                const indicator = document.getElementById('metronomeBeatIndicator');
                if (!indicator) return;

                const currentBeat = Math.floor((this.metronomeCurrentBeat % (beats * subdivisionMultiplier)) / subdivisionMultiplier) + 1;
                indicator.textContent = `${currentBeat}/${beats}`;

                // Parpadeo visual
                indicator.style.color = (this.metronomeCurrentBeat % (beats * subdivisionMultiplier) === 0) ? '#dc2626' : '#10b981';
            },

            tapTempo() {
                const now = Date.now();
                this.metronomeTapTimes.push(now);

                // Mantener solo últimos 4 taps
                if (this.metronomeTapTimes.length > 4) {
                    this.metronomeTapTimes.shift();
                }

                // Calcular BPM si hay al menos 2 taps
                if (this.metronomeTapTimes.length >= 2) {
                    const intervals = [];
                    for (let i = 1; i < this.metronomeTapTimes.length; i++) {
                        intervals.push(this.metronomeTapTimes[i] - this.metronomeTapTimes[i - 1]);
                    }
                    const avgInterval = intervals.reduce((a, b) => a + b) / intervals.length;
                    const bpm = Math.round(60000 / avgInterval);

                    // Limitar rango
                    this.metronomeBPM = Math.max(40, Math.min(240, bpm));

                    // Actualizar display
                    const display = document.getElementById('bpmDisplay');
                    if (display) display.textContent = this.metronomeBPM;

                    this.showToast(`Tap Tempo: ${this.metronomeBPM} BPM`, 'info', 1500);

                    // Reiniciar metrónomo si está corriendo
                    if (this.metronomeRunning) {
                        this.stopMetronome();
                        setTimeout(() => this.startMetronome(), 100);
                    }
                }

                // Resetear taps después de 2 segundos de inactividad
                setTimeout(() => {
                    if (Date.now() - this.metronomeTapTimes[this.metronomeTapTimes.length - 1] > 2000) {
                        this.metronomeTapTimes = [];
                    }
                }, 2000);
            },

            stopMetronome() {
                this.metronomeRunning = false;
                if (this.metronomeIntervalId) {
                    clearTimeout(this.metronomeIntervalId);
                    this.metronomeIntervalId = null;
                }

                // Actualizar UI
                const btn = document.getElementById('metronomeBtn');
                if (btn) {
                    btn.classList.remove('active');
                    btn.style.borderColor = '';
                    btn.style.color = '';
                }
            },

            showMetronomeSettings() {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black/80 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-void-800 border-2 border-void-600 rounded-lg p-6 max-w-md w-full mx-4">
                        <h3 class="text-xl font-display text-accent-400 mb-4">Configuración del Metrónomo</h3>

                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm text-void-300 mb-2">Compás</label>
                                <select id="timeSignatureSelect" class="w-full bg-void-900 border border-void-600 rounded px-3 py-2 text-white">
                                    <option value="2/4">2/4</option>
                                    <option value="3/4">3/4</option>
                                    <option value="4/4" selected>4/4</option>
                                    <option value="5/4">5/4</option>
                                    <option value="6/8">6/8</option>
                                    <option value="7/8">7/8</option>
                                    <option value="9/8">9/8</option>
                                    <option value="11/8">11/8</option>
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm text-void-300 mb-2">Subdivisión</label>
                                <select id="subdivisionSelect" class="w-full bg-void-900 border border-void-600 rounded px-3 py-2 text-white">
                                    <option value="quarter" selected>Cuartos (♩)</option>
                                    <option value="eighth">Octavos (♪)</option>
                                    <option value="sixteenth">Dieciseisavos (♬)</option>
                                    <option value="triplet">Tresillos (♪♪♪)</option>
                                </select>
                            </div>

                            <div class="flex items-center gap-3">
                                <span class="text-sm text-void-300">Acentuar primer tiempo</span>
                                <div class="toggle-switch ${this.metronomeAccent ? 'active' : ''}" id="accentToggle"></div>
                            </div>

                            <div>
                                <label class="block text-sm text-void-300 mb-2">Tempo (BPM)</label>
                                <div class="flex items-center gap-3">
                                    <span class="text-xs text-void-400">40</span>
                                    <input type="range"
                                        id="metronomeBPMSlider"
                                        min="40"
                                        max="240"
                                        value="120"
                                        step="1"
                                        class="flex-1 h-2 bg-void-900 border border-void-600 rounded-lg appearance-none cursor-pointer"
                                        style="accent-color: #dc2626;">
                                    <span class="text-xs text-void-400">240</span>
                                    <span id="metronomeBPMDisplay" class="text-2xl font-bold text-accent-400 w-14 text-center">120</span>
                                </div>
                            </div>
                        </div>

                        <div class="flex gap-3 mt-6">
                            <button class="btn-primary flex-1" id="applyMetronomeSettings">Aplicar</button>
                            <button class="btn-secondary flex-1" id="cancelMetronomeSettings">Cancelar</button>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);

                // Set current values
                document.getElementById('timeSignatureSelect').value = this.metronomeTimeSignature;
                document.getElementById('subdivisionSelect').value = this.metronomeSubdivision;

                // Event listeners
                document.getElementById('applyMetronomeSettings').addEventListener('click', () => {
                    this.metronomeTimeSignature = document.getElementById('timeSignatureSelect').value;
                    this.metronomeSubdivision = document.getElementById('subdivisionSelect').value;

                    // Restart metronome if running
                    if (this.metronomeRunning) {
                        this.stopMetronome();
                        setTimeout(() => this.startMetronome(), 100);
                    }

                    document.body.removeChild(modal);
                    this.showToast('Configuración guardada', 'success', 2000);
                });

                document.getElementById('cancelMetronomeSettings').addEventListener('click', () => {
                    document.body.removeChild(modal);
                });

                // Accent toggle
                document.getElementById('accentToggle').addEventListener('click', () => {
                    this.metronomeAccent = !this.metronomeAccent;
                    document.getElementById('accentToggle').classList.toggle('active');
                });

                // BPM slider con actualización en tiempo real
                const metronomeBpmSlider = document.getElementById('metronomeBPMSlider');
                const metronomeBpmDisplay = document.getElementById('metronomeBPMDisplay');
                if (metronomeBpmSlider && metronomeBpmDisplay) {
                    // Inicializar slider con BPM actual
                    metronomeBpmSlider.value = this.metronomeBPM;
                    metronomeBpmDisplay.textContent = this.metronomeBPM;

                    // Actualización en tiempo real al arrastrar
                    metronomeBpmSlider.addEventListener('input', (e) => {
                        const newBPM = parseInt(e.target.value);
                        this.metronomeBPM = newBPM;
                        metronomeBpmDisplay.textContent = newBPM;

                        // Actualizar display principal en el header
                        const mainBpmDisplay = document.getElementById('bpmDisplay');
                        if (mainBpmDisplay) mainBpmDisplay.textContent = newBPM;

                        // Reiniciar metrónomo si está corriendo
                        if (this.metronomeRunning) {
                            this.stopMetronome();
                            this.startMetronome();
                        }
                    });
                }

                // Close on backdrop click
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        document.body.removeChild(modal);
                    }
                });
            },

            adjustMetronomeBPM(delta) {
                this.metronomeBPM = Math.max(40, Math.min(240, this.metronomeBPM + delta));
                const bpmDisplay = document.getElementById('bpmDisplay');
                if (bpmDisplay) {
                    bpmDisplay.textContent = this.metronomeBPM;
                }

                // Reiniciar si está corriendo
                if (this.metronomeRunning) {
                    this.stopMetronome();
                    this.startMetronome();
                }
            },

            // Función para anunciar mensajes a lectores de pantalla
            announce(message) {
                const announcer = document.getElementById('sr-announcements');
                if (announcer) {
                    announcer.textContent = message;
                    setTimeout(() => {
                        announcer.textContent = '';
                    }, 1000);
                }
            },

            bindEvents() {
                // Root select
                const rootSelect = document.getElementById('rootSelect');
                if (rootSelect) {
                    rootSelect.addEventListener('change', (e) => {
                        this.currentRoot = parseInt(e.target.value);
                        this.refreshCurrentLevel();
                    });
                }

                // Tuning select
                const tuningSelect = document.getElementById('tuningSelect');
                if (tuningSelect) {
                    tuningSelect.addEventListener('change', (e) => {
                        Fretboard.setTuning(e.target.value);
                        this.refreshCurrentLevel();
                    });
                }

                // Toggle switches
                const notesToggle = document.getElementById('showNotesToggle');
                const functionsToggle = document.getElementById('showFunctionsToggle');

                if (notesToggle && functionsToggle) {
                    // Toggle con soporte de teclado y ARIA
                    const handleToggle = (toggle, updateFn) => {
                        const handler = (e) => {
                            if (e.type === 'keydown' && e.key !== 'Enter' && e.key !== ' ') return;
                            if (e.type === 'keydown') e.preventDefault();

                            toggle.classList.toggle('active');
                            const isActive = toggle.classList.contains('active');
                            toggle.setAttribute('aria-checked', isActive.toString());
                            updateFn(isActive);
                        };
                        toggle.addEventListener('click', handler);
                        toggle.addEventListener('keydown', handler);
                    };

                    handleToggle(notesToggle, (isActive) => {
                        Fretboard.showNoteNames = isActive;
                        Fretboard.updateDisplay();
                    });

                    handleToggle(functionsToggle, (isActive) => {
                        Fretboard.showFunctions = isActive;
                        Fretboard.updateDisplay();
                    });
                }

                // Metronome button
                const metronomeBtn = document.getElementById('metronomeBtn');
                if (metronomeBtn) {
                    metronomeBtn.addEventListener('click', () => {
                        this.toggleMetronome();
                    });

                    // Ajustar BPM con scroll en el botón
                    metronomeBtn.addEventListener('wheel', (e) => {
                        e.preventDefault();
                        const delta = e.deltaY > 0 ? -5 : 5;
                        this.adjustMetronomeBPM(delta);
                    });
                }

                // Tap Tempo button
                const tapTempoBtn = document.getElementById('tapTempoBtn');
                if (tapTempoBtn) {
                    tapTempoBtn.addEventListener('click', () => {
                        this.tapTempo();
                    });
                }

                // Metronome settings modal
                const metronomeSettingsBtn = document.getElementById('metronomeSettingsBtn');
                if (metronomeSettingsBtn) {
                    metronomeSettingsBtn.addEventListener('click', () => {
                        this.showMetronomeSettings();
                    });
                }

                // Level navigation buttons
                const levelBtns = document.querySelectorAll('.level-nav-btn');
                if (levelBtns.length > 0) {
                    levelBtns.forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const level = parseInt(e.currentTarget.dataset.level);
                            this.loadLevel(level);
                        });
                    });
                } else {
                    console.error('No level navigation buttons found');
                }
            },

            loadLevel(level) {
                console.log('[LoadLevel] Loading level:', level);
                this.currentLevel = level;

                // Cleanup backing track si está corriendo
                if (this.backingTrackPlaying) {
                    this.stopBackingTrack();
                }

                // Cleanup event listeners anteriores
                if (this.eventController) {
                    this.eventController.abort();
                }
                this.eventController = new AbortController();

                // Limpiar TODOS los contenedores de contenido dinámico
                this.clearAllContentContainers();

                // Update sidebar active state y ARIA
                document.querySelectorAll('.level-nav-btn').forEach(btn => {
                    const isActive = parseInt(btn.dataset.level) === level;
                    btn.classList.toggle('active', isActive);
                    if (isActive) {
                        btn.setAttribute('aria-current', 'page');
                    } else {
                        btn.removeAttribute('aria-current');
                    }
                });

                // Hide diagrams by default
                document.getElementById('diagramsContainer').classList.add('hidden');
                document.getElementById('boxSelector').classList.add('hidden');

                // Load appropriate template into control panel
                const controlPanel = document.getElementById('controlPanel');
                const templates = {
                    1: 'tpl-intervals',
                    2: 'tpl-scales',
                    3: 'tpl-chords',
                    4: 'tpl-modes',
                    5: 'tpl-pentatonics',
                    6: 'tpl-circle',
                    7: 'tpl-progressions',
                    8: 'tpl-seventh',
                    9: 'tpl-caged',
                    10: 'tpl-quiz',
                    11: 'tpl-extended',
                    12: 'tpl-secondary',
                    13: 'tpl-songs',
                    14: 'tpl-ear-training',
                    16: 'tpl-chord-lab',
                    15: 'tpl-jam-session',
                    17: 'tpl-lick-library'
                };

                const tplId = templates[level];
                const tpl = document.getElementById(tplId);

                // Manejo especial para Jam Session (nivel 15)
                if (level === 15) {
                    const jamSessionLayout = document.getElementById('jamSessionFullLayout');
                    const header = document.querySelector('header'); // Header principal
                    const mainFretboardArea = document.getElementById('mainFretboardArea');
                    const controlPanel = document.getElementById('controlPanel');

                    if (tpl && jamSessionLayout) {
                        console.log('[Jam Session] Loading template...');

                        // Ocultar header y área principal
                        if (header) header.style.display = 'none';
                        if (mainFretboardArea) mainFretboardArea.style.display = 'none';
                        if (controlPanel) controlPanel.style.display = 'none';

                        // Mostrar Jam Session
                        jamSessionLayout.innerHTML = '';
                        jamSessionLayout.appendChild(tpl.content.cloneNode(true));
                        jamSessionLayout.classList.add('active');

                        console.log('[Jam Session] Template loaded, classList:', jamSessionLayout.classList);

                        // IMPORTANTE: Llamar a showJamSession DESPUÉS de insertar el template
                        // Para que los elementos del DOM ya existan
                        this.bindLevelEvents(level);
                        this.showJamSession();
                        this.saveProgress();
                        return; // Salir temprano para nivel 15
                    }
                } else {
                    // Niveles normales: restaurar layout
                    const jamSessionLayout = document.getElementById('jamSessionFullLayout');
                    const header = document.querySelector('header');
                    const mainFretboardArea = document.getElementById('mainFretboardArea');
                    const controlPanel = document.getElementById('controlPanel');

                    // Ocultar Jam Session
                    if (jamSessionLayout) {
                        jamSessionLayout.classList.remove('active');
                    }

                    // Mostrar layout normal
                    if (header) header.style.display = 'flex';
                    if (mainFretboardArea) mainFretboardArea.style.display = 'flex';
                    if (controlPanel) controlPanel.style.display = 'block';

                    if (tpl) {
                        controlPanel.innerHTML = '';
                        controlPanel.appendChild(tpl.content.cloneNode(true));
                    }
                }

                // Bind events DESPUÉS de cargar el template (solo para niveles != 15)
                this.bindLevelEvents(level);
                this.refreshCurrentLevel();
                this.saveProgress();
            },

            bindLevelEvents(level) {
                const controlPanel = document.getElementById('controlPanel');

                switch(level) {
                    case 1: // Intervals
                        controlPanel.querySelectorAll('.interval-btn').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                controlPanel.querySelectorAll('.interval-btn').forEach(b => b.classList.remove('active'));
                                e.currentTarget.classList.add('active');
                                this.currentInterval = parseInt(e.currentTarget.dataset.interval);
                                this.showInterval();
                            });
                        });
                        // Set default active
                        controlPanel.querySelector(`[data-interval="${this.currentInterval}"]`)?.classList.add('active');
                        break;

                    case 2: // Scales
                        this.bindScaleEvents(controlPanel);
                        break;

                    case 3: // Chords
                        controlPanel.querySelectorAll('.chord-btn').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                controlPanel.querySelectorAll('.chord-btn').forEach(b => b.classList.remove('active'));
                                e.currentTarget.classList.add('active');
                                this.currentChord = parseInt(e.currentTarget.dataset.chord);
                                this.showChord();
                            });
                        });
                        break;

                    case 4: // Modes
                        controlPanel.querySelectorAll('.mode-btn-simple').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                controlPanel.querySelectorAll('.mode-btn-simple').forEach(b => b.classList.remove('active'));
                                e.currentTarget.classList.add('active');
                                this.currentMode = parseInt(e.currentTarget.dataset.mode);
                                this.showMode();
                            });
                        });
                        break;

                    case 5: // Pentatonics
                        controlPanel.querySelectorAll('[data-penta]').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                controlPanel.querySelectorAll('[data-penta]').forEach(b => b.classList.remove('active'));
                                e.currentTarget.classList.add('active');
                                this.currentPentatonic = e.currentTarget.dataset.penta;
                                this.showPentatonic();
                            });
                        });
                        controlPanel.querySelectorAll('[data-box]').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                controlPanel.querySelectorAll('[data-box]').forEach(b => b.classList.remove('active'));
                                e.currentTarget.classList.add('active');
                                this.currentBox = parseInt(e.currentTarget.dataset.box);
                                this.showPentatonic();
                            });
                        });
                        break;

                    case 6: // Circle of Fifths
                        this.renderCircleOfFifths();
                        break;

                    case 7: // Progressions
                        controlPanel.querySelectorAll('.progression-btn-simple').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                controlPanel.querySelectorAll('.progression-btn-simple').forEach(b => b.classList.remove('active'));
                                e.currentTarget.classList.add('active');
                                this.currentProgression = e.currentTarget.dataset.progression;
                                this.currentProgressionChordIndex = 0;
                                this.stopProgression(); // Detener reproducción si está activa
                                this.showProgression();
                            });
                        });

                        // Event listeners para controles de reproducción
                        document.getElementById('playProgressionBtn')?.addEventListener('click', async () => {
                            // Asegurar que el AudioContext esté activo
                            if (AudioEngine.audioContext && AudioEngine.audioContext.state === 'suspended') {
                                await AudioEngine.audioContext.resume();
                            }
                            this.playProgression();
                        });
                        document.getElementById('pauseProgressionBtn')?.addEventListener('click', () => {
                            this.pauseProgression();
                        });
                        document.getElementById('stopProgressionBtn')?.addEventListener('click', () => {
                            this.stopProgression();
                        });

                        // BPM slider
                        const progressionBpmSlider = document.getElementById('progressionBPMSlider');
                        const progressionBpmDisplay = document.getElementById('progressionBPMDisplay');
                        if (progressionBpmSlider && progressionBpmDisplay) {
                            progressionBpmSlider.value = this.progressionBPM;
                            progressionBpmDisplay.textContent = this.progressionBPM;
                            progressionBpmSlider.addEventListener('input', (e) => {
                                this.progressionBPM = parseInt(e.target.value);
                                progressionBpmDisplay.textContent = this.progressionBPM;
                            });
                        }

                        // Loop toggle
                        document.getElementById('progressionLoopToggle')?.addEventListener('change', (e) => {
                            this.progressionLoop = e.target.checked;
                        });

                        // Repeat count
                        document.getElementById('progressionRepeatInput')?.addEventListener('change', (e) => {
                            this.progressionRepeatCount = parseInt(e.target.value) || 1;
                        });

                        break;

                    case 8: // Seventh chords
                        controlPanel.querySelectorAll('[data-chord7]').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                controlPanel.querySelectorAll('[data-chord7]').forEach(b => b.classList.remove('active'));
                                e.currentTarget.classList.add('active');
                                this.currentChord7 = parseInt(e.currentTarget.dataset.chord7);
                                this.showSeventhChord();
                            });
                        });
                        break;

                    case 9: // CAGED
                        // Render SVG pentagon on load
                        this.renderCAGEDMap();

                        // Toggle para mostrar todas las formas
                        const cagedToggle = document.getElementById('cagedShowAllToggle');
                        if (cagedToggle) {
                            const toggleDot = document.getElementById('caged-toggle-dot');
                            cagedToggle.addEventListener('click', () => {
                                this.cagedShowAll = !this.cagedShowAll;
                                if (this.cagedShowAll) {
                                    cagedToggle.style.background = '#84cc16';
                                    toggleDot.style.transform = 'translateX(2.5rem)';
                                    this.renderAllCAGEDDiagrams();
                                    document.getElementById('caged-all-diagrams')?.classList.remove('hidden');
                                    this.showToast('Mostrando todas las formas CAGED', 'info');
                                } else {
                                    cagedToggle.style.background = '#333';
                                    toggleDot.style.transform = 'translateX(0.25rem)';
                                    document.getElementById('caged-all-diagrams')?.classList.add('hidden');
                                    this.showToast('Vista de forma individual', 'info');
                                }
                            });
                        }

                        // Tour CAGED button
                        document.getElementById('caged-tour-btn')?.addEventListener('click', () => {
                            this.playCAGEDTour();
                        });
                        break;

                    case 10: // Quiz
                        controlPanel.querySelectorAll('.quiz-cat-btn').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                controlPanel.querySelectorAll('.quiz-cat-btn').forEach(b => b.classList.remove('active'));
                                e.currentTarget.classList.add('active');
                                this.quizCategory = e.currentTarget.dataset.category;
                                this.generateQuizQuestion();
                            });
                        });
                        controlPanel.querySelectorAll('[data-diff]').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                controlPanel.querySelectorAll('[data-diff]').forEach(b => b.classList.remove('active'));
                                e.currentTarget.classList.add('active');
                                this.quizDifficulty = e.currentTarget.dataset.diff;
                                this.generateQuizQuestion();
                            });
                        });
                        document.getElementById('newQuizBtn')?.addEventListener('click', () => {
                            this.generateQuizQuestion();
                        });
                        break;

                    case 11: // Extended Chords
                        controlPanel.querySelectorAll('.ext-matrix-btn').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                controlPanel.querySelectorAll('.ext-matrix-btn').forEach(b => b.classList.remove('active'));
                                e.currentTarget.classList.add('active');
                                this.currentExtension = e.currentTarget.dataset.ext;
                                this.currentExtQuality = e.currentTarget.dataset.quality;
                                this.showExtendedChord();
                            });
                        });
                        break;

                    case 12: // Secondary Dominants
                        controlPanel.querySelectorAll('[data-secondary]').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                controlPanel.querySelectorAll('[data-secondary]').forEach(b => b.classList.remove('active'));
                                e.currentTarget.classList.add('active');
                                this.currentSecondary = e.currentTarget.dataset.secondary;
                                this.currentSecProg = null;
                                controlPanel.querySelectorAll('[data-secprog]').forEach(b => b.classList.remove('active'));
                                this.showSecondaryDominant();
                            });
                        });
                        controlPanel.querySelectorAll('[data-secprog]').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                controlPanel.querySelectorAll('[data-secprog]').forEach(b => b.classList.remove('active'));
                                e.currentTarget.classList.add('active');
                                this.currentSecProg = parseInt(e.currentTarget.dataset.secprog);
                                this.currentSecondary = null;
                                controlPanel.querySelectorAll('[data-secondary]').forEach(b => b.classList.remove('active'));
                                this.showSecondaryProgression();
                            });
                        });
                        break;

                    case 13: // Songs
                        controlPanel.querySelectorAll('[data-genre]').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                controlPanel.querySelectorAll('[data-genre]').forEach(b => b.classList.remove('active'));
                                e.currentTarget.classList.add('active');
                                this.songGenreFilter = e.currentTarget.dataset.genre;
                                this.renderSongList();
                            });
                        });
                        break;

                    case 14: // Ear Training
                        // Exercise type tabs
                        controlPanel.querySelectorAll('.ear-exercise-tab').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                controlPanel.querySelectorAll('.ear-exercise-tab').forEach(b => b.classList.remove('active'));
                                e.currentTarget.classList.add('active');
                                this.earExerciseType = e.currentTarget.dataset.exercise;
                                this.showEarTraining();
                            });
                        });

                        // Difficulty level
                        controlPanel.querySelectorAll('[data-ear-level]').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                controlPanel.querySelectorAll('[data-ear-level]').forEach(b => b.classList.remove('active'));
                                e.currentTarget.classList.add('active');
                                this.earTrainingLevel = e.currentTarget.dataset.earLevel;
                                this.showEarTraining();
                            });
                        });

                        // Play button
                        document.getElementById('playIntervalBtn')?.addEventListener('click', () => {
                            this.playCurrentInterval();
                        });

                        // Next button
                        document.getElementById('newIntervalBtn')?.addEventListener('click', () => {
                            this.showEarTraining();
                        });

                        // Answer buttons (delegated)
                        const answersPanel = document.getElementById('earTrainingAnswers');
                        if (answersPanel) {
                            answersPanel.addEventListener('click', (e) => {
                                const btn = e.target.closest('.mode-btn-simple');
                                if (btn && !btn.disabled) {
                                    const answer = btn.dataset.answer;
                                    // Convert to appropriate type
                                    const typedAnswer = !isNaN(answer) ? parseInt(answer) : answer;
                                    this.checkEarTrainingAnswer(typedAnswer);
                                }
                            });
                        }
                        break;

                    case 15: // Jam Session
                        // Track cards (delegated event)
                        const trackGrid = document.getElementById('jamTrackGrid');
                        if (trackGrid) {
                            trackGrid.addEventListener('click', (e) => {
                                const card = e.target.closest('.jam-track-item');
                                if (!card) return;

                                const trackId = card.dataset.track;
                                this.currentBackingTrack = MusicTheory.backingTracks.find(t => t.id === trackId);

                                // Resetear BPM custom al cambiar track
                                this.customBPM = null;
                                let bpmSliderEl = document.getElementById('bpmSlider');
                                let bpmDisplayEl = document.getElementById('jamBpmDisplay');
                                if (bpmSliderEl && this.currentBackingTrack) {
                                    const bpm = this.syncMetronomeWithBacking ? this.globalBPM : this.currentBackingTrack.bpm;
                                    bpmSliderEl.value = bpm;
                                    if (bpmDisplayEl) bpmDisplayEl.textContent = bpm;
                                }

                                this.showJamSession();
                            });
                        }

                        // Selector de tonalidad
                        const keySelector = document.getElementById('jamKeySelector');
                        if (keySelector) {
                            keySelector.value = this.currentRoot;
                            keySelector.addEventListener('change', (e) => {
                                this.currentRoot = parseInt(e.target.value);
                                this.showJamSession();

                                // Si está tocando, reiniciar con nueva tonalidad
                                if (this.backingTrackPlaying) {
                                    this.changeBackingTrackBPM(this.customBPM || this.currentBackingTrack.bpm);
                                }
                            });
                        }

                        document.getElementById('playTrackBtn')?.addEventListener('click', () => {
                            this.playBackingTrack();
                        });

                        document.getElementById('stopTrackBtn')?.addEventListener('click', () => {
                            this.stopBackingTrack();
                        });

                        // Toggle de sincronización BPM
                        const syncToggle = document.getElementById('syncBPMToggle');
                        if (syncToggle) {
                            const syncSlider = syncToggle.parentElement?.querySelector('.slider-sync');
                            const syncDot = syncToggle.parentElement?.querySelector('.dot-sync');

                            syncToggle.checked = this.syncMetronomeWithBacking;
                            if (this.syncMetronomeWithBacking && syncSlider && syncDot) {
                                syncSlider.style.background = '#10b981';
                                syncDot.style.transform = 'translateX(24px)';
                            } else if (syncSlider && syncDot) {
                                syncSlider.style.background = '#333';
                                syncDot.style.transform = 'translateX(0)';
                            }

                            syncToggle.addEventListener('change', (e) => {
                                this.syncMetronomeWithBacking = e.target.checked;
                                if (this.syncMetronomeWithBacking) {
                                    if (syncSlider) syncSlider.style.background = '#10b981';
                                    if (syncDot) syncDot.style.transform = 'translateX(24px)';

                                    // Actualizar BPM al global
                                    let bpmSliderEl2 = document.getElementById('bpmSlider');
                                    let bpmDisplayEl2 = document.getElementById('jamBpmDisplay');
                                    if (bpmSliderEl2) bpmSliderEl2.value = this.globalBPM;
                                    if (bpmDisplayEl2) bpmDisplayEl2.textContent = this.globalBPM;
                                    this.customBPM = null;
                                } else {
                                    if (syncSlider) syncSlider.style.background = '#333';
                                    if (syncDot) syncDot.style.transform = 'translateX(0)';
                                }
                            });
                        }

                        // BPM Slider con debounce
                        const bpmSlider = document.getElementById('bpmSlider');
                        const bpmDisplay = document.getElementById('jamBpmDisplay');
                        let bpmChangeTimeout = null;

                        if (bpmSlider && bpmDisplay) {
                            const updateBPM = (e) => {
                                const newBPM = parseInt(e.target.value);
                                bpmDisplay.textContent = newBPM;
                                // Forzar estilos inline
                                bpmDisplay.style.cssText = 'color: #dc2626 !important; font-size: 14px !important; font-weight: 600 !important; display: inline-block !important; min-width: 40px !important; text-align: center !important; opacity: 1 !important; visibility: visible !important;';

                                // Actualizar BPM inmediatamente en UI
                                if (this.syncMetronomeWithBacking) {
                                    this.globalBPM = newBPM;
                                    this.metronomeBPM = newBPM;
                                } else {
                                    this.customBPM = newBPM;
                                }

                                // Debounce para aplicar cambio
                                if (bpmChangeTimeout) clearTimeout(bpmChangeTimeout);
                                bpmChangeTimeout = setTimeout(() => {
                                    if (this.backingTrackPlaying) {
                                        this.changeBackingTrackBPM(newBPM);
                                    }
                                }, 300);
                            };

                            bpmSlider.addEventListener('input', updateBPM);
                            bpmSlider.addEventListener('change', updateBPM);

                            // NOTA: La inicialización del BPM se hace en renderJamSessionPanel
                        }

                        // Drums Toggle
                        const drumsToggle = document.getElementById('drumsToggle');
                        if (drumsToggle) {
                            const slider = drumsToggle.nextElementSibling;
                            const dot = slider?.querySelector('.dot');

                            drumsToggle.addEventListener('change', (e) => {
                                this.drumsEnabled = e.target.checked;

                                if (slider && dot) {
                                    if (this.drumsEnabled) {
                                        slider.style.background = '#dc2626';
                                        dot.style.transform = 'translateX(24px)';
                                    } else {
                                        slider.style.background = '#404040';
                                        dot.style.transform = 'translateX(0)';
                                    }
                                }

                                // Si está reproduciendo, reiniciar con/sin batería
                                if (this.backingTrackPlaying) {
                                    this.stopBackingTrack();
                                    setTimeout(() => this.playBackingTrack(), 100);
                                }
                            });
                        }
                        break;

                    case 16: // Chord Lab
                        // Mode tabs
                        controlPanel.querySelectorAll('.chord-lab-mode-btn').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                controlPanel.querySelectorAll('.chord-lab-mode-btn').forEach(b => b.classList.remove('active'));
                                e.currentTarget.classList.add('active');
                                ChordLabState.currentMode = e.currentTarget.dataset.mode;
                                this.showChordLabMode();
                            });
                        });

                        // Root selector
                        document.getElementById('chord-lab-root')?.addEventListener('change', (e) => {
                            ChordLabState.currentRoot = e.target.value;
                            this.renderChordLabVoicings();
                        });

                        // Quality buttons
                        controlPanel.querySelectorAll('.chord-lab-quality-btn').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                controlPanel.querySelectorAll('.chord-lab-quality-btn').forEach(b => b.classList.remove('active'));
                                e.currentTarget.classList.add('active');
                                ChordLabState.currentQuality = e.currentTarget.dataset.quality;
                                this.renderChordLabVoicings();
                            });
                        });


                        // Comparison controls
                        document.getElementById('chord-lab-play-both')?.addEventListener('click', () => {
                            this.playChordLabComparison();
                        });

                        document.getElementById('chord-lab-clear-comparison')?.addEventListener('click', () => {
                            this.clearChordLabComparison();
                        });

                        // Exercise buttons
                        controlPanel.querySelectorAll('.chord-lab-exercise-btn').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                const exercise = e.currentTarget.dataset.exercise;
                                this.startChordLabExercise(exercise);
                            });
                        });

                        // Progression Builder: Initial chord selector
                        controlPanel.querySelectorAll('.initial-chord-btn').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                const chord = e.currentTarget.dataset.chord;
                                const quality = e.currentTarget.dataset.quality;
                                this.selectInitialChord(chord, quality);
                            });
                        });

                        // Progression Builder: Emotion selector
                        controlPanel.querySelectorAll('.emotion-btn').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                const emotion = e.currentTarget.dataset.emotion;
                                this.selectEmotion(emotion);
                            });
                        });

                        // Progression Builder: Play progression
                        document.getElementById('play-progression')?.addEventListener('click', () => {
                            this.playProgression();
                        });

                        // Progression Builder: Clear progression
                        document.getElementById('clear-progression')?.addEventListener('click', () => {
                            this.clearProgression();
                        });

                        // Progression Builder: Sub-mode tabs
                        controlPanel.querySelectorAll('.progression-mode-btn').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                const submode = e.currentTarget.dataset.submode;
                                this.showProgressionSubMode(submode);
                            });
                        });

                        // Progression Builder: Save progression
                        document.getElementById('save-progression')?.addEventListener('click', () => {
                            this.saveProgression();
                        });

                        // Progression Builder: Load progression
                        document.getElementById('load-progression')?.addEventListener('click', () => {
                            this.showLoadProgressionDialog();
                        });

                        // Progression Builder: Transpose
                        document.getElementById('transpose-progression')?.addEventListener('click', () => {
                            this.transposeProgressionDialog();
                        });

                        // Progression Builder: Reverse
                        document.getElementById('reverse-progression')?.addEventListener('click', () => {
                            this.reverseProgression();
                        });

                        // Progression Builder: Mutate
                        document.getElementById('mutate-progression')?.addEventListener('click', () => {
                            this.mutateProgression();
                        });

                        // Free mode key selector
                        document.getElementById('free-mode-key')?.addEventListener('change', () => {
                            this.renderFreeModeChordPalette();
                        });

                        // Chord Builder: Play button
                        document.getElementById('chord-builder-play')?.addEventListener('click', () => {
                            this.playChordBuilder();
                        });

                        // Chord Builder: Clear button
                        document.getElementById('chord-builder-clear')?.addEventListener('click', () => {
                            this.clearChordBuilder();
                        });

                        // Chord Builder: Save button
                        document.getElementById('chord-builder-save')?.addEventListener('click', () => {
                            this.saveChordBuilderVoicing();
                        });

                        // Chord Builder: Famous voicings
                        document.querySelectorAll('#chord-builder-famous button').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                const voicingKey = e.currentTarget.dataset.voicing;
                                this.loadFamousVoicing(voicingKey);
                            });
                        });

                        // CAGED Tour button
                        document.getElementById('caged-tour-btn')?.addEventListener('click', () => {
                            this.playCAGEDTour();
                        });

                        // Initialize
                        this.showChordLabMode();
                        break;

                    case 17: // Lick Library
                        // Filter dropdowns
                        document.getElementById('lickGenreFilter')?.addEventListener('change', (e) => {
                            this.lickFilters.genre = e.target.value;
                            this.renderLickGrid();
                        });

                        document.getElementById('lickTechniqueFilter')?.addEventListener('change', (e) => {
                            this.lickFilters.technique = e.target.value;
                            this.renderLickGrid();
                        });

                        document.getElementById('lickDifficultyFilter')?.addEventListener('change', (e) => {
                            this.lickFilters.difficulty = e.target.value;
                            this.renderLickGrid();
                        });

                        // Lick card clicks (delegated)
                        const lickGrid = document.getElementById('lickGrid');
                        if (lickGrid) {
                            lickGrid.addEventListener('click', (e) => {
                                const card = e.target.closest('.lick-card');
                                if (card) {
                                    const lickId = card.dataset.lickId;
                                    this.showLickDetail(lickId);
                                }
                            });
                        }

                        // Modal close
                        const modalClose = document.querySelector('.lick-modal-close');
                        if (modalClose) {
                            modalClose.addEventListener('click', () => {
                                const modal = document.getElementById('lickDetailModal');
                                if (modal) modal.classList.add('hidden');
                                if (this.lickPlaybackInterval) {
                                    clearInterval(this.lickPlaybackInterval);
                                    this.lickPlaybackInterval = null;
                                }
                            });
                        }

                        // Tab playback controls (delegated)
                        controlPanel.addEventListener('click', (e) => {
                            // Play button
                            if (e.target.classList.contains('tab-play-btn')) {
                                if (this.currentLick) {
                                    const tempoSlider = document.querySelector('.tempo-slider');
                                    const bpm = tempoSlider ? parseInt(tempoSlider.value) : this.currentLick.bpm;
                                    AudioEngine.playTabLine(this.currentLick.tabs, bpm, 1);
                                }
                            }

                            // Loop button
                            if (e.target.classList.contains('tab-loop-btn')) {
                                if (this.currentLick) {
                                    const tempoSlider = document.querySelector('.tempo-slider');
                                    const bpm = tempoSlider ? parseInt(tempoSlider.value) : this.currentLick.bpm;

                                    // Stop previous loop
                                    if (this.lickPlaybackInterval) {
                                        clearInterval(this.lickPlaybackInterval);
                                    }

                                    // Start new loop
                                    this.lickPlaybackInterval = AudioEngine.playTabLine(this.currentLick.tabs, bpm, 999);
                                    e.target.textContent = '⏹ Stop Loop';
                                    e.target.classList.add('active');

                                    // Toggle off after click
                                    setTimeout(() => {
                                        e.target.textContent = '🔁 Loop';
                                        e.target.classList.remove('active');
                                    }, 300);
                                }
                            }
                        });

                        // Tempo slider
                        controlPanel.addEventListener('input', (e) => {
                            if (e.target.classList.contains('tempo-slider')) {
                                const tempoValue = e.target.parentElement.querySelector('.tempo-value');
                                if (tempoValue) {
                                    tempoValue.textContent = e.target.value;
                                }
                            }
                        });
                        break;
                }
            },

            bindScaleEvents(container) {
                // Category buttons
                container.querySelectorAll('.scale-cat-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        container.querySelectorAll('.scale-cat-btn').forEach(b => b.classList.remove('active'));
                        e.currentTarget.classList.add('active');
                        this.currentScaleCategory = e.currentTarget.dataset.category;
                        this.renderScaleButtons(container);
                    });
                });

                this.renderScaleButtons(container);
            },

            renderScaleButtons(container) {
                const scaleList = container.querySelector('#scaleListMain');
                if (!scaleList) return;

                const scales = this.CATEGORY_SCALES[this.currentScaleCategory] || [];
                scaleList.innerHTML = '';

                scales.forEach(scaleKey => {
                    const btn = document.createElement('button');
                    btn.className = `mode-btn-simple ${scaleKey === this.currentScale ? 'active' : ''}`;
                    btn.dataset.scale = scaleKey;
                    btn.textContent = this.SCALE_NAMES[scaleKey] || scaleKey;
                    btn.addEventListener('click', () => {
                        scaleList.querySelectorAll('.mode-btn-simple').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        this.currentScale = scaleKey;
                        this.showScale();
                    });
                    scaleList.appendChild(btn);
                });
            },

            refreshCurrentLevel() {
                console.log('[RefreshLevel] Refreshing level:', this.currentLevel);
                switch(this.currentLevel) {
                    case 1: this.showIntervals(); break;
                    case 2: this.showScale(); break;
                    case 3: this.showHarmonization(); break;
                    case 4: this.showMode(); break;
                    case 5: this.showPentatonic(); break;
                    case 6: this.showCircleOfFifths(); break;
                    case 7: this.showProgressions(); break;
                    case 8: this.showSeventhChords(); break;
                    case 9: this.showCAGEDShape(); break;
                    case 10: this.showQuiz(); break;
                    case 11: this.showExtendedChord(); break;
                    case 12: this.showSecondaryDominant(); break;
                    case 13: this.showSongs(); break;
                    case 14: this.showEarTraining(); break;
                    case 15: this.showJamSession(); break;
                    case 16: this.showChordLab(); break;
                    case 17: this.showLickLibrary(); break;
                    default: this.showScale();
                }
            },

            showScale() {
                const rootName = MusicTheory.getNoteName(this.currentRoot);
                const info = MusicTheory.scaleInfo[this.currentScale];

                // Hide diagrams and box selector for regular scale view
                document.getElementById('diagramsContainer').classList.add('hidden');
                document.getElementById('boxSelector').classList.add('hidden');

                Fretboard.showScale(this.currentRoot, this.currentScale);

                const noteCount = MusicTheory.scales[this.currentScale].length;
                document.getElementById('displayTitle').textContent =
                    `Escala de ${rootName} ${this.SCALE_NAMES[this.currentScale] || this.currentScale}`;
                document.getElementById('displaySubtitle').textContent =
                    `${noteCount} notas - Fórmula: ${MusicTheory.scales[this.currentScale].map(i => MusicTheory.intervalNames[i]).join(' - ')}`;

                // Show detailed scale info panel
                this.showScaleInfoPanel(info, this.currentScale);
            },

            showScaleInfoPanel(info, scaleKey) {
                const panel = document.getElementById('infoPanel');
                if (!panel) return;

                if (!info) {
                    panel.innerHTML = '';
                    return;
                }

                // Generate brightness bar (0-7 scale, Locrio=0, Lidio=7)
                const brightness = info.brightness !== undefined ? info.brightness : 4;
                const brightnessPercent = (brightness / 7) * 100;
                const brightnessLabels = ['Muy Oscuro', 'Oscuro', 'Semi-Oscuro', 'Neutral', 'Semi-Brillante', 'Brillante', 'Muy Brillante', 'Máximo Brillo'];
                const brightnessLabel = brightnessLabels[brightness] || 'Neutral';

                // Generate usage context tags
                const usageContextHTML = info.usageContext ?
                    info.usageContext.map(ctx => `<span class="context-tag">${ctx}</span>`).join('')
                    : '';

                // Generate characteristic note display
                const charNote = info.characteristicNote || '-';

                // Build the panel HTML with new styling
                panel.innerHTML = `
                    <div class="scale-info-box">
                        <!-- Header with emotion -->
                        <div class="info-header">
                            <div class="info-title">${info.name || scaleKey}</div>
                            <div class="info-emotion">"${info.emotion || ''}"</div>
                        </div>

                        <!-- Main info grid -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Left column -->
                            <div class="space-y-3">
                                <!-- Brightness meter -->
                                <div class="info-section">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="info-label" style="margin-bottom: 0;">Brillo Modal</span>
                                        <span class="info-value" style="font-size: 13px; color: #d4a574;">${brightness}/7 - ${brightnessLabel}</span>
                                    </div>
                                    <div class="brightness-bar">
                                        <div class="brightness-fill" style="width: ${brightnessPercent}%;"></div>
                                    </div>
                                    <div class="flex justify-between mt-2" style="font-size: 10px; color: #666;">
                                        <span>Locrio</span>
                                        <span>Lidio</span>
                                    </div>
                                </div>

                                <!-- Characteristic Note -->
                                <div class="info-section accent">
                                    <div class="info-label">Nota Característica</div>
                                    <div class="info-value highlight" style="font-size: 22px;">${charNote}</div>
                                    <div class="info-description">El intervalo que define su sonido único</div>
                                </div>

                                <!-- Formula -->
                                <div class="info-section">
                                    <div class="info-label">Fórmula Interválica</div>
                                    <div class="info-value" style="font-size: 14px; letter-spacing: 2px;">${info.formula || '-'}</div>
                                </div>
                            </div>

                            <!-- Right column -->
                            <div class="space-y-3">
                                <!-- Usage -->
                                <div class="info-section">
                                    <div class="info-label">Uso Práctico</div>
                                    <p style="font-family: 'Barlow Condensed', sans-serif; font-size: 14px; color: #ccc; line-height: 1.6;">${info.usage || ''}</p>
                                </div>

                                <!-- Usage Context Tags -->
                                <div class="info-section">
                                    <div class="info-label">Estilos y Contextos</div>
                                    <div class="flex flex-wrap" style="margin-top: 8px;">${usageContextHTML || '<span style="color: #666; font-size: 13px;">-</span>'}</div>
                                </div>

                                ${info.parentScale ? `
                                <!-- Parent Scale Info -->
                                <div class="parent-scale-box">
                                    <div class="info-label" style="color: #dc2626;">Escala Madre</div>
                                    <p style="font-family: 'Barlow Condensed', sans-serif; font-size: 14px; color: #ccc;">
                                        Deriva del grado <span style="font-weight: 700; color: #dc2626;">${info.degree || '?'}</span>
                                        de la escala <span style="font-weight: 700; color: #dc2626;">${MusicTheory.scaleInfo[info.parentScale]?.name || info.parentScale}</span>
                                    </p>
                                </div>
                                ` : ''}
                            </div>
                        </div>

                        <!-- Chord construction explanation -->
                        ${info.chordTypes ? `
                        <div style="border-top: 1px solid #333; padding-top: 16px; margin-top: 16px;">
                            <div class="info-label">Armonización - Cómo nacen los acordes</div>
                            <p style="font-family: 'Barlow Condensed', sans-serif; font-size: 12px; color: #666; margin: 8px 0 12px 0;">Cada grado de la escala genera un acorde al apilar terceras. El tipo depende de los intervalos disponibles.</p>
                            <div class="flex flex-wrap gap-2" id="harmonizationChords">
                                ${info.chordTypes.map((type, i) => {
                                    const romanNumerals = ['I', 'ii', 'iii', 'IV', 'V', 'vi', 'vii°'];
                                    const typeName = type === 'maj' ? 'Mayor' : type === 'min' ? 'menor' : type === 'dim' ? 'dim' : type === 'aug' ? 'aug' : type;
                                    return `<button class="harm-chord-btn type-${type}" data-degree="${i + 1}" data-quality="${type}">
                                        <div style="font-size: 15px; font-weight: 700;">${romanNumerals[i] || (i+1)}</div>
                                        <div class="chord-quality">${typeName}</div>
                                    </button>`;
                                }).join('')}
                            </div>
                        </div>
                        ` : ''}
                    </div>
                `;

                // Bind chord click events
                setTimeout(() => {
                    const container = document.getElementById('harmonizationChords');
                    if (container) {
                        container.querySelectorAll('[data-degree]').forEach(btn => {
                            btn.addEventListener('click', () => {
                                const degree = parseInt(btn.dataset.degree);
                                this.showHarmonizationChord(scaleKey, degree);
                            });
                        });
                    }
                }, 0);
            },

            showHarmonizationChord(scaleKey, degree) {
                const harmonization = MusicTheory.getScaleHarmonization(this.currentRoot, scaleKey);
                if (!harmonization || !harmonization[degree - 1]) return;

                const chord = harmonization[degree - 1];
                const chordRootIndex = MusicTheory.getNoteIndex(chord.root);
                const qualityNames = { maj: 'Mayor', min: 'menor', dim: 'disminuido', aug: 'aumentado' };

                // Keep the scale visible, just highlight chord tones
                Fretboard.showScale(this.currentRoot, scaleKey);

                // Set chord highlight for the chord tones
                Fretboard.chordHighlight = new Set([
                    MusicTheory.getNoteIndex(chord.root),
                    MusicTheory.getNoteIndex(chord.third),
                    MusicTheory.getNoteIndex(chord.fifth)
                ]);
                Fretboard.updateDisplay();

                // Show chord diagram if available
                const voicingKey = chord.quality === 'min' ? chord.root + 'm' : chord.root;
                let voicing = MusicTheory.chordVoicings[voicingKey];
                let position = 0;

                if (!voicing && (chord.quality === 'maj' || chord.quality === 'min')) {
                    const shape = chord.quality === 'min' ? 'E_shape_minor' : 'E_shape_major';
                    voicing = MusicTheory.chordVoicings[shape];
                    position = (chordRootIndex - 4 + 12) % 12;
                }

                const diagramContainer = document.getElementById('diagramsContainer');
                if (diagramContainer && voicing) {
                    diagramContainer.innerHTML = '';
                    diagramContainer.classList.remove('hidden');
                    const chordSuffix = chord.quality === 'min' ? 'm' : chord.quality === 'dim' ? '°' : chord.quality === 'aug' ? '+' : '';
                    const chordName = chord.root + chordSuffix;
                    const diagram = ChordDiagram.create(voicing, chordName, position);
                    diagramContainer.appendChild(diagram);
                } else if (diagramContainer) {
                    diagramContainer.classList.add('hidden');
                }

                const rootName = MusicTheory.getNoteName(this.currentRoot);
                const info = MusicTheory.scaleInfo[scaleKey];
                const chordSuffix = chord.quality === 'min' ? 'm' : chord.quality === 'dim' ? '°' : chord.quality === 'aug' ? '+' : '';
                const romanNumerals = ['I', 'ii', 'iii', 'IV', 'V', 'vi', 'vii°'];

                this.updateDisplay(
                    `${romanNumerals[degree - 1]} - ${chord.root}${chordSuffix} (${qualityNames[chord.quality] || chord.quality})`,
                    `Grado ${degree} de ${rootName} ${info?.name || scaleKey} | Notas: ${chord.root} - ${chord.third} - ${chord.fifth}`
                );
            },

            showIntervals() {
                console.log('[ShowIntervals] currentInterval:', this.currentInterval);
                try {
                    this.resetState(['currentInterval']);
                    this.hideUIElements();
                    if (this.currentInterval === null) {
                        this.currentInterval = 4;
                        document.querySelector('[data-interval="4"]')?.classList.add('active');
                    }
                    this.showInterval();
                } catch (error) {
                    console.error('[ShowIntervals] Error:', error);
                }
            },

            showInterval() {
                console.log('[ShowInterval] root:', this.currentRoot, 'interval:', this.currentInterval);
                try {
                    const rootName = MusicTheory.getNoteName(this.currentRoot);
                const intervalName = MusicTheory.intervalNames[this.currentInterval];
                const targetNote = MusicTheory.getNoteName(this.currentRoot + this.currentInterval);

                Fretboard.clearZone();
                Fretboard.showInterval(this.currentRoot, this.currentInterval);

                // Also show descending interval
                const descendingNote = MusicTheory.getNoteName((this.currentRoot - this.currentInterval + 12) % 12);
                const descendingSemitones = 12 - this.currentInterval;

                this.updateDisplay(
                    `${intervalName} desde ${rootName}`,
                    `Ascendente: ${rootName} → ${targetNote} (${this.currentInterval} st) | Descendente: ${rootName} → ${descendingNote} (${descendingSemitones} st)`
                );
                this.showIntervalInfo(this.currentInterval);
                } catch (error) {
                    console.error('[ShowInterval] Error:', error);
                }
            },

            showMajorScale() {
                this.resetState();
                this.currentScale = 'major';
                const scaleSelect = document.getElementById('scaleSelect');
                if (scaleSelect) scaleSelect.value = 'major';
                this.showScale();
            },

            showHarmonization() {
                this.resetState(['currentChord']);
                if (this.currentChord === null) {
                    this.currentChord = 1;
                    document.querySelector('[data-chord="1"]')?.classList.add('active');
                }
                this.showChord();
            },

            showChord() {
                const triad = MusicTheory.getTriad(this.currentRoot, 'major', this.currentChord);
                const rootName = MusicTheory.getNoteName(this.currentRoot);
                const chordRoot = triad.root.note;

                const qualityNames = { maj: 'Mayor', min: 'menor', dim: 'disminuido' };
                const harmonicFunctions = {
                    1: 'Tónica (reposo, estabilidad)',
                    2: 'Subdominante (movimiento suave)',
                    3: 'Tónica / Dominante (ambiguo)',
                    4: 'Subdominante (tensión media)',
                    5: 'Dominante (máxima tensión)',
                    6: 'Tónica menor (reposo menor)',
                    7: 'Dominante (tensión extrema por tritono)'
                };
                const tensions = {
                    1: '9, #11 (lidio), 13',
                    2: '9, 11, 13',
                    3: '11 (b9 evitada)',
                    4: '9, #11 (lidio), 13',
                    5: '9, b9, #9, #11, 13, b13',
                    6: '9, 11 (b13 evitada)',
                    7: '11, b13'
                };
                const voicingKey = triad.quality === 'min' ? `${chordRoot}m` : chordRoot;

                // Show chord diagram
                const diagramContainer = document.getElementById('diagramsContainer');
                diagramContainer.innerHTML = '';
                diagramContainer.classList.remove('hidden');

                // Get voicing - use open chord if available, otherwise barre
                let voicing = MusicTheory.chordVoicings[voicingKey];
                let position = 0;

                if (!voicing) {
                    // Use barre chord shape - E shape root is on 6th string (E = index 4)
                    const shape = triad.quality === 'min' ? 'E_shape_minor' : 'E_shape_major';
                    voicing = MusicTheory.chordVoicings[shape];
                    // Calculate position: distance from E (4) to target note
                    const targetIndex = MusicTheory.getNoteIndex(chordRoot);
                    position = (targetIndex - 4 + 12) % 12;
                }

                const chordName = triad.quality === 'min' ? `${chordRoot}m` : chordRoot;
                const diagram = ChordDiagram.create(voicing, chordName, position);
                diagramContainer.appendChild(diagram);

                // Show chord notes on fretboard with zone
                Fretboard.tonicNote = MusicTheory.getNoteIndex(chordRoot);
                Fretboard.currentScale = [
                    { note: triad.root.note, degree: 1 },
                    { note: triad.third.note, degree: 3 },
                    { note: triad.fifth.note, degree: 5 }
                ];
                Fretboard.highlightedNotes.clear();
                Fretboard.setZone(position, position + 4);
                Fretboard.specificPositions = null;
                Fretboard.updateDisplay();

                this.updateDisplay(
                    `${triad.roman} de ${rootName} Mayor: ${chordName} ${qualityNames[triad.quality]}`,
                    `Notas: ${triad.root.note} (T) - ${triad.third.note} (3ª) - ${triad.fifth.note} (5ª) | ${harmonicFunctions[this.currentChord]}`
                );
                document.getElementById('boxSelector').classList.add('hidden');

                // Show function and tension info
                const panel = document.getElementById('infoPanel');
                if (panel) {
                    panel.innerHTML = `
                        <div class="scale-info-box">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="info-section accent">
                                    <div class="info-label">Función Armónica</div>
                                    <div class="info-value" style="font-size: 15px;">${harmonicFunctions[this.currentChord]}</div>
                                </div>
                                <div class="info-section">
                                    <div class="info-label">Tensiones Disponibles</div>
                                    <div class="info-value" style="font-size: 15px;">${tensions[this.currentChord]}</div>
                                    <div class="info-description" style="margin-top: 4px;">Notas que se pueden añadir al acorde para enriquecerlo</div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            },

            showModes() {
                this.resetState(['currentMode']);
                this.hideUIElements();
                if (this.currentMode === null) {
                    this.currentMode = 1;
                    document.querySelector('[data-mode="1"]')?.classList.add('active');
                }
                this.showMode();
            },

            showMode() {
                const modeNames = ['Jónico', 'Dórico', 'Frigio', 'Lidio', 'Mixolidio', 'Eólico', 'Locrio'];
                const scaleTypes = ['major', 'dorian', 'phrygian', 'lydian', 'mixolydian', 'minor', 'locrian'];
                const romanNumerals = ['I', 'II', 'III', 'IV', 'V', 'VI', 'VII'];
                const charChords = ['Imaj7', 'IVmaj7 (lydian chord)', 'bIImaj7', 'IImaj7', 'bVIImaj7', 'bIIImaj7', 'bVmaj7'];
                const modeExamples = [
                    'Happy Birthday, Twinkle Twinkle',
                    'So What (Miles Davis), Scarborough Fair',
                    'White Rabbit (Jefferson Airplane), flamenco',
                    'Flying (E.T.), The Simpsons Theme',
                    'Norwegian Wood (Beatles), Sweet Home Alabama',
                    'Stairway to Heaven, All Along the Watchtower',
                    'Raro en uso melódico. YYZ (Rush) en pasajes'
                ];

                const rootName = MusicTheory.getNoteName(this.currentRoot);
                this.currentScale = scaleTypes[this.currentMode - 1];

                Fretboard.showScale(this.currentRoot, this.currentScale);

                const scaleSelect = document.getElementById('scaleSelect');
                if (scaleSelect) scaleSelect.value = this.currentScale;

                // Determine what note changes vs Jónico
                const majorFormula = MusicTheory.scales['major'];
                const modeFormula = MusicTheory.scales[this.currentScale];
                const differences = [];
                for (let i = 0; i < Math.min(majorFormula.length, modeFormula.length); i++) {
                    if (majorFormula[i] !== modeFormula[i]) {
                        const diff = modeFormula[i] - majorFormula[i];
                        differences.push(`grado ${i+1}: ${diff > 0 ? '+' : ''}${diff} st`);
                    }
                }
                const diffText = differences.length > 0 ? differences.join(', ') : 'Igual al Jónico (Mayor)';

                this.updateDisplay(
                    `${rootName} ${modeNames[this.currentMode - 1]}`,
                    `Modo ${this.currentMode} - Grado ${romanNumerals[this.currentMode - 1]} | Acorde característico: ${charChords[this.currentMode - 1]}`
                );
                // Mostrar info del modo
                const info = MusicTheory.scaleInfo[this.currentScale];
                this.showScaleInfoPanel(info, this.currentScale);

                // Add mode comparison below the info panel
                const panel = document.getElementById('infoPanel');
                if (panel) {
                    const compDiv = document.createElement('div');
                    compDiv.className = 'scale-info-box';
                    compDiv.style.marginTop = '16px';
                    compDiv.innerHTML = `
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="info-section accent">
                                <div class="info-label">Diferencia vs Jónico (Mayor)</div>
                                <div class="info-description" style="color: #ccc;">${diffText}</div>
                            </div>
                            <div class="info-section">
                                <div class="info-label">Acorde Característico</div>
                                <div class="info-value" style="font-size: 16px;">${charChords[this.currentMode - 1]}</div>
                            </div>
                            <div class="info-section">
                                <div class="info-label">Canciones/Artistas</div>
                                <div class="info-description" style="color: #ccc; font-size: 13px;">${modeExamples[this.currentMode - 1]}</div>
                            </div>
                        </div>
                    `;
                    panel.appendChild(compDiv);
                }
            },

            // ========== PENTATÓNICAS ==========

            showPentatonics() {
                this.resetState(['currentPentatonic']);
                if (this.currentPentatonic === null) {
                    this.currentPentatonic = 'minor';
                    document.querySelector('[data-penta="minor"]')?.classList.add('active');
                }
                this.currentBox = 0;
                this.showPentatonic();
            },

            showPentatonic() {
                const rootName = MusicTheory.getNoteName(this.currentRoot);
                const scaleMap = {
                    'minor': 'pentatonicMinor',
                    'major': 'pentatonicMajor',
                    'blues': 'blues'
                };
                const nameMap = {
                    'minor': 'Pentatónica Menor',
                    'major': 'Pentatónica Mayor',
                    'blues': 'Blues'
                };

                const scaleType = scaleMap[this.currentPentatonic];

                // Hide chord diagrams
                document.getElementById('diagramsContainer').classList.add('hidden');

                // Show box selector for pentatonic minor
                const boxSelector = document.getElementById('boxSelector');
                if (this.currentPentatonic === 'minor' || this.currentPentatonic === 'blues') {
                    boxSelector.classList.remove('hidden');
                    boxSelector.innerHTML = '';
                    for (let i = 0; i < 5; i++) {
                        const btn = document.createElement('button');
                        btn.className = `box-btn ${i === this.currentBox ? 'active' : ''}`;
                        btn.textContent = i + 1;
                        btn.addEventListener('click', () => {
                            this.currentBox = i;
                            document.querySelectorAll('.box-btn').forEach(b => b.classList.remove('active'));
                            btn.classList.add('active');
                            this.showPentatonic();
                        });
                        boxSelector.appendChild(btn);
                    }

                    // Show specific box
                    const boxes = MusicTheory.pentatonicBoxes.minor;
                    const box = boxes[this.currentBox];
                    const rootFret = this.currentRoot; // Simplified: root on 6th string

                    // Calculate positions for this box
                    const positions = [];
                    box.pattern.forEach(p => {
                        p.frets.forEach(f => {
                            if (f >= 0) {
                                const actualFret = (box.startFret + f + rootFret) % 12;
                                positions.push({ string: p.string, fret: actualFret });
                                // Also add octave position if in range
                                if (actualFret + 12 < 13) {
                                    positions.push({ string: p.string, fret: actualFret + 12 });
                                }
                            }
                        });
                    });

                    // Set zone
                    const startFret = (box.startFret + rootFret) % 12;
                    Fretboard.tonicNote = this.currentRoot;
                    Fretboard.currentScale = MusicTheory.getScale(this.currentRoot, scaleType);
                    Fretboard.setZone(Math.max(0, startFret), Math.min(12, startFret + 4));

                    if (this.currentPentatonic === 'blues') {
                        Fretboard.blueNoteIndex = (this.currentRoot + 6) % 12;
                    } else {
                        Fretboard.blueNoteIndex = null;
                    }

                    Fretboard.updateDisplay();

                    this.updateDisplay(
                        `${rootName} ${nameMap[this.currentPentatonic]} - ${box.name}`,
                        `Posición ${this.currentBox + 1} de 5 | Trastes ${startFret}-${startFret + 3}`
                    );
                } else {
                    boxSelector.classList.add('hidden');
                    Fretboard.showScale(this.currentRoot, scaleType);
                    this.updateDisplay(
                        `${rootName} ${nameMap[this.currentPentatonic]}`,
                        `5 notas - Relativa de ${MusicTheory.getNoteName((this.currentRoot + 3) % 12)} Pent. Menor`
                    );
                }
                // Mostrar info de la escala pentatónica/blues
                const info = MusicTheory.scaleInfo[scaleType];
                this.showScaleInfoPanel(info, scaleType);
            },

            // ========== CÍRCULO DE QUINTAS ==========

            showCircleOfFifths() {
                this.resetState();
                this.hideUIElements();
                Fretboard.showScale(this.currentRoot, 'major');

                const rootName = MusicTheory.getNoteName(this.currentRoot);
                const relativeMinor = MusicTheory.getNoteName(MusicTheory.getRelativeMinor(this.currentRoot));

                // Key signature info
                const keySignatures = {
                    0: '0 alteraciones', 7: '1 # (F#)', 2: '2 # (F#, C#)', 9: '3 # (F#, C#, G#)',
                    4: '4 # (F#, C#, G#, D#)', 11: '5 # (F#, C#, G#, D#, A#)', 6: '6 #/b',
                    1: '7 # / 5 b', 8: '4 b (Bb, Eb, Ab, Db)', 3: '3 b (Bb, Eb, Ab)',
                    10: '2 b (Bb, Eb)', 5: '1 b (Bb)'
                };

                this.updateDisplay(
                    `Tonalidad: ${rootName} Mayor`,
                    `Relativo menor: ${relativeMinor}m | ${keySignatures[this.currentRoot] || ''}`
                );
                this.renderCircleOfFifths();

                // Show diatonic chords and neighbor keys
                const triads = MusicTheory.getScaleTriads(this.currentRoot, 'major');
                const romanNumerals = ['I', 'ii', 'iii', 'IV', 'V', 'vi', 'vii°'];
                const qualitySymbols = { maj: '', min: 'm', dim: '°' };

                const neighborUp = MusicTheory.getNoteName((this.currentRoot + 7) % 12);
                const neighborDown = MusicTheory.getNoteName((this.currentRoot + 5) % 12);

                const panel = document.getElementById('infoPanel');
                if (panel) {
                    panel.innerHTML = `
                        <div class="scale-info-box">
                            <div class="info-header">
                                <div class="info-title">Tonalidad ${rootName} Mayor</div>
                                <div class="info-emotion">Armadura: ${keySignatures[this.currentRoot] || 'N/A'}</div>
                            </div>
                            <div class="info-section" style="margin-bottom: 12px;">
                                <div class="info-label">Acordes Diatónicos</div>
                                <div class="flex flex-wrap gap-2 mt-2">
                                    ${triads.map((t, i) => `
                                        <div style="padding: 8px 12px; background: #1a1a1a; border: 2px solid #333; border-radius: 8px; text-align: center; min-width: 55px;">
                                            <div style="font-family: 'Bebas Neue'; font-size: 18px; color: #fafafa;">${romanNumerals[i]}</div>
                                            <div style="font-family: 'IBM Plex Mono'; font-size: 12px; color: #dc2626;">${t.root.note}${qualitySymbols[t.quality] || ''}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="info-section">
                                    <div class="info-label">Tonalidades Vecinas (modulación fácil)</div>
                                    <div class="info-description" style="color: #ccc; margin-top: 4px;">
                                        ← <strong>${neighborDown} Mayor</strong> (IV, subdominante) |
                                        <strong>${neighborUp} Mayor</strong> (V, dominante) →
                                    </div>
                                    <div class="info-description" style="color: #888; margin-top: 4px;">
                                        Relativo menor: <strong>${relativeMinor}m</strong>
                                    </div>
                                </div>
                                <div class="info-section accent">
                                    <div class="info-label">Armadura</div>
                                    <div class="info-value" style="font-size: 15px;">${keySignatures[this.currentRoot] || 'N/A'}</div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            },

            renderCircleOfFifths() {
                // Try both possible container IDs
                let container = document.getElementById('circleOfFifthsMain');
                if (!container) container = document.getElementById('circleOfFifths');
                if (!container) return;

                container.innerHTML = '';
                const centerX = 110;
                const centerY = 110;
                const outerRadius = 90;
                const innerRadius = 60;

                // Major keys (outer circle)
                MusicTheory.circleOfFifths.forEach((noteIndex, i) => {
                    const angle = (i * 30 - 90) * Math.PI / 180;
                    const x = centerX + outerRadius * Math.cos(angle) - 16;
                    const y = centerY + outerRadius * Math.sin(angle) - 16;

                    const btn = document.createElement('button');
                    btn.className = `circle-note ${noteIndex === this.currentRoot ? 'active' : ''}`;
                    btn.style.left = `${x}px`;
                    btn.style.top = `${y}px`;
                    btn.textContent = MusicTheory.circleOfFifthsLabels[i];
                    btn.dataset.note = noteIndex;
                    btn.addEventListener('click', () => {
                        this.currentRoot = noteIndex;
                        document.getElementById('rootSelect').value = noteIndex;
                        this.showCircleOfFifths();
                    });
                    container.appendChild(btn);
                });

                // Minor keys (inner circle)
                MusicTheory.circleOfFifths.forEach((noteIndex, i) => {
                    const minorNote = MusicTheory.getRelativeMinor(noteIndex);
                    const angle = (i * 30 - 90) * Math.PI / 180;
                    const x = centerX + innerRadius * Math.cos(angle) - 13;
                    const y = centerY + innerRadius * Math.sin(angle) - 13;

                    const minorLabels = ['Am', 'Em', 'Bm', 'F#m', 'C#m', 'G#m', 'Ebm', 'Bbm', 'Fm', 'Cm', 'Gm', 'Dm'];
                    const btn = document.createElement('button');
                    const isRelativeOfCurrent = minorNote === MusicTheory.getRelativeMinor(this.currentRoot);
                    btn.className = `circle-note minor ${isRelativeOfCurrent ? 'active' : ''}`;
                    btn.style.left = `${x}px`;
                    btn.style.top = `${y}px`;
                    btn.textContent = minorLabels[i];
                    btn.dataset.note = minorNote;
                    btn.addEventListener('click', () => {
                        this.currentRoot = MusicTheory.getRelativeMajor(minorNote);
                        document.getElementById('rootSelect').value = this.currentRoot;
                        this.showCircleOfFifths();
                    });
                    container.appendChild(btn);
                });
            },

            // ========== ACORDES DE SÉPTIMA ==========

            showSeventhChords() {
                this.resetState(['currentChord7']);
                if (this.currentChord7 === null) {
                    this.currentChord7 = 1;
                    document.querySelector('[data-chord7="1"]')?.classList.add('active');
                }
                this.showSeventhChord();
            },

            showSeventhChord() {
                const chord = MusicTheory.getSeventhChord(this.currentRoot, this.currentChord7);
                const rootName = MusicTheory.getNoteName(this.currentRoot);
                const chordRootIndex = MusicTheory.getNoteIndex(chord.root);

                // Hide box selector
                document.getElementById('boxSelector').classList.add('hidden');

                // Show chord diagram
                const diagramContainer = document.getElementById('diagramsContainer');
                diagramContainer.innerHTML = '';
                diagramContainer.classList.remove('hidden');

                // Get appropriate voicing
                const voicingTypes = {
                    1: 'maj7_E', 2: 'm7_A', 3: 'm7_E', 4: 'maj7_A',
                    5: 'dom7_E', 6: 'm7_A', 7: 'm7b5_E'
                };
                const voicingKey = voicingTypes[this.currentChord7];
                const voicing = MusicTheory.seventhVoicings[voicingKey];
                // E shapes: root on 6th string (E=4), A shapes: root on 5th string (A=9)
                const isAShape = voicingKey.includes('_A');
                const baseNote = isAShape ? 9 : 4; // A=9, E=4
                const position = (chordRootIndex - baseNote + 12) % 12;

                const chordName = `${chord.root}${chord.quality}`;
                const diagram = ChordDiagram.create(voicing, chordName, position);
                diagramContainer.appendChild(diagram);

                // Show chord on fretboard with zone
                Fretboard.tonicNote = chordRootIndex;
                Fretboard.currentScale = chord.notes.map((n, i) => ({
                    note: n.note,
                    degree: i + 1
                }));
                Fretboard.highlightedNotes.clear();
                Fretboard.setZone(position, position + 4);
                Fretboard.specificPositions = null;
                Fretboard.updateDisplay();

                const romanNumerals = ['I', 'ii', 'iii', 'IV', 'V', 'vi', 'vii°'];
                this.updateDisplay(
                    `${romanNumerals[this.currentChord7 - 1]}${chord.quality} de ${rootName} Mayor: ${chord.root}${chord.quality}`,
                    `Notas: ${chord.notes.map(n => n.note).join(' - ')} | Tipo: ${chord.quality}`
                );
                this.clearInfoPanel();
            },

            // ========== PROGRESIONES ==========

            showProgressions() {
                this.resetState(['currentProgression']);
                if (!this.currentProgression) {
                    this.currentProgression = 'I-IV-V-I';
                    document.querySelector('[data-progression="I-IV-V-I"]')?.classList.add('active');
                }
                this.showProgression();
            },

            showProgression() {
                if (!this.currentProgression) return;

                const prog = MusicTheory.progressions[this.currentProgression];
                if (!prog) return;
                const rootName = MusicTheory.getNoteName(this.currentRoot);

                // Hide box selector
                document.getElementById('boxSelector').classList.add('hidden');

                // Build all chords for the progression
                const chords = prog.degrees.map(degree => {
                    let chordRoot, quality, triad;

                    // Handle flat degrees from minor key
                    const flatDegreeOffsets = {
                        '-1': { offset: 0, quality: 'min' },    // i
                        '-3': { offset: 3, quality: 'maj' },    // bIII
                        '-4': { offset: 5, quality: 'min' },    // iv
                        '-5': { offset: 7, quality: 'min' },    // v
                        '-6': { offset: 8, quality: 'maj' },    // bVI
                        '-7': { offset: 10, quality: 'maj' },   // bVII
                    };

                    if (flatDegreeOffsets[String(degree)]) {
                        const info = flatDegreeOffsets[String(degree)];
                        chordRoot = MusicTheory.getNoteName((this.currentRoot + info.offset) % 12);
                        quality = info.quality;
                        const thirdOffset = quality === 'min' ? 3 : 4;
                        triad = {
                            root: { note: chordRoot },
                            third: { note: MusicTheory.getNoteName((this.currentRoot + info.offset + thirdOffset) % 12) },
                            fifth: { note: MusicTheory.getNoteName((this.currentRoot + info.offset + 7) % 12) }
                        };
                    } else if (degree > 0) {
                        triad = MusicTheory.getTriad(this.currentRoot, 'major', degree);
                        chordRoot = triad.root.note;
                        quality = triad.quality;
                    } else {
                        // Fallback
                        chordRoot = MusicTheory.getNoteName(this.currentRoot);
                        quality = 'maj';
                        triad = { root: { note: chordRoot }, third: { note: chordRoot }, fifth: { note: chordRoot } };
                    }

                    const voicingKey = quality === 'min' ? `${chordRoot}m` : chordRoot;
                    let voicing = MusicTheory.chordVoicings[voicingKey];
                    let position = 0;

                    if (!voicing) {
                        const shape = quality === 'min' ? 'E_shape_minor' : 'E_shape_major';
                        voicing = MusicTheory.chordVoicings[shape];
                        // Calculate position: distance from E (4) to target note
                        const targetIndex = MusicTheory.getNoteIndex(chordRoot);
                        position = (targetIndex - 4 + 12) % 12;
                    }

                    return {
                        name: quality === 'min' ? `${chordRoot}m` : chordRoot,
                        voicing,
                        position,
                        triad
                    };
                });

                // Show all chord diagrams
                const diagramContainer = document.getElementById('diagramsContainer');
                diagramContainer.innerHTML = '';
                diagramContainer.classList.remove('hidden');
                diagramContainer.classList.add('scrollable-horizontal');

                chords.forEach((chord, i) => {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'chord-wrapper';
                    wrapper.style.cursor = 'pointer';
                    wrapper.style.position = 'relative';
                    wrapper.style.transition = 'all 0.2s';

                    if (i === this.currentProgressionChordIndex) {
                        wrapper.classList.add('active-chord');
                        wrapper.style.opacity = '1';
                        // Borde animado para acorde activo
                        if (this.progressionPlaying && !this.progressionPaused) {
                            wrapper.style.border = '3px solid #10b981';
                            wrapper.style.boxShadow = '0 0 15px rgba(16, 185, 129, 0.5)';
                        }
                    } else {
                        wrapper.style.opacity = '0.6';
                    }

                    wrapper.addEventListener('click', () => {
                        if (!this.progressionPlaying) {
                            this.currentProgressionChordIndex = i;
                            this.showProgression();
                        }
                    });

                    // Hover effects
                    wrapper.addEventListener('mouseenter', () => {
                        if (!this.progressionPlaying) {
                            wrapper.style.transform = 'scale(1.15)';
                            wrapper.style.zIndex = '100';
                            wrapper.style.opacity = '1';
                        }
                    });

                    wrapper.addEventListener('mouseleave', () => {
                        if (!this.progressionPlaying) {
                            wrapper.style.transform = 'scale(1)';
                            wrapper.style.zIndex = '1';
                            if (i !== this.currentProgressionChordIndex) {
                                wrapper.style.opacity = '0.6';
                            }
                        }
                    });

                    // Numeración del acorde
                    const numberBadge = document.createElement('div');
                    numberBadge.style.cssText = `
                        position: absolute;
                        top: -8px;
                        left: 50%;
                        transform: translateX(-50%);
                        width: 24px;
                        height: 24px;
                        border-radius: 50%;
                        background: ${this.getChordFunctionColor(prog, i)};
                        color: white;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-weight: bold;
                        font-size: 12px;
                        z-index: 10;
                    `;
                    numberBadge.textContent = i + 1;
                    wrapper.appendChild(numberBadge);

                    // Tooltip con notas del acorde
                    const tooltip = document.createElement('div');
                    const chordNotes = [chord.triad.root.note, chord.triad.third.note, chord.triad.fifth.note].join(' - ');
                    tooltip.style.cssText = `
                        position: absolute;
                        bottom: -30px;
                        left: 50%;
                        transform: translateX(-50%);
                        background: rgba(0, 0, 0, 0.9);
                        color: white;
                        padding: 6px 12px;
                        border-radius: 4px;
                        font-size: 11px;
                        white-space: nowrap;
                        opacity: 0;
                        pointer-events: none;
                        transition: opacity 0.2s;
                        z-index: 200;
                    `;
                    tooltip.textContent = chordNotes;
                    wrapper.appendChild(tooltip);

                    wrapper.addEventListener('mouseenter', () => {
                        tooltip.style.opacity = '1';
                    });

                    wrapper.addEventListener('mouseleave', () => {
                        tooltip.style.opacity = '0';
                    });

                    const diagram = ChordDiagram.create(chord.voicing, chord.name, chord.position);

                    // Clase compact si hay más de 4 acordes
                    if (chords.length > 4) {
                        diagram.classList.add('compact');
                    }

                    wrapper.appendChild(diagram);
                    diagramContainer.appendChild(wrapper);
                });

                // Auto-scroll al acorde activo
                setTimeout(() => {
                    const active = diagramContainer.querySelector('.active-chord');
                    if (active) {
                        active.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
                    }
                }, 100);

                // Show current chord on fretboard
                const currentChord = chords[this.currentProgressionChordIndex];
                const chordRootIndex = MusicTheory.getNoteIndex(currentChord.name.replace('m', ''));

                Fretboard.tonicNote = chordRootIndex;
                Fretboard.currentScale = [
                    { note: currentChord.triad.root.note, degree: 1 },
                    { note: currentChord.triad.third.note, degree: 3 },
                    { note: currentChord.triad.fifth.note, degree: 5 }
                ];
                Fretboard.highlightedNotes.clear();
                Fretboard.setZone(currentChord.position, currentChord.position + 4);
                Fretboard.specificPositions = null;
                Fretboard.updateDisplay();

                const styleLabel = prog.style ? ` | Estilo: ${prog.style}` : '';
                const funcLabel = prog.function ? ` | Función: ${prog.function[this.currentProgressionChordIndex]}` : '';
                this.updateDisplay(
                    `Progresión ${this.currentProgression} en ${rootName}`,
                    `${prog.name}${styleLabel} | Acorde ${this.currentProgressionChordIndex + 1}/${prog.degrees.length}: ${currentChord.name}${funcLabel}`
                );
                this.clearInfoPanel();

                // NUEVO: Análisis de progresión
                this.renderProgressionAnalysis(prog, currentChord, this.currentProgressionChordIndex);
            },

            // NUEVO: Renderizar análisis de progresión
            renderProgressionAnalysis(prog, currentChord, chordIndex) {
                const infoPanel = document.getElementById('infoPanel');
                if (!infoPanel || !prog.function || !prog.analysis) return;

                infoPanel.classList.remove('hidden');

                const functionColors = {
                    'T': '#10b981',   // Verde - Tónica
                    'Tm': '#10b981',  // Verde - Tónica menor
                    'SD': '#f59e0b',  // Amarillo - Subdominante
                    'SDm': '#f59e0b', // Amarillo - Subdominante menor
                    'D': '#dc2626',   // Rojo - Dominante
                    'Dm': '#dc2626',  // Rojo - Dominante menor
                    'bVII': '#8b5cf6', // Púrpura - Acorde prestado
                    'bVI': '#8b5cf6',
                    'bIII': '#8b5cf6'
                };

                const functionLabels = {
                    'T': 'Tónica (Reposo)',
                    'Tm': 'Tónica menor (Reposo)',
                    'SD': 'Subdominante (Tensión suave)',
                    'SDm': 'Subdominante menor',
                    'D': 'Dominante (Tensión fuerte)',
                    'Dm': 'Dominante menor',
                    'bVII': 'Acorde prestado',
                    'bVI': 'Acorde prestado',
                    'bIII': 'Acorde prestado'
                };

                // Crear chips de acordes con colores
                const chordChips = prog.degrees.map((degree, i) => {
                    const func = prog.function[i];
                    const color = functionColors[func] || '#666';
                    const isActive = i === chordIndex;
                    const opacity = isActive ? '1' : '0.5';
                    const romanNumeral = this.getRomanNumeral(degree);

                    return `
                        <div style="
                            display: inline-block;
                            padding: 8px 16px;
                            margin: 4px;
                            background: ${color};
                            color: white;
                            border-radius: 6px;
                            font-weight: bold;
                            opacity: ${opacity};
                            ${isActive ? 'transform: scale(1.1);' : ''}
                            transition: all 0.2s;
                        ">
                            ${romanNumeral}
                        </div>
                    `;
                }).join('');

                const currentFunction = prog.function[chordIndex];
                const functionDesc = functionLabels[currentFunction] || currentFunction;

                // Verificar estado de colapso desde localStorage
                const isCollapsed = localStorage.getItem('progressionPanelCollapsed') === 'true';

                infoPanel.innerHTML = `
                    <div style="position: relative;">
                        <button id="toggleProgressionPanel" style="
                            position: absolute;
                            top: -40px;
                            right: 0;
                            padding: 8px 16px;
                            background: rgba(220, 38, 38, 0.2);
                            border: 1px solid rgba(220, 38, 38, 0.4);
                            border-radius: 4px;
                            color: #dc2626;
                            cursor: pointer;
                            font-size: 12px;
                            font-weight: 600;
                            transition: all 0.2s;
                        " onmouseover="this.style.background='rgba(220, 38, 38, 0.3)'" onmouseout="this.style.background='rgba(220, 38, 38, 0.2)'">
                            ${isCollapsed ? '▼ Mostrar Análisis' : '▲ Ocultar Análisis'}
                        </button>

                        <div id="progressionPanelContent" style="
                            max-height: ${isCollapsed ? '0' : '1000px'};
                            overflow: hidden;
                            transition: max-height 0.3s ease-in-out, opacity 0.3s;
                            opacity: ${isCollapsed ? '0' : '1'};
                        ">
                            <div class="info-section" style="background: rgba(0,0,0,0.3); padding: 20px; border-radius: 8px; margin-bottom: 16px;">
                                <div class="info-label" style="color: #dc2626; margin-bottom: 12px;">ANÁLISIS ARMÓNICO</div>
                                <div style="margin-bottom: 16px;">
                                    ${chordChips}
                                </div>
                                <div style="margin-bottom: 12px; padding: 12px; background: rgba(220,38,38,0.1); border-left: 3px solid ${functionColors[currentFunction]}; border-radius: 4px;">
                                    <strong style="color: ${functionColors[currentFunction]};">Acorde actual:</strong>
                                    ${functionDesc}
                                </div>
                                <div style="color: #ccc; font-size: 14px; line-height: 1.6;">
                                    ${prog.analysis}
                                </div>
                            </div>

                            ${prog.songs ? `
                                <div class="info-section" style="background: rgba(0,0,0,0.2); padding: 16px; border-radius: 8px;">
                                    <div class="info-label" style="color: #dc2626; margin-bottom: 8px;">CANCIONES FAMOSAS</div>
                                    <div style="color: #aaa; font-size: 13px; line-height: 1.8;">
                                        ${prog.songs.map(song => `• ${song}`).join('<br>')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;

                // Agregar event listener para el botón de toggle
                setTimeout(() => {
                    const toggleBtn = document.getElementById('toggleProgressionPanel');
                    const content = document.getElementById('progressionPanelContent');
                    if (toggleBtn && content) {
                        toggleBtn.addEventListener('click', () => {
                            const isCurrentlyCollapsed = content.style.maxHeight === '0px';
                            content.style.maxHeight = isCurrentlyCollapsed ? '1000px' : '0';
                            content.style.opacity = isCurrentlyCollapsed ? '1' : '0';
                            toggleBtn.textContent = isCurrentlyCollapsed ? '▲ Ocultar Análisis' : '▼ Mostrar Análisis';
                            localStorage.setItem('progressionPanelCollapsed', !isCurrentlyCollapsed);
                        });
                    }
                }, 0);
            },

            // NUEVO: Convertir grado numérico a romano
            getRomanNumeral(degree) {
                const romanMap = {
                    '-1': 'i', '-3': 'bIII', '-4': 'iv', '-5': 'v', '-6': 'bVI', '-7': 'bVII',
                    '1': 'I', '2': 'ii', '3': 'iii', '4': 'IV', '5': 'V', '6': 'vi', '7': 'vii°'
                };
                return romanMap[String(degree)] || degree;
            },

            // ========== REPRODUCCIÓN AUTOMÁTICA DE PROGRESIONES ==========

            playProgression() {
                if (this.progressionPlaying && !this.progressionPaused) return;

                const prog = MusicTheory.progressions[this.currentProgression];
                if (!prog) return;

                // Si está pausado, reanudar
                if (this.progressionPaused) {
                    this.progressionPaused = false;
                    this.progressionPlaying = true;
                    this.updateProgressionControls();
                    this.startProgressionPlayback(prog);
                    return;
                }

                // Iniciar desde el principio
                this.progressionPlaying = true;
                this.progressionPaused = false;
                this.currentProgressionChordIndex = 0;
                this.progressionCurrentRepeat = 0;
                this.updateProgressionControls();
                this.startProgressionPlayback(prog);
            },

            startProgressionPlayback(prog) {
                const beatDuration = (60 / this.progressionBPM) * 4000; // 4 beats por acorde
                const chords = prog.degrees;

                const playNextChord = () => {
                    if (!this.progressionPlaying || this.progressionPaused) return;

                    // Tocar acorde actual
                    const degree = chords[this.currentProgressionChordIndex];
                    this.playProgressionChord(degree);

                    // Actualizar UI
                    this.showProgression();
                    this.updateProgressionProgress();

                    // Avanzar al siguiente acorde
                    this.currentProgressionChordIndex++;

                    if (this.currentProgressionChordIndex >= chords.length) {
                        // Fin de la progresión
                        this.currentProgressionChordIndex = 0;
                        this.progressionCurrentRepeat++;

                        // Verificar si debe continuar
                        const shouldContinue = this.progressionLoop ||
                            (this.progressionCurrentRepeat < this.progressionRepeatCount);

                        if (!shouldContinue) {
                            this.stopProgression();
                            return;
                        }

                        this.updateProgressionProgress();
                    }

                    // Programar siguiente acorde
                    this.progressionIntervalId = setTimeout(playNextChord, beatDuration);
                };

                // Iniciar reproducción
                playNextChord();
            },

            playProgressionChord(degree) {
                // Calcular la raíz del acorde basado en el grado
                const flatDegreeOffsets = {
                    '-1': { offset: 0, quality: 'min' },
                    '-3': { offset: 3, quality: 'maj' },
                    '-4': { offset: 5, quality: 'min' },
                    '-5': { offset: 7, quality: 'min' },
                    '-6': { offset: 8, quality: 'maj' },
                    '-7': { offset: 10, quality: 'maj' },
                };

                let rootOffset, quality;

                if (flatDegreeOffsets[String(degree)]) {
                    const info = flatDegreeOffsets[String(degree)];
                    rootOffset = info.offset;
                    quality = info.quality;
                } else if (degree > 0) {
                    const triad = MusicTheory.getTriad(this.currentRoot, 'major', degree);
                    const rootNote = triad.root.note;
                    rootOffset = MusicTheory.getNoteIndex(rootNote) - this.currentRoot;
                    if (rootOffset < 0) rootOffset += 12;
                    quality = triad.quality;
                } else {
                    rootOffset = 0;
                    quality = 'maj';
                }

                // Calcular nota raíz
                const chordRoot = (this.currentRoot + rootOffset) % 12;

                // Construir tríada basado en la calidad
                const third = quality === 'min' ? 3 : 4;
                const notes = [
                    chordRoot,
                    (chordRoot + third) % 12,
                    (chordRoot + 7) % 12
                ];

                // Tocar el acorde directamente
                AudioEngine.playChord(notes, 1.5);
            },

            pauseProgression() {
                if (!this.progressionPlaying || this.progressionPaused) return;

                this.progressionPaused = true;
                this.progressionPlaying = false;

                if (this.progressionIntervalId) {
                    clearTimeout(this.progressionIntervalId);
                    this.progressionIntervalId = null;
                }

                this.updateProgressionControls();
            },

            stopProgression() {
                this.progressionPlaying = false;
                this.progressionPaused = false;
                this.currentProgressionChordIndex = 0;
                this.progressionCurrentRepeat = 0;

                if (this.progressionIntervalId) {
                    clearTimeout(this.progressionIntervalId);
                    this.progressionIntervalId = null;
                }

                this.updateProgressionControls();
                this.updateProgressionProgress();
                this.showProgression();
            },

            updateProgressionProgress() {
                const prog = MusicTheory.progressions[this.currentProgression];
                if (!prog) return;

                const total = prog.degrees.length;
                const current = this.currentProgressionChordIndex + 1;
                const percentage = (this.currentProgressionChordIndex / total) * 100;

                const progressText = document.getElementById('progressionProgressText');
                const progressBar = document.getElementById('progressionProgressBar');
                const repeatText = document.getElementById('progressionRepeatText');

                if (progressText) {
                    progressText.textContent = `Acorde ${current} / ${total}`;
                }

                if (progressBar) {
                    progressBar.style.width = `${percentage}%`;

                    // Color según función
                    const func = prog.function ? prog.function[this.currentProgressionChordIndex] : null;
                    const colors = {
                        'T': '#10b981', 'Tm': '#10b981',
                        'SD': '#f59e0b', 'SDm': '#f59e0b',
                        'D': '#dc2626', 'Dm': '#dc2626'
                    };
                    progressBar.style.background = colors[func] || '#666';
                }

                if (repeatText) {
                    const currentRep = this.progressionCurrentRepeat + 1;
                    const totalReps = this.progressionLoop ? '∞' : this.progressionRepeatCount;
                    repeatText.textContent = `Repetición ${currentRep} / ${totalReps}`;
                }
            },

            updateProgressionControls() {
                const playBtn = document.getElementById('playProgressionBtn');
                const pauseBtn = document.getElementById('pauseProgressionBtn');
                const stopBtn = document.getElementById('stopProgressionBtn');

                if (playBtn) playBtn.disabled = this.progressionPlaying && !this.progressionPaused;
                if (pauseBtn) pauseBtn.disabled = !this.progressionPlaying || this.progressionPaused;
                if (stopBtn) stopBtn.disabled = !this.progressionPlaying && !this.progressionPaused;
            },

            getChordFunctionColor(prog, index) {
                if (!prog.function) return '#666';
                const func = prog.function[index];
                const colors = {
                    'T': '#10b981', 'Tm': '#10b981',
                    'SD': '#f59e0b', 'SDm': '#f59e0b',
                    'D': '#dc2626', 'Dm': '#dc2626',
                    'bVII': '#8b5cf6', 'bVI': '#8b5cf6', 'bIII': '#8b5cf6'
                };
                return colors[func] || '#666';
            },

            // ========== SISTEMA CAGED ==========

            showCAGED() {
                this.resetState(['currentCAGED']);
                if (this.currentCAGED === null) {
                    this.currentCAGED = 'C';
                }
                this.renderCAGEDMap();
                this.showCAGEDShape();
            },

            showCAGEDShape() {
                const rootName = MusicTheory.getNoteName(this.currentRoot);

                // Hide box selector
                document.getElementById('boxSelector').classList.add('hidden');

                // Show chord diagram
                const diagramContainer = document.getElementById('diagramsContainer');
                diagramContainer.innerHTML = '';
                diagramContainer.classList.remove('hidden');

                if (this.cagedShowAll) {
                    // Mostrar todas las 5 formas simultáneamente
                    diagramContainer.classList.add('scrollable-horizontal');
                    const cagedOrder = ['C', 'A', 'G', 'E', 'D'];

                    cagedOrder.forEach(shape => {
                        const baseVoicing = MusicTheory.chordVoicings[shape];
                        const position = MusicTheory.calculateCAGEDPosition(shape, rootName);

                        const wrapper = document.createElement('div');
                        wrapper.className = 'chord-wrapper';
                        if (shape === this.currentCAGED) {
                            wrapper.classList.add('active-chord');
                        } else {
                            wrapper.style.opacity = '0.7';
                        }

                        const diagram = ChordDiagram.create(baseVoicing, `${rootName} (${shape})`, position);
                        wrapper.appendChild(diagram);

                        // Label de posición
                        const posLabel = document.createElement('div');
                        posLabel.textContent = `Posición ${position}`;
                        posLabel.style.cssText = 'text-align: center; font-size: 11px; color: #888; margin-top: 4px; font-weight: 600;';
                        wrapper.appendChild(posLabel);

                        diagramContainer.appendChild(wrapper);
                    });

                    // Mostrar la forma activa en el fretboard
                    const adjustedPosition = MusicTheory.calculateCAGEDPosition(this.currentCAGED, rootName);
                    Fretboard.tonicNote = this.currentRoot;
                    Fretboard.currentScale = MusicTheory.getScale(this.currentRoot, 'major');
                    Fretboard.highlightedNotes.clear();
                    const zoneStart = Math.max(0, adjustedPosition);
                    const zoneEnd = Math.min(12, adjustedPosition + 4);
                    Fretboard.setZone(zoneStart, zoneEnd);
                    Fretboard.specificPositions = null;
                    Fretboard.updateDisplay();

                    this.updateDisplay(
                        `${rootName} Mayor - Sistema CAGED Completo`,
                        `Forma activa: ${this.currentCAGED} | Ver todas las formas en el mástil`
                    );
                } else {
                    // Mostrar solo la forma actual
                    diagramContainer.classList.remove('scrollable-horizontal');

                    const baseVoicing = MusicTheory.chordVoicings[this.currentCAGED];
                    const adjustedPosition = MusicTheory.calculateCAGEDPosition(this.currentCAGED, rootName);

                    const diagram = ChordDiagram.create(baseVoicing, rootName, adjustedPosition);
                    diagramContainer.appendChild(diagram);

                    // Show major scale with zone highlighting
                    Fretboard.tonicNote = this.currentRoot;
                    Fretboard.currentScale = MusicTheory.getScale(this.currentRoot, 'major');
                    Fretboard.highlightedNotes.clear();

                    // Set zone based on CAGED position
                    const zoneStart = Math.max(0, adjustedPosition);
                    const zoneEnd = Math.min(12, adjustedPosition + 4);
                    Fretboard.setZone(zoneStart, zoneEnd);
                    Fretboard.specificPositions = null;
                    Fretboard.updateDisplay();

                    this.updateDisplay(
                        `${rootName} Mayor - Forma ${this.currentCAGED}`,
                        `Posición: Traste ${adjustedPosition} | Orden: C → A → G → E → D → C...`
                    );
                }
                this.clearInfoPanel();
            },

            // Render interactive SVG pentagon for CAGED
            renderCAGEDMap() {
                const container = document.getElementById('caged-svg-container');
                if (!container) return;

                const shapes = ['C', 'A', 'G', 'E', 'D'];
                const radius = 200;
                const centerX = 300;
                const centerY = 300;

                let svg = '<svg width="600" height="600" viewBox="0 0 600 600">';

                // Draw connections
                shapes.forEach((shape, idx) => {
                    const angle = (idx * 72 - 90) * Math.PI / 180;
                    const x1 = centerX + radius * Math.cos(angle);
                    const y1 = centerY + radius * Math.sin(angle);

                    const nextIdx = (idx + 1) % 5;
                    const nextShape = shapes[nextIdx];
                    const nextAngle = (nextIdx * 72 - 90) * Math.PI / 180;
                    const x2 = centerX + radius * Math.cos(nextAngle);
                    const y2 = centerY + radius * Math.sin(nextAngle);

                    svg += `<line x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}"
                                  class="caged-connection"
                                  data-from="${shape}"
                                  data-to="${nextShape}"
                                  stroke="#475569" stroke-width="2"
                                  style="cursor: pointer;"/>`;
                });

                // Draw nodes
                shapes.forEach((shape, idx) => {
                    const angle = (idx * 72 - 90) * Math.PI / 180;
                    const x = centerX + radius * Math.cos(angle);
                    const y = centerY + radius * Math.sin(angle);
                    const shapeData = MusicTheory.cagedRelationshipMap[shape];
                    const color = shapeData.color;

                    svg += `
                        <g class="caged-node" data-shape="${shape}" style="cursor: pointer;">
                            <circle cx="${x}" cy="${y}" r="40" fill="${color}" stroke="#0a0a0a" stroke-width="2"/>
                            <text x="${x}" y="${y + 8}" text-anchor="middle" fill="#0a0a0a"
                                  font-size="28" font-weight="bold">${shape}</text>
                        </g>
                    `;
                });

                // Add center text
                svg += `
                    <text x="${centerX}" y="${centerY - 10}" text-anchor="middle" fill="#cbd5e1"
                          font-size="16" font-weight="bold">CAGED</text>
                    <text x="${centerX}" y="${centerY + 10}" text-anchor="middle" fill="#94a3b8"
                          font-size="12">System</text>
                `;

                svg += '</svg>';
                container.innerHTML = svg;

                // Add event listeners to nodes
                container.querySelectorAll('.caged-node').forEach(node => {
                    node.addEventListener('click', (e) => {
                        const shape = e.currentTarget.dataset.shape;
                        this.showCAGEDShapeInfo(shape);
                    });
                });

                // Add event listeners to connections
                container.querySelectorAll('.caged-connection').forEach(conn => {
                    conn.addEventListener('click', (e) => {
                        const from = e.currentTarget.dataset.from;
                        const to = e.currentTarget.dataset.to;
                        this.showCAGEDTransitionInfo(from, to);
                    });
                });
            },

            // Show individual CAGED shape info with audio
            showCAGEDShapeInfo(shape) {
                // Update current shape
                this.currentCAGED = shape;

                // Play audio
                const baseVoicing = MusicTheory.chordVoicings[shape];
                if (baseVoicing && this.audioContext) {
                    this.playChord(baseVoicing.notes);
                }

                // Highlight active node
                document.querySelectorAll('.caged-node').forEach(n => {
                    const nodeShape = n.dataset.shape;
                    const circle = n.querySelector('circle');
                    if (nodeShape === shape) {
                        circle.setAttribute('stroke', '#84cc16');
                        circle.setAttribute('stroke-width', '4');
                    } else {
                        circle.setAttribute('stroke', '#0a0a0a');
                        circle.setAttribute('stroke-width', '2');
                    }
                });

                // Show info panel
                const shapeData = MusicTheory.cagedRelationshipMap[shape];
                const infoPanel = document.getElementById('caged-info-panel');
                if (infoPanel && shapeData) {
                    infoPanel.classList.remove('hidden');
                    infoPanel.innerHTML = `
                        <h4 class="text-lg font-medium text-sage-400 mb-3">
                            Forma ${shape}: ${shapeData.soundCharacter}
                        </h4>
                        <div class="space-y-3 text-sm">
                            <div class="p-3 bg-void-900 rounded">
                                <strong class="text-chalk-100">💡 Cuándo usarla:</strong>
                                <p class="text-void-300 mt-1">${shapeData.whenToUse}</p>
                            </div>

                            <div class="p-3 bg-sage-900/20 border border-sage-700 rounded">
                                <strong class="text-sage-400">📍 Posición en el mástil:</strong>
                                <p class="text-chalk-200 mt-1">
                                    Para tocar ${MusicTheory.getNoteName(this.currentRoot)} mayor con forma ${shape},
                                    empieza en el traste ${MusicTheory.calculateCAGEDPosition(shape, MusicTheory.getNoteName(this.currentRoot))}
                                </p>
                            </div>

                            <div class="pt-3 border-t border-void-600">
                                <strong class="text-sage-400">➡️ Siguiente forma: ${shapeData.next}</strong>
                                <p class="text-xs text-void-400 mt-1">
                                    ${shapeData.transitionToNext.fretMove}
                                </p>
                                <button onclick="App.showCAGEDTransitionInfo('${shape}', '${shapeData.next}')"
                                        class="mt-2 w-full px-3 py-1.5 bg-sage-600 hover:bg-sage-500 text-chalk-100 rounded text-sm">
                                    ▶ Escuchar transición a ${shapeData.next}
                                </button>
                            </div>
                        </div>
                    `;
                }

                // Update fretboard display
                this.showCAGEDShape();

                this.showToast(`Forma ${shape}: ${shapeData?.soundCharacter || ''}`, 'info');
            },

            // Show transition between two CAGED shapes
            showCAGEDTransitionInfo(from, to) {
                const fromData = MusicTheory.cagedRelationshipMap[from];
                const toData = MusicTheory.cagedRelationshipMap[to];
                const transition = fromData.transitionToNext;

                if (!transition || transition.to !== to) {
                    this.showToast('Transición no válida', 'error');
                    return;
                }

                // Highlight connection
                document.querySelectorAll('.caged-connection').forEach(c => {
                    if (c.dataset.from === from && c.dataset.to === to) {
                        c.setAttribute('stroke', '#84cc16');
                        c.setAttribute('stroke-width', '4');
                    } else {
                        c.setAttribute('stroke', '#475569');
                        c.setAttribute('stroke-width', '2');
                    }
                });

                // Highlight both nodes
                document.querySelectorAll('.caged-node').forEach(n => {
                    const nodeShape = n.dataset.shape;
                    const circle = n.querySelector('circle');
                    if (nodeShape === from || nodeShape === to) {
                        circle.setAttribute('stroke', '#84cc16');
                        circle.setAttribute('stroke-width', '4');
                    } else {
                        circle.setAttribute('stroke', '#0a0a0a');
                        circle.setAttribute('stroke-width', '2');
                    }
                });

                // Show transition info
                const infoPanel = document.getElementById('caged-info-panel');
                if (infoPanel) {
                    infoPanel.classList.remove('hidden');
                    infoPanel.innerHTML = `
                        <h4 class="text-lg font-medium text-sage-400 mb-3">
                            Transición: ${from} → ${to}
                        </h4>
                        <div class="space-y-3 text-sm">
                            <div class="grid grid-cols-2 gap-4">
                                <div class="p-3 bg-void-900 rounded">
                                    <div class="font-medium" style="color: ${fromData.color}">Desde: ${from}</div>
                                    <div class="text-xs text-void-400 mt-1">${fromData.soundCharacter}</div>
                                </div>
                                <div class="p-3 bg-void-900 rounded">
                                    <div class="font-medium" style="color: ${toData.color}">Hacia: ${to}</div>
                                    <div class="text-xs text-void-400 mt-1">${toData.soundCharacter}</div>
                                </div>
                            </div>

                            <div class="p-3 bg-sage-900/20 border border-sage-700 rounded">
                                <strong class="text-chalk-100">🎸 Cómo mover:</strong>
                                <p class="text-void-300 mt-1">${transition.fretMove}</p>
                            </div>

                            <div class="p-3 bg-sage-900/20 border border-sage-700 rounded">
                                <strong class="text-chalk-100">👂 Cambio de sonido:</strong>
                                <p class="text-void-300 mt-1">${transition.soundChange}</p>
                            </div>

                            <div class="flex items-center justify-between p-3 bg-void-900 rounded">
                                <strong class="text-chalk-100">Dificultad:</strong>
                                <span class="px-2 py-1 rounded text-xs ${
                                    transition.difficulty.includes('Fácil') ? 'bg-green-700' :
                                    transition.difficulty.includes('Media') ? 'bg-yellow-700' :
                                    'bg-red-700'
                                }">${transition.difficulty}</span>
                            </div>

                            <div class="p-3 bg-blue-900/20 border border-blue-700 rounded">
                                <strong class="text-blue-400">💡 Tip profesional:</strong>
                                <p class="text-chalk-200 mt-1 italic">${transition.tip}</p>
                            </div>

                            <div class="mt-4 flex gap-2">
                                <button onclick="App.playCAGEDTransitionAudio('${from}', '${to}')"
                                        class="flex-1 px-4 py-2 bg-sage-600 hover:bg-sage-500 text-chalk-100 rounded">
                                    ▶ Escuchar transición
                                </button>
                            </div>
                        </div>
                    `;
                }
            },

            // Play transition between two shapes with delay
            playCAGEDTransitionAudio(from, to) {
                const fromVoicing = MusicTheory.chordVoicings[from];
                const toVoicing = MusicTheory.chordVoicings[to];

                if (!fromVoicing || !toVoicing || !this.audioContext) {
                    this.showToast('Audio no disponible', 'error');
                    return;
                }

                // Play from
                this.playChord(fromVoicing.notes);
                this.showToast(`${from} (traste ${MusicTheory.calculateCAGEDPosition(from, MusicTheory.getNoteName(this.currentRoot))})`, 'info');

                // After 1.2s, play to
                setTimeout(() => {
                    this.playChord(toVoicing.notes);
                    const fromPos = MusicTheory.calculateCAGEDPosition(from, MusicTheory.getNoteName(this.currentRoot));
                    const toPos = MusicTheory.calculateCAGEDPosition(to, MusicTheory.getNoteName(this.currentRoot));
                    this.showToast(`${to} (traste ${toPos}) - ${toPos - fromPos > 0 ? '+' : ''}${toPos - fromPos} trastes`, 'info');
                }, 1200);
            },

            // Play complete CAGED tour: C → A → G → E → D
            playCAGEDTour() {
                const shapes = ['C', 'A', 'G', 'E', 'D'];
                let currentIdx = 0;

                const playNext = () => {
                    if (currentIdx >= shapes.length) {
                        this.showToast('Tour CAGED completo!', 'success');
                        return;
                    }

                    const shape = shapes[currentIdx];
                    const voicing = MusicTheory.chordVoicings[shape];

                    if (voicing && this.audioContext) {
                        this.playChord(voicing.notes);
                        this.showCAGEDShapeInfo(shape);
                        this.showToast(`Forma ${shape} (${currentIdx + 1}/5)`, 'info');

                        currentIdx++;
                        setTimeout(playNext, 1800);
                    }
                };

                this.showToast('Iniciando tour CAGED...', 'info');
                playNext();
            },

            // Render all CAGED diagrams in grid
            renderAllCAGEDDiagrams() {
                const container = document.getElementById('caged-diagrams-container');
                if (!container) return;

                const shapes = ['C', 'A', 'G', 'E', 'D'];
                const rootName = MusicTheory.getNoteName(this.currentRoot);

                container.innerHTML = shapes.map(shape => {
                    const shapeData = MusicTheory.cagedRelationshipMap[shape];
                    const position = MusicTheory.calculateCAGEDPosition(shape, rootName);
                    const voicing = MusicTheory.chordVoicings[shape];

                    return `
                        <div class="p-3 bg-void-800 border border-void-600 rounded-lg hover:border-sage-500 transition-colors cursor-pointer"
                             onclick="App.showCAGEDShapeInfo('${shape}')">
                            <div class="flex items-center justify-between mb-2">
                                <div class="text-xl font-bold" style="color: ${shapeData.color}">${shape}</div>
                                <div class="text-xs text-void-400">Traste ${position}</div>
                            </div>

                            <div class="text-center text-void-400 text-xs my-3">
                                [Diagrama ${shape}]
                            </div>

                            <div class="text-xs text-void-400 text-center mt-2">
                                ${shapeData.soundCharacter}
                            </div>

                            <button onclick="event.stopPropagation(); App.playCAGEDShapeAudio('${shape}')"
                                    class="w-full mt-2 px-2 py-1 bg-sage-700 hover:bg-sage-600 text-chalk-100 rounded text-xs">
                                ▶ Escuchar
                            </button>
                        </div>
                    `;
                }).join('');
            },

            // Play individual CAGED shape audio
            playCAGEDShapeAudio(shape) {
                const voicing = MusicTheory.chordVoicings[shape];
                if (voicing && this.audioContext) {
                    this.playChord(voicing.notes);
                    this.showToast(`Forma ${shape}`, 'info');
                }
            },

            // ========== NIVEL 1 - INTERVALOS MEJORADO ==========

            showIntervalInfo(interval) {
                const info = MusicTheory.intervalInfo[interval];
                if (!info) return;
                const panel = document.getElementById('infoPanel');
                if (!panel) return;
                panel.innerHTML = `
                    <div class="scale-info-box">
                        <div class="info-header">
                            <div class="info-title">${info.name}</div>
                            <div class="info-emotion">${info.semitones} semitono${info.semitones > 1 ? 's' : ''}</div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="info-section accent">
                                <div class="info-label">Carácter Sonoro</div>
                                <div class="info-value" style="font-size: 15px;">${info.character}</div>
                            </div>
                            <div class="info-section">
                                <div class="info-label">Consonancia</div>
                                <div class="info-value" style="font-size: 15px;">${info.consonance}</div>
                            </div>
                            <div class="info-section">
                                <div class="info-label">Reconocimiento</div>
                                <div class="info-description" style="color: #ccc; font-size: 14px;">${info.examples}</div>
                            </div>
                        </div>
                    </div>
                `;
            },

            // ========== NIVEL 10 - QUIZ ==========

            showQuiz() {
                this.resetState();
                this.hideUIElements();
                Fretboard.clear();
                this.updateDisplay('QUIZ INTERACTIVO', 'Pon a prueba tus conocimientos de teoría musical');
                this.generateQuizQuestion();
            },

            generateQuizQuestion() {
                this.quizAnswered = false;
                const questions = MusicTheory.quizQuestions[this.quizCategory];
                if (!questions) return;

                const diffQuestions = questions[this.quizDifficulty] || questions.easy;
                if (!diffQuestions || diffQuestions.length === 0) return;

                const q = diffQuestions[Math.floor(Math.random() * diffQuestions.length)];
                this.currentQuizQuestion = q;

                const panel = document.getElementById('infoPanel');
                if (!panel) return;

                // Shuffle options
                const shuffled = [...q.options].sort(() => Math.random() - 0.5);

                panel.innerHTML = `
                    <div class="quiz-question-box">
                        <div style="font-family: 'Barlow Condensed', sans-serif; font-size: 12px; color: #666; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px;">
                            ${this.quizCategory} — ${this.quizDifficulty === 'easy' ? 'Fácil' : this.quizDifficulty === 'medium' ? 'Medio' : 'Difícil'}
                        </div>
                        <div style="font-family: 'Barlow Condensed', sans-serif; font-size: 22px; color: #fafafa; font-weight: 600; margin-bottom: 20px;">
                            ${q.q}
                        </div>
                        <div id="quizOptions">
                            ${shuffled.map((opt, i) => `
                                <button class="quiz-option" data-answer="${opt}" data-correct="${opt === q.a}">
                                    <span style="font-weight: 700; color: #666; margin-right: 12px;">${String.fromCharCode(65 + i)}.</span>
                                    ${opt}
                                </button>
                            `).join('')}
                        </div>
                        <div id="quizFeedback" style="margin-top: 16px; display: none;"></div>
                    </div>
                `;

                // Bind option clicks
                panel.querySelectorAll('.quiz-option').forEach(btn => {
                    btn.addEventListener('click', () => this.answerQuiz(btn));
                });

                this.updateDisplay('QUIZ INTERACTIVO', `Categoría: ${this.quizCategory} | Dificultad: ${this.quizDifficulty}`);
            },

            answerQuiz(btn) {
                if (this.quizAnswered) return;
                this.quizAnswered = true;

                const isCorrect = btn.dataset.correct === 'true';
                const options = document.querySelectorAll('.quiz-option');

                options.forEach(opt => {
                    opt.classList.add('disabled');
                    if (opt.dataset.correct === 'true') {
                        opt.classList.add('correct');
                    }
                });

                if (isCorrect) {
                    btn.classList.add('correct');
                    const points = this.quizDifficulty === 'easy' ? 10 : this.quizDifficulty === 'medium' ? 20 : 30;
                    this.quizScore += points;
                    this.quizStreak++;
                    if (this.quizStreak > this.quizBest) this.quizBest = this.quizStreak;

                    // Streak bonus
                    if (this.quizStreak >= 3) {
                        this.quizScore += this.quizStreak * 5;
                        this.announce(`¡Correcto! Ganaste ${points} puntos. Racha de ${this.quizStreak}. Bonus: ${this.quizStreak * 5} puntos.`);
                    } else {
                        this.announce(`¡Correcto! Ganaste ${points} puntos.`);
                    }
                } else {
                    btn.classList.add('incorrect');
                    this.quizStreak = 0;
                    this.announce(`Incorrecto. La respuesta correcta era: ${this.currentQuizQuestion.a}`);
                }

                // Update score display
                const scoreEl = document.getElementById('quizScore');
                const streakEl = document.getElementById('quizStreak');
                const bestEl = document.getElementById('quizBest');
                if (scoreEl) scoreEl.textContent = this.quizScore;
                if (streakEl) streakEl.textContent = this.quizStreak;
                if (bestEl) bestEl.textContent = this.quizBest;

                // Guardar progreso
                this.saveProgress();

                // Show feedback
                const feedback = document.getElementById('quizFeedback');
                if (feedback) {
                    feedback.style.display = 'block';
                    feedback.innerHTML = `
                        <div style="padding: 12px; border-radius: 10px; background: ${isCorrect ? 'rgba(34, 197, 94, 0.1)' : 'rgba(220, 38, 38, 0.1)'}; border: 1px solid ${isCorrect ? '#22c55e' : '#dc2626'};">
                            <span style="font-weight: 700; color: ${isCorrect ? '#22c55e' : '#dc2626'};">
                                ${isCorrect ? '¡Correcto!' : 'Incorrecto'}
                            </span>
                            <span style="color: #ccc; margin-left: 8px;">
                                La respuesta es: <strong>${this.currentQuizQuestion.a}</strong>
                                ${this.quizStreak >= 3 ? ` | ¡Racha de ${this.quizStreak}! (+${this.quizStreak * 5} bonus)` : ''}
                            </span>
                        </div>
                    `;
                }
            },

            // ========== NIVEL 11 - ACORDES EXTENDIDOS ==========

            showExtendedChord() {
                this.resetState();
                this.hideUIElements();

                const rootName = MusicTheory.getNoteName(this.currentRoot);
                const ext = this.currentExtension;
                const qual = this.currentExtQuality;

                // Map quality+extension to chord key
                const chordMap = {
                    'maj-9': 'maj9', 'dom-9': 'dom9', 'min-9': 'min9', 'alt-9': '7#9',
                    'maj-11': 'maj11', 'dom-11': 'dom11', 'min-11': 'min11', 'alt-11': 'min11',
                    'maj-13': 'maj13', 'dom-13': 'dom13', 'min-13': 'min13', 'alt-13': 'dom13',
                };
                const altMap = {
                    'alt-9': '7#9',
                };

                const chordKey = altMap[`${qual}-${ext}`] || chordMap[`${qual}-${ext}`] || 'dom9';
                const chordData = MusicTheory.extendedChords[chordKey];

                if (!chordData) return;

                // Show notes on fretboard
                Fretboard.tonicNote = this.currentRoot;
                Fretboard.currentScale = chordData.intervals.map((interval, i) => ({
                    note: MusicTheory.getNoteName(this.currentRoot + interval),
                    degree: i + 1
                }));
                Fretboard.highlightedNotes.clear();
                Fretboard.clearZone();
                Fretboard.specificPositions = null;
                Fretboard.updateDisplay();

                // Show voicing diagram if available
                const voicingMap = {
                    'maj9': 'maj9_A', 'min9': 'min9_A', 'dom9': 'dom9_E',
                    '7#9': '7#9_E', '7b9': '7b9_E', 'min11': 'min11_A',
                    'dom11': 'dom11_A', 'maj11': 'maj11_A', 'maj13': 'maj13_A', 'dom13': 'dom13_E',
                };
                const voicingKey = voicingMap[chordKey];
                const voicing = voicingKey ? MusicTheory.extendedVoicings[voicingKey] : null;

                const diagramContainer = document.getElementById('diagramsContainer');
                if (voicing && diagramContainer) {
                    diagramContainer.innerHTML = '';
                    diagramContainer.classList.remove('hidden');
                    const isAShape = voicingKey.includes('_A');
                    const baseNote = isAShape ? 9 : 4;
                    const position = (this.currentRoot - baseNote + 12) % 12;
                    const chordName = `${rootName}${chordData.symbol}`;
                    const diagram = ChordDiagram.create({ frets: voicing.frets, fingers: null, barreInfo: null }, chordName, position);
                    diagramContainer.appendChild(diagram);
                }

                this.updateDisplay(
                    `${rootName} ${chordData.name}`,
                    `Fórmula: ${chordData.formula} | Notas: ${chordData.intervals.map(i => MusicTheory.getNoteName(this.currentRoot + i)).join(' - ')}`
                );

                // Info panel
                const panel = document.getElementById('infoPanel');
                if (panel) {
                    const tensionInfo = {
                        '9': 'La 9ª añade color y amplitud. Disponible en acordes mayores, menores y dominantes.',
                        '11': 'La 11ª añade suspensión. En acordes mayores suele ser "evitada" (tensión #11 es preferida = Lidio).',
                        '13': 'La 13ª añade riqueza. En dominantes, aporta un color dulce pre-resolución.',
                    };
                    const qualInfo = {
                        'maj': 'Sonido sofisticado, brillante. Común en jazz, bossa nova, neo-soul.',
                        'dom': 'Sonido con tensión dominante. Perfecto para resoluciones V→I con color.',
                        'min': 'Sonido melancólico pero rico. Esencial en jazz modal y R&B.',
                        'alt': 'Sonido extremadamente tenso. Dominantes alterados con #9/b9 para máxima resolución.',
                    };
                    const degreeNames = ['1', '3', '5', '7', '9', '11', '13'];
                    const extensionDegrees = ['7', '9', '11', '13'];
                    panel.innerHTML = `
                        <div class="scale-info-box">
                            <div class="info-header">
                                <div class="info-title">${chordData.name}</div>
                                <div class="info-emotion">${chordData.formula}</div>
                            </div>
                            <div class="info-section" style="margin-top: 12px;">
                                <div class="info-label" style="font-size: 14px; margin-bottom: 8px;">Notas del acorde</div>
                                <div class="flex flex-wrap gap-4 mt-2">
                                    ${chordData.intervals.map((interval, i) => {
                                        const noteName = MusicTheory.getNoteName(this.currentRoot + interval);
                                        const degree = degreeNames[i] || '';
                                        const isRoot = i === 0;
                                        const isExtension = extensionDegrees.includes(degree);
                                        const bgStyle = isRoot
                                            ? 'background: linear-gradient(135deg, #dc2626, #991b1b); border-color: #dc2626;'
                                            : 'background: #1a1a1a; border-color: ' + (isExtension ? '#d4a574' : '#333') + ';';
                                        return `<div style="padding: 14px 18px; ${bgStyle} border: 2px solid; border-radius: 10px; text-align: center; min-width: 60px;">
                                            <div style="font-family: 'Bebas Neue', sans-serif; font-size: 24px; font-weight: 400; color: #fafafa; line-height: 1;">${noteName}</div>
                                            <div style="font-size: 12px; color: ${isExtension ? '#d4a574' : '#888'}; margin-top: 4px; font-weight: ${isExtension ? '700' : '400'};">${degree}</div>
                                        </div>`;
                                    }).join('')}
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4" style="margin-top: 16px;">
                                <div class="info-section accent">
                                    <div class="info-label" style="font-size: 14px;">Sobre la extensión ${ext}ª</div>
                                    <div class="info-description" style="color: #ccc; font-size: 14px; line-height: 1.5;">${tensionInfo[ext] || ''}</div>
                                </div>
                                <div class="info-section">
                                    <div class="info-label" style="font-size: 14px;">Calidad: ${qual}</div>
                                    <div class="info-description" style="color: #ccc; font-size: 14px; line-height: 1.5;">${qualInfo[qual] || ''}</div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            },

            // ========== NIVEL 12 - DOMINANTES SECUNDARIOS ==========

            showSecondaryDominant() {
                this.hideUIElements();

                if (!this.currentSecondary) {
                    this.currentSecondary = 'ii';
                }

                const rootName = MusicTheory.getNoteName(this.currentRoot);
                const secDom = MusicTheory.secondaryDominants[this.currentSecondary];
                if (!secDom) return;

                // Calculate the secondary dominant root
                const secDomRoot = (this.currentRoot + secDom.rootOffset) % 12;
                const secDomRootName = MusicTheory.getNoteName(secDomRoot);

                // Calculate target chord root
                const scale = MusicTheory.getScale(this.currentRoot, 'major');
                const targetRoot = scale[secDom.target - 1].note;
                const targetRootIndex = MusicTheory.getNoteIndex(targetRoot);

                // Show dominant 7 chord on fretboard
                const dom7intervals = [0, 4, 7, 10]; // dom7
                Fretboard.tonicNote = secDomRoot;
                Fretboard.currentScale = dom7intervals.map((interval, i) => ({
                    note: MusicTheory.getNoteName(secDomRoot + interval),
                    degree: i + 1
                }));
                Fretboard.highlightedNotes.clear();
                Fretboard.clearZone();
                Fretboard.specificPositions = null;
                Fretboard.updateDisplay();

                // Show chord diagrams (dominante + resolución lado a lado)
                const diagramContainer = document.getElementById('diagramsContainer');
                diagramContainer.innerHTML = '';
                diagramContainer.classList.remove('hidden');

                const pairContainer = document.createElement('div');
                pairContainer.className = 'flex items-center gap-4';
                pairContainer.style.justifyContent = 'center';
                pairContainer.style.flexWrap = 'wrap';

                // Dominante
                const domWrapper = document.createElement('div');
                domWrapper.className = 'chord-wrapper dominant-wrapper';
                const domVoicing = MusicTheory.seventhVoicings['dom7_E'];
                const domPosition = (secDomRoot - 4 + 12) % 12;
                const domDiagram = ChordDiagram.create(domVoicing, `${secDomRootName}7`, domPosition);
                domWrapper.appendChild(domDiagram);

                const domLabel = document.createElement('div');
                domLabel.textContent = 'Dominante Secundario';
                domLabel.style.cssText = 'text-align: center; font-size: 12px; color: #d97706; margin-top: 8px; font-weight: 600;';
                domWrapper.appendChild(domLabel);

                // Flecha
                const arrow = document.createElement('div');
                arrow.innerHTML = '→';
                arrow.style.cssText = 'font-size: 48px; color: #dc2626; font-weight: bold;';

                // Resolución (acorde objetivo)
                const targetQuality = secDom.target === 2 || secDom.target === 3 || secDom.target === 6 ? 'm' : '';
                const targetWrapper = document.createElement('div');
                targetWrapper.className = 'chord-wrapper target-wrapper';

                // Obtener voicing para el acorde objetivo
                let targetVoicing;
                if (targetQuality === 'm') {
                    targetVoicing = MusicTheory.chordVoicings['E_shape_minor'];
                } else {
                    targetVoicing = MusicTheory.chordVoicings['E_shape_major'];
                }
                const targetPosition = (targetRootIndex - 4 + 12) % 12;
                const targetDiagram = ChordDiagram.create(targetVoicing, `${targetRoot}${targetQuality}`, targetPosition);
                targetWrapper.appendChild(targetDiagram);

                const targetLabel = document.createElement('div');
                targetLabel.textContent = 'Resolución';
                targetLabel.style.cssText = 'text-align: center; font-size: 12px; color: #22c55e; margin-top: 8px; font-weight: 600;';
                targetWrapper.appendChild(targetLabel);

                pairContainer.appendChild(domWrapper);
                pairContainer.appendChild(arrow);
                pairContainer.appendChild(targetWrapper);

                diagramContainer.appendChild(pairContainer);

                // Example in current key
                const exampleInKey = `${secDomRootName}7 → ${targetRoot}${secDom.target === 6 || secDom.target === 2 || secDom.target === 3 ? 'm' : ''}`;

                this.updateDisplay(
                    `${secDom.roman} en ${rootName} Mayor`,
                    `${secDom.name}: ${exampleInKey} | Dominante que resuelve al grado ${this.currentSecondary}`
                );

                // Info panel
                const panel = document.getElementById('infoPanel');
                if (panel) {
                    const targetQuality = secDom.target === 2 || secDom.target === 3 || secDom.target === 6 ? 'm' : '';
                    panel.innerHTML = `
                        <div class="scale-info-box">
                            <div class="info-header">
                                <div class="info-title">${secDom.roman} — ${secDom.name}</div>
                                <div class="info-emotion">Dominante Secundario en ${rootName} Mayor</div>
                            </div>
                            <div class="flex items-center justify-center gap-4 my-6">
                                <div class="sec-dom-chord dominant">
                                    <div style="font-family: 'Bebas Neue'; font-size: 24px; color: #d97706;">${secDomRootName}7</div>
                                    <div style="font-size: 10px; color: #888;">${secDom.roman}</div>
                                </div>
                                <div class="sec-dom-arrow">→</div>
                                <div class="sec-dom-chord target">
                                    <div style="font-family: 'Bebas Neue'; font-size: 24px; color: #22c55e;">${targetRoot}${targetQuality}</div>
                                    <div style="font-size: 10px; color: #888;">${this.currentSecondary}</div>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="info-section accent">
                                    <div class="info-label">¿Qué es?</div>
                                    <div class="info-description" style="color: #ccc;">
                                        Un dominante secundario es un acorde V7 que resuelve a un grado
                                        que no es el I. Crea tensión momentánea "prestada" de otra tonalidad.
                                    </div>
                                </div>
                                <div class="info-section">
                                    <div class="info-label">Efecto armónico</div>
                                    <div class="info-description" style="color: #ccc;">
                                        ${secDomRootName}7 contiene un tritono que resuelve naturalmente
                                        a ${targetRoot}${targetQuality}. Es como hacer una mini-modulación
                                        temporal al grado ${this.currentSecondary}.
                                    </div>
                                </div>
                            </div>
                            <div class="info-section" style="margin-top: 12px;">
                                <div class="info-label">Notas del ${secDomRootName}7</div>
                                <div class="flex flex-wrap gap-3 mt-2">
                                    ${dom7intervals.map((interval, i) => {
                                        const noteName = MusicTheory.getNoteName(secDomRoot + interval);
                                        const names = ['1 (Raíz)', '3ª Mayor', '5ª Justa', '7ª menor'];
                                        return `<div style="padding: 8px 14px; background: ${i === 0 ? '#dc2626' : '#1a1a1a'}; border: 2px solid ${i === 0 ? '#dc2626' : '#333'}; border-radius: 8px; text-align: center;">
                                            <div style="font-family: 'IBM Plex Mono'; font-size: 14px; font-weight: 700; color: #fafafa;">${noteName}</div>
                                            <div style="font-size: 10px; color: #888; margin-top: 2px;">${names[i]}</div>
                                        </div>`;
                                    }).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                }
            },

            showSecondaryProgression() {
                if (!this.currentSecProg) return;
                const prog = MusicTheory.secondaryProgressions[this.currentSecProg - 1];
                if (!prog) return;

                this.hideUIElements();
                const rootName = MusicTheory.getNoteName(this.currentRoot);
                const scale = MusicTheory.getScale(this.currentRoot, 'major');

                // Build chords
                const degreeMap = {
                    'I': { root: 0, quality: '' },
                    'ii': { root: 1, quality: 'm' },
                    'iii': { root: 2, quality: 'm' },
                    'IV': { root: 3, quality: '' },
                    'V': { root: 4, quality: '' },
                    'vi': { root: 5, quality: 'm' },
                    'V/ii': { root: -1, quality: '7', secTarget: 'ii' },
                    'V/iii': { root: -1, quality: '7', secTarget: 'iii' },
                    'V/IV': { root: -1, quality: '7', secTarget: 'IV' },
                    'V/V': { root: -1, quality: '7', secTarget: 'V' },
                    'V/vi': { root: -1, quality: '7', secTarget: 'vi' },
                };

                const chordNames = prog.degrees.map(deg => {
                    const info = degreeMap[deg];
                    if (!info) return deg;
                    if (info.secTarget) {
                        const secDom = MusicTheory.secondaryDominants[info.secTarget];
                        const secRoot = MusicTheory.getNoteName((this.currentRoot + secDom.rootOffset) % 12);
                        return `${secRoot}${info.quality}`;
                    }
                    return `${scale[info.root].note}${info.quality}`;
                });

                this.updateDisplay(
                    `${prog.name} en ${rootName}`,
                    `${prog.description} | ${chordNames.join(' → ')}`
                );

                // Show in info panel
                const panel = document.getElementById('infoPanel');
                if (panel) {
                    panel.innerHTML = `
                        <div class="scale-info-box">
                            <div class="info-header">
                                <div class="info-title">${prog.name}</div>
                                <div class="info-emotion">${prog.description}</div>
                            </div>
                            <div class="flex flex-wrap items-center justify-center gap-3 my-6">
                                ${prog.degrees.map((deg, i) => {
                                    const isSecondary = deg.startsWith('V/');
                                    const chord = chordNames[i];
                                    return `
                                        ${i > 0 ? '<div class="sec-dom-arrow">→</div>' : ''}
                                        <div class="sec-dom-chord ${isSecondary ? 'dominant' : deg === 'I' ? 'target' : ''}">
                                            <div style="font-family: 'Bebas Neue'; font-size: 22px; color: ${isSecondary ? '#d97706' : '#fafafa'};">${chord}</div>
                                            <div style="font-size: 10px; color: #888;">${deg}</div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                }

                Fretboard.showScale(this.currentRoot, 'major');
            },

            // ========== NIVEL 13 - CANCIONES ==========

            showSongs() {
                this.resetState();
                this.hideUIElements();
                this.updateDisplay('BIBLIOTECA DE CANCIONES', 'Analiza la teoría detrás de canciones reales');
                this.renderSongList();
            },

            renderSongList() {
                const panel = document.getElementById('infoPanel');
                if (!panel) return;

                let songs = [...MusicTheory.songs];

                // Filter by genre
                if (this.songGenreFilter !== 'all') {
                    const genreMap = {
                        'metal': ['Thrash Metal', 'Heavy Metal', 'Groove Metal', 'Nu Metal'],
                        'prog': ['Rock Progresivo', 'Metal Progresivo'],
                        'rock': ['Hard Rock', 'Rock', 'Grunge', 'Alternative'],
                        'blues': ['Blues', 'Blues Rock'],
                        'jazz': ['Jazz', 'Bossa Nova', 'Cool Jazz'],
                        'funk': ['Funk', 'Soul', 'Funk/Soul'],
                        'pop': ['Pop', 'Pop Rock', 'Soft Rock'],
                        'latin': ['Flamenco', 'Latin', 'Latin Rock'],
                        'country': ['Country', 'Country Rock'],
                        'reggae': ['Reggae'],
                    };
                    const genres = genreMap[this.songGenreFilter] || [];
                    songs = songs.filter(s => genres.includes(s.genre));
                }

                const genreColor = (genre) => {
                    if (genre.includes('Metal') || genre.includes('Nu')) return 'metal';
                    if (genre.includes('Progresivo')) return 'prog';
                    if (genre.includes('Blues')) return 'blues';
                    if (genre.includes('Jazz') || genre.includes('Bossa') || genre.includes('Cool')) return 'jazz';
                    if (genre.includes('Funk') || genre.includes('Soul')) return 'funk';
                    if (genre.includes('Pop') || genre.includes('Soft')) return 'pop';
                    if (genre.includes('Flamenco') || genre.includes('Latin')) return 'latin';
                    if (genre.includes('Country')) return 'country';
                    if (genre.includes('Reggae')) return 'reggae';
                    if (genre.includes('Grunge') || genre.includes('Alternative')) return 'grunge';
                    return 'rock';
                };

                panel.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        ${songs.map((song, i) => {
                            // Get the actual index in the full MusicTheory.songs array
                            const actualIndex = MusicTheory.songs.indexOf(song);
                            return `
                            <div class="song-card ${this.currentSong === actualIndex ? 'active' : ''}" data-song="${actualIndex}">
                                <div class="flex items-start justify-between mb-2">
                                    <div>
                                        <div style="font-family: 'Barlow Condensed'; font-size: 17px; font-weight: 700; color: #fafafa; text-transform: uppercase;">${song.name}</div>
                                        <div style="font-size: 13px; color: #888;">${song.artist}</div>
                                    </div>
                                    <span class="genre-badge ${genreColor(song.genre)}">${song.genre}</span>
                                </div>
                                <div class="flex items-center justify-between mt-3">
                                    <div style="font-family: 'IBM Plex Mono'; font-size: 12px; color: #666;">
                                        ${MusicTheory.getNoteName(song.key)} ${song.mode === 'major' ? 'Mayor' : 'menor'}
                                    </div>
                                </div>
                                <div style="font-family: 'IBM Plex Mono'; font-size: 11px; color: #555; margin-top: 6px;">
                                    ${song.progressionChords.join(' → ')}
                                </div>
                            </div>
                        `}).join('')}
                        ${songs.length === 0 ? '<div style="color: #666; grid-column: 1/-1; text-align: center; padding: 40px;">No hay canciones con estos filtros</div>' : ''}
                    </div>
                `;

                // Bind card clicks
                panel.querySelectorAll('.song-card').forEach(card => {
                    card.addEventListener('click', () => {
                        const songIndex = parseInt(card.dataset.song);
                        this.currentSong = songIndex;
                        panel.querySelectorAll('.song-card').forEach(c => c.classList.remove('active'));
                        card.classList.add('active');
                        this.showSongDetail(MusicTheory.songs[songIndex]);
                    });
                });
            },

            showSongDetail(song) {
                const rootName = MusicTheory.getNoteName(song.key);
                const scaleType = song.scale || 'minor';

                // Show scale on fretboard
                Fretboard.showScale(song.key, scaleType);

                this.updateDisplay(
                    `${song.name} — ${song.artist}`,
                    `${rootName} ${song.mode === 'major' ? 'Mayor' : 'menor'} | ${song.genre} | ${song.progressionChords.join(' → ')}`
                );

                // Show chord diagrams
                const diagramContainer = document.getElementById('diagramsContainer');
                if (diagramContainer && song.progressionChords[0] !== 'Instrumental') {
                    diagramContainer.innerHTML = '';
                    diagramContainer.classList.remove('hidden');

                    song.progressionChords.forEach(chordStr => {
                        const cleanName = chordStr.replace(/5$/, '').replace(/\/.*/, '');
                        const isMinor = cleanName.endsWith('m') || chordStr.includes('m');
                        const rootNote = cleanName.replace(/m$/, '').replace(/b$/, 'b');
                        const rootIdx = MusicTheory.getNoteIndex(rootNote);

                        let voicingKey = isMinor ? `${rootNote}m` : rootNote;
                        let voicing = MusicTheory.chordVoicings[voicingKey];
                        let position = 0;

                        if (!voicing) {
                            const shape = isMinor ? 'E_shape_minor' : 'E_shape_major';
                            voicing = MusicTheory.chordVoicings[shape];
                            position = (rootIdx - 4 + 12) % 12;
                        }

                        if (voicing) {
                            const diagram = ChordDiagram.create(voicing, chordStr, position);
                            diagram.style.display = 'inline-block';
                            diagram.style.margin = '0 8px';
                            diagramContainer.appendChild(diagram);
                        }
                    });
                }

                // Scroll detail into view with tips in info panel supplement
                const panel = document.getElementById('infoPanel');
                if (panel) {
                    // Keep the song cards, add detail below
                    const existing = panel.querySelector('.song-detail-box');
                    if (existing) existing.remove();

                    const detailBox = document.createElement('div');
                    detailBox.className = 'song-detail-box scale-info-box';
                    detailBox.style.marginTop = '20px';
                    detailBox.innerHTML = `
                        <div class="info-header">
                            <div class="info-title">${song.name}</div>
                            <div class="info-emotion">${song.artist} — ${song.genre}</div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="info-section accent">
                                <div class="info-label">Progresión</div>
                                <div class="info-value" style="font-size: 16px;">${song.progression.join(' → ')}</div>
                                <div class="info-description" style="margin-top: 8px;">Acordes: ${song.progressionChords.join(' → ')}</div>
                            </div>
                            <div class="info-section">
                                <div class="info-label">Escala Base</div>
                                <div class="info-value" style="font-size: 16px;">${rootName} ${App.SCALE_NAMES[scaleType] || scaleType}</div>
                            </div>
                        </div>
                        <div class="info-section" style="margin-top: 12px;">
                            <div class="info-label">Tips para tocar</div>
                            <div class="info-description" style="color: #ccc; font-size: 15px; line-height: 1.6;">${song.tips}</div>
                        </div>
                    `;
                    panel.appendChild(detailBox);
                }
            },

            // ========== LABORATORIO DE ESCALAS ==========

            initScaleLab() {
                this.renderScaleCategories();
                this.renderScaleList('major');
                this.populateCompareSelect();
            },

            renderScaleCategories() {
                const container = document.getElementById('scaleCategoryBtns');
                if (!container) return;
                // Usa CATEGORY_SCALES consolidado
            },

            renderScaleList(category) {
                const container = document.getElementById('scaleListContainer');
                if (!container) return;

                container.innerHTML = '';
                const scales = this.CATEGORY_SCALES[category] || [];

                scales.forEach(scaleKey => {
                    const info = MusicTheory.scaleInfo[scaleKey];
                    const item = document.createElement('div');
                    item.className = `scale-list-item ${scaleKey === this.currentLabScale ? 'active' : ''}`;
                    item.dataset.scale = scaleKey;

                    const name = info ? info.name : scaleKey;
                    const emotion = info ? info.emotion : '';

                    item.innerHTML = `
                        <div class="scale-name">${name}</div>
                        <div class="scale-emotion">${emotion}</div>
                    `;

                    item.addEventListener('click', () => {
                        document.querySelectorAll('.scale-list-item').forEach(i => i.classList.remove('active'));
                        item.classList.add('active');
                        this.currentLabScale = scaleKey;
                        this.showScaleInfo(scaleKey);
                        this.showScaleHarmonization(scaleKey);
                        this.updateComparison();
                    });

                    container.appendChild(item);
                });

                // Auto-select first scale if none selected
                if (scales.length > 0 && !scales.includes(this.currentLabScale)) {
                    this.currentLabScale = scales[0];
                    container.querySelector('.scale-list-item')?.classList.add('active');
                }

                this.showScaleInfo(this.currentLabScale);
                this.showScaleHarmonization(this.currentLabScale);
            },

            showScaleInfo(scaleKey) {
                const infoBox = document.getElementById('scaleInfoBox');
                if (!infoBox) return;

                const info = MusicTheory.scaleInfo[scaleKey];
                const formula = MusicTheory.scales[scaleKey];

                if (!info && !formula) {
                    infoBox.classList.add('hidden');
                    return;
                }

                infoBox.classList.remove('hidden');

                document.getElementById('scaleInfoName').textContent = info?.name || scaleKey;
                document.getElementById('scaleInfoCategory').textContent =
                    MusicTheory.scaleCategories[info?.category]?.name || info?.category || '';
                document.getElementById('scaleInfoFormula').textContent = info?.formula ||
                    formula.map(i => MusicTheory.intervalNames[i]).join(' - ');
                document.getElementById('scaleInfoEmotion').textContent = info?.emotion || '';
                document.getElementById('scaleInfoUsage').textContent = info?.usage || '';

                // Show parent info if exists
                const parentInfo = MusicTheory.getParentInfo(scaleKey);
                const parentSection = document.getElementById('scaleInfoParent');
                if (parentInfo) {
                    parentSection.classList.remove('hidden');
                    document.getElementById('scaleInfoParentText').textContent =
                        `${parentInfo.parentName} (grado ${parentInfo.degree})`;
                } else {
                    parentSection.classList.add('hidden');
                }
            },

            showScaleHarmonization(scaleKey) {
                const section = document.getElementById('scaleHarmonizationSection');
                const container = document.getElementById('scaleHarmonizationChords');
                if (!section || !container) return;

                const formula = MusicTheory.scales[scaleKey];

                // Only show for 7-note scales
                if (formula.length !== 7) {
                    section.classList.add('hidden');
                    return;
                }

                section.classList.remove('hidden');
                container.innerHTML = '';

                const harmonization = MusicTheory.getScaleHarmonization(this.currentRoot, scaleKey);
                const romanNumerals = ['I', 'II', 'III', 'IV', 'V', 'VI', 'VII'];
                const qualitySymbols = {
                    'maj': '', 'min': 'm', 'dim': '°', 'aug': '+', 'sus2': 'sus2', 'sus4': 'sus4', '?': '?'
                };

                harmonization.forEach((chord, i) => {
                    const btn = document.createElement('button');
                    btn.className = `harm-chord-btn ${this.currentLabHarmChord === i ? 'active' : ''}`;
                    btn.innerHTML = `
                        <span>${chord.root}${qualitySymbols[chord.quality]}</span>
                        <span class="chord-quality">${romanNumerals[i]}${qualitySymbols[chord.quality]}</span>
                    `;
                    btn.addEventListener('click', () => {
                        document.querySelectorAll('.harm-chord-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        this.currentLabHarmChord = i;
                        this.showLabChord(chord);
                    });
                    container.appendChild(btn);
                });
            },

            showLabChord(chord) {
                const chordRootIndex = MusicTheory.getNoteIndex(chord.root);
                const qualityNames = { maj: 'Mayor', min: 'menor', dim: 'disminuido', aug: 'aumentado' };

                // Show on fretboard
                Fretboard.tonicNote = chordRootIndex;
                Fretboard.currentScale = [
                    { note: chord.root, degree: 1 },
                    { note: chord.third, degree: 3 },
                    { note: chord.fifth, degree: 5 }
                ];
                Fretboard.highlightedNotes.clear();
                Fretboard.clearZone();
                Fretboard.specificPositions = null;
                Fretboard.blueNoteIndex = null;
                Fretboard.updateDisplay();

                // Show chord diagram if possible
                const voicingKey = chord.quality === 'min' ? `${chord.root}m` : chord.root;
                let voicing = MusicTheory.chordVoicings[voicingKey];
                let position = 0;

                if (!voicing) {
                    const shape = chord.quality === 'min' ? 'E_shape_minor' : 'E_shape_major';
                    voicing = MusicTheory.chordVoicings[shape];
                    // Calculate position: distance from E (4) to target note
                    position = (chordRootIndex - 4 + 12) % 12;
                }

                const diagramContainer = document.getElementById('diagramsContainer');
                if (diagramContainer && voicing) {
                    diagramContainer.innerHTML = '';
                    diagramContainer.classList.remove('hidden');
                    const chordName = chord.quality === 'min' ? `${chord.root}m` : chord.root;
                    const diagram = ChordDiagram.create(voicing, chordName, position);
                    diagramContainer.appendChild(diagram);
                }

                const rootName = MusicTheory.getNoteName(this.currentRoot);
                const info = MusicTheory.scaleInfo[this.currentLabScale];
                document.getElementById('displayTitle').textContent =
                    `Acorde ${chord.degree} de ${rootName} ${info?.name || this.currentLabScale}`;
                document.getElementById('displaySubtitle').textContent =
                    `${chord.root} ${qualityNames[chord.quality] || chord.quality} | Notas: ${chord.root} - ${chord.third} - ${chord.fifth}`;
            },

            populateCompareSelect() {
                const select = document.getElementById('compareScaleSelect');
                if (!select) return;

                select.innerHTML = '<option value="">Selecciona para comparar...</option>';

                const categories = {
                    'Mayores': ['major'],
                    'Menores': ['minor', 'harmonicMinor', 'melodicMinor'],
                    'Modos': ['dorian', 'phrygian', 'lydian', 'mixolydian', 'locrian'],
                    'Pentatónicas': ['pentatonicMajor', 'pentatonicMinor', 'blues'],
                    'Simétricas': ['wholeTone', 'diminished'],
                    'Exóticas': ['hungarian', 'byzantine', 'phrygianDom', 'japanese']
                };

                Object.entries(categories).forEach(([catName, scales]) => {
                    const optgroup = document.createElement('optgroup');
                    optgroup.label = catName;
                    scales.forEach(scaleKey => {
                        const info = MusicTheory.scaleInfo[scaleKey];
                        const option = document.createElement('option');
                        option.value = scaleKey;
                        option.textContent = info?.name || scaleKey;
                        optgroup.appendChild(option);
                    });
                    select.appendChild(optgroup);
                });

                select.addEventListener('change', (e) => {
                    this.compareScale = e.target.value || null;
                    this.updateComparison();
                });
            },

            updateComparison() {
                const resultDiv = document.getElementById('scaleComparisonResult');
                if (!resultDiv) return;

                if (!this.compareScale) {
                    resultDiv.classList.add('hidden');
                    return;
                }

                const comparison = MusicTheory.compareScales(this.currentLabScale, this.compareScale);
                resultDiv.classList.remove('hidden');

                document.getElementById('scaleSimilarity').textContent = `${comparison.similarity}%`;
                document.getElementById('scaleCommonNotes').textContent =
                    comparison.common.map(i => MusicTheory.intervalNames[i]).join(', ') || 'Ninguna';
                document.getElementById('scaleOnlyFirst').textContent =
                    comparison.onlyInFirst.map(i => MusicTheory.intervalNames[i]).join(', ') || 'Ninguna';
                document.getElementById('scaleOnlySecond').textContent =
                    comparison.onlyInSecond.map(i => MusicTheory.intervalNames[i]).join(', ') || 'Ninguna';
            },

            showScaleLab() {
                this.resetState();
                this.currentLabHarmChord = null;
                this.hideUIElements();

                const scaleSelect = document.getElementById('scaleSelect');
                if (scaleSelect) scaleSelect.value = this.currentLabScale;
                this.currentScale = this.currentLabScale;

                Fretboard.showScale(this.currentRoot, this.currentLabScale);

                const rootName = MusicTheory.getNoteName(this.currentRoot);
                const info = MusicTheory.scaleInfo[this.currentLabScale];
                const formula = MusicTheory.scales[this.currentLabScale];

                this.updateDisplay(
                    `${rootName} ${info?.name || this.currentLabScale}`,
                    `${formula.length} notas | ${info?.emotion || ''} | Fórmula: ${formula.map(i => MusicTheory.intervalNames[i]).join('-')}`
                );
            },

            // ========== NIVEL 17 - LICK LIBRARY ==========

            showLickLibrary() {
                this.resetState();
                this.hideUIElements();
                this.updateDisplay('LICK LIBRARY', 'Biblioteca de licks con tabs interactivos');

                // Initialize state
                this.lickFilters = {
                    genre: 'all',
                    technique: 'all',
                    difficulty: 'all'
                };
                this.currentLick = null;
                this.lickPlaybackInterval = null;

                this.renderLickGrid();
            },

            renderLickGrid() {
                const grid = document.getElementById('lickGrid');
                if (!grid) return;

                // Filter licks
                let licks = MusicTheory.licks.filter(lick => {
                    if (this.lickFilters.genre !== 'all' && lick.genre !== this.lickFilters.genre) return false;
                    if (this.lickFilters.technique !== 'all' && lick.technique !== this.lickFilters.technique) return false;
                    if (this.lickFilters.difficulty !== 'all' && lick.difficulty !== this.lickFilters.difficulty) return false;
                    return true;
                });

                // Difficulty colors
                const difficultyColor = {
                    'easy': '#10b981',
                    'medium': '#eab308',
                    'hard': '#f97316',
                    'expert': '#dc2626'
                };

                // Technique icons
                const techniqueIcon = {
                    'sweep': '🎸',
                    'tapping': '👆',
                    'alternate': '⚡',
                    'legato': '🎵',
                    'rhythm': '🥁'
                };

                grid.innerHTML = licks.map(lick => `
                    <div class="lick-card" data-lick-id="${lick.id}">
                        <div class="lick-card-header">
                            <div class="lick-icon">${techniqueIcon[lick.technique] || '🎸'}</div>
                            <div class="lick-difficulty" style="color: ${difficultyColor[lick.difficulty]}">
                                ${lick.difficulty.toUpperCase()}
                            </div>
                        </div>
                        <div class="lick-card-title">${lick.name}</div>
                        <div class="lick-card-meta">
                            <span class="lick-genre">${lick.genre}</span>
                            <span class="lick-bpm">${lick.bpm} BPM</span>
                        </div>
                        <div class="lick-card-description">${lick.description}</div>
                        <button class="lick-view-btn ctrl-btn">Ver Tab</button>
                    </div>
                `).join('');
            },

            showLickDetail(lickId) {
                const lick = MusicTheory.licks.find(l => l.id === lickId);
                if (!lick) return;

                this.currentLick = lick;

                const modal = document.getElementById('lickDetailModal');
                const content = document.getElementById('lickDetailContent');

                if (!modal || !content) return;

                // Create tab notation
                const tabContainer = TabNotation.create(lick.tabs, lick.name, lick.bpm);

                content.innerHTML = `
                    <h2 class="text-2xl font-display text-chalk-100 mb-2">${lick.name}</h2>
                    <div class="lick-detail-meta flex gap-4 mb-4 text-sm text-void-300">
                        <span>Género: <strong>${lick.genre}</strong></span>
                        <span>Técnica: <strong>${lick.technique}</strong></span>
                        <span>Dificultad: <strong>${lick.difficulty}</strong></span>
                        <span>Key: <strong>${lick.key}</strong></span>
                    </div>
                    <p class="text-void-200 mb-6">${lick.description}</p>
                    <div id="lickTabContainer"></div>
                    <div class="lick-detail-fretboard mt-6">
                        <h3 class="text-lg font-display mb-2">Visualización en el Diapasón</h3>
                        <div id="lickFretboard"></div>
                    </div>
                `;

                // Append tab notation
                const tabContainerDiv = content.querySelector('#lickTabContainer');
                if (tabContainerDiv) {
                    tabContainerDiv.appendChild(tabContainer);
                }

                // Show fretboard with lick notes
                const fretboardDiv = content.querySelector('#lickFretboard');
                if (fretboardDiv) {
                    const fretboardSvg = this.renderLickFretboard(lick);
                    fretboardDiv.appendChild(fretboardSvg);
                }

                // Show modal
                modal.classList.remove('hidden');
            },

            renderLickFretboard(lick) {
                // Create a simple fretboard showing the lick positions
                const container = document.createElement('div');
                container.className = 'mini-fretboard';

                const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                svg.setAttribute('width', '100%');
                svg.setAttribute('height', '200');
                svg.setAttribute('viewBox', '0 0 600 200');

                // Draw simple fretboard with lick positions highlighted
                const strings = 6;
                const frets = 12;
                const fretWidth = 40;
                const stringHeight = 25;
                const startX = 50;
                const startY = 30;

                // Draw strings
                for (let i = 0; i < strings; i++) {
                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    line.setAttribute('x1', startX);
                    line.setAttribute('y1', startY + i * stringHeight);
                    line.setAttribute('x2', startX + frets * fretWidth);
                    line.setAttribute('y2', startY + i * stringHeight);
                    line.setAttribute('stroke', '#444');
                    line.setAttribute('stroke-width', '1');
                    svg.appendChild(line);
                }

                // Draw frets
                for (let i = 0; i <= frets; i++) {
                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    line.setAttribute('x1', startX + i * fretWidth);
                    line.setAttribute('y1', startY);
                    line.setAttribute('x2', startX + i * fretWidth);
                    line.setAttribute('y2', startY + (strings - 1) * stringHeight);
                    line.setAttribute('stroke', '#444');
                    line.setAttribute('stroke-width', i === 0 ? '3' : '1');
                    svg.appendChild(line);
                }

                // Highlight lick notes
                lick.tabs.forEach((tab, i) => {
                    const x = startX + (tab.fret - 0.5) * fretWidth;
                    const y = startY + (5 - tab.string) * stringHeight;

                    const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                    circle.setAttribute('cx', x);
                    circle.setAttribute('cy', y);
                    circle.setAttribute('r', '8');
                    circle.setAttribute('fill', '#dc2626');
                    circle.setAttribute('opacity', '0.8');
                    svg.appendChild(circle);

                    // Fingering number
                    if (lick.fingering && lick.fingering[i]) {
                        const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                        text.setAttribute('x', x);
                        text.setAttribute('y', y + 4);
                        text.setAttribute('text-anchor', 'middle');
                        text.setAttribute('fill', '#fff');
                        text.setAttribute('font-size', '10');
                        text.setAttribute('font-weight', 'bold');
                        text.textContent = lick.fingering[i] || '';
                        svg.appendChild(text);
                    }
                });

                container.appendChild(svg);
                return container;
            },

            // ========== NIVEL 14 - EAR TRAINING ==========

            showEarTraining() {
                this.resetState();
                this.hideUIElements();
                this.earTrainingAnswered = false;

                // Initialize exercise type if not set
                if (!this.earExerciseType) {
                    this.earExerciseType = 'intervals';
                }

                // Generate question based on exercise type
                switch (this.earExerciseType) {
                    case 'intervals':
                        this.generateIntervalQuestion();
                        break;
                    case 'chords':
                        this.generateChordQuestion();
                        break;
                    case 'progressions':
                        this.generateProgressionQuestion();
                        break;
                    case 'melodic':
                        this.generateMelodicQuestion();
                        break;
                    case 'rhythmic':
                        this.generateRhythmicQuestion();
                        break;
                }

                this.updateDisplay(
                    `EAR TRAINING - ${this.earExerciseType.toUpperCase()} - ${this.earTrainingLevel.toUpperCase()}`,
                    `Puntuación: ${this.earTrainingScore} | Racha: ${this.earTrainingStreak} | Mejor: ${this.earTrainingBest}`
                );

                this.renderEarTrainingPanel();
            },

            generateIntervalQuestion() {
                const intervals = MusicTheory.earTraining.intervals[this.earTrainingLevel];
                this.earTrainingCurrent = intervals[Math.floor(Math.random() * intervals.length)];
            },

            generateChordQuestion() {
                const chords = MusicTheory.earTraining.chordQualities[this.earTrainingLevel];
                this.earTrainingCurrent = chords[Math.floor(Math.random() * chords.length)];
            },

            generateProgressionQuestion() {
                const progressions = MusicTheory.earTraining.progressions[this.earTrainingLevel];
                this.earTrainingCurrent = progressions[Math.floor(Math.random() * progressions.length)];
            },

            generateMelodicQuestion() {
                const patterns = MusicTheory.earTraining.melodicPatterns[this.earTrainingLevel];
                this.earTrainingCurrent = patterns[Math.floor(Math.random() * patterns.length)];
            },

            generateRhythmicQuestion() {
                const patterns = MusicTheory.earTraining.rhythmicPatterns[this.earTrainingLevel];
                this.earTrainingCurrent = patterns[Math.floor(Math.random() * patterns.length)];
            },

            renderEarTrainingPanel() {
                const panel = document.getElementById('earTrainingAnswers');
                const questionLabel = document.getElementById('earQuestionLabel');
                const tipText = document.getElementById('earTipText');
                if (!panel) return;

                let questions = [];
                let questionText = '';
                let tipMessage = '';

                switch (this.earExerciseType) {
                    case 'intervals':
                        questions = MusicTheory.earTraining.intervals[this.earTrainingLevel];
                        questionText = '¿Qué intervalo escuchaste?';
                        tipMessage = 'Escucha el salto entre las dos notas. Los intervalos pequeños suenan cercanos.';
                        panel.innerHTML = questions.map(item => `
                            <button class="mode-btn-simple"
                                    data-answer="${item.semitones}"
                                    style="padding: 12px 8px; text-align: center; font-size: 13px;"
                                    ${this.earTrainingAnswered ? 'disabled' : ''}
                                    title="${item.tip || ''}">
                                <div style="font-weight: 600;">${item.name}</div>
                                <div style="font-size: 10px; color: #999;">${item.semitones} st</div>
                            </button>
                        `).join('');
                        break;

                    case 'chords':
                        questions = MusicTheory.earTraining.chordQualities[this.earTrainingLevel];
                        questionText = '¿Qué tipo de acorde es?';
                        tipMessage = 'Mayor = alegre, Menor = triste, Disminuido = tenso, Aumentado = misterioso.';
                        panel.innerHTML = questions.map(item => `
                            <button class="mode-btn-simple"
                                    data-answer="${item.name}"
                                    style="padding: 12px 8px; text-align: center; font-size: 13px;"
                                    ${this.earTrainingAnswered ? 'disabled' : ''}
                                    title="${item.tip || ''}">
                                <div style="font-weight: 600;">${item.name}</div>
                                <div style="font-size: 10px; color: #999;">${item.abbr}</div>
                            </button>
                        `).join('');
                        break;

                    case 'progressions':
                        questions = MusicTheory.earTraining.progressions[this.earTrainingLevel];
                        questionText = '¿Qué progresión escuchaste?';
                        tipMessage = 'Escucha la secuencia de acordes. I-IV-V es rock básico, ii-V-I es jazz.';
                        panel.innerHTML = questions.map(item => `
                            <button class="mode-btn-simple"
                                    data-answer="${item.name}"
                                    style="padding: 12px 8px; text-align: center; font-size: 13px;"
                                    ${this.earTrainingAnswered ? 'disabled' : ''}
                                    title="${item.tip || ''}">
                                <div style="font-weight: 600;">${item.name}</div>
                            </button>
                        `).join('');
                        break;

                    case 'melodic':
                        questions = MusicTheory.earTraining.melodicPatterns[this.earTrainingLevel];
                        questionText = '¿Qué melodía escuchaste?';
                        tipMessage = 'Escucha la dirección (sube/baja) y el tamaño de los saltos.';
                        panel.innerHTML = questions.map(item => `
                            <button class="mode-btn-simple"
                                    data-answer="${item.name}"
                                    style="padding: 12px 8px; text-align: center; font-size: 13px;"
                                    ${this.earTrainingAnswered ? 'disabled' : ''}
                                    title="${item.tip || ''}">
                                <div style="font-weight: 600;">${item.name}</div>
                            </button>
                        `).join('');
                        break;

                    case 'rhythmic':
                        questions = MusicTheory.earTraining.rhythmicPatterns[this.earTrainingLevel];
                        questionText = '¿Qué ritmo escuchaste?';
                        tipMessage = 'Escucha el patrón de golpes y silencios.';
                        panel.innerHTML = questions.map(item => `
                            <button class="mode-btn-simple"
                                    data-answer="${item.name}"
                                    style="padding: 12px 8px; text-align: center; font-size: 13px;"
                                    ${this.earTrainingAnswered ? 'disabled' : ''}
                                    title="${item.tip || ''}">
                                <div style="font-weight: 600;">${item.name}</div>
                            </button>
                        `).join('');
                        break;
                }

                if (questionLabel) questionLabel.textContent = questionText;
                if (tipText) tipText.textContent = tipMessage;
            },

            playCurrentInterval() {
                if (!this.earTrainingCurrent) return;

                const randomRoot = Math.floor(Math.random() * 12);

                switch (this.earExerciseType) {
                    case 'intervals':
                        AudioEngine.playInterval(randomRoot, this.earTrainingCurrent.semitones, 0.6, 4);
                        break;

                    case 'chords':
                        AudioEngine.playChordQuality(randomRoot, this.earTrainingCurrent.intervals);
                        break;

                    case 'progressions':
                        AudioEngine.playProgressionEarTraining(this.earTrainingCurrent.pattern, randomRoot);
                        break;

                    case 'melodic':
                        this.earTrainingCurrent.notes.forEach((note, i) => {
                            setTimeout(() => {
                                AudioEngine.playNote((randomRoot + note) % 12, 0.4, 4);
                            }, i * 400);
                        });
                        break;

                    case 'rhythmic':
                        AudioEngine.playRhythmPattern(this.earTrainingCurrent.hits);
                        break;
                }
            },

            checkEarTrainingAnswer(answer) {
                if (this.earTrainingAnswered) return;

                this.earTrainingAnswered = true;
                let correct = false;
                let correctAnswer = '';

                switch (this.earExerciseType) {
                    case 'intervals':
                        correct = answer === this.earTrainingCurrent.semitones;
                        correctAnswer = this.earTrainingCurrent.name;
                        break;
                    case 'chords':
                    case 'progressions':
                    case 'melodic':
                    case 'rhythmic':
                        correct = answer === this.earTrainingCurrent.name;
                        correctAnswer = this.earTrainingCurrent.name;
                        break;
                }

                if (correct) {
                    this.earTrainingScore += 10;
                    this.earTrainingStreak++;
                    if (this.earTrainingStreak > this.earTrainingBest) {
                        this.earTrainingBest = this.earTrainingStreak;
                    }

                    this.updateDisplay(
                        `¡CORRECTO! ${correctAnswer}`,
                        `Puntuación: ${this.earTrainingScore} | Racha: ${this.earTrainingStreak} | Mejor: ${this.earTrainingBest}`
                    );
                } else {
                    this.earTrainingStreak = 0;
                    this.updateDisplay(
                        `Incorrecto. Era: ${correctAnswer}`,
                        `Puntuación: ${this.earTrainingScore} | Racha: ${this.earTrainingStreak} | Mejor: ${this.earTrainingBest}`
                    );
                }

                // Auto-advance después de 1.5s
                setTimeout(() => {
                    this.showEarTraining();
                }, 1500);
            },

            // ========== NIVEL 16 - CHORD LAB ==========

            showChordLab() {
                console.log('[Chord Lab] Initializing...');
                this.resetState();
                this.updateDisplay('Chord Laboratory', 'Explore chord voicings and relationships');

                // Initialize Chord Lab mode
                ChordLabState.currentMode = 'explorer';
                ChordLabState.currentRoot = this.currentRoot || 'C';
                ChordLabState.currentQuality = 'maj';
                ChordLabState.filterRegister = 'all';
                ChordLabState.filterDifficulty = 'all';
                ChordLabState.comparisonA = null;
                ChordLabState.comparisonB = null;

                console.log('[Chord Lab] State:', ChordLabState);
                this.showChordLabMode();
            },

            // ========== NIVEL 15 - JAM SESSION ==========

            showJamSession() {
                console.log('[showJamSession] INICIANDO...');
                this.resetState();

                if (!this.currentBackingTrack) {
                    this.currentBackingTrack = MusicTheory.backingTracks[0];
                }

                const track = this.currentBackingTrack;
                const bpm = this.customBPM || track.bpm;

                console.log('[showJamSession] Track:', track);
                console.log('[showJamSession] BPM:', bpm);

                // Renderizar tracks primero
                console.log('[showJamSession] Llamando renderJamTrackGrid...');
                this.renderJamTrackGrid();

                // Renderizar panel de info
                const rootName = MusicTheory.getNoteName(this.currentRoot);
                console.log('[showJamSession] Llamando renderJamSessionPanel...');
                this.renderJamSessionPanel(track, rootName, bpm);

                // Renderizar diapasón con verificación robusta
                console.log('[showJamSession] Llamando renderJamFretboard...');
                this.renderJamFretboard();

                console.log('[showJamSession] TERMINADO');
            },

            renderJamFretboard() {
                console.log('[renderJamFretboard] INICIANDO...');
                const jamFretboard = document.getElementById('jamFretboard');
                console.log('[renderJamFretboard] jamFretboard element:', jamFretboard);

                if (!jamFretboard) {
                    console.error('[Jam Session] jamFretboard container not found');
                    return;
                }

                // Limpiar contenido previo
                jamFretboard.innerHTML = '';
                console.log('[renderJamFretboard] Llamando Fretboard.render...');

                // Renderizar diapasón
                Fretboard.render('jamFretboard');

                console.log('[renderJamFretboard] Fretboard renderizado, HTML length:', jamFretboard.innerHTML.length);

                // Esperar a que el DOM se actualice antes de aplicar escala
                requestAnimationFrame(() => {
                    const track = this.currentBackingTrack;
                    console.log('[renderJamFretboard] requestAnimationFrame - track:', track);
                    if (track) {
                        console.log('[renderJamFretboard] Llamando showScale, root:', this.currentRoot, 'scale:', track.scale);
                        Fretboard.showScale(this.currentRoot, track.scale);
                    }
                });

                console.log('[renderJamFretboard] TERMINADO');
            },

            renderJamTrackGrid() {
                console.log('[renderJamTrackGrid] INICIANDO...');
                const grid = document.getElementById('jamTrackGrid');
                console.log('[renderJamTrackGrid] Grid element:', grid);

                if (!grid) {
                    console.error('[Jam Session] jamTrackGrid container not found');
                    return;
                }

                console.log('[renderJamTrackGrid] Backing tracks:', MusicTheory.backingTracks);

                grid.innerHTML = MusicTheory.backingTracks.map(track => {
                    const isActive = this.currentBackingTrack && this.currentBackingTrack.id === track.id;

                    return `
                        <button class="jam-track-item ${isActive ? 'active' : ''}" data-track="${track.id}">
                            <span class="track-name">${track.name}</span>
                            <span class="track-bpm">${track.bpm}</span>
                        </button>
                    `;
                }).join('');

                console.log('[renderJamTrackGrid] Grid HTML length:', grid.innerHTML.length);
                console.log('[renderJamTrackGrid] TERMINADO');
            },

            renderJamSessionPanel(track, rootName, bpm) {
                console.log('[renderJamSessionPanel] INICIANDO... bpm:', bpm);
                const keyDisplay = document.getElementById('jamKeyDisplay');
                const progDisplay = document.getElementById('jamProgressionDisplay');
                const bpmDisplay = document.getElementById('jamBpmDisplay');
                const bpmSlider = document.getElementById('bpmSlider');

                console.log('[renderJamSessionPanel] jamBpmDisplay:', bpmDisplay);
                console.log('[renderJamSessionPanel] bpmSlider:', bpmSlider);

                if (!keyDisplay || !progDisplay) {
                    console.error('[Jam Session] Key display or progression display not found');
                    return;
                }

                // Actualizar KEY DISPLAY
                const scaleName = this.SCALE_NAMES[track.scale] || 'Mayor';
                keyDisplay.textContent = `${rootName} ${scaleName}`.toUpperCase();

                // Actualizar BPM DISPLAY con estilos inline forzados
                if (bpmDisplay) {
                    bpmDisplay.textContent = bpm;
                    // Forzar estilos inline para asegurar visibilidad
                    bpmDisplay.style.cssText = 'color: #dc2626 !important; font-size: 14px !important; font-weight: 600 !important; display: inline-block !important; min-width: 40px !important; text-align: center !important; opacity: 1 !important; visibility: visible !important;';
                } else {
                    console.error('[renderJamSessionPanel] bpmDisplay NO ENCONTRADO!');
                }
                if (bpmSlider) {
                    console.log('[renderJamSessionPanel] Estableciendo bpmSlider.value =', bpm);
                    bpmSlider.value = bpm;
                } else {
                    console.error('[renderJamSessionPanel] bpmSlider NO ENCONTRADO!');
                }

                // Actualizar PROGRESSION DISPLAY con animación
                if (progDisplay) {
                    const chords = track.progression.map((symbol, idx) => {
                        const chordName = `${rootName}${symbol}`;
                        return `
                            <span class="prog-chord" data-chord-idx="${idx}">${chordName}</span>
                            ${idx < track.progression.length - 1 ? '<span class="prog-separator">→</span>' : ''}
                        `;
                    }).join('');
                    progDisplay.innerHTML = chords;
                }
            },

            playBackingTrack() {
                // Primero detener cualquier track que esté corriendo
                if (this.backingTrackPlaying) {
                    this.stopBackingTrack();
                }

                const track = this.currentBackingTrack;
                const bpm = this.syncMetronomeWithBacking ? this.globalBPM : (this.customBPM || track.bpm);
                this.backingTrackPlaying = true;

                // Resetear contadores
                this.jamCurrentBar = 0;
                this.jamLoopCount = 0;
                this.jamCurrentBeat = 0;

                // Mostrar panel de progreso
                const progressDisplay = document.getElementById('jamProgressDisplay');
                if (progressDisplay) {
                    progressDisplay.classList.add('active');
                }

                // Callback para actualizar progreso visual
                const progressCallback = (data) => {
                    if (data.bar !== undefined) {
                        this.jamCurrentBar = data.bar;
                        this.jamLoopCount = data.loopCount || 0;
                        this.updateJamProgress();
                    }
                    if (data.beat !== undefined) {
                        this.jamCurrentBeat = data.beat;
                        this.updateBeatIndicator(data.beat);
                    }
                };

                // Iniciar secuenciador con o sin batería
                if (this.drumsEnabled) {
                    this.backingTrackIntervals = AudioEngine.playChordSequenceWithDrums(
                        track.progression,
                        bpm,
                        this.currentRoot,
                        track.feel.toLowerCase(),
                        progressCallback
                    );
                } else {
                    this.backingTrackIntervals = {
                        chords: AudioEngine.playChordSequence(
                            track.progression,
                            bpm,
                            this.currentRoot
                        ),
                        drums: null,
                        currentBar: 0
                    };
                }

                const playBtn = document.getElementById('playTrackBtn');
                if (playBtn) playBtn.disabled = true;
                const stopBtn = document.getElementById('stopTrackBtn');
                if (stopBtn) stopBtn.disabled = false;
            },

            updateJamProgress() {
                const track = this.currentBackingTrack;
                if (!track) return;

                const rootName = MusicTheory.getNoteName(this.currentRoot);
                const currentChordSymbol = track.progression[this.jamCurrentBar];
                const chordName = `${rootName}${currentChordSymbol}`;

                // Actualizar nombre del acorde
                const chordNameEl = document.getElementById('currentChordName');
                if (chordNameEl) chordNameEl.textContent = chordName;

                // Función armónica (simple)
                const chordFunction = currentChordSymbol.includes('I') ? 'Tónica' :
                                     currentChordSymbol.includes('IV') ? 'Subdominante' :
                                     currentChordSymbol.includes('V') ? 'Dominante' : 'Acorde';
                const functionEl = document.getElementById('currentChordFunction');
                if (functionEl) functionEl.textContent = `${chordFunction}`;

                // Resaltar acorde activo en PROGRESSION BAR
                document.querySelectorAll('.prog-chord').forEach((chord, idx) => {
                    chord.classList.toggle('active', idx === this.jamCurrentBar);
                });

                // Actualizar compás
                const barDisplay = document.getElementById('currentBarDisplay');
                if (barDisplay) {
                    barDisplay.textContent = `${this.jamCurrentBar + 1}/${track.progression.length}`;
                }

                // Actualizar contador de loops
                const loopDisplay = document.getElementById('loopCountDisplay');
                if (loopDisplay) {
                    loopDisplay.textContent = this.jamLoopCount + 1;
                }

                // Barra de progreso
                const progressBar = document.getElementById('jamProgressBar');
                if (progressBar) {
                    const percentage = ((this.jamCurrentBar + 1) / track.progression.length) * 100;
                    progressBar.style.width = `${percentage}%`;
                }
            },

            updateBeatIndicator(beat) {
                document.querySelectorAll('.beat-pip').forEach((pip, idx) => {
                    pip.classList.toggle('active', idx === beat);
                });
            },

            async stopBackingTrack() {
                if (!this.backingTrackPlaying) return;

                // Fade out suave antes de detener
                if (AudioEngine.masterGain) {
                    const currentGain = AudioEngine.masterGain.gain.value;
                    const currentTime = AudioEngine.audioContext.currentTime;

                    AudioEngine.masterGain.gain.setValueAtTime(currentGain, currentTime);
                    AudioEngine.masterGain.gain.linearRampToValueAtTime(0.01, currentTime + 0.2);

                    await new Promise(resolve => setTimeout(resolve, 200));
                }

                if (this.backingTrackIntervals) {
                    if (this.backingTrackIntervals.chords) {
                        clearInterval(this.backingTrackIntervals.chords);
                    }
                    if (this.backingTrackIntervals.drums) {
                        clearInterval(this.backingTrackIntervals.drums);
                    }
                }

                this.backingTrackPlaying = false;
                this.backingTrackIntervals = null;

                // Ocultar panel de progreso
                const progressDisplay = document.getElementById('jamProgressDisplay');
                if (progressDisplay) {
                    progressDisplay.classList.remove('active');
                }

                // Restaurar volumen
                if (AudioEngine.masterGain) {
                    const currentTime = AudioEngine.audioContext.currentTime;
                    AudioEngine.masterGain.gain.setValueAtTime(0.01, currentTime);
                    AudioEngine.masterGain.gain.linearRampToValueAtTime(0.5, currentTime + 0.2);
                }

                const playBtn = document.getElementById('playTrackBtn');
                if (playBtn) playBtn.disabled = false;
                const stopBtn = document.getElementById('stopTrackBtn');
                if (stopBtn) stopBtn.disabled = true;
            },

            async changeBackingTrackBPM(newBPM) {
                if (!this.backingTrackPlaying) {
                    this.customBPM = newBPM;
                    return;
                }

                // Fade out gradual
                if (AudioEngine.masterGain) {
                    const currentGain = AudioEngine.masterGain.gain.value;
                    const currentTime = AudioEngine.audioContext.currentTime;

                    AudioEngine.masterGain.gain.setValueAtTime(currentGain, currentTime);
                    AudioEngine.masterGain.gain.linearRampToValueAtTime(0.01, currentTime + 0.2);

                    await new Promise(resolve => setTimeout(resolve, 200));
                }

                // Cambiar BPM y reiniciar
                await this.stopBackingTrack();
                this.customBPM = newBPM;
                this.playBackingTrack();

                // Fade in gradual
                if (AudioEngine.masterGain) {
                    const currentTime = AudioEngine.audioContext.currentTime;
                    AudioEngine.masterGain.gain.setValueAtTime(0.01, currentTime);
                    AudioEngine.masterGain.gain.linearRampToValueAtTime(0.5, currentTime + 0.2);
                }
            },

            // ========================================
            // CHORD LAB METHODS
            // ========================================

            showChordLabMode() {
                // Hide all modes
                document.querySelectorAll('.chord-lab-mode').forEach(mode => {
                    mode.classList.add('hidden');
                });

                // Show selected mode
                const modeId = `chord-lab-${ChordLabState.currentMode}`;
                const modeEl = document.getElementById(modeId);
                if (modeEl) {
                    modeEl.classList.remove('hidden');
                }

                // Execute mode-specific logic
                switch(ChordLabState.currentMode) {
                    case 'explorer':
                        this.renderChordLabVoicings();
                        break;
                    case 'progression-builder':
                        this.showProgressionBuilder();
                        break;
                    case 'chord-builder':
                        this.initChordBuilder();
                        break;
                    case 'practice':
                        // Practice area starts hidden
                        break;
                }
            },

            renderChordLabVoicings() {
                const grid = document.getElementById('chord-lab-voicings-grid');
                if (!grid) return;

                grid.innerHTML = '';

                // Get all voicings for current root and quality
                const voicings = this.getFilteredVoicings();

                if (voicings.length === 0) {
                    grid.innerHTML = '<div class="col-span-full text-center text-void-400 py-8">No voicings found for this combination</div>';
                    return;
                }

                voicings.forEach(voicing => {
                    const card = this.createVoicingCard(voicing);
                    grid.appendChild(card);
                });

                // Update fretboard with first voicing
                if (voicings.length > 0) {
                    this.displayChordLabVoicing(voicings[0]);
                }
            },

            getFilteredVoicings() {
                const voicings = [];
                const qualityMap = {
                    'maj': ['C_shape_major', 'A_shape_major', 'A_shape_major_high', 'G_shape_major', 'E_shape_major_barre', 'D_shape_major'],
                    'min': ['Am_shape', 'Em_shape', 'E_shape_minor_barre', 'Dm_shape'],
                    '7': ['E_shape_dom7'],
                    'maj7': ['E_shape_maj7', 'A_shape_maj7', 'D_shape_maj7'],
                    'm7': ['A_shape_m7', 'G_shape_m7'],
                    '9': ['C9', 'Cmaj9'],
                    '11': ['C11'],
                    '13': ['Cmaj13']
                };

                const keys = qualityMap[ChordLabState.currentQuality] || [];

                keys.forEach(key => {
                    const voicing = MusicTheory.chordLabVoicings[key];
                    if (!voicing) return;

                    voicings.push({ key, ...voicing });
                });

                return voicings;
            },

            createVoicingCard(voicing) {
                const card = document.createElement('div');
                card.className = 'chord-lab-voicing-card';
                card.dataset.voicingKey = voicing.key;

                // Check if selected for comparison
                if (ChordLabState.comparisonA === voicing.key) {
                    card.classList.add('compare-a');
                } else if (ChordLabState.comparisonB === voicing.key) {
                    card.classList.add('compare-b');
                }

                const chordSymbol = this.getChordSymbol(ChordLabState.currentRoot, ChordLabState.currentQuality);

                card.innerHTML = `
                    <div class="chord-lab-voicing-header">
                        <div>
                            <div class="chord-lab-voicing-title">${voicing.name}</div>
                            <div class="chord-lab-voicing-subtitle">${chordSymbol}</div>
                        </div>
                        <button class="chord-lab-play-btn" data-voicing-key="${voicing.key}">▶</button>
                    </div>
                    <div class="mt-3">
                        ${this.renderMiniChordDiagram(voicing)}
                    </div>
                    <div class="chord-lab-metadata">
                        <div class="chord-lab-metadata-row">
                            <span class="chord-lab-metadata-label">Register:</span>
                            <span class="chord-lab-metadata-value">${voicing.register}</span>
                        </div>
                        <div class="chord-lab-metadata-row">
                            <span class="chord-lab-metadata-label">Difficulty:</span>
                            <span class="chord-lab-metadata-value">${voicing.difficulty}/10</span>
                        </div>
                        <div class="chord-lab-difficulty-bar">
                            <div class="chord-lab-difficulty-fill" style="width: ${voicing.difficulty * 10}%"></div>
                        </div>
                        <div class="chord-lab-metadata-row">
                            <span class="chord-lab-metadata-label">Best for:</span>
                            <span class="chord-lab-metadata-value">${voicing.bestFor.join(', ')}</span>
                        </div>
                        <div class="chord-lab-metadata-row">
                            <span class="chord-lab-metadata-label">Use:</span>
                            <span class="chord-lab-metadata-value text-sm">${voicing.commonUse}</span>
                        </div>
                    </div>
                `;

                // Click on card to show on fretboard
                card.addEventListener('click', (e) => {
                    if (e.target.classList.contains('chord-lab-play-btn')) return;

                    // Shift+click for A/B comparison
                    if (e.shiftKey) {
                        this.toggleComparisonVoicing(voicing.key);
                    } else {
                        this.displayChordLabVoicing(voicing);
                        this.showChordStory(voicing);
                        document.querySelectorAll('.chord-lab-voicing-card').forEach(c => c.classList.remove('selected'));
                        card.classList.add('selected');
                    }
                });

                // Play button
                card.querySelector('.chord-lab-play-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.playChordLabVoicing(voicing);
                });

                return card;
            },

            renderMiniChordDiagram(voicing) {
                // Simple SVG representation
                const frets = voicing.frets;
                const baseFret = voicing.baseFret || 0;
                const svg = `
                    <svg width="120" height="90" viewBox="0 0 120 90" class="mx-auto">
                        ${[0,1,2,3,4,5].map(string => `
                            <line x1="20" y1="${15 + string * 12}" x2="100" y2="${15 + string * 12}"
                                  stroke="#475569" stroke-width="1"/>
                        `).join('')}
                        ${[0,1,2,3,4].map(fret => `
                            <line x1="${30 + fret * 16}" y1="15" x2="${30 + fret * 16}" y2="75"
                                  stroke="#475569" stroke-width="1"/>
                        `).join('')}
                        ${[0,1,2,3,4].map(fret => `
                            <text x="${30 + fret * 16}" y="10"
                                  font-size="8" fill="#94a3b8" text-anchor="middle">
                                ${baseFret + fret}
                            </text>
                        `).join('')}
                        ${frets.map((fret, idx) => {
                            if (fret === -1) return '';
                            const y = 15 + idx * 12;
                            const x = fret === 0 ? 20 : 30 + (fret - baseFret) * 16;
                            return `<circle cx="${x}" cy="${y}" r="5" fill="#84cc16"/>`;
                        }).join('')}
                    </svg>
                `;
                return svg;
            },

            getChordSymbol(root, quality) {
                const qualitySymbols = {
                    'maj': '',
                    'min': 'm',
                    '7': '7',
                    'maj7': 'maj7',
                    'm7': 'm7',
                    '9': '9',
                    '11': '11',
                    '13': '13'
                };
                return root + (qualitySymbols[quality] || '');
            },

            displayChordLabVoicing(voicing) {
                // Display on main fretboard using specificPositions
                Fretboard.clear();
                const root = ChordLabState.currentRoot;
                const rootIndex = MusicTheory.notes.indexOf(root);

                // Calculate positions from frets
                const positions = [];
                voicing.frets.forEach((fret, stringIdx) => {
                    if (fret === -1) return;
                    const openStringNotes = [4, 9, 2, 7, 11, 4]; // E A D G B E
                    const noteIndex = (openStringNotes[stringIdx] + fret) % 12;
                    positions.push({
                        string: stringIdx,
                        fret: fret,
                        isRoot: noteIndex === rootIndex
                    });
                });

                // Set tonic and show positions
                Fretboard.tonicNote = rootIndex;
                Fretboard.showPositions(positions);
            },

            playChordLabVoicing(voicing) {
                if (!voicing || !voicing.frets) {
                    console.error('Invalid voicing:', voicing);
                    App.showToast('Error: voicing inválido', 'error');
                    return;
                }
                try {
                    AudioEngine.playChordVoicing(voicing);
                } catch (e) {
                    console.error('Audio error:', e);
                    App.showToast('Error de audio', 'error');
                }
            },

            showChordStory(voicing) {
                const panel = document.getElementById('chord-story-panel');
                const content = document.getElementById('chord-story-content');

                if (!panel || !content || !voicing) {
                    if (panel) panel.classList.add('hidden');
                    return;
                }

                // Generar contenido didáctico
                const brightness = voicing.brightness > 6 ? 'Brillante y abierto' :
                                  voicing.brightness > 3 ? 'Balanceado' : 'Oscuro y denso';

                const register = voicing.register === 'low' ? 'Grave (profundo, potente)' :
                                voicing.register === 'mid' ? 'Medio (versátil)' :
                                'Agudo (brillante, cortante)';

                content.innerHTML = `
                    <div class="flex justify-between">
                        <span class="text-void-400">Carácter sonoro:</span>
                        <span class="text-chalk-200">${brightness}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-void-400">Registro:</span>
                        <span class="text-chalk-200">${register}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-void-400">Tensión:</span>
                        <span class="text-chalk-200">${voicing.tension}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-void-400">Mejor para:</span>
                        <span class="text-chalk-200">${voicing.bestFor.join(', ')}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-void-400">Géneros típicos:</span>
                        <span class="text-chalk-200">${voicing.genres.join(', ')}</span>
                    </div>
                    <div class="pt-2 border-t border-sage-700 mt-2">
                        <strong>💡 Uso común:</strong><br>
                        <span class="text-void-300 italic">"${voicing.commonUse}"</span>
                    </div>
                    ${this.generateDidacticTip(voicing)}
                `;

                panel.classList.remove('hidden');
            },

            generateDidacticTip(voicing) {
                let tip = '';

                if (voicing.movable) {
                    tip = 'Esta forma es movible - puedes trasladarla a cualquier traste para cambiar de tono.';
                } else if (voicing.register === 'low' && voicing.brightness > 7) {
                    tip = 'Sonido completo y resonante, ideal para acompañamiento base.';
                } else if (voicing.register === 'high') {
                    tip = 'Posición aguda que se "corta" en la mezcla - perfecta para solos o melodías.';
                } else if (voicing.tension === 'high') {
                    tip = 'Acorde tenso que busca resolver - úsalo para crear anticipación.';
                }

                return tip ? `
                    <div class="pt-2 border-t border-sage-700 mt-2">
                        <strong>🎯 Tip didáctico:</strong><br>
                        <span class="text-void-300">${tip}</span>
                    </div>
                ` : '';
            },

            toggleComparisonVoicing(key) {
                if (ChordLabState.comparisonA === key) {
                    ChordLabState.comparisonA = null;
                } else if (ChordLabState.comparisonB === key) {
                    ChordLabState.comparisonB = null;
                } else if (!ChordLabState.comparisonA) {
                    ChordLabState.comparisonA = key;
                } else if (!ChordLabState.comparisonB) {
                    ChordLabState.comparisonB = key;
                } else {
                    // Replace A
                    ChordLabState.comparisonA = key;
                }

                this.updateComparisonPanel();
                this.renderChordLabVoicings();
            },

            updateComparisonPanel() {
                const panel = document.getElementById('chord-lab-comparison');
                if (!panel) return;

                if (ChordLabState.comparisonA || ChordLabState.comparisonB) {
                    panel.classList.remove('hidden');

                    const divA = document.getElementById('chord-lab-compare-a');
                    const divB = document.getElementById('chord-lab-compare-b');

                    if (ChordLabState.comparisonA) {
                        const voicing = MusicTheory.chordLabVoicings[ChordLabState.comparisonA];
                        divA.innerHTML = this.renderComparisonVoicing(voicing, ChordLabState.comparisonA, 'A');
                    } else {
                        divA.innerHTML = '<div class="text-void-400 text-center py-8">Click card with Shift to select A</div>';
                    }

                    if (ChordLabState.comparisonB) {
                        const voicing = MusicTheory.chordLabVoicings[ChordLabState.comparisonB];
                        divB.innerHTML = this.renderComparisonVoicing(voicing, ChordLabState.comparisonB, 'B');
                    } else {
                        divB.innerHTML = '<div class="text-void-400 text-center py-8">Click card with Shift to select B</div>';
                    }

                    // Show didactic comparison if both are selected
                    if (ChordLabState.comparisonA && ChordLabState.comparisonB) {
                        this.showDidacticComparison();
                    }
                } else {
                    panel.classList.add('hidden');
                }
            },

            renderComparisonVoicing(voicing, key, label) {
                const color = label === 'A' ? '#3b82f6' : '#f59e0b';
                const chordSymbol = this.getChordSymbol(ChordLabState.currentRoot, ChordLabState.currentQuality);

                return `
                    <div class="text-center">
                        <div class="text-lg font-medium mb-2" style="color: ${color}">${label}: ${voicing.name}</div>
                        <div class="text-sm text-void-400 mb-3">${chordSymbol}</div>
                        ${this.renderMiniChordDiagram(voicing)}
                        <div class="mt-3 space-y-2 text-sm text-left px-4">
                            <div class="flex justify-between">
                                <span class="text-void-400">Dificultad:</span>
                                <span class="text-chalk-100">${voicing.difficulty}/10</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-void-400">Registro:</span>
                                <span class="text-chalk-100">${voicing.register}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-void-400">Brillo:</span>
                                <span class="text-chalk-100">${voicing.brightness}/10</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-void-400">Tensión:</span>
                                <span class="text-chalk-100">${voicing.tension}</span>
                            </div>
                            <div class="mt-3 pt-2 border-t border-void-600">
                                <div class="text-void-400 text-xs mb-1">Mejor para:</div>
                                <div class="text-chalk-100 text-xs">${voicing.bestFor.join(', ')}</div>
                            </div>
                            <div class="mt-2">
                                <div class="text-void-400 text-xs mb-1">Cuándo usar:</div>
                                <div class="text-chalk-100 text-xs italic">"${voicing.commonUse}"</div>
                            </div>
                        </div>
                    </div>
                `;
            },

            showDidacticComparison() {
                const panel = document.getElementById('chord-lab-comparison');
                if (!panel) return;

                const voicingA = MusicTheory.chordLabVoicings[ChordLabState.comparisonA];
                const voicingB = MusicTheory.chordLabVoicings[ChordLabState.comparisonB];

                // Check if there's a predefined comparison
                const compKey1 = `${ChordLabState.comparisonA}_vs_${ChordLabState.comparisonB}`;
                const compKey2 = `${ChordLabState.comparisonB}_vs_${ChordLabState.comparisonA}`;
                const comparison = MusicTheory.voicingComparisons[compKey1] || MusicTheory.voicingComparisons[compKey2];

                let analysisHTML = '';
                if (comparison) {
                    // Use predefined comparison
                    analysisHTML = `
                        <div class="mt-6 p-4 bg-sage-900/20 border border-sage-600 rounded-lg">
                            <h4 class="text-lg font-medium text-sage-400 mb-3">📚 Análisis Didáctico</h4>
                            <div class="space-y-3 text-sm">
                                <div>
                                    <strong class="text-chalk-100">Diferencia de sonido:</strong>
                                    <p class="text-void-300 mt-1">${comparison.soundDifference}</p>
                                </div>
                                <div>
                                    <strong class="text-chalk-100">Diferencia de registro:</strong>
                                    <p class="text-void-300 mt-1">${comparison.registerDifference}</p>
                                </div>
                                <div>
                                    <strong class="text-chalk-100">Voice Leading:</strong>
                                    <p class="text-void-300 mt-1">${comparison.voiceLeading}</p>
                                </div>
                                <div class="pt-3 border-t border-sage-700">
                                    <strong class="text-sage-400">💡 Ejercicio de práctica:</strong>
                                    <p class="text-chalk-200 mt-1 italic">${comparison.practiceExercise}</p>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    // Generate intelligent automatic comparison
                    const diffBrightness = Math.abs(voicingA.brightness - voicingB.brightness);
                    const diffDifficulty = Math.abs(voicingA.difficulty - voicingB.difficulty);

                    // Detect comparison context
                    const bothOpen = !voicingA.movable && !voicingB.movable;
                    const openVsBarre = (!voicingA.movable && voicingB.movable) || (voicingA.movable && !voicingB.movable);
                    const sameGenres = voicingA.genres.some(g => voicingB.genres.includes(g));
                    const tensionDiff = voicingA.tension !== voicingB.tension;

                    let brightnessText = '';
                    if (diffBrightness > 2) {
                        const brighter = voicingA.brightness > voicingB.brightness ? voicingA.name : voicingB.name;
                        const darker = voicingA.brightness < voicingB.brightness ? voicingA.name : voicingB.name;
                        brightnessText = `${brighter} suena más brillante y cortante - mejor para destacar en la mezcla. ${darker} es más oscura y cálida - mejor para crear profundidad.`;
                    } else {
                        brightnessText = 'Ambas tienen un brillo similar. La diferencia estará en otros aspectos como registro o tensión.';
                    }

                    let registerText = '';
                    if (voicingA.register !== voicingB.register) {
                        registerText = `${voicingA.name} (${voicingA.register}) vs ${voicingB.name} (${voicingB.register}).
                                       Diferentes registros = diferentes roles en una canción. Bajo para fundamento, alto para highlights.`;
                    } else {
                        registerText = `Ambas en registro ${voicingA.register} - buenas candidatas para alternar en una progresión sin saltos dramáticos.`;
                    }

                    let difficultyText = '';
                    if (diffDifficulty > 3) {
                        const easier = voicingA.difficulty < voicingB.difficulty ? voicingA.name : voicingB.name;
                        const harder = voicingA.difficulty > voicingB.difficulty ? voicingA.name : voicingB.name;
                        difficultyText = `${easier} es significativamente más fácil (dificultad ${Math.min(voicingA.difficulty, voicingB.difficulty)}/10).
                                         Si eres principiante, empieza con ${easier}. ${harder} requiere más práctica (dificultad ${Math.max(voicingA.difficulty, voicingB.difficulty)}/10).`;
                    } else {
                        difficultyText = `Dificultad similar (${voicingA.difficulty} vs ${voicingB.difficulty}) - puedes intercambiarlas libremente.`;
                    }

                    // Context-aware recommendations
                    let contextText = '';
                    if (openVsBarre) {
                        const open = voicingA.movable ? voicingB.name : voicingA.name;
                        const barre = voicingA.movable ? voicingA.name : voicingB.name;
                        contextText = `${open} (open) tiene más resonancia natural. ${barre} (barre) te permite cambiar de tonalidad moviéndola por el diapasón.`;
                    } else if (tensionDiff) {
                        const tense = voicingA.tension === 'high' ? voicingA.name : (voicingB.tension === 'high' ? voicingB.name : null);
                        const relaxed = voicingA.tension === 'low' ? voicingA.name : (voicingB.tension === 'low' ? voicingB.name : null);
                        if (tense && relaxed) {
                            contextText = `${tense} crea tensión (quiere resolver). ${relaxed} es estable (puede reposar).`;
                        }
                    } else if (sameGenres) {
                        const genre = voicingA.genres.find(g => voicingB.genres.includes(g));
                        contextText = `Ambas funcionan bien en ${genre}. La elección depende del mood que busques.`;
                    } else {
                        const genresA = voicingA.genres.slice(0, 2).join(', ');
                        const genresB = voicingB.genres.slice(0, 2).join(', ');
                        contextText = `${voicingA.name} es típica de ${genresA}. ${voicingB.name} de ${genresB}. Diferentes géneros, diferentes vibes.`;
                    }

                    analysisHTML = `
                        <div class="mt-6 p-4 bg-sage-900/20 border border-sage-600 rounded-lg">
                            <h4 class="text-lg font-medium text-sage-400 mb-3">📊 Comparación Automática</h4>
                            <div class="space-y-3 text-sm">
                                <div>
                                    <strong class="text-chalk-100">Brillo/Color:</strong>
                                    <p class="text-void-300 mt-1">${brightnessText}</p>
                                </div>
                                <div>
                                    <strong class="text-chalk-100">Registro:</strong>
                                    <p class="text-void-300 mt-1">${registerText}</p>
                                </div>
                                <div>
                                    <strong class="text-chalk-100">Dificultad:</strong>
                                    <p class="text-void-300 mt-1">${difficultyText}</p>
                                </div>
                                <div>
                                    <strong class="text-chalk-100">Contexto Musical:</strong>
                                    <p class="text-void-300 mt-1">${contextText}</p>
                                </div>
                                <div class="pt-3 border-t border-sage-700">
                                    <strong class="text-sage-400">💡 Recomendación:</strong>
                                    <p class="text-chalk-200 mt-1">Toca una progresión simple (I-IV-V) con cada voicing.
                                    Escucha cómo cambia el carácter de la canción. Ese es el verdadero aprendizaje.</p>
                                </div>
                            </div>
                        </div>
                    `;
                }

                // Insert analysis before the buttons
                const existingAnalysis = panel.querySelector('.didactic-comparison-analysis');
                if (existingAnalysis) {
                    existingAnalysis.remove();
                }

                const buttons = panel.querySelector('.mt-4.flex.gap-3');
                if (buttons) {
                    const analysisDiv = document.createElement('div');
                    analysisDiv.className = 'didactic-comparison-analysis';
                    analysisDiv.innerHTML = analysisHTML;
                    buttons.parentNode.insertBefore(analysisDiv, buttons);
                }
            },

            playChordLabComparison() {
                if (!ChordLabState.comparisonA || !ChordLabState.comparisonB) return;

                const voicingA = MusicTheory.chordLabVoicings[ChordLabState.comparisonA];
                const voicingB = MusicTheory.chordLabVoicings[ChordLabState.comparisonB];

                this.playChordLabVoicing(voicingA);
                setTimeout(() => {
                    this.playChordLabVoicing(voicingB);
                }, 1000);
            },

            clearChordLabComparison() {
                ChordLabState.comparisonA = null;
                ChordLabState.comparisonB = null;
                this.updateComparisonPanel();
                this.renderChordLabVoicings();
            },

            startChordLabExercise(exercise) {
                const area = document.getElementById('chord-lab-practice-area');
                if (!area) return;

                area.classList.remove('hidden');

                switch(exercise) {
                    case 'shape-shifting':
                        this.loadShapeShiftingExercise(area);
                        break;
                    case 'position-trainer':
                        this.loadPositionTrainerExercise(area);
                        break;
                    case 'progression-voicings':
                        this.loadProgressionVoicingsExercise(area);
                        break;
                }
            },

            loadShapeShiftingExercise(area) {
                // Select 3 random voicings of current chord quality
                const voicings = this.getFilteredVoicings();
                const selected = [];

                // Try to get different registers if possible
                const byRegister = {low: [], mid: [], high: []};
                voicings.forEach(v => {
                    if (byRegister[v.register]) {
                        byRegister[v.register].push(v);
                    }
                });

                // Pick one from each register if possible
                if (byRegister.low.length > 0) selected.push(byRegister.low[0]);
                if (byRegister.mid.length > 0) selected.push(byRegister.mid[0]);
                if (byRegister.high.length > 0) selected.push(byRegister.high[0]);

                // If we don't have 3, fill with random
                while (selected.length < 3 && voicings.length > selected.length) {
                    const v = voicings[Math.floor(Math.random() * voicings.length)];
                    if (!selected.includes(v)) selected.push(v);
                }

                const chord = this.getChordSymbol(ChordLabState.currentRoot, ChordLabState.currentQuality);

                area.innerHTML = `
                    <h3 class="text-lg font-medium text-sage-400 mb-3">🎯 Shape Shifting: Mismo Acorde, Diferentes Posiciones</h3>
                    <div class="p-3 bg-blue-900/20 border border-blue-700 rounded mb-4">
                        <p class="text-sm text-chalk-200">
                            <strong>Objetivo:</strong> Aprende a tocar el mismo acorde en diferentes partes del diapasón.
                            Cada posición tiene un sonido y "feeling" único. Practica transicionar entre ellas de forma fluida.
                        </p>
                    </div>
                    <div class="text-center mb-4">
                        <div class="text-3xl font-bold text-sage-400 mb-2">${chord}</div>
                        <div class="text-void-400">Toca este acorde en 3 posiciones diferentes</div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                        ${selected.map((v, idx) => `
                            <div class="p-4 bg-void-800 border border-void-600 rounded-lg hover:border-sage-500 transition-all">
                                <div class="text-center mb-3">
                                    <div class="text-lg font-medium text-chalk-100">${v.name}</div>
                                    <div class="text-xs text-void-400 mb-2">Registro ${v.register}</div>
                                </div>
                                <div class="mb-3">
                                    ${this.renderMiniChordDiagram(v)}
                                </div>
                                <div class="space-y-2 text-xs">
                                    <div class="flex justify-between">
                                        <span class="text-void-400">Sonido:</span>
                                        <span class="text-chalk-200">${v.register === 'low' ? 'Profundo' : v.register === 'mid' ? 'Balanceado' : 'Brillante'}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-void-400">Dificultad:</span>
                                        <span class="text-chalk-200">${v.difficulty}/10</span>
                                    </div>
                                    <div class="mt-2">
                                        <button onclick="App.playAndShowVoicing('${v.key}')"
                                                class="w-full px-3 py-1.5 bg-sage-600 hover:bg-sage-500 text-chalk-100 rounded text-sm">
                                            ▶ Escuchar y ver
                                        </button>
                                    </div>
                                </div>
                                <div class="mt-3 pt-3 border-t border-void-600 text-xs text-void-300 italic">
                                    "${v.commonUse}"
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="mt-6 p-4 bg-sage-900/20 border border-sage-700 rounded">
                        <h4 class="text-sm font-medium text-sage-400 mb-2">📝 Ejercicio Guiado:</h4>
                        <ol class="space-y-2 text-sm text-void-300">
                            <li>1. Escucha cada posición individualmente - nota cómo cambia el carácter</li>
                            <li>2. Toca la progresión ${chord} en posición 1 → 2 → 3 → 2 → 1</li>
                            <li>3. ¿Cuál te suena más "abierta"? ¿Cuál más "densa"?</li>
                            <li>4. Practica cambiar entre cualquier par de posiciones hasta que sea fluido</li>
                        </ol>
                    </div>
                    <div class="mt-4 flex gap-3">
                        <button onclick="App.playShapeShiftingSequence()"
                                class="flex-1 px-4 py-2 bg-sage-600 hover:bg-sage-500 text-chalk-100 rounded">
                            ▶ Tocar secuencia completa
                        </button>
                        <button onclick="App.loadShapeShiftingExercise(document.getElementById('chord-lab-practice-area'))"
                                class="px-4 py-2 bg-void-700 hover:bg-void-600 text-chalk-100 rounded">
                            🔄 Nuevo ejercicio
                        </button>
                    </div>
                `;

                // Store selected for playback
                ChordLabState.currentExerciseVoicings = selected;
            },

            loadPositionTrainerExercise(area) {
                area.innerHTML = `
                    <h3 class="text-lg font-medium text-sage-400 mb-3">🎓 Position Trainer: Sound Journeys</h3>
                    <div class="p-3 bg-blue-900/20 border border-blue-700 rounded mb-4">
                        <p class="text-sm text-chalk-200">
                            <strong>Concepto:</strong> Aprende cómo el mismo acorde "viaja" sonoramente cuando lo mueves
                            por el diapasón. Desde graves profundos hasta agudos brillantes.
                        </p>
                    </div>

                    ${Object.keys(MusicTheory.soundJourneys).map(journeyKey => {
                        const journey = MusicTheory.soundJourneys[journeyKey];
                        return `
                            <div class="mb-6 p-4 bg-void-800 border border-void-600 rounded-lg">
                                <h4 class="text-lg font-medium text-chalk-100 mb-2">${journey.title}</h4>
                                <p class="text-sm text-void-300 mb-4">${journey.explanation}</p>

                                <div class="space-y-3">
                                    ${journey.steps.map((step, idx) => `
                                        <div class="p-3 bg-void-900 rounded border-l-4"
                                             style="border-color: ${['#ef4444', '#eab308', '#84cc16'][idx]}">
                                            <div class="flex items-center justify-between mb-2">
                                                <span class="font-medium text-chalk-100">Paso ${idx + 1}</span>
                                                <button onclick="App.playJourneyStep('${journeyKey}', ${idx})"
                                                        class="px-3 py-1 bg-sage-600 hover:bg-sage-500 text-chalk-100 rounded text-sm">
                                                    ▶ Escuchar
                                                </button>
                                            </div>
                                            <div class="text-sm text-void-300">${step.description}</div>
                                            <div class="mt-2 text-xs italic text-void-400">
                                                Sensación: ${step.feeling || step.emotion}
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>

                                <div class="mt-4 p-3 bg-sage-900/20 border border-sage-700 rounded">
                                    <strong class="text-sage-400 text-sm">💡 Ejercicio:</strong>
                                    <p class="text-chalk-200 text-sm mt-1">${journey.exercise}</p>
                                    <p class="text-void-400 text-xs mt-2 italic">Ejemplo real: ${journey.realExample}</p>
                                </div>

                                <div class="mt-3 text-center">
                                    <button onclick="App.playSoundJourney('${journeyKey}')"
                                            class="px-6 py-2 bg-sage-600 hover:bg-sage-500 text-chalk-100 rounded-lg font-medium">
                                        🎵 Reproducir Journey Completo
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('')}
                `;
            },

            loadProgressionVoicingsExercise(area) {
                area.innerHTML = `
                    <h3 class="text-lg font-medium text-sage-400 mb-3">🎵 Progression Voicings: Casos Prácticos</h3>
                    <div class="p-3 bg-blue-900/20 border border-blue-700 rounded mb-4">
                        <p class="text-sm text-chalk-200">
                            <strong>¿Qué forma usar cuándo?</strong> Aprende qué voicing elegir según el contexto musical.
                            Cada escenario tiene voicings "correctas" que los profesionales usan.
                        </p>
                    </div>

                    ${Object.keys(MusicTheory.practicalScenarios).map(scenarioKey => {
                        const scenario = MusicTheory.practicalScenarios[scenarioKey];
                        return `
                            <div class="mb-6 p-4 bg-void-800 border border-void-600 rounded-lg">
                                <h4 class="text-lg font-medium text-chalk-100 mb-2">
                                    ${scenario.title}
                                </h4>
                                <div class="text-sm text-void-300 mb-4 italic">
                                    Situación: "${scenario.situation}"
                                </div>

                                <div class="space-y-3 mb-4">
                                    <div class="text-sm font-medium text-sage-400">Opciones:</div>
                                    ${scenario.options.map((option, idx) => `
                                        <div class="p-3 bg-void-900 rounded">
                                            <div class="flex items-center justify-between mb-2">
                                                <span class="font-medium text-chalk-100">Opción ${idx + 1}</span>
                                                ${option.voicing ? `
                                                    <button onclick="App.playScenarioVoicing('${option.voicing || option.progression}')"
                                                            class="px-3 py-1 bg-sage-600 hover:bg-sage-500 text-chalk-100 rounded text-sm">
                                                        ▶ Escuchar
                                                    </button>
                                                ` : ''}
                                            </div>
                                            ${option.voicing ? `
                                                <div class="text-sm text-chalk-200 mb-1">Usar: <strong>${option.voicing}</strong></div>
                                            ` : `
                                                <div class="text-sm text-chalk-200 mb-1">${option.progression}</div>
                                            `}
                                            <div class="text-sm text-void-300 mb-2">Por qué: ${option.why}</div>
                                            <div class="text-xs text-void-400 italic">Ejemplo: ${option.example}</div>
                                        </div>
                                    `).join('')}
                                </div>

                                <div class="p-3 bg-sage-900/20 border border-sage-700 rounded">
                                    <strong class="text-sage-400 text-sm">💡 Recomendación:</strong>
                                    <p class="text-chalk-200 text-sm mt-1">${scenario.recommendation}</p>
                                </div>
                            </div>
                        `;
                    }).join('')}
                `;
            },

            // Helper methods for practice exercises
            playAndShowVoicing(key) {
                const voicing = MusicTheory.chordLabVoicings[key];
                if (!voicing) return;

                this.displayChordLabVoicing(voicing);
                this.playChordLabVoicing(voicing);
                this.showToast(`Mostrando: ${voicing.name}`, 'info');
            },

            playShapeShiftingSequence() {
                const voicings = ChordLabState.currentExerciseVoicings || [];
                if (voicings.length === 0) return;

                let delay = 0;
                // Play 1 → 2 → 3 → 2 → 1
                const sequence = [0, 1, 2, 1, 0];

                sequence.forEach((idx, seqIdx) => {
                    if (voicings[idx]) {
                        setTimeout(() => {
                            this.displayChordLabVoicing(voicings[idx]);
                            this.playChordLabVoicing(voicings[idx]);
                            this.showToast(`Posición ${idx + 1}: ${voicings[idx].name}`, 'info');
                        }, delay);
                        delay += 1500;
                    }
                });
            },

            playJourneyStep(journeyKey, stepIdx) {
                const journey = MusicTheory.soundJourneys[journeyKey];
                if (!journey) return;

                const step = journey.steps[stepIdx];
                if (!step) return;

                const voicing = MusicTheory.chordLabVoicings[step.voicing];
                if (!voicing) return;

                this.displayChordLabVoicing(voicing);
                this.playChordLabVoicing(voicing);
                this.showToast(`${journey.title} - Paso ${stepIdx + 1}`, 'info');
            },

            playSoundJourney(journeyKey) {
                const journey = MusicTheory.soundJourneys[journeyKey];

                if (!journey) {
                    this.showToast('Journey no encontrado', 'error');
                    return;
                }

                let stepIdx = 0;

                const playStep = () => {
                    if (stepIdx >= journey.steps.length) {
                        this.showToast(`✅ ${journey.title} completado`, 'success');
                        return;
                    }

                    const step = journey.steps[stepIdx];
                    const voicing = MusicTheory.chordLabVoicings[step.voicing];

                    if (!voicing) {
                        console.warn(`Voicing ${step.voicing} no encontrado`);
                        stepIdx++;
                        setTimeout(playStep, 100);
                        return;
                    }

                    // Reproducir
                    this.playChordLabVoicing(voicing);
                    this.displayChordLabVoicing(voicing);

                    // Mostrar descripción como toast largo
                    this.showToast(
                        `Paso ${stepIdx + 1}/${journey.steps.length}: ${step.description}`,
                        'info',
                        3000
                    );

                    stepIdx++;
                    setTimeout(playStep, 3500);
                };

                this.showToast(`🎵 ${journey.title}`, 'info', 2000);
                setTimeout(playStep, 2000);
            },

            playScenarioVoicing(voicingKey) {
                const voicing = MusicTheory.chordLabVoicings[voicingKey];
                if (!voicing) return;

                this.displayChordLabVoicing(voicing);
                this.playChordLabVoicing(voicing);
            },

            // === PROGRESSION BUILDER METHODS ===

            showProgressionBuilder() {
                // Initial render - show/hide appropriate sections
                this.updateProgressionUI();

                // Initialize sub-mode if not set
                if (!ProgressionBuilderState.subMode) {
                    ProgressionBuilderState.subMode = 'guided';
                }

                // Show appropriate sub-mode
                this.showProgressionSubMode(ProgressionBuilderState.subMode);
            },

            showProgressionSubMode(subMode) {
                // Update sub-mode state
                ProgressionBuilderState.subMode = subMode;

                // Update tab buttons
                document.querySelectorAll('.progression-mode-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.submode === subMode);
                });

                // Show/hide content
                document.getElementById('guided-mode-content')?.classList.toggle('hidden', subMode !== 'guided');
                document.getElementById('free-mode-content')?.classList.toggle('hidden', subMode !== 'free');

                // Initialize free mode if switching to it
                if (subMode === 'free') {
                    this.renderFreeModeChordPalette();
                }
            },

            renderFreeModeChordPalette() {
                const palette = document.getElementById('free-mode-palette');
                if (!palette) return;

                const key = document.getElementById('free-mode-key')?.value || 'C';
                const keyIndex = MusicTheory.getNoteIndex(key);

                // FASE 4: Generate diatonic chords plus extensions (organizados y expandidos)
                const chords = [
                    // Basic Triads
                    { interval: 0, quality: 'maj', numeral: 'I' },
                    { interval: 2, quality: 'min', numeral: 'ii' },
                    { interval: 4, quality: 'min', numeral: 'iii' },
                    { interval: 5, quality: 'maj', numeral: 'IV' },
                    { interval: 7, quality: 'maj', numeral: 'V' },
                    { interval: 9, quality: 'min', numeral: 'vi' },
                    { interval: 11, quality: 'dim', numeral: 'vii°' },

                    // Seventh Chords
                    { interval: 0, quality: 'maj7', numeral: 'Imaj7' },
                    { interval: 2, quality: 'm7', numeral: 'iim7' },
                    { interval: 4, quality: 'm7', numeral: 'iiim7' },
                    { interval: 5, quality: 'maj7', numeral: 'IVmaj7' },
                    { interval: 7, quality: '7', numeral: 'V7' },
                    { interval: 9, quality: 'm7', numeral: 'vim7' },
                    { interval: 11, quality: 'm7b5', numeral: 'viim7b5' },

                    // EXPANDIDO: Ninths (más opciones)
                    { interval: 0, quality: 'maj9', numeral: 'Imaj9' },
                    { interval: 2, quality: 'm9', numeral: 'iim9' },
                    { interval: 4, quality: 'm9', numeral: 'iiim9' },
                    { interval: 5, quality: 'maj9', numeral: 'IVmaj9' },
                    { interval: 7, quality: '9', numeral: 'V9' },
                    { interval: 9, quality: 'm9', numeral: 'vim9' },

                    // NUEVO: Elevenths
                    { interval: 2, quality: 'm11', numeral: 'iim11' },
                    { interval: 9, quality: 'm11', numeral: 'vim11' },

                    // EXPANDIDO: Thirteenths
                    { interval: 0, quality: 'maj13', numeral: 'Imaj13' },
                    { interval: 5, quality: 'maj13', numeral: 'IVmaj13' },
                    { interval: 7, quality: '13', numeral: 'V13' },

                    // Suspended
                    { interval: 0, quality: 'sus2', numeral: 'Isus2' },
                    { interval: 0, quality: 'sus4', numeral: 'Isus4' },
                    { interval: 5, quality: 'sus2', numeral: 'IVsus2' },
                    { interval: 5, quality: 'sus4', numeral: 'IVsus4' },
                    { interval: 7, quality: 'sus4', numeral: 'Vsus4' },

                    // Added Tones
                    { interval: 0, quality: 'add9', numeral: 'Iadd9' },
                    { interval: 0, quality: '6', numeral: 'I6' },
                    { interval: 2, quality: 'add9', numeral: 'iiadd9' },
                    { interval: 9, quality: 'add9', numeral: 'viadd9' },

                    // Augmented & Diminished
                    { interval: 0, quality: 'aug', numeral: 'Iaug' },
                    { interval: 5, quality: 'aug', numeral: 'IVaug' }
                ];

                const lastChord = ProgressionBuilderState.progression.length > 0 ?
                    ProgressionBuilderState.progression[ProgressionBuilderState.progression.length - 1] : null;

                palette.innerHTML = chords.map(chordData => {
                    const root = (keyIndex + chordData.interval) % 12;
                    const rootName = MusicTheory.getNoteName(root);
                    const chordSymbol = this.getChordSymbol(rootName, chordData.quality);

                    // Get voicing to extract emotional tags
                    const voicingResult = MusicTheory.getVoicingForChord(rootName, chordData.quality);
                    const emotionalTags = MusicTheory.generateEmotionalTags(
                        chordData.numeral.replace(/[^IViv°]+/g, ''), // Extract function (I, ii, etc)
                        chordData.quality,
                        voicingResult.voicing
                    );

                    // Calculate compatibility if there's a last chord
                    let compatClass = '';
                    let compatScore = null;

                    if (lastChord) {
                        const compat = MusicTheory.calculateCompatibility(
                            lastChord.chord,
                            chordData.numeral,
                            key
                        );
                        compatClass = `compat-${compat.category}`;
                        compatScore = compat.score;
                    }

                    return `
                        <button class="free-mode-chord-btn ${compatClass}"
                                onclick="App.addChordFromFreePalette('${rootName}', '${chordData.quality}')"
                                title="${emotionalTags.slice(0, 3).join(' • ')}">
                            <div class="font-medium">${chordSymbol}</div>
                            <div class="text-xs text-void-400">${chordData.numeral}</div>
                            ${voicingResult.voicing?.extensions?.length > 0 ? `
                                <span class="extension-badge">${voicingResult.voicing.extensions.join(',')}</span>
                            ` : ''}
                            ${compatScore !== null ? `
                                <span class="compat-badge" style="background: ${MusicTheory.calculateCompatibility(lastChord.chord, chordData.numeral, key).color}">
                                    ${compatScore}
                                </span>
                            ` : ''}
                        </button>
                    `;
                }).join('');
            },

            addChordFromFreePalette(chord, quality) {
                this.addChordToProgression(chord, quality);
                // Re-render palette to update compatibility colors
                this.renderFreeModeChordPalette();
            },

            selectInitialChord(chord, quality) {
                // Clear previous progression
                ProgressionBuilderState.progression = [];

                // Get a voicing for this chord
                const voicingKey = this.getVoicingKeyForQuality(chord, quality);
                const voicing = MusicTheory.chordLabVoicings[voicingKey];

                if (!voicing) {
                    this.showToast('No hay voicing disponible para este acorde', 'error');
                    return;
                }

                // Add to progression
                ProgressionBuilderState.progression.push({
                    chord,
                    quality,
                    voicing,
                    voicingKey
                });

                // Update UI
                this.updateProgressionUI();

                // Show emotion selector
                document.getElementById('initial-chord-selector')?.classList.add('hidden');
                document.getElementById('emotion-selector')?.classList.remove('hidden');

                // Play the chord
                this.displayChordLabVoicing(voicing);
                this.playChordLabVoicing(voicing);

                this.showToast(`Acorde inicial: ${chord}${quality === 'maj' ? '' : quality}`, 'info');
            },

            selectEmotion(emotion) {
                ProgressionBuilderState.lastEmotion = emotion;

                // Get last chord in progression
                const lastItem = ProgressionBuilderState.progression[ProgressionBuilderState.progression.length - 1];
                if (!lastItem) return;

                // Get suggestions using new engine
                const key = ProgressionBuilderState.currentKey || 'C';
                const currentChord = {
                    root: lastItem.chord,
                    quality: lastItem.quality,
                    voicing: lastItem.voicing
                };

                const suggestions = MusicTheory.suggestNextChords(currentChord, key, {
                    emotion: emotion
                });

                // Take top 5 suggestions
                const topSuggestions = suggestions.slice(0, 5);

                // Render suggestions
                this.renderChordSuggestions(topSuggestions, emotion);

                // Hide emotion selector temporarily
                document.getElementById('emotion-selector')?.classList.add('hidden');
                document.getElementById('chord-suggestions')?.classList.remove('hidden');
            },

            renderChordSuggestions(suggestions, emotion) {
                const grid = document.getElementById('suggestions-grid');
                if (!grid) return;

                // FASE 4: Enhanced suggestions display with extensions and emotional tags
                grid.innerHTML = suggestions.map(sug => {
                    const chordSymbol = this.getChordSymbol(sug.chord, sug.quality);
                    const compatClass = sug.compatibility.category;
                    const compatColor = sug.compatibility.color;
                    const extensions = sug.voicing?.extensions || [];
                    const emotionalTags = sug.emotionalTags || [];

                    return `
                        <div class="suggestion-card ${compatClass}" style="border-color: ${compatColor}">
                            <div class="flex justify-between items-start mb-3">
                                <div>
                                    <div class="text-2xl font-display text-chalk-100">
                                        ${chordSymbol}
                                        ${extensions.length > 0 ? `
                                            <span class="extension-badge ml-2">${extensions.join(',')}</span>
                                        ` : ''}
                                    </div>
                                    <div class="text-xs text-sage-400">${sug.function}</div>
                                    ${emotionalTags.length > 0 ? `
                                        <div class="emotional-tags mt-1">${emotionalTags.slice(0, 3).join(' • ')}</div>
                                    ` : ''}
                                </div>
                                <div class="text-xs px-2 py-1 rounded" style="background: ${compatColor}22; color: ${compatColor}">
                                    ${sug.compatibility.score}%
                                </div>
                            </div>
                            <p class="text-xs text-void-300 mb-3">${sug.explanation}</p>
                            ${sug.voiceLeading ? `
                                <div class="p-2 bg-void-900/50 rounded text-xs mb-3">
                                    <div class="flex justify-between">
                                        <span>Voice Leading:</span>
                                        <span class="text-sage-400">${sug.voiceLeading.recommendation}</span>
                                    </div>
                                    <div class="text-void-400 text-[10px] mt-1">
                                        ${sug.voiceLeading.description}
                                    </div>
                                </div>
                            ` : ''}
                            <div class="flex gap-2">
                                <button class="ctrl-btn-small flex-1" onclick="App.playChordSuggestion('${sug.chord}', '${sug.quality}')">
                                    ▶
                                </button>
                                <button class="ctrl-btn-small flex-1" onclick="App.addChordToProgression('${sug.chord}', '${sug.quality}')">
                                    + Añadir
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            },

            playChordSuggestion(chord, quality) {
                // FIX: Use MusicTheory.getVoicingForChord() for proper extension support
                const result = MusicTheory.getVoicingForChord(chord, quality);
                if (result && result.voicing) {
                    this.displayChordLabVoicing(result.voicing);
                    this.playChordLabVoicing(result.voicing);
                }
            },

            addChordToProgression(chord, quality) {
                // FIX: Use MusicTheory.getVoicingForChord() directly for proper extension support
                const result = MusicTheory.getVoicingForChord(chord, quality);

                if (!result || !result.voicing) {
                    this.showToast('No hay voicing disponible', 'error');
                    return;
                }

                ProgressionBuilderState.progression.push({
                    chord,
                    quality,
                    voicing: result.voicing,
                    voicingKey: result.key
                });

                // Update UI
                this.updateProgressionUI();

                // Hide suggestions, show emotion selector again
                document.getElementById('chord-suggestions')?.classList.add('hidden');
                document.getElementById('emotion-selector')?.classList.remove('hidden');

                // Play the chord
                this.displayChordLabVoicing(voicing);
                this.playChordLabVoicing(voicing);

                this.showToast(`Añadido: ${chord}${quality === 'maj' ? '' : quality}`, 'success');
            },

            updateProgressionUI() {
                const chain = document.getElementById('progression-chain');
                if (!chain) return;

                const key = ProgressionBuilderState.currentKey || 'C';

                if (ProgressionBuilderState.progression.length === 0) {
                    chain.innerHTML = '<span class="text-sm text-void-400">Añade acordes para comenzar...</span>';
                    document.getElementById('play-progression')?.setAttribute('disabled', '');
                    document.getElementById('clear-progression')?.setAttribute('disabled', '');
                    document.getElementById('save-progression')?.setAttribute('disabled', '');
                    document.getElementById('transpose-progression')?.setAttribute('disabled', '');
                    document.getElementById('reverse-progression')?.setAttribute('disabled', '');
                    document.getElementById('mutate-progression')?.setAttribute('disabled', '');

                    // Clear analysis panel
                    this.updateAnalysisPanel([]);
                } else {
                    // Render chord chips with function labels
                    chain.innerHTML = ProgressionBuilderState.progression.map((item, idx) => {
                        const func = MusicTheory.getChordFunction(item.chord, key, item.quality);
                        return `
                            <div class="progression-chord-item">
                                <span class="function-label">${func}</span>
                                <span class="chord-name">${item.chord}${item.quality === 'maj' ? '' : item.quality}</span>
                                <span class="remove-btn" onclick="App.removeChordFromProgression(${idx})" title="Eliminar">×</span>
                            </div>
                        `;
                    }).join('→');

                    // Enable controls
                    document.getElementById('play-progression')?.removeAttribute('disabled');
                    document.getElementById('clear-progression')?.removeAttribute('disabled');
                    document.getElementById('save-progression')?.removeAttribute('disabled');
                    document.getElementById('transpose-progression')?.removeAttribute('disabled');
                    document.getElementById('reverse-progression')?.removeAttribute('disabled');
                    document.getElementById('mutate-progression')?.removeAttribute('disabled');

                    // Update analysis
                    this.updateAnalysisPanel(ProgressionBuilderState.progression);

                    // Update voice leading visualization if multiple chords
                    if (ProgressionBuilderState.progression.length >= 2) {
                        this.updateVoiceLeadingViz(ProgressionBuilderState.progression);
                    }
                }
            },

            updateAnalysisPanel(progression) {
                const panel = document.getElementById('analysis-content');
                if (!panel) return;

                if (progression.length === 0) {
                    panel.innerHTML = '<div class="text-void-400">Añade acordes para ver análisis...</div>';
                    document.getElementById('progression-story')?.classList.add('hidden');
                    return;
                }

                const key = ProgressionBuilderState.currentKey || 'C';

                // Calculate functions
                const functions = progression.map(item =>
                    MusicTheory.getChordFunction(item.chord, key, item.quality)
                );

                // Calculate total voice leading movement
                let totalMovement = 0;
                let smoothnessScores = [];
                for (let i = 1; i < progression.length; i++) {
                    const vl = MusicTheory.calculateVoiceLeading(
                        progression[i-1].voicing,
                        progression[i].voicing
                    );
                    if (vl) {
                        totalMovement += vl.movement;
                        smoothnessScores.push(vl.smoothness);
                    }
                }
                const avgSmoothness = smoothnessScores.length > 0 ?
                    smoothnessScores.reduce((a, b) => a + b, 0) / smoothnessScores.length : 0;

                // FASE 4: Build enhanced analysis HTML with extensions and emotional tags
                const chordsAnalysis = progression.map((item, idx) => {
                    const func = functions[idx];
                    const extensions = item.voicing?.extensions || [];
                    const emotionalTags = MusicTheory.generateEmotionalTags(func, item.quality, item.voicing);
                    const chordSymbol = this.getChordSymbol(item.chord, item.quality);

                    return `
                        <div class="chord-analysis-item">
                            <div class="chord-function">${func}</div>
                            <div class="text-chalk-200 font-medium">${chordSymbol}</div>
                            ${extensions.length > 0 ? `
                                <div class="extensions-badge">${extensions.join(', ')}</div>
                            ` : ''}
                            <div class="emotional-tags">${emotionalTags.slice(0, 3).join(' • ')}</div>
                        </div>
                    `;
                }).join('');

                panel.innerHTML = `
                    <div class="space-y-3">
                        <div>
                            <div class="text-void-400 mb-1">Funciones Armónicas</div>
                            <div class="text-chalk-200 font-medium">
                                ${functions.join(' → ')}
                            </div>
                        </div>
                        <div>
                            <div class="text-void-400 mb-1">Análisis Detallado</div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 0.5rem;">
                                ${chordsAnalysis}
                            </div>
                        </div>
                        <div>
                            <div class="text-void-400 mb-1">Tonalidad</div>
                            <div class="text-chalk-200">${key} Mayor</div>
                        </div>
                        ${smoothnessScores.length > 0 ? `
                            <div>
                                <div class="text-void-400 mb-1">Voice Leading</div>
                                <div class="flex items-center gap-2">
                                    <div class="flex-1 h-2 bg-void-900 rounded overflow-hidden">
                                        <div class="h-full bg-gradient-to-r from-sage-600 to-sage-400"
                                             style="width: ${avgSmoothness}%"></div>
                                    </div>
                                    <div class="text-xs text-chalk-200">${avgSmoothness.toFixed(0)}%</div>
                                </div>
                                <div class="text-[10px] text-void-400 mt-1">
                                    Movimiento total: ${totalMovement} semitonos
                                </div>
                            </div>
                        ` : ''}
                        <div>
                            <div class="text-void-400 mb-1">Acordes</div>
                            <div class="text-chalk-200">${progression.length} acordes</div>
                        </div>
                    </div>
                `;

                // Generate and show story
                this.updateProgressionStory(progression, functions);

                // Show voice leading panel if applicable
                if (smoothnessScores.length > 0) {
                    this.updateVoiceLeadingPanel(progression);
                }
            },

            updateProgressionStory(progression, functions) {
                const storyPanel = document.getElementById('progression-story');
                const storyContent = document.getElementById('story-content');
                if (!storyPanel || !storyContent) return;

                if (progression.length < 2) {
                    storyPanel.classList.add('hidden');
                    return;
                }

                // Generate narrative
                let narrative = 'Esta progresión ';

                // Analyze pattern
                if (functions.includes('I') && functions.includes('V')) {
                    narrative += 'establece una fuerte relación tónica-dominante, ';
                }

                if (functions.includes('ii') && functions.includes('V') && functions.includes('I')) {
                    narrative += 'utiliza la cadencia ii-V-I clásica del jazz, ';
                }

                if (functions.filter(f => f.includes('i')).length > functions.length / 2) {
                    narrative += 'tiene un carácter predominantemente menor, ';
                } else {
                    narrative += 'mantiene un carácter mayor, ';
                }

                narrative += 'creando un viaje armónico coherente.';

                storyContent.textContent = narrative;
                storyPanel.classList.remove('hidden');
            },

            updateVoiceLeadingPanel(progression) {
                const panel = document.getElementById('voice-leading-panel');
                const content = document.getElementById('voice-leading-content');
                if (!panel || !content) return;

                const movements = [];
                for (let i = 1; i < progression.length; i++) {
                    const vl = MusicTheory.calculateVoiceLeading(
                        progression[i-1].voicing,
                        progression[i].voicing
                    );
                    if (vl) {
                        const from = this.getChordSymbol(progression[i-1].chord, progression[i-1].quality);
                        const to = this.getChordSymbol(progression[i].chord, progression[i].quality);
                        movements.push({ from, to, vl });
                    }
                }

                if (movements.length === 0) {
                    panel.classList.add('hidden');
                    return;
                }

                content.innerHTML = movements.map(m => `
                    <div class="flex justify-between items-start">
                        <div class="text-chalk-200">${m.from} → ${m.to}</div>
                        <div class="text-${m.vl.recommendation === 'excellent' ? 'green' : m.vl.recommendation === 'good' ? 'amber' : 'red'}-400">
                            ${m.vl.recommendation}
                        </div>
                    </div>
                    <div class="text-void-400 text-[10px]">${m.vl.description}</div>
                `).join('<div class="border-t border-void-700 my-2"></div>');

                panel.classList.remove('hidden');
            },

            updateVoiceLeadingViz(progression) {
                // TODO: Implement SVG visualization of voice movement
                // This would draw lines showing how each note moves between chords
            },

            removeChordFromProgression(index) {
                ProgressionBuilderState.progression.splice(index, 1);
                this.updateProgressionUI();

                // If empty, reset UI
                if (ProgressionBuilderState.progression.length === 0) {
                    document.getElementById('initial-chord-selector')?.classList.remove('hidden');
                    document.getElementById('emotion-selector')?.classList.add('hidden');
                    document.getElementById('chord-suggestions')?.classList.add('hidden');
                }
            },

            clearProgression() {
                ProgressionBuilderState.progression = [];
                this.updateProgressionUI();

                // Reset UI
                document.getElementById('initial-chord-selector')?.classList.remove('hidden');
                document.getElementById('emotion-selector')?.classList.add('hidden');
                document.getElementById('chord-suggestions')?.classList.add('hidden');

                Fretboard.clear();
                this.showToast('Progresión limpiada', 'info');
            },

            playProgression() {
                if (ProgressionBuilderState.progression.length === 0) return;

                let delay = 0;
                ProgressionBuilderState.progression.forEach((item, idx) => {
                    setTimeout(() => {
                        this.displayChordLabVoicing(item.voicing);
                        this.playChordLabVoicing(item.voicing);
                        this.showToast(`${idx + 1}/${ProgressionBuilderState.progression.length}: ${item.chord}${item.quality === 'maj' ? '' : item.quality}`, 'info');
                    }, delay);
                    delay += 2000;
                });
            },

            saveProgression() {
                const progression = ProgressionBuilderState.progression;
                if (progression.length === 0) return;

                // Create progression data
                const progressionData = {
                    chords: progression.map(item => ({
                        chord: item.chord,
                        quality: item.quality
                    })),
                    key: ProgressionBuilderState.currentKey,
                    timestamp: Date.now()
                };

                // Save to localStorage
                const saved = JSON.parse(localStorage.getItem('savedProgressions') || '[]');
                saved.push(progressionData);
                localStorage.setItem('savedProgressions', JSON.stringify(saved));

                this.showToast('✅ Progresión guardada', 'success');
            },

            showLoadProgressionDialog() {
                const saved = JSON.parse(localStorage.getItem('savedProgressions') || '[]');

                if (saved.length === 0) {
                    this.showToast('No hay progresiones guardadas', 'info');
                    return;
                }

                // Create modal
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black/70 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-void-900 border border-sage-700 rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto">
                        <h2 class="text-xl font-bold text-sage-400 mb-4">📂 Progresiones Guardadas</h2>
                        <div class="space-y-2 mb-4">
                            ${saved.map((prog, idx) => {
                                const date = new Date(prog.timestamp).toLocaleString('es-ES', {
                                    dateStyle: 'short',
                                    timeStyle: 'short'
                                });
                                const chordString = prog.chords.map(c =>
                                    `${c.chord}${c.quality === 'maj' ? '' : c.quality}`
                                ).join(' → ');
                                return `
                                    <div class="bg-void-800 border border-void-700 rounded p-3 hover:border-sage-600 transition-colors">
                                        <div class="flex justify-between items-start gap-3">
                                            <div class="flex-1">
                                                <div class="text-sage-400 font-medium mb-1">
                                                    ${prog.key ? `Tonalidad: ${prog.key}` : 'Sin tonalidad'}
                                                </div>
                                                <div class="text-chalk-200 text-sm mb-2">
                                                    ${chordString}
                                                </div>
                                                <div class="text-void-400 text-xs">
                                                    ${date}
                                                </div>
                                            </div>
                                            <div class="flex gap-2">
                                                <button
                                                    class="px-3 py-1 bg-sage-600 hover:bg-sage-500 text-chalk-100 rounded text-sm"
                                                    onclick="App.loadSavedProgression(${idx}); this.closest('.fixed').remove();"
                                                >
                                                    Cargar
                                                </button>
                                                <button
                                                    class="px-3 py-1 bg-red-600 hover:bg-red-500 text-chalk-100 rounded text-sm"
                                                    onclick="App.deleteSavedProgression(${idx}); this.closest('.fixed').remove(); App.showLoadProgressionDialog();"
                                                >
                                                    Eliminar
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        <button
                            class="w-full px-4 py-2 bg-void-700 hover:bg-void-600 text-chalk-100 rounded"
                            onclick="this.closest('.fixed').remove()"
                        >
                            Cerrar
                        </button>
                    </div>
                `;

                document.body.appendChild(modal);
            },

            loadSavedProgression(index) {
                const saved = JSON.parse(localStorage.getItem('savedProgressions') || '[]');
                const progressionData = saved[index];

                if (!progressionData) {
                    this.showToast('Error al cargar la progresión', 'error');
                    return;
                }

                // Clear current progression
                ProgressionBuilderState.progression = [];

                // Set key
                ProgressionBuilderState.currentKey = progressionData.key || 'C';

                // Load chords
                progressionData.chords.forEach(chordData => {
                    const voicingResult = MusicTheory.getVoicingForChord(chordData.chord, chordData.quality);
                    ProgressionBuilderState.progression.push({
                        chord: chordData.chord,
                        quality: chordData.quality,
                        voicing: voicingResult.voicing,
                        voicingKey: voicingResult.key
                    });
                });

                // Update UI
                this.updateProgressionUI();
                this.showToast('✅ Progresión cargada', 'success');
            },

            deleteSavedProgression(index) {
                const saved = JSON.parse(localStorage.getItem('savedProgressions') || '[]');
                saved.splice(index, 1);
                localStorage.setItem('savedProgressions', JSON.stringify(saved));
                this.showToast('🗑️ Progresión eliminada', 'info');
            },

            transposeProgressionDialog() {
                // Simple prompt for now (could be a modal in future)
                const currentKey = ProgressionBuilderState.currentKey || 'C';
                const newKey = prompt(`Transponer de ${currentKey} a qué tonalidad? (C, D, E, F, G, A, B)`, currentKey);

                if (newKey && newKey !== currentKey) {
                    this.transposeProgressionTo(newKey);
                }
            },

            transposeProgressionTo(newKey) {
                const currentKey = ProgressionBuilderState.currentKey || 'C';
                const progression = ProgressionBuilderState.progression;

                if (progression.length === 0) return;

                // Transpose each chord
                const transposed = MusicTheory.transposeProgression(progression, currentKey, newKey);

                // Update progression with new voicings
                ProgressionBuilderState.progression = transposed.map(item => {
                    const voicingResult = MusicTheory.getVoicingForChord(item.root, item.quality);
                    return {
                        chord: item.root,
                        quality: item.quality,
                        voicing: voicingResult.voicing,
                        voicingKey: voicingResult.key
                    };
                });

                // Update key
                ProgressionBuilderState.currentKey = newKey;

                // Update UI
                this.updateProgressionUI();
                this.showToast(`🔄 Transpuesto a ${newKey}`, 'success');
            },

            reverseProgression() {
                if (ProgressionBuilderState.progression.length === 0) return;

                ProgressionBuilderState.progression.reverse();
                this.updateProgressionUI();
                this.showToast('↩️ Progresión invertida', 'info');
            },

            mutateProgression() {
                const progression = ProgressionBuilderState.progression;
                if (progression.length < 2) {
                    this.showToast('Necesitas al menos 2 acordes para mutar', 'info');
                    return;
                }

                // Random mutation strategies
                const strategies = [
                    'replace_one',   // Replace one random chord
                    'swap_two',      // Swap two random chords
                    'insert_passing' // Insert passing chord
                ];

                const strategy = strategies[Math.floor(Math.random() * strategies.length)];
                const key = ProgressionBuilderState.currentKey || 'C';

                switch (strategy) {
                    case 'replace_one': {
                        const idx = Math.floor(Math.random() * progression.length);
                        const currentChord = progression[idx];

                        // Get suggestions for neighbor
                        const prevChord = idx > 0 ? progression[idx - 1] : null;
                        if (prevChord) {
                            const suggestions = MusicTheory.suggestNextChords(prevChord.chord, key, {});
                            if (suggestions.length > 0) {
                                const newSugg = suggestions[Math.floor(Math.random() * suggestions.length)];
                                const voicingResult = MusicTheory.getVoicingForChord(newSugg.chord, newSugg.quality);
                                progression[idx] = {
                                    chord: newSugg.chord,
                                    quality: newSugg.quality,
                                    voicing: voicingResult.voicing,
                                    voicingKey: voicingResult.key
                                };
                                this.showToast(`🎲 Reemplazado acorde ${idx + 1}`, 'info');
                            }
                        }
                        break;
                    }

                    case 'swap_two': {
                        if (progression.length >= 2) {
                            const idx1 = Math.floor(Math.random() * progression.length);
                            let idx2 = Math.floor(Math.random() * progression.length);
                            while (idx2 === idx1) {
                                idx2 = Math.floor(Math.random() * progression.length);
                            }
                            [progression[idx1], progression[idx2]] = [progression[idx2], progression[idx1]];
                            this.showToast(`🎲 Intercambiados acordes ${idx1 + 1} y ${idx2 + 1}`, 'info');
                        }
                        break;
                    }

                    case 'insert_passing': {
                        if (progression.length >= 2) {
                            const idx = Math.floor(Math.random() * (progression.length - 1));
                            // Simple passing chord logic: chromatic approach
                            const fromChord = progression[idx].chord;
                            const toChord = progression[idx + 1].chord;

                            // TODO: More sophisticated passing chord logic
                            this.showToast('🎲 Mutación experimental', 'info');
                        }
                        break;
                    }
                }

                this.updateProgressionUI();
            },

            // ========================================
            // CHORD BUILDER METHODS
            // ========================================

            initChordBuilder() {
                // Clear state
                ChordBuilderState.selectedNotes = [];
                ChordBuilderState.currentChord = null;

                // Render interactive fretboard
                this.renderChordBuilderFretboard();

                // Load saved voicings from localStorage
                this.loadSavedVoicings();

                // Update display
                this.updateChordBuilderDisplay();
            },

            renderChordBuilderFretboard() {
                const container = document.getElementById('chord-builder-fretboard');
                if (!container) return;

                const openStringNotes = [4, 9, 2, 7, 11, 4]; // E A D G B E
                const stringNames = ['E', 'A', 'D', 'G', 'B', 'e'];

                let html = '<div class="space-y-1">';

                // Render each string
                for (let string = 0; string < 6; string++) {
                    html += `<div class="flex items-center gap-1">`;
                    html += `<div class="w-6 text-xs text-void-400">${stringNames[string]}</div>`;

                    // Frets 0-12
                    for (let fret = 0; fret <= 12; fret++) {
                        const noteIndex = (openStringNotes[string] + fret) % 12;
                        const noteName = MusicTheory.getNoteName(noteIndex);
                        const isSelected = ChordBuilderState.selectedNotes.some(n => n.string === string && n.fret === fret);

                        html += `
                            <button class="chord-builder-fret ${isSelected ? 'selected' : ''}"
                                    data-string="${string}" data-fret="${fret}" data-note="${noteName}"
                                    style="width: 32px; height: 32px;">
                                ${fret === 0 ? 'O' : fret}
                            </button>
                        `;
                    }

                    html += `</div>`;
                }

                html += '</div>';
                container.innerHTML = html;

                // Add event listeners
                container.querySelectorAll('.chord-builder-fret').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const string = parseInt(e.currentTarget.dataset.string);
                        const fret = parseInt(e.currentTarget.dataset.fret);
                        const note = e.currentTarget.dataset.note;
                        this.toggleChordBuilderNote(string, fret, note);
                    });
                });
            },

            toggleChordBuilderNote(string, fret, note) {
                const existingIdx = ChordBuilderState.selectedNotes.findIndex(n => n.string === string);

                if (existingIdx >= 0) {
                    // If same fret, remove; otherwise replace
                    if (ChordBuilderState.selectedNotes[existingIdx].fret === fret) {
                        ChordBuilderState.selectedNotes.splice(existingIdx, 1);
                    } else {
                        ChordBuilderState.selectedNotes[existingIdx] = { string, fret, note };
                    }
                } else {
                    // Add new note
                    ChordBuilderState.selectedNotes.push({ string, fret, note });
                }

                // Re-render fretboard
                this.renderChordBuilderFretboard();

                // Identify chord
                this.identifyChordBuilderChord();

                // Update display
                this.updateChordBuilderDisplay();
            },

            identifyChordBuilderChord() {
                const notes = ChordBuilderState.selectedNotes;

                if (notes.length < 2) {
                    ChordBuilderState.currentChord = null;
                    return;
                }

                // Get unique note indices
                const openStringNotes = [4, 9, 2, 7, 11, 4];
                const noteIndices = notes.map(n => (openStringNotes[n.string] + n.fret) % 12);
                const uniqueIndices = [...new Set(noteIndices)].sort((a, b) => a - b);

                // Try to identify chord
                const identified = MusicTheory.identifyChordFromNotes(uniqueIndices);

                ChordBuilderState.currentChord = identified;

                // Generate suggestions
                this.generateChordBuilderSuggestions(notes, identified);
            },

            updateChordBuilderDisplay() {
                const notes = ChordBuilderState.selectedNotes;
                const chord = ChordBuilderState.currentChord;

                // Update name
                const nameEl = document.getElementById('chord-builder-name');
                if (nameEl) {
                    if (chord && chord.root) {
                        nameEl.textContent = `${chord.root}${chord.quality}`;
                    } else if (notes.length >= 2) {
                        nameEl.textContent = '???';
                    } else {
                        nameEl.textContent = '---';
                    }
                }

                // Update notes
                const notesEl = document.getElementById('chord-builder-notes');
                if (notesEl) {
                    if (notes.length > 0) {
                        const noteNames = notes.map(n => n.note).join(', ');
                        notesEl.textContent = noteNames;
                    } else {
                        notesEl.textContent = 'Selecciona notas...';
                    }
                }

                // Update intervals
                const intervalsEl = document.getElementById('chord-builder-intervals');
                if (intervalsEl) {
                    if (chord && chord.intervals) {
                        intervalsEl.textContent = chord.intervals.join(', ');
                    } else {
                        intervalsEl.textContent = '---';
                    }
                }

                // Show/hide analysis
                const analysisPanel = document.getElementById('chord-builder-analysis');
                if (analysisPanel && chord) {
                    this.updateChordBuilderAnalysis(notes, chord);
                    analysisPanel.classList.remove('hidden');
                } else if (analysisPanel) {
                    analysisPanel.classList.add('hidden');
                }
            },

            updateChordBuilderAnalysis(notes, chord) {
                const content = document.getElementById('chord-builder-analysis-content');
                if (!content) return;

                // Calculate voicing properties
                const frets = notes.map(n => n.fret);
                const minFret = Math.min(...frets.filter(f => f > 0));
                const maxFret = Math.max(...frets);
                const span = maxFret - minFret;

                // Estimate difficulty
                let difficulty = 1;
                if (span > 4) difficulty += 3;
                else if (span > 3) difficulty += 2;
                else if (span > 2) difficulty += 1;

                if (notes.length >= 5) difficulty += 1;
                if (notes.length === 6) difficulty += 1;

                // Estimate register
                const avgFret = frets.reduce((a, b) => a + b, 0) / frets.length;
                let register = 'low';
                if (avgFret > 7) register = 'high';
                else if (avgFret > 4) register = 'mid';

                content.innerHTML = `
                    <div class="flex justify-between">
                        <span class="text-void-400">Dificultad:</span>
                        <span class="text-chalk-200">${difficulty}/10</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-void-400">Registro:</span>
                        <span class="text-chalk-200">${register}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-void-400">Span:</span>
                        <span class="text-chalk-200">${span} trastes</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-void-400">Cuerdas:</span>
                        <span class="text-chalk-200">${notes.length}</span>
                    </div>
                `;
            },

            generateChordBuilderSuggestions(notes, chord) {
                const panel = document.getElementById('chord-builder-suggestions');
                const content = document.getElementById('chord-builder-suggestions-content');

                if (!panel || !content) return;

                if (!chord || notes.length < 2) {
                    panel.classList.add('hidden');
                    return;
                }

                const suggestions = [];

                // Suggest adding extensions
                if (chord.quality === 'maj' && !chord.intervals.includes('7')) {
                    suggestions.push({
                        action: 'add',
                        note: '7ma',
                        result: 'maj7',
                        message: 'Añade la 7ma mayor para crear maj7'
                    });
                }

                if (chord.quality === 'maj' && !chord.intervals.includes('9')) {
                    suggestions.push({
                        action: 'add',
                        note: '9na',
                        result: 'add9',
                        message: 'Añade la 9na para más color'
                    });
                }

                // Suggest simplifications if too many notes
                if (notes.length > 4) {
                    suggestions.push({
                        action: 'simplify',
                        message: 'Considera usar menos cuerdas para facilitar'
                    });
                }

                if (suggestions.length > 0) {
                    content.innerHTML = suggestions.map(s => `
                        <div class="p-2 bg-void-900 rounded">
                            <div class="text-chalk-200">${s.message}</div>
                            ${s.result ? `<div class="text-sage-400 text-[10px] mt-1">→ ${s.result}</div>` : ''}
                        </div>
                    `).join('');
                    panel.classList.remove('hidden');
                } else {
                    panel.classList.add('hidden');
                }
            },

            playChordBuilder() {
                const notes = ChordBuilderState.selectedNotes;
                if (notes.length === 0) return;

                // Convert to voicing format
                const frets = new Array(6).fill(-1);
                notes.forEach(n => {
                    frets[n.string] = n.fret;
                });

                const voicing = {
                    frets: frets,
                    name: 'Custom',
                    register: 'mid',
                    difficulty: 5
                };

                this.playChordLabVoicing(voicing);
            },

            clearChordBuilder() {
                ChordBuilderState.selectedNotes = [];
                ChordBuilderState.currentChord = null;
                this.renderChordBuilderFretboard();
                this.updateChordBuilderDisplay();
                document.getElementById('chord-builder-suggestions')?.classList.add('hidden');
            },

            saveChordBuilderVoicing() {
                const notes = ChordBuilderState.selectedNotes;
                const chord = ChordBuilderState.currentChord;

                if (notes.length < 2) {
                    this.showToast('Necesitas al menos 2 notas', 'info');
                    return;
                }

                const name = prompt('Nombre para este voicing:', chord ? `${chord.root}${chord.quality} custom` : 'Custom');
                if (!name) return;

                // Convert to voicing format
                const frets = new Array(6).fill(-1);
                notes.forEach(n => {
                    frets[n.string] = n.fret;
                });

                const voicing = {
                    name: name,
                    frets: frets,
                    chord: chord ? `${chord.root}${chord.quality}` : 'Unknown',
                    timestamp: Date.now()
                };

                ChordBuilderState.savedVoicings.push(voicing);

                // Save to localStorage
                localStorage.setItem('customVoicings', JSON.stringify(ChordBuilderState.savedVoicings));

                // Update library display
                this.updateChordBuilderLibrary();

                this.showToast('✅ Voicing guardado', 'success');
            },

            loadSavedVoicings() {
                const saved = localStorage.getItem('customVoicings');
                if (saved) {
                    try {
                        ChordBuilderState.savedVoicings = JSON.parse(saved);
                        this.updateChordBuilderLibrary();
                    } catch (e) {
                        console.error('Error loading saved voicings:', e);
                    }
                }
            },

            updateChordBuilderLibrary() {
                const library = document.getElementById('chord-builder-library');
                if (!library) return;

                const voicings = ChordBuilderState.savedVoicings;

                if (voicings.length === 0) {
                    library.innerHTML = `
                        <div class="text-xs text-void-400 text-center py-4">
                            Guarda voicings para crear tu biblioteca
                        </div>
                    `;
                    return;
                }

                library.innerHTML = voicings.map((v, idx) => `
                    <div class="flex items-center justify-between p-2 bg-void-900 rounded text-xs">
                        <div>
                            <div class="text-chalk-200 font-medium">${v.name}</div>
                            <div class="text-void-400 text-[10px]">${v.chord}</div>
                        </div>
                        <div class="flex gap-1">
                            <button onclick="App.loadCustomVoicing(${idx})" class="px-2 py-1 bg-sage-600 hover:bg-sage-500 rounded">
                                Load
                            </button>
                            <button onclick="App.deleteCustomVoicing(${idx})" class="px-2 py-1 bg-red-600 hover:bg-red-500 rounded">
                                ×
                            </button>
                        </div>
                    </div>
                `).join('');
            },

            loadCustomVoicing(index) {
                const voicing = ChordBuilderState.savedVoicings[index];
                if (!voicing) return;

                // Clear current
                ChordBuilderState.selectedNotes = [];

                // Load frets
                const openStringNotes = [4, 9, 2, 7, 11, 4];
                voicing.frets.forEach((fret, string) => {
                    if (fret >= 0) {
                        const noteIndex = (openStringNotes[string] + fret) % 12;
                        const noteName = MusicTheory.getNoteName(noteIndex);
                        ChordBuilderState.selectedNotes.push({ string, fret, note: noteName });
                    }
                });

                // Update display
                this.renderChordBuilderFretboard();
                this.identifyChordBuilderChord();
                this.updateChordBuilderDisplay();

                this.showToast(`Cargado: ${voicing.name}`, 'info');
            },

            deleteCustomVoicing(index) {
                if (!confirm('¿Eliminar este voicing?')) return;

                ChordBuilderState.savedVoicings.splice(index, 1);
                localStorage.setItem('customVoicings', JSON.stringify(ChordBuilderState.savedVoicings));
                this.updateChordBuilderLibrary();

                this.showToast('Voicing eliminado', 'info');
            },

            loadFamousVoicing(voicingKey) {
                const voicing = MusicTheory.chordLabVoicings[voicingKey];
                if (!voicing) return;

                // Clear current
                ChordBuilderState.selectedNotes = [];

                // Load frets
                const openStringNotes = [4, 9, 2, 7, 11, 4];
                voicing.frets.forEach((fret, string) => {
                    if (fret >= 0) {
                        const noteIndex = (openStringNotes[string] + fret) % 12;
                        const noteName = MusicTheory.getNoteName(noteIndex);
                        ChordBuilderState.selectedNotes.push({ string, fret, note: noteName });
                    }
                });

                // Update display
                this.renderChordBuilderFretboard();
                this.identifyChordBuilderChord();
                this.updateChordBuilderDisplay();

                this.showToast(`Cargado: ${voicing.name}`, 'info');
            },

            getVoicingKeyForQuality(chord, quality) {
                // FIX: Use MusicTheory.getVoicingForChord() which has proper extension support
                // This ensures D and Dm use different voicings, and 9/13 extensions work
                const result = MusicTheory.getVoicingForChord(chord, quality);

                if (result && result.key) {
                    return result.key;
                }

                // Fallback to old behavior only if MusicTheory fails
                console.warn(`Could not find voicing for ${chord}${quality}, using fallback`);

                const qualityMap = {
                    'maj': ['C_shape_major', 'A_shape_major', 'G_shape_major'],
                    'min': ['Am_shape', 'Em_shape', 'Dm_shape'],
                    'm': ['Am_shape', 'Em_shape', 'Dm_shape'],
                    '7': ['G_shape_dom7', 'C_shape_dom7', 'A_shape_dom7'],
                    'maj7': ['C_shape_maj7', 'A_shape_maj7'],
                    'm7': ['A_shape_m7', 'C_shape_m7'],
                    '9': ['G_shape_dom9', 'E_shape_dom9', 'A_shape_dom9'],
                    'maj9': ['C_shape_maj9', 'E_shape_maj9', 'A_shape_maj9'],
                    'm9': ['E_shape_m9', 'A_shape_m9'],
                    '13': ['G_shape_dom13', 'E_shape_dom13'],
                    'maj13': ['C_shape_maj13', 'E_shape_maj13'],
                    'm11': ['E_shape_m11', 'A_shape_m11']
                };

                const fallbacks = qualityMap[quality] || qualityMap['maj'];
                return fallbacks[0];
            }
        };

        // Initialize app when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            AudioEngine.init();
            App.init();
        });
    </script>
</body>
</html>
