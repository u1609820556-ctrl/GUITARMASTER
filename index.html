<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guitar Theory Master</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Archivo+Black&family=IBM+Plex+Mono:wght@400;500;600;700&family=Barlow+Condensed:wght@400;500;600;700;800&family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        void: {
                            950: '#0a0a0a',
                            900: '#121212',
                            800: '#1a1a1a',
                            700: '#252525',
                            600: '#333333',
                            500: '#4a4a4a',
                            400: '#666666',
                            300: '#888888',
                        },
                        blood: {
                            400: '#dc2626',
                            500: '#b91c1c',
                            600: '#991b1b',
                        },
                        brass: {
                            400: '#d4a574',
                            500: '#c4956a',
                            600: '#a67c52',
                        },
                        chalk: {
                            100: '#fafafa',
                            200: '#e5e5e5',
                            300: '#cccccc',
                        },
                        sage: {
                            900: '#1a2018',
                            800: '#243020',
                            700: '#2e3d28',
                            600: '#3d5233',
                            500: '#4a6340',
                            400: '#6b8f5e',
                            300: '#8fb080',
                            200: '#b5cfaa',
                        }
                    },
                    fontFamily: {
                        'display': ['Bebas Neue', 'sans-serif'],
                        'heading': ['Archivo Black', 'sans-serif'],
                        'body': ['Barlow Condensed', 'sans-serif'],
                        'mono': ['IBM Plex Mono', 'monospace'],
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="css/main.css">
</head>
<body>
    <!-- Screen reader announcements -->
    <div id="sr-announcements" aria-live="polite" aria-atomic="true" class="sr-only" style="position: absolute; left: -10000px; width: 1px; height: 1px; overflow: hidden;"></div>

    <div class="min-h-screen flex">
        <!-- Sidebar -->
        <aside class="w-80 bg-void-900 border-r-2 border-void-700 flex flex-col">
            <!-- Logo -->
            <div class="p-6 border-b-2 border-void-700 header-glow relative">
                <div class="absolute top-0 left-0 w-full h-1 bg-blood-400"></div>
                <h1 class="font-display text-4xl text-chalk-100 tracking-widest">GUITAR</h1>
                <p class="font-heading text-2xl text-blood-400 -mt-1 tracking-wide">THEORY MASTER</p>
                <p class="text-xs text-void-400 mt-3 font-mono tracking-wider">V2.0 — TEORÍA MUSICAL</p>
            </div>

            <!-- Levels Navigation - Industrial -->
            <nav class="flex-1 overflow-y-auto p-4 space-y-1" id="levelsNav">
                <button class="level-nav-btn active" data-level="1" aria-label="Nivel 1: Intervalos - Distancias entre notas" aria-current="page">
                    <div class="level-badge bg-blood-400 text-chalk-100">01</div>
                    <div class="level-nav-text">
                        <span class="level-nav-title">Intervalos</span>
                        <span class="level-nav-sub">Distancias entre notas</span>
                    </div>
                </button>

                <button class="level-nav-btn" data-level="2" aria-label="Nivel 2: Escalas, Modos y Pentatónicas - Todas las escalas">
                    <div class="level-badge bg-chalk-100 text-void-950">02</div>
                    <div class="level-nav-text">
                        <span class="level-nav-title">Escalas, Modos y Pentatónicas</span>
                        <span class="level-nav-sub">Todas las escalas</span>
                    </div>
                </button>

                <button class="level-nav-btn" data-level="3" aria-label="Nivel 3: Acordes Básicos - Triadas y función armónica">
                    <div class="level-badge bg-brass-400 text-void-950">03</div>
                    <div class="level-nav-text">
                        <span class="level-nav-title">Acordes Básicos</span>
                        <span class="level-nav-sub">Triadas y función armónica</span>
                    </div>
                </button>

                <button class="level-nav-btn" data-level="4" aria-label="Nivel 4: Acordes Extendidos - Extensiones y explorador">
                    <div class="level-badge bg-blood-400 text-chalk-100">04</div>
                    <div class="level-nav-text">
                        <span class="level-nav-title">Acordes Extendidos</span>
                        <span class="level-nav-sub">Extensiones y explorador</span>
                    </div>
                </button>

                <button class="level-nav-btn" data-level="5" aria-label="Nivel 5: Círculo de Quintas - Mapa de tonalidades">
                    <div class="level-badge bg-chalk-100 text-void-950">05</div>
                    <div class="level-nav-text">
                        <span class="level-nav-title">Círculo de Quintas</span>
                        <span class="level-nav-sub">Mapa de tonalidades</span>
                    </div>
                </button>

                <button class="level-nav-btn" data-level="6" aria-label="Nivel 6: Progresiones Armónicas - Aprende y analiza">
                    <div class="level-badge bg-brass-400 text-void-950">06</div>
                    <div class="level-nav-text">
                        <span class="level-nav-title">Progresiones</span>
                        <span class="level-nav-sub">Aprende y analiza</span>
                    </div>
                </button>

                <button class="level-nav-btn" data-level="7" aria-label="Nivel 7: Sistema CAGED - Domina el mástil">
                    <div class="level-badge bg-blood-400 text-chalk-100">07</div>
                    <div class="level-nav-text">
                        <span class="level-nav-title">Sistema CAGED</span>
                        <span class="level-nav-sub">Domina el mástil</span>
                    </div>
                </button>

                <button class="level-nav-btn" data-level="8" aria-label="Nivel 8: Funciones Armónicas - De tónica a dominante secundario">
                    <div class="level-badge bg-chalk-100 text-void-950">08</div>
                    <div class="level-nav-text">
                        <span class="level-nav-title">Funciones Armónicas</span>
                        <span class="level-nav-sub">Tensión y resolución</span>
                    </div>
                </button>

                <button class="level-nav-btn" data-level="9" aria-label="Nivel 9: Entrenamiento - Quiz Visual y Ear Training">
                    <div class="level-badge bg-brass-400 text-void-950">09</div>
                    <div class="level-nav-text">
                        <span class="level-nav-title">Entrenamiento</span>
                        <span class="level-nav-sub">Quiz y Ear Training</span>
                    </div>
                </button>

                <button class="level-nav-btn" data-level="10" aria-label="Nivel 10: Biblioteca Práctica - Toca y practica">
                    <div class="level-badge bg-blood-400 text-chalk-100">10</div>
                    <div class="level-nav-text">
                        <span class="level-nav-title">Biblioteca</span>
                        <span class="level-nav-sub">Toca y practica</span>
                    </div>
                </button>

                <button class="level-nav-btn" data-level="11" aria-label="Lab: Chord Lab - Crea tus progresiones">
                    <div class="level-badge bg-sage-500 text-chalk-100">Lab</div>
                    <div class="level-nav-text">
                        <span class="level-nav-title">Chord Lab</span>
                        <span class="level-nav-sub">Crea tus progresiones</span>
                    </div>
                </button>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col bg-void-950">
            <!-- Top Bar with Root Select - Industrial -->
            <header class="h-16 bg-void-900 border-b-2 border-void-700 flex items-center justify-between px-6">
                <div class="flex items-center gap-6">
                    <div>
                        <label class="text-xs text-void-400 block mb-1 font-mono tracking-wider uppercase">Nota Raíz</label>
                        <select class="custom-select !py-2 !text-sm" id="rootSelect">
                            <option value="0">C (Do)</option>
                            <option value="1">C# / Db</option>
                            <option value="2">D (Re)</option>
                            <option value="3">D# / Eb</option>
                            <option value="4">E (Mi)</option>
                            <option value="5">F (Fa)</option>
                            <option value="6">F# / Gb</option>
                            <option value="7">G (Sol)</option>
                            <option value="8">G# / Ab</option>
                            <option value="9">A (La)</option>
                            <option value="10">A# / Bb</option>
                            <option value="11">B (Si)</option>
                        </select>
                    </div>

                    <div>
                        <label class="text-xs text-void-400 block mb-1 font-mono tracking-wider uppercase">Afinación</label>
                        <select class="custom-select !py-2 !text-sm" id="tuningSelect">
                            <option value="standard">Standard (E)</option>
                            <option value="dropD">Drop D</option>
                            <option value="dropC">Drop C</option>
                            <option value="dropB">Drop B</option>
                            <option value="dropA">Drop A</option>
                            <option value="dadgad">DADGAD</option>
                            <option value="openG">Open G</option>
                            <option value="openD">Open D</option>
                            <option value="halfStep">Half Step Down</option>
                            <option value="wholeStep">Whole Step Down</option>
                        </select>
                    </div>
                </div>
                <div class="flex items-center gap-8">
                    <div class="flex items-center gap-3">
                        <span class="text-sm text-void-300 font-body uppercase tracking-wide">Notas</span>
                        <div class="toggle-switch active" id="showNotesToggle" role="switch" aria-checked="true" aria-label="Mostrar nombres de notas" tabindex="0"></div>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="text-sm text-void-300 font-body uppercase tracking-wide">Grados</span>
                        <div class="toggle-switch" id="showFunctionsToggle" role="switch" aria-checked="false" aria-label="Mostrar grados de la escala" tabindex="0"></div>
                    </div>
                    <div class="flex items-center gap-3">
                        <button class="btn-secondary !py-2 !px-4 !text-xs" id="metronomeBtn" aria-label="Activar metrónomo">
                            <span id="metronomeIcon">♪</span>
                            <span id="bpmDisplay">120</span>
                            <span id="metronomeBeatIndicator" class="ml-2 text-xs font-mono" style="min-width: 30px;">1/4</span>
                        </button>
                        <button class="btn-secondary !py-1 !px-3 !text-xs" id="tapTempoBtn" aria-label="Tap Tempo" title="Click varias veces para detectar BPM">
                            TAP
                        </button>
                        <button class="btn-secondary !py-1 !px-3 !text-xs" id="metronomeSettingsBtn" aria-label="Configuración del metrónomo" title="Compás, subdivisiones, etc.">
                            ⚙
                        </button>
                    </div>
                </div>
            </header>

            <!-- Control Panel Area (changes based on level) - Industrial -->
            <div class="bg-void-800/50 border-b-2 border-void-700" id="controlPanel" style="padding: 8px 24px;">
                <!-- Content generated by JS based on current level -->
            </div>

            <!-- Fretboard Area - Industrial -->
            <div id="mainFretboardArea" class="flex-1 flex flex-col overflow-y-auto" style="height: calc(100vh - 64px);">
                <!-- Current Display Info -->
                <div class="mb-2 text-center px-8" style="padding-top: 12px; padding-bottom: 0;">
                    <h2 class="font-display text-chalk-100 tracking-widest" id="displayTitle" style="font-size: 32px; line-height: 1.2; margin: 0;">SELECCIONA UN NIVEL</h2>
                    <p class="text-void-400 font-body uppercase tracking-wider" id="displaySubtitle" style="font-size: 11px; margin-top: 4px; opacity: 0.7;">Usa la barra lateral para empezar</p>
                </div>

                <!-- Fila superior: Diagramas + T-SD-D (solo visible en Nivel 3) -->
                <div class="level3-top-section hidden" id="level3TopSection">
                    <div class="level3-content-row">
                        <!-- Diagramas de acordes -->
                        <div class="diagrams-container px-8" id="diagramsContainer" style="margin-bottom: 0;">
                            <!-- Generated by JS -->
                        </div>

                        <!-- Panel T-SD-D -->
                        <div class="level3-harmonic-panel px-8" id="infoPanel">
                            <!-- Generated by JS -->
                        </div>
                    </div>
                </div>

                <!-- Fila superior: Diagrama + Explicación (solo visible en Nivel 4) -->
                <div class="level4-top-section hidden" id="level4TopSection">
                    <div class="level4-content-row">
                        <div class="level4-diagram-slot px-8" id="diagramsContainer4">
                            <!-- Generated by JS -->
                        </div>
                        <div class="level4-intro-slot px-8" id="infoPanel4">
                            <!-- Generated by JS -->
                        </div>
                    </div>
                </div>

                <!-- Info panel above fretboard (level 8 and others that need text first) -->
                <div id="infoPanelAboveFretboard" class="hidden px-8 w-full max-w-5xl mx-auto" style="margin-bottom: 8px;"></div>

                <!-- Box/Position Selector -->
                <div class="box-selector hidden px-8" id="boxSelector" style="margin-bottom: 8px;">
                    <!-- Generated by JS -->
                </div>

                <!-- Sticky Fretboard Wrapper -->
                <div class="fretboard-sticky-wrapper" id="fretboardStickyWrapper">
                    <div class="w-full max-w-5xl mx-auto px-8">
                        <!-- Fret Numbers - Industrial -->
                        <div class="flex pl-8" style="margin-bottom: 8px;">
                            <div class="w-8"></div>
                            <div class="flex flex-1">
                                <div class="flex-[0.6] flex justify-center font-mono text-sm text-void-500 font-semibold"><span style="margin-right: 5px;">0</span></div>
                                <div class="flex-1 flex justify-center font-mono text-sm text-void-500 font-semibold"><span style="margin-right: 3px;">1</span></div>
                                <div class="flex-1 flex justify-center font-mono text-sm text-void-500 font-semibold"><span style="margin-right: 3px;">2</span></div>
                                <div class="flex-1 flex justify-center font-mono text-sm text-void-400 font-bold"><span style="margin-right: 3px;">3</span></div>
                                <div class="flex-1 flex justify-center font-mono text-sm text-void-500 font-semibold"><span style="margin-right: 3px;">4</span></div>
                                <div class="flex-1 flex justify-center font-mono text-sm text-void-400 font-bold"><span style="margin-right: 3px;">5</span></div>
                                <div class="flex-1 flex justify-center font-mono text-sm text-void-500 font-semibold"><span style="margin-right: 3px;">6</span></div>
                                <div class="flex-1 flex justify-center font-mono text-sm text-void-400 font-bold"><span style="margin-right: 3px;">7</span></div>
                                <div class="flex-1 flex justify-center font-mono text-sm text-void-500 font-semibold"><span style="margin-right: 3px;">8</span></div>
                                <div class="flex-1 flex justify-center font-mono text-sm text-void-400 font-bold"><span style="margin-right: 3px;">9</span></div>
                                <div class="flex-1 flex justify-center font-mono text-sm text-void-500 font-semibold"><span style="margin-right: 3px;">10</span></div>
                                <div class="flex-1 flex justify-center font-mono text-sm text-void-500 font-semibold"><span style="margin-right: 3px;">11</span></div>
                                <div class="flex-1 flex justify-center font-mono text-sm text-blood-400 font-bold"><span style="margin-right: 3px;">12</span></div>
                            </div>
                        </div>

                        <!-- Fretboard Container -->
                        <div class="fretboard-container p-4" id="fretboard">
                            <!-- Generated by JS -->
                        </div>

                        <!-- Fret markers - Industrial with rounded -->
                        <div class="flex mt-3 pl-8">
                            <div class="w-8"></div>
                            <div class="flex flex-1">
                                <div class="flex-[0.6]"></div>
                                <div class="flex-1"></div>
                                <div class="flex-1"></div>
                                <div class="flex-1 flex justify-center"><div class="w-3 h-3 rounded-full bg-void-500" style="margin-right: 3px;"></div></div>
                                <div class="flex-1"></div>
                                <div class="flex-1 flex justify-center"><div class="w-3 h-3 rounded-full bg-void-500" style="margin-right: 3px;"></div></div>
                                <div class="flex-1"></div>
                                <div class="flex-1 flex justify-center"><div class="w-3 h-3 rounded-full bg-void-500" style="margin-right: 3px;"></div></div>
                                <div class="flex-1"></div>
                                <div class="flex-1 flex justify-center"><div class="w-3 h-3 rounded-full bg-void-500" style="margin-right: 3px;"></div></div>
                                <div class="flex-1"></div>
                                <div class="flex-1"></div>
                                <div class="flex-1 flex justify-center gap-2" style="margin-right: 3px;"><div class="w-3 h-3 rounded-full bg-blood-500"></div><div class="w-3 h-3 rounded-full bg-blood-500"></div></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Scrollable Content Below -->
                <div class="flex-1 px-8">
                    <!-- Scale/Chord Info Panel - Industrial (para otros niveles) -->
                    <div class="mt-4 w-full max-w-5xl mx-auto" id="infoPanelOtherLevels">
                        <!-- Generated by JS -->
                    </div>
                </div>
            </div>
        </main>

        <!-- JAM SESSION FULL LAYOUT (nivel 15) -->
        <div id="jamSessionFullLayout">
            <!-- El template se cargará aquí -->
        </div>
    </div>

    <!-- TEMPLATES FOR CONTROL PANELS -->
    <template id="tpl-intervals">
        <div class="space-y-4">
            <!-- Controles superiores -->
            <div class="interval-play-controls">
                <span class="text-sm text-void-400 font-body uppercase tracking-wider font-semibold">Reproducir:</span>
                <button class="interval-play-btn" data-play-mode="ascending">↑ Ascendente</button>
                <button class="interval-play-btn" data-play-mode="descending">↓ Descendente</button>
                <button class="interval-play-btn" data-play-mode="harmonic">♫ Armónico</button>

                <div style="margin-left: auto; display: flex; gap: 12px; align-items: center;">
                    <span class="text-sm text-void-400 font-body uppercase tracking-wider font-semibold">Ver:</span>
                    <div class="direction-selector">
                        <button class="direction-btn" data-direction="ascending">↑ Asc</button>
                        <button class="direction-btn active" data-direction="both">↕ Ambos</button>
                        <button class="direction-btn" data-direction="descending">↓ Desc</button>
                    </div>
                </div>

                <button class="interval-play-btn" id="toggleComparisonMode" style="margin-left: 12px;">Comparar</button>
            </div>

            <!-- Panel de comparación (oculto por defecto) -->
            <div class="comparison-mode" id="comparisonPanel">
                <div class="comparison-display">
                    <div class="comparison-item empty" id="comparisonInterval1">Selecciona intervalo 1</div>
                    <span class="comparison-vs">VS</span>
                    <div class="comparison-item empty" id="comparisonInterval2">Selecciona intervalo 2</div>
                </div>
                <div class="comparison-controls">
                    <button class="comparison-btn" id="playComparison">Reproducir Comparación</button>
                    <button class="comparison-btn exit" id="exitComparison">Salir</button>
                </div>
            </div>

            <!-- Leyenda de colores -->
            <div class="consonance-legend">
                <span class="text-sm text-void-400 font-body uppercase tracking-wider font-semibold">Leyenda:</span>
                <div class="consonance-legend-item">
                    <div class="consonance-color-box perfect"></div>
                    <span class="consonance-legend-label">Perfecta</span>
                </div>
                <div class="consonance-legend-item">
                    <div class="consonance-color-box imperfect"></div>
                    <span class="consonance-legend-label">Imperfecta</span>
                </div>
                <div class="consonance-legend-item">
                    <div class="consonance-color-box mild"></div>
                    <span class="consonance-legend-label">Disonancia Suave</span>
                </div>
                <div class="consonance-legend-item">
                    <div class="consonance-color-box strong"></div>
                    <span class="consonance-legend-label">Disonancia Fuerte</span>
                </div>
            </div>

            <!-- Intervalos agrupados -->
            <div class="flex flex-wrap items-start gap-4">
                <!-- Segundas -->
                <div class="interval-group">
                    <div class="interval-group-title">Segundas</div>
                    <div class="interval-group-buttons">
                        <button class="interval-btn" data-interval="1" data-consonance="strong-dissonant">2ª m</button>
                        <button class="interval-btn" data-interval="2" data-consonance="mild-dissonant">2ª M</button>
                    </div>
                </div>

                <!-- Terceras -->
                <div class="interval-group">
                    <div class="interval-group-title">Terceras</div>
                    <div class="interval-group-buttons">
                        <button class="interval-btn" data-interval="3" data-consonance="imperfect-consonant">3ª m</button>
                        <button class="interval-btn" data-interval="4" data-consonance="imperfect-consonant">3ª M</button>
                    </div>
                </div>

                <!-- Cuartas -->
                <div class="interval-group">
                    <div class="interval-group-title">Cuartas</div>
                    <div class="interval-group-buttons">
                        <button class="interval-btn" data-interval="5" data-consonance="perfect-consonant">4ª J</button>
                        <button class="interval-btn" data-interval="6" data-consonance="strong-dissonant">Tritono</button>
                    </div>
                </div>

                <!-- Quintas -->
                <div class="interval-group">
                    <div class="interval-group-title">Quintas</div>
                    <div class="interval-group-buttons">
                        <button class="interval-btn" data-interval="7" data-consonance="perfect-consonant">5ª J</button>
                    </div>
                </div>

                <!-- Sextas -->
                <div class="interval-group">
                    <div class="interval-group-title">Sextas</div>
                    <div class="interval-group-buttons">
                        <button class="interval-btn" data-interval="8" data-consonance="imperfect-consonant">6ª m</button>
                        <button class="interval-btn" data-interval="9" data-consonance="imperfect-consonant">6ª M</button>
                    </div>
                </div>

                <!-- Séptimas -->
                <div class="interval-group">
                    <div class="interval-group-title">Séptimas</div>
                    <div class="interval-group-buttons">
                        <button class="interval-btn" data-interval="10" data-consonance="mild-dissonant">7ª m</button>
                        <button class="interval-btn" data-interval="11" data-consonance="strong-dissonant">7ª M</button>
                    </div>
                </div>

                <!-- Octava -->
                <div class="interval-group">
                    <div class="interval-group-title">Octava</div>
                    <div class="interval-group-buttons">
                        <button class="interval-btn" data-interval="12" data-consonance="perfect-consonant">8ª J</button>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <template id="tpl-scales">
        <div class="space-y-4">
            <!-- Controles de audio -->
            <div class="scale-play-controls">
                <span class="text-sm text-void-400">Reproducir:</span>
                <button class="scale-play-btn active" data-scale-play-mode="ascending">↑ Ascendente</button>
                <button class="scale-play-btn" data-scale-play-mode="descending">↓ Descendente</button>

                <span class="text-sm text-void-400 ml-4">Velocidad:</span>
                <div class="speed-selector">
                    <button class="speed-btn" data-speed="slow">Lento</button>
                    <button class="speed-btn active" data-speed="medium">Medio</button>
                    <button class="speed-btn" data-speed="fast">Rápido</button>
                </div>

                <button class="scale-play-btn ml-auto" id="toggleScaleComparison">Comparar</button>
            </div>

            <!-- Panel de comparación (oculto por defecto) -->
            <div class="comparison-mode-scales" id="scaleComparisonPanel">
                <div class="comparison-display">
                    <div class="comparison-item empty" id="comparisonScale1">Selecciona escala 1</div>
                    <span class="comparison-vs">VS</span>
                    <div class="comparison-item empty" id="comparisonScale2">Selecciona escala 2</div>
                </div>

                <!-- Split view con 2 mini fretboards -->
                <div class="comparison-split-view" id="comparisonSplitView"></div>

                <div class="comparison-controls">
                    <button class="comparison-btn" id="playScaleComparison">Reproducir Comparación</button>
                    <button class="comparison-btn exit" id="exitScaleComparison">Salir</button>
                </div>
            </div>

            <!-- Categorías (4 botones) -->
            <div class="flex flex-wrap items-center gap-4">
                <span class="text-sm text-void-400 font-body uppercase tracking-wider font-semibold">Categoría:</span>
                <div class="flex flex-wrap gap-2" id="scaleCatBtnsMain">
                    <button class="scale-cat-btn active" data-category="basic">Básicas</button>
                    <button class="scale-cat-btn" data-category="modes">Modos Griegos</button>
                    <button class="scale-cat-btn" data-category="pentatonic">Pentatónicas</button>
                    <button class="scale-cat-btn" data-category="advanced">Avanzadas</button>
                </div>
            </div>

            <!-- Lista de escalas -->
            <div class="flex flex-wrap items-center gap-4">
                <span class="text-sm text-void-400 font-body uppercase tracking-wider font-semibold">Escala:</span>
                <div class="flex flex-wrap gap-2" id="scaleListMain">
                    <!-- Generated by JS -->
                </div>
            </div>

            <!-- Sub-selector de pentatónicas (SOLO si category === 'pentatonic') -->
            <div id="pentatonicSubOptions" class="hidden space-y-4">
                <!-- Tabs: Global / Boxes -->
                <div class="penta-tabs">
                    <button class="penta-tab-btn active" data-penta-tab="global">Visualización Global</button>
                    <button class="penta-tab-btn" data-penta-tab="boxes">Sistema de Boxes</button>
                </div>

                <!-- Tab Content: Global -->
                <div class="penta-tab-content active" id="pentaTabGlobal">
                    <div class="flex flex-wrap items-center gap-4">
                        <span class="text-sm text-void-400">Tipo:</span>
                        <button class="penta-type-btn active" data-penta-type="minor">Menor</button>
                        <button class="penta-type-btn" data-penta-type="major">Mayor</button>
                        <button class="penta-type-btn" data-penta-type="blues">Blues</button>
                    </div>
                </div>

                <!-- Tab Content: Boxes -->
                <div class="penta-tab-content" id="pentaTabBoxes">
                    <div class="flex flex-wrap items-center gap-4 mb-4">
                        <span class="text-sm text-void-400">Posición:</span>
                        <div id="pentaBoxButtons" class="flex gap-2">
                            <button class="box-btn active" data-box="0">Box 1</button>
                            <button class="box-btn" data-box="1">Box 2</button>
                            <button class="box-btn" data-box="2">Box 3</button>
                            <button class="box-btn" data-box="3">Box 4</button>
                            <button class="box-btn" data-box="4">Box 5</button>
                        </div>
                    </div>

                    <button class="scale-play-btn" id="toggleAllBoxes">Ver las 5 boxes simultáneamente</button>

                    <!-- Container para 5 boxes -->
                    <div class="all-boxes-container hidden" id="allBoxesContainer"></div>

                    <!-- Licks comunes del box activo -->
                    <div class="mt-3">
                        <div class="text-sm text-void-400 mb-2">Licks comunes para este box</div>
                        <div id="licksContainer" style="max-height: 180px; overflow-y: auto; padding-right: 4px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <template id="tpl-chords">
        <div class="space-y-3">
            <div class="flex flex-wrap items-center gap-3">
                <span class="text-sm text-slate-400">Grado:</span>
                <div class="flex flex-wrap gap-2">
                    <button class="chord-btn" data-chord="1"><span class="roman">I</span><span class="name">Mayor</span></button>
                    <button class="chord-btn" data-chord="2"><span class="roman">ii</span><span class="name">menor</span></button>
                    <button class="chord-btn" data-chord="3"><span class="roman">iii</span><span class="name">menor</span></button>
                    <button class="chord-btn" data-chord="4"><span class="roman">IV</span><span class="name">Mayor</span></button>
                    <button class="chord-btn" data-chord="5"><span class="roman">V</span><span class="name">Mayor</span></button>
                    <button class="chord-btn" data-chord="6"><span class="roman">vi</span><span class="name">menor</span></button>
                    <button class="chord-btn" data-chord="7"><span class="roman">vii°</span><span class="name">dim</span></button>
                </div>
                <button id="playBasicChordBtn" class="ctrl-btn ctrl-play ml-2">▶ Play</button>
            </div>
        </div>
    </template>

    <template id="tpl-modes">
        <div class="flex flex-wrap items-center gap-3">
            <span class="text-sm text-slate-400">Modo:</span>
            <div class="flex flex-wrap gap-2">
                <button class="mode-btn-simple active" data-mode="1">I Jónico</button>
                <button class="mode-btn-simple" data-mode="2">II Dórico</button>
                <button class="mode-btn-simple" data-mode="3">III Frigio</button>
                <button class="mode-btn-simple" data-mode="4">IV Lidio</button>
                <button class="mode-btn-simple" data-mode="5">V Mixolidio</button>
                <button class="mode-btn-simple" data-mode="6">VI Eólico</button>
                <button class="mode-btn-simple" data-mode="7">VII Locrio</button>
            </div>
        </div>
    </template>

    <template id="tpl-pentatonics">
        <div class="space-y-3">
            <div class="flex flex-wrap items-center gap-3">
                <span class="text-sm text-slate-400">Tipo:</span>
                <div class="flex flex-wrap gap-2">
                    <button class="chord-btn active" data-penta="minor"><span class="roman">Menor</span></button>
                    <button class="chord-btn" data-penta="major"><span class="roman">Mayor</span></button>
                    <button class="chord-btn" data-penta="blues"><span class="roman">Blues</span></button>
                </div>
            </div>
            <div class="flex flex-wrap items-center gap-3">
                <span class="text-sm text-slate-400">Posición:</span>
                <div class="flex gap-2" id="pentaBoxBtns">
                    <button class="box-btn active" data-box="0">1</button>
                    <button class="box-btn" data-box="1">2</button>
                    <button class="box-btn" data-box="2">3</button>
                    <button class="box-btn" data-box="3">4</button>
                    <button class="box-btn" data-box="4">5</button>
                </div>
            </div>
        </div>
    </template>

    <template id="tpl-circle">
        <div style="display:flex;flex-direction:column;gap:8px;width:100%;">
            <div class="circle-controls-row">
                <button class="circle-view-btn" id="tourPlayBtn">&#9654; Tour Sonoro</button>
                <button class="circle-view-btn" id="tourStopBtn" style="display:none;">&#9632; Stop</button>
                <button class="circle-view-btn active" data-tour-speed="medium">Medio</button>
                <button class="circle-view-btn" data-tour-speed="slow">Lento</button>
                <button class="circle-view-btn" data-tour-speed="fast">Rápido</button>
                <span id="circleInfo" style="font-size:12px;color:#22d3ee;margin-left:6px;font-family:'IBM Plex Mono',monospace;">—</span>
            </div>
            <div id="circleMainRow" style="display:flex;align-items:flex-start;gap:16px;width:100%;">
                <div style="flex:0 0 auto;display:flex;align-items:center;justify-content:center;position:relative;" id="circleWrapOuter">
                    <svg id="circleRelationSvg" style="position:absolute;top:0;left:0;pointer-events:none;z-index:5;"></svg>
                    <div style="position:relative;width:300px;height:300px;" id="circleOfFifthsMain"></div>
                </div>
                <div id="circleSidePanel" style="flex:1;overflow-y:auto;padding:0 8px;box-sizing:border-box;min-width:0;">
                </div>
            </div>
        </div>
    </template>

    <template id="tpl-progressions">
        <div class="space-y-3">
            <div class="flex flex-wrap items-center gap-3">
                <span class="text-sm text-slate-400">Progresión:</span>
                <div class="flex flex-wrap gap-2">
                    <button class="progression-btn-simple active" data-progression="I-IV-V-I">I-IV-V-I</button>
                    <button class="progression-btn-simple" data-progression="I-V-vi-IV">I-V-vi-IV</button>
                    <button class="progression-btn-simple" data-progression="ii-V-I">ii-V-I</button>
                    <button class="progression-btn-simple" data-progression="I-vi-IV-V">I-vi-IV-V</button>
                    <button class="progression-btn-simple" data-progression="vi-IV-I-V">vi-IV-I-V</button>
                    <button class="progression-btn-simple" data-progression="I-bVII-IV-I">I-bVII-IV</button>
                </div>
            </div>
            <div class="flex flex-wrap items-center gap-3">
                <span class="text-sm text-slate-400">Avanzadas:</span>
                <div class="flex flex-wrap gap-2">
                    <button class="progression-btn-simple" data-progression="i-bVII-bVI-V">Andaluza</button>
                    <button class="progression-btn-simple" data-progression="i-bVI-bIII-bVII">Epic</button>
                    <button class="progression-btn-simple" data-progression="i-iv-v-i">Menor Clás.</button>
                    <button class="progression-btn-simple" data-progression="I-vi-ii-V">Rhythm Ch.</button>
                    <button class="progression-btn-simple" data-progression="I-V-vi-iii-IV-I-IV-V">Canon</button>
                </div>
            </div>
            <div class="flex flex-wrap items-center gap-3">
                <span class="text-sm text-slate-400">Jazz Avanzado:</span>
                <div class="flex flex-wrap gap-2">
                    <button class="progression-btn-simple" data-progression="bII7-I">Tritone Sub</button>
                    <button class="progression-btn-simple" data-progression="I-III7-VImaj7-bII7-I">Coltrane</button>
                    <button class="progression-btn-simple" data-progression="I-vi-ii-V-I-vi-ii-V-IV-iv-I-ii-V-I">Rhythm Full</button>
                    <button class="progression-btn-simple" data-progression="iii7-VI7-ii7-V7-I">iii-VI-ii-V-I</button>
                </div>
            </div>
            <div class="flex flex-wrap items-center gap-3">
                <span class="text-sm text-slate-400">Modal/Rock:</span>
                <div class="flex flex-wrap gap-2">
                    <button class="progression-btn-simple" data-progression="i-IV">Dorian</button>
                    <button class="progression-btn-simple" data-progression="I-bII">Phrygian</button>
                    <button class="progression-btn-simple" data-progression="bVII-IV-I">Mixolidio</button>
                    <button class="progression-btn-simple" data-progression="vi-V-IV-V">Indie</button>
                    <button class="progression-btn-simple" data-progression="i-bVII-bVI-bVII">Modal Menor</button>
                    <button class="progression-btn-simple" data-progression="I-III-vi-IV">Terceras</button>
                </div>
            </div>
            <!-- Controles de reproducción de progresión -->
            <div class="mt-6 p-4 bg-black bg-opacity-30 rounded-lg border border-red-900 border-opacity-30">
                <div class="flex flex-wrap items-center gap-4 mb-4">
                    <button id="playProgressionBtn" class="px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded font-semibold transition-colors">
                        ▶️ PLAY
                    </button>
                    <button id="pauseProgressionBtn" class="px-6 py-2 bg-yellow-600 hover:bg-yellow-700 text-white rounded font-semibold transition-colors" disabled>
                        ⏸️ PAUSE
                    </button>
                    <button id="stopProgressionBtn" class="px-6 py-2 bg-red-600 hover:bg-red-700 text-white rounded font-semibold transition-colors" disabled>
                        ⏹️ STOP
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm text-slate-400 mb-2">Tempo (BPM)</label>
                        <div class="flex items-center gap-3">
                            <input type="range" id="progressionBPMSlider" min="40" max="200" value="120"
                                class="flex-1 h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer">
                            <span id="progressionBPMDisplay" class="text-xl font-bold text-red-500 w-12 text-center">120</span>
                        </div>
                    </div>
                    <div class="flex items-center gap-6">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="progressionLoopToggle" class="w-5 h-5">
                            <span class="text-sm text-slate-300">Loop infinito</span>
                        </label>
                        <div class="flex items-center gap-2">
                            <label class="text-sm text-slate-400">Repetir:</label>
                            <input type="number" id="progressionRepeatInput" min="1" max="10" value="1"
                                class="w-16 px-2 py-1 bg-slate-800 text-white rounded border border-slate-600 text-center">
                            <span class="text-sm text-slate-400">veces</span>
                        </div>
                    </div>
                </div>
                <div class="mt-4 p-3 bg-slate-900 bg-opacity-50 rounded">
                    <div class="flex items-center justify-between mb-2">
                        <span id="progressionProgressText" class="text-lg font-bold text-white">Acorde 1 / 4</span>
                        <span id="progressionRepeatText" class="text-sm text-slate-400">Repetición 1 / 1</span>
                    </div>
                    <div class="w-full h-3 bg-slate-800 rounded-full overflow-hidden">
                        <div id="progressionProgressBar" class="h-full bg-gradient-to-r from-green-500 to-red-500 transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <template id="tpl-seventh">
        <div class="flex flex-wrap items-center gap-3">
            <span class="text-sm text-slate-400">Acorde 7ª:</span>
            <div class="flex flex-wrap gap-2">
                <button class="chord-btn" data-chord7="1"><span class="roman">Imaj7</span></button>
                <button class="chord-btn" data-chord7="2"><span class="roman">ii-7</span></button>
                <button class="chord-btn" data-chord7="3"><span class="roman">iii-7</span></button>
                <button class="chord-btn" data-chord7="4"><span class="roman">IVmaj7</span></button>
                <button class="chord-btn" data-chord7="5"><span class="roman">V7</span></button>
                <button class="chord-btn" data-chord7="6"><span class="roman">vi-7</span></button>
                <button class="chord-btn" data-chord7="7"><span class="roman">viiø7</span></button>
            </div>
        </div>
    </template>

    <template id="tpl-caged">
        <div class="space-y-4">
            <!-- Tab navigation -->
            <div class="flex gap-1 bg-void-900 p-1 rounded-lg">
                <button id="caged-tab-learn" class="caged-tab flex-1 py-2 px-3 text-sm font-medium rounded-md transition-colors bg-void-700 text-chalk-100" data-caged-tab="learn">Aprende</button>
                <button id="caged-tab-practice" class="caged-tab flex-1 py-2 px-3 text-sm font-medium rounded-md transition-colors text-void-400 hover:text-chalk-200" data-caged-tab="practice">Practica</button>
                <button id="caged-tab-expand" class="caged-tab flex-1 py-2 px-3 text-sm font-medium rounded-md transition-colors text-void-400 hover:text-chalk-200" data-caged-tab="expand">Expande</button>
                <button id="caged-tab-mastery" class="caged-tab flex-1 py-2 px-3 text-sm font-medium rounded-md transition-colors text-void-400 hover:text-chalk-200" data-caged-tab="mastery">Maestría</button>
            </div>

            <!-- TAB: Aprende -->
            <div id="caged-panel-learn" class="caged-panel space-y-4">
                <!-- Intro compacta -->
                <div class="p-3 bg-blue-900/20 border border-blue-700/50 rounded-lg flex items-center gap-3">
                    <div class="grid grid-cols-5 gap-1 flex-shrink-0">
                        <div class="w-8 h-8 bg-void-800 rounded text-center flex items-center justify-center font-bold text-sm" style="color:#ef4444">C</div>
                        <div class="w-8 h-8 bg-void-800 rounded text-center flex items-center justify-center font-bold text-sm" style="color:#f59e0b">A</div>
                        <div class="w-8 h-8 bg-void-800 rounded text-center flex items-center justify-center font-bold text-sm" style="color:#eab308">G</div>
                        <div class="w-8 h-8 bg-void-800 rounded text-center flex items-center justify-center font-bold text-sm" style="color:#84cc16">E</div>
                        <div class="w-8 h-8 bg-void-800 rounded text-center flex items-center justify-center font-bold text-sm" style="color:#06b6d4">D</div>
                    </div>
                    <p class="text-sm text-void-300">5 formas que cubren todo el mástil en orden circular. <button id="caged-show-all-btn" class="text-sage-400 hover:text-sage-300 underline">Ver sistema completo →</button></p>
                </div>

                <!-- Visualizador interactivo -->
                <div>
                    <p class="text-xs text-void-400 mb-2">Click en los nodos para ver cada forma. Click en las líneas para ver transiciones.</p>
                    <div id="caged-svg-container" class="flex justify-center mb-3">
                        <!-- SVG generado por renderCAGEDMap() -->
                    </div>

                    <!-- Controles del Tour -->
                    <div class="flex items-center justify-center gap-2 flex-wrap mb-3">
                        <button id="caged-tour-prev" class="px-3 py-1.5 bg-void-700 hover:bg-void-600 text-chalk-100 rounded text-sm">⏮ Anterior</button>
                        <button id="caged-tour-btn" class="px-4 py-1.5 bg-sage-600 hover:bg-sage-500 text-chalk-100 rounded text-sm font-medium">▶ Tour</button>
                        <button id="caged-tour-next" class="px-3 py-1.5 bg-void-700 hover:bg-void-600 text-chalk-100 rounded text-sm">Siguiente ⏭</button>
                        <div class="flex items-center gap-2 ml-2">
                            <span class="text-xs text-void-400">Vel:</span>
                            <input id="caged-tour-speed" type="range" min="0.5" max="2" step="0.25" value="1" class="w-20 accent-sage-500">
                            <span id="caged-tour-speed-label" class="text-xs text-void-300 w-6">1x</span>
                        </div>
                    </div>

                    <!-- Panel de información dinámica -->
                    <div id="caged-info-panel" class="p-4 bg-void-800 rounded-lg hidden">
                        <!-- Contenido dinámico -->
                    </div>
                </div>
            </div>

            <!-- TAB: Practica -->
            <div id="caged-panel-practice" class="caged-panel hidden space-y-4">
                <!-- A1: Entrenamiento Progresivo -->
                <div class="p-4 bg-void-800 rounded-lg">
                    <h3 class="text-base font-medium text-sage-400 mb-3">Entrenamiento Progresivo</h3>
                    <div class="grid grid-cols-5 gap-2 mb-3" id="caged-training-levels">
                        <button class="caged-train-lvl p-2 rounded text-center text-sm font-medium border transition-colors border-sage-600 bg-sage-600/20 text-sage-300" data-level="1">
                            <div class="font-bold" style="color:#ef4444">C</div>
                            <div class="text-xs text-void-400 mt-1">Nivel 1</div>
                        </button>
                        <button class="caged-train-lvl p-2 rounded text-center text-sm font-medium border transition-colors border-void-600 bg-void-700 text-void-400" data-level="2">
                            <div class="text-sm">C+<span style="color:#f59e0b">A</span></div>
                            <div class="text-xs text-void-500 mt-1">Nivel 2</div>
                        </button>
                        <button class="caged-train-lvl p-2 rounded text-center text-sm font-medium border transition-colors border-void-600 bg-void-700 text-void-400" data-level="3">
                            <div class="text-sm">+<span style="color:#eab308">G</span></div>
                            <div class="text-xs text-void-500 mt-1">Nivel 3</div>
                        </button>
                        <button class="caged-train-lvl p-2 rounded text-center text-sm font-medium border transition-colors border-void-600 bg-void-700 text-void-400" data-level="4">
                            <div class="text-sm">+<span style="color:#84cc16">E</span></div>
                            <div class="text-xs text-void-500 mt-1">Nivel 4</div>
                        </button>
                        <button class="caged-train-lvl p-2 rounded text-center text-sm font-medium border transition-colors border-void-600 bg-void-700 text-void-400" data-level="5">
                            <div class="text-sm">+<span style="color:#06b6d4">D</span></div>
                            <div class="text-xs text-void-500 mt-1">Nivel 5</div>
                        </button>
                    </div>
                    <div id="caged-training-desc" class="text-sm text-void-300 mb-3 p-2 bg-void-900 rounded">
                        Nivel 1: Domina la forma C. Practica la posición abierta hasta sentirte cómodo.
                    </div>
                    <div class="flex gap-2">
                        <button id="caged-train-start" class="flex-1 py-2 bg-sage-600 hover:bg-sage-500 text-chalk-100 rounded font-medium text-sm">Practicar este nivel</button>
                        <button id="caged-train-advance" class="px-4 py-2 bg-void-700 hover:bg-void-600 text-chalk-200 rounded text-sm">Siguiente nivel →</button>
                    </div>
                </div>

                <!-- A5: Quiz CAGED -->
                <div class="p-4 bg-void-800 rounded-lg">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-base font-medium text-sage-400">Quiz CAGED</h3>
                        <div class="flex gap-3 text-sm">
                            <span class="text-void-400">Score: <span id="caged-quiz-score" class="text-chalk-200 font-bold">0</span></span>
                            <span class="text-void-400">Racha: <span id="caged-quiz-streak" class="text-sage-400 font-bold">0</span></span>
                        </div>
                    </div>
                    <div id="caged-quiz-question" class="text-center mb-4">
                        <p class="text-sm text-void-400 mb-3">¿Qué forma CAGED es esta?</p>
                        <div id="caged-quiz-diagram" class="flex justify-center mb-3 min-h-[120px] items-center">
                            <p class="text-void-500 text-sm">Inicia el quiz para ver un diagrama</p>
                        </div>
                        <div id="caged-quiz-feedback" class="text-sm font-medium mb-3 h-5"></div>
                    </div>
                    <div class="grid grid-cols-5 gap-2 mb-3" id="caged-quiz-buttons">
                        <button class="caged-quiz-ans py-2 bg-void-700 hover:bg-void-600 text-chalk-200 rounded font-bold text-lg transition-colors" data-shape="C" style="color:#ef4444">C</button>
                        <button class="caged-quiz-ans py-2 bg-void-700 hover:bg-void-600 text-chalk-200 rounded font-bold text-lg transition-colors" data-shape="A" style="color:#f59e0b">A</button>
                        <button class="caged-quiz-ans py-2 bg-void-700 hover:bg-void-600 text-chalk-200 rounded font-bold text-lg transition-colors" data-shape="G" style="color:#eab308">G</button>
                        <button class="caged-quiz-ans py-2 bg-void-700 hover:bg-void-600 text-chalk-200 rounded font-bold text-lg transition-colors" data-shape="E" style="color:#84cc16">E</button>
                        <button class="caged-quiz-ans py-2 bg-void-700 hover:bg-void-600 text-chalk-200 rounded font-bold text-lg transition-colors" data-shape="D" style="color:#06b6d4">D</button>
                    </div>
                    <button id="caged-quiz-start" class="w-full py-2 bg-sage-600 hover:bg-sage-500 text-chalk-100 rounded font-medium text-sm">Iniciar Quiz</button>
                </div>
            </div>

            <!-- TAB: Expande -->
            <div id="caged-panel-expand" class="caged-panel hidden space-y-4">
                <!-- A3: Extensiones 7ª/9ª -->
                <div class="p-4 bg-void-800 rounded-lg">
                    <h3 class="text-base font-medium text-sage-400 mb-3">CAGED con Extensiones</h3>
                    <div class="flex gap-4 mb-4">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="caged-show-7th" class="w-4 h-4 accent-sage-500">
                            <span class="text-sm text-chalk-200">Mostrar 7ª</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="caged-show-9th" class="w-4 h-4 accent-sage-500">
                            <span class="text-sm text-chalk-200">Mostrar 9ª</span>
                        </label>
                    </div>
                    <div id="caged-extensions-diagram" class="flex justify-center min-h-[120px] items-center">
                        <p class="text-void-500 text-sm">Selecciona una forma en el visualizador y activa las extensiones</p>
                    </div>
                </div>

                <!-- A6: Vista mástil completo -->
                <div class="p-4 bg-void-800 rounded-lg">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-base font-medium text-sage-400">Mapa del Mástil</h3>
                        <div class="flex gap-1 bg-void-900 rounded p-0.5">
                            <button id="caged-view-pentagon" class="px-3 py-1 text-xs rounded bg-void-700 text-chalk-200 font-medium" data-view="pentagon">Pentágono</button>
                            <button id="caged-view-fretboard" class="px-3 py-1 text-xs rounded text-void-400 hover:text-chalk-200" data-view="fretboard">Mástil</button>
                        </div>
                    </div>
                    <div id="caged-fretboard-map" class="flex justify-center overflow-x-auto">
                        <!-- SVG del mástil generado por renderCAGEDFretboardMap() -->
                        <p class="text-void-500 text-sm py-4">Cambia a vista Mástil para ver el mapa completo</p>
                    </div>
                </div>
            </div>

            <!-- TAB: Maestría -->
            <div id="caged-panel-mastery" class="caged-panel hidden space-y-4">
                <!-- Toggle Ver todas -->
                <div class="p-4 bg-sage-900/20 border border-sage-600 rounded-lg">
                    <div class="flex items-center justify-between mb-3">
                        <div>
                            <h3 class="text-base font-medium text-sage-400">Ver Todas las Formas</h3>
                            <p class="text-sm text-void-400">Compara las 5 posiciones simultáneamente</p>
                        </div>
                        <button id="cagedShowAllToggle" class="relative inline-flex h-8 w-16 items-center rounded-full bg-void-700 transition-colors">
                            <span class="inline-block h-6 w-6 transform rounded-full bg-chalk-100 transition-transform translate-x-1" id="caged-toggle-dot"></span>
                        </button>
                    </div>
                    <div id="caged-all-diagrams" class="hidden mt-4">
                        <div class="grid grid-cols-2 md:grid-cols-5 gap-3" id="caged-diagrams-container">
                            <!-- Diagramas generados dinámicamente -->
                        </div>
                    </div>
                </div>

                <!-- Ejercicio: Encuentra el patrón -->
                <div class="p-4 bg-void-800 rounded-lg">
                    <h3 class="text-base font-medium text-sage-400 mb-3">Ejercicio: Encuentra el patrón</h3>
                    <p class="text-sm text-chalk-200 mb-3">Toca un acorde C mayor usando las 5 formas CAGED en orden:</p>
                    <ol class="text-sm text-void-300 space-y-2 ml-6 list-decimal">
                        <li>Forma C (posición abierta) - Traste 0</li>
                        <li>Forma A (barre en 3er traste) - Traste 3</li>
                        <li>Forma G (barre en 5º traste) - Traste 5</li>
                        <li>Forma E (barre en 8º traste) - Traste 8</li>
                        <li>Forma D (barre en 10º traste) - Traste 10</li>
                    </ol>
                    <div class="mt-4 p-3 bg-blue-900/20 border border-blue-700 rounded">
                        <strong class="text-blue-400">Reto avanzado:</strong>
                        <p class="text-sm text-chalk-200 mt-1">¿Puedes tocar una progresión I-IV-V (C-F-G) usando solo formas E?</p>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <template id="tpl-extended">
        <div id="extendedMainContent">
        </div>
    </template>

    <template id="tpl-training">
        <div class="space-y-4">
            <!-- Training Mode Tabs -->
            <div class="flex gap-2 border-b border-void-700 pb-2 mb-4">
                <button class="training-tab active" data-tab="visual">
                    ❓ Quiz Visual
                </button>
                <button class="training-tab" data-tab="audio">
                    👂 Ear Training
                </button>
            </div>

            <!-- Quiz Content -->
            <div id="trainingQuizContent">
                <div class="flex flex-wrap items-center gap-3">
                    <span class="text-sm text-void-400">Categoría:</span>
                    <div class="flex flex-wrap gap-2">
                        <button class="quiz-cat-btn active" data-category="intervals">Intervalos</button>
                        <button class="quiz-cat-btn" data-category="scales">Escalas</button>
                        <button class="quiz-cat-btn" data-category="chords">Acordes</button>
                        <button class="quiz-cat-btn" data-category="modes">Modos</button>
                        <button class="quiz-cat-btn" data-category="theory">Teoría</button>
                    </div>
                </div>
                <div class="flex items-center gap-3 mt-4">
                    <span class="text-sm text-void-400">Dificultad:</span>
                    <button class="box-btn active" data-diff="easy">Fácil</button>
                    <button class="box-btn" data-diff="medium">Medio</button>
                    <button class="box-btn" data-diff="hard">Difícil</button>
                </div>
                <div class="flex items-center gap-6 text-sm mt-4">
                    <span>Puntos: <strong id="quizScore" class="text-blood-400">0</strong></span>
                    <span>Racha: <strong id="quizStreak" class="text-brass-400">0</strong></span>
                    <span>Mejor: <strong id="quizBest" class="text-chalk-100">0</strong></span>
                    <button class="btn-secondary ml-4" id="newQuizBtn">Nueva Pregunta</button>
                </div>
            </div>

            <!-- Ear Training Content -->
            <div id="trainingEarContent" style="display: none;">
                <div class="flex gap-2 mb-4">
                    <button class="ear-exercise-tab active" data-exercise="intervals">Intervalos</button>
                    <button class="ear-exercise-tab" data-exercise="chords">Acordes</button>
                    <button class="ear-exercise-tab" data-exercise="scales">Escalas</button>
                </div>
                <div class="flex items-center gap-3 mb-4">
                    <span class="text-sm text-void-400">Dificultad:</span>
                    <button class="box-btn active" data-ear-level="easy">Fácil</button>
                    <button class="box-btn" data-ear-level="medium">Medio</button>
                    <button class="box-btn" data-ear-level="hard">Difícil</button>
                </div>
            </div>
        </div>
    </template>

    <template id="tpl-practice">
        <div class="space-y-4">
            <!-- Practice Mode Tabs -->
            <div class="flex gap-2 border-b border-void-700 pb-2 mb-4">
                <button class="practice-tab active" data-tab="songs">
                    🎶 Canciones
                </button>
                <button class="practice-tab" data-tab="jam">
                    🎤 Jam Session
                </button>
                <button class="practice-tab" data-tab="licks">
                    📚 Lick Library
                </button>
            </div>

            <!-- Songs Content -->
            <div id="practiceSongsContent">
                <div class="flex flex-wrap items-center gap-3">
                    <span class="text-sm text-void-400">Género:</span>
                    <div class="flex flex-wrap gap-2">
                        <button class="box-btn active" data-genre="all">Todos</button>
                        <button class="box-btn" data-genre="rock">Rock</button>
                        <button class="box-btn" data-genre="metal">Metal</button>
                        <button class="box-btn" data-genre="blues">Blues</button>
                        <button class="box-btn" data-genre="jazz">Jazz</button>
                        <button class="box-btn" data-genre="pop">Pop</button>
                    </div>
                </div>
            </div>

            <!-- Jam Session Content -->
            <div id="practiceJamContent" style="display: none;">
                <!-- Jam session se renderiza dinámicamente -->
            </div>

            <!-- Lick Library Content - Removed (duplicated in tpl-lick-library) -->
        </div>
    </template>

    <template id="tpl-chord-lab">
        <div class="space-y-4">
            <!-- Mode Tabs -->
            <div class="flex gap-2 border-b border-void-700 pb-2 mb-4">
                <button class="chord-lab-mode-btn active" data-mode="progression-builder">
                    🎵 Progression Lab
                </button>
                <button class="chord-lab-mode-btn" data-mode="chord-builder">
                    🎨 Chord Builder
                </button>
                <button class="chord-lab-mode-btn" data-mode="practice">
                    💪 Practice
                </button>
            </div>

            <!-- Integrated Fretboard (Chord Lab specific) -->
            <div class="fretboard-chord-lab-wrapper mb-6 p-4 bg-void-900/30 rounded-lg border border-sage-600/20">
                <div class="w-full max-w-5xl mx-auto">
                    <!-- Fret Numbers -->
                    <div class="flex mb-3 pl-8">
                        <div class="w-8"></div>
                        <div class="flex flex-1">
                            <div class="flex-[0.6] flex justify-center font-mono text-sm text-void-500 font-semibold"><span style="margin-right: 5px;">0</span></div>
                            <div class="flex-1 flex justify-center font-mono text-sm text-void-500 font-semibold"><span style="margin-right: 3px;">1</span></div>
                            <div class="flex-1 flex justify-center font-mono text-sm text-void-500 font-semibold"><span style="margin-right: 3px;">2</span></div>
                            <div class="flex-1 flex justify-center font-mono text-sm text-void-400 font-bold"><span style="margin-right: 3px;">3</span></div>
                            <div class="flex-1 flex justify-center font-mono text-sm text-void-500 font-semibold"><span style="margin-right: 3px;">4</span></div>
                            <div class="flex-1 flex justify-center font-mono text-sm text-void-400 font-bold"><span style="margin-right: 3px;">5</span></div>
                            <div class="flex-1 flex justify-center font-mono text-sm text-void-500 font-semibold"><span style="margin-right: 3px;">6</span></div>
                            <div class="flex-1 flex justify-center font-mono text-sm text-void-400 font-bold"><span style="margin-right: 3px;">7</span></div>
                            <div class="flex-1 flex justify-center font-mono text-sm text-void-500 font-semibold"><span style="margin-right: 3px;">8</span></div>
                            <div class="flex-1 flex justify-center font-mono text-sm text-void-400 font-bold"><span style="margin-right: 3px;">9</span></div>
                            <div class="flex-1 flex justify-center font-mono text-sm text-void-500 font-semibold"><span style="margin-right: 3px;">10</span></div>
                            <div class="flex-1 flex justify-center font-mono text-sm text-void-500 font-semibold"><span style="margin-right: 3px;">11</span></div>
                            <div class="flex-1 flex justify-center font-mono text-sm text-blood-400 font-bold"><span style="margin-right: 3px;">12</span></div>
                        </div>
                    </div>

                    <!-- Fretboard Container (Chord Lab) -->
                    <div class="fretboard-container p-4" id="fretboard-chord-lab">
                        <!-- Generated by JS -->
                    </div>

                    <!-- Fret markers -->
                    <div class="flex mt-3 pl-8">
                        <div class="w-8"></div>
                        <div class="flex flex-1">
                            <div class="flex-[0.6]"></div>
                            <div class="flex-1"></div>
                            <div class="flex-1"></div>
                            <div class="flex-1 flex justify-center"><div class="w-3 h-3 rounded-full bg-void-500" style="margin-right: 3px;"></div></div>
                            <div class="flex-1"></div>
                            <div class="flex-1 flex justify-center"><div class="w-3 h-3 rounded-full bg-void-500" style="margin-right: 3px;"></div></div>
                            <div class="flex-1"></div>
                            <div class="flex-1 flex justify-center"><div class="w-3 h-3 rounded-full bg-void-500" style="margin-right: 3px;"></div></div>
                            <div class="flex-1"></div>
                            <div class="flex-1 flex justify-center"><div class="w-3 h-3 rounded-full bg-void-500" style="margin-right: 3px;"></div></div>
                            <div class="flex-1"></div>
                            <div class="flex-1"></div>
                            <div class="flex-1 flex justify-center gap-2" style="margin-right: 3px;"><div class="w-3 h-3 rounded-full bg-blood-500"></div><div class="w-3 h-3 rounded-full bg-blood-500"></div></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Mode: Progression Lab Pro -->
            <div id="chord-lab-progression-builder" class="chord-lab-mode">
                <!-- Sub-tabs for Guided/Free modes -->
                <div class="flex gap-2 border-b border-void-700 pb-2 mb-4">
                    <button class="progression-mode-btn active" data-submode="guided">
                        🎯 Guiado
                    </button>
                    <button class="progression-mode-btn" data-submode="free">
                        🎨 Libre
                    </button>
                </div>

                <!-- Main Layout: Progression + Analysis -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                    <!-- LEFT: Progression Chain Panel -->
                    <div class="lg:col-span-2 space-y-4">
                        <!-- Progression Chain -->
                        <div class="p-4 bg-void-800 rounded-lg border border-sage-600">
                            <div class="flex justify-between items-center mb-3">
                                <h3 class="text-lg font-medium text-sage-400">🎵 Progresión</h3>
                                <div class="text-xs text-void-400">
                                    <span id="progression-key-display">Tonalidad: C</span>
                                </div>
                            </div>

                            <div id="progression-chain" class="flex items-center gap-2 flex-wrap min-h-[60px] p-3 bg-void-900 rounded">
                                <span class="text-sm text-void-400">Añade acordes para comenzar...</span>
                            </div>

                            <!-- Voice Leading Visualization -->
                            <div id="voice-leading-viz" class="mt-4 p-3 bg-void-900 rounded hidden">
                                <div class="text-xs text-sage-400 mb-2">Voice Leading:</div>
                                <svg id="voice-leading-svg" width="100%" height="60" class="overflow-visible"></svg>
                            </div>

                            <!-- Controls -->
                            <div class="mt-4 flex flex-wrap gap-2">
                                <button id="play-progression" class="px-4 py-2 bg-sage-600 hover:bg-sage-500 text-chalk-100 rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                    ▶ Play
                                </button>
                                <button id="save-progression" class="px-3 py-2 bg-blue-600 hover:bg-blue-500 text-chalk-100 rounded text-sm disabled:opacity-50" disabled>
                                    💾 Save
                                </button>
                                <button id="load-progression" class="px-3 py-2 bg-teal-600 hover:bg-teal-500 text-chalk-100 rounded text-sm">
                                    📂 Load
                                </button>
                                <button id="transpose-progression" class="px-3 py-2 bg-purple-600 hover:bg-purple-500 text-chalk-100 rounded text-sm disabled:opacity-50" disabled>
                                    🔄 Transpose
                                </button>
                                <button id="reverse-progression" class="px-3 py-2 bg-amber-600 hover:bg-amber-500 text-chalk-100 rounded text-sm disabled:opacity-50" disabled>
                                    ↩️ Reverse
                                </button>
                                <button id="mutate-progression" class="px-3 py-2 bg-indigo-600 hover:bg-indigo-500 text-chalk-100 rounded text-sm disabled:opacity-50" disabled>
                                    🎲 Mutate
                                </button>
                                <button id="clear-progression" class="px-3 py-2 bg-red-600 hover:bg-red-500 text-chalk-100 rounded text-sm disabled:opacity-50" disabled>
                                    🗑️ Clear
                                </button>
                            </div>
                        </div>

                        <!-- GUIDED MODE Content -->
                        <div id="guided-mode-content" class="space-y-4">
                            <!-- Step 1: Initial Chord (only shown when empty) -->
                            <div id="initial-chord-selector" class="p-4 bg-void-800 rounded-lg">
                                <h3 class="text-sm font-medium text-sage-400 mb-3">1️⃣ Acorde Inicial</h3>
                                <div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-2">
                                    <button class="initial-chord-btn" data-chord="C" data-quality="maj">C</button>
                                    <button class="initial-chord-btn" data-chord="C" data-quality="min">Cm</button>
                                    <button class="initial-chord-btn" data-chord="D" data-quality="maj">D</button>
                                    <button class="initial-chord-btn" data-chord="D" data-quality="min">Dm</button>
                                    <button class="initial-chord-btn" data-chord="E" data-quality="maj">E</button>
                                    <button class="initial-chord-btn" data-chord="E" data-quality="min">Em</button>
                                    <button class="initial-chord-btn" data-chord="F" data-quality="maj">F</button>
                                    <button class="initial-chord-btn" data-chord="F" data-quality="min">Fm</button>
                                    <button class="initial-chord-btn" data-chord="G" data-quality="maj">G</button>
                                    <button class="initial-chord-btn" data-chord="G" data-quality="min">Gm</button>
                                    <button class="initial-chord-btn" data-chord="A" data-quality="maj">A</button>
                                    <button class="initial-chord-btn" data-chord="A" data-quality="min">Am</button>
                                </div>
                            </div>

                            <!-- Step 2: Emotion Selector -->
                            <div id="emotion-selector" class="p-4 bg-void-800 rounded-lg hidden">
                                <h3 class="text-sm font-medium text-sage-400 mb-3">2️⃣ Color/Emoción</h3>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                                    <button class="emotion-btn" data-emotion="bright">
                                        <div class="text-xl mb-1">☀️</div>
                                        <div class="text-xs font-medium">Brillante</div>
                                    </button>
                                    <button class="emotion-btn" data-emotion="dark">
                                        <div class="text-xl mb-1">🌙</div>
                                        <div class="text-xs font-medium">Oscuro</div>
                                    </button>
                                    <button class="emotion-btn" data-emotion="tense">
                                        <div class="text-xl mb-1">⚡</div>
                                        <div class="text-xs font-medium">Tenso</div>
                                    </button>
                                    <button class="emotion-btn" data-emotion="resolved">
                                        <div class="text-xl mb-1">✨</div>
                                        <div class="text-xs font-medium">Resolutivo</div>
                                    </button>
                                </div>
                            </div>

                            <!-- Step 3: Chord Suggestions -->
                            <div id="chord-suggestions" class="hidden">
                                <h3 class="text-sm font-medium text-sage-400 mb-3">3️⃣ Sugerencias</h3>
                                <div id="suggestions-grid" class="grid grid-cols-1 md:grid-cols-2 gap-3"></div>
                            </div>
                        </div>

                        <!-- FREE MODE Content -->
                        <div id="free-mode-content" class="hidden">
                            <div class="p-4 bg-void-800 rounded-lg">
                                <h3 class="text-sm font-medium text-sage-400 mb-3">🎨 Paleta de Acordes</h3>
                                <div class="space-y-3">
                                    <!-- Key selector -->
                                    <div class="flex items-center gap-3">
                                        <span class="text-xs text-void-400">Tonalidad:</span>
                                        <select id="free-mode-key" class="px-2 py-1 bg-void-900 text-chalk-100 rounded border border-void-600 text-sm">
                                            <option value="C">C</option>
                                            <option value="D">D</option>
                                            <option value="E">E</option>
                                            <option value="F">F</option>
                                            <option value="G">G</option>
                                            <option value="A">A</option>
                                            <option value="B">B</option>
                                        </select>
                                    </div>

                                    <!-- Chord palette with color-coding -->
                                    <div id="free-mode-palette" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2">
                                        <!-- Populated by JS with color-coded compatibility -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- RIGHT: Analysis Panel -->
                    <div class="space-y-4">
                        <!-- Harmonic Analysis -->
                        <div class="p-4 bg-void-800 rounded-lg border border-sage-600">
                            <h3 class="text-sm font-medium text-sage-400 mb-3">📊 Análisis</h3>
                            <div id="analysis-content" class="space-y-3 text-xs">
                                <div class="text-void-400">Añade acordes para ver análisis...</div>
                            </div>
                        </div>

                        <!-- Voice Leading Details -->
                        <div id="voice-leading-panel" class="p-4 bg-void-800 rounded-lg border border-amber-600 hidden">
                            <h3 class="text-sm font-medium text-amber-400 mb-3">🎼 Voice Leading</h3>
                            <div id="voice-leading-content" class="space-y-2 text-xs"></div>
                        </div>

                        <!-- Story/Narrative -->
                        <div id="progression-story" class="p-4 bg-sage-900/20 rounded-lg border border-sage-600 hidden">
                            <h3 class="text-sm font-medium text-sage-400 mb-2">📖 Historia</h3>
                            <div id="story-content" class="text-xs text-void-300 leading-relaxed"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Mode: Practice Builder -->
            <div id="chord-lab-practice" class="chord-lab-mode hidden">
                <div class="space-y-4">
                    <div>
                        <h3 class="text-lg font-medium text-sage-400 mb-3">Practice Exercises</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <button class="chord-lab-exercise-btn" data-exercise="shape-shifting">
                                <div class="text-base font-medium">Shape Shifting</div>
                                <div class="text-sm text-void-400">Same chord, different forms</div>
                            </button>
                            <button class="chord-lab-exercise-btn" data-exercise="position-trainer">
                                <div class="text-base font-medium">Position Trainer</div>
                                <div class="text-sm text-void-400">Random chord quiz</div>
                            </button>
                            <button class="chord-lab-exercise-btn" data-exercise="progression-voicings">
                                <div class="text-base font-medium">Progression Voicings</div>
                                <div class="text-sm text-void-400">Best shapes for songs</div>
                            </button>
                        </div>
                    </div>
                    <div id="chord-lab-practice-area" class="p-4 bg-void-800 rounded-lg hidden">
                        <!-- Practice content loaded here -->
                    </div>
                </div>
            </div>

            <!-- Mode: Chord Builder -->
            <div id="chord-lab-chord-builder" class="chord-lab-mode hidden">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                    <!-- LEFT: Interactive Fretboard -->
                    <div class="lg:col-span-2 space-y-4">
                        <div class="p-4 bg-void-800 rounded-lg border border-sage-600">
                            <h3 class="text-sm font-medium text-sage-400 mb-3">🎸 Diapasón Interactivo</h3>
                            <p class="text-xs text-void-400 mb-4">Click en las notas para construir tu acorde</p>

                            <!-- Interactive Fretboard -->
                            <div id="chord-builder-fretboard" class="relative">
                                <!-- Populated by JS -->
                            </div>

                            <div class="mt-4 flex gap-2">
                                <button id="chord-builder-play" class="px-4 py-2 bg-sage-600 hover:bg-sage-500 text-chalk-100 rounded text-sm">
                                    ▶ Play
                                </button>
                                <button id="chord-builder-clear" class="px-3 py-2 bg-void-700 hover:bg-void-600 text-chalk-100 rounded text-sm">
                                    Clear
                                </button>
                                <button id="chord-builder-save" class="px-3 py-2 bg-blue-600 hover:bg-blue-500 text-chalk-100 rounded text-sm">
                                    💾 Save
                                </button>
                            </div>
                        </div>

                        <!-- Suggestions Panel -->
                        <div id="chord-builder-suggestions" class="p-4 bg-void-800 rounded-lg hidden">
                            <h3 class="text-sm font-medium text-sage-400 mb-3">💡 Sugerencias</h3>
                            <div id="chord-builder-suggestions-content" class="space-y-2 text-xs">
                                <!-- Populated by JS -->
                            </div>
                        </div>
                    </div>

                    <!-- RIGHT: Analysis & Info -->
                    <div class="space-y-4">
                        <!-- Chord Identification -->
                        <div class="p-4 bg-void-800 rounded-lg border border-sage-600">
                            <h3 class="text-sm font-medium text-sage-400 mb-3">🎯 Identificación</h3>
                            <div id="chord-builder-identification" class="space-y-3">
                                <div>
                                    <div class="text-void-400 text-xs mb-1">Acorde:</div>
                                    <div id="chord-builder-name" class="text-2xl font-bold text-chalk-100">
                                        ---
                                    </div>
                                </div>
                                <div>
                                    <div class="text-void-400 text-xs mb-1">Notas:</div>
                                    <div id="chord-builder-notes" class="text-sm text-chalk-200">
                                        Selecciona notas...
                                    </div>
                                </div>
                                <div>
                                    <div class="text-void-400 text-xs mb-1">Intervalos:</div>
                                    <div id="chord-builder-intervals" class="text-sm text-chalk-200">
                                        ---
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Voicing Analysis -->
                        <div id="chord-builder-analysis" class="p-4 bg-void-800 rounded-lg hidden">
                            <h3 class="text-sm font-medium text-sage-400 mb-3">📊 Análisis</h3>
                            <div id="chord-builder-analysis-content" class="space-y-2 text-xs">
                                <!-- Populated by JS -->
                            </div>
                        </div>

                        <!-- Saved Voicings Library -->
                        <div class="p-4 bg-void-800 rounded-lg">
                            <h3 class="text-sm font-medium text-sage-400 mb-3">📚 Mis Voicings</h3>
                            <div id="chord-builder-library" class="space-y-2">
                                <div class="text-xs text-void-400 text-center py-4">
                                    Guarda voicings para crear tu biblioteca
                                </div>
                            </div>
                        </div>

                        <!-- Famous Voicings -->
                        <div class="p-4 bg-void-800 rounded-lg">
                            <h3 class="text-sm font-medium text-sage-400 mb-3">⭐ Voicings Famosos</h3>
                            <div id="chord-builder-famous" class="space-y-1">
                                <button class="w-full text-left px-2 py-1 text-xs bg-void-900 hover:bg-void-700 rounded" data-voicing="Dsus2_bright">
                                    Dsus2 - Wonderwall
                                </button>
                                <button class="w-full text-left px-2 py-1 text-xs bg-void-900 hover:bg-void-700 rounded" data-voicing="Em7_beatles">
                                    Em7 - Something
                                </button>
                                <button class="w-full text-left px-2 py-1 text-xs bg-void-900 hover:bg-void-700 rounded" data-voicing="Gmaj7_bright">
                                    Gmaj7 - Bright
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chord Story Panel (moved outside sticky wrapper) -->
            <div id="chord-story-panel" class="mt-6 p-4 bg-sage-900/20 border border-sage-600 rounded-lg hidden">
                <h4 class="text-lg font-medium text-sage-400 mb-3">📖 Historia de este acorde</h4>
                <div id="chord-story-content" class="space-y-2 text-sm">
                    <!-- Contenido dinámico -->
                </div>
            </div>
        </div>
    </template>

    <template id="tpl-secondary">
        <div class="space-y-3">
            <!-- Tabs -->
            <div class="flex gap-1 p-1 rounded-lg" style="background:#111;">
                <button class="sec-tab-btn active" data-sectab="learn" style="flex:1;padding:6px 10px;border-radius:6px;font-size:13px;border:none;cursor:pointer;background:#1e1e1e;color:#fafafa;transition:all 0.2s;">Aprende</button>
                <button class="sec-tab-btn" data-sectab="explore" style="flex:1;padding:6px 10px;border-radius:6px;font-size:13px;border:none;cursor:pointer;background:transparent;color:#888;transition:all 0.2s;">Explora</button>
            </div>

            <!-- Tab: Aprende — navegación por pasos -->
            <div class="sec-tab-panel" data-secpanel="learn">
                <div class="space-y-2">
                    <!-- Step pills -->
                    <div class="flex gap-1 flex-wrap" id="secStepPills">
                        <button class="sec-step-pill active" data-step="0" style="padding:8px 18px;border-radius:20px;font-size:14px;font-weight:600;border:1px solid #dc2626;background:#dc2626;color:#fff;cursor:pointer;">1. Tonalidad</button>
                        <button class="sec-step-pill" data-step="1" style="padding:8px 18px;border-radius:20px;font-size:14px;font-weight:600;border:1px solid #555;background:transparent;color:#aaa;cursor:pointer;">2. Grados</button>
                        <button class="sec-step-pill" data-step="2" style="padding:8px 18px;border-radius:20px;font-size:14px;font-weight:600;border:1px solid #555;background:transparent;color:#aaa;cursor:pointer;">3. Funciones</button>
                        <button class="sec-step-pill" data-step="3" style="padding:8px 18px;border-radius:20px;font-size:14px;font-weight:600;border:1px solid #555;background:transparent;color:#aaa;cursor:pointer;">4. Dom. Secundario</button>
                    </div>
                    <!-- Prev / Next -->
                    <div class="flex items-center justify-between" style="padding:4px 0;">
                        <button id="secStepPrev" style="padding:5px 14px;background:#1e1e1e;border:1px solid #333;border-radius:6px;color:#ccc;font-size:12px;cursor:pointer;">← Anterior</button>
                        <span id="secStepIndicator" style="font-size:11px;color:#666;">Paso 1 / 4</span>
                        <button id="secStepNext" style="padding:5px 14px;background:#dc2626;border:1px solid #dc2626;border-radius:6px;color:#fff;font-size:12px;cursor:pointer;">Siguiente →</button>
                    </div>
                </div>
            </div>

            <!-- Tab: Explora -->
            <div class="sec-tab-panel hidden" data-secpanel="explore">
                <div class="space-y-2">
                    <div class="flex flex-wrap items-center gap-3">
                        <span class="text-sm text-void-400">Dominante de:</span>
                        <button class="chord-btn active" data-secondary="ii">V/ii</button>
                        <button class="chord-btn" data-secondary="iii">V/iii</button>
                        <button class="chord-btn" data-secondary="IV">V/IV</button>
                        <button class="chord-btn" data-secondary="V">V/V</button>
                        <button class="chord-btn" data-secondary="vi">V/vi</button>
                    </div>
                    <div class="flex flex-wrap items-center gap-3">
                        <span class="text-sm text-void-400">Progresiones:</span>
                        <button class="progression-btn-simple" data-secprog="1">V/V → V → I</button>
                        <button class="progression-btn-simple" data-secprog="2">I → V/vi → vi</button>
                        <button class="progression-btn-simple" data-secprog="3">ii-V secundario</button>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <template id="tpl-songs">
        <div class="space-y-4">
            <div class="flex flex-wrap items-center gap-3">
                <span class="text-sm text-void-400">Género:</span>
                <button class="scale-cat-btn active" data-genre="all">Todos</button>
                <button class="scale-cat-btn" data-genre="metal">Metal</button>
                <button class="scale-cat-btn" data-genre="prog">Progresivo</button>
                <button class="scale-cat-btn" data-genre="rock">Rock</button>
                <button class="scale-cat-btn" data-genre="blues">Blues</button>
                <button class="scale-cat-btn" data-genre="jazz">Jazz</button>
                <button class="scale-cat-btn" data-genre="funk">Funk/Soul</button>
                <button class="scale-cat-btn" data-genre="pop">Pop</button>
                <button class="scale-cat-btn" data-genre="latin">Latino</button>
                <button class="scale-cat-btn" data-genre="country">Country</button>
                <button class="scale-cat-btn" data-genre="reggae">Reggae</button>
            </div>
        </div>
    </template>

    <template id="tpl-ear-training">
        <div class="space-y-4">
            <!-- Header con estilo industrial -->
            <div style="border-left: 3px solid #dc2626; padding-left: 12px; margin-bottom: 20px;">
                <div class="text-xs text-void-400 uppercase tracking-widest mb-1">Entrenamiento Auditivo</div>
                <div class="text-sm text-chalk-100">Desarrolla tu oído musical</div>
            </div>

            <!-- Tabs de tipo de ejercicio -->
            <div class="flex flex-wrap items-center gap-2 mb-4">
                <button class="ear-exercise-tab active" data-exercise="intervals">Intervalos</button>
                <button class="ear-exercise-tab" data-exercise="chords">Acordes</button>
                <button class="ear-exercise-tab" data-exercise="progressions">Progresiones</button>
                <button class="ear-exercise-tab" data-exercise="melodic">Melodía</button>
                <button class="ear-exercise-tab" data-exercise="rhythmic">Ritmo</button>
            </div>

            <!-- Dificultad -->
            <div class="flex flex-wrap items-center gap-3 mb-4">
                <span class="text-xs text-void-400 uppercase tracking-wider" style="min-width: 90px;">Nivel:</span>
                <button class="scale-cat-btn active" data-ear-level="easy">Principiante</button>
                <button class="scale-cat-btn" data-ear-level="medium">Intermedio</button>
                <button class="scale-cat-btn" data-ear-level="hard">Avanzado</button>
            </div>

            <!-- Controles principales -->
            <div class="grid grid-cols-2 gap-3 mb-6">
                <button id="playIntervalBtn" class="mode-btn-simple" style="background: #dc2626; padding: 14px; font-weight: 600;">
                    ▶ REPRODUCIR
                </button>
                <button id="newIntervalBtn" class="mode-btn-simple" style="background: #404040; padding: 14px;">
                    ⏭ SIGUIENTE
                </button>
            </div>

            <!-- Respuestas -->
            <div style="background: rgba(0,0,0,0.4); padding: 16px; border-radius: 4px; border: 1px solid rgba(220, 38, 38, 0.2);">
                <div class="text-xs text-void-400 uppercase tracking-wider mb-3" id="earQuestionLabel">¿Qué intervalo escuchaste?</div>
                <div id="earTrainingAnswers" class="grid grid-cols-2 gap-2">
                    <!-- Botones generados dinámicamente -->
                </div>
            </div>

            <!-- Tips -->
            <div id="earTipBox" style="background: rgba(220, 38, 38, 0.1); padding: 12px; border-radius: 4px; border-left: 3px solid #dc2626;">
                <div class="text-xs text-void-400 leading-relaxed">
                    <strong style="color: #dc2626;">TIP:</strong> <span id="earTipText">Escucha el salto entre las dos notas.
                    Los intervalos pequeños (2ª, 3ª) suenan cercanos, mientras que los grandes (6ª, 7ª, 8ª) tienen un salto más amplio.</span>
                </div>
            </div>
        </div>
    </template>

    <template id="tpl-jam-session">
        <div class="jam-session-layout">
            <!-- SIDEBAR DE TRACKS -->
            <div class="jam-sidebar">
                <div class="jam-sidebar-header">
                    <span class="sidebar-label">TRACKS</span>
                    <span class="sidebar-count" id="jamTrackCount">17</span>
                </div>
                <div id="jamTrackGrid" class="jam-tracklist">
                    <!-- Generado dinámicamente -->
                </div>
            </div>

            <!-- ÁREA PRINCIPAL -->
            <div class="jam-main-area">
                <!-- KEY INFO BAR (3 columnas: KEY | PROGRESSION | CONTROLS) -->
                <div class="jam-keyinfo-bar">
                    <div class="key-display">
                        <div class="key-label">KEY</div>
                        <div id="jamKeyDisplay" class="key-value">C MAYOR</div>
                    </div>

                    <div class="progression-display">
                        <div class="progression-label">PROGRESSION</div>
                        <div id="jamProgressionDisplay" class="progression-chords"></div>
                    </div>

                    <div class="jam-controls">
                        <div class="control-row">
                            <button id="playTrackBtn" class="ctrl-btn ctrl-play">▶</button>
                            <button id="stopTrackBtn" class="ctrl-btn ctrl-stop" disabled>■</button>
                            <select id="jamKeySelector" class="ctrl-select">
                                <option value="0">C</option>
                                <option value="1">C# / Db</option>
                                <option value="2">D</option>
                                <option value="3">D# / Eb</option>
                                <option value="4">E</option>
                                <option value="5">F</option>
                                <option value="6">F# / Gb</option>
                                <option value="7">G</option>
                                <option value="8">G# / Ab</option>
                                <option value="9">A</option>
                                <option value="10">A# / Bb</option>
                                <option value="11">B</option>
                            </select>
                        </div>
                        <div class="control-row">
                            <input type="range" id="bpmSlider" class="ctrl-slider" min="40" max="200" value="120" />
                            <span id="jamBpmDisplay" class="bpm-value"></span>
                            <label class="ctrl-toggle">
                                <input type="checkbox" id="syncBPMToggle" checked />
                                <span>SYNC</span>
                            </label>
                            <label class="ctrl-toggle">
                                <input type="checkbox" id="drumsToggle" checked />
                                <span>DRUMS</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- FRETBOARD CONTAINER (MAXIMIZADO) -->
                <div class="jam-fretboard-container">
                    <!-- Fret numbers -->
                    <div style="display: flex; padding-left: 32px; margin-bottom: 8px;">
                        <div style="width: 32px;"></div>
                        <div style="flex: 1; display: flex;">
                            <div style="flex: 0.6;"></div>
                            <div style="flex: 1; text-align: center; font-family: 'JetBrains Mono', monospace; font-size: 11px; color: #666;">1</div>
                            <div style="flex: 1; text-align: center; font-family: 'JetBrains Mono', monospace; font-size: 11px; color: #666;">2</div>
                            <div style="flex: 1; text-align: center; font-family: 'JetBrains Mono', monospace; font-size: 11px; color: #666; font-weight: bold;">3</div>
                            <div style="flex: 1; text-align: center; font-family: 'JetBrains Mono', monospace; font-size: 11px; color: #666;">4</div>
                            <div style="flex: 1; text-align: center; font-family: 'JetBrains Mono', monospace; font-size: 11px; color: #666; font-weight: bold;">5</div>
                            <div style="flex: 1; text-align: center; font-family: 'JetBrains Mono', monospace; font-size: 11px; color: #666;">6</div>
                            <div style="flex: 1; text-align: center; font-family: 'JetBrains Mono', monospace; font-size: 11px; color: #666; font-weight: bold;">7</div>
                            <div style="flex: 1; text-align: center; font-family: 'JetBrains Mono', monospace; font-size: 11px; color: #666;">8</div>
                            <div style="flex: 1; text-align: center; font-family: 'JetBrains Mono', monospace; font-size: 11px; color: #666; font-weight: bold;">9</div>
                            <div style="flex: 1; text-align: center; font-family: 'JetBrains Mono', monospace; font-size: 11px; color: #666;">10</div>
                            <div style="flex: 1; text-align: center; font-family: 'JetBrains Mono', monospace; font-size: 11px; color: #666;">11</div>
                            <div style="flex: 1; text-align: center; font-family: 'JetBrains Mono', monospace; font-size: 11px; color: #dc2626; font-weight: bold;">12</div>
                        </div>
                    </div>

                    <!-- Fretboard -->
                    <div id="jamFretboard" class="fretboard-container" style="padding: 16px;">
                        <!-- Generated by JS -->
                    </div>

                    <!-- Fret markers -->
                    <div style="display: flex; margin-top: 12px; padding-left: 32px;">
                        <div style="width: 32px;"></div>
                        <div style="flex: 1; display: flex;">
                            <div style="flex: 0.6;"></div>
                            <div style="flex: 1;"></div>
                            <div style="flex: 1;"></div>
                            <div style="flex: 1; display: flex; justify-content: center;"><div style="width: 12px; height: 12px; border-radius: 50%; background: #404040;"></div></div>
                            <div style="flex: 1;"></div>
                            <div style="flex: 1; display: flex; justify-content: center;"><div style="width: 12px; height: 12px; border-radius: 50%; background: #404040;"></div></div>
                            <div style="flex: 1;"></div>
                            <div style="flex: 1; display: flex; justify-content: center;"><div style="width: 12px; height: 12px; border-radius: 50%; background: #404040;"></div></div>
                            <div style="flex: 1;"></div>
                            <div style="flex: 1; display: flex; justify-content: center;"><div style="width: 12px; height: 12px; border-radius: 50%; background: #404040;"></div></div>
                            <div style="flex: 1;"></div>
                            <div style="flex: 1;"></div>
                            <div style="flex: 1; display: flex; justify-content: center; gap: 8px;"><div style="width: 12px; height: 12px; border-radius: 50%; background: #dc2626;"></div><div style="width: 12px; height: 12px; border-radius: 50%; background: #dc2626;"></div></div>
                        </div>
                    </div>
                </div>

                <!-- LIVE PROGRESS (aparece cuando está playing) -->
                <div id="jamProgressDisplay" class="jam-live-progress">
                    <div class="live-header">
                        <span class="live-label">LIVE</span>
                        <span class="live-stats">
                            <span class="live-stat">Bar <span id="currentBarDisplay">1/4</span></span>
                            <span class="live-stat">Loop <span id="loopCountDisplay">1</span></span>
                        </span>
                    </div>

                    <div class="live-chord">
                        <div id="currentChordName" class="live-chord-name">C</div>
                        <div id="currentChordFunction" class="live-chord-function">Tónica</div>
                    </div>

                    <div class="live-beats">
                        <div class="beat-pip" data-beat="0"></div>
                        <div class="beat-pip" data-beat="1"></div>
                        <div class="beat-pip" data-beat="2"></div>
                        <div class="beat-pip" data-beat="3"></div>
                    </div>

                    <div class="live-progress-track">
                        <div id="jamProgressBar" class="live-progress-fill"></div>
                    </div>
                </div>

                <!-- TIP COMPACTO -->
                <div class="jam-tip">
                    <strong>TIP:</strong> El diapasón muestra la escala recomendada para improvisar.
                </div>
            </div>
        </div>
    </template>

    <template id="tpl-lick-library">
        <div class="lick-library-container space-y-6">
            <div class="library-header">
                <h2 class="text-3xl font-display text-chalk-100 mb-2">LICK LIBRARY</h2>
                <p class="text-void-300 font-body">Biblioteca de licks con tabs interactivos. Aprende técnicas avanzadas paso a paso.</p>
            </div>

            <!-- Filtros -->
            <div class="library-filters flex flex-wrap gap-4 items-center">
                <div class="filter-group">
                    <label class="text-sm text-void-400 font-body uppercase tracking-wider font-semibold">Género:</label>
                    <select id="lickGenreFilter" class="filter-select">
                        <option value="all">Todos</option>
                        <option value="metal">Metal</option>
                        <option value="rock">Rock</option>
                        <option value="jazz">Jazz</option>
                        <option value="fusion">Fusion</option>
                        <option value="progressive">Progressive</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label class="text-sm text-void-400 font-body uppercase tracking-wider font-semibold">Técnica:</label>
                    <select id="lickTechniqueFilter" class="filter-select">
                        <option value="all">Todas</option>
                        <option value="sweep">Sweep Picking</option>
                        <option value="tapping">Tapping</option>
                        <option value="alternate">Alternate Picking</option>
                        <option value="legato">Legato</option>
                        <option value="rhythm">Rhythm</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label class="text-sm text-void-400 font-body uppercase tracking-wider font-semibold">Dificultad:</label>
                    <select id="lickDifficultyFilter" class="filter-select">
                        <option value="all">Todas</option>
                        <option value="easy">Principiante</option>
                        <option value="medium">Intermedio</option>
                        <option value="hard">Avanzado</option>
                        <option value="expert">Experto</option>
                    </select>
                </div>
            </div>

            <!-- Grid de licks -->
            <div id="lickGrid" class="lick-grid"></div>

            <!-- Lick detail view (modal) -->
            <div id="lickDetailModal" class="lick-modal hidden">
                <div class="lick-modal-content">
                    <button class="lick-modal-close">&times;</button>
                    <div id="lickDetailContent"></div>
                </div>
            </div>
        </div>
    </template>

    <!-- CLEANED: Old level cards content removed, now using templates + control panel -->

    <script type="module" src="js/main.js"></script>
</body>
</html>
